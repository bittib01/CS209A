{
  "question": {
    "tags": [
      "java",
      "reflection",
      "static",
      "private",
      "final"
    ],
    "owner": {
      "account_id": 171067,
      "reputation": 6773,
      "user_id": 398237,
      "user_type": "registered",
      "accept_rate": 82,
      "profile_image": "https://www.gravatar.com/avatar/e23d84e9d71da70d5ae0a333f771b0a9?s=256&d=identicon&r=PG",
      "display_name": "fixitagain",
      "link": "https://stackoverflow.com/users/398237/fixitagain"
    },
    "is_answered": true,
    "view_count": 404082,
    "accepted_answer_id": 3301720,
    "answer_count": 18,
    "score": 587,
    "last_activity_date": 1760920250,
    "creation_date": 1279730148,
    "last_edit_date": 1553126955,
    "question_id": 3301635,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/3301635/change-private-static-final-field-using-java-reflection",
    "title": "Change private static final field using Java reflection",
    "body": "<p>I have a class with a <code>private static final</code> field that, unfortunately, I need to change it at run-time.</p>\n\n<p>Using reflection I get this error: <code>java.lang.IllegalAccessException: Can not set static final boolean field</code></p>\n\n<p>Is there any way to change the value?</p>\n\n<pre><code>Field hack = WarpTransform2D.class.getDeclaredField(\"USE_HACK\");\nhack.setAccessible(true);\nhack.set(null, true);\n</code></pre>\n"
  },
  "answers": [
    {
      "owner": {
        "account_id": 935202,
        "reputation": 50314,
        "user_id": 964243,
        "user_type": "registered",
        "accept_rate": 66,
        "profile_image": "https://i.sstatic.net/fL1rH.png?s=256",
        "display_name": "Boann",
        "link": "https://stackoverflow.com/users/964243/boann"
      },
      "is_accepted": false,
      "score": 0,
      "last_activity_date": 1760920250,
      "creation_date": 1760920250,
      "answer_id": 79794545,
      "question_id": 3301635,
      "content_license": "CC BY-SA 4.0",
      "body": "<p>Note that there is work ongoing in OpenJDK to &quot;make final mean final&quot;: <a href=\"https://openjdk.org/jeps/500\" rel=\"nofollow noreferrer\">https://openjdk.org/jeps/500</a></p>\n<p>The ability to mutate final <em>instance</em> fields via reflection was added in Java 5 in 2004 to support third-party serialization libraries. This is now regarded as a historical mistake, because it interferes with integrity and with performance optimizations.</p>\n<p>They plan to add an alternative &quot;limited-purpose API&quot; for serialization libraries, and then crack down on final field mutation. This will also close the loopholes that allow manipulating the modifiers to mutate final <em>static</em> fields.</p>\n<p>For now this is still a candidate JEP, not yet targeted at a particular Java version. Assuming it goes thru, at some point, <strong>the ability to mutate <em>any</em> final fields</strong> via reflection will generate a nuisance warning on the console, and later, an error, unless you add a special command line override. (They are not proposing to kill the ability entirely... yet.)</p>\n<p>Already it's impossible to mutate a final field of a <code>record</code> and it will also be impossible to mutate a <a href=\"https://openjdk.org/jeps/8350458\" rel=\"nofollow noreferrer\">&quot;strict&quot;</a> final field, which all fields of Valhalla <code>value</code> classes will be (which will include some classes which exist today if they are upgraded to <code>value</code> classes).</p>\n<p>There will always be <em>some</em> kind of workaround, even if it's just hex-editing the bytecode of the class files before the VM sees them. Or compiling your own VM. But the point is that mutating final fields is going to keep getting more difficult. If you can find some way to do what you need within the language instead, it will be easier in the long run, even if it's a nuisance right now.</p>\n"
    },
    {
      "owner": {
        "account_id": 9148036,
        "reputation": 39,
        "user_id": 6803479,
        "user_type": "registered",
        "profile_image": "https://graph.facebook.com/661705823983924/picture?type=large",
        "display_name": "Andrei Marchanka",
        "link": "https://stackoverflow.com/users/6803479/andrei-marchanka"
      },
      "is_accepted": false,
      "score": 2,
      "last_activity_date": 1715850956,
      "last_edit_date": 1715850956,
      "creation_date": 1695812586,
      "answer_id": 77186891,
      "question_id": 3301635,
      "content_license": "CC BY-SA 4.0",
      "body": "<p>To make this worked with JDK 21 you can use option <code>-Djdk.reflect.useDirectMethodHandle=false</code></p>\n<p>Make accessable for JDK 11 - 17</p>\n<pre class=\"lang-java prettyprint-override\"><code>public static void setFieldAccessible(Field field) throws Exception {\n    field.setAccessible(true);\n    Method getDeclaredFields0 = Class.class.getDeclaredMethod(&quot;getDeclaredFields0&quot;, boolean.class);\n    getDeclaredFields0.setAccessible(true);\n    Field[] fields = (Field[]) getDeclaredFields0.invoke(Field.class, false);\n    for (Field each : fields) {\n        if (&quot;modifiers&quot;.equals(each.getName())) {\n            each.setAccessible(true);\n            each.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);\n            break;\n        }\n    }\n}\n</code></pre>\n"
    },
    {
      "owner": {
        "account_id": 30200427,
        "reputation": 295,
        "user_id": 23144795,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/a8524840334627d77272f8e6e56185ae?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name": "tesmo",
        "link": "https://stackoverflow.com/users/23144795/tesmo"
      },
      "is_accepted": false,
      "score": 2,
      "last_activity_date": 1715691288,
      "last_edit_date": 1715691288,
      "creation_date": 1711837665,
      "answer_id": 78249703,
      "question_id": 3301635,
      "content_license": "CC BY-SA 4.0",
      "body": "<p>The top rated answer does not work with the new Reflection implementation of <a href=\"https://openjdk.org/jeps/416\" rel=\"nofollow noreferrer\">JEP416</a> in e.g. Java 21 that uses MethodHandles and ignores the flags value on the Field abstraction object.</p>\n<p>One solution is to use Unsafe, however with <a href=\"https://openjdk.org/jeps/8323072\" rel=\"nofollow noreferrer\">this JEP</a> Unsafe and the important <code>long objectFieldOffset(Field f)</code> and\n<code>long staticFieldOffset(Field f)</code> methods are getting deprecated for removal so for example this will not work in the future:</p>\n<pre class=\"lang-java prettyprint-override\"><code>final Unsafe unsafe = //..get Unsafe (...and add subsequent --add-opens statements for this to work)\nfinal Field ourField = Example.class.getDeclaredField(&quot;changeThis&quot;);\nfinal Object staticFieldBase = unsafe.staticFieldBase(ourField);\nfinal long staticFieldOffset = unsafe.staticFieldOffset(ourField);\nunsafe.putObject(staticFieldBase, staticFieldOffset, &quot;it works&quot;);\n</code></pre>\n<p>I do not recommend this but it is possible in Java 21 with the new reflection implementation when making heavy use of the internal API if really needed.</p>\n<h1>Java 21+ solution without <code>Unsafe</code></h1>\n<p>The gist of it is to use a <code>MethodHandle</code> that can write to a static final field by getting it from the internal <a href=\"https://github.com/openjdk/jdk/blob/master/src/java.base/share/classes/java/lang/invoke/MethodHandles.java#L4165\" rel=\"nofollow noreferrer\"><code>getDirectFieldNoSecurityManager(...)</code></a> method of the Lookup by providing it with a <code>MemberName</code> that is manipulated via Reflection to remove the final flag from it.</p>\n<p>You will need to add the following JVM options for this to work:</p>\n<pre><code>--add-opens=java.base/java.lang.invoke=ALL-UNNAMED --add-opens=java.base/java.lang.reflect=ALL-UNNAMED\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>public class FinalFieldUtil {\n\n    private static class MemberNameWrapper {\n\n        protected  final Class&lt;?&gt; MEMBER_NAME_CLASS;\n        private  final Constructor&lt;?&gt; MEMBER_NAME_CONSTRUCTOR;\n        private  final Field MEMBER_NAME_FLAGS_FIELD;\n        private  final Method MEMBER_NAME_GET_REFERENCE_KIND_METHOD;\n\n         {\n            try {\n                MEMBER_NAME_CLASS = Class.forName(&quot;java.lang.invoke.MemberName&quot;);\n\n                MEMBER_NAME_CONSTRUCTOR = MEMBER_NAME_CLASS.getDeclaredConstructor(Field.class, boolean.class); //e.g. new MemberName(myField, true);\n                MEMBER_NAME_CONSTRUCTOR.setAccessible(true);\n\n                MEMBER_NAME_FLAGS_FIELD = MEMBER_NAME_CLASS.getDeclaredField(&quot;flags&quot;);\n                MEMBER_NAME_FLAGS_FIELD.setAccessible(true);\n\n                MEMBER_NAME_GET_REFERENCE_KIND_METHOD = MEMBER_NAME_CLASS.getDeclaredMethod(&quot;getReferenceKind&quot;);\n                MEMBER_NAME_GET_REFERENCE_KIND_METHOD.setAccessible(true);\n            } catch (ClassNotFoundException | NoSuchMethodException | NoSuchFieldException e) {\n                throw new RuntimeException(e);\n            }\n        }\n\n        final Object instance;\n\n        public MemberNameWrapper(Field field, boolean makeSetter) {\n            try {\n                instance = MEMBER_NAME_CONSTRUCTOR.newInstance(field, makeSetter);\n                removeFinality(instance);\n\n            } catch (Exception e) {\n                throw new RuntimeException(e);\n            }\n        }\n\n        private final void removeFinality(Object memberNameInstance) throws IllegalAccessException {\n            //Manipulate flags to remove hints to it being final\n            final int initialFlags = MEMBER_NAME_FLAGS_FIELD.getInt(memberNameInstance);\n\n            if (!Modifier.isFinal(initialFlags)) {\n                return;\n            }\n\n            final int nonFinalFlags = initialFlags &amp; ~Modifier.FINAL;\n\n            MEMBER_NAME_FLAGS_FIELD.setInt(memberNameInstance, nonFinalFlags);\n        }\n\n        protected Object getMemberNameInstance(){\n            return instance;\n        }\n\n        protected byte getReferenceKind() {\n            try {\n                return (byte) MEMBER_NAME_GET_REFERENCE_KIND_METHOD.invoke(instance);\n            } catch (IllegalAccessException | InvocationTargetException e) {\n                throw new RuntimeException(e);\n            }\n        }\n\n    }\n\n    private static class LookupWrapper {\n\n        private  final Class&lt;?&gt; LOOKUP_CLASS;\n        private  final Method LOOKUP_GET_FIELD_VAR_HANDLE_NO_SECURITY_MANAGER_METHOD;\n\n         {\n            try {\n                LOOKUP_CLASS = Lookup.class;\n                LOOKUP_GET_FIELD_VAR_HANDLE_NO_SECURITY_MANAGER_METHOD = LOOKUP_CLASS.getDeclaredMethod(&quot;getDirectFieldNoSecurityManager&quot;, byte.class, Class.class, Class.forName(&quot;java.lang.invoke.MemberName&quot;));\n                LOOKUP_GET_FIELD_VAR_HANDLE_NO_SECURITY_MANAGER_METHOD.setAccessible(true);\n\n            } catch (NoSuchMethodException | ClassNotFoundException e) {\n                throw new RuntimeException(e);\n            }\n\n         }\n\n        private final Lookup lookup;\n\n        private LookupWrapper(Lookup lookup) {\n            this.lookup = lookup;\n        }\n\n        public MethodHandle unreflectVarHandleUnrestricted(Field field) {\n            final MemberNameWrapper memberNameSetterWrapper = new MemberNameWrapper(field, true);\n            final byte setterReferenceKind = memberNameSetterWrapper.getReferenceKind();\n            final Object memberNameSetter = memberNameSetterWrapper.getMemberNameInstance();\n\n\n            try {\n                return (MethodHandle) LOOKUP_GET_FIELD_VAR_HANDLE_NO_SECURITY_MANAGER_METHOD.invoke(lookup, setterReferenceKind, field.getDeclaringClass(), memberNameSetter);\n            } catch (IllegalAccessException | InvocationTargetException e) {\n                throw new RuntimeException(e);\n            }\n        }\n    }\n\n    public static void setStaticFinalField(Field field, Object value) throws Throwable {\n        if (Modifier.isFinal(field.getModifiers()) &amp;&amp; field.getType().isPrimitive()) {\n            throw new IllegalArgumentException(&quot;primitive finals are not supported, because their modification depends on very specific circumstances.&quot;);\n        }\n\n        final LookupWrapper lookupWrapper = new LookupWrapper(MethodHandles.privateLookupIn(field.getDeclaringClass(), MethodHandles.lookup()));\n        final MethodHandle methodHandle = lookupWrapper.unreflectVarHandleUnrestricted(field);\n        methodHandle.invoke(value);\n\n    }\n\n}\n</code></pre>\n<p>And then you can</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class TestModelClassWithFinalFields {\n\n    public static final String myStr; //can be set\n    public static final List&lt;Object&gt; myList = List.of(); //can be set\n    public static final String myInlineStr = &quot;init&quot;; //cannot be set with this method!\n    \n    static {\n        myStr = &quot;initial static value&quot;;\n    }\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>FinalFieldUtil.setStaticFinalField(TestModelClassWithFinalFields.class.getDeclaredField(&quot;myStr&quot;), &quot;new value!&quot;);\n\nSystem.out.println(FinalFieldUtil.myStr);\n</code></pre>\n<p>Please note that this will not work for pure String literals and primitive values when set inline (e.g. <code>static final String = &quot;str&quot;</code>)</p>\n<p>See my answer <a href=\"https://stackoverflow.com/a/77705202/23144795\">here</a> for a the initial attempt and thoughts regarding using the internal API to set a final field in Java 21 without Unsafe.</p>\n"
    },
    {
      "owner": {
        "account_id": 31526890,
        "reputation": 1,
        "user_id": 24348089,
        "user_type": "unregistered",
        "profile_image": "https://www.gravatar.com/avatar/635d5eeb8edcfa7e74bf77c808201fa7?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name": "user24348089",
        "link": "https://stackoverflow.com/users/24348089/user24348089"
      },
      "is_accepted": false,
      "score": -1,
      "last_activity_date": 1713171697,
      "creation_date": 1713171697,
      "answer_id": 78327231,
      "question_id": 3301635,
      "content_license": "CC BY-SA 4.0",
      "body": "<p>In openjdk17 I had to remove <code>final</code> modifier not just from <code>Field.modifiers</code>, but also from <code>Field.root.modifiers</code>.<br />\n<a href=\"https://github.com/openjdk/jdk17u/blob/jdk-17%2B35/src/java.base/share/classes/java/lang/reflect/Field.java#L91\" rel=\"nofollow noreferrer\"><code>Field.root</code></a> is used internally in <code>field.set(...)</code> <a href=\"https://github.com/openjdk/jdk17u/blob/jdk-17%2B35/src/java.base/share/classes/java/lang/reflect/Field.java#L1124\" rel=\"nofollow noreferrer\">here</a>.<br />\nSo my code is this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>    private static void makeStaticFinalFieldWritable( Field field ) {\n      try {\n        var lookup = MethodHandles.privateLookupIn( field.getClass(), MethodHandles.lookup() );\n        var modifiersHandle = lookup.findVarHandle( field.getClass(), &quot;modifiers&quot;, int.class );\n        var modifiers = field.getModifiers();\n        modifiersHandle.set( field, modifiers &amp; ~Modifier.FINAL );\n\n        var rootHandle = lookup.findVarHandle( field.getClass(), &quot;root&quot;, Field.class );\n        var root = ( Field ) rootHandle.get( field );\n        if ( root != null &amp;&amp; root != field ) {\n          makeStaticFinalFieldWritable( root );\n        }\n      }\n      catch ( IllegalAccessException | NoSuchFieldException e ) {\n        throw new Error( e );\n      }\n    }\n</code></pre>\n"
    }
  ],
  "question_comments": [
    {
      "owner": {
        "account_id": 192003,
        "reputation": 31432,
        "user_id": 432903,
        "user_type": "registered",
        "accept_rate": 64,
        "profile_image": "https://www.gravatar.com/avatar/279725897f787bf1455ad43de9ef9826?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name": "prayagupadhyay",
        "link": "https://stackoverflow.com/users/432903/prayagupadhyay"
      },
      "edited": false,
      "score": 0,
      "creation_date": 1665167993,
      "post_id": 3301635,
      "comment_id": 130644694,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 7445,
        "reputation": 62917,
        "user_id": 12943,
        "user_type": "registered",
        "accept_rate": 84,
        "profile_image": "https://www.gravatar.com/avatar/d6a9924b767fe91c46def7edc7bce035?s=256&d=identicon&r=PG",
        "display_name": "Bill K",
        "link": "https://stackoverflow.com/users/12943/bill-k"
      },
      "edited": false,
      "score": 6,
      "creation_date": 1581029941,
      "post_id": 3301635,
      "comment_id": 106303647,
      "content_license": "CC BY-SA 4.0"
    }
  ],
  "answer_comments": {
    "79794545": [],
    "77186891": [
      {
        "owner": {
          "account_id": 1093264,
          "reputation": 6248,
          "user_id": 1087407,
          "user_type": "registered",
          "accept_rate": 67,
          "profile_image": "https://i.sstatic.net/Px2sm.jpg?s=256",
          "display_name": "Piotr Olaszewski",
          "link": "https://stackoverflow.com/users/1087407/piotr-olaszewski"
        },
        "edited": false,
        "score": 1,
        "creation_date": 1703270344,
        "post_id": 77186891,
        "comment_id": 136992130,
        "content_license": "CC BY-SA 4.0"
      },
      {
        "owner": {
          "account_id": 1392029,
          "reputation": 124,
          "user_id": 1322622,
          "user_type": "registered",
          "profile_image": "https://www.gravatar.com/avatar/1bb7b678619c0c3f9607ca406715c998?s=256&d=identicon&r=PG",
          "display_name": "George Stanchev",
          "link": "https://stackoverflow.com/users/1322622/george-stanchev"
        },
        "edited": false,
        "score": 1,
        "creation_date": 1698958616,
        "post_id": 77186891,
        "comment_id": 136474116,
        "content_license": "CC BY-SA 4.0"
      }
    ],
    "78249703": [
      {
        "owner": {
          "account_id": 30200427,
          "reputation": 295,
          "user_id": 23144795,
          "user_type": "registered",
          "profile_image": "https://www.gravatar.com/avatar/a8524840334627d77272f8e6e56185ae?s=256&d=identicon&r=PG&f=y&so-version=2",
          "display_name": "tesmo",
          "link": "https://stackoverflow.com/users/23144795/tesmo"
        },
        "reply_to_user": {
          "account_id": 71739,
          "reputation": 311873,
          "user_id": 207421,
          "user_type": "registered",
          "accept_rate": 82,
          "profile_image": "https://www.gravatar.com/avatar/5cfe5f7d64f44be04f147295f5c7b88e?s=256&d=identicon&r=PG",
          "display_name": "user207421",
          "link": "https://stackoverflow.com/users/207421/user207421"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1711840599,
        "post_id": 78249703,
        "comment_id": 137952437,
        "content_license": "CC BY-SA 4.0"
      },
      {
        "owner": {
          "account_id": 71739,
          "reputation": 311873,
          "user_id": 207421,
          "user_type": "registered",
          "accept_rate": 82,
          "profile_image": "https://www.gravatar.com/avatar/5cfe5f7d64f44be04f147295f5c7b88e?s=256&d=identicon&r=PG",
          "display_name": "user207421",
          "link": "https://stackoverflow.com/users/207421/user207421"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1711840196,
        "post_id": 78249703,
        "comment_id": 137952406,
        "content_license": "CC BY-SA 4.0"
      }
    ],
    "78327231": [
      {
        "owner": {
          "account_id": -1,
          "reputation": 1,
          "user_id": -1,
          "user_type": "moderator",
          "profile_image": "https://www.gravatar.com/avatar/a007be5a61f6aa8f3e85ae2fc18dd66e?s=256&d=identicon&r=PG",
          "display_name": "Community",
          "link": "https://stackoverflow.com/users/-1/community"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1713387055,
        "post_id": 78327231,
        "comment_id": 138117969,
        "content_license": "CC BY-SA 4.0"
      }
    ]
  }
}