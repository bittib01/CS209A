{
  "question": {
    "tags": [
      "java",
      "struts-1"
    ],
    "owner": {
      "account_id": 4329822,
      "reputation": 1,
      "user_id": 3535643,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/956c07b6220d7392ff9fa04374ada607?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "user3535643",
      "link": "https://stackoverflow.com/users/3535643/user3535643"
    },
    "is_answered": false,
    "view_count": 10554,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1764392905,
    "creation_date": 1397561727,
    "last_edit_date": 1461239499,
    "question_id": 23082498,
    "content_license": "CC BY-SA 3.0",
    "link": "https://stackoverflow.com/questions/23082498/csrf-token-generation-issue",
    "title": "CSRF token generation issue",
    "body": "<p>To prevent CSRF below were the steps i have followed:</p>\n\n<p><strong>1</strong>. First time when request comes(to loginfilter) session is null, create a session add token(randome number) to this new session by using setAttribute() and redirect to login.jsp screen using <strong>dispatcher.forward</strong>.</p>\n\n<p><strong>2</strong>. in login.jsp screen use getAttribute() store the token in the hidden filed.</p>\n\n<p><strong>3</strong>. on submit of login.jsp first request will come to loginfilter, here compare the token from the request with the token in the session, if matches then proceed with  executing the action class. otherwise generate the new token for the same session and redirect to the login.jsp using <strong>sendRedirect()</strong></p>\n\n<p>when i ran the security tool on this application, i message saying \"Missing one time token parameter\".</p>\n\n<p>Please help me. </p>\n\n<hr>\n\n<p><strong>1.filter.java</strong></p>\n\n<pre><code>if (session == null) {\n    chain.doFilter(request, response);\n    return;\n}\nelse {\n    // validate the CSRF\n    String sToken = httprequest.getSession().getAttribute(\"CSRF_TOKEN\")\n            .toString();\n    String pToken = httprequest.getParameter(\"CSRF_TOKEN\");\n    System.out.println(\"Tokens - \" + sToken + pToken);\n    if (sToken.equals(pToken)) {\n        chain.doFilter(request, response);\n    }\n    else {\n        CommonUtils.updateSessionToken(session);\n        /*\n         * RequestDispatcher rd =\n         * request.getRequestDispatcher(\"/login.jsp\");\n         * rd.forward(request, response);\n         */\n        httpresponse.sendRedirect(\"/login.jsp\");\n    }\n}\n</code></pre>\n\n<hr>\n\n<p><strong>2.login.jsp</strong></p>\n\n<pre><code>&lt;!DOCTYPE html PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\"&gt;\n&lt;%\n    Object token = request.getSession().getAttribute(\"CSRF_TOKEN\");\n    String tokenStr = \"\";\n    if (token != null) {\n        tokenStr = (String) token;\n    }\n\n    System.out.println(\"+tokenStr \" + tokenStr);\n%&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;meta http-equiv=\"Content-Type\" content=\"text/html; charset=ISO-8859-1\"&gt;\n&lt;title&gt;CSRFGuard Test Application&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    Welcome to the OWASP CSRFGuard Test Application! Where would you like\n    to go?\n    &lt;br /&gt;\n    &lt;form action=\"/CSRF/helloServlet\" method=\"post\"&gt;\n        &lt;input type=\"text\" name=\"username\" /&gt; &lt;br /&gt; &lt;input type=\"text\"\n            value=\"&lt;%=tokenStr%&gt;\" name=\"CSRF_TOKEN\" /&gt; &lt;input type=\"submit\"\n            value=\"login\"&gt;\n    &lt;/form&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>\n\n<hr>\n\n<p><strong>3.web.xml</strong></p>\n\n<pre><code>&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n&lt;web-app id=\"WebApp_ID\" version=\"2.4\" xmlns=\"http://java.sun.com/xml/ns/j2ee\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd\"&gt;\n    &lt;display-name&gt;CSRF&lt;/display-name&gt;\n    &lt;servlet&gt;\n        &lt;description&gt;\n        &lt;/description&gt;\n        &lt;display-name&gt;Hell0oServelt&lt;/display-name&gt;\n        &lt;servlet-name&gt;HelloServelt&lt;/servlet-name&gt;\n        &lt;servlet-class&gt;com.HelloServlet&lt;/servlet-class&gt;\n    &lt;/servlet&gt;\n    &lt;servlet-mapping&gt;\n        &lt;servlet-name&gt;HelloServelt&lt;/servlet-name&gt;\n        &lt;url-pattern&gt;/helloServlet&lt;/url-pattern&gt;\n    &lt;/servlet-mapping&gt;\n    &lt;welcome-file-list&gt;\n        &lt;welcome-file&gt;login.jsp&lt;/welcome-file&gt;\n    &lt;/welcome-file-list&gt;\n\n        &lt;listener&gt;\n        &lt;listener-class&gt;com.CsrfGuardHttpSessionListener&lt;/listener-class&gt;\n    &lt;/listener&gt;\n  &lt;filter&gt;\n    &lt;filter-name&gt;LoggedInFilter&lt;/filter-name&gt;\n    &lt;filter-class&gt;com.LoggedInFilter&lt;/filter-class&gt;\n  &lt;/filter&gt;\n\n  &lt;filter-mapping&gt;\n    &lt;filter-name&gt;LoggedInFilter&lt;/filter-name&gt;\n    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;\n  &lt;/filter-mapping&gt;\n\n&lt;/web-app&gt;\n</code></pre>\n\n<p><strong>4.CsrfGuardHttpSessionListener</strong></p>\n\n<hr>\n\n<pre><code>public class CsrfGuardHttpSessionListener implements HttpSessionListener {\n\n    @Override\n    public void sessionCreated(HttpSessionEvent event) {\n        HttpSession session = event.getSession();\n        System.out.println(\"New session id - \"+session.getId());\n        String tokenId = generateRandomId();\n    session.setAttribute(\"CSRF_TOKEN\", tokenId);\n    System.out.println(\"newtoken -\"+tokenId);\n    }\n\n    @Override\n    public void sessionDestroyed(HttpSessionEvent event) {\n        /** nothing to do  **/\n    }\n\n}\n</code></pre>\n\n<p><strong>5.HelloServlet</strong></p>\n\n<hr>\n\n<pre><code>public class HelloServlet extends HttpServlet {\n    private static final long serialVersionUID = 1L;\n\n    /**\n     * @see HttpServlet#HttpServlet()\n     */\n    public HelloServlet() {\n        super();\n    }\n\n    /**\n     * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)\n     */\n    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {\n        System.out.println(\"Welcome ...!\");\n    }\n\n    @Override\n    protected void doGet(HttpServletRequest req, HttpServletResponse resp)\n            throws ServletException, IOException {\n\n        doPost(req, resp);\n    }\n}\n</code></pre>\n\n<hr>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}