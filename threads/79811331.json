{
  "question": {
    "tags": [
      "java",
      "jython",
      "pythoninterpreter"
    ],
    "owner": {
      "account_id": 5619856,
      "reputation": 33,
      "user_id": 4450063,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/55e8d95f609be88cdbb218294ccae4c8?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Robert",
      "link": "https://stackoverflow.com/users/4450063/robert"
    },
    "is_answered": false,
    "view_count": 86,
    "answer_count": 1,
    "score": 2,
    "last_activity_date": 1762548093,
    "creation_date": 1762436340,
    "last_edit_date": 1762439364,
    "question_id": 79811331,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79811331/can-i-reuse-an-instance-of-pythoninterpreter-perhaps-via-pycode-object",
    "title": "Can I reuse an instance of PythonInterpreter - perhaps via PyCode object?",
    "body": "<p>I have a script that I load via:</p>\n<pre><code>python = new PythonInterpreter();\nString script = &quot;script I loaded from somewhere&quot;    \n    \ntry {\n    python.exec(script);\n} catch (Exception e) {\n    AtiWarning.msg(host, &quot;eaPY&quot;, &quot;Error parsing script: &quot; + e, e);\n}\n</code></pre>\n<p>This seems to &quot;compile&quot; the script.</p>\n<p>The script contains a function that I then call many times for a given <code>host</code> via:</p>\n<pre><code>try {\n    python.set(&quot;host&quot;, host);\n    python.set(&quot;tableName&quot;, tableName);\n    python.set(&quot;state&quot;, order);\n    python.set(&quot;index&quot;, index);\n            python.set(&quot;values&quot;, values);\n\n    python.exec(&quot;row(host, tableName, state, index, values)&quot;);  \n\n} catch (Exception e) {\n    AtiWarning.msg(host, &quot;eaPY&quot;, &quot;Error in row: &quot; + e, e);\n}\n</code></pre>\n<p>This entire process may be repeated for other <code>hosts</code>. Multiple <code>hosts</code> may need to execute the script concurrently.</p>\n<p>After the first <code>exec(script)</code>, is there any way to save some kind of object (such as <code>PyCode</code>?) so when another <code>host</code> comes along I do not have to call <code>exec(script)</code> again?</p>\n<p>Due to concurrency, I cannot simply hold on to the <code>PythonInterpreter</code> instance and reuse it.  I would like to create a new instance of <code>PythonInterpeter</code> and give it some object rather than having it parse the script again.</p>\n"
  },
  "answers": [
    {
      "owner": {
        "account_id": 23173771,
        "reputation": 226,
        "user_id": 17272599,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/0c55399ebafd24932ca4d309afc69098?s=256&d=identicon&r=PG",
        "display_name": "dbakr",
        "link": "https://stackoverflow.com/users/17272599/dbakr"
      },
      "is_accepted": false,
      "score": 0,
      "last_activity_date": 1762548093,
      "last_edit_date": 1762548093,
      "creation_date": 1762442116,
      "answer_id": 79811459,
      "question_id": 79811331,
      "content_license": "CC BY-SA 4.0",
      "body": "<p>Underneath your code snippet demonstrating <code>PythonInterpreter('some string...')</code> you say</p>\n<blockquote>\n<p>This seems to &quot;compile&quot; the script.</p>\n</blockquote>\n<p>No, this <em>executes</em> the script. Which is why you haven't been able to reuse the instance.</p>\n<hr />\n<p>Per the docs:\n<code>PythonInterpreter.compile('some string...')</code></p>\n<blockquote>\n<p>Compiles a string of Python source as either an expression (if possible) or a module.</p>\n</blockquote>\n<p>Your question has two parts.\nFocusing on the easier question, without getting too into the specifics of your setup:</p>\n<p><strong>The script contains a function that I then call many times [...] Is there a way to save some kind of object (PyCode?) so when another &quot;host&quot; comes along I do not have to call exec(script) again?</strong></p>\n<hr />\n<p><strong>Yes</strong>. Based on the <a href=\"https://www.javadoc.io/doc/org.python/jython-standalone/2.7.2/index.html\" rel=\"nofollow noreferrer\">Jython docs</a>, you should be first <a href=\"https://www.javadoc.io/static/org.python/jython-standalone/2.7.2/org/python/util/PythonInterpreter.html#compile-java.lang.String-\" rel=\"nofollow noreferrer\">compiling the string</a> into  your PyCode object via: <code>PyCode my_func= new PythonInterpreter.compile('some string expression or module')</code> that you can then pass around to local threads. Which brings us to the second and slightly more difficult question</p>\n<p><strong>This entire process may be repeated for other hosts. Multiple hosts may need to execute the script concurrently. [...] Due to concurrency, I cannot simply hold on to the PythonInterpreter instance and reuse it. I would like to create a new instance of PythonInterpeter and give it some object rather than having it parse the script again.</strong></p>\n<p>You will need to manage local threads for each host via <code>threadLocalStateInterpreter</code> -- then simply replace your <code>python.set('env_var',env_var)</code> with a thread-safe <code>python.setLocals()</code>. Something like</p>\n<pre class=\"lang-java prettyprint-override\"><code>import org.python.core.*;\nimport org.python.util.PythonInterpreter;\nimport java.util.concurrent.*;\n\npublic class JythonRemoteExecutor {\n    \n    // shared, thread-safe, compiled Python function\n    private static PyCode compiledFunction;\n    \n    // thread-local interpreter for each connecting host\n    private static ThreadLocal&lt;PythonInterpreter&gt; threadLocalStateInterpreter = \n        ThreadLocal.withInitial(() -&gt; {\n            PythonInterpreter interp = new PythonInterpreter();\n            return interp;\n        });\n\n    // compile your Python function once at startup\n    static {\n        String pythonCode = &quot;def your_function():...&quot;;\n        PythonInterpreter compiler = new PythonInterpreter();\n        compiledFunction = compiler.compile(pythonCode);\n        compiler.close();\n    }\n    \n    /* execute the shared function for a specific host */\n    public static PyObject executeForHost(String hostId) {\n\n        // this is where you begin to take advantage of that precompiled \n        // code from earlier\n        PythonInterpreter interp = threadLocalStateInterpreter.get();\n        // execute the compiled function in this thread's namespace,\n        // this will allow you to use `your_function()` locally,\n        // independent of other hosts who may be executing their\n        // instance of your function\n        interp.exec(compiledFunction);\n        \n        // set local variables specific to this host using setLocals()\n        interp.setLocals(new PyStringMap() {{\n            __setitem__(&quot;host_id&quot;, new PyString(hostId));\n            __setitem__(&quot;host&quot;, host);\n            __setitem__(&quot;tableName&quot;, tableName);\n            __setitem__(&quot;state&quot;, state);\n            __setitem__(&quot;index&quot;, index);\n            __setitem__(&quot;values&quot;, values);\n        }});\n        \n        interp.exec(&quot;row(host, tableName, state, index, values)&quot;);\n    }\n    \n    /**\n     * example driver program simulating multiple hosts connecting and executing\n     */\n    public static void main(String[] args) throws InterruptedException {\n        ExecutorService executor = Executors.newFixedThreadPool(3); // set as needed\n        Callable&lt;String&gt; host1Task = () -&gt; {\n            PyObject result = executeForHost(&quot;Host-1&quot;);\n            return &quot;Host-1 finished executing.&quot;\n        };\n        \n        Callable&lt;String&gt; host2Task = () -&gt; {\n            PyObject result = executeForHost(&quot;Host-2&quot;);\n            return &quot;Host-2 finished executing.&quot;\n        };\n        \n        Callable&lt;String&gt; host3Task = () -&gt; {\n            PyObject result = executeForHost(&quot;Host-3&quot;);\n            return &quot;Host-3 finished executing.&quot;\n        };\n        \n        // execute all host connections concurrently\n        Future&lt;String&gt; future1 = executor.submit(host1Task);\n        Future&lt;String&gt; future2 = executor.submit(host2Task);\n        Future&lt;String&gt; future3 = executor.submit(host3Task);\n        \n        // print results -- should see all hosts finish executing\n        try {\n            System.out.println(future1.get());\n            System.out.println(future2.get());\n            System.out.println(future3.get());\n        } catch (ExecutionException e) {\n            e.printStackTrace();\n        }\n        \n        executor.shutdown();\n    }\n}\n\n</code></pre>\n"
    }
  ],
  "question_comments": [
    {
      "owner": {
        "account_id": 23173771,
        "reputation": 226,
        "user_id": 17272599,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/0c55399ebafd24932ca4d309afc69098?s=256&d=identicon&r=PG",
        "display_name": "dbakr",
        "link": "https://stackoverflow.com/users/17272599/dbakr"
      },
      "edited": false,
      "score": 0,
      "creation_date": 1762805851,
      "post_id": 79811331,
      "comment_id": 140847491,
      "content_license": "CC BY-SA 4.0"
    }
  ],
  "answer_comments": {
    "79811459": [
      {
        "owner": {
          "account_id": 5619856,
          "reputation": 33,
          "user_id": 4450063,
          "user_type": "registered",
          "profile_image": "https://www.gravatar.com/avatar/55e8d95f609be88cdbb218294ccae4c8?s=256&d=identicon&r=PG&f=y&so-version=2",
          "display_name": "Robert",
          "link": "https://stackoverflow.com/users/4450063/robert"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1762900845,
        "post_id": 79811459,
        "comment_id": 140849467,
        "content_license": "CC BY-SA 4.0"
      },
      {
        "owner": {
          "account_id": 23173771,
          "reputation": 226,
          "user_id": 17272599,
          "user_type": "registered",
          "profile_image": "https://www.gravatar.com/avatar/0c55399ebafd24932ca4d309afc69098?s=256&d=identicon&r=PG",
          "display_name": "dbakr",
          "link": "https://stackoverflow.com/users/17272599/dbakr"
        },
        "reply_to_user": {
          "account_id": 5619856,
          "reputation": 33,
          "user_id": 4450063,
          "user_type": "registered",
          "profile_image": "https://www.gravatar.com/avatar/55e8d95f609be88cdbb218294ccae4c8?s=256&d=identicon&r=PG&f=y&so-version=2",
          "display_name": "Robert",
          "link": "https://stackoverflow.com/users/4450063/robert"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1762547926,
        "post_id": 79811459,
        "comment_id": 140842620,
        "content_license": "CC BY-SA 4.0"
      },
      {
        "owner": {
          "account_id": 23173771,
          "reputation": 226,
          "user_id": 17272599,
          "user_type": "registered",
          "profile_image": "https://www.gravatar.com/avatar/0c55399ebafd24932ca4d309afc69098?s=256&d=identicon&r=PG",
          "display_name": "dbakr",
          "link": "https://stackoverflow.com/users/17272599/dbakr"
        },
        "reply_to_user": {
          "account_id": 5619856,
          "reputation": 33,
          "user_id": 4450063,
          "user_type": "registered",
          "profile_image": "https://www.gravatar.com/avatar/55e8d95f609be88cdbb218294ccae4c8?s=256&d=identicon&r=PG&f=y&so-version=2",
          "display_name": "Robert",
          "link": "https://stackoverflow.com/users/4450063/robert"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1762547560,
        "post_id": 79811459,
        "comment_id": 140842611,
        "content_license": "CC BY-SA 4.0"
      },
      {
        "owner": {
          "account_id": 5619856,
          "reputation": 33,
          "user_id": 4450063,
          "user_type": "registered",
          "profile_image": "https://www.gravatar.com/avatar/55e8d95f609be88cdbb218294ccae4c8?s=256&d=identicon&r=PG&f=y&so-version=2",
          "display_name": "Robert",
          "link": "https://stackoverflow.com/users/4450063/robert"
        },
        "edited": false,
        "score": 1,
        "creation_date": 1762453782,
        "post_id": 79811459,
        "comment_id": 140840570,
        "content_license": "CC BY-SA 4.0"
      }
    ]
  }
}