{
  "question": {
    "tags": [
      "java",
      "windows",
      "jna",
      "win32com",
      "lnk"
    ],
    "owner": {
      "account_id": 43233157,
      "reputation": 41,
      "user_id": 31148503,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/3218ce528b7e23b0aeb9a0de2dbf192a?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Syed Maroof Hussain",
      "link": "https://stackoverflow.com/users/31148503/syed-maroof-hussain"
    },
    "is_answered": true,
    "view_count": 71,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1763842280,
    "creation_date": 1763771684,
    "question_id": 79827044,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79827044/jna-cocreateinstance-returns-s-ok-but-shelllink-ishelllinkw-fails-com-pointer-i",
    "title": "JNA CoCreateInstance returns S_OK but ShellLink/IShellLinkW fails, COM pointer is non-null but object unusable",
    "body": "<p>I'm making a Java app that scans the Windows Recent Files folder and resolves .lnk shorcuts to their actual file paths. I'm doing so using JNA the JNA API and simulating IShellLinkW and IPersistFile.</p>\n<p>Every time I run my code, CoCreateInstance returns S_OK and the COM pointer is non-null, but my ShellLink object fails immediately as well as my IPersistFile.load.</p>\n<p>This is my debug log (I generated a lot of debug messages) after clearing the recent files folder and downloading a dummy pdf:</p>\n<pre><code>Resolving: pdf-sample_0.pdf.lnk\n===== ShellLink.createShellLink() BEGIN =====\nCLSID_SHELL_LINK = {00021401-0000-0000-C000-000000000046}\nIID_SHELL_LINK_W = {000214F9-0000-0000-C000-000000000046}\n[1] Calling CoInitialize...\n[1] CoInitialize HRESULT = 1  (S_FALSE)\n[2] Calling CoCreateInstance...\n[2] CoCreateInstance HRESULT = 0  (S_OK)\n[2] HRESULT (hex) = 0x00000000\n[2] Returned COM pointer (ppv) = native@0x1eeef60df60\n!!! ShellLink create FAILED !!!\n!!! HRESULT = 0x00000000\n!!! ppv = native@0x1eeef60df60\nError resolving: pdf-sample_0.pdf.lnk\n</code></pre>\n<p>My question: Why would JNA treat this COM pointer as invalid when CoCreateInstance returns S_OK? Am I using the incorrect COM IDs for the classes/interfaces? Wrong virtual table indices? Or something else?</p>\n<p><strong>Relevant Code</strong></p>\n<p><strong>1. Relevant Config.java constants</strong></p>\n<pre><code>public static final String WIN32_CLASS_ID_OBJECT_SHELL_LINK = &quot;{00021401-0000-0000-C000-000000000046}&quot;;\npublic static final String WIN32_INTERFACE_ID_SHELL_LINK_WIDE = &quot;{000214F9-0000-0000-C000-000000000046}&quot;;\npublic static final String WIN32_INTERFACE_ID_PERSIST_FILE = &quot;{0000010B-0000-0000-C000-000000000046}&quot;;\npublic static final int WIN32_MAX_PATH = 260;\npublic static final int WIN32_VTABLE_GETPATH = 20;\npublic static final int WIN32_VTABLE_RESOLVE = 21;\npublic static final int WIN32_VTABLE_LOAD = 5;\n</code></pre>\n<p><strong>2. ShellLink.createLink snippet (seems like the main issue is happening here)</strong></p>\n<pre><code>public static IShellLinkW createShellLink() {\n\n    // Initialize COM\n    WinNT.HRESULT initRes = Ole32.INSTANCE.CoInitialize(null);\n\n    // Create the ShellLink COM object\n    PointerByReference ppv = new PointerByReference();\n    WinNT.HRESULT hres = Ole32.INSTANCE.CoCreateInstance(\n            CLSID_SHELL_LINK,\n            null,\n            WTypes.CLSCTX_INPROC_SERVER,\n            IID_SHELL_LINK_W,\n            ppv\n    );\n\n    Pointer rawPtr = ppv.getValue();\n\n    // Failure\n    if (hres == null || hres.intValue() != WinNT.S_OK || rawPtr == null) {\n        Ole32.INSTANCE.CoUninitialize();\n        return null;\n    }\n\n    // Success\n    return new IShellLinkW(rawPtr);\n}\n</code></pre>\n<p>Even though hres == S_OK and rawPtr != null, this if block still runs.</p>\n<p>I am running a Windows 10 machine, and the code runs on Java 17 with JNA 5.13.0. The folder I'm scanning is %APPDATA%\\Microsoft\\Windows\\Recent. If it helps, this app is a JavaFX app.</p>\n<p>If it helps, here's a <a href=\"https://github.com/smhussa22/filespark\" rel=\"nofollow noreferrer\">link</a> to the GitHub repository. I would very much appreciate some guidance, thank you!</p>\n"
  },
  "answers": [
    {
      "owner": {
        "account_id": 1187908,
        "reputation": 9345,
        "user_id": 1161484,
        "user_type": "registered",
        "accept_rate": 93,
        "profile_image": "https://www.gravatar.com/avatar/371797a0137ad4519049f88afac2d4e7?s=256&d=identicon&r=PG",
        "display_name": "Daniel Widdis",
        "link": "https://stackoverflow.com/users/1161484/daniel-widdis"
      },
      "is_accepted": false,
      "score": 1,
      "last_activity_date": 1763842280,
      "creation_date": 1763842280,
      "answer_id": 79827534,
      "question_id": 79827044,
      "content_license": "CC BY-SA 4.0",
      "body": "<blockquote>\n<p>Am I using the incorrect COM IDs for the classes/interfaces?</p>\n</blockquote>\n<p>Those look correct.</p>\n<blockquote>\n<p>Wrong virtual table indices?</p>\n</blockquote>\n<p>Yes, you're using the wrong virtual table indices.</p>\n<p>The Unknown class consumes the first three indices (0, 1, 2) and after that you'd count <a href=\"https://microsoft.github.io/windows-docs-rs/doc/windows/Win32/UI/Shell/struct.IShellLinkW_Vtbl.html\" rel=\"nofollow noreferrer\">the IShellLinkW functions</a> in order:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public static final int WIN32_VTABLE_GETPATH = 3; // not 20\npublic static final int WIN32_VTABLE_RESOLVE = 19; // not 21\n</code></pre>\n<p>Your question doesn't include the actual method call producing the error, but given the message includes the word &quot;resolve&quot; the above changes will likely fix your problem.</p>\n<p>Your <a href=\"https://microsoft.github.io/windows-docs-rs/doc/windows/Win32/System/Com/struct.IPersistFile_Vtbl.html\" rel=\"nofollow noreferrer\">IPersistFile functions</a> start indexing at 4 (it extends IPersist with one function and Unknown with three) so this one is correct.</p>\n<pre class=\"lang-java prettyprint-override\"><code>public static final int WIN32_VTABLE_LOAD = 5;\n</code></pre>\n<p>One other suggestion to improve your code: rather than manually checking all the <code>HRESULT</code> values, just use <code>ComUtils</code> methods like <code>checkRC()</code> or <code>FAILED()</code>/<code>SUCCEEDED()</code>.</p>\n"
    }
  ],
  "question_comments": [],
  "answer_comments": {
    "79827534": []
  }
}