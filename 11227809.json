{
  "question": {
    "tags": [
      "java",
      "c++",
      "performance",
      "cpu-architecture",
      "branch-prediction"
    ],
    "owner": {
      "account_id": 31692,
      "reputation": 506155,
      "user_id": 87234,
      "user_type": "registered",
      "accept_rate": 100,
      "profile_image": "https://i.sstatic.net/FkjBe.png?s=256",
      "display_name": "GManNickG",
      "link": "https://stackoverflow.com/users/87234/gmannickg"
    },
    "is_answered": true,
    "view_count": 1959316,
    "protected_date": 1399067470,
    "accepted_answer_id": 11227902,
    "answer_count": 25,
    "score": 27499,
    "last_activity_date": 1753188482,
    "creation_date": 1340805096,
    "last_edit_date": 1748010184,
    "question_id": 11227809,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/11227809/why-is-processing-a-sorted-array-faster-than-processing-an-unsorted-array",
    "title": "Why is processing a sorted array faster than processing an unsorted array?",
    "body": "<p>In this C++ code, sorting the data (<em>before</em> the timed region) makes the primary loop ~6x faster:</p>\n<pre class=\"lang-cpp prettyprint-override\"><code>#include &lt;algorithm&gt;\n#include &lt;ctime&gt;\n#include &lt;iostream&gt;\n\nint main()\n{\n    // Generate data\n    const unsigned arraySize = 32768;\n    int data[arraySize];\n\n    for (unsigned c = 0; c &lt; arraySize; ++c)\n        data[c] = std::rand() % 256;\n\n    // !!! With this, the next loop runs faster.\n    std::sort(data, data + arraySize);\n\n    // Test\n    clock_t start = clock();\n    long long sum = 0;\n    for (unsigned i = 0; i &lt; 100000; ++i)\n    {\n        for (unsigned c = 0; c &lt; arraySize; ++c)\n        {   // Primary loop.\n            if (data[c] &gt;= 128)\n                sum += data[c];\n        }\n    }\n\n    double elapsedTime = static_cast&lt;double&gt;(clock()-start) / CLOCKS_PER_SEC;\n\n    std::cout &lt;&lt; elapsedTime &lt;&lt; '\\n';\n    std::cout &lt;&lt; &quot;sum = &quot; &lt;&lt; sum &lt;&lt; '\\n';\n}\n</code></pre>\n<ul>\n<li>Without <code>std::sort(data, data + arraySize);</code>, the code runs in 11.54 seconds.</li>\n<li>With the sorted data, the code runs in 1.93 seconds.</li>\n</ul>\n<p>(Sorting itself takes more time than this one pass over the array, so it's not actually worth doing if we needed to calculate this for an unknown array.)</p>\n<hr />\n<p>Initially, I thought this might be just a language or compiler anomaly, so I tried Java:</p>\n<pre class=\"lang-java prettyprint-override\"><code>import java.util.Arrays;\nimport java.util.Random;\n\npublic class Main\n{\n    public static void main(String[] args)\n    {\n        // Generate data\n        int arraySize = 32768;\n        int data[] = new int[arraySize];\n\n        Random rnd = new Random(0);\n        for (int c = 0; c &lt; arraySize; ++c)\n            data[c] = rnd.nextInt() % 256;\n\n        // !!! With this, the next loop runs faster\n        Arrays.sort(data);\n\n        // Test\n        long start = System.nanoTime();\n        long sum = 0;\n        for (int i = 0; i &lt; 100000; ++i)\n        {\n            for (int c = 0; c &lt; arraySize; ++c)\n            {   // Primary loop.\n                if (data[c] &gt;= 128)\n                    sum += data[c];\n            }\n        }\n\n        System.out.println((System.nanoTime() - start) / 1000000000.0);\n        System.out.println(&quot;sum = &quot; + sum);\n    }\n}\n</code></pre>\n<p>With a similar but less extreme result.</p>\n<hr />\n<p>My first thought was that sorting brings the data into the <a href=\"https://en.wikipedia.org/wiki/CPU_cache\" rel=\"noreferrer\">cache</a>, but that's silly because the array was just generated.</p>\n<ul>\n<li>What is going on?</li>\n<li>Why is processing a sorted array faster than processing an unsorted array?</li>\n</ul>\n<p>The code is summing up some independent terms, so the order should not matter.</p>\n<hr />\n<h2>Related / follow-up Q&amp;As with more modern C++ compilers</h2>\n<ul>\n<li><a href=\"https://stackoverflow.com/q/66521344\">Why is processing an unsorted array the same speed as processing a sorted array with modern x86-64 clang?</a> - <strong>modern C++ compilers auto-vectorize the loop</strong>, especially when SSE4.1 or AVX2 is available.  This avoids any data-dependent branching so performance isn't data-dependent.</li>\n<li><a href=\"https://stackoverflow.com/q/28875325\">gcc optimization flag -O3 makes code slower than -O2</a> - branchless scalar with <code>cmov</code> can result in a longer dependency chain (especially when GCC chooses poorly), creating a latency bottleneck that makes it slower than branchy asm for the sorted case.</li>\n</ul>\n"
  },
  "answers": [],
  "question_comments": [
    {
      "owner": {
        "account_id": 78868,
        "reputation": 377220,
        "user_id": 224132,
        "user_type": "registered",
        "accept_rate": 83,
        "profile_image": "https://i.sstatic.net/N4ivW.png?s=256",
        "display_name": "Peter Cordes",
        "link": "https://stackoverflow.com/users/224132/peter-cordes"
      },
      "reply_to_user": {
        "account_id": 7428050,
        "reputation": 914,
        "user_id": 5649936,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/661e20ca103f2357646581face8787be?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name": "Šimon Hrabec",
        "link": "https://stackoverflow.com/users/5649936/%c5%a0imon-hrabec"
      },
      "edited": false,
      "score": 1,
      "creation_date": 1711712583,
      "post_id": 11227809,
      "comment_id": 137941445,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 7428050,
        "reputation": 914,
        "user_id": 5649936,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/661e20ca103f2357646581face8787be?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name": "Šimon Hrabec",
        "link": "https://stackoverflow.com/users/5649936/%c5%a0imon-hrabec"
      },
      "reply_to_user": {
        "account_id": 3324724,
        "reputation": 1244,
        "user_id": 2795046,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/37d94521e300f95ac572db4b39ed05d5?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name": "nicolai",
        "link": "https://stackoverflow.com/users/2795046/nicolai"
      },
      "edited": false,
      "score": 2,
      "creation_date": 1711706358,
      "post_id": 11227809,
      "comment_id": 137940732,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 78868,
        "reputation": 377220,
        "user_id": 224132,
        "user_type": "registered",
        "accept_rate": 83,
        "profile_image": "https://i.sstatic.net/N4ivW.png?s=256",
        "display_name": "Peter Cordes",
        "link": "https://stackoverflow.com/users/224132/peter-cordes"
      },
      "reply_to_user": {
        "account_id": 321401,
        "reputation": 19130,
        "user_id": 640205,
        "user_type": "registered",
        "accept_rate": 94,
        "profile_image": "https://www.gravatar.com/avatar/54b992871265b6997dd53e13bb6fdc67?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name": "JustBeingHelpful",
        "link": "https://stackoverflow.com/users/640205/justbeinghelpful"
      },
      "edited": false,
      "score": 1,
      "creation_date": 1708378290,
      "post_id": 11227809,
      "comment_id": 137550814,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 3324724,
        "reputation": 1244,
        "user_id": 2795046,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/37d94521e300f95ac572db4b39ed05d5?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name": "nicolai",
        "link": "https://stackoverflow.com/users/2795046/nicolai"
      },
      "reply_to_user": {
        "account_id": 7428050,
        "reputation": 914,
        "user_id": 5649936,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/661e20ca103f2357646581face8787be?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name": "Šimon Hrabec",
        "link": "https://stackoverflow.com/users/5649936/%c5%a0imon-hrabec"
      },
      "edited": false,
      "score": 4,
      "creation_date": 1705156332,
      "post_id": 11227809,
      "comment_id": 137176305,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 78868,
        "reputation": 377220,
        "user_id": 224132,
        "user_type": "registered",
        "accept_rate": 83,
        "profile_image": "https://i.sstatic.net/N4ivW.png?s=256",
        "display_name": "Peter Cordes",
        "link": "https://stackoverflow.com/users/224132/peter-cordes"
      },
      "reply_to_user": {
        "account_id": 1426955,
        "reputation": 9448,
        "user_id": 1350209,
        "user_type": "registered",
        "accept_rate": 100,
        "profile_image": "https://www.gravatar.com/avatar/bd2f0eb2365d2a1fcd6f4eb4d40366b1?s=256&d=identicon&r=PG",
        "display_name": "Cole Tobin",
        "link": "https://stackoverflow.com/users/1350209/cole-tobin"
      },
      "edited": false,
      "score": 3,
      "creation_date": 1701123253,
      "post_id": 11227809,
      "comment_id": 136733980,
      "content_license": "CC BY-SA 4.0"
    }
  ],
  "answer_comments": {}
}