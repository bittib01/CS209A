{
  "question": {
    "tags": [
      "javascript",
      "java",
      "digital-signature",
      "ecdsa",
      "webcrypto-api"
    ],
    "owner": {
      "account_id": 1964164,
      "reputation": 410,
      "user_id": 1764836,
      "user_type": "registered",
      "profile_image": "https://i.sstatic.net/BZPBx.jpg?s=256",
      "display_name": "Sajid Hussain",
      "link": "https://stackoverflow.com/users/1764836/sajid-hussain"
    },
    "is_answered": true,
    "view_count": 1648,
    "accepted_answer_id": 68770875,
    "answer_count": 1,
    "score": 3,
    "last_activity_date": 1764884791,
    "creation_date": 1628848578,
    "last_edit_date": 1764884791,
    "question_id": 68770259,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/68770259/failing-to-verify-ecdsa-signature-using-webcrypto",
    "title": "Failing to verify ECDSA signature using WebCrypto",
    "body": "<p>I am trying to verify an ECDSA signature via WebCrypto and failing. The signature is created using Java (Bouncy Castle). The curve used is secp256r1 and SHA256 hash is used at signature creation. Then I tried creating signature using RSA (SHA256) in Java and tried verified in WebCrypto and succeeded. This seems like an ECDSA specific issue. In java I exported the public key in SPKI and then imported successfully in WebCrypto. What could be causing WebCrypto to fail verifying ECDSA based keys.</p>\n<pre><code>let publicKey;\nconst verifyButton = document.querySelector(&quot;.spki .encrypt-button&quot;);\n\nconsole.log(&quot;Starting js code&quot;);\n\nconst content = str2ab('HelloWorld');\nconst signatureB64 = 'MEUCIEAcdw929MCVQhk7BxHslo4cq0TwmkaNtL/JQgbbef1JAiEA5WKai5VCMhwKs7Zyh7fiG2DIKxoytw9OaYwsfA0etzY=';\nconst signature = str2ab(window.atob(signatureB64));\n\nconst pemEncodedKey = `-----BEGIN PUBLIC KEY-----\nMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE5J8msRi8yYS8ndRquLAXW4K7tdra9Awgl1CmOPPQsfFHYieZWMdWkcxreYI/hrbnwKP7MtjcTrt8seoVUprx8Q==\n-----END PUBLIC KEY-----`;\n\nfunction importECDSAKey(pem) {\n    // fetch the part of the PEM string between header and footer\n    const pemHeader = &quot;-----BEGIN PUBLIC KEY-----&quot;;\n    const pemFooter = &quot;-----END PUBLIC KEY-----&quot;;\n    const pemContents = pem.substring(pemHeader.length, pem.length - pemFooter.length);\n    // base64 decode the string to get the binary data\n    const binaryDerString = window.atob(pemContents);\n    // convert from a binary string to an ArrayBuffer\n    const binaryDer = str2ab(binaryDerString);\n\n    return window.crypto.subtle.importKey(\n      &quot;spki&quot;,\n      binaryDer,\n      {\n        name: &quot;ECDSA&quot;,\n        namedCurve: 'P-256'\n      },\n      true,\n      [&quot;verify&quot;]\n    );\n}\n\n\nasync function verifySignature() {\n    //download(&quot;signatureecdsa_13Aug.bin&quot;, window.btoa(window.atob(signatureB64)));\n    console.log(&quot;Verify Content: &quot; + content);\n    console.log(&quot;Verify Signature: &quot; + signature);\n    let result = await window.crypto.subtle.verify(\n      {\n        name: &quot;ECDSA&quot;,\n        namedCurve: 'P-256',\n        hash: {name: &quot;SHA-256&quot;},\n      },\n      publicKey,\n      signature,\n      content\n    );\n    console.log(result ? &quot;valid&quot; : &quot;invalid&quot;);\n    \n}\n\nfunction str2ab(str) {\n    const buf = new ArrayBuffer(str.length);\n    const bufView = new Uint8Array(buf);\n    for (let i = 0, strLen = str.length; i &lt; strLen; i++) {\n      bufView[i] = str.charCodeAt(i);\n    }\n    return buf;\n}\n\nconst importKeyButton = document.querySelector(&quot;.spki .import-key-button&quot;);\n  importKeyButton.addEventListener(&quot;click&quot;, async () =&gt; {\n    publicKey = await importECDSAKey(pemEncodedKey);\n    console.log(publicKey);\n    \n  });\n\nverifyButton.addEventListener(&quot;click&quot;, async () =&gt; {\n    verifySignature();\n    \n});\n</code></pre>\n<pre class=\"lang-html prettyprint-override\"><code>&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;style&gt;\n/* General setup */\n\n* {\n    box-sizing: border-box;\n}\n\nhtml,body {\n    font-family: sans-serif;\n    line-height: 1.2rem;\n}\n\n/* Layout and styles */\n\nh1 {\n    color: green;\n    margin-left: .5rem;\n}\n\n.description, .sign-verify {\n    margin: 0 .5rem;\n}\n\n.description &gt; p {\n    margin-top: 0;\n}\n\n.sign-verify {\n    box-shadow: -1px 2px 5px gray;\n    padding: .2rem .5rem;\n    margin-bottom: 2rem;\n}\n\n.sign-verify-controls &gt; * {\n    margin: .5rem 0;\n}\n\ninput[type=&quot;button&quot;] {\n    width: 5rem;\n}\n\n.signature-value {\n    padding-left: .5rem;\n    font-family: monospace;\n}\n\n/* Validity CSS */\n.valid {\n    color: green;\n}\n\n.invalid {\n    color: red;\n}\n\n.invalid::after {\n    content: ' ✖';\n}\n\n.valid::after {\n    content: ' ✓';\n}\n\n/* Whole page grid */\nmain {\n    display: grid;\n    grid-template-columns: 32rem 1fr;\n    grid-template-rows: 4rem 1fr;\n}\n\nh1 {\n    grid-column: 1/2;\n    grid-row: 1;\n}\n\n.examples {\n    grid-column: 1;\n    grid-row: 2;\n}\n\n.description {\n    grid-column: 2;\n    grid-row: 2;\n}\n\n/* sign-verify controls grid */\n.sign-verify-controls {\n    display: grid;\n    grid-template-columns: 1fr 5rem;\n    grid-template-rows: 1fr 1fr;\n}\n\n.message-control {\n    grid-column-start: 1;\n    grid-row-start: 1;\n}\n\n.signature {\n    grid-column-start: 1;\n    grid-row-start: 2;\n}\n\n.sign-button {\n    grid-column-start: 2;\n    grid-row-start: 1;\n}\n\n.verify-button {\n    grid-column-start: 2;\n    grid-row-start: 2;\n}\n\n/* Animate output display */\n.fade-in {\n    animation: fadein .5s;\n}\n\n@keyframes fadein {\n    from {\n        opacity: 0;\n    }\n    to {\n        opacity: 1;\n    }\n}\n&lt;/style&gt;\n&lt;head&gt;\n &lt;meta charset=&quot;utf-8&quot;&gt;\n    &lt;!-- head definitions go here --&gt;\n&lt;/head&gt;\n&lt;body onload=&quot;&quot;&gt;\n      &lt;section class=&quot;import-key spki&quot;&gt;\n      &lt;h2 class=&quot;import-key-heading&quot;&gt;ECDSA Siganture Verification&lt;/h2&gt;\n      &lt;section class=&quot;import-key-controls&quot;&gt;\n        &lt;input class=&quot;import-key-button&quot; type=&quot;button&quot; value=&quot;Import Key&quot;&gt;\n        &lt;input class=&quot;encrypt-button&quot; type=&quot;button&quot; value=&quot;Verify&quot;&gt;\n      &lt;/section&gt;\n    &lt;/section&gt;\n&lt;/body&gt;\n    &lt;script src=&quot;sample.js&quot;&gt;&lt;/script&gt;\n    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/node-forge@0.7.0/dist/forge.min.js&quot;&gt;&lt;/script&gt;\n&lt;/html&gt;\n\n</code></pre>\n<p>The signature verifiable in java:</p>\n<pre><code>/*\n * To change this license header, choose License Headers in Project Properties.\n * To change this template file, choose Tools | Templates\n * and open the template in the editor.\n */\npackage com.text.pkcs1;\n\nimport java.io.ByteArrayInputStream;\nimport java.io.IOException;\nimport java.io.UnsupportedEncodingException;\nimport java.security.InvalidKeyException;\nimport java.security.NoSuchAlgorithmException;\nimport java.security.Security;\nimport java.security.Signature;\nimport java.security.SignatureException;\nimport java.security.cert.CertificateException;\nimport java.security.cert.CertificateFactory;\nimport java.security.cert.X509Certificate;\nimport java.util.Base64;\nimport org.bouncycastle.jce.provider.BouncyCastleProvider;\n\n/**\n *\n * @author Sajid Hussain\n */\npublic class ECDSASignatureVerifier {\n\n    static String content = &quot;HelloWorld&quot;;\n    static String sigantureB64 = &quot;MEUCIEAcdw929MCVQhk7BxHslo4cq0TwmkaNtL/JQgbbef1JAiEA5WKai5VCMhwKs7Zyh7fiG2DIKxoytw9OaYwsfA0etzY=&quot;;\n    static String pemEncodedCert = &quot;-----BEGIN CERTIFICATE-----\\n&quot;\n            + &quot;MIIDQTCCAimgAwIBAgIUUm4Lc5DyI1TgpT2FdmDW1TIJ8rQwDQYJKoZIhvcNAQEL\\n&quot;\n            + &quot;BQAwODELMAkGA1UEBhMCUEsxEDAOBgNVBAoTB0NvZGVnaWMxFzAVBgNVBAMTDkNv\\n&quot;\n            + &quot;ZGVnaWMgU3ViIENBMB4XDTIxMDgxMjEwMTE0M1oXDTI2MDgxMjEwMTE0M1owHTEb\\n&quot;\n            + &quot;MBkGA1UEAxMSRUNEU0EtVGVzdGluZy1DZXJ0MFkwEwYHKoZIzj0CAQYIKoZIzj0D\\n&quot;\n            + &quot;AQcDQgAE5J8msRi8yYS8ndRquLAXW4K7tdra9Awgl1CmOPPQsfFHYieZWMdWkcxr\\n&quot;\n            + &quot;eYI/hrbnwKP7MtjcTrt8seoVUprx8aOCAScwggEjMA4GA1UdDwEB/wQEAwIGwDAf\\n&quot;\n            + &quot;BgNVHSMEGDAWgBRMIjotWPXzdcBEsvsWI9GGgsK5sTCBxQYDVR0gBIG9MIG6MIG3\\n&quot;\n            + &quot;BgkrBgEEAYOoZAEwgakwgaYGCCsGAQUFBwICMIGZDIGWQXMgcGVyIHRoaXMgcG9s\\n&quot;\n            + &quot;aWN5IGlkZW50aXR5IG9mIHRoZSBzdWJqZWN0IGlzIG5vdCBpZGVudGlmaWVkLiBZ\\n&quot;\n            + &quot;b3UgbXVzdCBub3QgdXNlIHRoZXNlIGNlcnRpZmljYXRlcyBmb3IgdmFsdWFibGUg\\n&quot;\n            + &quot;dHJhbnNhY3Rpb25zLiBOTyBMSUFCSUxJVFkgSVMgQUNDRVBURUQuMAkGA1UdEwQC\\n&quot;\n            + &quot;MAAwHQYDVR0OBBYEFIEA+hTr95sTIKNgdm/qL3WdAB4MMA0GCSqGSIb3DQEBCwUA\\n&quot;\n            + &quot;A4IBAQAHcmrw0gjBdqjYowT4TsUBEL6Dei7gt/qEgDBOsewgESZmoDqSbZXNMHsJ\\n&quot;\n            + &quot;kvceQ3hCLt9FTQPijyXMQJyBSKdYym8PXk3BJRbZpl3Kdy/jZMBg10oZo5PMZh8i\\n&quot;\n            + &quot;MZNpvzdiULpAqtquRK1kUS/hB/5qnWuypuQgFdrM/S2IuJuTzdmUuTBt3yjK12Zp\\n&quot;\n            + &quot;8j8gqT1JlL/SYkFA3HvdFMu6t6pDWyfL3h48YpQqjpHw7H55IGKrBRhpDlGNYpO9\\n&quot;\n            + &quot;/MkNhaKlCKA6/LXqJ1Exonu+WbJk5X23F+SaThrxWR7iY7aIdLjj1Sqd73wKhtM8\\n&quot;\n            + &quot;39gP1Xtl+AyoVLHyXFvqbuwyZaPU\\n&quot;\n            + &quot;-----END CERTIFICATE-----&quot;;\n\n    public static void main(String[] args) throws IOException, CertificateException, NoSuchAlgorithmException, InvalidKeyException, SignatureException {\n        Security.removeProvider(&quot;BC&quot;);\n        Security.addProvider(new BouncyCastleProvider());\n        verifyTextSiganture();\n    }\n\n    private static void verifyTextSiganture() throws NoSuchAlgorithmException, InvalidKeyException, SignatureException, UnsupportedEncodingException, CertificateException {\n        Base64.Decoder decoder = Base64.getDecoder();\n        Signature signAlg = Signature.getInstance(&quot;SHA256withECDSA&quot;);\n        CertificateFactory certFactory = CertificateFactory.getInstance(&quot;X.509&quot;);\n        X509Certificate signerCertificate = (X509Certificate) certFactory.generateCertificate(new ByteArrayInputStream(pemEncodedCert.getBytes()));\n        signAlg.initVerify(signerCertificate.getPublicKey());\n        signAlg.update(content.getBytes());\n        boolean result = signAlg.verify(decoder.decode(sigantureB64.getBytes()));\n        System.out.println(&quot;Verification Result: &quot; + result);\n    }\n\n}\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}