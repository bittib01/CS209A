{
  "question": {
    "tags": [
      "java",
      "spring",
      "nginx",
      "websocket",
      "sockjs"
    ],
    "owner": {
      "account_id": 1261634,
      "reputation": 26144,
      "user_id": 1219755,
      "user_type": "registered",
      "accept_rate": 84,
      "profile_image": "https://i.sstatic.net/UmjNt.jpg?s=256",
      "display_name": "alexanoid",
      "link": "https://stackoverflow.com/users/1219755/alexanoid"
    },
    "is_answered": true,
    "view_count": 10209,
    "accepted_answer_id": 40367268,
    "answer_count": 3,
    "score": 3,
    "last_activity_date": 1764766819,
    "creation_date": 1478027675,
    "last_edit_date": 1495542755,
    "question_id": 40367068,
    "content_license": "CC BY-SA 3.0",
    "link": "https://stackoverflow.com/questions/40367068/spring-sockjs-error-during-websocket-handshake-unexpected-response-code-400",
    "title": "Spring, SockJS - error during WebSocket handshake: Unexpected response code 400",
    "body": "<p>I have implemented BE application with WebSockets support using Spring Boot. I use SockJS in order to connect to my WebSocket endpoint and during the connection process I get a following error:</p>\n\n<pre><code>error during WebSocket handshake: Unexpected response code: 400\n</code></pre>\n\n<p><a href=\"https://i.sstatic.net/McKKy.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/McKKy.png\" alt=\"enter image description here\"></a></p>\n\n<p>but then (as you can see at the image above) everything is working fine and websocket  opened. </p>\n\n<p>Right now I don't understand what can be a reason of this issue and how to fix it. Please help.</p>\n\n<p><strong>UPDATED</strong></p>\n\n<p>Thanks for the <a href=\"https://stackoverflow.com/users/3574103/paweln1986\"><strong>paweln1986</strong></a> help I have fixed version issue with SockJS lib but the issue with Unexpected response code 400 still exists:</p>\n\n<p><a href=\"https://i.sstatic.net/StPzJ.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/StPzJ.png\" alt=\"enter image description here\"></a></p>\n\n<p>I also using nginx in front of Tomcat 8. This is my nginx config:</p>\n\n<pre><code>server {\n    listen          443 ssl;        \n    server_name  myserver.com;\n    ssl on;\n\n    location /api/ {                                                                                                                                                                                                                                             \n        proxy_pass_header X-XSRF-TOKEN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \n        proxy_pass        http://localhost:8081/api/;                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \n        proxy_set_header Origin \"http://localhost:8081/api/\";                                                                                                                                                                                                    \n\n        proxy_set_header Host $host;                                                                                                                                                                                                                             \n        proxy_set_header X-Real-IP $remote_addr;                                                                                                                                                                                                                 \n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;                                                                                                                                                                                             \n        proxy_http_version 1.1;                                                                                                                                                                                                                                  \n    }                                                                                                                                                                                                                                                            \n\n    location /dashboard/ {\n        proxy_pass        http://localhost:8081/dashboard/;\n\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n\n    location /manager {\n        proxy_pass        http://localhost:8081/manager/;\n\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    }        \n\n    location / {\n        root   /srv/www/htdocs/myserver/;\n        index  index.html index.htm;\n    }\n\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   /srv/www/htdocs/;\n    }        \n\n} \n</code></pre>\n"
  },
  "answers": [
    {
      "owner": {
        "account_id": 10850257,
        "reputation": 797,
        "user_id": 7978231,
        "user_type": "registered",
        "accept_rate": 90,
        "profile_image": "https://www.gravatar.com/avatar/3c63089164eb455c963299bccd2e1aa7?s=256&d=identicon&r=PG",
        "display_name": "Orkhan Hasanli",
        "link": "https://stackoverflow.com/users/7978231/orkhan-hasanli"
      },
      "is_accepted": false,
      "score": 1,
      "last_activity_date": 1764766819,
      "creation_date": 1764766819,
      "answer_id": 79836914,
      "question_id": 40367068,
      "content_license": "CC BY-SA 4.0",
      "body": "<p>I have faced with this issue after upgrading to the Spring Boot 4.0.x from Spring 3.5.x.</p>\n<p>The reason was that I'm used API versioning with path segment:</p>\n<pre><code>spring:\n  mvc:\n    api-version:\n      use:\n        path-segment: 0\n      supported:\n        - 1.0.0\n      default: 1.0.0\n</code></pre>\n<p>For some reasons Spring applied this logic also for SockJS endpoint /ws/info</p>\n<p>Also tried to write Java configuration like that:</p>\n<pre><code>@Configuration\npublic class ApiVersionConfig implements WebMvcConfigurer {\n\n   @Override\n   public void configureApiVersioning(ApiVersionConfigurer configurer) {\n       configurer\n               .addSupportedVersions(&quot;1.0.0&quot;)\n               .setDefaultVersion(&quot;1.0.0&quot;)\n               .usePathSegment(0);\n   }\n}\n</code></pre>\n<p>But the problem still persist. After that I tried to apply the filter like:</p>\n<pre><code>@Configuration\npublic class ApiVersionConfig implements WebMvcConfigurer {\n\n\n   @Override\n   public void configurePathMatch(PathMatchConfigurer configurer) {\n       configurer.addPathPrefix(&quot;/{version}&quot;, HandlerTypePredicate.forAnnotation(RestController.class));\n               .and(c -&gt; {\n                   var requestMapping = c.getAnnotation(org.springframework.web.bind.annotation.RequestMapping.class);\n                   if (requestMapping != null) {\n                       return Arrays.stream(requestMapping.value())\n                               .noneMatch(path -&gt; path.contains(&quot;/ws&quot;));\n                   }\n                   return true;\n               }));\n   }\n}\n</code></pre>\n<p>Problem solved by changing API versioning model to the header like:</p>\n<pre><code>spring:\n  mvc:\n    api-version:\n      use:\n        header: &quot;X-API-Version&quot;\n      supported:\n        - 1.0.0\n      default: 1.0.0\n</code></pre>\n<p>And the problem is gone.</p>\n"
    }
  ],
  "question_comments": [],
  "answer_comments": {
    "79836914": []
  }
}