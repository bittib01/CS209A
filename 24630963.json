{
  "question": {
    "tags": [
      "java",
      "nullpointerexception",
      "java-stream",
      "collectors"
    ],
    "owner": {
      "account_id": 3628411,
      "reputation": 6616,
      "user_id": 3025358,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/181c405f3c12e6b59c938e85f981776c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Jasper",
      "link": "https://stackoverflow.com/users/3025358/jasper"
    },
    "is_answered": true,
    "view_count": 227281,
    "accepted_answer_id": 24634007,
    "answer_count": 14,
    "score": 584,
    "last_activity_date": 1753117826,
    "creation_date": 1404819842,
    "last_edit_date": 1616101126,
    "question_id": 24630963,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/24630963/nullpointerexception-in-collectors-tomap-with-null-entry-values",
    "title": "NullPointerException in Collectors.toMap with null entry values",
    "body": "<p><code>Collectors.toMap</code> throws a <code>NullPointerException</code> if one of the values is <code>null</code>. I don't understand this behaviour, maps can contain null pointers as value without any problems. Is there a good reason why values cannot be null for <code>Collectors.toMap</code>?</p>\n<p>Also, is there a nice Java 8 way of fixing this, or should I revert to plain old for loop?</p>\n<p>An example of my problem:</p>\n<pre><code>import java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.stream.Collectors;\n\n\nclass Answer {\n    private int id;\n\n    private Boolean answer;\n\n    Answer() {\n    }\n\n    Answer(int id, Boolean answer) {\n        this.id = id;\n        this.answer = answer;\n    }\n\n    public int getId() {\n        return id;\n    }\n\n    public void setId(int id) {\n        this.id = id;\n    }\n\n    public Boolean getAnswer() {\n        return answer;\n    }\n\n    public void setAnswer(Boolean answer) {\n        this.answer = answer;\n    }\n}\n\npublic class Main {\n    public static void main(String[] args) {\n        List&lt;Answer&gt; answerList = new ArrayList&lt;&gt;();\n\n        answerList.add(new Answer(1, true));\n        answerList.add(new Answer(2, true));\n        answerList.add(new Answer(3, null));\n\n        Map&lt;Integer, Boolean&gt; answerMap =\n        answerList\n                .stream()\n                .collect(Collectors.toMap(Answer::getId, Answer::getAnswer));\n    }\n}\n</code></pre>\n<p>Stacktrace:</p>\n<pre><code>Exception in thread &quot;main&quot; java.lang.NullPointerException\n    at java.util.HashMap.merge(HashMap.java:1216)\n    at java.util.stream.Collectors.lambda$toMap$168(Collectors.java:1320)\n    at java.util.stream.Collectors$$Lambda$5/1528902577.accept(Unknown Source)\n    at java.util.stream.ReduceOps$3ReducingSink.accept(ReduceOps.java:169)\n    at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1359)\n    at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:512)\n    at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:502)\n    at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708)\n    at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\n    at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:499)\n    at Main.main(Main.java:48)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke(Method.java:483)\n    at com.intellij.rt.execution.application.AppMain.main(AppMain.java:134)\n</code></pre>\n<p>This problem still exists in Java 11.</p>\n"
  },
  "answers": [
    {
      "owner": {
        "account_id": 223715,
        "reputation": 12995,
        "user_id": 483113,
        "user_type": "registered",
        "accept_rate": 89,
        "profile_image": "https://www.gravatar.com/avatar/5e6ce1def86e084cf06ac3a5a7e2d74f?s=256&d=identicon&r=PG",
        "display_name": "sjngm",
        "link": "https://stackoverflow.com/users/483113/sjngm"
      },
      "is_accepted": false,
      "score": 14,
      "last_activity_date": 1753117826,
      "last_edit_date": 1753117826,
      "creation_date": 1491679670,
      "answer_id": 43299462,
      "question_id": 24630963,
      "content_license": "CC BY-SA 4.0",
      "body": "<p><em>Yep, a late answer from me, but I think it may help to understand what's happening under the hood in case anyone wants to code some other <code>Collector</code>-logic.</em></p>\n<p>I tried to solve the problem by coding a more native and straight forward approach. I think it's as direct as possible:</p>\n<pre><code>public class LambdaUtilities {\n\n  /**\n   * In contrast to {@link Collectors#toMap(Function, Function)} the result map\n   * may have null values.\n   */\n  public static &lt;T, K, U&gt; Collector&lt;T, ?, Map&lt;K, U&gt;&gt; toMapWithNullValues(Function&lt;? super T, ? extends K&gt; keyMapper, Function&lt;? super T, ? extends U&gt; valueMapper) {\n    return toMapWithNullValues(keyMapper, valueMapper, HashMap::new);\n  }\n\n  /**\n   * In contrast to {@link Collectors#toMap(Function, Function, BinaryOperator, Supplier)}\n   * the result map may have null values.\n   */\n  public static &lt;T, K, U, M extends Map&lt;K, U&gt;&gt; Collector&lt;T, ?, M&gt; toMapWithNullValues(Function&lt;? super T, ? extends K&gt; keyMapper, Function&lt;? super T, ? extends U&gt; valueMapper, Supplier&lt;M&gt; supplier) {\n    return new Collector&lt;T, M, M&gt;() {\n\n      @Override\n      public Supplier&lt;M&gt; supplier() {\n        return supplier;\n      }\n\n      @Override\n      public BiConsumer&lt;M, T&gt; accumulator() {\n        return (map, element) -&gt; {\n          K key = keyMapper.apply(element);\n          if (map.containsKey(key)) {\n            throw new IllegalStateException(&quot;Duplicate key &quot; + key);\n          }\n          map.put(key, valueMapper.apply(element));\n        };\n      }\n\n      @Override\n      public BinaryOperator&lt;M&gt; combiner() {\n        return (left, right) -&gt; {\n          int total = left.size() + right.size();\n          left.putAll(right);\n          if (left.size() &lt; total) {\n            throw new IllegalStateException(&quot;Duplicate key(s)&quot;);\n          }\n          return left;\n        };\n      }\n\n      @Override\n      public Function&lt;M, M&gt; finisher() {\n        return Function.identity();\n      }\n\n      @Override\n      public Set&lt;Collector.Characteristics&gt; characteristics() {\n        return Collections.unmodifiableSet(EnumSet.of(Collector.Characteristics.IDENTITY_FINISH));\n      }\n\n    };\n  }\n\n}\n</code></pre>\n<p>And the tests using JUnit and assertj:</p>\n<pre><code>  @Test\n  public void testToMapWithNullValues() throws Exception {\n    Map&lt;Integer, Integer&gt; result = Stream.of(1, 2, 3)\n        .collect(LambdaUtilities.toMapWithNullValues(Function.identity(), x -&gt; x % 2 == 1 ? x : null));\n\n    assertThat(result)\n        .isExactlyInstanceOf(HashMap.class)\n        .hasSize(3)\n        .containsEntry(1, 1)\n        .containsEntry(2, null)\n        .containsEntry(3, 3);\n  }\n\n  @Test\n  public void testToMapWithNullValuesWithSupplier() throws Exception {\n    Map&lt;Integer, Integer&gt; result = Stream.of(1, 2, 3)\n        .collect(LambdaUtilities.toMapWithNullValues(Function.identity(), x -&gt; x % 2 == 1 ? x : null, LinkedHashMap::new));\n\n    assertThat(result)\n        .isExactlyInstanceOf(LinkedHashMap.class)\n        .hasSize(3)\n        .containsEntry(1, 1)\n        .containsEntry(2, null)\n        .containsEntry(3, 3);\n  }\n\n  @Test\n  public void testToMapWithNullValuesDuplicate() throws Exception {\n    assertThatThrownBy(() -&gt; Stream.of(1, 2, 3, 1)\n        .collect(LambdaUtilities.toMapWithNullValues(Function.identity(), x -&gt; x % 2 == 1 ? x : null)))\n            .isExactlyInstanceOf(IllegalStateException.class)\n            .hasMessage(&quot;Duplicate key 1&quot;);\n  }\n\n  @Test\n  public void testToMapWithNullValuesParallel() throws Exception {\n    Map&lt;Integer, Integer&gt; result = Stream.of(1, 2, 3)\n        .parallel() // this causes .combiner() to be called\n        .collect(LambdaUtilities.toMapWithNullValues(Function.identity(), x -&gt; x % 2 == 1 ? x : null));\n\n    assertThat(result)\n        .isExactlyInstanceOf(HashMap.class)\n        .hasSize(3)\n        .containsEntry(1, 1)\n        .containsEntry(2, null)\n        .containsEntry(3, 3);\n  }\n\n  @Test\n  public void testToMapWithNullValuesParallelWithDuplicates() throws Exception {\n    assertThatThrownBy(() -&gt; Stream.of(1, 2, 3, 1, 2, 3)\n        .parallel() // this causes .combiner() to be called\n        .collect(LambdaUtilities.toMapWithNullValues(Function.identity(), x -&gt; x % 2 == 1 ? x : null)))\n            .isExactlyInstanceOf(IllegalStateException.class)\n            .hasCauseExactlyInstanceOf(IllegalStateException.class)\n            .hasStackTraceContaining(&quot;Duplicate key&quot;);\n  }\n</code></pre>\n<p>And how do you use it? Well, just use it instead of <code>toMap()</code> like the tests show. This makes the calling code look as clean as possible.</p>\n<p>EDIT:<br />\nimplemented Holger's idea below, added a test method</p>\n"
    },
    {
      "owner": {
        "account_id": 985197,
        "reputation": 13109,
        "user_id": 1003886,
        "user_type": "registered",
        "accept_rate": 66,
        "profile_image": "https://i.sstatic.net/ECmJC.png?s=256",
        "display_name": "kajacx",
        "link": "https://stackoverflow.com/users/1003886/kajacx"
      },
      "is_accepted": true,
      "score": 563,
      "last_activity_date": 1716574139,
      "last_edit_date": 1716574139,
      "creation_date": 1404828562,
      "answer_id": 24634007,
      "question_id": 24630963,
      "content_license": "CC BY-SA 4.0",
      "body": "<p>You can work around this <a href=\"https://bugs.openjdk.java.net/browse/JDK-8148463\" rel=\"noreferrer\">known bug</a> in OpenJDK with this:</p>\n<pre><code>Map&lt;Integer, Boolean&gt; collect = list.stream()\n        .collect(HashMap::new, (m,v)-&gt;m.put(v.getId(), v.getAnswer()), HashMap::putAll);\n</code></pre>\n<p>It is not that pretty, but it works. Result:</p>\n<pre><code>1: true\n2: true\n3: null\n</code></pre>\n<p>(<a href=\"http://docs.oracle.com/javase/tutorial/collections/streams/reduction.html#collect\" rel=\"noreferrer\">this</a> tutorial helped me the most.)</p>\n<p><strong>EDIT:</strong></p>\n<p>Unlike <code>Collectors.toMap</code>, this will silently replace values if you have the same key multiple times, as @mmdemirbas pointed out in the comments. If you don't want this, look at the link in the comment.</p>\n"
    }
  ],
  "question_comments": [
    {
      "owner": {
        "account_id": 7958430,
        "reputation": 229,
        "user_id": 6006943,
        "user_type": "registered",
        "accept_rate": 35,
        "profile_image": "https://lh5.googleusercontent.com/-fvRsAs2Eq4I/AAAAAAAAAAI/AAAAAAAAAEo/QEzKkrO2cik/s256-rj/photo.jpg",
        "display_name": "Fran&#231;ois F.",
        "link": "https://stackoverflow.com/users/6006943/fran%c3%a7ois-f"
      },
      "edited": false,
      "score": 0,
      "creation_date": 1676384605,
      "post_id": 24630963,
      "comment_id": 133123332,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 284637,
        "reputation": 3927,
        "user_id": 582862,
        "user_type": "registered",
        "accept_rate": 43,
        "profile_image": "https://i.sstatic.net/YR5mf.jpg?s=256",
        "display_name": "Ikthiander",
        "link": "https://stackoverflow.com/users/582862/ikthiander"
      },
      "reply_to_user": {
        "account_id": 985197,
        "reputation": 13109,
        "user_id": 1003886,
        "user_type": "registered",
        "accept_rate": 66,
        "profile_image": "https://i.sstatic.net/ECmJC.png?s=256",
        "display_name": "kajacx",
        "link": "https://stackoverflow.com/users/1003886/kajacx"
      },
      "edited": false,
      "score": 0,
      "creation_date": 1553677203,
      "post_id": 24630963,
      "comment_id": 97468732,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 49078,
        "reputation": 47221,
        "user_id": 145989,
        "user_type": "registered",
        "accept_rate": 59,
        "profile_image": "https://www.gravatar.com/avatar/d0edf9d0f312ec47d27046845580ba4f?s=256&d=identicon&r=PG",
        "display_name": "Ondra Žižka",
        "link": "https://stackoverflow.com/users/145989/ondra-%c5%bdi%c5%beka"
      },
      "edited": false,
      "score": 1,
      "creation_date": 1543586939,
      "post_id": 24630963,
      "comment_id": 93983655,
      "content_license": "CC BY-SA 4.0"
    }
  ],
  "answer_comments": {
    "43299462": [
      {
        "owner": {
          "account_id": 8532578,
          "reputation": 49884,
          "user_id": 6395627,
          "user_type": "registered",
          "profile_image": "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
          "display_name": "Slaw",
          "link": "https://stackoverflow.com/users/6395627/slaw"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1753116937,
        "post_id": 43299462,
        "comment_id": 140606693,
        "content_license": "CC BY-SA 4.0"
      },
      {
        "owner": {
          "account_id": 223715,
          "reputation": 12995,
          "user_id": 483113,
          "user_type": "registered",
          "accept_rate": 89,
          "profile_image": "https://www.gravatar.com/avatar/5e6ce1def86e084cf06ac3a5a7e2d74f?s=256&d=identicon&r=PG",
          "display_name": "sjngm",
          "link": "https://stackoverflow.com/users/483113/sjngm"
        },
        "reply_to_user": {
          "account_id": 8532578,
          "reputation": 49884,
          "user_id": 6395627,
          "user_type": "registered",
          "profile_image": "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
          "display_name": "Slaw",
          "link": "https://stackoverflow.com/users/6395627/slaw"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1753114827,
        "post_id": 43299462,
        "comment_id": 140606589,
        "content_license": "CC BY-SA 4.0"
      },
      {
        "owner": {
          "account_id": 8532578,
          "reputation": 49884,
          "user_id": 6395627,
          "user_type": "registered",
          "profile_image": "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
          "display_name": "Slaw",
          "link": "https://stackoverflow.com/users/6395627/slaw"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1753110751,
        "post_id": 43299462,
        "comment_id": 140606385,
        "content_license": "CC BY-SA 4.0"
      }
    ],
    "24634007": [
      {
        "owner": {
          "account_id": 6295688,
          "reputation": 348,
          "user_id": 4891964,
          "user_type": "registered",
          "accept_rate": 67,
          "profile_image": "https://www.gravatar.com/avatar/2ea4969b0f00c9580b18433942a80b91?s=256&d=identicon&r=PG&f=y&so-version=2",
          "display_name": "Dawid",
          "link": "https://stackoverflow.com/users/4891964/dawid"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1665420131,
        "post_id": 24634007,
        "comment_id": 130691051,
        "content_license": "CC BY-SA 4.0"
      }
    ]
  }
}