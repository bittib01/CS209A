{
  "question": {
    "tags": [
      "java",
      "microsoft-graph-api"
    ],
    "owner": {
      "account_id": 6911888,
      "reputation": 173,
      "user_id": 5307407,
      "user_type": "registered",
      "accept_rate": 70,
      "profile_image": "https://graph.facebook.com/881390108596373/picture?type=large",
      "display_name": "Nitin Rathod",
      "link": "https://stackoverflow.com/users/5307407/nitin-rathod"
    },
    "is_answered": true,
    "view_count": 9430,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1764853220,
    "creation_date": 1660137883,
    "last_edit_date": 1749193292,
    "question_id": 73307144,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/73307144/read-and-write-email-using-microsoft-graph-api-java",
    "title": "Read and write email using Microsoft Graph API Java",
    "body": "<p>I want to read and send email using Microsoft Graph API. I have tried using DeviceCodeCredentials and it is working fine but I want to read emails without any user interaction in the backend. By using DeviceCodeCredentials, it asks me to login using my email id and enter the code provided.</p>\n<p>Below is the code I have written with ClientSecretCredentials which give me below error.</p>\n<pre class=\"lang-none prettyprint-override\"><code>Exception in thread &quot;main&quot; java.lang.RuntimeException: Unable to get access token\n    at com.eclerx.email.AccessProvider.accessToken(AccessProvider.java:30)\n    at com.eclerx.email.AuthenticationBuilder2.main(AuthenticationBuilder2.java:55)\n    Caused by: java.util.concurrent.ExecutionException: \n    com.microsoft.aad.msal4j.MsalServiceException: AADSTS1002012: The provided value for scope \n    User.read openid profile offline_access Mail.Read is not valid. Client credential flows must \n    have a scope value with /.default suffixed to the resource identifier (application ID URI).\n    Trace ID: ac0c217d-72c7-4ba0-9472-16c711ceea00\n    Correlation ID: 4d9f5a16-e2e6-4c26-a30e-40e3aa89d53b\n    Timestamp: 2022-08-10 13:15:35Z\n    at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:357)\n    at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1908)\n    at com.eclerx.email.AccessProvider.accessToken(AccessProvider.java:27)\n     ... 1 more\n    Caused by: com.microsoft.aad.msal4j.MsalServiceException: AADSTS1002012: The provided value \n    for scope User.read openid profile offline_access Mail.Read is not valid. Client credential \n    flows must have a scope value with /.default suffixed to the resource identifier (application \n    ID URI).\n    Trace ID: ac0c217d-72c7-4ba0-9472-16c711ceea00\n    Correlation ID: 4d9f5a16-e2e6-4c26-a30e-40e3aa89d53b\n    Timestamp: 2022-08-10 13:15:35Z\n    at \n    com.microsoft.aad.msal4j.MsalServiceExcepti\n    onFactory.fromHttpResponse(MsalServiceExceptionFactory.java:45)\n    at \n</code></pre>\n<p>Code is as below</p>\n<pre class=\"lang-java prettyprint-override\"><code>import java.util.Arrays;\nimport java.util.List;\n\nimport com.azure.identity.ClientSecretCredential;\nimport com.azure.identity.ClientSecretCredentialBuilder; \nimport com.azure.identity.DeviceCodeCredential;\nimport com.azure.identity.DeviceCodeCredentialBuilder;\nimport com.microsoft.graph.authentication.TokenCredentialAuthProvider;\nimport com.microsoft.graph.models.Message;\nimport com.microsoft.graph.models.User;\nimport com.microsoft.graph.requests.GraphServiceClient;\nimport com.microsoft.graph.requests.MessageCollectionPage;\n\nimport okhttp3.Request;\n\npublic class AuthenticationBuilder2 {\n    private static final String CLIENT_ID = &quot;*************&quot;;\n    private static final String CLIENT_SECRET_ID = &quot;**************&quot;;\n    private static final String CLIENT_SECRET = &quot;****************&quot;;\n    private static final String AUTH_TENANT = &quot;*************&quot;;\n    \n    private static final List&lt;String&gt; graphApiScopes = Arrays.asList(&quot;Mail.Read&quot;,&quot;User.read&quot;);\n    public AuthenticationBuilder2() {\n    }\n\n    public static AccessProvider initializeGraphForUserAuth() {\n\n        ClientSecretCredential clientSecretCredential =\n                new ClientSecretCredentialBuilder()\n                        .clientId(CLIENT_ID)\n                        .clientSecret(CLIENT_SECRET)\n                        .tenantId(AUTH_TENANT)\n                        .build();\n\n        /*final DeviceCodeCredential deviceCodeCred = new DeviceCodeCredentialBuilder()\n                .clientId(CLIENT_ID)\n                .tenantId(AUTH_TENANT)\n                .challengeConsumer(challange -&gt; System.out.println(challange.getMessage()))\n                .build();*/\n        TokenCredentialAuthProvider tokenCredentialAuthProvider = new TokenCredentialAuthProvider(graphApiScopes, clientSecretCredential);\n        //TokenCredentialAuthProvider tokenCredentialAuthProvider = new TokenCredentialAuthProvider(graphApiScopes, deviceCodeCred);\n        \n        GraphServiceClient&lt;Request&gt; graphServiceClient = GraphServiceClient.builder()\n                .authenticationProvider(tokenCredentialAuthProvider)\n                .buildClient();\n\n        return new AccessProvider(graphServiceClient, tokenCredentialAuthProvider);\n    }\n\n    public static void main(String[] args) {\n        AccessProvider accessProvider = AuthenticationBuilder.initializeGraphForUserAuth();\n        // get token\n        System.out.println(&quot;token : &quot; + accessProvider.accessToken());\n\n        System.out.println(accessProvider.getServiceClient().users());\n        \n        \n        User user = accessProvider.getServiceClient().me().buildRequest().get();\n        \n        System.out.println(&quot;My UserName :: &quot;+user.displayName);\n        \n        final MessageCollectionPage messagePage = accessProvider.getServiceClient().me().messages()\n                .buildRequest().top(3).select(&quot;subject&quot;).get();\n        \n        List&lt;Message&gt; messageList = messagePage.getCurrentPage();\n        \n        for(Message msg : messageList) {\n            System.out.println(&quot;Subject -&gt; &quot;+msg.subject);\n        }\n    }\n}\n</code></pre>\n"
  },
  "answers": [
    {
      "owner": {
        "account_id": 24140407,
        "reputation": 756,
        "user_id": 18106676,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/a9b27a147e4f6c3d46f507f238a97136?s=256&d=identicon&r=PG",
        "display_name": "vicky kumar",
        "link": "https://stackoverflow.com/users/18106676/vicky-kumar"
      },
      "is_accepted": false,
      "score": 1,
      "last_activity_date": 1751794606,
      "last_edit_date": 1751794606,
      "creation_date": 1661404146,
      "answer_id": 73482121,
      "question_id": 73307144,
      "content_license": "CC BY-SA 4.0",
      "body": "<p>You are using the client credential flow here, which means that you cannot dynamically request scopes. You must configure your required permission scopes on your app registration in apps.dev.microsoft.com, then you set the value of scope in your code to <a href=\"https://graph.microsoft.com/.default\" rel=\"nofollow noreferrer\">https://graph.microsoft.com/.default</a>.</p>\n<p><a href=\"https://i.sstatic.net/0xlSm.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/0xlSm.png\" alt=\"enter image description here\" /></a></p>\n<p>You can use this code:</p>\n<pre><code>string[] scopes = new string[] { &quot;https://graph.microsoft.com/.default&quot; };\n</code></pre>\n<p>References:</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/active-directory/develop/scenario-daemon-acquire-token?tabs=dotnet#azure-ad-v10-resources\" rel=\"nofollow noreferrer\">https://learn.microsoft.com/en-us/azure/active-directory/develop/scenario-daemon-acquire-token?tabs=dotnet#azure-ad-v10-resources</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=CS#client-credentials-provider\" rel=\"nofollow noreferrer\">https://learn.microsoft.com/en-us/graph/sdks/choose-authentication-providers?tabs=CS#client-credentials-provider</a></li>\n</ul>\n"
    }
  ],
  "question_comments": [
    {
      "owner": {
        "account_id": 6911888,
        "reputation": 173,
        "user_id": 5307407,
        "user_type": "registered",
        "accept_rate": 70,
        "profile_image": "https://graph.facebook.com/881390108596373/picture?type=large",
        "display_name": "Nitin Rathod",
        "link": "https://stackoverflow.com/users/5307407/nitin-rathod"
      },
      "reply_to_user": {
        "account_id": 231683,
        "reputation": 4830,
        "user_id": 496038,
        "user_type": "registered",
        "profile_image": "https://i.sstatic.net/lO2Iq.png?s=256",
        "display_name": "pringi",
        "link": "https://stackoverflow.com/users/496038/pringi"
      },
      "edited": false,
      "score": 0,
      "creation_date": 1661161969,
      "post_id": 73307144,
      "comment_id": 129697673,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 6911888,
        "reputation": 173,
        "user_id": 5307407,
        "user_type": "registered",
        "accept_rate": 70,
        "profile_image": "https://graph.facebook.com/881390108596373/picture?type=large",
        "display_name": "Nitin Rathod",
        "link": "https://stackoverflow.com/users/5307407/nitin-rathod"
      },
      "reply_to_user": {
        "account_id": 231683,
        "reputation": 4830,
        "user_id": 496038,
        "user_type": "registered",
        "profile_image": "https://i.sstatic.net/lO2Iq.png?s=256",
        "display_name": "pringi",
        "link": "https://stackoverflow.com/users/496038/pringi"
      },
      "edited": false,
      "score": 0,
      "creation_date": 1660140846,
      "post_id": 73307144,
      "comment_id": 129463147,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 231683,
        "reputation": 4830,
        "user_id": 496038,
        "user_type": "registered",
        "profile_image": "https://i.sstatic.net/lO2Iq.png?s=256",
        "display_name": "pringi",
        "link": "https://stackoverflow.com/users/496038/pringi"
      },
      "edited": false,
      "score": 0,
      "creation_date": 1660139069,
      "post_id": 73307144,
      "comment_id": 129462323,
      "content_license": "CC BY-SA 4.0"
    }
  ],
  "answer_comments": {
    "73482121": [
      {
        "owner": {
          "account_id": 24140407,
          "reputation": 756,
          "user_id": 18106676,
          "user_type": "registered",
          "profile_image": "https://www.gravatar.com/avatar/a9b27a147e4f6c3d46f507f238a97136?s=256&d=identicon&r=PG",
          "display_name": "vicky kumar",
          "link": "https://stackoverflow.com/users/18106676/vicky-kumar"
        },
        "reply_to_user": {
          "account_id": 6911888,
          "reputation": 173,
          "user_id": 5307407,
          "user_type": "registered",
          "accept_rate": 70,
          "profile_image": "https://graph.facebook.com/881390108596373/picture?type=large",
          "display_name": "Nitin Rathod",
          "link": "https://stackoverflow.com/users/5307407/nitin-rathod"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1662633971,
        "post_id": 73482121,
        "comment_id": 130053340,
        "content_license": "CC BY-SA 4.0"
      },
      {
        "owner": {
          "account_id": 6911888,
          "reputation": 173,
          "user_id": 5307407,
          "user_type": "registered",
          "accept_rate": 70,
          "profile_image": "https://graph.facebook.com/881390108596373/picture?type=large",
          "display_name": "Nitin Rathod",
          "link": "https://stackoverflow.com/users/5307407/nitin-rathod"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1662631810,
        "post_id": 73482121,
        "comment_id": 130052593,
        "content_license": "CC BY-SA 4.0"
      },
      {
        "owner": {
          "account_id": 24140407,
          "reputation": 756,
          "user_id": 18106676,
          "user_type": "registered",
          "profile_image": "https://www.gravatar.com/avatar/a9b27a147e4f6c3d46f507f238a97136?s=256&d=identicon&r=PG",
          "display_name": "vicky kumar",
          "link": "https://stackoverflow.com/users/18106676/vicky-kumar"
        },
        "reply_to_user": {
          "account_id": 6911888,
          "reputation": 173,
          "user_id": 5307407,
          "user_type": "registered",
          "accept_rate": 70,
          "profile_image": "https://graph.facebook.com/881390108596373/picture?type=large",
          "display_name": "Nitin Rathod",
          "link": "https://stackoverflow.com/users/5307407/nitin-rathod"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1662443092,
        "post_id": 73482121,
        "comment_id": 129999746,
        "content_license": "CC BY-SA 4.0"
      },
      {
        "owner": {
          "account_id": 6911888,
          "reputation": 173,
          "user_id": 5307407,
          "user_type": "registered",
          "accept_rate": 70,
          "profile_image": "https://graph.facebook.com/881390108596373/picture?type=large",
          "display_name": "Nitin Rathod",
          "link": "https://stackoverflow.com/users/5307407/nitin-rathod"
        },
        "edited": false,
        "score": 0,
        "creation_date": 1662378446,
        "post_id": 73482121,
        "comment_id": 129985245,
        "content_license": "CC BY-SA 4.0"
      }
    ]
  }
}