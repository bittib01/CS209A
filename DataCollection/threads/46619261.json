{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "websocket"
    ],
    "owner": {
      "account_id": 1537344,
      "reputation": 13485,
      "user_id": 1432980,
      "user_type": "registered",
      "accept_rate": 73,
      "profile_image": "https://www.gravatar.com/avatar/e646027bcc545177a971230c1e23134a?s=256&d=identicon&r=PG",
      "display_name": "lapots",
      "link": "https://stackoverflow.com/users/1432980/lapots"
    },
    "is_answered": false,
    "view_count": 8645,
    "answer_count": 2,
    "score": 3,
    "last_activity_date": 1764968610,
    "creation_date": 1507372815,
    "question_id": 46619261,
    "content_license": "CC BY-SA 3.0",
    "link": "https://stackoverflow.com/questions/46619261/the-http-request-to-initiate-the-websocket-connection-failed",
    "title": "The HTTP request to initiate the WebSocket connection failed",
    "body": "<p>I want to send a message to websocket from <code>java</code> code.</p>\n\n<p>This is configuration class for <code>websockets</code></p>\n\n<pre><code>@Configuration\n@EnableWebSocket\npublic class WebSocketConfig implements WebSocketConfigurer {\n    private WebSocketHandler handler;\n\n    public WebSocketConfig(WebSocketHandler handler) {\n        this.handler = handler;\n    }\n\n    @Override\n    public void registerWebSocketHandlers(WebSocketHandlerRegistry webSocketHandlerRegistry) {\n        webSocketHandlerRegistry.addHandler(this.handler, \"/ws\");\n    }\n}\n</code></pre>\n\n<p>This is <code>websocket</code> handler</p>\n\n<pre><code>@Component\npublic class WebSocketHandler extends TextWebSocketHandler {\n    private static final Logger LOGGER = JavaLogUtils.getLogger();\n\n    @Override\n    public void afterConnectionEstablished(WebSocketSession session) throws Exception {\n        super.afterConnectionEstablished(session);\n    }\n\n    @Override\n    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {\n        LOGGER.info(\" Server &gt;&gt;&gt;&gt; {}\", message);\n        session.sendMessage(message);\n    }\n}\n</code></pre>\n\n<p>When I send message from <code>html</code> page via <code>javascript</code> like this</p>\n\n<pre><code>$(function(){\n\n    var connection = new WebSocket('ws://localhost:8080/ws');\n    connection.onopen = function () {\n        console.log('Connected...');\n    };\n    connection.onmessage = function(event){\n        console.log('&gt;&gt;&gt;&gt;&gt; ' + event.data);\n        var json = JSON.parse(event.data);\n        $(\"#output\").append(\"&lt;span&gt;&lt;strong&gt;\" + json.user + \"&lt;/strong&gt;: &lt;em&gt;\" + json.message  +\"&lt;/em&gt;&lt;/span&gt;&lt;br/&gt;\");\n    };\n    connection.onclose   = function(event){\n        $(\"#output\").append(\"&lt;p class=\\\"text-uppercase\\\"&gt;&lt;strong&gt;CONNECTION: CLOSED&lt;/strong&gt;&lt;/p&gt;\");\n    };\n\n    $(\"#send\").click(function(){\n        var message = {}\n        message[\"user\"] = $(\"#user\").val();\n        message[\"message\"] = $(\"#message\").val();\n        connection.send(JSON.stringify(message));\n    });\n\n});\n</code></pre>\n\n<p>It works fine. But when I try to send the message from <code>java client</code> it fails</p>\n\n<pre><code>@SpringBootApplication\n@ComponentScan(\"com.lapots.breed.platform.cloud.boot\")\n@EnableJpaRepositories(\"com.lapots.breed.platform.cloud.boot.repository\")\n@EntityScan(\"com.lapots.breed.platform.cloud.boot.domain\")\n@EnableAspectJAutoProxy\n@EnableJms\npublic class JavaCloudSampleApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(JavaCloudSampleApplication.class, args);\n    }\n\n    @Bean\n    public CommandLineRunner welcomeSocketMessage(WebSocketHandler handler) throws URISyntaxException {\n        return args -&gt; {\n            StandardWebSocketClient client = new StandardWebSocketClient();\n            ListenableFuture&lt;WebSocketSession&gt; future = client.doHandshake(handler,\n                    new WebSocketHttpHeaders(),\n                    new URI(\"ws://localhost:8080/ws\"));\n            WebSocketSession session = future.get();\n            WebSocketMessage&lt;String&gt; message = new TextMessage(\"Hello from Spring\");\n            session.sendMessage(message);\n        };\n    }\n}\n</code></pre>\n\n<p>and I get this error</p>\n\n<pre><code>java.lang.IllegalStateException: Failed to load ApplicationContext\n        at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:124) ~[spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.springframework.test.context.support.DefaultTestContext.getApplicationContext(DefaultTestContext.java:83) ~[spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.springframework.test.context.web.ServletTestExecutionListener.setUpRequestContextIfNecessary(ServletTestExecutionListener.java:189) ~[spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.springframework.test.context.web.ServletTestExecutionListener.prepareTestInstance(ServletTestExecutionListener.java:131) ~[spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.springframework.test.context.TestContextManager.prepareTestInstance(TestContextManager.java:230) ~[spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.createTest(SpringJUnit4ClassRunner.java:228) [spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.springframework.test.context.junit4.SpringJUnit4ClassRunner$1.runReflectiveCall(SpringJUnit4ClassRunner.java:287) [spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12) [junit-4.12.jar:4.12]\n        at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.methodBlock(SpringJUnit4ClassRunner.java:289) [spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:247) [spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:94) [spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290) [junit-4.12.jar:4.12]\n        at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71) [junit-4.12.jar:4.12]\n        at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288) [junit-4.12.jar:4.12]\n        at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58) [junit-4.12.jar:4.12]\n        at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268) [junit-4.12.jar:4.12]\n        at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61) [spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70) [spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.junit.runners.ParentRunner.run(ParentRunner.java:363) [junit-4.12.jar:4.12]\n        at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:191) [spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:365) [surefire-junit4-2.20.jar:2.20]\n        at org.apache.maven.surefire.junit4.JUnit4Provider.executeWithRerun(JUnit4Provider.java:272) [surefire-junit4-2.20.jar:2.20]\n        at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:236) [surefire-junit4-2.20.jar:2.20]\n        at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:159) [surefire-junit4-2.20.jar:2.20]\n        at org.apache.maven.surefire.booter.ForkedBooter.invokeProviderInSameClassLoader(ForkedBooter.java:386) [surefire-booter-2.20.jar:2.20]\n        at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:323) [surefire-booter-2.20.jar:2.20]\n        at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:143) [surefire-booter-2.20.jar:2.20]\nCaused by: java.lang.IllegalStateException: Failed to execute CommandLineRunner\n        at org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:735) ~[spring-boot-1.5.6.RELEASE.jar:1.5.6.RELEASE]\n        at org.springframework.boot.SpringApplication.callRunners(SpringApplication.java:716) ~[spring-boot-1.5.6.RELEASE.jar:1.5.6.RELEASE]\n        at org.springframework.boot.SpringApplication.afterRefresh(SpringApplication.java:703) ~[spring-boot-1.5.6.RELEASE.jar:1.5.6.RELEASE]\n        at org.springframework.boot.SpringApplication.run(SpringApplication.java:304) ~[spring-boot-1.5.6.RELEASE.jar:1.5.6.RELEASE]\n        at org.springframework.boot.test.context.SpringBootContextLoader.loadContext(SpringBootContextLoader.java:120) ~[spring-boot-test-1.5.6.RELEASE.jar:1.5.6.RELEASE]\n        at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContextInternal(DefaultCacheAwareContextLoaderDelegate.java:98) ~[spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:116) ~[spring-test-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        ... 26 common frames omitted\nCaused by: java.util.concurrent.ExecutionException: javax.websocket.DeploymentException: The HTTP request to initiate the WebSocket connection failed\n        at java.util.concurrent.FutureTask.report(FutureTask.java:122) ~[na:1.8.0_121]\n        at java.util.concurrent.FutureTask.get(FutureTask.java:192) ~[na:1.8.0_121]\n        at com.lapots.breed.platform.cloud.boot.JavaCloudSampleApplication.lambda$welcomeSocketMessage$4(JavaCloudSampleApplication.java:76) ~[classes/:na]\n        at org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:732) ~[spring-boot-1.5.6.RELEASE.jar:1.5.6.RELEASE]\n        ... 32 common frames omitted\nCaused by: javax.websocket.DeploymentException: The HTTP request to initiate the WebSocket connection failed\n        at org.apache.tomcat.websocket.WsWebSocketContainer.connectToServer(WsWebSocketContainer.java:395) ~[tomcat-embed-websocket-8.5.16.jar:8.5.16]\n        at org.springframework.web.socket.client.standard.StandardWebSocketClient$1.call(StandardWebSocketClient.java:150) ~[spring-websocket-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at org.springframework.web.socket.client.standard.StandardWebSocketClient$1.call(StandardWebSocketClient.java:147) ~[spring-websocket-4.3.10.RELEASE.jar:4.3.10.RELEASE]\n        at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_121]\n        at java.lang.Thread.run(Thread.java:745) ~[na:1.8.0_121]\nCaused by: java.util.concurrent.ExecutionException: java.io.IOException: The remote computer refused the network connection.\n\n        at sun.nio.ch.PendingFuture.get(PendingFuture.java:202) ~[na:1.8.0_121]\n        at org.apache.tomcat.websocket.WsWebSocketContainer.connectToServer(WsWebSocketContainer.java:336) ~[tomcat-embed-websocket-8.5.16.jar:8.5.16]\n        ... 4 common frames omitted\nCaused by: java.io.IOException: The remote computer refused the network connection.\n\n        at sun.nio.ch.Iocp.translateErrorToIOException(Iocp.java:309) ~[na:1.8.0_121]\n        at sun.nio.ch.Iocp.access$700(Iocp.java:46) ~[na:1.8.0_121]\n        at sun.nio.ch.Iocp$EventHandlerTask.run(Iocp.java:399) ~[na:1.8.0_121]\n        ... 1 common frames omitted\n\n[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 8.071 s &lt;&lt;&lt; FAILURE! - in com.lapots.breed.platform.cloud.boot.app.JavaCloudSampleApplicationTests\n[ERROR] contextLoads(com.lapots.breed.platform.cloud.boot.app.JavaCloudSampleApplicationTests)  Time elapsed: 0 s  &lt;&lt;&lt; ERROR!\njava.lang.IllegalStateException: Failed to load ApplicationContext\nCaused by: java.lang.IllegalStateException: Failed to execute CommandLineRunner\nCaused by: java.util.concurrent.ExecutionException: javax.websocket.DeploymentException: The HTTP request to initiate the WebSocket connection failed\nCaused by: javax.websocket.DeploymentException: The HTTP request to initiate the WebSocket connection failed\nCaused by: java.util.concurrent.ExecutionException:\njava.io.IOException: The remote computer refused the network connection.\n\nCaused by: java.io.IOException:\nThe remote computer refused the network connection.\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}