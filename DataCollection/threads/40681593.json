{
  "question": {
    "tags": [
      "java",
      "ssh",
      "sftp",
      "jsch"
    ],
    "owner": {
      "account_id": 6140032,
      "reputation": 33,
      "user_id": 4787711,
      "user_type": "registered",
      "accept_rate": 25,
      "profile_image": "https://www.gravatar.com/avatar/5994141b54b79a990a7d7aeafe14c6c7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Techji",
      "link": "https://stackoverflow.com/users/4787711/techji"
    },
    "is_answered": false,
    "view_count": 10099,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1764936015,
    "creation_date": 1479485643,
    "last_edit_date": 1479495037,
    "question_id": 40681593,
    "content_license": "CC BY-SA 3.0",
    "link": "https://stackoverflow.com/questions/40681593/not-able-to-connect-to-sftp-using-jcraft-jsch",
    "title": "Not able to connect to SFTP using jcraft JSch",
    "body": "<p>I am trying to connect to SFTP location via ssh jump-host proxy using jcraft version 0.1.52. But getting \"<em>connection is closed by foreign host</em>\" exception in my code. I have spent a good enough time looking at documentation but not able to figure out what the problem is</p>\n\n<pre><code>2016-11-18 14:53:14,091 44977 [main] ERROR c.w.v.r.ftp.JschSftpConnect -\n    - com.jcraft.jsch.JSchException: connection is closed by foreign host\n        at com.jcraft.jsch.Session.connect(Session.java:269)\n        at com.jcraft.jsch.Session.connect(Session.java:183)\n        at com.x.y.ftp.JschSftpConnect.connect(JschSftpConnect.java:77)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n</code></pre>\n\n<p>There is no problem with private keys as I am able to connect to sftp server via unix command.</p>\n\n<pre><code> sftp -o UserKnownHostsFile=/dev/null \n  -o StrictHostKeyChecking=no \n  -i /path/to/host/private-key-file \n    -o 'ProxyCommand=ssh \n        -o UserKnownHostsFile=/dev/null \n        -o StrictHostKeyChecking=no \n        -i /path/to/jumphost/private-key-file\n        -l jumphostuser jump.host.com nc sftp.host.com 22' \n</code></pre>\n\n<ol start=\"3\">\n<li>Here is the code that I am running</li>\n</ol>\n\n<p>The code:</p>\n\n<pre><code>import java.io.BufferedInputStream;\nimport java.io.BufferedOutputStream;\nimport java.io.File;\nimport java.io.FileOutputStream;\nimport java.io.IOException;\nimport java.io.InputStream;\nimport java.io.OutputStream;\nimport java.net.Socket;\nimport java.nio.file.FileSystems;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.util.Properties;\n\nimport org.apache.commons.lang3.exception.ExceptionUtils;\n\nimport com.jcraft.jsch.Channel;\nimport com.jcraft.jsch.ChannelSftp;\nimport com.jcraft.jsch.JSch;\nimport com.jcraft.jsch.Proxy;\nimport com.jcraft.jsch.Session;\nimport com.jcraft.jsch.SocketFactory;\n\npublic class JschSftpConnect {\n\n\n    public static void main(String args[]) {\n        String sftpHostKeyFilePath = \"/path/to/host/private-key-file\";\n        String sftpHost=\"sftp.host.com\";\n        String sftpUser=\"user\";\n        String proxyHostName=\"jump.host.com\";\n        String proxyKeyPath =\"/path/to/jumphost/private-key-file\";\n        String proxyUserName=\"jumphostuser\";\n\n        log.debug(\"Executing JSCH code.....\");\n        try {\n\n            JSch jsch = new JSch();\n\n            Path path = FileSystems.getDefault().getPath(sftpHostKeyFilePath);\n            byte[] filearray = Files.readAllBytes(path);\n\n            jsch.addIdentity(\"ID\", filearray, null, null);\n            Session session = jsch.getSession(sftpUser, sftpHost, 22);\n            Properties props = new Properties();\n            props.put(\"StrictHostKeyChecking\", \"no\");\n            session.setConfig(props);\n\n            String command = \"ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i \"\n                + localKeyFileDirectoryName + proxyKey + \" -l \" + proxyUserName + \" \" + proxyHostName\n                + \" nc %h %p\";\n\n            session.setProxy(new JumpHostProxyCommand(command));\n            log.debug(\"Connecting session .......................\");\n            session.connect();\n            log.debug(\"Session openend .......................\");\n\n            Channel ch = session.openChannel(\"sftp\");\n            ch.connect();\n            log.debug(\"SFTP channel connected .......................\");\n            ChannelSftp channelSftp = (ChannelSftp) ch;\n            channelSftp.cd(\"/\");\n\n            log.debug(\"Working directory is / .......................\");\n\n            byte[] buffer = new byte[1024];\n            BufferedInputStream bis = new BufferedInputStream(channelSftp.get(\"/some_file_.psv\"));\n            File newFile = new File(\"some_file_.psv\");\n            OutputStream os = new FileOutputStream(newFile);\n            BufferedOutputStream bos = new BufferedOutputStream(os);\n            int readCount;\n            // System.out.println(\"Getting: \" + theLine);\n            while ((readCount = bis.read(buffer)) &gt; 0) {\n                // System.out.println(\"Writing: \");\n                bos.write(buffer, 0, readCount);\n            }\n            log.debug(\"File should have been written / .......................\");\n\n            while (session != null) {\n                System.out.println(\"Killing the session\");\n                session.disconnect();\n                bis.close();\n                bos.close();\n                System.exit(0);\n            }\n        } catch (Exception e) {\n            log.error(ExceptionUtils.getStackTrace(e));\n        }\n    }\n}\n\n\n\nclass JumpHostProxyCommand implements Proxy {\n\n    String command;\n    Process p = null;\n    InputStream in = null;\n    OutputStream out = null;\n\n    public JumpHostProxyCommand(String command) {\n        this.command = command;\n    }\n\n    public void connect(SocketFactory socket_factory, String host, int port, int timeout) throws Exception {\n\n\n        String cmd = command.replace(\"%h\", host);\n        cmd = cmd.replace(\"%p\", new Integer(port).toString());\n\n        p = Runtime.getRuntime().exec(cmd);\n        log.debug(\"Process returned by proxy command {} , {}\", command,  p);\n        in = p.getInputStream();\n        log.debug(\"Input stream returned by proxy {}\", in);\n        out = p.getOutputStream();\n        log.debug(\"Output stream returned by proxy {}\", out);\n    }\n\n    public Socket getSocket() {\n        return null;\n    }\n\n    public InputStream getInputStream() {\n        return in;\n    }\n\n    public OutputStream getOutputStream() {\n        return out;\n    }\n\n    public void close() {\n        try {\n            if (p != null) {\n                p.getErrorStream().close();\n                p.getOutputStream().close();\n                p.getInputStream().close();\n                p.destroy();\n                p = null;\n            }\n        } catch (IOException e) {\n            e.printStackTrace();\n        }\n    }\n}\n</code></pre>\n\n<p>Would really appreciate if someone could help. Thanks!</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}