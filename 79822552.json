{
  "question": {
    "tags": [
      "java",
      "performance",
      "unsafe",
      "lambda-metafactory",
      "varhandle"
    ],
    "owner": {
      "account_id": 1364678,
      "reputation": 2232,
      "user_id": 1301373,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/56eb9a131846d4447ca24b5ea9ecb600?s=256&d=identicon&r=PG",
      "display_name": "winne2",
      "link": "https://stackoverflow.com/users/1301373/winne2"
    },
    "is_answered": true,
    "view_count": 148,
    "closed_date": 1763460470,
    "accepted_answer_id": 79822684,
    "answer_count": 1,
    "score": -9,
    "last_activity_date": 1764475822,
    "creation_date": 1763397607,
    "last_edit_date": 1764475822,
    "question_id": 79822552,
    "link": "https://stackoverflow.com/questions/79822552/are-there-any-plans-to-expose-internal-arrays-in-java-lang-string",
    "closed_reason": "Opinion-based",
    "title": "Are there any plans to expose internal arrays in java.lang.String?",
    "body": "<p>When trying to performance-tune our Java XML parsing/validation/binding pipeline, I observed the following:</p>\n<ul>\n<li>Iterating a String's chars via <code>String.charAt()</code> is slow, cf. e.g. <a href=\"https://github.com/FasterXML/woodstox/blob/main/src/main/java/com/ctc/wstx/sw/BaseStreamWriter.java#L95\" rel=\"nofollow noreferrer\">Woodstox</a> (I was able to verify this statement with own benchmarks):</li>\n</ul>\n<blockquote>\n<p>Intermediate buffer into which characters of a String can be copied, in cases where such a copy followed by array access is faster than calling <code>String.charAt()</code> (which perhaps surprisingly is often case, and especially significant for longer buffers).</p>\n</blockquote>\n<ul>\n<li>Copying to a buffer array with <code>String.getChars()</code> and <em>then</em> iterating the buffer is obviously more expensive than just iterating over an array.</li>\n<li>Heavily performance-optimized libraries like <a href=\"https://www.alibabacloud.com/blog/techniques-to-construct-string-objects-and-access-internal-members-quickly_599831\" rel=\"nofollow noreferrer\">FastJSON</a> use a mix of unsafe, deprecated and undocumented APIs (AFAIU) to directly access a String's backing array (I verified with own benchmarks that this approach has performance benefits)</li>\n</ul>\n<p>Are you aware of any plans to &quot;officially&quot; offer an API to directly access a String's backing array?</p>\n"
  },
  "answers": [
    {
      "owner": {
        "account_id": 1211967,
        "reputation": 9964,
        "user_id": 1180351,
        "user_type": "registered",
        "profile_image": "https://i.sstatic.net/pKB8y.png?s=256",
        "display_name": "Rob Spoor",
        "link": "https://stackoverflow.com/users/1180351/rob-spoor"
      },
      "is_accepted": true,
      "score": 2,
      "last_activity_date": 1763408079,
      "last_edit_date": 1763408079,
      "creation_date": 1763406795,
      "answer_id": 79822684,
      "question_id": 79822552,
      "content_license": "CC BY-SA 4.0",
      "body": "<p>The short answer to your question is: no. On the contrary, steps have been taken to make it <em>harder</em> to access internals. There's no way Oracle is going to make it easier. (Well, maaaaaybe after <a href=\"https://openjdk.org/jeps/8261007\" rel=\"nofollow noreferrer\">frozen arrays</a> are implemented; just don't count on it.)</p>\n<p>As said in the comments, String internals are guarded because otherwise it's possible to violate the immutability of String. Years ago I've already experimented with modifying Strings using reflection, and in Java 11 it's still possible:</p>\n<pre class=\"lang-java prettyprint-override\"><code>String s = &quot;hello world&quot;;\n\nvar valueHandle = MethodHandles.privateLookupIn(String.class, MethodHandles.lookup())\n        .findVarHandle(String.class, &quot;value&quot;, byte[].class);\n\nbyte[] value = (byte[]) valueHandle.get(s);\nvalue[0] = 'H';\n\nSystem.out.println(s); // prints Hello world, not hello world\n</code></pre>\n<p>To make it harder, <a href=\"https://openjdk.org/jeps/396\" rel=\"nofollow noreferrer\">JEP 396</a> in Java 16 and <a href=\"https://openjdk.org/jeps/403\" rel=\"nofollow noreferrer\">JEP 403</a> in Java 17 have been implemented to prevent the above unless you explicitly open packages using <code>--add-opens</code>. For instance, the above is still possible in Java 17 by using the <code>--add-opens java.base/java.lang=ALL-UNNAMED</code> JVM flag (for use in a named module, replace <code>ALL-UNNAMED</code> with your module name). But while it's possible, it's bad practice to do so. Any use of <code>--add-opens</code> indicates someone is trying to do something that the authors (of any opened module, not just Oracle) don't intend you to do.</p>\n<p>I was hoping that <a href=\"https://docs.oracle.com/en/java/javase/25/docs/api/java.base/java/text/StringCharacterIterator.html\" rel=\"nofollow noreferrer\">StringCharacterIterator</a> could perhaps be a bit more efficient, but it still uses <code>charAt</code> and <code>length</code> internally. Perhaps Oracle can be persuaded to update it to use String internals, but I wouldn't count on it.</p>\n"
    }
  ],
  "question_comments": [
    {
      "owner": {
        "account_id": 5195749,
        "reputation": 3000,
        "user_id": 4157124,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/ccb2110df592e8d6b210ad3a764f092a?s=256&d=identicon&r=PG",
        "display_name": "user4157124",
        "link": "https://stackoverflow.com/users/4157124/user4157124"
      },
      "edited": false,
      "score": 0,
      "creation_date": 1764475826,
      "post_id": 79822552,
      "comment_id": 140879685,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 3211603,
        "reputation": 300971,
        "user_id": 2711488,
        "user_type": "registered",
        "profile_image": "https://i.sstatic.net/t2hoD.jpg?s=256",
        "display_name": "Holger",
        "link": "https://stackoverflow.com/users/2711488/holger"
      },
      "edited": false,
      "score": 1,
      "creation_date": 1764154149,
      "post_id": 79822552,
      "comment_id": 140873957,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 1364678,
        "reputation": 2232,
        "user_id": 1301373,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/56eb9a131846d4447ca24b5ea9ecb600?s=256&d=identicon&r=PG",
        "display_name": "winne2",
        "link": "https://stackoverflow.com/users/1301373/winne2"
      },
      "reply_to_user": {
        "account_id": 3211603,
        "reputation": 300971,
        "user_id": 2711488,
        "user_type": "registered",
        "profile_image": "https://i.sstatic.net/t2hoD.jpg?s=256",
        "display_name": "Holger",
        "link": "https://stackoverflow.com/users/2711488/holger"
      },
      "edited": false,
      "score": 0,
      "creation_date": 1763930719,
      "post_id": 79822552,
      "comment_id": 140869221,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 213468,
        "reputation": 110279,
        "user_id": 466862,
        "user_type": "registered",
        "profile_image": "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
        "display_name": "Mark Rotteveel",
        "link": "https://stackoverflow.com/users/466862/mark-rotteveel"
      },
      "edited": false,
      "score": 4,
      "creation_date": 1763460446,
      "post_id": 79822552,
      "comment_id": 140860008,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 31180,
        "reputation": 29752,
        "user_id": 85421,
        "user_type": "registered",
        "profile_image": "https://i.sstatic.net/kKvXH.gif?s=256",
        "display_name": "user85421",
        "link": "https://stackoverflow.com/users/85421/user85421"
      },
      "edited": false,
      "score": 4,
      "creation_date": 1763404626,
      "post_id": 79822552,
      "comment_id": 140858903,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 372682,
        "reputation": 26512,
        "user_id": 721855,
        "user_type": "registered",
        "profile_image": "https://i.sstatic.net/vZiox.png?s=256",
        "display_name": "aled",
        "link": "https://stackoverflow.com/users/721855/aled"
      },
      "edited": false,
      "score": 3,
      "creation_date": 1763402399,
      "post_id": 79822552,
      "comment_id": 140858838,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 3211603,
        "reputation": 300971,
        "user_id": 2711488,
        "user_type": "registered",
        "profile_image": "https://i.sstatic.net/t2hoD.jpg?s=256",
        "display_name": "Holger",
        "link": "https://stackoverflow.com/users/2711488/holger"
      },
      "edited": false,
      "score": 5,
      "creation_date": 1763400086,
      "post_id": 79822552,
      "comment_id": 140858772,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 465573,
        "reputation": 200423,
        "user_id": 869736,
        "user_type": "registered",
        "accept_rate": 82,
        "profile_image": "https://www.gravatar.com/avatar/ae7bb06b9a23a4dd7eea69e853d47d12?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name": "Louis Wasserman",
        "link": "https://stackoverflow.com/users/869736/louis-wasserman"
      },
      "edited": false,
      "score": 6,
      "creation_date": 1763399635,
      "post_id": 79822552,
      "comment_id": 140858758,
      "content_license": "CC BY-SA 4.0"
    },
    {
      "owner": {
        "account_id": 3211603,
        "reputation": 300971,
        "user_id": 2711488,
        "user_type": "registered",
        "profile_image": "https://i.sstatic.net/t2hoD.jpg?s=256",
        "display_name": "Holger",
        "link": "https://stackoverflow.com/users/2711488/holger"
      },
      "edited": false,
      "score": 6,
      "creation_date": 1763398822,
      "post_id": 79822552,
      "comment_id": 140858731,
      "content_license": "CC BY-SA 4.0"
    }
  ],
  "answer_comments": {
    "79822684": [
      {
        "owner": {
          "account_id": 3211603,
          "reputation": 300971,
          "user_id": 2711488,
          "user_type": "registered",
          "profile_image": "https://i.sstatic.net/t2hoD.jpg?s=256",
          "display_name": "Holger",
          "link": "https://stackoverflow.com/users/2711488/holger"
        },
        "edited": false,
        "score": 2,
        "creation_date": 1763467958,
        "post_id": 79822684,
        "comment_id": 140860227,
        "content_license": "CC BY-SA 4.0"
      },
      {
        "owner": {
          "account_id": 1211967,
          "reputation": 9964,
          "user_id": 1180351,
          "user_type": "registered",
          "profile_image": "https://i.sstatic.net/pKB8y.png?s=256",
          "display_name": "Rob Spoor",
          "link": "https://stackoverflow.com/users/1180351/rob-spoor"
        },
        "reply_to_user": {
          "account_id": 3159259,
          "reputation": 111552,
          "user_id": 2670892,
          "user_type": "registered",
          "profile_image": "https://i.sstatic.net/4iPV5.png?s=256",
          "display_name": "greg-449",
          "link": "https://stackoverflow.com/users/2670892/greg-449"
        },
        "edited": false,
        "score": 1,
        "creation_date": 1763454085,
        "post_id": 79822684,
        "comment_id": 140859773,
        "content_license": "CC BY-SA 4.0"
      },
      {
        "owner": {
          "account_id": 3159259,
          "reputation": 111552,
          "user_id": 2670892,
          "user_type": "registered",
          "profile_image": "https://i.sstatic.net/4iPV5.png?s=256",
          "display_name": "greg-449",
          "link": "https://stackoverflow.com/users/2670892/greg-449"
        },
        "edited": false,
        "score": 4,
        "creation_date": 1763416883,
        "post_id": 79822684,
        "comment_id": 140859221,
        "content_license": "CC BY-SA 4.0"
      }
    ]
  }
}