{
  "question": {
    "tags": [
      "java",
      "memory",
      "containers",
      "alpine-linux"
    ],
    "owner": {
      "account_id": 3020430,
      "reputation": 1029,
      "user_id": 3176108,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/d4f641db5a20adf8e950e1ec9badb15a?s=256&d=identicon&r=PG",
      "display_name": "Raghu",
      "link": "https://stackoverflow.com/users/3176108/raghu"
    },
    "is_answered": true,
    "view_count": 2531,
    "answer_count": 2,
    "score": 9,
    "last_activity_date": 1756917466,
    "creation_date": 1727171868,
    "last_edit_date": 1756917466,
    "question_id": 79018043,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79018043/high-memory-usage-in-java-21-compared-to-java-8",
    "title": "High memory usage in Java 21 compared to Java 8",
    "body": "<p>We recently upgraded from Java 8 to Java 21 and noticed a significant increase in memory consumption in our Java applications. Our applications are deployed in containers based on Alpine OS, and we use the Eclipse Temurin Build.</p>\n<p><strong>Reproducing the Issue</strong>\nI have created a small project that replicates this issue, which is available at: <a href=\"https://github.com/RaghuChandrasekaran/java21-memory-usage\" rel=\"nofollow noreferrer\">https://github.com/RaghuChandrasekaran/java21-memory-usage</a>.\nThe docker stats report the following memory usage for the Java process when the heap values are <code>-Xms256m -Xmx512m</code> with the memory limit of 1 G. Memory usage jumps from 231 <a href=\"https://simple.m.wikipedia.org/wiki/Mebibyte\" rel=\"nofollow noreferrer\">MiB</a> to 314, a third higher.</p>\n<p><a href=\"https://i.sstatic.net/YF4yk2yx.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/YF4yk2yx.png\" alt=\"Docker Stats Output\" /></a></p>\n<p><strong>Analysis</strong>\nTo investigate the issue, I enabled Native Memory Tracking (NMT), and the output is provided below.</p>\n<p><strong>Java 8</strong></p>\n<pre><code>Native Memory Tracking:\n\nTotal: reserved=1929874KB, committed=393190KB\n-                 Java Heap (reserved=524288KB, committed=262208KB)\n                            (mmap: reserved=524288KB, committed=262208KB) \n \n-                     Class (reserved=1099014KB, committed=57566KB)\n                            (classes #10367)\n                            (malloc=1286KB #10537) \n                            (mmap: reserved=1097728KB, committed=56280KB) \n \n-                    Thread (reserved=31968KB, committed=31968KB)\n                            (thread #32)\n                            (stack: reserved=31829KB, committed=31829KB)\n                            (malloc=106KB #186) \n                            (arena=32KB #58)\n \n-                      Code (reserved=253118KB, committed=20810KB)\n                            (malloc=3518KB #5282) \n                            (mmap: reserved=249600KB, committed=17292KB) \n \n-                        GC (reserved=1738KB, committed=890KB)\n                            (malloc=26KB #174) \n                            (mmap: reserved=1712KB, committed=864KB) \n \n-                  Compiler (reserved=159KB, committed=159KB)\n                            (malloc=24KB #469) \n                            (arena=135KB #7)\n \n-                  Internal (reserved=1844KB, committed=1844KB)\n                            (malloc=1812KB #12019) \n                            (mmap: reserved=32KB, committed=32KB) \n \n-                    Symbol (reserved=15183KB, committed=15183KB)\n                            (malloc=11915KB #122017) \n                            (arena=3268KB #1)\n \n-    Native Memory Tracking (reserved=2366KB, committed=2366KB)\n                            (malloc=7KB #90) \n                            (tracking overhead=2359KB)\n \n-               Arena Chunk (reserved=196KB, committed=196KB)\n                            (malloc=196KB) \n</code></pre>\n<p><strong>Java 21</strong></p>\n<pre><code>Native Memory Tracking:\n\nTotal: reserved=2044186KB, committed=424038KB\n       malloc: 42596KB #337605\n       mmap:   reserved=2001590KB, committed=381442KB\n\n-                 Java Heap (reserved=524288KB, committed=262208KB)\n                            (mmap: reserved=524288KB, committed=262208KB) \n \n-                     Class (reserved=1050068KB, committed=13012KB)\n                            (classes #17813)\n                            (  instance classes #16553, array classes #1260)\n                            (malloc=1492KB #45190) (peak=1496KB #45058) \n                            (mmap: reserved=1048576KB, committed=11520KB) \n                            (  Metadata:   )\n                            (    reserved=131072KB, committed=69376KB)\n                            (    used=68992KB)\n                            (    waste=384KB =0.55%)\n                            (  Class space:)\n                            (    reserved=1048576KB, committed=11520KB)\n                            (    used=11130KB)\n                            (    waste=390KB =3.38%)\n \n-                    Thread (reserved=31927KB, committed=2831KB)\n                            (thread #32)\n                            (stack: reserved=31826KB, committed=2730KB)\n                            (malloc=66KB #191) (peak=79KB #207) \n                            (arena=34KB #60) (peak=2322KB #38)\n \n-                      Code (reserved=249888KB, committed=24908KB)\n                            (malloc=2200KB #9067) (at peak) \n                            (mmap: reserved=247688KB, committed=22708KB) \n \n-                        GC (reserved=1734KB, committed=882KB)\n                            (malloc=22KB #80) (peak=250KB #137) \n                            (mmap: reserved=1712KB, committed=860KB) \n \n-                  Compiler (reserved=238KB, committed=238KB)\n                            (malloc=74KB #835) (peak=117KB #857) \n                            (arena=164KB #4) (peak=53061KB #30)\n \n-                  Internal (reserved=863KB, committed=863KB)\n                            (malloc=827KB #25496) (peak=835KB #25298) \n                            (mmap: reserved=36KB, committed=36KB) \n \n-                     Other (reserved=24KB, committed=24KB)\n                            (malloc=24KB #3) (peak=58KB #5) \n \n-                    Symbol (reserved=30116KB, committed=30116KB)\n                            (malloc=28254KB #234525) (at peak) \n                            (arena=1862KB #1) (at peak)\n \n-    Native Memory Tracking (reserved=5362KB, committed=5362KB)\n                            (malloc=87KB #1569) (peak=87KB #1568) \n                            (tracking overhead=5275KB)\n \n-        Shared class space (reserved=16384KB, committed=11996KB, readonly=0KB)\n                            (mmap: reserved=16384KB, committed=11996KB) \n \n-               Arena Chunk (reserved=2KB, committed=2KB)\n                            (malloc=2KB #116) (peak=55748KB #1365) \n \n-                    Module (reserved=127KB, committed=127KB)\n                            (malloc=127KB #3158) (at peak) \n \n-                 Safepoint (reserved=8KB, committed=8KB)\n                            (mmap: reserved=8KB, committed=8KB) \n \n-           Synchronization (reserved=1751KB, committed=1751KB)\n                            (malloc=1751KB #17227) (at peak) \n \n-            Serviceability (reserved=17KB, committed=17KB)\n                            (malloc=17KB #9) (peak=17KB #11) \n \n-                 Metaspace (reserved=131387KB, committed=69691KB)\n                            (malloc=315KB #118) (at peak) \n                            (mmap: reserved=131072KB, committed=69376KB) \n \n-      String Deduplication (reserved=1KB, committed=1KB)\n                            (malloc=1KB #8) (at peak) \n</code></pre>\n<p><a href=\"https://i.sstatic.net/ycIQ750w.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/ycIQ750w.png\" alt=\"Comparison\" /></a></p>\n<p>The possible suspects that I had were,</p>\n<ol>\n<li>Direct Buffer/ Native Memory usage by Netty</li>\n<li>Default Memory Allocation Library in Alpine</li>\n</ol>\n<p>But testing with the spring-pet-clinic project which doesn't use Netty ruled out #1 and testing in Ubuntu Base OS ruled out #2.</p>\n<p>What additional steps can I take to further diagnose the cause of this behavior?</p>\n<p><strong>Update on Oct 2nd:</strong></p>\n<p>As per @matt's request, I tried with a Simple HTTP Server in Native Java without any dependency and can reproduce the same behavior (Java 21 using slightly higher memory than Java 8). In this case, the memory usage is not as high as in the Spring Pet Clinic. Changes are updated in the <a href=\"https://github.com/RaghuChandrasekaran/java21-memory-usage\" rel=\"nofollow noreferrer\">https://github.com/RaghuChandrasekaran/java21-memory-usage</a> repo.</p>\n<p><a href=\"https://i.sstatic.net/ENczEEZP.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/ENczEEZP.png\" alt=\"Java SimpleServer Memory Usage\" /></a></p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}