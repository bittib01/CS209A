{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "spring-security",
      "spring-oauth2"
    ],
    "owner": {
      "account_id": 23977999,
      "reputation": 155,
      "user_id": 17965846,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/7302523e7fb6666c6bde1fc76520f887?s=256&d=identicon&r=PG",
      "display_name": "wuttke",
      "link": "https://stackoverflow.com/users/17965846/wuttke"
    },
    "is_answered": true,
    "view_count": 271,
    "accepted_answer_id": 79492292,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1741349638,
    "creation_date": 1737717833,
    "question_id": 79384175,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79384175/exclude-the-spring-boot-security-configuration-inner-package-private-class",
    "title": "Exclude the spring boot security configuration inner package-private class",
    "body": "<p>I have an external library that implements basic and oauth2 authorization.</p>\n<p>And I have a <code>SecurityFilterChain</code> for basic authorization:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Bean\n@ConditionalOnMissingBean\npublic AuthorizeRequestsCustomizer authorizeRequestsCustomizer(\n    @Qualifier(&quot;basicAndFormMvc&quot;) MvcRequestMatcher.Builder mvc) {\n  return customizer -&gt;\n      customizer.requestMatchers(mvc.pattern(&quot;/api/**&quot;)).authenticated().anyRequest().permitAll();\n}\n\n@Order(3)\n@Bean(&quot;basicAndFormAuthFilter&quot;)\npublic SecurityFilterChain filterChain(\n    HttpSecurity http, AuthorizeRequestsCustomizer authorizeRequestsCustomizer) throws Exception {\n\n  http.sessionManagement(c -&gt; c.sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED))\n      .csrf(AbstractHttpConfigurer::disable)\n      .cors(withDefaults())\n      .httpBasic(withDefaults())\n      .formLogin(withDefaults())\n      .exceptionHandling(\n          c -&gt;\n              c.defaultAuthenticationEntryPointFor(\n                  customAuthenticationEntryPoint(), new AntPathRequestMatcher(&quot;/**&quot;)))\n      .authorizeHttpRequests(authorizeRequestsCustomizer);\n\n  return http.build();\n}\n</code></pre>\n<p>But when starting, the error described above occurs:</p>\n<pre><code> [                  main] [ERROR] o.springframework.boot.SpringApplication: [] Application run failed\norg.springframework.beans.factory.BeanCreationException: Error creating bean with name 'springSecurityFilterChain': Cannot create inner bean '(inner bean)#7f088b5c' while setting constructor argument with key [1]\n    at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveInnerBeanValue(BeanDefinitionValueResolver.java:421)\n    at org.springframework.beans.factory.support.BeanDefinitionValueResolver.lambda$resolveValueIfNecessary$1(BeanDefinitionValueResolver.java:153)\n    at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveInnerBean(BeanDefinitionValueResolver.java:262)\n    at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary(BeanDefinitionValueResolver.java:152)\n    at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveManagedList(BeanDefinitionValueResolver.java:460)\n    at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary(BeanDefinitionValueResolver.java:191)\n    at org.springframework.beans.factory.support.ConstructorResolver.resolveConstructorArguments(ConstructorResolver.java:691)\n    at org.springframework.beans.factory.support.ConstructorResolver.autowireConstructor(ConstructorResolver.java:206)\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.autowireConstructor(AbstractAutowireCapableBeanFactory.java:1377)\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:1214)\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:563)\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:523)\n    at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:336)\n    at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:289)\n    at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:334)\n    at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:199)\n    at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:312)\n    at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:199)\n    at org.springframework.beans.factory.support.DefaultListableBeanFactory.instantiateSingleton(DefaultListableBeanFactory.java:1122)\n    at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingleton(DefaultListableBeanFactory.java:1093)\n    at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:1030)\n    at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:987)\n    at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:627)\n    at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:146)\n    at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:752)\n    at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:439)\n    at org.springframework.boot.SpringApplication.run(SpringApplication.java:318)\n    at org.springframework.boot.SpringApplication.run(SpringApplication.java:1361)\n    at org.springframework.boot.SpringApplication.run(SpringApplication.java:1350)\n    at (.java:10)\nCaused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name '(inner bean)#7f088b5c' defined in class path resource [org/springframework/security/config/annotation/web/configuration/WebSecurityConfiguration.class]: Failed to instantiate [jakarta.servlet.Filter]: Factory method 'springSecurityFilterChain' threw exception with message: A filter chain that matches any request [DefaultSecurityFilterChain defined as 'basicAndFormAuthFilter' in [class path resource [/BasicAndFormAuthConfig.class]] matching [any request] and having filters [DisableEncodeUrl, WebAsyncManagerIntegration, SecurityContextHolder, HeaderWriter, Cors, Logout, UsernamePasswordAuthentication, DefaultResources, DefaultLoginPageGenerating, DefaultLogoutPageGenerating, BasicAuthentication, RequestCacheAware, SecurityContextHolderAwareRequest, AnonymousAuthentication, SessionManagement, ExceptionTranslation]] has already been configured, which means that this filter chain [DefaultSecurityFilterChain defined as 'jwtSecurityFilterChain' in [class path resource [org/springframework/boot/autoconfigure/security/oauth2/resource/servlet/OAuth2ResourceServerJwtConfiguration$OAuth2SecurityFilterChainConfiguration.class]] matching [any request] and having filters [DisableEncodeUrl, WebAsyncManagerIntegration, SecurityContextHolder, HeaderWriter, Csrf, Logout, BearerTokenAuthentication, RequestCacheAware, SecurityContextHolderAwareRequest, AnonymousAuthentication, ExceptionTranslation, Authorization]] will never get invoked. Please use `HttpSecurity#securityMatcher` to ensure that there is only one filter chain configured for 'any request' and that the 'any request' filter chain is published last.\n    at org.springframework.beans.factory.support.ConstructorResolver.instantiate(ConstructorResolver.java:657)\n    at org.springframework.beans.factory.support.ConstructorResolver.instantiateUsingFactoryMethod(ConstructorResolver.java:489)\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.instantiateUsingFactoryMethod(AbstractAutowireCapableBeanFactory.java:1357)\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:1187)\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:563)\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:523)\n    at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveInnerBeanValue(BeanDefinitionValueResolver.java:407)\n    ... 29 common frames omitted\nCaused by: org.springframework.beans.BeanInstantiationException: Failed to instantiate [jakarta.servlet.Filter]: Factory method 'springSecurityFilterChain' threw exception with message: A filter chain that matches any request [DefaultSecurityFilterChain defined as 'basicAndFormAuthFilter' in [class path resource [/BasicAndFormAuthConfig.class]] matching [any request] and having filters [DisableEncodeUrl, WebAsyncManagerIntegration, SecurityContextHolder, HeaderWriter, Cors, Logout, UsernamePasswordAuthentication, DefaultResources, DefaultLoginPageGenerating, DefaultLogoutPageGenerating, BasicAuthentication, RequestCacheAware, SecurityContextHolderAwareRequest, AnonymousAuthentication, SessionManagement, ExceptionTranslation]] has already been configured, which means that this filter chain [DefaultSecurityFilterChain defined as 'jwtSecurityFilterChain' in [class path resource [org/springframework/boot/autoconfigure/security/oauth2/resource/servlet/OAuth2ResourceServerJwtConfiguration$OAuth2SecurityFilterChainConfiguration.class]] matching [any request] and having filters [DisableEncodeUrl, WebAsyncManagerIntegration, SecurityContextHolder, HeaderWriter, Csrf, Logout, BearerTokenAuthentication, RequestCacheAware, SecurityContextHolderAwareRequest, AnonymousAuthentication, ExceptionTranslation, Authorization]] will never get invoked. Please use `HttpSecurity#securityMatcher` to ensure that there is only one filter chain configured for 'any request' and that the 'any request' filter chain is published last.\n    at org.springframework.beans.factory.support.SimpleInstantiationStrategy.lambda$instantiate$0(SimpleInstantiationStrategy.java:199)\n    at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiateWithFactoryMethod(SimpleInstantiationStrategy.java:88)\n    at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate(SimpleInstantiationStrategy.java:168)\n    at org.springframework.beans.factory.support.ConstructorResolver.instantiate(ConstructorResolver.java:653)\n    ... 35 common frames omitted\nCaused by: java.lang.IllegalArgumentException: A filter chain that matches any request [DefaultSecurityFilterChain defined as 'basicAndFormAuthFilter' in [class path resource [/BasicAndFormAuthConfig.class]] matching [any request] and having filters [DisableEncodeUrl, WebAsyncManagerIntegration, SecurityContextHolder, HeaderWriter, Cors, Logout, UsernamePasswordAuthentication, DefaultResources, DefaultLoginPageGenerating, DefaultLogoutPageGenerating, BasicAuthentication, RequestCacheAware, SecurityContextHolderAwareRequest, AnonymousAuthentication, SessionManagement, ExceptionTranslation]] has already been configured, which means that this filter chain [DefaultSecurityFilterChain defined as 'jwtSecurityFilterChain' in [class path resource [org/springframework/boot/autoconfigure/security/oauth2/resource/servlet/OAuth2ResourceServerJwtConfiguration$OAuth2SecurityFilterChainConfiguration.class]] matching [any request] and having filters [DisableEncodeUrl, WebAsyncManagerIntegration, SecurityContextHolder, HeaderWriter, Csrf, Logout, BearerTokenAuthentication, RequestCacheAware, SecurityContextHolderAwareRequest, AnonymousAuthentication, ExceptionTranslation, Authorization]] will never get invoked. Please use `HttpSecurity#securityMatcher` to ensure that there is only one filter chain configured for 'any request' and that the 'any request' filter chain is published last.\n    at org.springframework.security.config.annotation.web.builders.WebSecurity.performBuild(WebSecurity.java:320)\n    at org.springframework.security.config.annotation.web.builders.WebSecurity.performBuild(WebSecurity.java:94)\n    at org.springframework.security.config.annotation.AbstractConfiguredSecurityBuilder.doBuild(AbstractConfiguredSecurityBuilder.java:354)\n    at org.springframework.security.config.annotation.AbstractSecurityBuilder.build(AbstractSecurityBuilder.java:38)\n    at org.springframework.security.config.annotation.web.configuration.WebSecurityConfiguration.springSecurityFilterChain(WebSecurityConfiguration.java:118)\n    at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:580)\n    at org.springframework.beans.factory.support.SimpleInstantiationStrategy.lambda$instantiate$0(SimpleInstantiationStrategy.java:171)\n    ... 38 common frames omitted\n</code></pre>\n<p>It comes from an existing <code>SecurityFilterChain</code> 'jwtSecurityFilterChain' in <code>OAuth2ResourceServerJwtConfiguration.OAuth2SecurityFilterChainConfiguration</code>:</p>\n<pre class=\"lang-java prettyprint-override\"><code>    @Configuration(proxyBeanMethods = false)\n    @ConditionalOnDefaultWebSecurity\n    static class OAuth2SecurityFilterChainConfiguration {\n\n        @Bean\n        @ConditionalOnBean(JwtDecoder.class)\n        SecurityFilterChain jwtSecurityFilterChain(HttpSecurity http) throws Exception {\n            http.authorizeHttpRequests((requests) -&gt; requests.anyRequest().authenticated());\n            http.oauth2ResourceServer((resourceServer) -&gt; resourceServer.jwt(withDefaults()));\n            return http.build();\n        }\n\n    }\n</code></pre>\n<p>Since the following <code>SecurityFilterChain</code> is part of the library, I don't know how to get around this error using the tips above.</p>\n<p>How can I exclude a configuration inner package-private class <code>OAuth2ResourceServerJwtConfiguration.OAuth2SecurityFilterChainConfiguration.class</code>?</p>\n<p>Provided that you need to do this:</p>\n<ol>\n<li>In a custom local library, then without @SpringBootApplication annotations</li>\n<li>I tried the tips from this answer <a href=\"https://stackoverflow.com/questions/67020215/how-to-turn-off-spring-security-auto-configuration\">How to turn off spring security auto-configuration?</a>, they didn't work</li>\n</ol>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}