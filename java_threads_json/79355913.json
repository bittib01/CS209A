{
  "question": {
    "tags": [
      "java",
      "runtime-error",
      "grpc-java"
    ],
    "owner": {
      "account_id": 39266744,
      "reputation": 11,
      "user_id": 29189304,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/8b9494935858a211181e4ad791330743?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Mikle N",
      "link": "https://stackoverflow.com/users/29189304/mikle-n"
    },
    "is_answered": false,
    "view_count": 279,
    "answer_count": 0,
    "score": 1,
    "last_activity_date": 1738061999,
    "creation_date": 1736876919,
    "last_edit_date": 1736876970,
    "question_id": 79355913,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79355913/why-the-grpcclient-annotation-doesnt-work",
    "title": "Why the GrpcClient annotation doesn&#39;t work?",
    "body": "<p>I am trying to set up a GRPC client, but the default implementation does not work. Below I describe my project (Java, SpringBoot, GRPC).</p>\n<p>I have:</p>\n<p><strong>the protofile</strong> is located separately from the server and the client</p>\n<pre class=\"lang-protobuf prettyprint-override\"><code>syntax = &quot;proto3&quot;;\n\npackage my.proto.file.proto.event;\n\nimport &quot;google/protobuf/timestamp.proto&quot;;\nimport &quot;google/protobuf/empty.proto&quot;;\n\nmessage EventsRequest {\n  string serviceName = 1;\n}\n\nmessage EventSaveRequest {\n  Event event = 1;\n  string eventType = 2;\n}\n\nmessage Event {\n  string eventId = 1;\n  string source = 2;\n  string login = 3;\n  string role = 4;\n  string operation = 5;\n  string description = 6;\n  optional google.protobuf.Timestamp createdAt = 7;\n}\n\nmessage EventResponse {\n  repeated Event events = 1;\n}\n\nmessage SaveEventResponse {\n  Event events = 1;\n}\n\nservice EventService {\n\n    rpc getEventsByServiceName(EventsRequest) returns (stream EventResponse);\n\n    rpc saveEvents(EventSaveRequest) returns (SaveEventResponse);\n\n}\n</code></pre>\n<p><strong>application.yml client</strong></p>\n<pre class=\"lang-yaml prettyprint-override\"><code>...\ngrpc:\n  client:\n    my-service-client:\n      address: &quot;localhost:9090&quot;\n      negotiationType: PLAINTEXT\n...\n</code></pre>\n<p><strong>build.gradle.kts client</strong></p>\n<pre class=\"lang-kotlin prettyprint-override\"><code>...\ndependencyManagement {\n    dependencies {\n                ...\n        dependency(&quot;my.proto.file:eventmanager-grpc-proto:1.0.0-SNAPSHOT&quot;)\n        dependency(&quot;net.devh:grpc-client-spring-boot-starter:3.1.0.RELEASE&quot;)\n    }\n}\n\ndependencies {\n    implementation(&quot;net.devh:grpc-client-spring-boot-starter&quot;)\n    implementation(&quot;my.proto.file:eventmanager-grpc-proto&quot;)\n        ...\n}\n...\n</code></pre>\n<p><strong>service client</strong></p>\n<pre class=\"lang-java prettyprint-override\"><code>import lombok.extern.slf4j.Slf4j;\nimport net.devh.boot.grpc.client.inject.GrpcClient;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Service;\nimport my.proto.file.proto.event.EventServiceGrpc;\nimport my.proto.file.proto.event.EventOuterClass;\n\n@Slf4j\n@Service\npublic class EventService {\n    @GrpcClient(&quot;my-service-client&quot;)\n    private EventServiceGrpc.EventServiceBlockingStub blockingStub;\n\n    public EventOuterClass.EventResponse getEventsByServiceName(String serviceName) {\n        EventOuterClass.EventsRequest request = EventOuterClass.EventsRequest\n                .newBuilder()\n                .setServiceName(serviceName)\n                .build();\n        EventOuterClass.EventResponse response = blockingStub.getEventsByServiceName(request).next();\n        return response;\n    }\n\n    ... // here is the call to saveEvents\n}\n</code></pre>\n<p><strong>application.yml server</strong></p>\n<pre class=\"lang-yaml prettyprint-override\"><code>...\ngrpc:\n  server:\n    port: 9090\n    reflection-service-enabled: true\n    shutdown-grace-period: 0\n...\n</code></pre>\n<p><strong>build.gradle.kts server</strong></p>\n<pre class=\"lang-kotlin prettyprint-override\"><code>...\ndependencies {\n    ...\n    implementation(&quot;io.grpc:grpc-api:1.63.0&quot;)\n    implementation(&quot;io.grpc:grpc-stub:1.63.0&quot;)\n    implementation(&quot;io.grpc:grpc-protobuf:1.63.0&quot;)\n    implementation(&quot;net.devh:grpc-server-spring-boot-starter:3.1.0.RELEASE&quot;)\n    testImplementation(&quot;net.devh:grpc-client-spring-boot-starter:3.1.0.RELEASE&quot;)\n    implementation(&quot;org.springdoc:springdoc-openapi-starter-webflux-api&quot;)\n    implementation(&quot;org.springdoc:springdoc-openapi-starter-webflux-ui&quot;)\n    implementation(&quot;io.netty:netty-all:4.1.110.Final&quot;)\n    implementation(&quot;org.javers:javers-core&quot;)\n    implementation(&quot;de.codecentric:spring-boot-admin-starter-client:3.3.2&quot;)\n    implementation(&quot;io.projectreactor:reactor-tools&quot;)\n    implementation(&quot;io.r2dbc:r2dbc-postgresql:0.8.13.RELEASE&quot;)\n\n    //compile only\n    compileOnly(&quot;org.projectlombok:lombok&quot;)\n    compileOnly (&quot;io.grpc:grpc-netty:1.63.0&quot;)\n    compileOnly (&quot;io.grpc:grpc-protobuf:1.63.0&quot;)\n    compileOnly (&quot;io.grpc:grpc-stub:1.63.0&quot;)\n    compileOnly (&quot;io.grpc:grpc-services:1.63.0&quot;)\n\n    testImplementation(&quot;io.projectreactor:reactor-test&quot;)\n    testImplementation(&quot;io.grpc:grpc-testing:1.63.0&quot;)\n    testImplementation(&quot;com.salesforce.servicelibs:reactor-grpc-stub:1.2.4&quot;)\n    ...\n}\n\ndependencyManagement {\n...\n    dependencies {\n        ...\n        dependency(&quot;org.projectlombok:lombok-mapstruct-binding:0.2.0&quot;)\n        dependency(&quot;org.springdoc:springdoc-openapi-starter-webflux-api:2.5.0&quot;)\n        dependency(&quot;org.springdoc:springdoc-openapi-starter-webflux-ui:2.5.0&quot;)\n        dependency(&quot;my.proto.file:eventmanager-grpc-proto:1.0.0-SNAPSHOT&quot;)\n        dependency(&quot;org.springframework.cloud:spring-cloud-starter-sleuth:3.1.11&quot;)\n        dependency(&quot;org.springframework.cloud:spring-cloud-sleuth-zipkin:3.1.11&quot;)\n        dependency(&quot;io.projectreactor:reactor-core:3.6.2&quot;)\n        ...\n    }\n}\n...\n</code></pre>\n<p><strong>service server</strong></p>\n<pre class=\"lang-java prettyprint-override\"><code>import my.proto.file.eventmanager.interceptors.LogGrpcInterceptor;\nimport my.proto.file.eventmanager.mapper.EventMapper;\nimport my.proto.file.eventmanager.model.Event;\nimport my.proto.file.proto.event.EventOuterClass;\nimport my.proto.file.proto.event.ReactorEventServiceGrpc;\n\nimport io.micrometer.tracing.Tracer;\nimport io.micrometer.tracing.annotation.NewSpan;\nimport jakarta.validation.ConstraintViolationException;\nimport jakarta.validation.Validator;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport net.devh.boot.grpc.server.service.GrpcService;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Mono;\n\nimport java.time.Duration;\n\n@GrpcService(interceptors = {LogGrpcInterceptor.class})\n@Slf4j\n@RequiredArgsConstructor\npublic class GrpcImplEventService extends ReactorEventServiceGrpc.EventServiceImplBase {\n    private static final Long TIMEOUT_MILLIS = 5000L;\n    private final EventService eventService;\n    private final Tracer tracer;\n    private final Validator validator;\n\n    @Override\n    @NewSpan\n    public Flux&lt;EventOuterClass.EventResponse&gt; getEventsByServiceName(EventOuterClass.EventsRequest request) {\n        Flux&lt;Event&gt; w = eventService.getEventsByServiceName(request.getServiceName());\n        return Mono.just(request)\n                       .flatMapMany(req -&gt; eventService.getEventsByServiceName(req.getServiceName())\n                                                   .doOnNext(ev -&gt; spanTag(&quot;source&quot;, req.getServiceName()))\n                                                   .map(\n                                                           ev -&gt; EventOuterClass.EventResponse.newBuilder().addEvents(EventMapper.INSTANCE.map(ev)).build()\n                                                   )\n\n                       )\n                       .timeout(Duration.ofMillis(TIMEOUT_MILLIS))\n                       .doOnError(this::spanError)\n                       .doOnNext(response -&gt; log.info(&quot;Events count received: {}&quot;, response.getEventsCount()));\n\n    }\n   ... // here is the implementation saveEvents, validate, spanTag, spanError\n}\n</code></pre>\n<p>When I call the client service, the client returns errors</p>\n<blockquote>\n<p>[grpc-nio-worker-ELG-1-5] DEBUG n.d.b.g.c.n.DiscoveryClientNameResolver - Scheduled resolve for localhost:9090</p>\n</blockquote>\n<blockquote>\n<p>[grpc-default-executor-0] ERROR n.d.b.g.c.n.DiscoveryClientNameResolver - No servers found for localhost:9090</p>\n</blockquote>\n<blockquote>\n<p>[grpc-default-executor-0] WARN  io.grpc.internal.ManagedChannelImpl - [Channel&lt;3&gt;: (localhost:9090)] Failed to resolve name. status=Status{code=UNAVAILABLE, description=No servers found for localhost:9090, cause=null}</p>\n</blockquote>\n<blockquote>\n<p>[grpc-default-executor-0] DEBUG io.grpc.ChannelLogger - [Channel&lt;3&gt;: (localhost:9090)] Entering TRANSIENT_FAILURE state with picker: FixedResultPicker(PickResult{subchannel=null, streamTracerFactory=null, status=Status{code=UNAVAILABLE, description=No servers found for localhost:9090, cause=null}, drop=false})</p>\n</blockquote>\n<blockquote>\n<p>[grpc-default-executor-0] DEBUG i.g.i.BackoffPolicyRetryScheduler - Scheduling DNS resolution backoff for 6 987 791 831ns</p>\n</blockquote>\n<blockquote>\n<p>[http-nio-8081-exec-2] ERROR o.a.c.c.C.[.[.[.[dispatcherServlet] - Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed: io.grpc.StatusRuntimeException: UNAVAILABLE: No servers found for localhost:9090] with root cause io.grpc.StatusRuntimeException: UNAVAILABLE: No servers found for localhost:9090</p>\n</blockquote>\n<blockquote>\n<p>[grpc-default-executor-0] ERROR n.d.b.g.c.n.DiscoveryClientNameResolver - No servers found for localhost:9090</p>\n</blockquote>\n<blockquote>\n<p>[grpc-default-executor-0] WARN  io.grpc.internal.ManagedChannelImpl - [Channel&lt;3&gt;: (localhost:9090)] Failed to resolve name. status=Status{code=UNAVAILABLE, description=No servers found for localhost:9090, cause=null}</p>\n</blockquote>\n<blockquote>\n<p>[grpc-default-executor-0] DEBUG io.grpc.ChannelLogger - [Channel&lt;3&gt;: (localhost:9090)] Failed to resolve name: Status{code=UNAVAILABLE, description=No servers found for localhost:9090, cause=null}</p>\n</blockquote>\n<blockquote>\n<p>[grpc-default-executor-0] DEBUG io.grpc.ChannelLogger - [Channel&lt;3&gt;: (localhost:9090)] Entering TRANSIENT_FAILURE state with picker: FixedResultPicker(PickResult{subchannel=null, streamTracerFactory=null, status=Status{code=UNAVAILABLE, description=No servers found for localhost:9090, cause=null}, drop=false})</p>\n</blockquote>\n<blockquote>\n<p>[http-nio-8081-exec-2] DEBUG io.grpc.Context - Storage override doesn't exist. Using default java.lang.ClassNotFoundException: io.grpc.override.ContextStorageOverride</p>\n</blockquote>\n<p>P.S.\nIf I create my own bean and substitute it instead of GrpcClient, everything will work. Below is an example of the client working.</p>\n<p><strong>My bean</strong></p>\n<pre class=\"lang-java prettyprint-override\"><code>import io.grpc.ManagedChannel;\nimport io.grpc.ManagedChannelBuilder;\nimport io.grpc.stub.AbstractBlockingStub;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.ComponentScan;\nimport org.springframework.context.annotation.Configuration;\nimport my.proto.file.proto.event.EventServiceGrpc;\nimport my.proto.file.proto.event.EventServiceGrpc.EventServiceBlockingStub;\n\n\n@Configuration\n@ComponentScan(basePackages = &quot;accessportal.controller&quot;)\npublic class MyBeans {\n    @Bean\n    public EventServiceBlockingStub EventServiceBlockingStub() {\n        ManagedChannel channel = ManagedChannelBuilder\n                .forTarget(&quot;localhost:9090&quot;)\n                .usePlaintext().build();\n        return EventServiceGrpc.newBlockingStub(channel);\n    }\n}\n</code></pre>\n<p>Reworked client service to my bin</p>\n<pre class=\"lang-java prettyprint-override\"><code>...\npublic class EventService {\n    @Autowired\n    private EventServiceGrpc.EventServiceBlockingStub blockingStub;\n\n    public EventOuterClass.EventResponse getEventsByServiceName(String serviceName) {\n        EventOuterClass.EventsRequest request = EventOuterClass.EventsRequest\n                .newBuilder()\n                .setServiceName(serviceName)\n                .build();\n        EventOuterClass.EventResponse response = blockingStub.getEventsByServiceName(request).next();\n        return response;\n    }\n\n    ...// here is the call to saveEvents\n}\n</code></pre>\n<p>Also, my stub has a different structure than GrpcClient</p>\n<p>GrpcClient BlockStub structure has many channels\n<img src=\"https://i.sstatic.net/J1NfrN2C.png\" alt=\"enter image description here\" /></p>\n<p>My BlockStub structure\n<img src=\"https://i.sstatic.net/KnQ2hWbG.png\" alt=\"enter image description here\" /></p>\n<p>If I don't have enough information, write to me, I will supplement my question.</p>\n<p>I tried different versions of dependencies. And also instead of implementing GrpcClient I made my own, which works.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}