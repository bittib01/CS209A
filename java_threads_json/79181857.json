{
  "question": {
    "tags": [
      "java",
      "metaspace"
    ],
    "owner": {
      "account_id": 4835964,
      "reputation": 2304,
      "user_id": 3902663,
      "user_type": "registered",
      "accept_rate": 78,
      "profile_image": "https://i.sstatic.net/IQyER.jpg?s=256",
      "display_name": "SATO Yusuke",
      "link": "https://stackoverflow.com/users/3902663/sato-yusuke"
    },
    "is_answered": false,
    "view_count": 61,
    "answer_count": 0,
    "score": 1,
    "last_activity_date": 1733671361,
    "creation_date": 1731427064,
    "last_edit_date": 1733671361,
    "question_id": 79181857,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79181857/how-to-get-metaspace-usage-histogram",
    "title": "How to get metaspace usage histogram",
    "body": "<h2>Background</h2>\n<p>The application we developed causes <code>java.lang.OutOfMemoryError: Metaspace</code> even in <code>-XX:MaxMetaspaceSize=512m</code> environment. This application consists of many jars, so I am guessing the <code>OutOfMemoryError</code> is not caused by a memory leak but by the fact that there are so many classes. So I want to know which packages or jars cause metaspace shortage.</p>\n<h2>Problem</h2>\n<p>You can use jmap to show the usage of Java heap, but I couldn't find a way to show a metaspace histogram with jmap.</p>\n<ul>\n<li><code>jmap -histo</code> shows a histogram for instances on the java heap, not metaspace.</li>\n<li><code>jmap -clstats</code> shows only metadata usage per classloader, not per package/jar.</li>\n</ul>\n<h2>Question</h2>\n<p>Is there any way to get the metaspace usage histogram?\nFor example, I want to know &quot;The classes in <code>spring-*.jar</code> take the most part of 512M metaspace&quot;.</p>\n<p>Out-of-the-box feature of JDK or JRE is preferable.</p>\n<h3>Edit</h3>\n<ul>\n<li>Metaspace OOMs occur until application redeployment (deployment is aborted by Metaspace OOM).</li>\n<li>The application is based on Spring Boot and uses <code>@inject</code> heavily, so many proxy objects are likely to be generated.</li>\n<li>The application doesn't manipulate classloaders or load classes dynamically in business logic.</li>\n<li>The OOMs never occur when <code>-XX:MaxMetaspaceSize=1g</code> (it's not desirable from a resource design perspective) is specified, even after multiple application redeployment.</li>\n<li>The OOMs occur even in the first redeployment after restarting the JavaEE server process.</li>\n<li>The server itself requires ~300MB of metaspace, and the application (<code>.ear</code>) size is 100MB~.</li>\n<li>In application redeployment, the server consumes about 2x of <code>.class</code> size in <code>.ear</code> because of soft reference. I know <code>-XX:SoftRefLRUPolicyMSPerMB=0</code> mitigates it, but it's not preferable because of performance degradation.</li>\n</ul>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}