{
  "question": {
    "tags": [
      "java",
      "spring",
      "upload",
      "spring-webflux",
      "multipart"
    ],
    "owner": {
      "account_id": 30211746,
      "reputation": 1,
      "user_id": 23153563,
      "user_type": "registered",
      "profile_image": "https://lh3.googleusercontent.com/a/ACg8ocLz0RLljxAM6IU3qoTcxwlA-sLiCTPlpa_ZmcqRIVqM1Kw=k-s256",
      "display_name": "Luo Stone",
      "link": "https://stackoverflow.com/users/23153563/luo-stone"
    },
    "is_answered": false,
    "view_count": 855,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1715946921,
    "creation_date": 1703486383,
    "last_edit_date": 1703498673,
    "question_id": 77712720,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/77712720/spring-webflux-multipart-file-uplad-error-could-not-find-first-boundary",
    "title": "spring webflux multipart file uplad error,Could not find first boundary",
    "body": "<p>when i use router function,it works fine\nRouterFunction:</p>\n<pre><code>@Bean\npublic RouterFunction&lt;ServerResponse&gt; configUpload(UploadHandler uploadHandler) {\n    return RouterFunctions.route(RequestPredicates.POST(&quot;/api/v1/config/upload&quot;).and(RequestPredicates.contentType(MediaType.MULTIPART_FORM_DATA)), uploadHandler::uploadConfig);\n}\n</code></pre>\n<p>UploadHandler:</p>\n<pre><code>public Mono&lt;ServerResponse&gt; uploadConfig(ServerRequest request){\n    return request.body(BodyExtractors.toMultipartData()).flatMap(parts-&gt;{\n        Map&lt;String, Part&gt; stringPartMap = parts.toSingleValueMap();\n        stringPartMap.forEach((partName,value)-&gt;{\n            if(value instanceof FilePart){\n                // Handle file\n                FilePart file = (FilePart) stringPartMap.get(partName);\n                DefaultLogGenerator.BIZ_SERVICE_LOGGER.info(&quot;File name: {}&quot;, file.filename());\n            }\n            if(value instanceof FormFieldPart){\n                // Handle form field\n                FormFieldPart type = (FormFieldPart) stringPartMap.get(partName);\n                DefaultLogGenerator.BIZ_SERVICE_LOGGER.info(&quot;type value: {}&quot;, type.value());\n            }\n        });\n\n\n        return Mono.empty();\n    }).then(ServerResponse.ok().bodyValue(Result.success(new MultiFileUploadResponse())));\n}\n</code></pre>\n<p>But when i use RestController with RequestBody it give me a parse error: Could not find first boundary</p>\n<blockquote>\n<p>reactor.core.Exceptions$ErrorCallbackNotImplemented:\norg.springframework.web.server.ServerWebInputException: 400\nBAD_REQUEST &quot;Failed to read HTTP message&quot;; nested exception is\norg.springframework.core.codec.DecodingException: Could not find first\nboundary Caused by:\norg.springframework.web.server.ServerWebInputException: 400\nBAD_REQUEST &quot;Failed to read HTTP message&quot;; nested exception is\norg.springframework.core.codec.DecodingException: Could not find first\nboundary  at\norg.springframework.web.reactive.result.method.annotation.AbstractMessageReaderArgumentResolver.handleReadError(AbstractMessageReaderArgumentResolver.java:235)\n~[spring-webflux-5.3.27.jar:5.3.27]   at\norg.springframework.web.reactive.result.method.annotation.AbstractMessageReaderArgumentResolver.lambda$readBody$0(AbstractMessageReaderArgumentResolver.java:185)\n~[spring-webflux-5.3.27.jar:5.3.27]   at\nreactor.core.publisher.FluxOnErrorResume$ResumeSubscriber.onError(FluxOnErrorResume.java:94)\n~[reactor-core-3.4.29.jar:3.4.29]     at\nreactor.core.publisher.FluxCreate$BaseSink.error(FluxCreate.java:474)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxCreate$BufferAsyncSink.drain(FluxCreate.java:802)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxCreate$BufferAsyncSink.error(FluxCreate.java:747)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxCreate$SerializedFluxSink.drainLoop(FluxCreate.java:237)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxCreate$SerializedFluxSink.drain(FluxCreate.java:213)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxCreate$SerializedFluxSink.error(FluxCreate.java:189)\n[reactor-core-3.4.29.jar:3.4.29]  at\norg.springframework.http.codec.multipart.PartGenerator.hookOnError(PartGenerator.java:176)\n[spring-web-5.3.27.jar:5.3.27]    at\nreactor.core.publisher.BaseSubscriber.onError(BaseSubscriber.java:180)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxCreate$BaseSink.error(FluxCreate.java:474)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxCreate$BufferAsyncSink.drain(FluxCreate.java:802)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxCreate$BufferAsyncSink.error(FluxCreate.java:747)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxCreate$SerializedFluxSink.drainLoop(FluxCreate.java:237)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxCreate$SerializedFluxSink.drain(FluxCreate.java:213)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxCreate$SerializedFluxSink.error(FluxCreate.java:189)\n[reactor-core-3.4.29.jar:3.4.29]  at\norg.springframework.http.codec.multipart.MultipartParser.emitError(MultipartParser.java:179)\n[spring-web-5.3.27.jar:5.3.27]    at\norg.springframework.http.codec.multipart.MultipartParser$PreambleState.onComplete(MultipartParser.java:321)\n[spring-web-5.3.27.jar:5.3.27]    at\norg.springframework.http.codec.multipart.MultipartParser.hookOnComplete(MultipartParser.java:124)\n[spring-web-5.3.27.jar:5.3.27]    at\nreactor.core.publisher.BaseSubscriber.onComplete(BaseSubscriber.java:197)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxMap$MapSubscriber.onComplete(FluxMap.java:144)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxPeek$PeekSubscriber.onComplete(FluxPeek.java:260)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.core.publisher.FluxMap$MapSubscriber.onComplete(FluxMap.java:144)\n[reactor-core-3.4.29.jar:3.4.29]  at\nreactor.netty.channel.FluxReceive.disposeAndUnsubscribeReceiver(FluxReceive.java:499)\n[reactor-netty-core-1.0.32.jar:1.0.32]    at\nreactor.netty.channel.FluxReceive.lambda$new$0(FluxReceive.java:86)\n[reactor-netty-core-1.0.32.jar:1.0.32]    at\nreactor.netty.channel.FluxReceive.cancelReceiver(FluxReceive.java:199)\n[reactor-netty-core-1.0.32.jar:1.0.32]    at\nreactor.netty.channel.FluxReceive.doCancel(FluxReceive.java:205)\n[reactor-netty-core-1.0.32.jar:1.0.32]    at\nreactor.netty.channel.FluxReceive.dispose(FluxReceive.java:118)\n[reactor-netty-core-1.0.32.jar:1.0.32]    at\nreactor.netty.channel.ChannelOperations.discard(ChannelOperations.java:366)\n~[reactor-netty-core-1.0.32.jar:1.0.32]   at\nreactor.netty.http.server.HttpServerOperations.cleanHandlerTerminate(HttpServerOperations.java:764)\n~[reactor-netty-http-1.0.32.jar:1.0.32]   at\nreactor.netty.http.server.HttpTrafficHandler.operationComplete(HttpTrafficHandler.java:464)\n~[reactor-netty-http-1.0.32.jar:1.0.32]   at\nreactor.netty.http.server.HttpTrafficHandler.operationComplete(HttpTrafficHandler.java:65)\n~[reactor-netty-http-1.0.32.jar:1.0.32]   at\nio.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:590)\n~[netty-common-4.1.92.Final.jar:4.1.92.Final]     at\nio.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:557)\n~[netty-common-4.1.92.Final.jar:4.1.92.Final]     at\nio.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:492)\n~[netty-common-4.1.92.Final.jar:4.1.92.Final]     at\nio.netty.util.concurrent.DefaultPromise.setValue0(DefaultPromise.java:636)\n~[netty-common-4.1.92.Final.jar:4.1.92.Final]     at\nio.netty.util.concurrent.DefaultPromise.setSuccess0(DefaultPromise.java:625)\n~[netty-common-4.1.92.Final.jar:4.1.92.Final]     at\nio.netty.util.concurrent.DefaultPromise.trySuccess(DefaultPromise.java:105)\n~[netty-common-4.1.92.Final.jar:4.1.92.Final]     at\nio.netty.util.concurrent.PromiseCombiner.tryPromise(PromiseCombiner.java:170)\n~[netty-common-4.1.92.Final.jar:4.1.92.Final]     at\nio.netty.util.concurrent.PromiseCombiner.access$600(PromiseCombiner.java:35)\n~[netty-common-4.1.92.Final.jar:4.1.92.Final]     at\nio.netty.util.concurrent.PromiseCombiner$1.operationComplete0(PromiseCombiner.java:62)\n~[netty-common-4.1.92.Final.jar:4.1.92.Final]     at\nio.netty.util.concurrent.PromiseCombiner$1.operationComplete(PromiseCombiner.java:44)\n~[netty-common-4.1.92.Final.jar:4.1.92.Final]</p>\n</blockquote>\n<p>Controller code is:</p>\n<pre><code>@PostMapping(value = &quot;/upload&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\npublic Mono&lt;Result&lt;MultiFileUploadResponse&gt;&gt; upload(@RequestBody Mono&lt;MultiValueMap&lt;String, Part&gt;&gt; multiValueMapMono) {\n    multiValueMapMono.subscribe(stringPartMap -&gt; {\n        stringPartMap.forEach((partName, value) -&gt; {\n            if (value instanceof FilePart) {\n                // Handle file\n                FilePart file = (FilePart) stringPartMap.get(partName);\n                DefaultLogGenerator.BIZ_SERVICE_LOGGER.info(&quot;File name: {}&quot;, file.filename());\n            }\n            if (value instanceof FormFieldPart) {\n                // Handle form field\n                FormFieldPart type = (FormFieldPart) stringPartMap.get(partName);\n                DefaultLogGenerator.BIZ_SERVICE_LOGGER.info(&quot;type value: {}&quot;, type.value());\n            }\n        });\n    });\n    return Mono.just(Result.success(new MultiFileUploadResponse()));\n}\n\n@PostMapping(value = &quot;/upload2&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\npublic Mono&lt;Result&lt;MultiFileUploadResponse&gt;&gt; upload2(@RequestBody Flux&lt;Part&gt; input) {\n    input.subscribe(value -&gt; {\n        if (value instanceof FilePart) {\n            // Handle file\n            FilePart file = (FilePart) value;\n            DefaultLogGenerator.BIZ_SERVICE_LOGGER.info(&quot;File name: {}&quot;, file.filename());\n        }\n        if (value instanceof FormFieldPart) {\n            // Handle form field\n            FormFieldPart type = (FormFieldPart) value;\n            DefaultLogGenerator.BIZ_SERVICE_LOGGER.info(&quot;type value: {}&quot;, type.value());\n        }\n    });\n    return Mono.just(Result.success(new MultiFileUploadResponse()));\n}\n</code></pre>\n<p>Both Mono&lt;MultiValueMap&lt;String, Part&gt;&gt; or Flux&lt;Part&gt; get error</p>\n<p>Spring webflux version:</p>\n<blockquote>\n<p>              org.springframework.boot\nspring-boot-starter-webflux\n2.7.12          </p>\n</blockquote>\n<p>I have read the spring reference and confirm it support\n<a href=\"https://docs.spring.io/spring-framework/docs/5.3.x/reference/html/web-reactive.html#webflux-multipart-forms\" rel=\"nofollow noreferrer\">https://docs.spring.io/spring-framework/docs/5.3.x/reference/html/web-reactive.html#webflux-multipart-forms</a></p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}