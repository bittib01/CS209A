{
  "question": {
    "tags": [
      "java",
      "sql-server",
      "always-encrypted"
    ],
    "owner": {
      "account_id": 2714938,
      "reputation": 6458,
      "user_id": 2342529,
      "user_type": "registered",
      "accept_rate": 98,
      "profile_image": "https://i.sstatic.net/SSkK4.jpg?s=256",
      "display_name": "Alexandru Severin",
      "link": "https://stackoverflow.com/users/2342529/alexandru-severin"
    },
    "is_answered": false,
    "view_count": 321,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1721914581,
    "creation_date": 1708364680,
    "last_edit_date": 1721914581,
    "question_id": 78022602,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78022602/call-a-stored-procedure-on-an-always-encrypted-sql-server-database",
    "title": "Call a stored procedure on an always encrypted SQL Server database",
    "body": "<p>When calling any stored procedure from an Always Encrypted SQL Server database I get the following error:</p>\n<blockquote>\n<p>SQLServerException: The incoming tabular data stream (TDS) remote procedure call (RPC) protocol stream is incorrect. Parameter 1 (&quot;&quot;): Data type 0xC0 is unknown.</p>\n</blockquote>\n<p>The table and the stored procedure was created like this:</p>\n<pre><code>CREATE TABLE [dbo].[test_table] (\n    [id] [int] IDENTITY(1,1) NOT NULL,\n    [encrypted_col] [nvarchar](255) COLLATE Latin1_General_BIN2 ENCRYPTED WITH (COLUMN_ENCRYPTION_KEY = [MY_KEY], ENCRYPTION_TYPE = Randomized, ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256') NOT NULL\n)\nGO\n\nCREATE PROCEDURE [dbo].[test_sp]\n    @test_param nvarchar(255)\nAS\n    SELECT * from test_table where encrypted_col = @test_param\nGO\n</code></pre>\n<p>The java code looks like this:</p>\n<pre><code>try(CallableStatement callableStatement = connection.prepareCall(&quot;{call test_sp(?)}&quot;)) {\n    callableStatement.setNString(1, &quot;TEST VALUE&quot;);\n    ResultSet rs = callableStatement.executeQuery(); &lt;-- Throws the Exception\n}\n</code></pre>\n<p>My connection url looks like this:</p>\n<pre><code>jdbc:sqlserver://localhost:1433;applicationName=MY-APP;databaseName=test_encryption;sendStringParametersAsUnicode=false;encrypt=true;trustServerCertificate=true;columnEncryptionSetting=enabled;enclaveAttestationUrl=http://localhost/Attestation;enclaveAttestationProtocol=HGS;\n</code></pre>\n<p>What causes this error?</p>\n<p>Notes:</p>\n<ul>\n<li>I am using SQL Server 2019 and latest mssql driver (12.6), which are <a href=\"https://learn.microsoft.com/en-us/sql/connect/jdbc/microsoft-jdbc-driver-for-sql-server-support-matrix?view=sql-server-ver16\" rel=\"nofollow noreferrer\">compatible</a>. I also tried downgrading the driver but results in the same error.</li>\n<li>Reading and writing data from/to the database tables works using Hibernate, which makes me think the connection url and encryption key are setup correctly. I only get this error on stored procedures</li>\n<li>The stored procedure can be called with success from SQL Server Management Studio, which makes me think the procedure and encryption was created correctly at the database level</li>\n<li>I have tried several other ways of calling the stored procedure, such as using Hibernate Query, or Spring Jpa Query, but they result in the same error.</li>\n<li>If I recreate the database table without using encryption, calling the stored procedure works</li>\n<li>I have tried to use the database connection parameter sendStringParametersAsUnicode with both false and true values</li>\n</ul>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}