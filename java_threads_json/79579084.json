{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-boot",
      "virtual-threads",
      "structured-concurrency"
    ],
    "owner": {
      "account_id": 4645073,
      "reputation": 1225,
      "user_id": 3763679,
      "user_type": "registered",
      "profile_image": "https://i.sstatic.net/a0A3d.jpg?s=256",
      "display_name": "Andreas Radauer",
      "link": "https://stackoverflow.com/users/3763679/andreas-radauer"
    },
    "is_answered": true,
    "view_count": 580,
    "accepted_answer_id": 79582274,
    "answer_count": 2,
    "score": 8,
    "last_activity_date": 1745058301,
    "creation_date": 1744887443,
    "last_edit_date": 1745041378,
    "question_id": 79579084,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79579084/using-scopedvalue-instead-of-threadlocal-in-servlet-filter-in-spring-boot-app",
    "title": "Using ScopedValue instead of ThreadLocal in Servlet Filter in spring boot app",
    "body": "<p>Our application heavily uses ThreadLocals where we read values from ServletRequest parameters and provide theses as a global context on Thread Level to other Services.</p>\n<p>Something like this:</p>\n<pre><code>@Component\n@Order(1)\npublic class ParameterHandlingFilter implements Filter {\n\n  public static ThreadLocal&lt;String&gt; EXAMPLE = new ThreadLocal&lt;&gt;();\n\n  @Override\n  public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)\n      throws ServletException, IOException {\n    HttpServletRequest req = (HttpServletRequest) request;\n\n    EXAMPLE.set(req.getParameter(&quot;example&quot;));\n    try {\n        chain.doFilter(request, response);\n    }finally {\n        EXAMPLE.remove();\n    }\n  }\n}\n</code></pre>\n<p>Lots of articles suggest to use previewed <a href=\"https://openjdk.org/jeps/487\" rel=\"noreferrer\">Scoped Values</a> feature as a better approach especially with <a href=\"https://openjdk.org/jeps/444\" rel=\"noreferrer\">Virtual Threads</a> in mind.</p>\n<p>How would be a good approach to handle the IOException and ServletException thrown by the doFilter Method of FilterChain?</p>\n<p>To catch the Exception and wrap it in a RuntimeExeptions seems a bit odd for me and for sonarqube.</p>\n<pre><code>public class ParameterHandlingFilterScopedValue implements Filter {\n\n  public static final ScopedValue&lt;String&gt; EXAMPLE = ScopedValue.newInstance();\n\n  @Override\n  public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) {\n    HttpServletRequest req = (HttpServletRequest) request;\n\n    ScopedValue.where(EXAMPLE, req.getParameter(&quot;example&quot;)).run(() -&gt; {\n        try {\n            chain.doFilter(request, response);\n        }\n        catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    });\n  }\n}\n</code></pre>\n<p>Is there a better solution for this usecase?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}