{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "tomcat",
      "nginx-reverse-proxy",
      "vaadin-flow"
    ],
    "owner": {
      "account_id": 14571259,
      "reputation": 1196,
      "user_id": 10524503,
      "user_type": "registered",
      "profile_image": "https://lh4.googleusercontent.com/-TTMbFydM2wc/AAAAAAAAAAI/AAAAAAAAIbU/tMY5KezwBbg/s256-rj/photo.jpg",
      "display_name": "MarekChr",
      "link": "https://stackoverflow.com/users/10524503/marekchr"
    },
    "is_answered": true,
    "view_count": 334,
    "answer_count": 1,
    "score": 3,
    "last_activity_date": 1763634698,
    "creation_date": 1761636767,
    "last_edit_date": 1763634698,
    "question_id": 79802519,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79802519/sockettimeoutexception-while-downloading-large-file-and-this-behavior-is-inconsi",
    "title": "SocketTimeoutException while downloading large file and this behavior is inconsistent among different browsers",
    "body": "<h3>Description of the bug</h3>\n<p>Description of the bug</p>\n<p>Using Vaadin with Spring Boot, and when I try to download a file using the DownloadHandler.fromInputStream API, the download is being interrupted after some time.</p>\n<p>On the Firefox browser, it is interrupted after 30 seconds. On Chromium-based browsers (tried Chrome and Brave), the download is interrupted after 1GB of data is downloaded.</p>\n<p>The application is deployed to a Debian server behind an Nginx proxy as a WAR file. The Nginx proxy has all timeouts set to a high value, so the timeout is not happening because of Nginx.</p>\n<pre><code>send_timeout 300;\nproxy_connect_timeout 600;\nproxy_send_timeout 600;\nproxy_read_timeout 600;\n</code></pre>\n<p>Regarding tomcat and spring configuration, i tried to use high values for timeouts or infinite timeouts, but they have no effect:</p>\n<pre><code>tomcat:\n    connection-timeout: 900000 (default is 60000).\n</code></pre>\n<p>I found no default timeout configuration of the stack that I am using, which could cause a 30-second timeout while downloading a file. Moreover, this behavior is inconsistent among different types of browsers.</p>\n<p>Looking at the Network inspector in Firefox, the request status is 200, but after 30 seconds it gets <code>NS_BINDING_ABORTED</code>. The download is not canceled by the user. I tried to increase the default timeouts in Firefox too, with no effect:</p>\n<p><a href=\"https://i.sstatic.net/xF1zqbSi.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/xF1zqbSi.png\" alt=\"Firefox configuration\" /></a></p>\n<p>I also tried to use different Java/Tomcat versions.</p>\n<p>What is also interesting is that uploading a large file using the Upload component in Vaadin completes without issue. The problem is happening only during download.</p>\n<p>Vaadin java code:</p>\n<pre><code>hiddenDownloadAnchor.setHrefAndDownload(DownloadHandler.fromInputStream(\n                                downloadEvent -&gt; new DownloadResponse(\n                                        new FileInputStream(file),\n                                        name,\n                                        type,\n                                        length))); // hiddenDownloadAnchor is hidden Anchor component from Vaadin\n</code></pre>\n<p>Content length is set correctly, along with the MIME type. I also tried to use <code>null</code> or <code>-1</code> values to indicate an unknown size or to auto-decide the MIME type, but it had no effect.</p>\n<p>Looking at the stack trace, where the exception is thrown in Tomcat: <code>NioSocketWrapper.doWrite(NioEndpoint.java:1410)</code>, I can see there is a timeout, but I am unsure why. Looking at the <code>timeout</code> variable in debug, which is retrieved from <code>getWriteTimeout()</code>, is larger than 30 seconds (even the default is 60), so I have no clue why this happens consistently in Firefox after 30 seconds, and in Chromium-based browsers after downloading 1GB (exceeding 30 seconds: downloading for about 5 minutes).</p>\n<p>Complete stack trace:</p>\n<pre><code>org.apache.catalina.connector.ClientAbortException: java.net.SocketTimeoutException\n        at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:342)\n        at org.apache.catalina.connector.OutputBuffer.appendByteArray(OutputBuffer.java:747)\n        at org.apache.catalina.connector.OutputBuffer.append(OutputBuffer.java:675)\n        at org.apache.catalina.connector.OutputBuffer.writeBytes(OutputBuffer.java:377)\n        at org.apache.catalina.connector.OutputBuffer.write(OutputBuffer.java:355)\n        at org.apache.catalina.connector.CoyoteOutputStream.write(CoyoteOutputStream.java:102)\n        at com.vaadin.flow.server.streams.TransferUtil.transfer(TransferUtil.java:97)\n        at com.vaadin.flow.server.streams.InputStreamDownloadHandler.handleDownloadRequest(InputStreamDownloadHandler.java:101)\n        at com.vaadin.flow.server.streams.DownloadHandler.handleRequest(DownloadHandler.java:104)\n        at com.vaadin.flow.server.communication.StreamRequestHandler.callElementResourceHandler(StreamRequestHandler.java:194)\n        at com.vaadin.flow.server.communication.StreamRequestHandler.handleRequest(StreamRequestHandler.java:119)\n        at com.vaadin.flow.server.VaadinService.handleRequest(VaadinService.java:1879)\n        at com.vaadin.flow.server.VaadinServlet.service(VaadinServlet.java:398)\n        at com.vaadin.flow.spring.SpringServlet.service(SpringServlet.java:106)\n        at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:195)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n        at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:612)\n        at org.apache.catalina.core.ApplicationDispatcher.processRequest(ApplicationDispatcher.java:394)\n        at org.apache.catalina.core.ApplicationDispatcher.doForward(ApplicationDispatcher.java:323)\n        at org.apache.catalina.core.ApplicationDispatcher.forward(ApplicationDispatcher.java:268)\n        at org.springframework.web.servlet.mvc.ServletForwardingController.handleRequestInternal(ServletForwardingController.java:142)\n        at org.springframework.web.servlet.mvc.AbstractController.handleRequest(AbstractController.java:178)\n        at org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter.handle(SimpleControllerHandlerAdapter.java:51)\n        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)\n        at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)\n        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)\n        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)\n        at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)\n        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)\n        at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:195)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n        at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n        at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n        at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n        at org.springframework.boot.web.servlet.support.ErrorPageFilter.doFilter(ErrorPageFilter.java:124)\n        at org.springframework.boot.web.servlet.support.ErrorPageFilter$1.doFilterInternal(ErrorPageFilter.java:99)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n        at org.springframework.boot.web.servlet.support.ErrorPageFilter.doFilter(ErrorPageFilter.java:117)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n        at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)\n        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:167)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:90)\n        at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:483)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:116)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93)\n        at org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:666)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:344)\n        at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:398)\n        at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63)\n        at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:903)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1776)\n        at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)\n        at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:975)\n        at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:493)\n        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)\n        at java.base/java.lang.Thread.run(Thread.java:1474)\nCaused by: java.net.SocketTimeoutException\n        at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:1410)\n        at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:732)\n        at org.apache.tomcat.util.net.SocketWrapperBase.writeBlocking(SocketWrapperBase.java:572)\n        at org.apache.tomcat.util.net.SocketWrapperBase.write(SocketWrapperBase.java:520)\n        at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.doWrite(Http11OutputBuffer.java:548)\n        at org.apache.coyote.http11.filters.ChunkedOutputFilter.doWrite(ChunkedOutputFilter.java:111)\n        at org.apache.coyote.http11.Http11OutputBuffer.doWrite(Http11OutputBuffer.java:193)\n        at org.apache.coyote.Response.doWrite(Response.java:628)\n        at org.apache.catalina.connector.OutputBuffer.realWriteBytes(OutputBuffer.java:330)\n        ... 70 more\n</code></pre>\n<h3>Expected behavior</h3>\n<p>Downloading large files should complete without issue and should not timeout on firefox browser after 30 seconds or after 1GB downloaded on chromium based browsers.</p>\n<h3>Minimal reproducible example</h3>\n<p>Add view to vaadin with an anchor and initiate download of large file (exceeding 1GB):</p>\n<pre><code>hiddenDownloadAnchor.setHrefAndDownload(DownloadHandler.fromInputStream(\n                                downloadEvent -&gt; new DownloadResponse(\n                                        new FileInputStream(file),\n                                        name,\n                                        type,\n                                        length)));\n</code></pre>\n<p>Application is spring boot with tomcat, deployed as war behind nginx proxy.</p>\n<h3>Versions</h3>\n<ul>\n<li>Vaadin / Flow version: 24.9.3</li>\n<li>Java version: 25/21</li>\n<li>Browser version: Firefox 145.0b6 or Brave 1.83.120 (Chromium: 141.0.7390.122)</li>\n<li>Application Server: Tomcat 10.1.48 (also tried older: 10.1.46)</li>\n</ul>\n<h3>EDIT: Investigation update</h3>\n<p>Came across this old <a href=\"https://trac.nginx.org/nginx/ticket/1472\" rel=\"nofollow noreferrer\">nginx issue</a> citing:</p>\n<blockquote>\n<p>Hi, we tried nginx version 1.6.2 till version 1.12.2 and have a\nproblem when used as proxy before artifactory. Downloads get\ninterrupted at 1GB.</p>\n<p>This behavior depends on the internal VLAN. On one VLAN this always\nhappens. On an other VLAN it never happens. This is size limited, not\ntime limited. From some network it stops after 30 seconds and from one\nother slow network it stops after 13 minutes.</p>\n<p>We made a minimal proxy setup with apache and this works with all\nVLANs. This is why we expect it has something to do with nginx or the\ncombination of nginx and TCP/IP stack of linux.</p>\n<p>In wireshark we see &quot;TCP Dup ACK&quot; on the client side sent to the nginx\nserver.</p>\n<p>Wget fails with connection closed at byte 1083793011 but continues\ndownload with partial content. docker can't handle this and our\ncustomers can't download docker images with layers greater 1 GB.</p>\n</blockquote>\n<p>With suggestion:</p>\n<blockquote>\n<p>The 1GB limit suggests that the problem is due to\nâ€‹proxy_max_temp_file_size. It is one gigabyte by default, and if the\nlimit is reached, nginx will stop reading from the backend till all\ndisk-buffered data are sent to the client. This in turn can result in\na send timeout on the backend side.</p>\n<p>Please check nginx and your backend logs to see what happens here.\nLikely there are something like &quot;upstream prematurely closed\nconnection&quot; in nginx error log, and send timeouts in your backend\nlogs. Alternatively, just check if proxy_max_temp_file_size 0; helps\n(this will disable disk buffering completely).</p>\n<p>If the above suggestion is true, the two possible solutions are:</p>\n<p>Tune proxy_max_temp_file_size. Consider either configuring the limit\nabove the size of all expected responses, or small enough for your\nbackend to don't time out. In particular, proxy_max_temp_file_size 0;\nmight be a good choice when proxying large files. Tune your backend\ntimeouts appropriately.</p>\n</blockquote>\n<p><strong>Changing this <code>proxy_max_temp_file_size</code> to <code>0</code> helps with downloads on chromium based browsers, but this issue persist on firefox.</strong>\nRunning <a href=\"https://nginx.org/en/download.html\" rel=\"nofollow noreferrer\">latest stable (1.28.0) nginx</a> locally, even with default configuration (just set proxy_pass and port) provides same results, so there must be something between nginx and vaadin application.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}