{
  "question": {
    "tags": [
      "java",
      "spring",
      "gradle",
      "junit",
      "jetty"
    ],
    "owner": {
      "account_id": 8582865,
      "reputation": 4285,
      "user_id": 6474292,
      "user_type": "registered",
      "accept_rate": 56,
      "profile_image": "https://www.gravatar.com/avatar/f79b7461639c260154c974c45dc13bc4?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "David",
      "link": "https://stackoverflow.com/users/6474292/david"
    },
    "is_answered": false,
    "view_count": 805,
    "answer_count": 0,
    "score": 4,
    "last_activity_date": 1712640754,
    "creation_date": 1707979695,
    "last_edit_date": 1712640754,
    "question_id": 77998836,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/77998836/java-lang-noclassdeffounderror-jakarta-servlet-servletconnection-while-wrinting",
    "title": "java.lang.NoClassDefFoundError: jakarta/servlet/ServletConnection while wrinting junit",
    "body": "<p>java.lang.NoClassDefFoundError: jakarta/servlet/ServletConnection while wrinting junit</p>\n<p>I am writing Junit for my Java projects.  I am have an issue like</p>\n<p>when I am removing This I am able to run test cases but not my application. and I am adding it I am able to run application not test cases. My few of the test cases are getting failed.</p>\n<p>I am using Spring 3.14 with Java 17.</p>\n<pre><code>resolutionStrategy.eachDependency { details -&gt;\n    if (details.requested.group == 'jakarta.servlet') {\n    details.useVersion '5.0.0'\n    }\n}\n</code></pre>\n<p>This is build.gradle file.</p>\n<pre><code>plugins {\n    id 'org.springframework.boot' version '3.1.4'\n    id 'io.spring.dependency-management' version '1.0.12.RELEASE'\n    id 'java'\n    id 'eclipse'\n    id &quot;com.diffplug.eclipse.apt&quot; version &quot;3.38.0&quot;\n    id 'jacoco'\n    id 'org.sonarqube' version '3.3'\n}\ngroup = 'com.company.app'\nversion = '1.1.0'\nsourceCompatibility = '17'\n\nconfigurations {\n    compileOnly {\n        extendsFrom annotationProcessor\n    }\n    all {\n        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-logging'\n        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-tomcat'\n        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-websocket'\n        testImplementation.exclude group: 'org.projectlombok', module: 'lombok'\n\n        if (project.hasProperty('runTests')) {\n            testImplementation.exclude group: 'org.springframework.boot', module: 'spring-boot-starter-tomcat'\n        }\n        resolutionStrategy.eachDependency { details -&gt;\n            if (details.requested.group == 'jakarta.servlet') {\n            details.useVersion '5.0.0'\n            }\n        }\n    }\n    \n}\n\nrepositories {\n    mavenCentral()\n}\n\ndependencies {\n    implementation 'org.springframework.boot:spring-boot-starter-actuator'\n    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'\n    implementation 'org.springframework.boot:spring-boot-starter-security'\n    implementation 'org.springframework.boot:spring-boot-starter-web'\n    implementation 'org.springframework.boot:spring-boot-starter-log4j2'\n    implementation 'org.springframework.boot:spring-boot-starter-jetty'\n    implementation 'org.springframework.boot:spring-boot-starter-validation'\n    implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'\n    implementation 'org.springframework.boot:spring-boot-starter-jdbc'\n    // Some other dependency \n    testImplementation 'org.springframework.security:spring-security-test'\n    testImplementation 'org.eclipse.jetty:jetty-server:12.0.0'\n    testImplementation 'jakarta.servlet:jakarta.servlet-api:6.0.0'\n    testImplementation 'com.h2database:h2:1.4.200'\n    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.8.2'\n    testImplementation 'org.springframework.boot:spring-boot-starter-test'\n    testImplementation 'org.mockito:mockito-core:3.12.4'\n    testImplementation 'org.projectlombok:lombok:1.18.28'\n    testImplementation 'org.projectlombok:lombok:1.18.28'\n    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.8.2'\n}\n    \n\n\ntest {\n    useJUnitPlatform()\n}\n\ntasks.withType(JavaCompile) {\n    configure(options) {\n        options.compilerArgs &lt;&lt; '-Xlint:deprecation' &lt;&lt; '-Xlint:unchecked'\n    }\n}\n\njacoco {\n    toolVersion = &quot;0.8.10&quot;\n}\n\ntasks.withType(Test) {\n    jacoco.includeNoLocationClasses = true\n    jacoco.excludes = ['jdk.internal.*']\n}\n\ntest {\n    useJUnitPlatform()\n    finalizedBy jacocoTestReport\n}\n\n\n\n// some other configurations\n</code></pre>\n<p>Here is What I am getting in error :</p>\n<pre><code>java.lang.NoClassDefFoundError: jakarta/servlet/ServletConnection\n    at org.springframework.test.context.web.ServletTestExecutionListener.setUpRequestContextIfNecessary(ServletTestExecutionListener.java:210)\n    at org.springframework.test.context.web.ServletTestExecutionListener.prepareTestInstance(ServletTestExecutionListener.java:130)\n    at org.springframework.test.context.TestContextManager.prepareTestInstance(TestContextManager.java:241)\n    at org.springframework.test.context.junit.jupiter.SpringExtension.postProcessTestInstance(SpringExtension.java:138)\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.lambda$invokeTestInstancePostProcessors$8(ClassBasedTestDescriptor.java:363)\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.executeAndMaskThrowable(ClassBasedTestDescriptor.java:368)\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.lambda$invokeTestInstancePostProcessors$9(ClassBasedTestDescriptor.java:363)\n\n\nCaused by: java.lang.ClassNotFoundException: jakarta.servlet.ServletConnection\n    at java.base/jdk.internal.loader.BuiltinClassLoader.loadClass(BuiltinClassLoader.java:641)\n    at java.base/jdk.internal.loader.ClassLoaders$AppClassLoader.loadClass(ClassLoaders.java:188)\n    at java.base/java.lang.ClassLoader.loadClass(ClassLoader.java:520)\n    ... 85 more\n</code></pre>\n<p>Note : I can't update to servlet 6 with hetty server api as many of my configuration are in use already.</p>\n<p>For More clearity i have added my class and test cases.</p>\n<p>This is User Controller</p>\n<pre><code>import lombok.RequiredArgsConstructor;\nimport lombok.extern.log4j.Log4j2;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Lazy;\nimport org.springframework.http.HttpStatus;\nimport org.springframework.web.bind.annotation.*;\n\nimport jakarta.servlet.http.HttpServletResponse;\nimport jakarta.validation.Valid;\nimport java.io.IOException;\n\n@Log4j2\n@RestController\n@RequestMapping(URLConstants.SIGNUP_URL)\n@RequiredArgsConstructor(onConstructor = @__({ @Autowired, @Lazy }))\n\npublic class UserController {\n\n  private final UserService userService;\n\n  @ResponseStatus(HttpStatus.ACCEPTED)\n  @PostMapping\n  public void userUpdate(@RequestBody @Valid SignupRequest signupRequest,\n      HttpServletResponse response) throws IOException {\n       userServiceUpService.signup(signupRequest, response);\n  }\n\n}\n</code></pre>\n<p>For this I have this test class</p>\n<pre><code>@SpringBootTest(classes = UserController.class)\n@AutoConfigureMockMvc(addFilters = false)\n@ExtendWith(MockitoExtension.class)\npublic final class UserControllerTest {\n\n    @Autowired\n    private MockMvc mockMvc;\n\n    @Mock\n    private UserService userService;\n\n    \n    private final ValidatorFactory factory = Validation.buildDefaultValidatorFactory();\n    private final Validator validator = factory.getValidator();\n\n    @BeforeEach\n    public void setUp() {\n        mockMvc = MockMvcBuilders.standaloneSetup(userController).build();\n    }\n\n    private static final String User_ENDPOINT = &quot;/api/website/user”;\n\n    @Test\n    public void testUserNotAllowed() throws Exception {\n        Mockito.doThrow(new IOException(“User failed&quot;)).when(userService).update(Mockito.any(), Mockito.any());\n\n        String userRequest = MockData.getObjectAsString(User_Failed, UserRequest.class);\n        mockMvc.perform(MockMvcRequestBuilders.post(User_ENDPOINT)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(userRequest))\n                .andExpect(MockMvcResultMatchers.status().isBadRequest())\n                .andReturn();\n    }\n}\n</code></pre>\n<p>As if I am not giving <code>resolutionStrategy.eachDependency </code> test cases are fine but I need <code>resolutionStrategy.eachDependency </code> to run my application. Now In test cases The problem is my test class is going to User controller class and there it is failing with the error.</p>\n<p>Note : I have used this link <a href=\"https://stackoverflow.com/a/75753052/6474292\">https://stackoverflow.com/a/75753052/6474292</a> where it is workling fine both applciation and test but this is wrong as per the doc <a href=\"https://eclipse.dev/jetty/\" rel=\"nofollow noreferrer\">https://eclipse.dev/jetty/</a></p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}