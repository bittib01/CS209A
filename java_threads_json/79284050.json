{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-boot",
      "google-secret-manager"
    ],
    "owner": {
      "account_id": 24670724,
      "reputation": 31,
      "user_id": 18565775,
      "user_type": "registered",
      "profile_image": "https://lh3.googleusercontent.com/a-/AOh14GiNWqPPP9CaJ6iWQM4EXPMzTD3d8HWDSBzH23JN1w=k-s256",
      "display_name": "Raichu",
      "link": "https://stackoverflow.com/users/18565775/raichu"
    },
    "is_answered": true,
    "view_count": 1047,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1749750536,
    "creation_date": 1734337902,
    "question_id": 79284050,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79284050/spring-boot-upgrade-to-version-3-4-0-make-gcp-secretmanager-not-work",
    "title": "Spring-Boot upgrade to version 3.4.0 make gcp secretmanager NOT work",
    "body": "<h2>Background</h2>\n<blockquote>\n<p>Let's start to upgrade Spring-Boot from <code>3.3.6</code> to <code>3.4.0</code>.</p>\n</blockquote>\n<h3>build.gradle</h3>\n<pre><code>//build.gradle\n//old\nplugins {\n    id 'java'\n    id 'org.springframework.boot' version '3.3.6'\n    id 'io.spring.dependency-management' version '1.1.6'\n    id 'org.sonarqube' version '5.1.0.4882'\n    id 'jacoco'\n    id 'com.gorylenko.gradle-git-properties' version '2.4.2'\n    id 'project-report'\n}\next {\n    set('springCloudGcpVersion', &quot;5.8.0&quot;)\n    set('springCloudVersion', &quot;2023.0.4&quot;)\n}\ndependencies {\n    implementation platform('com.google.cloud:spring-cloud-gcp-dependencies:5.8.0')\n    implementation platform('org.springframework.cloud:spring-cloud-dependencies:2023.0.4')\n    implementation 'org.springframework.boot:spring-boot-starter'\n    implementation 'org.springframework.boot:spring-boot-starter-web'\n    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'\n    implementation 'org.springframework.boot:spring-boot-starter-validation'\n    implementation 'org.springframework.cloud:spring-cloud-starter-openfeign'\n    implementation 'org.bouncycastle:bcprov-jdk18on:1.79'\n    implementation 'org.springframework.boot:spring-boot-starter-actuator'\n    implementation 'com.google.cloud:spring-cloud-gcp-starter-secretmanager'\n    implementation 'com.google.cloud:spring-cloud-gcp-starter-storage'\n    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.6.0'\n    implementation 'org.apache.commons:commons-collections4:4.4'\n    implementation 'org.mapstruct:mapstruct:1.6.3'\n    annotationProcessor 'org.mapstruct:mapstruct-processor:1.6.3'\n    annotationProcessor 'org.projectlombok:lombok-mapstruct-binding:0.2.0'\n    annotationProcessor 'org.projectlombok:lombok'\n    compileOnly 'org.projectlombok:lombok'\n    runtimeOnly 'org.postgresql:postgresql'\n}\n\ndependencyManagement {\n    imports {\n        mavenBom &quot;com.google.cloud:spring-cloud-gcp-dependencies:${springCloudGcpVersion}&quot;\n        mavenBom &quot;org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}&quot;\n    }\n}\n</code></pre>\n<pre><code>//build.gradle\n//new\nplugins {\n    id 'java'\n    id 'org.springframework.boot' version '3.4.0'\n    id 'io.spring.dependency-management' version '1.1.6'\n    id 'org.sonarqube' version '5.1.0.4882'\n    id 'jacoco'\n    id 'com.gorylenko.gradle-git-properties' version '2.4.2'\n    id 'project-report'\n}\next {\n    set('springCloudGcpVersion', &quot;5.9.0&quot;)\n    set('springCloudVersion', &quot;2024.0.0&quot;)\n}\ndependencies {\n    implementation platform('com.google.cloud:spring-cloud-gcp-dependencies:5.9.0')\n    implementation platform('org.springframework.cloud:spring-cloud-dependencies:2024.0.0')\n    implementation 'org.springframework.boot:spring-boot-starter'\n    implementation 'org.springframework.boot:spring-boot-starter-web'\n    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'\n    implementation 'org.springframework.boot:spring-boot-starter-validation'\n    implementation 'org.springframework.cloud:spring-cloud-starter-bootstrap'\n    implementation 'org.springframework.cloud:spring-cloud-starter-openfeign'\n    implementation 'org.bouncycastle:bcprov-jdk18on:1.79'\n    implementation 'org.springframework.boot:spring-boot-starter-actuator'\n    implementation 'com.google.cloud:spring-cloud-gcp-starter-secretmanager'\n    implementation 'com.google.cloud:spring-cloud-gcp-starter-storage'\n    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.7.0'\n    implementation 'org.apache.commons:commons-collections4:4.4'\n    implementation 'org.mapstruct:mapstruct:1.6.3'\n    annotationProcessor 'org.mapstruct:mapstruct-processor:1.6.3'\n    annotationProcessor 'org.projectlombok:lombok-mapstruct-binding:0.2.0'\n    annotationProcessor 'org.projectlombok:lombok'\n    compileOnly 'org.projectlombok:lombok'\n    runtimeOnly 'org.postgresql:postgresql'\n}\n\ndependencyManagement {\n    imports {\n        mavenBom &quot;com.google.cloud:spring-cloud-gcp-dependencies:${springCloudGcpVersion}&quot;\n        mavenBom &quot;org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}&quot;\n    }\n}\n</code></pre>\n<h3>lib version</h3>\n<ul>\n<li>org.springframework.boot: 3.3.6 -&gt; 3.4.0</li>\n<li>com.google.cloud:spring-cloud-gcp-dependencie: 5.8.0 -&gt; 5.9.0</li>\n<li>org.springframework.cloud:spring-cloud-dependencies: 2023.0.4 -&gt; 2024.0.0</li>\n<li>org.springdoc:springdoc-openapi-starter-webmvc-ui: 2.6.0 -&gt; 2.7.0</li>\n</ul>\n<h2>Problem</h2>\n<blockquote>\n<p>Now, datasource connect failed because using <code>secretmanager</code> to register db connection infomation.</p>\n</blockquote>\n<h3>Problem detail and test</h3>\n<pre class=\"lang-yaml prettyprint-override\"><code># application.yml\nspring:\n  config:\n    import: &quot;sm://&quot;\n  datasource:\n    url: jdbc:postgresql://localhost:5432/cehr?currentSchema=XXXX\n    username: ${sm://psql-username}\n    password: ${sm://psql-password}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@Service\npublic class XXXService extends CommonService {\n\n    @Autowired\n    private SecretManagerTemplate secretManagerTemplate;\n\n    @Value(&quot;${spring.datasource.username}&quot;)\n    private String username;\n\n    @Value(&quot;${spring.datasource.password}&quot;)\n    private String password;\n\n    @Value(&quot;${sm://psql-username}&quot;)\n    private String username2;\n\n    @Value(&quot;${sm://psql-password}&quot;)\n    private String password2;\n\n    public void execute() {\n\n        System.out.println(&quot;username = &quot; + username);\n        System.out.println(&quot;password = &quot; + password);\n\n        System.out.println(&quot;username2 = &quot; + username2);\n        System.out.println(&quot;password2 = &quot; + password2);\n\n        System.out.println(&quot;psql-username = &quot; + secretManagerTemplate.getSecretString(&quot;sm://psql-username&quot;));\n        System.out.println(&quot;psql-password = &quot; + secretManagerTemplate.getSecretString(&quot;sm://psql-password&quot;));\n    }\n}\n</code></pre>\n<pre><code># output\nusername = //psql-username\npassword = //psql-password\nusername2 = //psql-username\npassword2 = //psql-password\npsql-username = ********** (correct)\npsql-password = ********** (correct)\n</code></pre>\n<h3>Problem analysis</h3>\n<ul>\n<li><code>secretmanager</code> work by using <code>SecretManagerTemplate</code></li>\n<li><code>secretmanager</code> DO NOT work by using <code>application.yml</code></li>\n</ul>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}