{
  "question": {
    "tags": [
      "java",
      "mysql",
      "spring",
      "kotlin",
      "hikaricp"
    ],
    "owner": {
      "account_id": 40249959,
      "reputation": 1,
      "user_id": 29684546,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/10626165bfaf2dad240e7abfe1e3ada4?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Ilja Booij",
      "link": "https://stackoverflow.com/users/29684546/ilja-booij"
    },
    "is_answered": false,
    "view_count": 535,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1740067036,
    "creation_date": 1739962396,
    "last_edit_date": 1740067036,
    "question_id": 79451073,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79451073/getting-exception-not-a-navigable-resultset-from-jdbctemplate-query-against-a",
    "title": "Getting exception &quot;Not a navigable ResultSet&quot; from JDBCTemplate query against a MySQL database in Spring Boot application",
    "body": "<p>We have a Spring Boot application, written in Kotlin, which runs in a container on Digital Ocean App Platform.</p>\n<p>Versions:</p>\n<ul>\n<li>MySQL 8.0.30</li>\n<li>Kotlin 2.0.20</li>\n<li>Spring Boot 3.4.2</li>\n<li>HikariCP 3.4.5</li>\n<li>MySQL Connector/J 9.1.0</li>\n</ul>\n<p>At, seemingly random, times, we're getting errors from our select queries that indicate that the result set was &quot;Not a navigable ResultSet&quot;.</p>\n<pre><code>2025-02-18T14:37:44.866 [join-backend-v3-prod-85f5d9c488-scsgt] [http-nio-0.0.0.0-8080-exec-5] ERROR o.a.c.c.C.[.[.[.[dispatcherServlet] - [] - Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception\norg.springframework.dao.TransientDataAccessResourceException: PreparedStatementCallback; SQL [select \n    u.uid,\n    first_name,\n    last_name,\n    email,\n    ss.end_datetime is not null and ss.end_datetime &gt; current_timestamp() as subscription_active,\n    locale,\n    time_zone,\n    is_admin,\n    exists(select uid from blacklisted_users where blacklisted_users.uid = u.uid) as is_blacklisted\nfrom users u\nleft join subscription_summaries ss on u.uid = ss.uid\nwhere u.uid = ?\nand auth_token = ?]; Not a navigable ResultSet.\n    at org.springframework.jdbc.support.SQLStateSQLExceptionTranslator.doTranslate(SQLStateSQLExceptionTranslator.java:124)\n    at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:107)\n    at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:116)\n    at org.springframework.jdbc.core.JdbcTemplate.translateException(JdbcTemplate.java:1556)\n    at org.springframework.jdbc.core.JdbcTemplate.execute(JdbcTemplate.java:677)\n    at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:723)\n    at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:748)\n    at org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate.query(NamedParameterJdbcTemplate.java:178)\n    at org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate.query(NamedParameterJdbcTemplate.java:186)\n    at cc.join.backend.repositories.SpringUserRepository.fetchPrincipalByIdAndAuthToken(SpringUserRepository.kt:38)\n    at cc.join.backend.spring.JoinAuthenticationProvider.retrieveUser(JoinAuthenticationProvider.kt:28)\n    at org.springframework.security.authentication.dao.AbstractUserDetailsAuthenticationProvider.authenticate(AbstractUserDetailsAuthenticationProvider.java:133)\n    at org.springframework.security.authentication.ProviderManager.authenticate(ProviderManager.java:182)\n    at cc.join.backend.spring.JoinAuthenticationTokenFilter.doFilterInternal(JoinAuthenticationTokenFilter.kt:56)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)\n    at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)\n    at cc.join.backend.spring.JoinInternalJwtFilter.doFilterInternal(JoinInternalJwtFilter.kt:59)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)\n    at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)\n    at cc.join.backend.spring.ActuatorApiKeyFilter.doFilterInternal(ActuatorApiKeyFilter.kt:41)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)\n    at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)\n    at org.springframework.web.filter.CorsFilter.doFilterInternal(CorsFilter.java:91)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)\n    at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)\n    at org.springframework.security.web.header.HeaderWriterFilter.doHeadersAfter(HeaderWriterFilter.java:90)\n    at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:75)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)\n    at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)\n    at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)\n    at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)\n    at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)\n    at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:62)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:227)\n    at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)\n    at org.springframework.security.web.session.DisableEncodeUrlFilter.doFilterInternal(DisableEncodeUrlFilter.java:42)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)\n    at org.springframework.security.web.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$0(ObservationFilterChainDecorator.java:323)\n    at org.springframework.security.web.ObservationFilterChainDecorator$ObservationFilter.doFilter(ObservationFilterChainDecorator.java:224)\n    at org.springframework.security.web.ObservationFilterChainDecorator$VirtualFilterChain.doFilter(ObservationFilterChainDecorator.java:137)\n    at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)\n    at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)\n    at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:113)\n    at org.springframework.web.servlet.handler.HandlerMappingIntrospector.lambda$createCacheFilter$3(HandlerMappingIntrospector.java:243)\n    at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:113)\n    at org.springframework.web.filter.CompositeFilter.doFilter(CompositeFilter.java:74)\n    at org.springframework.security.config.annotation.web.configuration.WebMvcSecurityConfiguration$CompositeFilterChainProxy.doFilter(WebMvcSecurityConfiguration.java:238)\n    at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:362)\n    at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:278)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.zalando.logbook.servlet.LogbookFilter.doFilter(LogbookFilter.java:76)\n    at org.zalando.logbook.servlet.SecureLogbookFilter.doFilter(SecureLogbookFilter.java:32)\n    at org.zalando.logbook.servlet.HttpFilter.doFilter(HttpFilter.java:32)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.springframework.web.filter.ServerHttpObservationFilter.doFilterInternal(ServerHttpObservationFilter.java:114)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:167)\n    at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:90)\n    at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:483)\n    at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:115)\n    at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93)\n    at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)\n    at org.apache.catalina.valves.RemoteIpValve.invoke(RemoteIpValve.java:731)\n    at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:344)\n    at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:397)\n    at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63)\n    at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:905)\n    at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1741)\n    at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)\n    at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1190)\n    at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)\n    at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)\n    at java.base/java.lang.Thread.run(Unknown Source)\nCaused by: java.sql.SQLException: Not a navigable ResultSet.\n    at com.mysql.cj.jdbc.exceptions.SQLError.createSQLException(SQLError.java:121)\n    at com.mysql.cj.jdbc.exceptions.SQLError.createSQLException(SQLError.java:89)\n    at com.mysql.cj.jdbc.exceptions.SQLError.createSQLException(SQLError.java:81)\n    at com.mysql.cj.jdbc.exceptions.SQLError.createSQLException(SQLError.java:55)\n    at com.mysql.cj.jdbc.result.ResultSetImpl.next(ResultSetImpl.java:1807)\n    at com.zaxxer.hikari.pool.HikariProxyResultSet.next(HikariProxyResultSet.java)\n    at cc.join.backend.repositories.SpringUserRepository.joinPrincipalResultSetExtractor$lambda$3(SpringUserRepository.kt:64)\n    at org.springframework.jdbc.core.JdbcTemplate$1.doInPreparedStatement(JdbcTemplate.java:733)\n    at org.springframework.jdbc.core.JdbcTemplate.execute(JdbcTemplate.java:658)\n    ... 99 common frames omitted\n</code></pre>\n<p>The code that executes the query is:</p>\n<pre><code>import java.time.DateTimeException\nimport java.time.ZoneId\nimport java.time.zone.ZoneRulesException\nimport java.util.Locale\nimport javax.sql.DataSource\n\n@Repository\nclass SpringUserRepository(dataSource: DataSource) {\n    private val jdbcTemplate = NamedParameterJdbcTemplate(dataSource)\n\n    /** Fetch a user with the given userId and token exists in the database. If no user with\n     * the provided [userId] and [token] is found, returns null. */\n    fun fetchPrincipalByIdAndAuthToken(userId: Long, token: String): JoinPrincipal? {\n        val sql = &quot;&quot;&quot;\n            select \n                u.uid,\n                first_name,\n                last_name,\n                email,\n                ss.end_datetime is not null and ss.end_datetime &gt; current_timestamp() as subscription_active,\n                locale,\n                time_zone,\n                is_admin,\n                exists(select uid from blacklisted_users where blacklisted_users.uid = u.uid) as is_blacklisted\n            from users u\n            left join subscription_summaries ss on u.uid = ss.uid\n            where u.uid = :uid\n            and auth_token = :authToken\n        &quot;&quot;&quot;.trimIndent()\n        return jdbcTemplate.query(sql, mapOf(&quot;uid&quot; to userId, &quot;authToken&quot; to token), joinPrincipalResultSetExtractor)\n    }\n    \n    private val joinPrincipalResultSetExtractor: ResultSetExtractor&lt;JoinPrincipal&gt; = ResultSetExtractor { resultSet -&gt;\n        if (resultSet.next()) {\n            val isBlacklisted = resultSet.getBoolean(&quot;is_blacklisted&quot;)\n\n            val timeZone: ZoneId = resultSet.getString(&quot;time_zone&quot;)\n                ?.takeIf { it.isNotBlank() }\n                ?.let {\n                    try {\n                        ZoneId.of(it)\n                    } catch (zoneRulesException: ZoneRulesException) {\n                        null\n                    } catch (dateTimeException: DateTimeException) {\n                        null\n                    }\n                }\n                ?: StaticSettings.DEFAULT_ZONE_ID\n\n            JoinPrincipal(\n                id = resultSet.getLong(&quot;uid&quot;),\n                firstName = resultSet.getString(&quot;first_name&quot;),\n                locale = Locale.of(resultSet.getString(&quot;locale&quot;).ifEmpty { &quot;en&quot; }),\n                timeZone = timeZone,\n                isSubscriptionActive = !isBlacklisted &amp;&amp; resultSet.getBoolean(&quot;subscription_active&quot;),\n                isAdmin = resultSet.getBoolean(&quot;is_admin&quot;),\n                isBlacklisted = isBlacklisted,\n            )\n        } else {\n            null\n        }\n    }\n}\n</code></pre>\n<p>This query could result in zero rows returned, but, as it's a select query, <code>ResultSet.next()</code> should still work, returning false.\nWe see the same thing with other queries that potentially return 0 rows.\nWe have multiple tests for this (running against a MySQL database in a testcontainer), which also check for the <code>null</code> case</p>\n<pre><code>@Test\ninternal fun `test fetch by auth token for unknown user`() {\n    val principal = springUserRepository.fetchPrincipalByIdAndAuthToken(\n        userId = 90210,\n        token = &quot;auth&quot;,\n    )\n    assertThat(principal).isNull()\n}\n</code></pre>\n<p>Datasource configuration:</p>\n<pre><code>spring.datasource:\n    # Our database contains zero dates and datetimes unfortunately, so we have the JDBC driver convert these to NULLs.\n    url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:join}?zeroDateTimeBehavior=convertToNull&amp;rewriteBatchedStatements=true&amp;serverTimezone=UTC&amp;auto\n    username: ${DB_USER}\n    password: ${DB_PASSWORD}\n    hikari:\n      data-source-properties:\n        # The MySQL JDBC driver does not set a socket timeout by default. When the connection to the database gets\n        # severed without a normal TCP shutdown, this can result in database connections and not being available\n        # for the application.\n        # See https://github.com/brettwooldridge/HikariCP/wiki/Rapid-Recover for more information.\n        socketTimeout: 30000\n\n      # See https://github.com/brettwooldridge/HikariCP for documentation about the following properties:\n\n      # Maximum amount of time that a connection will be tested for aliveness. This value must be less than the\n      # connection-timeout.\n      validation-timeout: 4_000\n      # when creating a new database connection, fail after 5 seconds when no connection can be established. If it\n      # takes longer than this, chances are that high that it will be impossible to get a connection.\n      connection-timeout: 5_000\n      # Regularly check database connections for aliveness. This prevents database code from being handed a connection\n      # that has been severed.\n      keepalive-time: 60_000\n      # maximum nr of connections. We're not setting 'minimum-idle', so this will be a fixed-size pool.\n      maximum-pool-size: 25\n      # Whenever a connection is not returned to the pool within 10 seconds, mark it as having been leaked. = 10_000\n      leak-detection-threshold: 10_000\n</code></pre>\n<p>The weird thing is that most of the time, things work perfectly. It seems rather random, and what does not help is that we cannot find any similar issues on Google nor this site.</p>\n<p>Because we had seen the same error on our development environment, we have tried to trigger the error by performing a load test on the development environment. Unfortunately, this did not trigger the error.</p>\n<p>We're in contact with Digital Ocean support. They indicate not having seen any database or network errors around the times that the problem occurred.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}