{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-boot",
      "openai-api",
      "spring-ai"
    ],
    "owner": {
      "account_id": 8781643,
      "reputation": 27176,
      "user_id": 6565093,
      "user_type": "registered",
      "accept_rate": 47,
      "profile_image": "https://i.sstatic.net/ar2Cp.jpg?s=256",
      "display_name": "pvpkiran",
      "link": "https://stackoverflow.com/users/6565093/pvpkiran"
    },
    "is_answered": true,
    "view_count": 3827,
    "answer_count": 3,
    "score": 0,
    "last_activity_date": 1718661894,
    "creation_date": 1709815905,
    "last_edit_date": 1709827261,
    "question_id": 78121525,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78121525/spring-ai-openai-error-extracting-response-of-type-openaiapiembeddinglist",
    "title": "Spring AI - openAi Error extracting response of type OpenAiApi$EmbeddingList&lt;......OpenAiApi$Embedding&gt;",
    "body": "<p>I am trying my hands on spring ai. I am trying to read a pdf and save the data into a vector store. Then I am calling aiclient to respond to prompts. This is what it looks like</p>\n<pre><code>@Component\nclass Chatbot {\n    \n    private final String template = &quot;&quot;&quot;\n                        \n            You're assisting with questions about a given pdf\n                    \n            Use the information from the DOCUMENTS section to provide accurate answers but act as if you knew this information innately.\n            If unsure, simply state that you don't know.\n                    \n            DOCUMENTS:\n            {documents}\n                        \n            &quot;&quot;&quot;;\n    private final ChatClient aiClient;\n    private final VectorStore vectorStore;\n\n    Chatbot(ChatClient aiClient, VectorStore vectorStore) {\n        this.aiClient = aiClient;\n        this.vectorStore = vectorStore;\n    }\n\n    public String chat(String message) {\n        var listOfSimilarDocuments = this.vectorStore.similaritySearch(message);\n        var documents = listOfSimilarDocuments\n                .stream()\n                .map(Document::getContent)\n                .collect(Collectors.joining(System.lineSeparator()));\n        var systemMessage = new SystemPromptTemplate(this.template)\n                .createMessage(Map.of(&quot;documents&quot;, documents));\n        var userMessage = new UserMessage(message);\n        var prompt = new Prompt(List.of(systemMessage, userMessage));\n        var aiResponse = aiClient.call(prompt);\n        return aiResponse.getResult().getOutput().getContent();\n    }\n} \n</code></pre>\n<p>I have a api key setup on openAi.</p>\n<p>When I start my application, I see that even before the above piece of code is called, a rest call is made to openai which is resulting in the following error</p>\n<pre><code>org.springframework.web.client.RestClientException: Error while extracting response for type [org.springframework.ai.openai.api.OpenAiApi$EmbeddingList&lt;org.springframework.ai.openai.api.OpenAiApi$Embedding&gt;] and content type [application/json;charset=utf-8]\n    at org.springframework.web.client.DefaultRestClient.readWithMessageConverters(DefaultRestClient.java:231) ~[spring-web-6.1.2.jar:6.1.2]\n    at org.springframework.web.client.DefaultRestClient$DefaultResponseSpec.readBody(DefaultRestClient.java:659) ~[spring-web-6.1.2.jar:6.1.2]\n    at org.springframework.web.client.DefaultRestClient$DefaultResponseSpec.toEntityInternal(DefaultRestClient.java:629) ~[spring-web-6.1.2.jar:6.1.2]\n    at org.springframework.web.client.DefaultRestClient$DefaultResponseSpec.toEntity(DefaultRestClient.java:625) ~[spring-web-6.1.2.jar:6.1.2]\n    at org.springframework.ai.openai.api.OpenAiApi.embeddings(OpenAiApi.java:795) ~[spring-ai-openai-0.8.0-20240223.153858-200.jar:0.8.0-SNAPSHOT]\n    at org.springframework.ai.openai.OpenAiEmbeddingClient.lambda$call$1(OpenAiEmbeddingClient.java:114) ~[spring-ai-openai-0.8.0-20240223.153858-200.jar:0.8.0-SNAPSHOT]\n    at org.springframework.retry.support.RetryTemplate.doExecute(RetryTemplate.java:335) ~[spring-retry-2.0.5.jar:na]\n    at org.springframework.retry.support.RetryTemplate.execute(RetryTemplate.java:211) ~[spring-retry-2.0.5.jar:na]\n    at org.springframework.ai.openai.OpenAiEmbeddingClient.call(OpenAiEmbeddingClient.java:100) ~[spring-ai-openai-0.8.0-20240223.153858-200.jar:0.8.0-SNAPSHOT]\n    at org.springframework.ai.embedding.EmbeddingClient.embed(EmbeddingClient.java:56) ~[spring-ai-core-0.8.0-20240223.153858-209.jar:0.8.0-SNAPSHOT]\n    at org.springframework.ai.embedding.EmbeddingClient.embed(EmbeddingClient.java:39) ~[spring-ai-core-0.8.0-20240223.153858-209.jar:0.8.0-SNAPSHOT]\n    at org.springframework.ai.embedding.AbstractEmbeddingClient.dimensions(AbstractEmbeddingClient.java:57) ~[spring-ai-core-0.8.0-20240223.153858-209.jar:0.8.0-SNAPSHOT]\n    at org.springframework.ai.embedding.AbstractEmbeddingClient.dimensions(AbstractEmbeddingClient.java:79) ~[spring-ai-core-0.8.0-20240223.153858-209.jar:0.8.0-SNAPSHOT]\n    at org.springframework.ai.vectorstore.PgVectorStore.embeddingDimensions(PgVectorStore.java:363) ~[spring-ai-pgvector-store-0.8.0-20240223.153858-191.jar:0.8.0-SNAPSHOT]\n    at org.springframework.ai.vectorstore.PgVectorStore.afterPropertiesSet(PgVectorStore.java:347) ~[spring-ai-pgvector-store-0.8.0-20240223.153858-191.jar:0.8.0-SNAPSHOT]\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1820) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1769) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:599) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:521) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:325) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:234) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:323) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:199) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.config.DependencyDescriptor.resolveCandidate(DependencyDescriptor.java:254) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.DefaultListableBeanFactory.doResolveDependency(DefaultListableBeanFactory.java:1443) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.DefaultListableBeanFactory.resolveDependency(DefaultListableBeanFactory.java:1353) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.ConstructorResolver.resolveAutowiredArgument(ConstructorResolver.java:911) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.ConstructorResolver.createArgumentArray(ConstructorResolver.java:789) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.ConstructorResolver.autowireConstructor(ConstructorResolver.java:241) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.autowireConstructor(AbstractAutowireCapableBeanFactory.java:1354) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:1191) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:561) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:521) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:325) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:234) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:323) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:199) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:975) ~[spring-beans-6.1.2.jar:6.1.2]\n    at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:960) ~[spring-context-6.1.2.jar:6.1.2]\n    at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:625) ~[spring-context-6.1.2.jar:6.1.2]\n    at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:146) ~[spring-boot-3.2.1.jar:3.2.1]\n    at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:762) ~[spring-boot-3.2.1.jar:3.2.1]\n    at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:464) ~[spring-boot-3.2.1.jar:3.2.1]\n    at org.springframework.boot.SpringApplication.run(SpringApplication.java:334) ~[spring-boot-3.2.1.jar:3.2.1]\n    at org.springframework.boot.SpringApplication.run(SpringApplication.java:1358) ~[spring-boot-3.2.1.jar:3.2.1]\n    at org.springframework.boot.SpringApplication.run(SpringApplication.java:1347) ~[spring-boot-3.2.1.jar:3.2.1]\n    at bootiful.service.ServiceApplication.main(ServiceApplication.java:33) ~[classes/:na]\nCaused by: java.net.HttpRetryException: cannot retry due to server authentication, in streaming mode\n    at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1796) ~[na:na]\n    at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1599) ~[na:na]\n    at java.base/sun.net.www.protocol.http.HttpURLConnection.getHeaderFieldKey(HttpURLConnection.java:3288) ~[na:na]\n    at java.base/sun.net.www.protocol.https.HttpsURLConnectionImpl.getHeaderFieldKey(HttpsURLConnectionImpl.java:276) ~[na:na]\n    at org.springframework.http.client.SimpleClientHttpResponse.getHeaders(SimpleClientHttpResponse.java:69) ~[spring-web-6.1.2.jar:6.1.2]\n    at org.springframework.web.client.DefaultRestClient$DefaultConvertibleClientHttpResponse.getHeaders(DefaultRestClient.java:715) ~[spring-web-6.1.2.jar:6.1.2]\n    at org.springframework.web.client.DefaultRestClient.getContentType(DefaultRestClient.java:236) ~[spring-web-6.1.2.jar:6.1.2]\n    at org.springframework.web.client.DefaultRestClient.readWithMessageConverters(DefaultRestClient.java:192) ~[spring-web-6.1.2.jar:6.1.2]\n    ... 46 common frames omitted\n</code></pre>\n<p>I am not sure why is this happening or how to fix this. Any help is much appreciated.</p>\n<p>When I tried debugging, I see that <code>OpenAiEmbeddingClient::call</code> method is called where a Hello World request is sent with model <code>text-embedding-ada-002</code>. This call is failing</p>\n<pre><code>EmbeddingList&lt;OpenAiApi.Embedding&gt; apiEmbeddingResponse = this.openAiApi.embeddings(apiRequest).getBody();\n</code></pre>\n<p>I have the following dependencies in the pom.</p>\n<pre><code>   &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-ai-openai-spring-boot-starter&lt;/artifactId&gt;\n        &lt;version&gt;${spring-ai.version}&lt;/version&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-ai-pdf-document-reader&lt;/artifactId&gt;\n        &lt;version&gt;${spring-ai.version}&lt;/version&gt;\n    &lt;/dependency&gt;\n\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-ai-pgvector-store-spring-boot-starter&lt;/artifactId&gt;\n        &lt;version&gt;${spring-ai.version}&lt;/version&gt;\n    &lt;/dependency&gt;\n\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.retry&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-retry&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-aspects&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}