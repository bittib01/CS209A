{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-boot",
      "integration-testing",
      "mockwebserver"
    ],
    "owner": {
      "account_id": 17625363,
      "reputation": 29,
      "user_id": 12790511,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/91658d6e06335bd77f4b9b22bdc2b4cb?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Fuzhyon",
      "link": "https://stackoverflow.com/users/12790511/fuzhyon"
    },
    "is_answered": false,
    "view_count": 330,
    "answer_count": 1,
    "score": -1,
    "last_activity_date": 1717515712,
    "creation_date": 1715674425,
    "last_edit_date": 1717515712,
    "question_id": 78476672,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78476672/how-to-use-beforeeach-and-aftereach-annotations-with-mockwebserver",
    "title": "How to use @BeforeEach and @AfterEach annotations with MockWebServer?",
    "body": "<p>Doing integration tests, I'm trying to mock the comportement of my controller with one or multiple MockWebServer but doesn't found a solution.</p>\n<p>I saw the post <a href=\"https://github.com/square/okhttp/issues/6906\" rel=\"nofollow noreferrer\">here</a> saying that a MockWebServer should only be for a single use.</p>\n<p>So I tried a way to use it with @BeforeEach and @AfterEach annotations without success.</p>\n<p>I tried this:</p>\n<pre><code>@SpringBootTest(\n        classes = {\n                MyApplication.class,\n        },\n        properties = {\n                &quot;api.url=TEST&quot;,\n                // ... other properties ...\n    })\n@AutoConfigureMockMvc\nclass MyControllerTest {\n\n    private static MockWebServer serverApiA;\n    private static MockWebServer serverApiB;\n    private static MockWebServer serverApiC;\n    private static MockWebServer serverApiD;\n\n    // ... Beans and repos declared here ....\n\n    @BeforeEach\n    public void mockHeadersAndStartMockWebServer() throws CustomException, IOException {\n        doReturn(new HttpHeaders()).when(SomeServiceImplMock).getHeaders();\n\n        serverApiA = new MockWebServer();\n        serverApiA.start();\n\n        HttpUrl httpUrlApiA = serverApiA.url(&quot;/operation-a/v1&quot;);\n        String urlApiA = httpUrlApiA.url().toString();\n        System.setProperty(&quot;my-project.api.path.url&quot;, urlApiA);\n    }\n\n    @AfterEach\n    void cleanData() throws IOException {\n        repositoryA.deleteAll();\n        repositoryB.deleteAll();\n        repositoryC.deleteAll();\n        repositoryD.deleteAll();\n\n        serverApiA.shutdown();\n    }\n\n@WithMockUser(value = &quot;somevalue&quot;, authorities = &quot;some-authorities&quot;)\n@Test\nvoid whenCallControllerMethod_withSpecificCase_thenReturnResponseOKAndStatusKO() throws Exception {\n\n        // Given\n        // ... Some code to initialise my test ...\n\n        MockResponse mockResponse = getMockResponseApiA(HttpStatus.OK, SomeEnum.VALUE);\n\n        // Mock\n        serverApiA.enqueue(mockResponse);\n\n        // When\n        MockHttpServletRequestBuilder request = MockMvcRequestBuilders.post(&quot;/specific/operation&quot;)\n            .contentType(MediaType.APPLICATION_JSON)\n            .content(createRequestBody());\n\n        MvcResult mvcResult = mockMvc.perform(request)\n            .andReturn();\n\n        // Then\n        MockHttpServletResponse response = mvcResult.getResponse();\n        assertThat(response.getStatus()).isEqualTo(HttpStatus.OK.value());\n} \n\n</code></pre>\n<p>But I got this Error = java.lang.IllegalArgumentException: [TEST//operation-a/v1] is not a valid HTTP URL.</p>\n<p>I also tried the following solutions:</p>\n<ul>\n<li>Using dispatcher instead of enqueue, but I couldn't specify multiple &quot;System.setProperty&quot;.</li>\n<li>Using @BeforeAll and @AfterAll at first like this:</li>\n</ul>\n<pre><code>@BeforeEach\npublic void mockHeaders(){\n    doReturn(new HttpHeaders()).when(SomeServiceImplMock).getHeaders();\n}\n\n@BeforeAll\npublic void startMockWebServer() throws CustomException, IOException {\n    serverApiA = new MockWebServer();\n    serverApiB = new MockWebServer();\n    serverApiC = new MockWebServer();\n    serverApiD = new MockWebServer();\n    \n    serverApiA.start();\n    serverApiB.start();\n    serverApiC.start();\n    serverApiD.start();\n    \n    HttpUrl httpUrlApiA = serverApiA.url(&quot;/operation-a/v1&quot;);\n    String urlApiA = httpUrlApiA.url().toString();\n    System.setProperty(&quot;my-project.api.pathA.url&quot;, urlApiA);\n    \n    HttpUrl httpUrlApiB = serverApiB.url(&quot;/operation-b/v1&quot;);\n    String urlApiB = httpUrlApiB.url().toString();\n    System.setProperty(&quot;my-project.api.pathB.url&quot;, urlApiB);\n    \n    HttpUrl httpUrlApiC = serverApiC.url(&quot;/operation-c/v1&quot;);\n    String urlApiC = httpUrlApiC.url().toString();\n    System.setProperty(&quot;my-project.api.pathC.url&quot;, urlApiC);\n    \n    HttpUrl httpUrlApiD = serverApiD.url(&quot;/operation-d/v1&quot;);\n    String urlApiD = httpUrlApiD.url().toString();\n    System.setProperty(&quot;my-project.api.pathD.url&quot;, urlApiD);\n}\n\n@AfterAll\nvoid cleanData() throws IOException {\n    repositoryA.deleteAll();\n    repositoryB.deleteAll();\n    repositoryC.deleteAll();\n    repositoryD.deleteAll();\n\n    serverApiA.shutdown();\n    serverApiB.shutdown();\n    serverApiC.shutdown();\n    serverApiD.shutdown();\n}\n</code></pre>\n<p>It does worked, but I had to be very carefull of which test to do first. serverApiA.enqueue() is the same stack as serverApiB, serverApiC and serverApiD.</p>\n<p>Results where sometimes randoms, different if I launch them in debug or not.</p>\n<p><strong>EDIT:</strong>\nI also have issues while debugging.\nIf I wait too much in the debugger, some tests run in loops.\nIf I pass them quickly, they sometimes pass, and sometimes doesn't.</p>\n<p>The best solution I have in mind for now is to do each &quot;buggy&quot; test, in his own file. But it's not a good way to do it.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}