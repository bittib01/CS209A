{
  "question": {
    "tags": [
      "python",
      "java",
      "amazon-bedrock"
    ],
    "owner": {
      "account_id": 39503626,
      "reputation": 1,
      "user_id": 29308505,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/f6209d9fed2fa8f856b5adee327397b7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Mitesh Suthar",
      "link": "https://stackoverflow.com/users/29308505/mitesh-suthar"
    },
    "is_answered": false,
    "view_count": 73,
    "answer_count": 0,
    "score": 0,
    "last_activity_date": 1739268141,
    "creation_date": 1737552363,
    "last_edit_date": 1739268141,
    "question_id": 79377878,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79377878/signature-not-matched-error-occured-while-calling-bedrock-api-using-java-code-wi",
    "title": "Signature not matched error occured while calling bedrock api using java code with sdk",
    "body": "<p>I'm trying to invoke the AWS Bedrock API using Java without using the AWS SDK. However, I keep getting a 403 Forbidden error with the message &quot;Signature mismatch.&quot; The same request works perfectly in Python.</p>\n<p>Below is my Java code:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Service\npublic class AnthropicServiceImpl {\n\n    private static final String AWS_ACCESS_KEY_ID = &quot;accesskeyid&quot;;\n    private static final String AWS_SECRET_ACCESS_KEY = &quot;secretkey&quot;;\n\n    private static final String METHOD = &quot;POST&quot;;\n    private static final String SERVICE = &quot;bedrock&quot;;\n    private static final String REGION = &quot;us-east-1&quot;;\n    private static final String ALGORITHM = &quot;AWS4-HMAC-SHA256&quot;;\n    private static final String HOST = &quot;bedrock-runtime.us-east-1.amazonaws.com&quot;;\n    private static final String ENDPOINT_PATH = &quot;/model/anthropic.claude-3-haiku-20240307-v1:0/invoke&quot;;\n\n    public static void main(String[] args) throws Exception {\n        // Use TreeMap to ensure consistent ordering of headers\n        TreeMap&lt;String, String&gt; headers = new TreeMap&lt;&gt;();\n\n        String payload = &quot;{&quot;\n                + &quot;\\&quot;anthropic_version\\&quot;: \\&quot;bedrock-2023-05-31\\&quot;,&quot;\n                + &quot;\\&quot;max_tokens\\&quot;: 512,&quot;\n                + &quot;\\&quot;messages\\&quot;: [&quot;\n                + &quot;    {&quot;\n                + &quot;        \\&quot;role\\&quot;: \\&quot;user\\&quot;,&quot;\n                + &quot;        \\&quot;content\\&quot;: [&quot;\n                + &quot;            {&quot;\n                + &quot;                \\&quot;type\\&quot;: \\&quot;text\\&quot;,&quot;\n                + &quot;                \\&quot;text\\&quot;: \\&quot;What is java\\&quot;&quot;\n                + &quot;            }&quot;\n                + &quot;        ]&quot;\n                + &quot;    }&quot;\n                + &quot;]&quot;\n                + &quot;}&quot;;\n\n        // Create a datetime object for signing\n        SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;yyyyMMdd'T'HHmmss'Z'&quot;, Locale.US);\n        dateFormat.setTimeZone(TimeZone.getTimeZone(&quot;UTC&quot;));\n        String amzDate = dateFormat.format(new Date());\n        String dateStamp = amzDate.substring(0, 8);\n \n        // Calculate payload hash\n        String payloadHash = sha256Hex(payload);\n        String contentLength = String.valueOf(payload.getBytes(StandardCharsets.UTF_8).length);\n \n        // Add headers to TreeMap to ensure consistent ordering\n        headers.put(&quot;accept&quot;, &quot;application/json&quot;);\n        headers.put(&quot;content-length&quot;, contentLength);\n        headers.put(&quot;content-type&quot;, &quot;application/json&quot;);\n        headers.put(&quot;host&quot;, HOST);\n        headers.put(&quot;x-amz-content-sha256&quot;, payloadHash);\n        headers.put(&quot;x-amz-date&quot;, amzDate);\n        headers.put(&quot;x-amzn-bedrock-save&quot;, &quot;true&quot;);\n\n        // Build canonical headers and signed headers string\n        StringBuilder canonicalHeadersBuilder = new StringBuilder();\n        StringBuilder signedHeadersBuilder = new StringBuilder();\n\n        boolean first = true;\n        for (String key : headers.keySet()) {\n            canonicalHeadersBuilder.append(key.toLowerCase())\n                    .append(&quot;:&quot;)\n                    .append(headers.get(key).trim())\n                    .append(&quot;\\n&quot;);\n\n            if (!first) {\n                signedHeadersBuilder.append(&quot;;&quot;);\n            }\n            signedHeadersBuilder.append(key.toLowerCase());\n            first = false;\n        }\n\n        String canonicalHeaders = canonicalHeadersBuilder.toString();\n        String signedHeaders = signedHeadersBuilder.toString();\n\n        // Create canonical request\n        String canonicalRequest = METHOD + &quot;\\n&quot;\n                + ENDPOINT_PATH + &quot;\\n&quot;\n                + &quot;\\n&quot;  // Empty query string\n                + canonicalHeaders + &quot;\\n&quot;\n                + signedHeaders + &quot;\\n&quot;\n                + payloadHash;\n\n        // Create string to sign\n        String credentialScope = String.format(&quot;%s/%s/%s/aws4_request&quot;, dateStamp, REGION, SERVICE);\n        String stringToSign = ALGORITHM + &quot;\\n&quot;\n                + amzDate + &quot;\\n&quot;\n                + credentialScope + &quot;\\n&quot;\n                + sha256Hex(canonicalRequest);\n\n        System.out.println(&quot;Canonical Request:\\n&quot; + canonicalRequest);\n        System.out.println(&quot;\\nString to Sign:\\n&quot; + stringToSign);\n\n        // Calculate signature\n        byte[] signingKey = getSignatureKey(AWS_SECRET_ACCESS_KEY, dateStamp, REGION, SERVICE);\n        String signature = hmacSha256Hex(signingKey, stringToSign);\n\n        // Create authorization header\n         String authorizationHeader = String.format(&quot;%s Credential=%s/%s, SignedHeaders=%s, Signature=%s&quot;,\n                ALGORITHM, AWS_ACCESS_KEY_ID, credentialScope, signedHeaders, signature);\n\n        // Make the request\n        URL url = new URL(&quot;https://&quot; + HOST + ENDPOINT_PATH);\n        HttpURLConnection conn = (HttpURLConnection) url.openConnection();\n        conn.setDoOutput(true);\n        conn.setRequestMethod(METHOD);\n\n        // Set all headers from our TreeMap\n        for (String key : headers.keySet()) {\n            conn.setRequestProperty(key, headers.get(key));\n        }\n        conn.setRequestProperty(&quot;Authorization&quot;, authorizationHeader);\n \n        // Print request details for debugging\n        System.out.println(&quot;\\nAuthorization Header:\\n&quot; + authorizationHeader);\n        System.out.println(&quot;\\nPayload Hash: &quot; + payloadHash);\n \n        // Send payload\n        try (OutputStream os = conn.getOutputStream()) {\n            byte[] input = payload.getBytes(StandardCharsets.UTF_8);\n            os.write(input, 0, input.length);\n        }\n\n        // Get response\n        int responseCode = conn.getResponseCode();\n        if (responseCode == HttpURLConnection.HTTP_OK) {\n            String response = new String(conn.getInputStream().readAllBytes(), StandardCharsets.UTF_8);\n            System.out.println(&quot;Response: &quot; + response);\n        } else {\n            System.out.println(&quot;Error: &quot; + responseCode + &quot; &quot; + conn.getResponseMessage());\n            String errorResponse = new String(conn.getErrorStream().readAllBytes(), StandardCharsets.UTF_8);\n            System.out.println(&quot;Error details: &quot; + errorResponse);\n        }\n    }\n \n    private static byte[] getSignatureKey(String key, String dateStamp, String regionName, String serviceName) {\n        try {\n            byte[] kSecret = (&quot;AWS4&quot; + key).getBytes(StandardCharsets.UTF_8);\n            byte[] kDate = hmacSha256(kSecret, dateStamp);\n            byte[] kRegion = hmacSha256(kDate, regionName);\n            byte[] kService = hmacSha256(kRegion, serviceName);\n            return hmacSha256(kService, &quot;aws4_request&quot;);\n        } catch (Exception e) {\n            throw new RuntimeException(&quot;Error calculating signing key&quot;, e);\n        }\n    }\n\n    private static byte[] hmacSha256(byte[] key, String data) throws NoSuchAlgorithmException, InvalidKeyException {\n        Mac mac = Mac.getInstance(&quot;HmacSHA256&quot;);\n        mac.init(new SecretKeySpec(key, &quot;HmacSHA256&quot;));\n        return mac.doFinal(data.getBytes(StandardCharsets.UTF_8));\n    }\n\n    private static String hmacSha256Hex(byte[] key, String data) {\n        try {\n            return bytesToHex(hmacSha256(key, data));\n        } catch (Exception e) {\n            throw new RuntimeException(&quot;Error calculating HMAC&quot;, e);\n        }\n    }\n\n    private static String sha256Hex(String data) throws NoSuchAlgorithmException {\n        MessageDigest digest = MessageDigest.getInstance(&quot;SHA-256&quot;);\n        byte[] hash = digest.digest(data.getBytes(StandardCharsets.UTF_8));\n        return bytesToHex(hash);\n    }\n \n    private static String bytesToHex(byte[] bytes) {\n        StringBuilder result = new StringBuilder();\n        for (byte b : bytes) {\n            result.append(String.format(&quot;%02x&quot;, b));\n        }\n        return result.toString();\n    }\n}\n</code></pre>\n<p>The Python code that works is:</p>\n<pre class=\"lang-py prettyprint-override\"><code>import boto3\nimport json\nfrom botocore.awsrequest import AWSRequest\nfrom botocore.auth import SigV4Auth\nfrom botocore.credentials import Credentials\n\n# AWS credentials\naccess_key = &quot;access key&quot;\nsecret_key = &quot;secret key&quot;\n\n# Service and region\nservice = &quot;bedrock&quot;\nregion = &quot;us-east-1&quot;\n\n# Request details\nurl = &quot;https://bedrock-runtime.us-east-1.amazonaws.com/model/anthropic.claude-3-haiku-20240307-v1:0/invoke&quot;\npayload = {\n    &quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is python?&quot;}],\n    &quot;temperature&quot;: 0.5,\n    &quot;top_p&quot;: 0.9,\n    &quot;max_tokens&quot;: 512,\n    &quot;anthropic_version&quot;: &quot;bedrock-2023-05-31&quot;,  # Set version to a valid one\n}\nheaders = {\n    &quot;Accept&quot;: &quot;application/json&quot;,\n    &quot;X-Amzn-Bedrock-Save&quot;: &quot;true&quot;,\n    &quot;Content-Type&quot;: &quot;application/json&quot;,\n}\n\n# Create AWS request\nrequest = AWSRequest(method=&quot;POST&quot;, url=url, data=json.dumps(payload), headers=headers)\ncredentials = Credentials(access_key, secret_key)\nSigV4Auth(credentials, service, region).add_auth(request)\n\n# Create an HTTP client manually using botocore for sending the request\nimport botocore.session\n\n# Create a botocore session\nsession = botocore.session.get_session()\nclient = session.create_client(service, region_name=region, aws_access_key_id=access_key, aws_secret_access_key=secret_key)\n\n# Send the prepared request using the client\nhttp_session = client._endpoint.http_session\nresponse = http_session.send(request.prepare())\n\n# Debugging\nprint(&quot;Payload Sent:&quot;)\nprint(json.dumps(payload, indent=4))\nprint(&quot;\\nResponse:&quot;)\nprint(response.text)\n</code></pre>\n<p>Payload Sent:</p>\n<pre class=\"lang-json prettyprint-override\"><code>{\n    &quot;messages&quot;: [\n        {\n            &quot;role&quot;: &quot;user&quot;,\n            &quot;content&quot;: &quot;What is python?&quot;\n        }\n    ],\n    &quot;temperature&quot;: 0.5,\n    &quot;top_p&quot;: 0.9,\n    &quot;max_tokens&quot;: 512,\n    &quot;anthropic_version&quot;: &quot;bedrock-2023-05-31&quot;\n}\n</code></pre>\n<p>Response:</p>\n<pre class=\"lang-json prettyprint-override\"><code>{&quot;id&quot;:&quot;msg_bdrk_01YDAcio1xXTfXMkL6xhheNz&quot;,&quot;type&quot;:&quot;message&quot;,&quot;role&quot;:&quot;assistant&quot;,&quot;model&quot;:&quot;claude-3-haiku-20240307&quot;,&quot;content&quot;:[{&quot;type&quot;:&quot;text&quot;,&quot;text&quot;:&quot;Python is a high-level, general-purpose programming language.&quot;}],&quot;stop_reason&quot;:&quot;end_turn&quot;,&quot;stop_sequence&quot;:null,&quot;usage&quot;:{&quot;input_tokens&quot;:11,&quot;output_tokens&quot;:318}}\n</code></pre>\n<p>As the same request works perfectly in Python, what is the issue with the Java code?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}