{
  "question": {
    "tags": [
      "java",
      "intellij-idea",
      "javafx",
      "utf-8",
      "flatpak"
    ],
    "owner": {
      "account_id": 9669794,
      "reputation": 684,
      "user_id": 7175142,
      "user_type": "registered",
      "accept_rate": 89,
      "profile_image": "https://i.sstatic.net/xdPND.png?s=256",
      "display_name": "Doombringer",
      "link": "https://stackoverflow.com/users/7175142/doombringer"
    },
    "is_answered": true,
    "view_count": 201,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1732887718,
    "creation_date": 1732314793,
    "last_edit_date": 1732887718,
    "question_id": 79216754,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79216754/recursively-reading-files-in-directories-and-adding-the-file-names-to-a-listview",
    "title": "Recursively reading files in directories and adding the file names to a ListView results in question marks �",
    "body": "<p>After investigating, I found out that the most performant way to read a directory and its sub-directories' files is using <code>Files.walk()</code> method.</p>\n<pre><code>private void selectPrimaryFolder(ResourceBundle resourceBundle, ListView&lt;String&gt; lvFileList) {\n        DirectoryChooser chooser = new DirectoryChooser();\n        chooser.setTitle(resourceBundle.getString(&quot;selectPrimaryFolder&quot;));\n\n        File selectedDirectory = chooser.showDialog((Stage) btnSelectPrimaryFolder.getScene().getWindow());\n\n        System.out.println(&quot;SELECTED DIRECTORY: &quot; + selectedDirectory.toPath());\n\n        // TODO\n        try (Stream&lt;Path&gt; stream = Files.walk(selectedDirectory.toPath()).sorted()) {\n            stream.forEach(path -&gt; addFileToList(path.toFile(), lvFileList));\n        } catch (IOException ioException) {\n            ioException.getMessage();\n        }\n\n        /*System.out.println(listFileTree(selectedDirectory));\n        for (File f: listFileTree(selectedDirectory)){\n            lvFileList.getItems().add(f.getName());\n        }*/\n\n\n    }\n\nprivate static void addFileToList(File file, ListView&lt;String&gt; lvFileList) {\n        if (file.isDirectory()) {\n            System.out.println(&quot;Directory: &quot; + file.getAbsolutePath());\n        } else {\n            System.out.println(&quot;File: &quot; + file.getAbsolutePath());\n            lvFileList.getItems().add(file.getName());\n        }\n    }\n\npublic static Collection&lt;File&gt; listFileTree(File dir) {\n        Set&lt;File&gt; fileTree = new HashSet&lt;File&gt;();\n        if(dir==null||dir.listFiles()==null){\n            return fileTree;\n        }\n        for (File entry : dir.listFiles()) {\n            if (entry.isFile()) fileTree.add(entry);\n            else fileTree.addAll(listFileTree(entry));\n        }\n        return fileTree;\n    }\n</code></pre>\n<p>Unfortunately, in the IntelliJ console, for any Cyrillic characters, it outputs <code>????</code>, while in JavaFX's <code>ListView</code>, I get <code>�����</code>.</p>\n<p>The <code>listFileTree()</code> method, which I found <a href=\"https://stackoverflow.com/questions/2056221/recursively-list-files-in-java/24006711#24006711\">here (Recursively list files in Java)</a>, is another way I tried to get the list of files, but weirdly enough, it straight up ignores files that contain any Cyrillic characters.</p>\n<p>According to a post <a href=\"https://stackoverflow.com/questions/14853402/both-file-isfile-and-file-isdirectory-is-returning-false\">here (both File.isFile() and File.isDirectory() is returning false)</a>, <code>isFile()</code> might be having an issue with the encoding.</p>\n<h1>The Encoding</h1>\n<p>From what I found, this <em>might be</em> an encoding issue.</p>\n<p>I checked my IntelliJ's file enconding settings and they're all set to UTF-8 (it's also set to create UTF-8 files with no BOM), including the console's default encoding.</p>\n<p>I've set both of these in the VMOptions:</p>\n<pre><code>-Dconsole.encoding=UTF-8\n-Dfile.encoding=UTF-8\n</code></pre>\n<h1>Byte vs Character Streams</h1>\n<p>Something interesting I ran into is that if I use <code>FileChooser</code> and select a single file, the characters are properly displayed in the <code>ListView</code> (albeit in the console they still show as question marks).</p>\n<p>As per the documentation, <code>File.walk()</code> returns a <code>stream</code> (of <code>path</code>), which I'm assuming is <s>done via <code>single byte stream</code></s> [<em><strong>See EDIT 4</strong></em>] (I admit, I got a bit lost in the documentation), because according to Ted Hopp's comment in <a href=\"https://stackoverflow.com/questions/46874783/byte-stream-vs-character-stream-in-java\">Byte Stream vs Character Stream in Java</a>, it should be able to read the Cyrillic if it was a &quot;Character Stream&quot; (assuming the original file is enconded in UTF-8, of course).</p>\n<blockquote>\n<p>...To test this, try a file that contains something that requires more\nthan one byte to represent (such as Greek, Cyrillic, or Arabic\ncharacters). With a byte-oriented stream, these won't work. With a\ncharacter-oriented stream, the characters will be preserved as long as\nboth the streams are using encodings that supports those characters\n(such as UTF-8) and the input file was stored in the encoding used for\nthe input stream...</p>\n</blockquote>\n<h1>Figuring out the original file encoding</h1>\n<p>I thought I'd just look for a way to detect the encoding and set up a condition, but after reading many, <em>many</em>, <strong>many</strong> answers, it turns out it's not something that can be done. The best option one has is to try and &quot;guess&quot; it. Which I did.</p>\n<p>Using <code>new String(bytes, charset) / String.getBytes()</code> mentioned in <a href=\"https://stackoverflow.com/questions/229015/encoding-conversion-in-java\">Encoding conversion in java</a>, I tested the most common ones, as per <a href=\"https://stackoverflow.com/questions/8509339/what-is-the-most-common-encoding-of-each-language\">this question (What is the most common encoding of each language?)</a>, via <code>File.walk()</code>.</p>\n<p><em>NONE OF THEM WORKED!</em> Every single one resulted in question marks, in the console and in the <code>ListView</code>.</p>\n<p>I thought my files might be bugged but VLC doesn't seem to have any issues with encoding. All the text is presented as it should.</p>\n<h1>Question</h1>\n<p>How do I go about this? Is there a recursive <code>character stream</code> alternative to <code>File.walk()</code>? Have I missed something else?</p>\n<p>P.S. I have not tried any non-recursive solutions as recursion is a requirement.</p>\n<p>P.S. 2. I've also tried the ones mentioned in <a href=\"https://github.com/brettryan/io-recurse-tests\" rel=\"nofollow noreferrer\">io-recurse-tests</a>, but alas, nothing.</p>\n<h2>EDIT 1 - Additional information</h2>\n<h2>@Basil Bourque</h2>\n<blockquote>\n<p>Post an example of a file name with the problematic Cyrillic characters.</p>\n</blockquote>\n<p>Cyrillic file name examples:</p>\n<p><code>Ъпсурт - Колега.mp3</code></p>\n<p><code>Kingsize - Оставам себе си.mp3</code></p>\n<h2>@Basil Bourque</h2>\n<blockquote>\n<p>What is “VLC” you mentioned?</p>\n</blockquote>\n<p>I was referring to <a href=\"https://www.videolan.org/vlc/\" rel=\"nofollow noreferrer\">VLC Media Player</a>.</p>\n<h2>@Basil Bourque @g00se</h2>\n<blockquote>\n<p>What file system? What is the host operating system?</p>\n</blockquote>\n<p>I'm using Fedora, which uses <a href=\"https://fedoraproject.org/wiki/Btrfs\" rel=\"nofollow noreferrer\">Btrfs: the b-tree filesystem</a> with UTF-8 as default system encoding.</p>\n<h2>@g00se</h2>\n<blockquote>\n<p>Not quite sure why a) you're mixing Path with File (perhaps because of your positive results with FileChooser or something?)...</p>\n</blockquote>\n<pre><code>ListView&lt;String&gt; lvPrimaryList = new ListView&lt;&gt;();\nButton btn = new Button(&quot;Select file&quot;);\nbtn.setOnMouseClicked(new EventHandler&lt;MouseEvent&gt;() {\n    @Override\n    public void handle(MouseEvent mouseEvent) {\n\n        FileChooser chooser = new FileChooser();\n        chooser.setTitle(resourceBundle.getString(&quot;selectPrimaryFolder&quot;));\n        File selectedFile = chooser.showOpenDialog((Stage) btn.getScene().getWindow());\n        System.out.println(&quot;SELECTED FILE: &quot; + selectedFile.getAbsolutePath());\n\n        lvPrimaryList.getItems().add(selectedFile.getAbsolutePath());\n\n    }\n});\n</code></pre>\n<p>The above code successfully adds <code>/home/user/music/Kingsize - Оставам себе си.mp3</code> to the <code>ListView</code>.</p>\n<p>But if I try to get a list of all of the files in a directory using <code>File.walk()</code> mentioned above, it ends up as <code>/home/user/music/Kingsize - ������� ���� ��.mp3</code>.</p>\n<h2>@g00se</h2>\n<blockquote>\n<p>...b) why you think recursion/non-recursion has any bearing on this...</p>\n</blockquote>\n<p>I mentioned recursion in case there are solutions that work but only get a list of files in the current directory and I need to be able to get any possible files within any sub-directories.</p>\n<h2>@jewelsea</h2>\n<blockquote>\n<p>Create an App with a label that displays the hardcoded text of one of &gt; the problem file names: new Scene(new Label(&quot;problem text&quot;)). That is &gt; all it needs to do. Nothing else. Does the text display correctly?</p>\n</blockquote>\n<p>Using <code>Label</code> does work.</p>\n<pre><code>ListView&lt;Label&gt; lvPrimaryList = new ListView&lt;&gt;();\nButton btn = new Button(&quot;Select file&quot;);\nbtn.setOnMouseClicked(new EventHandler&lt;MouseEvent&gt;() {\n    @Override\n    public void handle(MouseEvent mouseEvent) {\n    \n        lvPrimaryList.getItems().add(new Label(&quot;Ъпсурт - Колега.mp3&quot;));\n    \n    }\n});\n</code></pre>\n<p>Hard coding the text via the following code also works:</p>\n<pre><code>ListView&lt;String&gt; lvPrimaryList = new ListView&lt;&gt;();\nButton btn = new Button(&quot;Select file&quot;);\nbtn.setOnMouseClicked(new EventHandler&lt;MouseEvent&gt;() {\n    @Override\n    public void handle(MouseEvent mouseEvent) {\n\n        lvPrimaryList.getItems().add(&quot;Ъпсурт - Колега.mp3&quot;);\n\n    }\n});\n</code></pre>\n<h2>@g00se</h2>\n<blockquote>\n<p>new Scene(new Label(&quot;\\u041E\\u0434\\u0438\\u043D&quot;));</p>\n</blockquote>\n<pre><code>ListView&lt;Label&gt; lvPrimaryList = new ListView&lt;&gt;();\nButton btn = new Button(&quot;Select file&quot;);\nbtn.setOnMouseClicked(new EventHandler&lt;MouseEvent&gt;() {\n    @Override\n    public void handle(MouseEvent mouseEvent) {\n        \n        lvPrimaryList.getItems().add(new Label(&quot;\\u041E\\u0434\\u0438\\u043D&quot;));\n        \n    }\n});\n</code></pre>\n<p>This does work. I get, <code>Один</code>.</p>\n<h2>@Basil Bourque</h2>\n<blockquote>\n<p>You may need to specify a font you know to have glyphs for your\ndesired characters. Other Questions have pointed to JavaFX failing to\nrun through fonts properly to find one with needed glyphs.</p>\n</blockquote>\n<p>I'm using <a href=\"https://www.ibm.com/plex/\" rel=\"nofollow noreferrer\">IBM Plex Sans</a> font.</p>\n<p>In my <code>Main.java</code> file, I've added it like so:</p>\n<pre><code>Font.loadFont(Objects.requireNonNull(getClass().getResource(&quot;fonts/IBMPlexSans-Light.ttf&quot;)).toExternalForm(), 14);\nFont.loadFont(Objects.requireNonNull(getClass().getResource(&quot;fonts/IBMPlexSans-Medium.ttf&quot;)).toExternalForm(), 14);\nFont.loadFont(Objects.requireNonNull(getClass().getResource(&quot;fonts/IBMPlexSans-Regular.ttf&quot;)).toExternalForm(), 14);\nFont.loadFont(Objects.requireNonNull(getClass().getResource(&quot;fonts/IBMPlexSans-SemiBold.ttf&quot;)).toExternalForm(), 14);\n</code></pre>\n<p>In my <code>style.css</code> file, I've loaded it via:</p>\n<pre><code>.root {\n    -fx-font-family: &quot;IBM Plex Sans&quot;;\n}\n</code></pre>\n<p>I reviewed the font glyphs and it <strong>does</strong> include Cyrillic, as mentioned in the <a href=\"https://www.ibm.com/plex/specs/\" rel=\"nofollow noreferrer\">specifications</a>.</p>\n<p>I did remove it, just in case, but I still get <code>�����</code> in the <code>ListView</code> when using <code>File.walk()</code>.</p>\n<h1>EDIT 2 - Further testing</h1>\n<p>Using <code>FileChooser</code> and selecting multiple files produces the desired results in the <code>ListView</code>, but the code lacks recursion.</p>\n<pre><code>ListView&lt;String&gt; lvPrimaryList = new ListView&lt;&gt;();\nButton btn = new Button(&quot;Select file&quot;);\nbtn.setOnMouseClicked(new EventHandler&lt;MouseEvent&gt;() {\n    @Override\n    public void handle(MouseEvent mouseEvent) {\n\n        FileChooser chooser = new FileChooser();\n        chooser.setTitle(&quot;Select files&quot;);\n        List&lt;File&gt; selectedFiles = chooser.showOpenMultipleDialog((Stage) btn.getScene().getWindow());\n\n        for (File file : selectedFiles) {\n            System.out.println(&quot;SELECTED FILE: &quot; + file.getAbsolutePath());\n            lvPrimaryList.getItems().add(file.getAbsolutePath());\n        }\n    }\n});\n</code></pre>\n<p>It's also a bit less user friendly when there are hundreds of files and the user would have to select all of them. It'd be much better to prompt the user to select a single directory and leave the program to do the &quot;heavy lifting&quot;.</p>\n<h1>EDIT 3 - Minimal reproducible example</h1>\n<p>In the process of creating a full MRE, I ran into an issue where, after creating the files myself, their names were all: <code>?????? - ??????.mp3</code></p>\n<p><a href=\"https://i.sstatic.net/fzlLw3z6.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/fzlLw3z6.png\" alt=\"Files with question marks in their names.\" /></a></p>\n<p><strong>Main.java</strong></p>\n<pre><code>public class Main extends Application {\n    @Override\n    public void start(Stage stage) throws IOException {\n\n        FXMLLoader fxmlLoader = new FXMLLoader(Main.class.getResource(&quot;main.fxml&quot;));\n        Scene scene = new Scene(fxmlLoader.load(), 800, 600);\n        scene.getStylesheets().add(getClass().getResource(&quot;style/style.css&quot;).toExternalForm());\n        stage.setTitle(&quot;My Program&quot;);\n        stage.setScene(scene);\n        stage.show();\n    }\n\n    public static void main(String[] args) {\n        launch();\n    }\n}\n</code></pre>\n<p><strong>MainController.java</strong></p>\n<pre><code>public class MainController implements Initializable {\n\n    @FXML\n    private ListView&lt;String&gt; lvPrimaryList;\n    @FXML\n    private Button btnSelectFile;\n\n    @Override\n    public void initialize(URL url, ResourceBundle resourceBundle) {\n\n        // Select primary list\n        btnSelectFile.setOnMouseClicked(new EventHandler&lt;MouseEvent&gt;() {\n            @Override\n            public void handle(MouseEvent mouseEvent) {\n\n                initTest();\n            }\n        });\n    }\n\n    private void initTest() {\n\n        System.out.println(java.nio.charset.Charset.defaultCharset());\n\n        // Edit these to match your operating system\n        String osDelimiter = &quot;/&quot;;\n        String rootString = &quot;/home/user/Documents/init-test&quot; + osDelimiter;\n\n        Path rootPath = Paths.get(rootString);\n\n\n        try {\n            Files.createDirectory(rootPath);\n\n            File songOne = new File(rootString + &quot;Ъпсурт - Колега.mp3&quot;);\n            songOne.createNewFile();\n            File songTwo = new File(rootString + &quot;Kingsize - Оставам себе си.mp3&quot;);\n            songTwo.createNewFile();\n\n            //System.setOut(new PrintStream(new FileOutputStream(rootString + &quot;Ъпсурт - Колега.mp3&quot;), true, StandardCharsets.UTF_8));\n            //System.setOut(new PrintStream(new FileOutputStream(rootString + &quot;Kingsize - Оставам себе си.mp3&quot;), true, StandardCharsets.UTF_8));\n\n            //System.setOut(new PrintStream(new FileOutputStream(rootString + &quot;Ъпсурт - Колега.mp3&quot;), true, &quot;Cp1252&quot;));\n            //System.setOut(new PrintStream(new FileOutputStream(rootString + &quot;Kingsize - Оставам себе си.mp3&quot;), true, &quot;Cp1252&quot;));\n\n            //System.setOut(new PrintStream(new FileOutputStream(rootString + &quot;Ъпсурт - Колега.mp3&quot;), true, &quot;windows-1251&quot;));\n            //System.setOut(new PrintStream(new FileOutputStream(rootString + &quot;Kingsize - Оставам себе си.mp3&quot;), true, &quot;windows-1251&quot;));\n\n            //System.setOut(new PrintStream(new FileOutputStream(rootString + &quot;Ъпсурт - Колега.mp3&quot;), true, &quot;UTF-16&quot;));\n            //System.setOut(new PrintStream(new FileOutputStream(rootString + &quot;Kingsize - Оставам себе си.mp3&quot;), true, &quot;UTF-16&quot;));\n\n            //Writer writerOne = new OutputStreamWriter(new FileOutputStream(rootString + &quot;Ъпсурт - Колега.mp3&quot;));\n            //writerOne.close();\n            //Writer writerTwo = new OutputStreamWriter(new FileOutputStream(rootString + &quot;Kingsize - Оставам себе си.mp3&quot;));\n            //writerTwo.close();\n        \n            //Writer writerOne = new OutputStreamWriter(new FileOutputStream(rootString + &quot;Ъпсурт - Колега.mp3&quot;), StandardCharsets.UTF_8);\n            //writerOne.close();\n            //Writer writerTwo = new OutputStreamWriter(new FileOutputStream(rootString + &quot;Kingsize - Оставам себе си.mp3&quot;), StandardCharsets.UTF_8);\n            //writerTwo.close();\n\n            //Writer writerOne = new OutputStreamWriter(new FileOutputStream(rootString + &quot;Ъпсурт - Колега.mp3&quot;), StandardCharsets.UTF_16);\n            //writerOne.close();\n            //Writer writerTwo = new OutputStreamWriter(new FileOutputStream(rootString + &quot;Kingsize - Оставам себе си.mp3&quot;), StandardCharsets.UTF_16);\n            //writerTwo.close();\n\n            try (Stream&lt;Path&gt; stream = Files.walk(rootPath.toFile().toPath()).sorted()) {\n                stream.forEach(path -&gt; addFileToList(path.toFile(), lvPrimaryList));\n            } catch (IOException ioException) {\n                ioException.getMessage();\n            }\n\n        } catch (IOException exception) {\n            exception.printStackTrace();\n        }\n    }\n}\n</code></pre>\n<p><strong>init-test.fxml</strong></p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n\n&lt;?import javafx.geometry.Insets?&gt;\n&lt;?import javafx.scene.control.Button?&gt;\n&lt;?import javafx.scene.control.Label?&gt;\n&lt;?import javafx.scene.control.ListView?&gt;\n&lt;?import javafx.scene.layout.VBox?&gt;\n&lt;?import javafx.scene.text.Font?&gt;\n\n&lt;VBox alignment=&quot;CENTER&quot; maxHeight=&quot;-Infinity&quot; maxWidth=&quot;-Infinity&quot; minHeight=&quot;-Infinity&quot; minWidth=&quot;-Infinity&quot; spacing=&quot;5.0&quot; xmlns=&quot;http://javafx.com/javafx/21&quot; xmlns:fx=&quot;http://javafx.com/fxml/1&quot; fx:controller=&quot;com.project.test.MainController&quot;&gt;\n   &lt;children&gt;\n      &lt;Label alignment=&quot;CENTER&quot; maxWidth=&quot;1.7976931348623157E308&quot; text=&quot;Init Test&quot;&gt;\n         &lt;font&gt;\n            &lt;Font name=&quot;System Bold&quot; size=&quot;13.0&quot; /&gt;\n         &lt;/font&gt;\n      &lt;/Label&gt;\n      &lt;ListView fx:id=&quot;lvPrimaryList&quot; /&gt;\n      &lt;Button fx:id=&quot;btnSelectFile&quot; mnemonicParsing=&quot;false&quot; text=&quot;Select file&quot; /&gt;\n   &lt;/children&gt;\n   &lt;padding&gt;\n      &lt;Insets bottom=&quot;5.0&quot; left=&quot;5.0&quot; right=&quot;5.0&quot; top=&quot;5.0&quot; /&gt;\n   &lt;/padding&gt;\n&lt;/VBox&gt;\n</code></pre>\n<p>I also ran into <a href=\"https://stackoverflow.com/questions/72592782/how-to-support-cyrillic-alphabet-in-eclipse\">this post (How to support Cyrillic alphabet in Eclipse?)</a>.</p>\n<p>It explains that the <code>�</code> symbol doesn't have anything to do with the encoding but the font not having the necessary glyphs to support Cyrillic, as mentioned by <strong>Basil Bourque</strong> - which is weird because of the above experiments resulting in a success when manually selecting the files.</p>\n<p>I'll keep updating as I keep investigating.</p>\n<h1>EDIT 4 - Source code</h1>\n<p>Digging through Github source code of Java/JavaFX, I found the following:</p>\n<ul>\n<li><a href=\"https://github.com/openjdk/jfx/blob/master/modules/javafx.graphics/src/main/java/javafx/stage/FileChooser.java#L329\" rel=\"nofollow noreferrer\">FileChooser</a> - uses a <code>List&lt;File&gt;</code></li>\n<li><a href=\"https://github.com/openjdk/jdk/blob/master/src/java.base/share/classes/java/io/File.java#L255\" rel=\"nofollow noreferrer\">File</a> - uses a normalized pathname <code>String</code>.</li>\n<li><a href=\"https://github.com/openjdk/jdk/blob/master/src/java.base/share/classes/java/nio/file/Files.java#L151\" rel=\"nofollow noreferrer\">Files</a> - uses an <code>InputStream</code> of <code>Path</code></li>\n<li><a href=\"https://github.com/openjdk/jdk/blob/master/src/java.base/share/classes/java/nio/file/Path.java#L147\" rel=\"nofollow noreferrer\">Path</a> - uses a <code>URI</code></li>\n<li><a href=\"https://github.com/openjdk/jdk/blob/master/src/java.base/share/classes/java/net/URI.java\" rel=\"nofollow noreferrer\">URI</a> - is a <code>String</code></li>\n</ul>\n<p>Theoretically, whether I use <code>File.walk()</code> or manually selecting files via <code>FileChooser</code>, both should be getting their data in a form of a <code>String</code>.</p>\n<p>Yet, the same <code>String</code> seems to be interpreted in different ways.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}