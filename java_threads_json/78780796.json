{
  "question": {
    "tags": [
      "java",
      "android",
      "service",
      "notifications"
    ],
    "owner": {
      "account_id": 29892259,
      "reputation": 3,
      "user_id": 22908131,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/47e3f2f7323a8c673c2388e062fa0525?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "theoyuncu13",
      "link": "https://stackoverflow.com/users/22908131/theoyuncu13"
    },
    "is_answered": false,
    "view_count": 67,
    "answer_count": 0,
    "score": 0,
    "last_activity_date": 1721739406,
    "creation_date": 1721682964,
    "last_edit_date": 1721739406,
    "question_id": 78780796,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78780796/caused-by-android-app-foregroundservicestartnotallowedexception-for-android-14",
    "title": "Caused by android.app.ForegroundServiceStartNotAllowedException for Android 14",
    "body": "<p>Although there are many problems similar to the question mentioned in the title, none of them work for Android 14. That's why I will take care to present my question with as clear sources as possible.\nAs far as Firebase Crashlytics shows, the relevant error is shown in line 166 of my pedometer service that I created for the Android 14 device.</p>\n<p><a href=\"https://i.sstatic.net/WxkhxVpw.png\" rel=\"nofollow noreferrer\">Crash Report SS</a></p>\n<p>Crash Report:</p>\n<pre><code>\nFatal Exception: java.lang.RuntimeException\nUnable to create service com.packagename.stepcounter.StepCounterService: android.app.ForegroundServiceStartNotAllowedException: Service.startForeground() not allowed due to mAllowStartForeground false: service com.packagename/.stepcounter.StepCounterService\nandroid.app.ActivityThread.handleCreateService (ActivityThread.java:5111)\n\ncom.android.internal.os.ZygoteInit.main (ZygoteInit.java:1103)\nCaused by android.app.ForegroundServiceStartNotAllowedException\nService.startForeground() not allowed due to mAllowStartForeground false: service com.packagename/.stepcounter.StepCounterService\nandroid.app.ForegroundServiceStartNotAllowedException$1.createFromParcel (ForegroundServiceStartNotAllowedException.java:54)\n\nandroid.app.Service.startForeground (Service.java:862)\ncom.packagename.stepcounter.StepCounterService.onCreate (StepCounterService.java:166)\nandroid.app.ActivityThread.handleCreateService (ActivityThread.java:5098)\n\ncom.android.internal.os.ZygoteInit.main (ZygoteInit.java:1103)\n\n</code></pre>\n<p>I share all the codes respectively.</p>\n<p>Manifest:</p>\n<pre><code>\n    &lt;uses-permission android:name=&quot;android.permission.POST_NOTIFICATIONS&quot; /&gt;\n    &lt;uses-permission android:name=&quot;android.permission.FOREGROUND_SERVICE&quot; /&gt;\n    &lt;uses-permission android:name=&quot;android.permission.FOREGROUND_SERVICE_HEALTH&quot; /&gt;\n    &lt;uses-permission android:name=&quot;android.permission.BODY_SENSORS&quot; /&gt;\n    &lt;uses-permission\n        android:name=&quot;android.permission.HIGH_SAMPLING_RATE_SENSORS&quot;\n        tools:ignore=&quot;HighSamplingRate&quot; /&gt;\n\n\n    &lt;service\n            android:name=&quot;.stepcounter.StepCounterService&quot;\n            android:enabled=&quot;true&quot;\n            android:exported=&quot;false&quot;\n            android:foregroundServiceType=&quot;health&quot;\n            android:stopWithTask=&quot;false&quot; /&gt;\n</code></pre>\n<p>Step Counter Service Helper (to turn on and off)</p>\n<pre><code>public class StepServiceHelper {\n    public Activity activity;\n    public StepCounterService mService;\n    public static final String TAG = &quot;StepCallback&quot;;\n    public boolean mIsRunning;\n    boolean mBound = false;\n\n    public StepServiceHelper(Activity activity) {\n        this.activity = activity;\n    }\n\n\n\n    private boolean isServiceRunning() {\n        ActivityManager manager =\n                (ActivityManager) activity.getSystemService(Context.ACTIVITY_SERVICE);\n        for (ActivityManager.RunningServiceInfo service : manager.getRunningServices(Integer.MAX_VALUE)) {\n            if (&quot;com.packagename.stepcounter.StepCounterService&quot;.equals(service.service.getClassName())) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    public void startService() {\n        if (!isServiceRunning()) {\n            Log.i(TAG, &quot;[SERVICE] Start&quot;);\n            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {\n                if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU) {\n                    if (ContextCompat.checkSelfPermission(activity, POST_NOTIFICATIONS) == PackageManager.PERMISSION_DENIED) {\n                        Toast.makeText(activity.getApplicationContext(), &quot;Please allow notifications from the application settings.&quot;, Toast.LENGTH_LONG).show();\n                        ActivityCompat.requestPermissions(activity, new String[]{POST_NOTIFICATIONS}, NOTIFICATION_PERMISSION);\n                    } else {\n                        ContextCompat.startForegroundService(activity, new Intent(activity, StepCounterService.class));\n                    }\n                } else {\n                    ContextCompat.startForegroundService(activity, new Intent(activity, StepCounterService.class));\n                }\n            } else {\n                activity.getApplicationContext().startService(new Intent(activity, StepCounterService.class));\n            }\n        }\n    }\n\n\n    public void stopService() {\n        if (isServiceRunning()) {\n            Log.i(TAG, &quot;[SERVICE] stopService&quot;);\n            activity.getApplicationContext().stopService(new Intent(activity, StepCounterService.class));\n        }\n    }\n\n  }\n\n</code></pre>\n<p>StepCounterService (The line number where the error occurs is line 166.)</p>\n<pre><code>\npublic class StepCounterService extends Service {\n    public static final String TAG = &quot;StepService&quot;;\n    public SensorManager mSensorManager;\n    public static final Integer NOTIFICATION_ID = 9;\n    public NotificationCompat.Builder mBuilder;\n    public NotificationManager notificationManager;\n    private final IBinder binder = new StepBinder();\n    DatabaseHelper databaseHelper;\n    StepDetector mStepDetector;\n\n    public class StepBinder extends Binder {\n        public StepCounterService getService() {\n            return StepCounterService.this;\n        }\n    }\n\n    @Override\n    public IBinder onBind(Intent intent) {\n        Log.i(TAG, &quot;[SERVICE] onBind&quot;);\n        return binder;\n    }\n\n\n    @Override\n    public boolean onUnbind(Intent intent) {\n        Log.i(TAG, &quot;[SERVICE] unBind&quot;);\n        return super.onUnbind(intent);\n    }\n\n    @Override\n    public void onRebind(Intent intent) {\n        Log.i(TAG, &quot;[SERVICE] reBind&quot;);\n        super.onRebind(intent);\n    }\n\n\n    @Override\n    public int onStartCommand(Intent intent, int flags, int startId) {\n        super.onStartCommand(intent, flags, startId);\n        Log.i(TAG, &quot;[SERVICE] start&quot;);\n        return START_STICKY;\n    }\n\n    public void clearNotification() {\n        if (notificationManager != null) {\n            notificationManager.cancel(NOTIFICATION_ID);\n        }\n    }\n\n    @Override\n    public void onCreate() {\n        super.onCreate();\n        Log.i(TAG, &quot;[SERVICE] onCreate&quot;);\n\n        Intent myintent = new Intent(getApplicationContext(), SplashActivity.class);\n        PendingIntent pendingIntent = PendingIntent.getActivity(getApplicationContext(), 0, myintent, PendingIntent.FLAG_IMMUTABLE);\n\n\n        mBuilder = new NotificationCompat.Builder(getApplicationContext(), getApplicationContext().getString(R.string.counter_channel))\n                .setSmallIcon(R.drawable.ic_notification_icon)\n                .setPriority(NotificationManager.IMPORTANCE_HIGH)\n                .setOngoing(true)\n                .setAutoCancel(false)\n                .setOnlyAlertOnce(true)\n                .setSilent(true)\n                .setSound(null)\n                .setForegroundServiceBehavior(NotificationCompat.FOREGROUND_SERVICE_IMMEDIATE)\n                .setVibrate(new long[]{0})\n                .setContentIntent(pendingIntent);\n\n        notificationManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);\n\n\n        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {\n            NotificationChannel channel = new NotificationChannel(getString(R.string.counter_channel), getString(R.string.counter_channel), NotificationManager.IMPORTANCE_HIGH);\n            channel.setDescription(getString(R.string.counter_channel));\n            channel.setVibrationPattern(new long[]{0});\n            channel.enableVibration(false);\n            channel.setSound(null, null);\n            channel.setImportance(NotificationManager.IMPORTANCE_HIGH);\n            notificationManager.createNotificationChannel(channel);\n        }\n\n\n        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.UPSIDE_DOWN_CAKE) {\n            startForeground(NOTIFICATION_ID, mBuilder.build(), FOREGROUND_SERVICE_TYPE_HEALTH); // This is line 166\n        } else {\n            startForeground(NOTIFICATION_ID, mBuilder.build());\n        }\n \n        // The text on the notification will be updated\n        updateNotification();\n}\n\n\n    @Override\n    public void onDestroy() {\n        Log.i(TAG, &quot;[SERVICE] onDestroy&quot;);\n        unregisterDetector();\n        clearNotification();\n        super.onDestroy();\n    }\n\n\n    @Override\n    public void onTaskRemoved(Intent rootIntent) {\n        super.onTaskRemoved(rootIntent);\n        if (!isServiceRunning() &amp;&amp; SharedPreferencesReceiver.getStepServiceRun(getApplicationContext())) {\n            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {\n                startForegroundService(new Intent(this, StepCounterService.class));\n            } else {\n                startService(new Intent(this, StepCounterService.class));\n            }\n        }\n    }\n\n    private boolean isServiceRunning() {\n        ActivityManager manager =\n                (ActivityManager) getApplicationContext().getSystemService(Context.ACTIVITY_SERVICE);\n        for (ActivityManager.RunningServiceInfo service : manager.getRunningServices(Integer.MAX_VALUE)) {\n            if (&quot;com.packagename.stepcounter.StepCounterService&quot;.equals(service.service.getClassName())) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n\n\n    private void updateNotification() {\n        RemoteViews notificationLayout;\n\n        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.S) {\n            notificationLayout = new RemoteViews(getPackageName(), R.layout.step_notification_layout_collapsed);\n        } else {\n            notificationLayout = new RemoteViews(getPackageName(), R.layout.step_notification_layout);\n        }\n\n        notificationLayout.setTextViewText(R.id.stepCount, String.valueOf(db_steps));\n        notificationLayout.setTextViewText(R.id.stepKcal, String.format(Locale.ROOT, &quot;%.1f&quot;, db_calories));\n\n        mBuilder.setCustomContentView(notificationLayout);\n        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.S) {\n            RemoteViews step_notification_layout_expanded = new RemoteViews(getPackageName(), R.layout.step_notification_layout_expanded);\n            step_notification_layout_expanded.setTextViewText(R.id.adimsayisi, String.valueOf(db_steps));\n            step_notification_layout_expanded.setTextViewText(R.id.gkcaltext, String.format(Locale.ROOT, &quot;%.1f&quot;, db_calories));\n            mBuilder.setCustomBigContentView(step_notification_layout_expanded);\n        }\n\n\n        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.UPSIDE_DOWN_CAKE) {\n            startForeground(NOTIFICATION_ID, mBuilder.build(), FOREGROUND_SERVICE_TYPE_HEALTH);\n        } else {\n            startForeground(NOTIFICATION_ID, mBuilder.build());\n        }\n    }\n\n\n\n}\n</code></pre>\n<p>I added all the codes and necessary explanations. I don't have the slightest information about why and how the problem occurs. I encountered it once while testing my application, but even then I don't know how I did it. There was a problem for users with Android 14 operating system on Firebase</p>\n<p>Additional info</p>\n<p>I call it in the onStop method in MainActivity. I don't know if this is wrong</p>\n<pre><code>    @Override\n    protected void onStop() {\n        super.onStop();\n        Log.d(&quot;TAG_RES&quot;, &quot;main_stop&quot;);\n        if (SharedPreferencesHelper.getStepServiceRun(getApplicationContext())) {\n            stepCallback.startService();\n        } else {\n            stepCallback.stopService();\n        }\n    }\n\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}