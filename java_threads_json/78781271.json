{
  "question": {
    "tags": [
      "java",
      "multithreading",
      "concurrency",
      "java.util.concurrent"
    ],
    "owner": {
      "account_id": 15081619,
      "reputation": 51,
      "user_id": 10884112,
      "user_type": "registered",
      "profile_image": "https://lh6.googleusercontent.com/-ZbVlYp2cqps/AAAAAAAAAAI/AAAAAAAAAAA/AKxrwcaPvbbepjPOdUIbP0xDPdISw1OgfQ/mo/s256-rj/photo.jpg",
      "display_name": "MangKyu",
      "link": "https://stackoverflow.com/users/10884112/mangkyu"
    },
    "is_answered": true,
    "view_count": 123,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1724422892,
    "creation_date": 1721699292,
    "last_edit_date": 1724422892,
    "question_id": 78781271,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78781271/java-concurrency-problem-by-multi-thread-not-occured-and-automatically-synchroni",
    "title": "Java concurrency problem by multi-thread not occured and automatically synchronized",
    "body": "<p>I’m trying to test a multi-threaded concurrency problem.</p>\n<p>What I expected is that the result should be less than 0 (not always but sometimes), because it is not synchronized.</p>\n<p>Notice the pair of <code>println</code> calls enabled/disabled by an <code>if ( doPrintln )</code> test. Enabling/disabling changes the outcome of the test.</p>\n<pre class=\"lang-java prettyprint-override\"><code>class OptionTest\n{\n    static class Option\n    {\n        private int quantity;\n\n        public Option ( int aQuantity ) { this.quantity = aQuantity; }\n\n        public int getQuantity ( ) { return quantity; }\n\n        public boolean subtract ( final int aQuantity )\n        {\n            final boolean doPrintln = false;\n            if ( aQuantity &gt;= this.quantity )\n            {\n                if ( doPrintln ) System.out.println( &quot;Returning FALSE. this.quantity = &quot; + this.quantity + &quot; at &quot; + Instant.now( ) );\n                return false;\n            }\n\n            if ( doPrintln ) System.out.println( &quot;Returning TRUE. this.quantity = &quot; + this.quantity + &quot; at &quot; + Instant.now( ) );\n            this.quantity -= aQuantity;\n            return true;\n        }\n    }\n\n    @Test\n    void asyncSubtract ( ) throws InterruptedException\n    {\n        int numberOfThreads = 100; // Increased number of threads\n        ExecutorService executorService = Executors.newFixedThreadPool( numberOfThreads );\n        List &lt; Callable &lt; Boolean &gt; &gt; tasks = new ArrayList &lt;&gt;( );\n\n        Option option = new Option( 201 );\n        for ( int i = 0 ; i &lt; numberOfThreads ; i++ )\n        {\n            tasks.add( ( ) -&gt; option.subtract( 50 ) );\n        }\n\n        executorService.invokeAll( tasks );\n        executorService.shutdown( );\n\n        assertThat( option.getQuantity( ) ).isLessThan( 1 ); // org.assertj.core.api.Assertions.assertThat\n        System.out.println( &quot;INFO - Test end.  option.getQuantity( ) = &quot; + option.getQuantity( ) + &quot;. Now: &quot; + Instant.now( ) );\n    }\n}\n</code></pre>\n<h2>Without <code>println</code></h2>\n<p>When I run while suppressing the <code>println</code> calls (<code>doPrintln = false</code>), I get this result:</p>\n<pre class=\"lang-none prettyprint-override\"><code>java.lang.AssertionError: \nExpecting actual:\n  1\nto be less than:\n  1 \n\n    at work.basil.example.testing.OptionTest.asyncSubtract(OriginalOptionTest.java:55)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:580)\n    at java.base/java.util.ArrayList.forEach(ArrayList.java:1597)\n    at java.base/java.util.ArrayList.forEach(ArrayList.java:1597)\n</code></pre>\n<h2>With <code>println</code></h2>\n<p>When I run the test with <code>doPrintln = true</code>, I get the following result, a hundred lines of <code>Returning …</code> output.</p>\n<pre class=\"lang-none prettyprint-override\"><code>Returning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.537881Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528665Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528054Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.531742Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.531094Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.537219Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.532059Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528697Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.531952Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.527946Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.532171Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.532220Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.537462Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528005Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.538305Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.536697Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.530989Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.535044Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.538518Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528587Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528202Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528469Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.534627Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528248Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.532282Z\nReturning FALSE. this.quantity = -999 at 2024-07-24T19:04:06.539461Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528481Z\nReturning FALSE. this.quantity = -1049 at 2024-07-24T19:04:06.539559Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.532323Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.530792Z\nReturning FALSE. this.quantity = -349 at 2024-07-24T19:04:06.538886Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.531271Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.527857Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528781Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.531565Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.532480Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528736Z\nReturning FALSE. this.quantity = -1399 at 2024-07-24T19:04:06.540039Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.532122Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.531314Z\nReturning FALSE. this.quantity = -1599 at 2024-07-24T19:04:06.540262Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.531166Z\nReturning FALSE. this.quantity = -499 at 2024-07-24T19:04:06.539014Z\nReturning FALSE. this.quantity = -1649 at 2024-07-24T19:04:06.540332Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.532820Z\nReturning FALSE. this.quantity = -1649 at 2024-07-24T19:04:06.540406Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.530923Z\nReturning FALSE. this.quantity = -1699 at 2024-07-24T19:04:06.540453Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.527858Z\nReturning FALSE. this.quantity = -599 at 2024-07-24T19:04:06.539171Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528355Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.533105Z\nReturning FALSE. this.quantity = -1849 at 2024-07-24T19:04:06.540620Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.533050Z\nReturning FALSE. this.quantity = -899 at 2024-07-24T19:04:06.539382Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528146Z\nReturning FALSE. this.quantity = -1949 at 2024-07-24T19:04:06.540756Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.527857Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528517Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.527868Z\nReturning FALSE. this.quantity = -2099 at 2024-07-24T19:04:06.540873Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528291Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528636Z\nReturning FALSE. this.quantity = -2199 at 2024-07-24T19:04:06.540951Z\nReturning FALSE. this.quantity = -1199 at 2024-07-24T19:04:06.539664Z\nReturning FALSE. this.quantity = -2249 at 2024-07-24T19:04:06.540996Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.532579Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.531213Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528807Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.528098Z\nReturning FALSE. this.quantity = -1199 at 2024-07-24T19:04:06.539833Z\nReturning FALSE. this.quantity = -2449 at 2024-07-24T19:04:06.541133Z\nReturning TRUE. this.quantity = 201 at 2024-07-24T19:04:06.533149Z\nReturning FALSE. this.quantity = -1549 at 2024-07-24T19:04:06.540224Z\nReturning FALSE. this.quantity = -1749 at 2024-07-24T19:04:06.540496Z\nReturning FALSE. this.quantity = -1799 at 2024-07-24T19:04:06.540566Z\nReturning FALSE. this.quantity = -1949 at 2024-07-24T19:04:06.540704Z\nReturning FALSE. this.quantity = -1999 at 2024-07-24T19:04:06.540813Z\nReturning FALSE. this.quantity = -2149 at 2024-07-24T19:04:06.540909Z\nReturning FALSE. this.quantity = -2299 at 2024-07-24T19:04:06.541048Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541178Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541357Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541231Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541415Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541268Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541463Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541311Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541514Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541588Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541618Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541674Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541711Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541767Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541823Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541853Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541895Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541940Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.541988Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.542028Z\nReturning FALSE. this.quantity = -2499 at 2024-07-24T19:04:06.542081Z\nINFO - Test end.  option.getQuantity( ) = -2499. Now: 2024-07-24T19:04:06.568632Z\n</code></pre>\n<p>Why does invoking <code>System.out.println</code> consistently alter the results?</p>\n<p>===================================================\nAnswer my self. This is indeed an issue caused by memory visibility, and it stems from the cached data in the CPU cores. Context switching ouccured by I/O tasks and it makes data updated on cache of CPU cores.\nIf you want to fix this issue, use keyword <code>volatile</code>.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}