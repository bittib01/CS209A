{
  "question": {
    "tags": [
      "java",
      "serialization",
      "hashmap",
      "graalvm"
    ],
    "owner": {
      "account_id": 14482834,
      "reputation": 5478,
      "user_id": 10461625,
      "user_type": "registered",
      "profile_image": "https://i.sstatic.net/fgo5D.jpg?s=256",
      "display_name": "PatPanda",
      "link": "https://stackoverflow.com/users/10461625/patpanda"
    },
    "is_answered": true,
    "view_count": 234,
    "accepted_answer_id": 78543757,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1716894906,
    "creation_date": 1715808306,
    "last_edit_date": 1716753708,
    "question_id": 78486592,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78486592/objectinputstream-readobject-java-io-invalidclassexception-java-util-hashmap",
    "title": "objectInputStream.readObject() java.io.InvalidClassException: java.util.HashMap; local class incompatible: stream classdesc with graalVM",
    "body": "<ul>\n<li>Include details about your goal:</li>\n</ul>\n<p>Use <code>return (Map&lt;?, ?&gt;) objectInputStream.readObject();</code> to get a Map without failing in graalVM native image.</p>\n<ul>\n<li>Show some code:</li>\n</ul>\n<p>The code is actually very simple. Just two files which can be copy pasted to your environment to reproduce.</p>\n<pre><code>private static Map&lt;?, ?&gt; getNormalizedMap(String encoded) {\n        try (var objectInputStream = new ObjectInputStream(new ByteArrayInputStream(Base64.getDecoder().decode(encoded)))) {\n            return (Map&lt;?, ?&gt;) objectInputStream.readObject(); // issue here !\n        } catch (IOException | ClassNotFoundException | IllegalArgumentException e) {\n            LOGGER.error(&quot;encoded={}&quot;, encoded, e);\n            return Map.of();\n        }\n    }\n</code></pre>\n<p>full file:</p>\n<pre class=\"lang-java prettyprint-override\"><code>import org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.io.ByteArrayInputStream;\nimport java.io.IOException;\nimport java.io.ObjectInputStream;\nimport java.util.Base64;\nimport java.util.Map;\n\n@RestController\n@SpringBootApplication\npublic class GraalissueApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(GraalissueApplication.class, args);\n    }\n\n    @GetMapping(&quot;/graalissue&quot;)\n    public String index() {\n        String base64encoded = &quot;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&quot;;\n        Map map = getNormalizedMap(base64encoded);\n        return &quot;It should be 41 here =&gt; &quot; + map.size();\n    }\n\n    private static Map&lt;?, ?&gt; getNormalizedMap(final String encoded) {\n        try (var objectInputStream = new ObjectInputStream(new ByteArrayInputStream(Base64.getDecoder().decode(encoded)))) {\n            return (Map&lt;?, ?&gt;) objectInputStream.readObject();\n        } catch (IOException | ClassNotFoundException | IllegalArgumentException e) {\n            e.printStackTrace();\n            return Map.of();\n        }\n    }\n\n}\n</code></pre>\n<p>pom:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n    &lt;parent&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;\n        &lt;version&gt;3.3.0&lt;/version&gt;\n        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;\n    &lt;/parent&gt;\n    &lt;groupId&gt;com.example&lt;/groupId&gt;\n    &lt;artifactId&gt;graalissue&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;name&gt;graalissue&lt;/name&gt;\n    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;\n    &lt;properties&gt;\n        &lt;java.version&gt;22&lt;/java.version&gt;\n    &lt;/properties&gt;\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n\n    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.graalvm.buildtools&lt;/groupId&gt;\n                &lt;artifactId&gt;native-maven-plugin&lt;/artifactId&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;\n                &lt;configuration&gt;\n                    &lt;image&gt;\n                        &lt;env&gt;\n                            &lt;BP_JVM_VERSION&gt;22&lt;/BP_JVM_VERSION&gt;\n                            &lt;BP_NATIVE_IMAGE_BUILD_ARGUMENTS&gt;-H:-AddAllFileSystemProviders&lt;/BP_NATIVE_IMAGE_BUILD_ARGUMENTS&gt;\n                        &lt;/env&gt;\n                    &lt;/image&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n\n&lt;/project&gt;\n\n</code></pre>\n<ul>\n<li>Describe expected results:</li>\n</ul>\n<p><code>return (Map&lt;?, ?&gt;) objectInputStream.readObject();</code> would return a correct map. In the case of this issue, the expected result should be</p>\n<ol>\n<li>just run mvn clean install and run the jar</li>\n<li>make a http request, <code>curl http://localhost:8080/graalissue</code></li>\n<li>expected output: &quot;It should be 41 here =&gt; 41&quot;</li>\n</ol>\n<p>I would expect to see &quot;It should be 41 here =&gt; 41&quot; for both native and non native image.</p>\n<ul>\n<li>Describe actual results:</li>\n</ul>\n<ol>\n<li>run <code>mvn -Pnative spring-boot:build-image</code> this would create the graalvm native image</li>\n<li><code>run docker tag docker.io/library/graalissue:0.0.1-SNAPSHOT graalissue:latest</code></li>\n<li><code>docker run -p 8080:8080 graalissue:latest</code></li>\n<li><code>curl http://localhost:8080/graalissue</code>\nThe output size will be 0.</li>\n</ol>\n<ul>\n<li>Include any error messages:</li>\n</ul>\n<p>It is failing with either</p>\n<ol>\n<li>asking for <code>java.util.Collections$UnmodifiableMap</code> to be added to <code>serialization-config.json</code></li>\n<li>if I add <code>java.util.Collections$UnmodifiableMap</code> to <code>serialization-config.json</code> (which I am not even sure is correct) I will get <code>java.io.InvalidClassException: java.util.HashMap; local class incompatible: stream classdesc </code></li>\n</ol>\n<p>If I am not adding anything to <code>serialization-config.json</code>, it will error, and the stack trace will ask me to add <code>java.util.Collections$UnmodifiableMap</code> to <code>serialization-config.json</code></p>\n<p>If I add it, I would get this stack trace:</p>\n<pre><code>java.io.InvalidClassException: java.util.HashMap; local class incompatible: stream classdesc serialVersionUID = 362498820763181265, local class serialVersionUID = -3563561681480877083\n        at java.base@22.0.1/java.io.ObjectStreamClass.initNonProxy(ObjectStreamClass.java:598)\n        at java.base@22.0.1/java.io.ObjectInputStream.readNonProxyDesc(ObjectInputStream.java:2063)\n        at java.base@22.0.1/java.io.ObjectInputStream.readClassDesc(ObjectInputStream.java:1912)\n        at java.base@22.0.1/java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2237)\n        at java.base@22.0.1/java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1747)\n        at java.base@22.0.1/java.io.ObjectInputStream$FieldValues.&lt;init&gt;(ObjectInputStream.java:2603)\n        at java.base@22.0.1/java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:2454)\n        at java.base@22.0.1/java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2269)\n        at java.base@22.0.1/java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1747)\n        at java.base@22.0.1/java.io.ObjectInputStream.readObject(ObjectInputStream.java:525)\n        at java.base@22.0.1/java.io.ObjectInputStream.readObject(ObjectInputStream.java:483)\n</code></pre>\n<ul>\n<li>Question:</li>\n</ul>\n<p>How to work around this issue?</p>\n<p>How to properly <code>return (Map&lt;?, ?&gt;) objectInputStream.readObject();</code> in graalVM native image, as the code in non native image has no issue at all?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}