{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "memory-leaks"
    ],
    "owner": {
      "account_id": 26726605,
      "reputation": 31,
      "user_id": 27869002,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/9317197557a403634769fa2735d805d7?s=256&d=identicon&r=PG",
      "display_name": "Dimon_yarik",
      "link": "https://stackoverflow.com/users/27869002/dimon-yarik"
    },
    "is_answered": false,
    "view_count": 176,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1755881368,
    "creation_date": 1755678615,
    "last_edit_date": 1755690148,
    "question_id": 79740821,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79740821/direct-memory-is-not-released-when-downloading-files",
    "title": "Direct memory is not released when downloading files",
    "body": "<p>I have encountered a memory management problem in a Spring Boot application, and would like to get advice on how to properly clean up direct memory.</p>\n<p>Configuration:</p>\n<ul>\n<li>JDK: OpenJDK Runtime Environment (build 21.0.8+9-Ubuntu-0ubuntu122.04.1), OpenJDK 64-Bit Server VM</li>\n<li>Spring Boot: Versions 3.2.6 - 3.4.6</li>\n</ul>\n<p>I have the following controller and service:</p>\n<pre><code>@RequiredArgsConstructor\n@RestController\npublic class MyEntityController {\n    private final MyEntityService service;\n\n    @PostMapping(&quot;/file&quot;)\n    public ResponseEntity&lt;String&gt; addedFileInVersion(MultipartHttpServletRequest request) throws IOException {\n        return service.addFileVersion(request);\n    }\n}\n\n@Service\n@Slf4j\n@RequiredArgsConstructor\npublic class MyEntityService {\n\n    @Transactional\n    public ResponseEntity&lt;String&gt; addFileVersion(MultipartHttpServletRequest request) throws IOException {\n        try {\n            log.info(&quot;Before reading : {} bytes&quot;, getDirectMemoryUsed());\n            MultipartFile file = request.getFile(&quot;file&quot;);\n            if (file == null) {\n                return ResponseEntity.badRequest().body(&quot;The file has not been transferred or the file is empty.&quot;);\n            }\n            byte[] array = file.getBytes();\n            String fileName = file.getOriginalFilename();\n            storeFile(array, fileName);\n            log.info(&quot;After reading : {} bytes&quot;, getDirectMemoryUsed());\n            return ResponseEntity.ok(&quot;ok&quot;);\n        } catch (IOException e) {\n            log.error(&quot;Error processing file&quot;, e);\n            return ResponseEntity.badRequest().body(&quot;Error when uploading file: &quot; + e.GetMessage());\n        } finally {\n            log.info(&quot;Finally reading : {} bytes&quot;, getDirectMemoryUsed());\n        }\n    }\n\n    private void storeFile(byte[] array, String path) throws IOException {\n        String decode = UriUtils.decode(path, StandardCharsets.UTF_8.toString());\n        synchronized (this) {\n            Path savedPath = Paths.get(&quot;/storage/tmp&quot;, decode);\n            if (Files.notExists(savedPath.getParent())) {\n                Files.createDirectories(savedPath.getParent());\n            }\n            Files.write(savedPath, array);\n        }\n    }\n\n    private double getDirectMemoryUsed() {\n        List&lt;BufferPoolMXBean&gt; bufferPoolMXBeans = ManagementFactory.getPlatformMXBeans(BufferPoolMXBean.class);\n        for (BufferPoolMXBean pool : bufferPoolMXBeans) {\n            if (&quot;direct&quot;.equals(pool.getName())) {\n                return pool.getMemoryUsed();\n            }\n        }\n        return 0;\n    }\n}\n</code></pre>\n<p>When sending files, I observe an increase in the use of direct memory, which does not decrease after processing the file. The logs show the following:</p>\n<div class=\"s-table-container\"><table class=\"s-table\">\n<thead>\n<tr>\n<th>Step</th>\n<th>Memory</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before reading</td>\n<td>24576.0 bytes</td>\n</tr>\n<tr>\n<td>After reading</td>\n<td>9.58496462E8 bytes</td>\n</tr>\n<tr>\n<td>Finally reading</td>\n<td>9.58496462E8 bytes</td>\n</tr>\n<tr>\n<td>Before reading</td>\n<td>9.58512846E8 bytes</td>\n</tr>\n<tr>\n<td>After reading</td>\n<td>1.916984732E9 bytes</td>\n</tr>\n<tr>\n<td>Finally reading</td>\n<td>1.916984732E9 bytes</td>\n</tr>\n</tbody>\n</table></div>\n<p>It can be seen that after processing the file, the direct memory is not released.</p>\n<p>I understand that using <code>file.getBytes()</code> (as well as <code>readAllBytes()</code>) is not an optimal solution for working with files, as it loads the entire file into memory. I also know that direct memory is located outside the JVM heap and is not directly managed by the garbage collector, and using Cleaner is not recommended in most cases.</p>\n<p>In this regard, I have a question: what are alternative and recommended approaches for processing files in Spring Boot in order to effectively manage direct memory and avoid problems with <code>OutOfMemoryError</code>?</p>\n<p>What strategies can be used instead of loading the entire file into memory, and how to properly free up direct memory in such scenarios?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}