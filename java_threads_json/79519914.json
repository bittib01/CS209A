{
  "question": {
    "tags": [
      "java",
      "amazon-sqs",
      "jsonserializer",
      "java-21",
      "message-listener"
    ],
    "owner": {
      "account_id": 2643205,
      "reputation": 435,
      "user_id": 2286446,
      "user_type": "registered",
      "accept_rate": 50,
      "profile_image": "https://i.sstatic.net/n1Mrf.jpg?s=256",
      "display_name": "Zoe",
      "link": "https://stackoverflow.com/users/2286446/zoe"
    },
    "is_answered": false,
    "view_count": 204,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1754570013,
    "creation_date": 1742380349,
    "last_edit_date": 1742383459,
    "question_id": 79519914,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79519914/java-21-sqs-listener-fails-to-parse-custom-object-sent-as-message",
    "title": "Java 21 SQS Listener Fails to Parse Custom Object Sent as Message",
    "body": "<p>I am upgrading a microservices-based system from Java 17 to Java 21, running on Spring Boot 3 and Spring Framework 6. My application sends a custom object (Event) to an AWS SQS queue, but my message listener expects a String. This worked fine in Java 17, but after upgrading, my listener fails to process the message due to a JSON parsing issue.</p>\n<p><strong>Problem</strong></p>\n<p>When sending an Event object using sqsTemplate.send(queueName, myEvent), the listener fails with the following exception:</p>\n<pre><code>Caused by: com.fasterxml.jackson.core.JsonParseException: Unrecognized token 'no': was expecting (JSON String, Number, Array, Object or token 'null', 'true' or 'false')\n at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 1, column: 3]\n    at com.fasterxml.jackson.core.JsonParser._constructError(JsonParser.java:2572)\n    at com.fasterxml.jackson.core.JsonParser._constructReadException(JsonParser.java:2598)\n    at com.fasterxml.jackson.core.JsonParser._constructReadException(JsonParser.java:2606)\n    at com.fasterxml.jackson.core.base.ParserMinimalBase._reportError(ParserMinimalBase.java:765)\n    at com.fasterxml.jackson.core.json.ReaderBasedJsonParser._reportInvalidToken(ReaderBasedJsonParser.java:3018)\n    at com.fasterxml.jackson.core.json.ReaderBasedJsonParser._reportInvalidToken(ReaderBasedJsonParser.java:2996)\n    at com.fasterxml.jackson.core.json.ReaderBasedJsonParser._matchToken(ReaderBasedJsonParser.java:2761)\n    at com.fasterxml.jackson.core.json.ReaderBasedJsonParser._matchNull(ReaderBasedJsonParser.java:2747)\n    at com.fasterxml.jackson.core.json.ReaderBasedJsonParser.nextToken(ReaderBasedJsonParser.java:750)\n    at com.fasterxml.jackson.databind.ObjectMapper._initForReading(ObjectMapper.java:4992)\n    at com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose(ObjectMapper.java:4898)\n    at com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3848)\n    at org.springframework.messaging.converter.MappingJackson2MessageConverter.convertFromInternal(MappingJackson2MessageConverter.java:251)\n    ... 27 common frames omitted\n</code></pre>\n<p>After debugging, I found that payload.toString() inside MappingJackson2MessageConverter returns something like:</p>\n<pre><code>no.com.common.Event@6f8e5dfd\n</code></pre>\n<p>instead of a JSON string representation.</p>\n<p><strong>Configuration Details</strong></p>\n<p><strong>SQS Listener &amp; Message Conversion:</strong></p>\n<pre><code>@SqsListener(value = &quot;${sqs.queue.event.in}&quot;, acknowledgementMode = SqsListenerAcknowledgementMode.MANUAL)\n    public void receiveHourEvent(Acknowledgement acknowledgement, String event){\nLOG.info(&quot;SQSListener triggered&quot;);\n}\n</code></pre>\n<pre><code>@Bean\nSqsMessageListenerContainerFactory&lt;Object&gt; defaultSqsListenerContainerFactory(SqsAsyncClient sqsAsyncClient,\n                                                                                  SqsMessagingMessageConverter sqsMessagingMessageConverter,\n                                                                                  SqsReceiverErrorHandler sqsReceiverErrorHandler,\n                                                                                  @Value(&quot;${sqs.poll.timeout}&quot;) Duration pollTimeout,\n                                                                                  @Value(&quot;${sqs.poll.messagevisibility}&quot;) Duration pollMessageVisibility) {\n    return SqsMessageListenerContainerFactory\n            .builder()\n            .configure(options -&gt; options\n                    .maxMessagesPerPoll(10)\n                    .pollTimeout(pollTimeout)\n                    .messageVisibility(pollMessageVisibility)\n                    .messageConverter(sqsMessagingMessageConverter))\n            .sqsAsyncClient(sqsAsyncClient)\n            .messageInterceptor(new BreadcrumbMessageInterceptor())\n            .errorHandler(sqsReceiverErrorHandler)\n            .build();\n}\n\n@Bean\nSqsTemplate sqsTemplate(SqsAsyncClient sqsAsyncClient, SqsMessagingMessageConverter sqsMessagingMessageConverter) {\n    SqsTemplate sqsTemplate = SqsTemplate.builder()\n            .sqsAsyncClient(sqsAsyncClient)\n            .messageConverter(sqsMessagingMessageConverter)\n            .build();\n    return sqsTemplate;\n}\n\n@Bean\npublic SqsMessagingMessageConverter sqsMessagingMessageConverter(SqsExtendedClient sqsExtendedClient) {\n    ExtendedSqsMessagingMessageConverter converter = new ExtendedSqsMessagingMessageConverter(sqsExtendedClient);\n    converter.setObjectMapper(JsonMappers.getObjectMapper());\n    return converter;\n}\n\n</code></pre>\n<pre><code>private static ObjectMapper initializeMapper() {\n            final ObjectMapper mapper = new ObjectMapper();\n            mapper.setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY)\n                    .setVisibility(PropertyAccessor.GETTER, JsonAutoDetect.Visibility.NONE)\n                    .setVisibility(PropertyAccessor.IS_GETTER, JsonAutoDetect.Visibility.NONE);\n\n            mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);\n            mapper.registerModule(new JavaTimeModule());\n            mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n            mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);\n            mapper.configure(DeserializationFeature.READ_UNKNOWN_ENUM_VALUES_AS_NULL, true);\n            mapper.disable(SerializationFeature.WRITE_DATE_KEYS_AS_TIMESTAMPS);\n            mapper.configure(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES, true);\n\n            return mapper;\n}\n\npublic static &lt;T&gt; T fromJson(String text, Class&lt;T&gt; type) {\n    try {\n        return getObjectMapper().readValue(text, type);\n    } catch (IOException e) {\n        throw new RuntimeException(e);\n    }\n}\n\npublic static &lt;T&gt; String toJson(T value) {\n    try {\n        return getObjectMapper().writeValueAsString(value);\n     } catch (IOException e) {\n        throw new RuntimeException(e);\n     }\n}\n\n</code></pre>\n<p><strong>Event Object:</strong></p>\n<pre><code>public class Event {\n    String eventName;\n    Instant dateTime;\n}\n</code></pre>\n<p>I use sqsTemplate to send it and in my code it looks like this:</p>\n<pre><code>sqsTemplate.send(queueName, myEvent);\n</code></pre>\n<p>I have verified that toJson(myEvent) properly serializes the object when called manually. I have ensured that sqsMessagingMessageConverter is set correctly in SqsTemplate. After debugging I see that payload.toString() inside MappingJackson2MessageConverter returns an object reference instead of a JSON string.</p>\n<pre><code>return this.objectMapper.readValue(payload.toString(), javaType)\n</code></pre>\n<p>I am using following dependencies:</p>\n<pre><code>&lt;!--JSON serialization--&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;com.fasterxml.jackson.datatype&lt;/groupId&gt;\n        &lt;artifactId&gt;jackson-datatype-jsr310&lt;/artifactId&gt;\n        &lt;version&gt;2.17.2&lt;/version&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;\n        &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;\n        &lt;version&gt;2.17.2&lt;/version&gt;\n    &lt;/dependency&gt;\n</code></pre>\n<p>Why is the payload being treated as an object reference instead of a JSON string? Is there something missing in my ObjectMapper configuration, or do I need to adjust how SqsMessagingMessageConverter is handling serialization?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}