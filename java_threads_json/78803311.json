{
  "question": {
    "tags": [
      "java",
      "lombok",
      "java-module",
      "annotation-processing"
    ],
    "owner": {
      "account_id": 32812647,
      "reputation": 29,
      "user_id": 25499090,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/21cfaad28296fcd89d2789ba39795524?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Photon",
      "link": "https://stackoverflow.com/users/25499090/photon"
    },
    "is_answered": true,
    "view_count": 186,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1725288511,
    "creation_date": 1722155756,
    "last_edit_date": 1722237338,
    "question_id": 78803311,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78803311/a-method-to-open-jdk-compile-from-the-lombok-source",
    "title": "A method to open jdk.compile from the lombok source",
    "body": "<p>I referenced <a href=\"https://github.com/projectlombok/lombok/commit/9806e5cca4b449159ad0509dafde81951b8a8523\" rel=\"nofollow noreferrer\">lombok</a>.'s method of opening jdk.compile in jdk21,which opens jdk.complie at the initialization stage of the annotation processor</p>\n<pre><code>    private static void addOpensForLombok() {\n        Class&lt;?&gt; cModule;\n        try {\n            cModule = Class.forName(&quot;java.lang.Module&quot;);\n        } catch (ClassNotFoundException e) {\n            return; //jdk8-; this is not needed.\n        }\n\n        Unsafe unsafe = getUnsafe();\n        Object jdkCompilerModule = getJdkCompilerModule();\n        Object ownModule = getOwnModule();\n        String[] allPkgs = {\n            &quot;com.sun.tools.javac.code&quot;,\n            &quot;com.sun.tools.javac.comp&quot;,\n            &quot;com.sun.tools.javac.file&quot;,\n            &quot;com.sun.tools.javac.main&quot;,\n            &quot;com.sun.tools.javac.model&quot;,\n            &quot;com.sun.tools.javac.parser&quot;,\n            &quot;com.sun.tools.javac.processing&quot;,\n            &quot;com.sun.tools.javac.tree&quot;,\n            &quot;com.sun.tools.javac.util&quot;,\n            &quot;com.sun.tools.javac.jvm&quot;,\n        };\n\n        try {\n            Method m = cModule.getDeclaredMethod(&quot;implAddOpens&quot;, String.class, cModule);\n            long firstFieldOffset = getFirstFieldOffset(unsafe);\n            unsafe.putBooleanVolatile(m, firstFieldOffset, true);\n            for (String p : allPkgs) m.invoke(jdkCompilerModule, p, ownModule);\n        } catch (Exception ignore) {}\n    }\n</code></pre>\n<p>I use the <code>maven clear install</code> command to package the annotation processor into a jar file. Apply this annotation processor to other projects. Other projects compile with an error</p>\n<pre><code> class org.example.async.log.client.annotation.AsyncLogProcessor (in unnamed module @0x201c3cda) cannot access class com.sun.tools.javac.api.JavacTrees (in module jdk.compiler) because module jdk.compiler does not export com.sun.tools.javac.api to unnamed module @0x201c3cda\n\n</code></pre>\n<p>I debugged the compilation process through IDEA. I found that the getOwnModule method returns the unnamed module\n<a href=\"https://i.sstatic.net/8MYAW55T.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/8MYAW55T.png\" alt=\"enter image description here\" /></a></p>\n<pre><code>    private static Object getOwnModule() {\n        try {\n            Method m = Permit.getMethod(Class.class, &quot;getModule&quot;);\n            return m.invoke(LombokProcessor.class);\n        } catch (Exception e) {\n            return null;\n        }\n    }\n</code></pre>\n<p>This method will get the unnamed module when other projects that depend on the annotation processor.</p>\n<pre><code>        try {\n            Method m = cModule.getDeclaredMethod(&quot;implAddOpens&quot;, String.class, cModule);\n            long firstFieldOffset = getFirstFieldOffset(unsafe);\n            unsafe.putBooleanVolatile(m, firstFieldOffset, true);\n            for (String p : allPkgs) m.invoke(jdkCompilerModule, p, ownModule);\n        } catch (Exception ignore) {}\n</code></pre>\n<p><code>implAddOpens</code> cannot open jdk.compile for unname module</p>\n<pre><code>    private void implAddExportsOrOpens(String pn,\n                                       Module other,\n                                       boolean open,\n                                       boolean syncVM) {\n        Objects.requireNonNull(other);\n        Objects.requireNonNull(pn);\n\n        // all packages are open in unnamed, open, and automatic modules\n        if (!isNamed() || descriptor.isOpen() || descriptor.isAutomatic())\n            return;\n</code></pre>\n<p>This means that the jdk.compile was not opened successfully.However, I have added module-info.java in my project</p>\n<pre><code>import javax.annotation.processing.Processor;\nimport org.example.async.log.client.annotation.AsyncLogProcessor;\n\nmodule org.example.async.log.client{\n    requires jdk.compiler;\n    requires jdk.unsupported;\n\n    exports org.example.async.log.client.annotation;\n    provides Processor with AsyncLogProcessor;\n}\n</code></pre>\n<p>The project of annotation processor is <a href=\"https://github.com/severous/async-log\" rel=\"nofollow noreferrer\">here</a></p>\n<p>Test projects that depend on the annotation processor are <a href=\"https://github.com/severous/async-log-test\" rel=\"nofollow noreferrer\">here</a></p>\n<hr />\n<p><strong>Update</strong>: According to the answer of Naman, I conduct the following experiments.</p>\n<h3>remove it from <code>&lt;annotationProcessorPaths&gt;</code></h3>\n<p>I removed the custom annotation processor in the <code>&lt;annotationProcessorPaths&gt;</code></p>\n<pre><code>    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;\n                &lt;version&gt;3.13.0&lt;/version&gt;\n                &lt;configuration&gt;\n                    &lt;source&gt;21&lt;/source&gt;\n                    &lt;target&gt;21&lt;/target&gt;\n                    &lt;encoding&gt;UTF-8&lt;/encoding&gt;\n                    &lt;compilerArgs&gt;\n                        &lt;arg&gt;-proc:full&lt;/arg&gt;\n                        &lt;arg&gt;-Xlint:all&lt;/arg&gt;\n                        &lt;arg&gt;-verbose&lt;/arg&gt;\n                        &lt;arg&gt;-XprintRounds&lt;/arg&gt;\n                        &lt;arg&gt;-XprintProcessorInfo&lt;/arg&gt;\n                        &lt;arg&gt;-Xmaxerrs&lt;/arg&gt;\n                        &lt;arg&gt;10000&lt;/arg&gt;\n                    &lt;/compilerArgs&gt;\n                    &lt;annotationProcessorPaths&gt;\n                        &lt;path&gt;\n                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;\n                            &lt;version&gt;${lombok.version}&lt;/version&gt;\n                        &lt;/path&gt;\n\n&lt;!--                        &lt;path&gt;--&gt;\n&lt;!--                            &lt;groupId&gt;org.example&lt;/groupId&gt;--&gt;\n&lt;!--                            &lt;artifactId&gt;async-log-client&lt;/artifactId&gt;--&gt;\n&lt;!--                            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;--&gt;\n&lt;!--                        &lt;/path&gt;--&gt;\n\n                    &lt;/annotationProcessorPaths&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n</code></pre>\n<p>However, this causes the custom annotator to not work. Although the compilation succeeded, the custom annotation processor compilation phase was skipped straight away</p>\n<p>If both lombok and my custom annotation processor are removed, the compilation will report an error</p>\n<pre><code>class org.example.async.log.client.annotation.AsyncLogProcessor (in unnamed module @0x36359723) cannot access class com.sun.tools.javac.api.JavacTrees (in module jdk.compiler) because module jdk.compiler does not export com.sun.tools.javac.api to unnamed module @0x36359723\n</code></pre>\n<p>The git branch is <a href=\"https://github.com/severous/async-log-test/tree/annotaionProcessorPathRemove\" rel=\"nofollow noreferrer\">here</a></p>\n<h3>Use the jvm parameter to open jdk.compile instead of using code</h3>\n<p>I removed module-info.java from the annotation processor.</p>\n<pre><code>    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;\n                &lt;version&gt;3.13.0&lt;/version&gt;\n                &lt;configuration&gt;\n                    &lt;source&gt;21&lt;/source&gt;\n                    &lt;target&gt;21&lt;/target&gt;\n                    &lt;encoding&gt;UTF-8&lt;/encoding&gt;\n                    &lt;compilerArgs&gt;\n                        &lt;arg&gt;-proc:full&lt;/arg&gt;\n                        &lt;arg&gt;-Xlint:all&lt;/arg&gt;\n                        &lt;arg&gt;-verbose&lt;/arg&gt;\n                        &lt;arg&gt;-XprintRounds&lt;/arg&gt;\n                        &lt;arg&gt;-XprintProcessorInfo&lt;/arg&gt;\n                        &lt;arg&gt;-Xmaxerrs&lt;/arg&gt;\n                        &lt;arg&gt;10000&lt;/arg&gt;\n\n                        &lt;arg&gt;-J--add-opens=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED&lt;/arg&gt;\n                        &lt;arg&gt;-J--add-opens=jdk.compiler/com.sun.tools.javac.comp=ALL-UNNAMED&lt;/arg&gt;\n                        &lt;arg&gt;-J--add-opens=jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED&lt;/arg&gt;\n                        &lt;arg&gt;-J--add-opens=jdk.compiler/com.sun.tools.javac.main=ALL-UNNAMED&lt;/arg&gt;\n                        &lt;arg&gt;-J--add-opens=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED&lt;/arg&gt;\n                        &lt;arg&gt;-J--add-opens=jdk.compiler/com.sun.tools.javac.parser=ALL-UNNAMED&lt;/arg&gt;\n                        &lt;arg&gt;-J--add-opens=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED&lt;/arg&gt;\n                        &lt;arg&gt;-J--add-opens=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED&lt;/arg&gt;\n                        &lt;arg&gt;-J--add-opens=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED&lt;/arg&gt;\n                        &lt;arg&gt;-J--add-opens=jdk.compiler/com.sun.tools.javac.jvm=ALL-UNNAMED&lt;/arg&gt;\n                        &lt;arg&gt;-J--add-opens=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED&lt;/arg&gt;\n                    &lt;/compilerArgs&gt;\n                    &lt;annotationProcessorPaths&gt;\n                        &lt;path&gt;\n                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;\n                            &lt;version&gt;${lombok.version}&lt;/version&gt;\n                        &lt;/path&gt;\n\n                        &lt;path&gt;\n                            &lt;groupId&gt;org.example&lt;/groupId&gt;\n                            &lt;artifactId&gt;async-log-client&lt;/artifactId&gt;\n                            &lt;version&gt;1.1-SNAPSHOT&lt;/version&gt;\n                        &lt;/path&gt;\n\n                    &lt;/annotationProcessorPaths&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n\n</code></pre>\n<p>The error still happened.</p>\n<pre><code>: java.lang.IllegalAccessError: class org.example.async.log.client.annotation.AsyncLogProcessor (in unnamed module @0x77429040) cannot access class com.sun.tools.javac.api.JavacTrees (in module jdk.compiler) because module jdk.compiler does not export com.sun.tools.javac.api to unnamed module @0x77429040\n</code></pre>\n<p>To this I added <code>&lt;fork&gt;true&lt;fork&gt;</code> referenced by <a href=\"https://github.com/projectlombok/lombok/issues/2681#issuecomment-748616687\" rel=\"nofollow noreferrer\">here</a>. when I remove lombok, the error still happens. whenn I don't remove lombok, my annotation processor is skiped</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}