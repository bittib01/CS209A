{
  "question": {
    "tags": [
      "java",
      "deserialization",
      "avro"
    ],
    "owner": {
      "account_id": 5588652,
      "reputation": 501,
      "user_id": 4428547,
      "user_type": "registered",
      "accept_rate": 75,
      "profile_image": "https://i.sstatic.net/z7BgN.png?s=256",
      "display_name": "Kris",
      "link": "https://stackoverflow.com/users/4428547/kris"
    },
    "is_answered": false,
    "view_count": 224,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1735290695,
    "creation_date": 1732275606,
    "last_edit_date": 1732373015,
    "question_id": 79214851,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79214851/avrotypeexception-found-string-expecting-union-when-consuming-kafka-message",
    "title": "AvroTypeException: Found string, expecting union when consuming Kafka Message",
    "body": "<h1>Context</h1>\n<p>I write you this message because I have a deserialization error when consuming a Kafka Topic, raised by  io.confluent.kafka.serializers.KafkaAvroDeserializer.java.\nBelow are relevant versions used in my Spring JAVA project :</p>\n<pre><code>    &lt;dependency&gt;\n        &lt;groupId&gt;org.apache.avro&lt;/groupId&gt;\n        &lt;artifactId&gt;avro&lt;/artifactId&gt;\n        &lt;version&gt;1.10.1&lt;/version&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;io.confluent&lt;/groupId&gt;\n        &lt;artifactId&gt;kafka-avro-serializer&lt;/artifactId&gt;\n        &lt;version&gt;7.2.1&lt;/version&gt;\n    &lt;/dependency&gt;\n</code></pre>\n<p>Not the latest versions, but the same dependencies are also used for consuming other topics in production and the other consumptions work well.</p>\n<h1>The Problem</h1>\n<p>The error is:</p>\n<blockquote>\n<p>Caused by: org.apache.avro.AvroTypeException: Found string, expecting union\nat org.apache.avro.io.ResolvingDecoder.doAction(ResolvingDecoder.java:308)\nat org.apache.avro.io.parsing.Parser.advance(Parser.java:86)\nat org.apache.avro.io.ResolvingDecoder.readIndex(ResolvingDecoder.java:275)\nat org.apache.avro.generic.GenericDatumReader.readWithoutConversion(GenericDatumReader.java:187)</p>\n</blockquote>\n<p>In the message sent into the topic, all the fields contain a non empty string.\nA teamate suggested to add default:&quot;&quot; in each field definition.</p>\n<blockquote>\n<pre><code>{\n  &quot;name&quot;: &quot;namespace_Fld1&quot;,\n  &quot;type&quot;: [\n    &quot;string&quot;,\n    &quot;null&quot;\n  ],\n  &quot;default&quot;: &quot;&quot;\n},\n</code></pre>\n</blockquote>\n<p>But not sure if it will resolve this issue, because there're no empty fields in the message.</p>\n<p>Maybe there a difference in writer's schema</p>\n<pre><code>{&quot;type&quot;:&quot;record&quot;,\n&quot;name&quot;:&quot;myClassName&quot;,\n&quot;namespace&quot;:&quot;fr.laposte.bdl.bscc.myClassName&quot;,\n&quot;fields&quot;:\n[\n         {&quot;name&quot;:&quot;namespace_Fld1&quot;,\n        &quot;type&quot;:[&quot;string&quot;,&quot;null&quot;]},\n        {&quot;name&quot;:&quot;namespace_Fld2&quot;,\n        &quot;type&quot;:[&quot;string&quot;,&quot;null&quot;]},\n        {&quot;name&quot;:&quot;namespace_Fld3&quot;,\n        &quot;type&quot;:[&quot;string&quot;,&quot;null&quot;]},\n        {&quot;name&quot;:&quot;namespace_Fld4&quot;,\n        &quot;type&quot;:[&quot;string&quot;,&quot;null&quot;]},\n        {&quot;name&quot;:&quot;namespace_Fld5&quot;,\n        &quot;type&quot;:[&quot;string&quot;,&quot;null&quot;]},\n        {&quot;name&quot;:&quot;namespace_Fld6&quot;,\n        &quot;type&quot;:[&quot;string&quot;,&quot;null&quot;]},\n        {&quot;name&quot;:&quot;namespace_Fld7&quot;,\n        &quot;type&quot;:[&quot;string&quot;,&quot;null&quot;]},\n        {&quot;name&quot;:&quot;namespace_Fld8&quot;,\n        &quot;type&quot;:[&quot;string&quot;,&quot;null&quot;]},\n        {&quot;name&quot;:&quot;namespace_Fld9&quot;,\n        &quot;type&quot;:[&quot;string&quot;,&quot;null&quot;]}\n],\n&quot;default&quot;:null\n}\n</code></pre>\n<p>And here is my reader's schema:</p>\n<pre><code>  &quot;type&quot;: &quot;record&quot;,\n  &quot;name&quot;: &quot;myClassName&quot;,\n  &quot;namespace&quot;: &quot;fr.laposte.bdl.bscc.myClassName&quot;,\n  &quot;fields&quot;: [\n    {\n      &quot;name&quot;: &quot;namespace_Fld4&quot;,\n      &quot;type&quot;: [\n        &quot;string&quot;,\n        &quot;null&quot;\n      ]\n    },\n    {\n      &quot;name&quot;: &quot;namespace_Fld5&quot;,\n      &quot;type&quot;: [\n        &quot;string&quot;,\n        &quot;null&quot;\n      ]\n    },\n    {\n      &quot;name&quot;: &quot;namespace_Fld7&quot;,\n      &quot;type&quot;: [\n        &quot;int&quot;,\n        &quot;null&quot;\n      ]\n    },\n    {\n      &quot;name&quot;: &quot;namespace_Fld8&quot;,\n      &quot;type&quot;: [\n        &quot;string&quot;,\n        &quot;null&quot;\n      ]\n    }\n  ]\n}\n</code></pre>\n<p>In reader's schema the order of fields is not the same.\nHere I read it could be important : <a href=\"https://avro.apache.org/docs/1.8.2/spec.html#binary_encode_complex\" rel=\"nofollow noreferrer\">https://avro.apache.org/docs/1.8.2/spec.html#binary_encode_complex</a></p>\n<p>Also previous versions of the schema had been published and then deleted by the team who sends me message.</p>\n<h1>Questions</h1>\n<ul>\n<li><strong>Should my reader schema be updated in any way ?</strong></li>\n<li><strong>Could there be a problem with Avro cache ?</strong></li>\n<li><strong>Should something be done with my AVRO reader'sschema ?</strong></li>\n</ul>\n<p><strong>Useful articles about schema registry:</strong></p>\n<ul>\n<li><a href=\"https://dzone.com/articles/kafka-avro-serialization-and-the-schema-registry\" rel=\"nofollow noreferrer\">https://dzone.com/articles/kafka-avro-serialization-and-the-schema-registry</a></li>\n<li><a href=\"https://blog.knoldus.com/error-registering-avro-schema-multiple-schemas-in-one-topic/#schema-compatibility-in-kafka\" rel=\"nofollow noreferrer\">https://blog.knoldus.com/error-registering-avro-schema-multiple-schemas-in-one-topic/#schema-compatibility-in-kafka</a></li>\n</ul>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}