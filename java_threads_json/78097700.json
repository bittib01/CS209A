{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "keycloak"
    ],
    "owner": {
      "account_id": 1509736,
      "reputation": 712,
      "user_id": 1412161,
      "user_type": "registered",
      "accept_rate": 86,
      "profile_image": "https://www.gravatar.com/avatar/7c1f4a477237b0347c332481e157744e?s=256&d=identicon&r=PG",
      "display_name": "grange",
      "link": "https://stackoverflow.com/users/1412161/grange"
    },
    "is_answered": true,
    "view_count": 1028,
    "accepted_answer_id": 78097810,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1738380589,
    "creation_date": 1709494513,
    "last_edit_date": 1709496682,
    "question_id": 78097700,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78097700/spring-boot-with-react-and-keycloak-redirect-to-keycloaks-login-page-fails-due",
    "title": "Spring Boot with React and Keycloak: redirect to Keycloak&#39;s login page fails due to CORS error (no Access-Control-Allow-Origin header set)",
    "body": "<p>I'm working on the following setup:</p>\n<ul>\n<li>Frontend: React on localhost:3000</li>\n<li>Backend: Spring Boot on localhost:8080</li>\n<li>OIDC endpoint: Keycloak 21+ as Docker container (tried different\nversions) on localhost:8090</li>\n</ul>\n<p>As I'm a backend dev and have little to no experience with React, I wanted to let Spring handle all the authentication and authorization against Keycloak. Thus, I've configured:</p>\n<pre><code>spring:\n  security:\n  oauth2:\n    client:\n      registration:\n        keycloak:\n          clientId: &lt;my id&gt;\n          clientSecret: &lt;my secret&gt;\n          scope: openid\n      provider:\n        keycloak:\n          issuerUri: &lt;my issuer uri&gt;\n          user-name-attribute: preferred_username\n</code></pre>\n<p>and set the oauth2 config:</p>\n<pre><code>@Bean\npublic SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n\n    return http\n            .csrf(Customizer.withDefaults())\n            .cors(Customizer.withDefaults())\n            .exceptionHandling(customizer -&gt; customizer.accessDeniedHandler(customAccessDeniedHandler()))\n            .authorizeHttpRequests((customizer) -&gt; customizer.requestMatchers(\n                        &quot;/oauth2/login&quot;,\n                        &quot;/oauth2/logout/success&quot;,\n                        &quot;/oauth2/error&quot;,\n                        \n                ).permitAll()\n                .anyRequest().authenticated()\n            ).oauth2Login(configurer -&gt; {\n                configurer.userInfoEndpoint(customizer -&gt; customizer.userAuthoritiesMapper(customGrantedAuthoritiesMapper()));\n                configurer.loginPage(&quot;/oauth2/login&quot;);\n                configurer.defaultSuccessUrl(&quot;/oauth2/success&quot;);\n                configurer.failureUrl(&quot;/oauth2/error&quot;);\n            });\n}\n</code></pre>\n<p>When I access some protected endpoint (let's say /api/test) from React, Spring sends a redirect (per Location-header) to</p>\n<blockquote>\n<p>http://localhost:8080/oauth2/login</p>\n</blockquote>\n<p>which then redirects to</p>\n<blockquote>\n<p>http://localhost:8080/oauth2/authorization/keycloak</p>\n</blockquote>\n<p>which redirects to Keycloak on</p>\n<blockquote>\n<p>http://localhost:8090/realms/my-realm/protocol/openid-connect/auth?response_type=code&amp;client_id=my-client-id&amp;scope=openid&amp;state=my-state&amp;redirect_uri=http://localhost:8086/login/oauth2/code/keycloak&amp;nonce=my-nonce*</p>\n</blockquote>\n<p>When calling it directly from the browser, it works fine and I see the login form, can login and access my protected resources afterwards with the right roles set into the principal. But as soon as the request's origin is my frontend webapp, the last redirect to Keycloak fails because of missing CORS header Access-Control-Allow-Origin.</p>\n<p>Of course I followed the manual and set the valid resource urls as well as web origins inside Keycloak's client settings. But nothing worked, I tried to</p>\n<ul>\n<li>set the frontend url without trailing slashes</li>\n<li>set + and added http://localhost:3000/* to the valid redirect urls</li>\n<li>set * as a test, even though it would open security loopholes</li>\n</ul>\n<p>Nothing worked, I tried multiple solutions like those on <a href=\"https://stackoverflow.com/questions/45051923/keycloak-angular-no-access-control-allow-origin-header-is-present\">StackOverflow</a>, <a href=\"https://keycloak.discourse.group/t/access-control-allow-origin-header-missing/328\" rel=\"nofollow noreferrer\">Discourse (1)</a>, <a href=\"https://keycloak.discourse.group/t/keycloak-preflight-missing-allow-origin-header/7940\" rel=\"nofollow noreferrer\">Discourse (2)</a> and multiple others, but to no avail. Unfortunately Keycloak changed a bit in the past (of course), so most articles are outdated. But finally I've stumbled upon <a href=\"https://github.com/jangaraj/keycloak-cors-issue-debugging?tab=readme-ov-file\" rel=\"nofollow noreferrer\">this resource</a> saying in point 7 that this CORS error indicates &quot;wrong backend/API implementation or used flow&quot;.</p>\n<p>So long story short: has anyone managed to get it running like described? Should I change my architecture to let React handle the authentication with Keycloak, sending JWT token to Spring instead?</p>\n<p>Thank you very much for your opinions and insights.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}