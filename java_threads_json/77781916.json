{
  "question": {
    "tags": [
      "java",
      "minecraft",
      "packet"
    ],
    "owner": {
      "account_id": 29205155,
      "reputation": 3,
      "user_id": 22437483,
      "user_type": "registered",
      "profile_image": "https://lh3.googleusercontent.com/a/AAcHTteyLU4P5Vi2MQW5nt8q1RDHYOH97_9gZ-CJrBBQ6HXdaA=k-s256",
      "display_name": "Lite Mix-Ray",
      "link": "https://stackoverflow.com/users/22437483/lite-mix-ray"
    },
    "is_answered": true,
    "view_count": 193,
    "accepted_answer_id": 79206283,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1732089433,
    "creation_date": 1704731519,
    "question_id": 77781916,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/77781916/minecraft-server-returns-error-after-sending-loginstart-packet",
    "title": "Minecraft server returns error after sending LoginStart packet",
    "body": "<p>I'm trying to send a LoginStart packet, but the server responds with an error.</p>\n<p>The entire server response:\n<code>�{&quot;translate&quot;:&quot;disconnect.genericReason&quot;,&quot;with&quot;:[&quot;Internal Exception: io.netty.handler.codec.DecoderException: java.lang.IndexOutOfBoundsException: readerIndex(27) + length(8) exceeds writerIndex(34): PooledUnsafeDirectByteBuf(ridx: 27, widx: 34, cap: 34)&quot;]}</code></p>\n<p><strong>MinecraftPlayer</strong> class that starting connection:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class MinecraftPlayer {\n    public Socket sock;\n\n    public DataOutputStream output;\n    public DataInputStream input;\n\n    public MinecraftServer server;\n\n    public UUID uuid;\n    public String name;\n\n    public MinecraftPlayer(MinecraftServer server, UUID uuid, String name) {\n        this.server = server;\n        this.uuid = uuid;\n        this.name = name;\n    }\n\n    public void startConnection() {\n        new Thread(() -&gt; {\n            try {\n                this.sock = new Socket();\n\n                sock.connect(server.host);\n\n                this.output = new DataOutputStream(sock.getOutputStream());\n                this.input = new DataInputStream(sock.getInputStream());\n\n                // Отправляем handshake\n                sendHandshake();\n\n                // Отправляем пакет login start\n                sendLoginStartPacket();\n\n                // Читаем ответ от сервера\n                if (readLoginSuccessPacket()) {\n                    System.out.println(&quot;Login Successful!&quot;);\n                } else {\n                    System.out.println(&quot;Login Failed!&quot;);\n                }\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        }).start();\n    }\n\n    private void sendHandshake() throws IOException {\n//        System.out.println(&quot;send handshake&quot;);\n\n        OutputPacketContainer packet = new OutputPacketContainer((byte) 0x00);\n\n        packet.writeVarInt(server.protocol_version); // Protocol version\n        packet.writeString(server.host.getHostString()); // Server address\n        packet.writeShort((short) server.host.getPort()); // Server port as// unsigned short\n        packet.writeVarInt(2); // Next state (2 for login)\n\n        packet.sendPacket(this);\n    }\n\n    private void sendLoginStartPacket() throws IOException {\n//        System.out.println(&quot;send login start&quot;);\n\n        OutputPacketContainer packet = new OutputPacketContainer((byte) 0x00);\n\n        packet.writeString(name);\n        packet.writeUUID(uuid);\n\n        packet.sendPacket(this);\n    }\n\n    private boolean readLoginSuccessPacket() throws IOException {\n        int length = readVarInt(input);\n        int packetId = readVarInt(input);\n\n        if (packetId == 0x02) { // Packet ID for login success\n            UUID uuid = new UUID(input.readLong(), input.readLong()); // UUID is received\n            String username = readString(input); // Username is received as String\n            System.out.println(&quot;UUID: &quot; + uuid + &quot;, Username: &quot; + username);\n            return true;\n        } else if (packetId == 0x00) {\n            Main.logInputPacket(length, packetId, input.readAllBytes());\n//            System.out.println((String)((List&lt;Object&gt;)((Map&lt;String,Object&gt;)JSON.load(readString(input))).get(&quot;with&quot;)).get(0));\n        }\n        return false;\n    }\n\n    private int readVarInt(DataInputStream in) throws IOException {\n        int value = 0;\n        int bitOffset = 0;\n        byte b;\n        do {\n            b = in.readByte();\n            value |= (b &amp; 127) &lt;&lt; bitOffset;\n            bitOffset += 7;\n        } while ((b &amp; 128) == 128);\n        return value;\n    }\n\n    private String readString(DataInputStream in) throws IOException {\n        int length = readVarInt(in); // Length of string\n        byte[] bytes = new byte[length];\n        in.readFully(bytes); // Read string bytes\n        return new String(bytes, StandardCharsets.UTF_8); // Create string\n    }\n}\n</code></pre>\n<p><strong>OutputPacketContainer</strong> class that creates packet:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class OutputPacketContainer {\n    private ByteArrayOutputStream buffer;\n    private DataOutputStream output;\n    private byte packet_id;\n\n    public OutputPacketContainer(byte packet_id) {\n        this.packet_id = packet_id;\n\n        buffer = new ByteArrayOutputStream();\n        output = new DataOutputStream(buffer);\n\n        writeVarInt(packet_id);\n    }\n\n    public ByteArrayOutputStream getBuffer() {\n        return buffer;\n    }\n\n    public DataOutputStream getOutput() {\n        return output;\n    }\n\n    public byte getPacketId() {\n        return packet_id;\n    }\n\n    public void writeByte(byte v) {\n        try {\n            output.writeByte(v);\n        } catch (IOException e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    public void writeShort(short v) {\n        try {\n            output.writeShort(v);\n        } catch (IOException e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    public void writeString(String v, Charset charset) {\n        byte[] bytes = v.getBytes(charset);\n        writeVarInt(bytes.length);\n        writeBytes(bytes);\n    }\n\n    public void writeString(String v) {\n        writeString(v,StandardCharsets.UTF_8);\n    }\n\n    public void writeVarInt(int v) {\n        writeVarInt(output,v);\n    }\n\n    public void writeVarLong(long v) {\n        writeVarLong(output,v);\n    }\n\n    public void writeBytes(byte[] v) {\n        try {\n            output.write(v);\n        } catch (IOException e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    public void writeUUID(UUID v) {\n        try {\n            output.writeLong(v.getMostSignificantBits());\n            output.writeLong(v.getLeastSignificantBits());\n        } catch (IOException e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    public void sendPacket(MinecraftPlayer player) {\n        byte[] message = buffer.toByteArray();\n        try {\n            writeVarInt(player.output, message.length);\n            player.output.write(message);\n            player.output.flush();\n\n            Main.logOutputPacket(message.length, packet_id, message);\n        } catch (IOException e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    private static final int SEGMENT_BITS = 0x7F;\n    private static final int CONTINUE_BIT = 0x80;\n\n    private static void writeVarInt(DataOutputStream output, int v) {\n        try {\n            while (true) {\n                if ((v &amp; ~SEGMENT_BITS) == 0) {\n                    output.writeByte(v);\n                    return;\n                }\n\n                output.writeByte((v &amp; SEGMENT_BITS) | CONTINUE_BIT);\n\n                // Note: &gt;&gt;&gt; means that the sign bit is shifted with the rest of the number rather than being left alone\n                v &gt;&gt;&gt;= 7;\n            }\n        } catch (IOException e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    private static void writeVarLong(DataOutputStream output, long v) {\n        try {\n            while (true) {\n                if ((v &amp; ~((long) SEGMENT_BITS)) == 0) {\n                    output.writeByte((int) v);\n                    return;\n                }\n\n                output.writeByte((int) ((v &amp; SEGMENT_BITS) | CONTINUE_BIT));\n\n                // Note: &gt;&gt;&gt; means that the sign bit is shifted with the rest of the number rather than being left alone\n                v &gt;&gt;&gt;= 7;\n            }\n        } catch (IOException e) {\n            throw new RuntimeException(e);\n        }\n    }\n}\n</code></pre>\n<p>I think the problem is OutputPacketContainer#writeUUID, but couldn’t find a solution.\nWrote code based on <a href=\"https://wiki.vg/Protocol#Login\" rel=\"nofollow noreferrer\">wiki.vg</a></p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}