{
  "question": {
    "tags": [
      "java",
      "cassandra",
      "datastax-java-driver"
    ],
    "owner": {
      "account_id": 37692002,
      "reputation": 1,
      "user_id": 28377059,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/d345f612f167fbce9084d382cdfd4384?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Python_Max",
      "link": "https://stackoverflow.com/users/28377059/python-max"
    },
    "is_answered": false,
    "view_count": 48,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1736992741,
    "creation_date": 1732112127,
    "last_edit_date": 1736990914,
    "question_id": 79207587,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79207587/single-node-cluster-ignores-lwt-update-when-using-single-thread-java-client-on-w",
    "title": "Single node cluster ignores LWT update when using single thread Java client on Windows",
    "body": "<p>I have the following setup:</p>\n<ul>\n<li>cassandra 4.1.7 running in docker on Ubuntu host, single node</li>\n<li>java client with datastax driver 3.11.5, jdk 11.0.25</li>\n</ul>\n<p>The code:</p>\n<pre><code>public class Main {\n\n    public static void main(String[] args) throws Exception {\n        try (Cluster cluster = connect()) {\n            Session session = cluster.connect();\n            session.execute(&quot;DROP KEYSPACE IF EXISTS lwt_test&quot;);\n            session.execute(&quot;CREATE KEYSPACE lwt_test WITH REPLICATION = { 'class' : 'SimpleStrategy', 'replication_factor' : 1 } AND DURABLE_WRITES = true&quot;);\n            session.execute(&quot;CREATE TABLE lwt_test.lwt (key timeuuid, dummy text, value text, PRIMARY KEY(key))&quot;);\n            session.execute(&quot;USE lwt_test&quot;);\n\n            final UUID key = UUIDs.timeBased();\n            final String dummy = &quot;ABC&quot;;\n            final String value = &quot;DEF&quot;;\n            session.execute(&quot;insert into lwt(key, dummy, value) values(?, ?, ?)&quot;, key, dummy, value);\n\n            final String value2 = &quot;XYZ&quot;;\n            session.execute(&quot;update lwt set value=? where key=?&quot;, value2, key);\n            String actualValue = session.execute(&quot;select value from lwt where key=?&quot;, key).one().getString(&quot;value&quot;);\n            if (!value2.equals(actualValue)) {\n                throw new RuntimeException(&quot;Should be &quot; + value + &quot; but was &quot; + actualValue);\n            }\n\n            // (1) uncomment next line to make the problem go away\n//            Thread.sleep(1000);\n\n            ResultSet rs = session.execute(&quot;update lwt set value='MUHAHA' where key=? if value=?&quot;, key, value2);\n            if (rs.wasApplied()) {\n                actualValue = session.execute(&quot;select value from lwt where key=?&quot;, key).one().getString(&quot;value&quot;);\n                if (!&quot;MUHAHA&quot;.equals(actualValue)) {\n                    throw new RuntimeException(&quot;Should be MUHAHA but was &quot; + actualValue);\n                }\n                System.out.println(&quot;SUCCESS: actual value is &quot; + actualValue);\n            }\n        }\n    }\n\n    private static Cluster connect() {\n        return Cluster.builder()\n                .addContactPoints(&quot;remote-cluster&quot;)\n                .withPort(9042)\n                .withQueryOptions(new QueryOptions().setConsistencyLevel(ConsistencyLevel.LOCAL_QUORUM))\n                // (2) uncomment next line to make the problem go away\n//                .withTimestampGenerator(ServerSideTimestampGenerator.INSTANCE)\n                .build();\n    }\n\n}\n</code></pre>\n<p>When I run this code on Windows 10, its failing with exception:</p>\n<pre><code>Exception in thread &quot;main&quot; java.lang.RuntimeException: Should be MUHAHA but was XYZ\n    at org.example.Main.main(Main.java:37)\n</code></pre>\n<p>Which means the LWT update did not apply despite being executed later and wasApplied method returned true.</p>\n<p>At the same time the same code on MacOS works without any error.</p>\n<p>The workaround is either to wait before executing update with LWT (1) or use server-side timestamps (2) which could introduce another problems in case of multi-node cluster according to discussion in <a href=\"https://issues.apache.org/jira/browse/CASSANDRA-6178\" rel=\"nofollow noreferrer\">https://issues.apache.org/jira/browse/CASSANDRA-6178</a></p>\n<p>I also tried different versions of cassandra (3.11 and 5.0.2) and java driver 4.17.0 - the problem persists in all combinations.</p>\n<p>It does not look like expected behaviour because of different outcome in Windows and MacOS and it does look more like a driver issue than server itself.</p>\n<p>Is there a way to make it work without 'sleep' using default (driver-side) timestamp generator on Windows?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}