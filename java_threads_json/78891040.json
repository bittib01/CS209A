{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-boot",
      "spring-batch"
    ],
    "owner": {
      "account_id": 3503406,
      "reputation": 12225,
      "user_id": 2929562,
      "user_type": "registered",
      "accept_rate": 88,
      "profile_image": "https://www.gravatar.com/avatar/0708efce40a3a0474d79c80111cb2276?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "PAA",
      "link": "https://stackoverflow.com/users/2929562/paa"
    },
    "is_answered": true,
    "view_count": 312,
    "answer_count": 2,
    "score": 4,
    "last_activity_date": 1725950313,
    "creation_date": 1724137714,
    "last_edit_date": 1725171670,
    "question_id": 78891040,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78891040/spring-batch-issue-with-multiresourceitemwriter-and-classifiercompositeitemwrite",
    "title": "Spring Batch issue with MultiResourceItemWriter and ClassifierCompositeItemWriter",
    "body": "<p>I am using <strong>Spring Boot + Batch v2.7.1</strong> in my project and looks like there is a bug when Reading from <code>FlatFileItemReader</code> using <code>ClassifierCompositeItemWriter</code> and <code>MultiResourceItemWriter</code> as <code>itemCountLimitPerResource</code> value doesn't works well and gives wrong responses.</p>\n<p><strong>I am reading csv file and splitting into multiple files having max records in every file should be 5 only, but the code which I developed giving me 7 values.</strong></p>\n<p>MainApp.java</p>\n<pre><code>@EnableBatchProcessing\n@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})\npublic class MultiResourceSplitApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(MultiResourceSplitApplication.class, args);\n    }\n}\n</code></pre>\n<p>MyJob.java</p>\n<pre><code>package com.example;\n\nimport org.springframework.batch.core.Job;\nimport org.springframework.batch.core.Step;\nimport org.springframework.batch.core.configuration.annotation.JobBuilderFactory;\nimport org.springframework.batch.core.configuration.annotation.StepBuilderFactory;\nimport org.springframework.batch.item.ItemWriter;\nimport org.springframework.batch.item.file.FlatFileItemReader;\nimport org.springframework.batch.item.file.FlatFileItemWriter;\nimport org.springframework.batch.item.file.builder.FlatFileItemReaderBuilder;\nimport org.springframework.batch.item.file.builder.FlatFileItemWriterBuilder;\nimport org.springframework.batch.item.file.builder.MultiResourceItemWriterBuilder;\nimport org.springframework.batch.item.file.mapping.DefaultLineMapper;\nimport org.springframework.batch.item.file.transform.DelimitedLineTokenizer;\nimport org.springframework.batch.item.file.transform.PassThroughLineAggregator;\nimport org.springframework.batch.item.support.ClassifierCompositeItemWriter;\nimport org.springframework.batch.item.support.builder.ClassifierCompositeItemWriterBuilder;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.classify.Classifier;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.core.io.ClassPathResource;\nimport org.springframework.core.io.FileSystemResource;\n\n@Configuration\npublic class MyJobConfig {\n\n    @Autowired\n    private JobBuilderFactory jobBuilderFactory;\n    @Autowired\n    private StepBuilderFactory stepBuilderFactory;\n    \n    @Bean\n    public FlatFileItemReader&lt;Employee&gt; itemReader() {\n        DelimitedLineTokenizer tokenizer = new DelimitedLineTokenizer();\n        tokenizer.setNames(&quot;empId&quot;, &quot;firstName&quot;, &quot;lastName&quot;, &quot;role&quot;);\n\n        DefaultLineMapper&lt;Employee&gt; employeeLineMapper = new DefaultLineMapper&lt;&gt;();\n        employeeLineMapper.setLineTokenizer(tokenizer);\n        employeeLineMapper.setFieldSetMapper(new EmployeeFieldSetMapper());\n        employeeLineMapper.afterPropertiesSet();\n\n        return new FlatFileItemReaderBuilder&lt;Employee&gt;()\n                .name(&quot;flatFileReader&quot;)\n                .linesToSkip(1)\n                .resource(new ClassPathResource(&quot;employee.csv&quot;))\n                .lineMapper(employeeLineMapper)\n                .build();\n    }\n\n    @Bean\n    public ClassifierCompositeItemWriter&lt;Employee&gt; classifierCompositeItemWriter() throws Exception {\n        Classifier&lt;Employee, ItemWriter&lt;? super Employee&gt;&gt; classifier = new EmployeeClassifier(\n                javaDeveloperItemWriter(), \n                pythonDeveloperItemWriter(), \n                cloudDeveloperItemWriter());\n        \n        return new ClassifierCompositeItemWriterBuilder&lt;Employee&gt;()\n                .classifier(classifier)\n                .build();\n    }\n\n    @Bean\n    public ItemWriter&lt;Employee&gt; javaDeveloperItemWriter() {\n        FlatFileItemWriter&lt;Employee&gt; itemWriter = new FlatFileItemWriterBuilder&lt;Employee&gt;()\n                .lineAggregator(new PassThroughLineAggregator&lt;&gt;())\n                .name(&quot;iw1&quot;)\n                .build();\n\n        return new MultiResourceItemWriterBuilder&lt;Employee&gt;()\n                .name(&quot;javaDeveloperItemWriter&quot;)\n                .delegate(itemWriter)\n                .resource(new FileSystemResource(&quot;javaDeveloper-employee.csv&quot;))\n                .itemCountLimitPerResource(5)\n                .resourceSuffixCreator(index -&gt; &quot;-&quot; + index)\n                .build();\n    }\n\n    @Bean\n    public ItemWriter&lt;Employee&gt; pythonDeveloperItemWriter() {\n        FlatFileItemWriter&lt;Employee&gt; itemWriter = new FlatFileItemWriterBuilder&lt;Employee&gt;()\n                .lineAggregator(new PassThroughLineAggregator&lt;&gt;())\n                .name(&quot;iw2&quot;)\n                .build();\n\n        return new MultiResourceItemWriterBuilder&lt;Employee&gt;()\n                .name(&quot;pythonDeveloperItemWriter&quot;)\n                .delegate(itemWriter)\n                .resource(new FileSystemResource(&quot;pythonDeveloper-employee.csv&quot;))\n                .itemCountLimitPerResource(5)\n                .resourceSuffixCreator(index -&gt; &quot;-&quot; + index)\n                .build();\n    }\n\n    @Bean\n    public ItemWriter&lt;Employee&gt; cloudDeveloperItemWriter() {\n        FlatFileItemWriter&lt;Employee&gt; itemWriter = new FlatFileItemWriterBuilder&lt;Employee&gt;()\n                .lineAggregator(new PassThroughLineAggregator&lt;&gt;())\n                .name(&quot;iw3&quot;)\n                .build();\n\n        return new MultiResourceItemWriterBuilder&lt;Employee&gt;()\n                .name(&quot;cloudDeveloperItemWriter&quot;)\n                .delegate(itemWriter)\n                .resource(new FileSystemResource(&quot;cloudDeveloper-employee.csv&quot;))\n                .itemCountLimitPerResource(5)\n                .resourceSuffixCreator(index -&gt; &quot;-&quot; + index)\n                .build();\n    }\n\n    @Bean\n    public Step step() throws Exception {\n        return stepBuilderFactory.get(&quot;step&quot;)\n                .&lt;Employee, Employee&gt;chunk(3)\n                .reader(itemReader())\n                .writer(classifierCompositeItemWriter())\n                .build();\n    }\n\n    @Bean\n    public Job job() throws Exception {\n        return jobBuilderFactory.get(&quot;job&quot;)\n                .start(step())\n                .build();\n    }\n}\n</code></pre>\n<p>Classifier.java</p>\n<pre><code>import org.springframework.batch.item.ItemWriter;\nimport org.springframework.classify.Classifier;\n\nimport lombok.Setter;\n\n\n@Setter\npublic class EmployeeClassifier implements Classifier&lt;Employee, ItemWriter&lt;? super Employee&gt;&gt; {\n    private static final long serialVersionUID = 1L;\n    private ItemWriter&lt;Employee&gt; javaDeveloperFileItemWriter;\n    private ItemWriter&lt;Employee&gt; pythonDeveloperFileItemWriter;\n    private ItemWriter&lt;Employee&gt; cloudDeveloperFileItemWriter;\n    \n    public EmployeeClassifier() {\n        \n    }\n\n    public EmployeeClassifier(ItemWriter&lt;Employee&gt; javaDeveloperFileItemWriter,\n                              ItemWriter&lt;Employee&gt; pythonDeveloperFileItemWriter,\n                              ItemWriter&lt;Employee&gt; cloudDeveloperFileItemWriter) {\n        this.javaDeveloperFileItemWriter = javaDeveloperFileItemWriter;\n        this.pythonDeveloperFileItemWriter = pythonDeveloperFileItemWriter;\n        this.cloudDeveloperFileItemWriter = cloudDeveloperFileItemWriter;\n    }\n\n    @Override\n    public ItemWriter&lt;? super Employee&gt; classify(Employee employee) {\n        if(employee.getRole().equals(&quot;Java Developer&quot;)){\n            return javaDeveloperFileItemWriter;\n        }\n        else if(employee.getRole().equals(&quot;Python Developer&quot;)){\n            return pythonDeveloperFileItemWriter;\n        }\n        return cloudDeveloperFileItemWriter;\n    }\n}\n</code></pre>\n<p>Employee.java</p>\n<pre><code>@AllArgsConstructor\n@NoArgsConstructor\n@Data\n@Builder\npublic class Employee {\n    private String empId;\n    private String firstName;\n    private String lastName;\n    private String role;\n\n    @Override\n    public String toString() {\n        return empId + &quot;,&quot; + firstName + &quot;,&quot; + lastName + &quot;,&quot; + role;\n    }\n}\n</code></pre>\n<p>EmployeeFieldSetMapper.java</p>\n<pre><code>public class EmployeeFieldSetMapper implements FieldSetMapper&lt;Employee&gt; {\n    @Override\n    public Employee mapFieldSet(FieldSet fieldSet) throws BindException {\n        return Employee.builder()\n                .empId(fieldSet.readRawString(&quot;empId&quot;))\n                .firstName(fieldSet.readRawString(&quot;firstName&quot;))\n                .lastName(fieldSet.readRawString(&quot;lastName&quot;))\n                .role(fieldSet.readRawString(&quot;role&quot;))\n                .build();\n    }\n}\n</code></pre>\n<p>employee.csv</p>\n<pre><code>empId,firstName,lastName,role\n1,Mike ,Doe,Java Developer\n2,Matt ,Doe,Java Developer\n3,Deepak ,Doe,Python Developer\n4,Neha ,Doe,Python Developer\n5,Harish,Doe,Python Developer\n6,Parag ,Doe,Python Developer\n7,Harshita ,Doe,Python Developer\n8,Pranali ,Doe,Python Developer\n9,Raj ,Doe,Python Developer\n10,Ravi,Doe,Python Developer\n11,Gagan,Doe,Java Developer\n12,Ashish ,Doe,Java Developer\n13,Rajesh,Doe,Java Developer\n14,Anosh ,Doe,Java Developer\n15,Arpit ,Doe,Java Developer\n16,Sneha ,Doe,Java Developer\n17,Sneha ,Doe,Java Developer\n</code></pre>\n<p>Output:\njavaDeveloper-employee.csv-1</p>\n<pre><code>1,Mike ,Doe,Java Developer\n2,Matt ,Doe,Java Developer\n11,Gagan,Doe,Java Developer\n12,Ashish ,Doe,Java Developer\n13,Rajesh,Doe,Java Developer\n14,Anosh ,Doe,Java Developer\n15,Arpit ,Doe,Java Developer\n</code></pre>\n<p>javaDeveloper-employee.csv-2</p>\n<pre><code>16,Sneha ,Doe,Java Developer\n17,Sneha ,Doe,Java Developer\n</code></pre>\n<p>pythonDeveloper-employee.csv-1</p>\n<pre><code>3,Deepak ,Doe,Python Developer\n4,Neha ,Doe,Python Developer\n5,Harish,Doe,Python Developer\n6,Parag ,Doe,Python Developer\n7,Harshita ,Doe,Python Developer\n8,Pranali ,Doe,Python Developer\n9,Raj ,Doe,Python Developer\n</code></pre>\n<p>pythonDeveloper-employee.csv-1</p>\n<pre><code>10,Ravi,Doe,Python Developer\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}