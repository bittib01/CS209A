{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "spring-kafka",
      "micrometer-tracing"
    ],
    "owner": {
      "account_id": 16415077,
      "reputation": 127,
      "user_id": 11857423,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/5f418a2f097bb5b17ad86d772f700c36?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Arunabha Ghosh",
      "link": "https://stackoverflow.com/users/11857423/arunabha-ghosh"
    },
    "is_answered": true,
    "view_count": 644,
    "accepted_answer_id": 78825322,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1747535909,
    "creation_date": 1722581465,
    "last_edit_date": 1724312900,
    "question_id": 78824099,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78824099/springboot-kafka-consumer-not-printing-traceid-spanid-in-logs-received-from-topi",
    "title": "Springboot Kafka Consumer Not printing TraceId-SpanId in Logs received from Topic Message",
    "body": "<p><strong>Issue is in consumer logs traceid and spanid not getting printed.\nI have 2 apps <em>Producer</em> and <em>Consumer</em>. Both in springboot 3.</strong></p>\n<p>Both are communicating via Kafka. Both have micrometer brave dependency.\nIf i hit any rest endpoint in <em>Consumer</em> via any client i am able to get the trace and span in logs but not in case of kafka message consumption.</p>\n<p><strong>PRODUCER --&gt;</strong>\nFrom Producer i am able to send the trace and spanid via kafka\n(in producer factory i have this flag on - <code>kafkaTemplate.setObservationEnabled(true);</code>).</p>\n<pre><code>&lt;dependency&gt;\n            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n            &lt;artifactId&gt;micrometer-tracing-bridge-brave&lt;/artifactId&gt;\n            &lt;groupId&gt;io.micrometer&lt;/groupId&gt;\n&lt;/dependency&gt;\n\n</code></pre>\n<p><strong>KAFKA SERVER --&gt;</strong>\nusing <code>./kafka-console-consumer.sh</code> i am able to see the header being sent to topic -\n<a href=\"https://i.sstatic.net/xaG9h5iI.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/xaG9h5iI.png\" alt=\"enter image description here\" /></a></p>\n<p><strong>CONSUMER --&gt;</strong>\nIn consumer logs i am not able to get the trace and span in the logs. In the consumer header i do have the trace and span though, <strong>Please see the simple logs for reference</strong></p>\n<p>This is listener -</p>\n<pre><code>@KafkaListener(containerFactory = &quot;tracingKafkaConsumerFactory&quot;, topics = &quot;tracingTopic3&quot;)\n    public void kafkaTracingListener(ConsumerRecords&lt;String, Object&gt; consumerRecords){\n        consumerRecords.forEach(consumerRecord -&gt;{\n            try {\n                if(consumerRecord.headers()!=null) {\n                    consumerRecord.headers().forEach(header -&gt; {\n                        LOGGER.info(&quot;Header key {}, Header value {}&quot;, header.key(), new String(header.value()));\n                    });\n                }\n                TraceDTO traceDto = objectMapper.readValue((String) consumerRecord.value(), TraceDTO.class);\n                LOGGER.info(&quot;consumer record {}&quot;, consumerRecord);\n            } catch (Exception e) {\n                LOGGER.error(&quot;Exception :&quot;, e);\n            }\n        });\n        LOGGER.info(&quot;Is trace printed here? &quot;);\n    }\n\n</code></pre>\n<pre><code>2024-08-02T11:42:07.483+05:30  INFO 30481 --- [trace-demo] [ntainer#0-1-C-1] [               ] c.e.trace.demo.TracingDemoKafkaConsumer  : Header key traceparent, Header value 00-66ac78b618581c0549d46cbed2dfa9dc-9675e35b152ee946-01\n2024-08-02T11:42:07.484+05:30  INFO 30481 --- [trace-demo] [ntainer#0-1-C-1] [               ] c.e.trace.demo.TracingDemoKafkaConsumer  : Header key __TypeId__, Header value com.srs.chargesessionmanagement.tracetest.TraceDTO\n2024-08-02T11:42:07.537+05:30  INFO 30481 --- [trace-demo] [ntainer#0-1-C-1] [               ] c.e.trace.demo.TracingDemoKafkaConsumer  : data TraceDTO(id=11, data=eleven) \n2024-08-02T11:42:07.571+05:30  INFO 30481 --- [trace-demo] [ntainer#0-1-C-1] [               ] c.e.trace.demo.TracingDemoKafkaConsumer  : consumer record ConsumerRecord(topic = tracingTopic3, partition = 1, leaderEpoch = 0, offset = 2, CreateTime = 1722579126973, serialized key size = 3, serialized value size = 25, headers = RecordHeaders(headers = [RecordHeader(key = traceparent, value = [48, 48, 45, 54, 54, 97, 99, 55, 56, 98, 54, 49, 56, 53, 56, 49, 99, 48, 53, 52, 57, 100, 52, 54, 99, 98, 101, 100, 50, 100, 102, 97, 57, 100, 99, 45, 57, 54, 55, 53, 101, 51, 53, 98, 49, 53, 50, 101, 101, 57, 52, 54, 45, 48, 49]), RecordHeader(key = __TypeId__, value = [99, 111, 109, 46, 115, 114, 115, 46, 99, 104, 97, 114, 103, 101, 115, 101, 115, 115, 105, 111, 110, 109, 97, 110, 97, 103, 101, 109, 101, 110, 116, 46, 116, 114, 97, 99, 101, 116, 101, 115, 116, 46, 84, 114, 97, 99, 101, 68, 84, 79])], isReadOnly = false), key = key, value = {&quot;id&quot;:11,&quot;data&quot;:&quot;eleven&quot;})\n2024-08-02T11:42:07.571+05:30  INFO 30481 --- [trace-demo] [ntainer#0-1-C-1] [               ] c.e.trace.demo.TracingDemoKafkaConsumer  : Is trace printed here? \n</code></pre>\n<p><strong>Consumer config</strong> -</p>\n<pre><code>@EnableKafka\n@Configuration\npublic class TraceDemoKafkaConsumerConfig {\n\n    @Bean\n    public Map&lt;String, Object&gt; tracingKafkaConsumerConfigs() {\n        Map&lt;String, Object&gt; props = new HashMap&lt;&gt;();\n        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,\n                &quot;localhost:9094&quot;);\n        props.put(ConsumerConfig.GROUP_ID_CONFIG, &quot;tracing-group-3&quot;);\n        props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 10);\n        props.put(ConsumerConfig.MAX_POLL_INTERVAL_MS_CONFIG, &quot;300000&quot;);\n        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, false);\n        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, &quot;earliest&quot;);\n        props.put(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, &quot;15000&quot;);\n        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);\n        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);\n        return props;\n    }\n\n    @Bean\n    public DefaultKafkaConsumerFactory&lt;String, Object&gt; tracingKafkaConsumerDefaultFactory() {\n        return new DefaultKafkaConsumerFactory&lt;&gt;(tracingKafkaConsumerConfigs());\n    }\n\n    @Bean\n    public ConcurrentKafkaListenerContainerFactory&lt;String, Object&gt; tracingKafkaConsumerFactory(){\n        ConcurrentKafkaListenerContainerFactory&lt;String, Object&gt; factory = new ConcurrentKafkaListenerContainerFactory&lt;&gt;();\n        factory.setConsumerFactory(tracingKafkaConsumerDefaultFactory());\n        factory.setConcurrency(2);\n        factory.setBatchListener(true);\n        factory.getContainerProperties().setObservationEnabled(true);\n        factory.getContainerProperties().setSyncCommits(true);\n        factory.getContainerProperties()\n                .setAckMode(ContainerProperties.AckMode.valueOf(&quot;BATCH&quot;));\n        return factory;\n    }\n}\n\n</code></pre>\n<p><strong>application.yaml</strong> -</p>\n<pre><code>management:\n  tracing:\n    sampling:\n      probability: 1\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}