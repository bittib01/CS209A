{
  "question": {
    "tags": [
      "java",
      "authentication",
      "tomcat",
      "ssl-certificate",
      "certificate"
    ],
    "owner": {
      "account_id": 21460189,
      "reputation": 101,
      "user_id": 15811117,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/25f1f41b5d3dcb87a71a56cc62c863ce?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Izek H",
      "link": "https://stackoverflow.com/users/15811117/izek-h"
    },
    "is_answered": true,
    "view_count": 652,
    "accepted_answer_id": 78664793,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1719955095,
    "creation_date": 1718382325,
    "last_edit_date": 1718749680,
    "question_id": 78624062,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78624062/how-to-get-the-popup-menu-to-select-user-certificate-in-tomcat-10-server",
    "title": "How to get the popup menu to select user certificate in Tomcat 10 server?",
    "body": "<p>I am working on a java web app, that I will deploy on a tomcat 10 server, which requests a (smart card) certificate from a user to authenticate them (after having entered their regular user credentials). (See also <a href=\"https://stackoverflow.com/questions/78387597/what-is-the-standard-modern-way-to-use-cac-piv-card-authentication-in-java-tomca\">this question</a> that describes more about it.) By setting up the right tomcat server configuration, I have made my web app connect over https (on port 8443). Then, when needed, it will make an https request on another port (8444) to request the user's certificate.</p>\n<p>However, the issue I'm having is that <strong>the browser never prompts me to select one of the available certificates</strong>, like I've seen it work for others who do the same kind of thing (see <a href=\"https://stackoverflow.com/questions/22074397/validate-when-keystore-load-is-canceled\">this question</a> and <a href=\"https://blog.e-zest.com/enable-tomcat-server-for-smart-card-authentication\" rel=\"nofollow noreferrer\">this site</a>). I have tested my browser on sites like Login.gov and other government sites: it pops up the menu for me to select my certificate--so I know the issue is not my browser settings. I can even open my browser settings and view the certificates on the smart card I have connected so I know it sees them.</p>\n<p>Currently, my <code>server.xml</code> has the https connectors like this:</p>\n<pre><code>&lt;Connector\n    port=&quot;8444&quot; secure=&quot;true&quot; scheme=&quot;https&quot; maxThreads=&quot;150&quot; SSLEnabled=&quot;true&quot;\n    maxParameterCount=&quot;1000&quot; protocol=&quot;org.apache.coyote.http11.Http11NioProtocol&quot;&gt;\n    \n    &lt;SSLHostConfig\n        sslProtocol=&quot;TLSv1.2&quot; certificateVerification=&quot;true&quot;\n        truststoreFile=&quot;C:/Program Files/Java/jdk-17/lib/security/cacerts&quot;\n        truststorePassword=&quot;changeit&quot;&gt;\n        \n        &lt;Certificate\n            certificateKeystoreFile=&quot;path/to/keystore.jks&quot;\n            certificateKeystorePassword=&quot;password&quot; type=&quot;RSA&quot;/&gt;\n    &lt;/SSLHostConfig&gt;\n&lt;/Connector&gt;\n</code></pre>\n<p>The connector on port 8443 is nearly identical, but with <code>certificateVerification=&quot;false&quot;</code>. (<strong>Update 6-17-24:</strong> I have tried <code>certificateVerification=&quot;required&quot;</code> instead of <code>&quot;true&quot;</code>, and <code>&quot;optional&quot;</code> or <code>&quot;none&quot;</code> instead of <code>&quot;false&quot;</code>, but no successful results.)</p>\n<p>In my java servlet, I have,</p>\n<pre><code>// there are various types and providers, but these were the ones that worked\nKeyStore keyStore = KeyStore.getInstance(&quot;Windows-MY&quot;, &quot;SunMSCAPI&quot;);\n// load local certificates (the certificates visible in your browser)\nkeyStore.load(null);\n// get all the names of the available certificates\nEnumeration&lt;String&gt; aliases = keyStore.aliases();\n</code></pre>\n<p>which lets me see the same certificates I can see from my browser settings. (<strong>Update 6-17-24:</strong> after this past weekend, I now can't see the list of certificates anymore...and I have no idea why.) Then I make the request to the appropriate URL on port 8444:</p>\n<pre><code>URL url = new URL(certificateRequestUrl);\nHttpsURLConnection connection = (HttpsURLConnection) url.openConnection();\nconnection.setRequestMethod(&quot;GET&quot;);\nInteger responseCode = connection.getResponseCode(); // error thrown here\n</code></pre>\n<p>I get the error <code>javax.net.ssl.SSLHandshakeException: Received fatal alert: bad_certificate</code>. According to <a href=\"https://stackoverflow.com/questions/11799733/received-fatal-alert-bad-certificate\">this discussion</a>, I think the error means that the server doesn't trust the certificate presented during the SSL handshake--but it didn't even ask me which certificate to use! I know that the URL is structured correctly because I get the expected response when <code>certificateVerification</code> is set to <code>&quot;false&quot;</code> on the port the request goes to.</p>\n<p><strong>Update 6-18-2024:</strong> I added the <code>Java Option</code> (in Tomcat) <code>-Djavax.net.debug=ssl</code> and have seen some more details:</p>\n<pre><code>javax.net.ssl|ERROR|F3|https-jsse-nio-8444-exec-6|2024-06-18 13:29:13.491 MDT|TransportContext.java:363|Fatal (BAD_CERTIFICATE): Empty client certificate chain (\n&quot;throwable&quot; : { javax.net.ssl.SSLHandshakeException: Empty client certificate chain at ... }\n)\njavax.net.ssl|WARNING|F3|https-jsse-nio-8444-exec-6|2024-06-18 13:29:13.494 MDT|SSLEngineOutputRecord.java:173|outbound has closed, ignore outbound application data\njavax.net.ssl|DEBUG|E2|https-jsse-nio-8443-exec-1|2024-06-18 13:29:13.497 MDT|Alert.java:238|Received alert message (\n&quot;Alert&quot;: {\n  &quot;level&quot;      : &quot;fatal&quot;,\n  &quot;description&quot;: &quot;bad_certificate&quot;\n}\n)\njavax.net.ssl|ERROR|E2|https-jsse-nio-8443-exec-1|2024-06-18 13:29:13.500 MDT|TransportContext.java:363|Fatal (BAD_CERTIFICATE): Received fatal alert: bad_certificate (\n&quot;throwable&quot; : {\n  javax.net.ssl.SSLHandshakeException: Received fatal alert: bad_certificate at ... }\n)\n</code></pre>\n<p>I don't understand why this doesn't see the certificates, since I can view and download them from my browser.</p>\n<p><em>Note: Although, the smart card I have is a temporary one--without a certificate chain--some users of this application will have a certificate chain linked back to a trusted CA. Will I need to add a user's certificate to the server's trust store during set up of the card with their account so that the future SSL handshakes are accepted?</em></p>\n<p>I think my question is very similar to <a href=\"https://stackoverflow.com/questions/3929158/configuring-tomcat-to-accept-dod-cac-card-certificates\">this one</a>, but I will have <em>multiple users</em> needing to add their certificates to the server's trust store during account setup, so it has to be added programmatically in java. If that is the case, how do I prompt the user to select which certificate (if multiple are available) to add to the trust store? In some cases, the user's certificate will not have a chain, while for other users, it may have a certificate chain and the root may need to be added.</p>\n<p>I know that both java and my browser can see my certificates, so <strong>why doesn't my browser provide the popup menu to select the certificate and enter the pin (when required)? How can I get the browser to give those popups?</strong></p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}