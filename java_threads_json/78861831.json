{
  "question": {
    "tags": [
      "java",
      "spring",
      "apache-camel",
      "ibm-mq"
    ],
    "owner": {
      "account_id": 898648,
      "reputation": 9865,
      "user_id": 935374,
      "user_type": "registered",
      "accept_rate": 50,
      "profile_image": "https://i.sstatic.net/q3eVx.jpg?s=256",
      "display_name": "Abhishek Singh",
      "link": "https://stackoverflow.com/users/935374/abhishek-singh"
    },
    "is_answered": true,
    "view_count": 242,
    "answer_count": 2,
    "score": 2,
    "last_activity_date": 1724418251,
    "creation_date": 1723467796,
    "last_edit_date": 1724418251,
    "question_id": 78861831,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78861831/apache-camel-deadletterchannel-unable-to-capture-jms-ibm-mqmd-applidentitydata-w",
    "title": "Apache Camel DeadLetterChannel unable to capture JMS_IBM_MQMD_ApplIdentityData while writing to the Dead Letter Queue",
    "body": "<p>Given below is the code snippet to write an error on <strong>DLQ</strong> when some exception has occurred.</p>\n<pre><code>errorHandler(deadLetterChannel(&quot;jms:queue:&quot; + this.dlq+&quot;?allowAdditionalHeaders=*&quot;)\n                .onExceptionOccurred(exchange -&gt; {\n                    Exception exception = exchange.getProperty(Exchange.EXCEPTION_CAUGHT, Exception.class);\n                    boolean shouldRouteToDLQ = false;\n                    int reasonCode = MQException.MQRC_NONE;\n                    Throwable cause = exception;\n                    while (cause != null) {\n                        if (cause instanceof MQException) {\n                            MQException mqException = (MQException) cause;\n                            if (mqException.reasonCode == MQException.MQRC_Q_FULL ||\n                                    mqException.reasonCode == MQException.MQRC_UNKNOWN_OBJECT_NAME || mqException.reasonCode == MQException.MQRC_CONNECTION_BROKEN) {\n                                reasonCode = mqException.reasonCode;\n                                shouldRouteToDLQ = true;\n                                break;\n                            }\n                        }\n                        cause = cause.getCause();\n                    }\n\n                    if (shouldRouteToDLQ) {\n                        exchange.getIn().setHeader(JmsConstants.JMS_IBM_FORMAT, MQConstants.MQFMT_DEAD_LETTER_HEADER );\n                        // Retrieve the current endpoint from headers\n                        String currentQueue = exchange.getIn().getHeader(&quot;CurrentQueue&quot;, String.class);\n                        String currentQueueManager = exchange.getIn().getHeader(&quot;CurrentQueueManager&quot;, String.class);\n                        log.info(&quot;Current queue {} Current QueueManager {}&quot;, currentQueue, currentQueueManager);\n                        MQDLH mqdlh = new MQDLH();\n                        mqdlh.setCodedCharSetId(1208); // Set to match the MQ Manager's CCSID (UTF-8)\n                        mqdlh.setEncoding(MQConstants.MQENC_NATIVE); // Use native encoding\n\n                        log.info(&quot;Reason Code&quot; + reasonCode);\n                        mqdlh.setReason(MQConstants.MQRC_Q_FULL);\n                        mqdlh.setDestQName(currentQueue.replace(&quot;.ERROR&quot;,&quot;&quot;)); //For simulation\n                        mqdlh.setDestQMgrName(currentQueueManager);\n                        mqdlh.setPutApplName(appName);\n                        mqdlh.setFormat(MQConstants.MQFMT_STRING);\n                        mqdlh.setPutDate(new SimpleDateFormat(&quot;yyyyMMdd&quot;).format(new Date()));\n                        mqdlh.setPutTime(new SimpleDateFormat(&quot;HHmmssSS&quot;).format(new Date()).substring(0, 8));\n\n                        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n                        DataOutputStream dos = new DataOutputStream(baos);\n                        mqdlh.write(dos);\n                        byte[] mqdlhBytes = baos.toByteArray();\n\n                        log.info(&quot;CCSID: &quot; + mqdlh.getCodedCharSetId());\n                        log.info(&quot;Encoding: &quot; + mqdlh.getEncoding());\n\n                        log.info(&quot;MQ DLH String: &quot; + new String(mqdlhBytes, StandardCharsets.UTF_8));\n                        // For debugging: Print the byte array of the MQDLH header\n                        log.info(&quot;MQDLH Bytes: &quot; + Arrays.toString(mqdlhBytes));\n\n                        // Check the reason code bytes within the header\n                        byte[] reasonCodeBytes = ByteBuffer.allocate(4).putInt(MQException.MQRC_Q_FULL).array();\n                        log.info(&quot;Reason Code Bytes: &quot; + Arrays.toString(reasonCodeBytes));\n\n                        // Verify reason code bytes in MQDLH\n                        byte[] reasonCodeBytes2 = Arrays.copyOfRange(mqdlhBytes, 8, 12);\n                        log.info(&quot;Reason Code Bytes in MQDLH: {}&quot;, Arrays.toString(reasonCodeBytes2));\n\n                        byte[] bodyBytes = exchange.getIn().getBody(String.class).getBytes(StandardCharsets.UTF_8);\n\n                        // Ensure the body is correctly converted to bytes\n                        String body = exchange.getIn().getBody(String.class);\n                        log.info(&quot;Original message body: {}&quot;, body);\n                        byte[] bodyBytes2 = body.getBytes(StandardCharsets.UTF_8);\n                        log.info(&quot;Body Bytes: &quot; + Arrays.toString(bodyBytes));\n\n                        byte[] combinedMessage = new byte[mqdlhBytes.length + bodyBytes.length];\n                        System.arraycopy(mqdlhBytes, 0, combinedMessage, 0, mqdlhBytes.length);\n                        System.arraycopy(bodyBytes, 0, combinedMessage, mqdlhBytes.length, bodyBytes.length);\n                        log.info(&quot;Combined Bytes: &quot; + Arrays.toString(combinedMessage));\n                        exchange.getIn().setBody(combinedMessage);\n\n                        log.info(&quot;Logging JMS Headers {} &quot;, exchange.getIn().getHeaders().toString());\n                        // Set encoding and CCSID in JMS headers if needed\n                        exchange.getIn().setHeaders(exchange.getIn().getHeaders());\n                        exchange.getIn().setHeader(&quot;appIdentity&quot;,&quot;VOS&quot;);\n                        exchange.getIn().setHeader(&quot;example&quot;,&quot;value&quot;);\n                        //exchange.getIn().setHeader(&quot;JMS_IBM_MQMD_example&quot;,&quot;JMS_IBM_MQMD_value&quot;);\n                        exchange.getIn().setHeader(&quot;CurrentQueue&quot;,currentQueue.replace(&quot;.ERROR&quot;,&quot;&quot;));\n                        exchange.getIn().setHeader(JmsConstants.JMS_IBM_MQMD_APPLIDENTITYDATA, &quot;VOS&quot;);\n                        exchange.getIn().setHeader(JmsConstants.JMS_IBM_MQMD_PUTAPPLNAME, &quot;VOSAPP&quot;);\n                        exchange.getIn().setHeader(&quot;JMS_IBM_Encoding&quot;, MQConstants.MQENC_NATIVE);\n                        log.info(&quot;Logging JMS Headers after setting encoding {} &quot;, exchange.getIn().getHeaders());\n                        exchange.setProperty(&quot;FAILURE_ROUTE_TO_DLQ&quot;, true);\n                        log.info(&quot;Headers {} Body {}&quot;,exchange.getIn().getHeaders(), new String(exchange.getIn().getBody(byte[].class),StandardCharsets.UTF_8));\n                        log.error(&quot;MQ Error Occured. Message will be sent to DLQ. Headers {} Message Body {} Error {}&quot;,exchange.getIn().getHeaders(), new String(exchange.getIn().getBody(byte[].class),StandardCharsets.UTF_8), dlq, exception);\n\n                    } else {\n                        log.error(&quot;For Route Id {} Headers {} and Message {} An error occurred: {}&quot;, exchange.getFromRouteId(),exchange.getIn().getHeaders(),exchange.getIn().getBody(), exception.getMessage());\n                        exchange.setProperty(&quot;FAILURE_ROUTE_TO_DLQ&quot;, false);\n                    }\n                })\n                .onPrepareFailure(new Processor() {\n                    @Override\n                    public void process(Exchange exchange) throws Exception {\n                        log.info(&quot;Message before DLQ: &quot; + exchange.getIn().getHeaders());\n                    }\n                })\n                .maximumRedeliveries(3)\n                .redeliveryDelay(1000)\n                .retryAttemptedLogLevel(LoggingLevel.WARN)\n                .onRedelivery(exchange -&gt; {\n                    if (Boolean.FALSE.equals(exchange.getProperty(&quot;FAILURE_ROUTE_TO_DLQ&quot;))) {\n                        // If not routing to DLQ, handle the redelivery differently, e.g., log and stop redelivery\n                        log.error(&quot;Redelivery stopped due to non-MQ specific error&quot;);\n                        throw new Exception(&quot;Redelivery stopped due to non-MQ specific error. Message: &quot;+exchange.getIn().getBody());\n                    }\n                })\n                .logHandled(true)\n        );\n</code></pre>\n<p>Given below is my log output in which I can see that <code>JMS_IBM_MQMD_ApplIdentityData</code> is being set properly in the headers.</p>\n<pre><code>Message before DLQ: {appIdentity=HENRY, CamelMessageTimestamp=1723465932100, CurrentQueue=EXAMPLE.ISB.HENRY.ISO, CurrentQueueManager=EXAMPLE.DEV.QMGR, example=value, JMS_IBM_Character_Set=ISO-8859-1, JMS_IBM_Encoding=273, JMS_IBM_Format=MQDEAD  , JMS_IBM_MQMD_ApplIdentityData=HENRY, JMS_IBM_MQMD_PutApplName=HENRYAPP, JMS_IBM_MsgType=8, JMS_IBM_PutApplType=6, JMS_IBM_PutDate=20240812, JMS_IBM_PutTime=12321210, JMSCorrelationID=null, JMSCorrelationIDAsBytes=null, JMSDeliveryMode=1, JMSDestination=null, JMSExpiration=0, JMSMessageID=ID:414d51204750502e4445562e514d47526ecab96608879521, JMSPriority=0, JMSRedelivered=false, JMSReplyTo=null, JMSTimestamp=1723465932100, JMSType=null, JMSXAppID=swx                         , JMSXDeliveryCount=1, JMSXGroupID=null, JMSXUserID=EXAMPLE         }\n</code></pre>\n<p><strong>Problem:</strong> I see all the headers are getting populated properly except for <code>JMS_IBM_MQMD_ApplIdentityData</code> when I view this message in the <strong>IBM MQ Explorer</strong>.</p>\n<p><strong>Screenshot:</strong></p>\n<p><a href=\"https://i.sstatic.net/82q6ktyT.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/82q6ktyT.png\" alt=\"enter image description here\" /></a></p>\n<p>How to resolve this issue?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}