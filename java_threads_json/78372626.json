{
  "question": {
    "tags": [
      "java",
      "digital-signature",
      "private-key",
      "public-key",
      "pgp"
    ],
    "owner": {
      "account_id": 27218848,
      "reputation": 11,
      "user_id": 20748459,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/64fc393a26ea98b3d0a9f0fb4eea2102?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "MM Ary",
      "link": "https://stackoverflow.com/users/20748459/mm-ary"
    },
    "is_answered": false,
    "view_count": 1705,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1714717734,
    "creation_date": 1713877905,
    "last_edit_date": 1713901890,
    "question_id": 78372626,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78372626/invalid-header-encountered-while-pgp-verifying-signature",
    "title": "Invalid header encountered while PGP verifying signature",
    "body": "<p>My requirement:</p>\n<ul>\n<li>Hash Algorithm during signing: SHA256</li>\n<li>Sender signs the encrypted message using its private key</li>\n<li>Receiver verifies the signature using Senderâ€™s public key</li>\n</ul>\n<p>I am having the below exception while verifying the signature:</p>\n<blockquote>\n<p>Exception in thread &quot;main&quot; java.io.IOException: invalid header encountered\nat org.bouncycastle.bcpg.BCPGInputStream.readPacket(Unknown Source)\nat org.bouncycastle.openpgp.PGPLiteralData.(Unknown Source)\nat org.bouncycastle.openpgp.PGPObjectFactory.nextObject(Unknown Source)\nat com.groupId.auth.PGPExample.verify(PGPExample.java:253)\nat com.groupId.auth.PGPExample.main(PGPExample.java:52)</p>\n</blockquote>\n<p>The above exception is on line -&gt; <code>while ((obj = pgpObjectFactory.nextObject()) != null) {...</code>\nwhen I click on 'PGPExample.java:253', my cursor goes to 'pgpObjectFactory.'</p>\n<p>I am signing the message using the below code snippet:</p>\n<pre><code>private static byte[] sign(String message) throws IOException, PGPException {\n    ByteArrayOutputStream out = new ByteArrayOutputStream();\n    OutputStream signedOut = new ArmoredOutputStream(out);\n\n    // Sign the message using sender's private key\n    PGPSecretKey senderPrivateKey = PGPUtils.getSenderPrivateKey();\n\n   BCPGOutputStream bOut = new BCPGOutputStream(signedOut);\n    PGPSignatureGenerator signatureGenerator = new PGPSignatureGenerator(\n            new JcaPGPContentSignerBuilder(senderPrivateKey.getPublicKey().getAlgorithm(), HashAlgorithmTags.SHA256)\n                    .setProvider(&quot;BC&quot;)\n    );\n\n   String password = &quot;password&quot;;\n\n   signatureGenerator.init(PGPSignature.BINARY_DOCUMENT,\n            senderPrivateKey.extractPrivateKey(\n                    new JcePBESecretKeyDecryptorBuilder().setProvider(&quot;BC&quot;).build(password.toCharArray())));\n\n    Iterator&lt;?&gt; it = senderPrivateKey.getPublicKey().getUserIDs();\n    if (it.hasNext()) {\n        PGPSignatureSubpacketGenerator spGen = new PGPSignatureSubpacketGenerator();\n        spGen.addSignerUserID(false, (String) it.next());\n        signatureGenerator.setHashedSubpackets(spGen.generate());\n    }\n\n  InputStream in = PGPUtil.getDecoderStream(new ByteArrayInputStream(message.getBytes(StandardCharsets.UTF_8)));\n    byte[] buf = new byte[8192];\n    int len;\n    while ((len = in.read(buf)) &gt; 0) {\n        signatureGenerator.update(buf, 0, len);\n    }\n    in.close();\n\n    // Generate the signature\n    signatureGenerator.generate().encode(bOut);\n    bOut.flush();\n\n    // Close streams\n    bOut.close();\n    signedOut.close();\n\n    return out.toByteArray();\n\n }\n</code></pre>\n<p>I am verifying the signature using the below code snippet:</p>\n<pre><code>private static boolean verify(String message, byte[] signature) throws IOException, PGPException {\n      ByteArrayInputStream in = new ByteArrayInputStream(signature);\n    PGPObjectFactory pgpObjectFactory = new PGPObjectFactory(in, new JcaKeyFingerprintCalculator());\n\n    Object obj;\n    while ((obj = pgpObjectFactory.nextObject()) != null) {\n        if (obj instanceof PGPSignatureList) {\n            PGPSignatureList signatureList = (PGPSignatureList) obj;\n            if (signatureList.isEmpty()) {\n                throw new IllegalArgumentException(&quot;No signature found in the data&quot;);\n            }\n            PGPSignature pgpSignature = signatureList.get(0);\n            pgpSignature.init(new JcaPGPContentVerifierBuilderProvider().setProvider(&quot;BC&quot;), PGPUtils.getReceiverPublicKey());\n            pgpSignature.update(message.getBytes(StandardCharsets.UTF_8));\n            return pgpSignature.verify();\n        }\n    }\n    throw new IllegalArgumentException(&quot;No signature found in the data&quot;);\n\n}\n</code></pre>\n<p>My main method call:</p>\n<pre><code>  public static void main(String[] args) throws Exception {\n        Security.addProvider(new BouncyCastleProvider());\n\n    byte[] signature = sign(message);\n    System.out.println(&quot;Signature: &quot;);\n    System.out.println(new String(signature));\n\n    boolean verified = verify(message, signature);\n    System.out.println(&quot;Signature Verified: &quot; + verified);\n  }\n</code></pre>\n<p>Below is my pom.xml</p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\nxsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n&lt;parent&gt;\n    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;\n    &lt;version&gt;2.7.8&lt;/version&gt;\n    &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;\n&lt;/parent&gt;\n&lt;groupId&gt;com.groupId&lt;/groupId&gt;\n&lt;artifactId&gt;auth&lt;/artifactId&gt;\n&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n&lt;name&gt;auth&lt;/name&gt;\n&lt;description&gt;Demo project for Spring Boot&lt;/description&gt;\n&lt;properties&gt;\n    &lt;java.version&gt;1.8&lt;/java.version&gt;\n&lt;/properties&gt;\n&lt;dependencies&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n        &lt;scope&gt;test&lt;/scope&gt;\n    &lt;/dependency&gt;\n\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.bouncycastle&lt;/groupId&gt;\n        &lt;artifactId&gt;bcpg-jdk18on&lt;/artifactId&gt;\n        &lt;version&gt;1.77&lt;/version&gt;\n    &lt;/dependency&gt;\n\n    &lt;dependency&gt;\n        &lt;groupId&gt;commons-codec&lt;/groupId&gt;\n        &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;\n        &lt;version&gt;1.16.1&lt;/version&gt;\n    &lt;/dependency&gt;\n\n&lt;/dependencies&gt;\n\n&lt;build&gt;\n    &lt;plugins&gt;\n        &lt;plugin&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;\n        &lt;/plugin&gt;\n    &lt;/plugins&gt;\n&lt;/build&gt;\n</code></pre>\n\n<p>I tried hard to resolve this issue but couldn't find the solution, kindly give me suggestions or solution for this.</p>\n<p>I want to sign my message &amp; then I tried to verify it but when I use the above code snippets I have provided I am not getting verified successfully or true result instead I am having this exception &quot;invalid header encountered&quot;.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}