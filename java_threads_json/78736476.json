{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-mvc",
      "junit",
      "mockito"
    ],
    "owner": {
      "account_id": 10816576,
      "reputation": 25,
      "user_id": 7955308,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/f3d86f8f4637ed9ca43e7945b79d63a4?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Juan Federico Di Leo",
      "link": "https://stackoverflow.com/users/7955308/juan-federico-di-leo"
    },
    "is_answered": false,
    "view_count": 346,
    "answer_count": 2,
    "score": 1,
    "last_activity_date": 1735770056,
    "creation_date": 1720712124,
    "last_edit_date": 1720714703,
    "question_id": 78736476,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78736476/i-cant-init-my-webclient-in-a-test-with-mockito",
    "title": "I cant init my webclient in a test with mockito",
    "body": "<p>I'm working on a project with java spring boot 2.x and java 1.8. In my pom i got the dependencies of junit 4.13.2 and mockito 3.12.4. When i try to run my test i got the problem that my setup function is not running even with the @before annotation so webclient builder is null</p>\n<pre><code>@Service\npublic class StarshipService {\n\n    private final WebClient webClient;\n\n    @Autowired\n    public StarshipService(WebClient.Builder webClientBuilder) {\n        this.webClient = webClientBuilder.baseUrl(&quot;https://www.swapi.tech/api&quot;).build();\n    }\n\n    public StarshipResponse getStarships(int page, int size, String nameOrId){\n        try {\n\n            // Si nameOrId es un n√∫mero, busca por ID\n            if (nameOrId != null &amp;&amp; nameOrId.matches(&quot;\\\\d+&quot;)) {\n                return getStarshipById(nameOrId);\n            }\n\n            UriComponentsBuilder builder = UriComponentsBuilder.fromHttpUrl(&quot;https://www.swapi.tech/api/starships&quot;);\n\n            if (page != 0){\n                builder.queryParam(&quot;page&quot;, page);\n            }\n            builder.queryParam(&quot;limit&quot;, size);\n            if (nameOrId != null &amp;&amp; !nameOrId.isEmpty()) {\n                builder.queryParam(&quot;name&quot;, nameOrId);\n            }\n\n            String url = builder.toUriString();\n\n            Mono&lt;ResponseEntity&lt;String&gt;&gt; responseMono = this.webClient.get()\n                    .uri(url)\n                    .retrieve()\n                    .toEntity(String.class);\n\n            ResponseEntity&lt;String&gt; responseEntity = responseMono.block();\n\n            if (responseEntity != null &amp;&amp; responseEntity.getStatusCode().is2xxSuccessful()) {\n                String responseBody = responseEntity.getBody();\n                if (responseBody != null &amp;&amp; responseBody.contains(&quot;results&quot;)) {\n                    return StarWarsParseService.parseStandardStarshipResponse(responseBody);\n                } else if (responseBody != null &amp;&amp; responseBody.contains(&quot;result&quot;)) {\n                    return StarWarsParseService.parseSearchStarshipResponse(responseBody);\n                }\n            }\n            return new StarshipResponse();\n        } catch (HttpClientErrorException e){\n            System.err.println(&quot;Error al llamar a la API de Star Wars: &quot; + e.getMessage());\n            e.printStackTrace();\n            return new StarshipResponse();\n        } catch (JsonProcessingException e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    public StarshipResponse getStarshipById(String id) throws JsonProcessingException {\n        try {\n            String url = &quot;https://www.swapi.tech/api/starships/&quot; + id;\n\n            Mono&lt;ResponseEntity&lt;String&gt;&gt; responseMono = this.webClient.get()\n                    .uri(url)\n                    .retrieve()\n                    .toEntity(String.class);\n\n            try{\n                ResponseEntity&lt;String&gt; responseEntity = responseMono.block();\n                if (responseEntity != null &amp;&amp; responseEntity.getStatusCode().is2xxSuccessful()) {\n                    return StarWarsParseService.parseIdStarshipResponse(responseEntity.getBody());\n                } else {\n                    System.err.println(&quot;Unexpected response or status code: &quot; + responseEntity);\n                    return new StarshipResponse();\n                }\n            }catch (WebClientResponseException.NotFound ex){\n                System.err.println(&quot;Person with ID &quot; + id + &quot; not found in SWAPI&quot;);\n                StarshipResponse starshipResponse = new StarshipResponse();\n                starshipResponse.setResults(new ArrayList&lt;&gt;());\n                starshipResponse.setTotal_records(0);\n                starshipResponse.setTotal_pages(1);\n                return starshipResponse;\n            }\n        } catch (HttpClientErrorException e) {\n            System.err.println(&quot;Error al llamar a la API de Star Wars: &quot; + e.getMessage());\n            e.printStackTrace();\n            return new StarshipResponse();\n        }\n        catch (Exception e) {\n            System.err.println(&quot;Unexpected error: &quot; + e.getMessage());\n            e.printStackTrace();\n            return new StarshipResponse();\n        }\n    }\n}\n</code></pre>\n<p>and this test with mockito and junit</p>\n<pre><code>@RunWith(MockitoJUnitRunner.class)\n@SpringBootTest\npublic class StarshipServiceTest {\n\n    @Mock\n    private WebClient.Builder webClientBuilder;\n\n    @Mock\n    private WebClient webClient;\n\n    @Mock\n    private WebClient.RequestHeadersUriSpec requestHeadersUriSpec;\n\n    @Mock\n    private WebClient.RequestHeadersSpec requestHeadersSpec;\n\n    @Mock\n    private WebClient.ResponseSpec responseSpec;\n\n    @InjectMocks\n    private StarshipService starshipService;\n\n    @Before\n    public void setUp() {\n        MockitoAnnotations.initMocks(this);\n        when(webClientBuilder.baseUrl(anyString())).thenReturn(webClientBuilder);\n        when(webClientBuilder.build()).thenReturn(webClient);\n    }\n\n    @Test\n    public void testGetStarships() throws JsonProcessingException {\n        // Mock the WebClient behavior\n        when(webClient.get()).thenReturn(requestHeadersUriSpec);\n        when(requestHeadersUriSpec.uri(anyString())).thenReturn(requestHeadersSpec);\n        when(requestHeadersSpec.retrieve()).thenReturn(responseSpec);\n        when(responseSpec.toEntity(String.class)).thenReturn(Mono.just(new ResponseEntity&lt;&gt;(&quot;{\\&quot;results\\&quot;: []}&quot;, HttpStatus.OK)));\n\n        // Call the method to test\n        StarshipResponse response = starshipService.getStarships(1, 10, null);\n\n        // Assert the response\n        assertNotNull(response);\n        assertEquals(0, response.getResults().size());\n    }\n\n    @Test\n    public void testGetStarshipById() throws JsonProcessingException {\n        // Mock the WebClient behavior\n        when(webClient.get()).thenReturn(requestHeadersUriSpec);\n        when(requestHeadersUriSpec.uri(anyString())).thenReturn(requestHeadersSpec);\n        when(requestHeadersSpec.retrieve()).thenReturn(responseSpec);\n        when(responseSpec.toEntity(String.class)).thenReturn(Mono.just(new ResponseEntity&lt;&gt;(&quot;{\\&quot;result\\&quot;: {\\&quot;properties\\&quot;: {\\&quot;name\\&quot;: \\&quot;Millennium Falcon\\&quot;}}}&quot;, HttpStatus.OK)));\n\n        // Call the method to test\n        StarshipResponse response = starshipService.getStarshipById(&quot;10&quot;);\n\n        // Assert the response\n        assertNotNull(response);\n        assertEquals(&quot;Millennium Falcon&quot;, response.getResults().get(0).getName());\n    }\n\n    @Test\n    public void testGetStarshipByIdNotFound() throws JsonProcessingException {\n        // Mock the WebClient behavior for 404 Not Found\n        when(webClient.get()).thenReturn(requestHeadersUriSpec);\n        when(requestHeadersUriSpec.uri(anyString())).thenReturn(requestHeadersSpec);\n        when(requestHeadersSpec.retrieve()).thenReturn(responseSpec);\n        when(responseSpec.toEntity(String.class)).thenReturn(Mono.error(new WebClientResponseException(404, &quot;Not Found&quot;, null, null, null)));\n\n        // Call the method to test\n        StarshipResponse response = starshipService.getStarshipById(&quot;0&quot;);\n\n        // Assert the response\n        assertNotNull(response);\n        assertEquals(0, response.getTotal_records());\n    }\n}\n</code></pre>\n<p>but when i try to run the test i got this error</p>\n<p>org.mockito.exceptions.misusing.InjectMocksException:\nCannot instantiate @InjectMocks field named 'starshipService' of type 'class com.example.conexatest.conexatest.service.StarshipService'.\nYou haven't provided the instance at field declaration so I tried to construct the instance.\nHowever the constructor or the initialization block threw an exception : Cannot invoke &quot;org.springframework.web.reactive.function.client.WebClient$Builder.build()&quot; because the return value of &quot;org.springframework.web.reactive.function.client.WebClient$Builder.baseUrl(String)&quot; is null</p>\n<p>when i put a breakpoint in the setup function i cant reach it when i'm debugging</p>\n<p>I have fixed some thing and now i can enter the setup function but the webClientBuilder is null and when i call the when() function the program crash. In my project i got a config like this</p>\n<pre><code>@Configuration\npublic class AppConfig {\n    @Bean\n    public WebClient.Builder webClientBuilder() {\n        return WebClient.builder();\n    }\n}\n</code></pre>\n<p>and the service is consuming this like this:</p>\n<pre><code>private final WebClient webClient;\n\n    @Autowired\n    public StarshipService(WebClient.Builder webClientBuilder) {\n        this.webClient = webClientBuilder.baseUrl(&quot;https://www.swapi.tech/api&quot;).build();\n}\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}