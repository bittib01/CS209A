{
  "question": {
    "tags": [
      "java",
      "java-native-interface",
      "dalvik",
      "gluonfx"
    ],
    "owner": {
      "account_id": 14686581,
      "reputation": 165,
      "user_id": 10606381,
      "user_type": "registered",
      "profile_image": "https://i.sstatic.net/OnSIU.jpg?s=256",
      "display_name": "CTO - Abid Maqbool",
      "link": "https://stackoverflow.com/users/10606381/cto-abid-maqbool"
    },
    "is_answered": true,
    "view_count": 121,
    "accepted_answer_id": 79317043,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1735544457,
    "creation_date": 1734173003,
    "last_edit_date": 1734181432,
    "question_id": 79280483,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79280483/jni-issue-passing-java-runnable-object-to-jni-in-custom-gluon-attach-plugin",
    "title": "JNI Issue: Passing Java Runnable Object to JNI in Custom Gluon Attach Plugin",
    "body": "<p>I am developing a <strong>custom Gluon Attach plugin</strong> and encountering issues with passing a Java <code>Runnable</code> object from Java to JNI. Despite reviewing the <a href=\"https://github.com/gluonhq/attach\" rel=\"nofollow noreferrer\">Gluon Attach plugin source code</a> (which unfortunately didn't help much in this case), I'm unable to successfully invoke the <code>Runnable</code> object on the native side.</p>\n<h3><strong>Context</strong></h3>\n<p>This is a custom implementation of the <code>AndroidAlertDialogService</code> within a custom Gluon Attach plugin. I want to pass a <code>Runnable</code> object as the last parameter of the native method <code>showSaveAlert3</code>.</p>\n<p>When the native code attempts to invoke the <code>Runnable</code>, I consistently run into this error:</p>\n<pre><code>JNI DETECTED ERROR IN APPLICATION: JNI ERROR (app bug):  \njobject is an invalid JNI transition frame reference: 0x8000000000000008  \n</code></pre>\n<hr />\n<h3><strong>Code Overview</strong></h3>\n<h4><strong>Java Class 1 (AndroidAlertDialogService)</strong></h4>\n<pre class=\"lang-java prettyprint-override\"><code>package com.gluonhq.attachextended.alertdialog.impl;\n\nimport com.gluonhq.attachextended.alertdialog.AlertDialogService;\n\npublic class AndroidAlertDialogService implements AlertDialogService {\n\n    static {\n        System.loadLibrary(&quot;alertdialog&quot;);\n    }\n\n    @Override\n    public void showSaveAlert(String title, String content, Runnable r) {\n        showSaveAlert3(title, content, r);\n    }\n\n    private native static void showSaveAlert3(String title, String content, Runnable r);\n}\n</code></pre>\n<h4><strong>JNI Code (alertdialog.c)</strong></h4>\n<pre class=\"lang-c prettyprint-override\"><code>#include &quot;util.h&quot;\n\nstatic jclass jAlertDialogServiceClass;\nstatic jobject jDalvikAlertDialogService;\n\nstatic jmethodID jAlertDialogServiceShowSaveAlert3Method;\n\nstatic void initializeAlertDialogDalvikHandles() {\n    jAlertDialogServiceClass = GET_REGISTER_DALVIK_CLASS(jAlertDialogServiceClass, &quot;com/gluonhq/helloandroid/DalvikAlertDialogService&quot;);\n    \n    ATTACH_DALVIK();\n    jmethodID jAlertDialogServiceInitMethod = (*dalvikEnv)-&gt;GetMethodID(dalvikEnv, jAlertDialogServiceClass, &quot;&lt;init&gt;&quot;, &quot;(Landroid/app/Activity;)V&quot;);\n\n    jAlertDialogServiceShowSaveAlert3Method = (*dalvikEnv)-&gt;GetMethodID(dalvikEnv, jAlertDialogServiceClass, &quot;showSaveAlert3&quot;, &quot;(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Runnable;)V&quot;);\n    \n    jobject jActivity = substrateGetActivity();\n    jobject jObj = (*dalvikEnv)-&gt;NewObject(dalvikEnv, jAlertDialogServiceClass, jAlertDialogServiceInitMethod, jActivity);\n    jDalvikAlertDialogService = (*dalvikEnv)-&gt;NewGlobalRef(dalvikEnv, jObj);\n    DETACH_DALVIK();\n}\n\n//////////////////////////\n// From Graal to native //\n//////////////////////////\n\nJNIEXPORT jint JNICALL\nJNI_OnLoad_alertdialog(JavaVM *vm, void *reserved)\n{\n    JNIEnv* graalEnv;\n    ATTACH_LOG_INFO(&quot;JNI_OnLoad_alertdialog called&quot;);\n#ifdef JNI_VERSION_1_8\n    if ((*vm)-&gt;GetEnv(vm, (void **)&amp;graalEnv, JNI_VERSION_1_8) != JNI_OK) {\n        ATTACH_LOG_WARNING(&quot;Error initializing native AlertDialog from OnLoad&quot;);\n        return JNI_FALSE;\n    }\n    ATTACH_LOG_FINE(&quot;[AlertDialog Service] Initializing native AlertDialog from OnLoad&quot;);\n    initializeAlertDialogDalvikHandles();\n    return JNI_VERSION_1_8;\n#else\n    #error Error: Java 8+ SDK is required to compile Attach\n#endif\n}\n\n// from Java to Android\n\nJNIEXPORT void JNICALL Java_com_gluonhq_attachextended_alertdialog_impl_AndroidAlertDialogService_showSaveAlert3  \n(JNIEnv *env, jclass jClass, jstring jtitle, jstring jcontent, jobject jr) {  \n    const char *titleChars = (*env)-&gt;GetStringUTFChars(env, jtitle, NULL);  \n    const char *contentChars = (*env)-&gt;GetStringUTFChars(env, jcontent, NULL);  \n\n    ATTACH_DALVIK();  \n    jstring jTitleString = (*dalvikEnv)-&gt;NewStringUTF(dalvikEnv, titleChars);  \n    jstring jContentString = (*dalvikEnv)-&gt;NewStringUTF(dalvikEnv, contentChars);  \n\n    jobject globalRunnable = (*dalvikEnv)-&gt;NewGlobalRef(dalvikEnv, jr);  \n    jclass rClass = (*dalvikEnv)-&gt;GetObjectClass(dalvikEnv, globalRunnable);  \n\n    jmethodID midMyCustomMethod = (*dalvikEnv)-&gt;GetMethodID(dalvikEnv, rClass, &quot;run&quot;, &quot;()V&quot;);  \n    (*dalvikEnv)-&gt;CallVoidMethod(dalvikEnv, jDalvikAlertDialogService, jAlertDialogServiceShowSaveAlert3Method, jTitleString, jContentString, midMyCustomMethod);  \n\n    DETACH_DALVIK();  \n    (*env)-&gt;ReleaseStringUTFChars(env, jtitle, titleChars);  \n    (*env)-&gt;ReleaseStringUTFChars(env, jcontent, contentChars);  \n}\n</code></pre>\n<h4><strong>Java Class 2 (DalvikAlertDialogService)</strong></h4>\n<pre class=\"lang-java prettyprint-override\"><code>package com.gluonhq.helloandroid;\n\nimport android.app.AlertDialog;\nimport android.content.DialogInterface;\nimport android.app.Activity;\n\npublic class DalvikAlertDialogService {\n\n    private final Activity activity;\n\n    public DalvikAlertDialogService(Activity activity) {\n        this.activity = activity;\n    }\n\n    public void showSaveAlert3(String title, String content, Runnable r) {\n        activity.runOnUiThread(() -&gt; {\n            if (!activity.isFinishing()) {\n                AlertDialog.Builder dialog = new AlertDialog.Builder(activity);\n                dialog.setCancelable(false);\n                dialog.setTitle(title);\n                dialog.setMessage(content);\n                dialog.setPositiveButton(&quot;Ok&quot;, (DialogInterface dialog1, int id) -&gt; {\n                    dialog1.dismiss();\n                    r.run();\n                });\n\n                AlertDialog alert = dialog.create();\n                alert.show();\n            }\n        });\n    }\n}\n</code></pre>\n<hr />\n<h3><strong>What I've Tried</strong></h3>\n<ol>\n<li>Using <code>NewGlobalRef</code> to create a persistent reference to the <code>Runnable</code> object before invoking its <code>run</code> method.</li>\n<li>Checking the validity of the Dalvik environment (<code>dalvikEnv</code>).</li>\n<li>Exploring the <strong>Gluon Attach source code</strong> for existing plugins such as &quot;DisplayService&quot; and &quot;StorageService.&quot; Unfortunately, those examples primarily focus on passing strings, primitives, or arrays, not complex Java objects like <code>Runnable</code>.</li>\n</ol>\n<hr />\n<h3><strong>Problem Statement</strong></h3>\n<p>Despite these attempts, I am unable to invoke the <code>Runnable</code>'s <code>run()</code> method. The <code>jobject</code> reference seems to become invalid when used in the JNI context, resulting in the error mentioned above.</p>\n<hr />\n<h3><strong>Questions</strong></h3>\n<ol>\n<li><strong>What is the correct way to pass a Java <code>Runnable</code> object to JNI and call its <code>run()</code> method in this context?</strong></li>\n<li>Are there any specific steps for handling <code>Runnable</code> objects in Gluon Attach that I might be missing?</li>\n<li>Could the issue be related to improper reference management (<code>NewGlobalRef</code>, <code>Detach</code>, etc.) in the Dalvik environment?</li>\n</ol>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}