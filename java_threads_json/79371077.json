{
  "question": {
    "tags": [
      "java",
      "winapi",
      "javafx",
      "taskbar",
      "java-ffm"
    ],
    "owner": {
      "account_id": 8877206,
      "reputation": 241,
      "user_id": 6628911,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/4076075907310368328fd2750c80d99f?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Petr Å techm&#252;ller",
      "link": "https://stackoverflow.com/users/6628911/petr-%c5%a0techm%c3%bcller"
    },
    "is_answered": true,
    "view_count": 290,
    "accepted_answer_id": 79373930,
    "answer_count": 2,
    "score": 4,
    "last_activity_date": 1751522878,
    "creation_date": 1737370757,
    "last_edit_date": 1737405812,
    "question_id": 79371077,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79371077/control-taskbar-in-windows-from-java-using-ffm-and-winapi",
    "title": "Control taskbar in Windows from java using FFM and winapi",
    "body": "<p>I'm trying to control a taskbar so I can show a progress of some long running task in the JavaFX application. For communicating with winapi I want to use the new Java FFM API, which should replace the JNI one day.</p>\n<p>So far I was able successfully create instance of <code>ITaskbarList3</code> instance, but I'm not able to call any method on it.</p>\n<p>I'm using <code>jextract</code> to extract functions from winapi to make sure they are correctly mapped to API:</p>\n<pre><code>jextract --output target/generated-sources/jextract -t &quot;taskbar_test.gen&quot; -l :shell32 -l :Explorerframe -l :ole32 -I &quot;C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.26100.0\\shared&quot; -I &quot;C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.26100.0\\um&quot; -I &quot;C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.26100.0\\km&quot; -I &quot;C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.26100.0\\km\\crt&quot; &quot;C:\\Program Files (x86)\\Windows Kits\\10\\Include\\10.0.26100.0\\um\\ShObjIdl_core.h&quot;\n</code></pre>\n<p>In the code below, you can find complete application with my attempt to in the end call function <code>SetProgressValue</code>. My issue is that I'm not able to successfully call function <code>HrInit</code> which should be called to initialize the <code>ITaskbarList</code>.</p>\n<pre class=\"lang-java prettyprint-override\"><code>package taskbar_test;\nimport com.sun.glass.ui.Window;\nimport javafx.application.Application;\nimport javafx.stage.Stage;\nimport taskbar_test.gen.CLSID;\nimport taskbar_test.gen.IID;\nimport taskbar_test.gen.ITaskbarList;\nimport taskbar_test.gen.ITaskbarList3;\nimport taskbar_test.gen.ITaskbarList3Vtbl;\nimport taskbar_test.gen.ITaskbarListVtbl;\nimport taskbar_test.gen.ShObjIdl_core_h;\nimport java.lang.foreign.Arena;\nimport java.lang.foreign.MemorySegment;\nimport java.lang.foreign.ValueLayout;\nimport java.nio.charset.StandardCharsets;\nimport java.util.concurrent.Executors;\npublic class FxWinTaskbar extends Application {\n     public static final String GUID_FORMAT = &quot;{%s}&quot;;\n     // CLSID of ITaskbarList3\n     public static final String CLSID_CONST = &quot;56FDF344-FD6D-11d0-958A-006097C9A090&quot;;\n     // IID of ITaskbarList3\n     public static final String IID_ITASKBAR_LIST = &quot;56FDF342-FD6D-11d0-958A-006097C9A090&quot;;\n     public static final String IID_ITASKBAR_LIST_3 = &quot;EA1AFB91-9E28-4B86-90E9-9E9F8A5EEFAF&quot;;\n     @Override\n     public void start(Stage stage) throws Exception {\n         var button = new javafx.scene.control.Button(&quot;Click Me&quot;);\n         button.setOnAction(e -&gt; handleClick());\n         var root = new javafx.scene.layout.StackPane(button);\n         var scene = new javafx.scene.Scene(root, 300, 200);\n         stage.setTitle(&quot;JavaFX Stage with Button&quot;);\n         stage.setScene(scene);\n         stage.show();\n     }\n    void handleClick() {\n        long rawHandle = Window.getWindows().getFirst().getRawHandle();\n        Executors.newSingleThreadExecutor().submit(() -&gt; {\n            try (var arena = Arena.ofConfined()) {\n                // 1. Initialize variables\n\n                // https://learn.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-clsidfromstring#remarks\n                // The CLSID format is {xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx}.\n                var clsidString = arena.allocateFrom(GUID_FORMAT.formatted(CLSID_CONST), StandardCharsets.UTF_16LE);\n                var iidITaskbarList = arena.allocateFrom(GUID_FORMAT.formatted(IID_ITASKBAR_LIST), StandardCharsets.UTF_16LE);\n                var iidITaskbarList3 = arena.allocateFrom(GUID_FORMAT.formatted(IID_ITASKBAR_LIST_3), StandardCharsets.UTF_16LE);\n                var clsid = CLSID.allocate(arena);\n                var iidTaskbarList = IID.allocate(arena);\n                var iidTaskbarList3 = IID.allocate(arena);\n                var taskbarPtrToPtr = arena.allocate(ShObjIdl_core_h.C_POINTER);\n                var taskbar3PtrToPtr = arena.allocate(ShObjIdl_core_h.C_POINTER);\n                MemorySegment windowHandle = arena.allocate(ValueLayout.ADDRESS, rawHandle);\n\n                // 2. Initialize COM\n                int hr = ShObjIdl_core_h.CoInitializeEx(MemorySegment.NULL, ShObjIdl_core_h.COINIT_MULTITHREADED());\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    throw new RuntimeException(&quot;CoInitialize failed with error code: &quot; + hr);\n                }\n\n                // 3. Create CLSID and IIDs\n                hr = ShObjIdl_core_h.CLSIDFromString(clsidString, clsid);\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    throw new RuntimeException(&quot;CLSIDFromString failed with error code: &quot; + hr);\n                }\n\n                hr = ShObjIdl_core_h.IIDFromString(iidITaskbarList, iidTaskbarList);\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    throw new RuntimeException(&quot;IIDFromString failed with error code: &quot; + hr);\n                }\n\n                hr = ShObjIdl_core_h.IIDFromString(iidITaskbarList3, iidTaskbarList3);\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    throw new RuntimeException(&quot;IIDFromString failed with error code: &quot; + hr);\n                }\n\n                // 4. Create instance of ITaskbarList\n                hr = ShObjIdl_core_h.CoCreateInstance(clsid, MemorySegment.NULL, ShObjIdl_core_h.CLSCTX_ALL(), iidTaskbarList, taskbarPtrToPtr);\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    if (hr == ShObjIdl_core_h.REGDB_E_CLASSNOTREG()) {\n                        System.out.println(&quot;COM class is not registered!&quot;);\n                    }\n                    throw new RuntimeException(&quot;CoCreateInstance failed with error code: &quot; + hr);\n                }\n                // CoCreateInstance returns pointer to pointer to ITaskbarList so here we obtain the &quot;inner&quot; pointer\n                var taskbarPtr = taskbarPtrToPtr.get(ValueLayout.ADDRESS, 0);\n                // Use reinterpret method to have access to the actual ITaskbarList instance\n                var taskbarListInstance = ITaskbarList.reinterpret(taskbarPtr, arena, _ -&gt; {\n                    System.out.println(&quot;Some cleanup...&quot;);\n                });\n\n                // 5. Obtain lpVtbl pointer from ITaskbarList\n                MemorySegment taskbarListVtblPtr = ITaskbarList.lpVtbl(taskbarListInstance);\n                // Use reinterpret method to have access to the actual ITaskbarListVtbl instance\n                MemorySegment taskbarListVtbl = ITaskbarListVtbl.reinterpret(taskbarListVtblPtr, arena, _ -&gt; {\n                    System.out.println(&quot;Some cleanup...&quot;);\n                });\n\n                // 6. Get pointer to function HrInit to initialize ITaskbarList\n                // https://learn.microsoft.com/en-us/windows/win32/api/shobjidl_core/nf-shobjidl_core-itaskbarlist-hrinit\n                // Initializes the taskbar list object. This method must be called before any other ITaskbarList methods can be called.\n                MemorySegment functionHrInitPtr = ITaskbarListVtbl.HrInit(taskbarListVtbl);\n                hr = ITaskbarListVtbl.HrInit.invoke(functionHrInitPtr, taskbarListVtbl);\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    throw new RuntimeException(&quot;HrInit failed with error code: &quot; + hr);\n                }\n\n                // 7. Create instance of ITaskbarList3\n                hr = ShObjIdl_core_h.CoCreateInstance(clsid, MemorySegment.NULL, ShObjIdl_core_h.CLSCTX_ALL(), iidTaskbarList3, taskbar3PtrToPtr);\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    if (hr == ShObjIdl_core_h.REGDB_E_CLASSNOTREG()) {\n                        System.out.println(&quot;COM class is not registered!&quot;);\n                    }\n                    throw new RuntimeException(&quot;CoCreateInstance failed with error code: &quot; + hr);\n                }\n                // 8. Obtain a pointer to the instance\n                var taskbar3Ptr = taskbar3PtrToPtr.get(ValueLayout.ADDRESS, 0);\n                // Use reinterpret method to have access to the actual ITaskbarList3 instance\n                var taskbarList3Instance = ITaskbarList3.reinterpret(taskbar3Ptr, arena, _ -&gt; {\n                    System.out.println(&quot;Some cleanup...&quot;);\n                });\n\n                // 9. Obtain lpVtbl pointer from ITaskbarList3\n                MemorySegment taskbarList3VtblPtr = ITaskbarList3.lpVtbl(taskbarList3Instance);\n                // Use reinterpret method to have access to the actual ITaskbarList3Vtbl instance\n                MemorySegment taskbarList3Vtbl = ITaskbarList3Vtbl.reinterpret(taskbarList3VtblPtr, arena, _ -&gt; {\n                    System.out.println(&quot;Some cleanup...&quot;);\n                });\n\n                // 10. Set progress state to indeterminate\n                MemorySegment functionSetProgressStatePtr = ITaskbarList3Vtbl.SetProgressState(taskbarList3Vtbl);\n                hr = ITaskbarList3Vtbl.SetProgressState.invoke(functionSetProgressStatePtr, taskbarList3Vtbl, windowHandle, ShObjIdl_core_h.TBPF_INDETERMINATE());\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    throw new RuntimeException(&quot;SetProgressState failed with error code: &quot; + hr);\n                }\n\n            } catch (Throwable ex) {\n                ex.printStackTrace();\n\n            } finally {\n                ShObjIdl_core_h.CoUninitialize();\n            }\n        });\n    }\n\n    public static void main(String[] args) {\n         launch(args);\n     }\n }\n</code></pre>\n<p>I'm not able to call the function <code>SetProgressState</code> directly on interface <code>ITaskbarList3</code> because generated sources does not have the ability to do so. Instead I have to manually obtain <code>vtbl</code> structure and call the function on this structure.</p>\n<p>As you can see on the picture below, the address of <code>vtblPtr</code> and function for <code>HrInit</code> are completely off. Calling function <code>HrInit</code> will fail, because it is accesssing wrong memory.</p>\n<p>Does anyone have idea what am I doing wrong?</p>\n<p>Thank you.\nPetr</p>\n<p><a href=\"https://i.sstatic.net/6KQFwCBM.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/6KQFwCBM.png\" alt=\"Memory example\" /></a></p>\n<p>Edit: I have applied suggestions from comments. Now, there is only one instance <code>ITaskbarList3</code> created and all functions are called on it. I have also extended the code to simulate some progress to see if it can set the progress. The code seems to be running, but unfortunately the taskbar is still without any changes.</p>\n<pre class=\"lang-java prettyprint-override\"><code>package taskbar_test;\n\nimport com.sun.glass.ui.Window;\nimport javafx.application.Application;\nimport javafx.stage.Stage;\nimport taskbar_test.gen.CLSID;\nimport taskbar_test.gen.IID;\nimport taskbar_test.gen.ITaskbarList3;\nimport taskbar_test.gen.ITaskbarList3Vtbl;\nimport taskbar_test.gen.ShObjIdl_core_h;\n\nimport java.lang.foreign.Arena;\nimport java.lang.foreign.MemorySegment;\nimport java.lang.foreign.ValueLayout;\nimport java.nio.charset.StandardCharsets;\nimport java.util.concurrent.Executors;\n\npublic class FxWinTaskbar extends Application {\n\n    public static final String GUID_FORMAT = &quot;{%s}&quot;;\n\n    // CLSID of ITaskbarList3\n    public static final String CLSID_CONST = &quot;56FDF344-FD6D-11d0-958A-006097C9A090&quot;;\n    // IID of ITaskbarList3\n    public static final String IID_ITASKBAR_LIST_3 = &quot;EA1AFB91-9E28-4B86-90E9-9E9F8A5EEFAF&quot;;\n\n    @Override\n    public void start(Stage stage) throws Exception {\n        var button = new javafx.scene.control.Button(&quot;Click Me&quot;);\n        button.setOnAction(e -&gt; handleClick());\n\n        var root = new javafx.scene.layout.StackPane(button);\n        var scene = new javafx.scene.Scene(root, 300, 200);\n\n        stage.setTitle(&quot;JavaFX Stage with Button&quot;);\n        stage.setScene(scene);\n        stage.show();\n    }\n\n    void handleClick() {\n        long rawHandle = Window.getWindows().getFirst().getRawHandle();\n        Executors.newSingleThreadExecutor().submit(() -&gt; {\n            try (var arena = Arena.ofConfined()) {\n                // 1. Initialize variables\n\n                // https://learn.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-clsidfromstring#remarks\n                // The CLSID format is {xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx}.\n                var clsidString = arena.allocateFrom(GUID_FORMAT.formatted(CLSID_CONST), StandardCharsets.UTF_16LE);\n                var iidITaskbarList3 = arena.allocateFrom(GUID_FORMAT.formatted(IID_ITASKBAR_LIST_3), StandardCharsets.UTF_16LE);\n                var clsid = CLSID.allocate(arena);\n                var iidTaskbarList3 = IID.allocate(arena);\n                var taskbar3PtrToPtr = arena.allocate(ShObjIdl_core_h.C_POINTER);\n                MemorySegment windowHandle = arena.allocate(ValueLayout.ADDRESS, rawHandle);\n\n                // 2. Initialize COM\n                int hr = ShObjIdl_core_h.CoInitializeEx(MemorySegment.NULL, ShObjIdl_core_h.COINIT_MULTITHREADED());\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    throw new RuntimeException(&quot;CoInitialize failed with error code: &quot; + hr);\n                }\n\n                // 3. Create CLSID and IIDs\n                hr = ShObjIdl_core_h.CLSIDFromString(clsidString, clsid);\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    throw new RuntimeException(&quot;CLSIDFromString failed with error code: &quot; + hr);\n                }\n\n                hr = ShObjIdl_core_h.IIDFromString(iidITaskbarList3, iidTaskbarList3);\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    throw new RuntimeException(&quot;IIDFromString failed with error code: &quot; + hr);\n                }\n\n                // 4. Create instance of ITaskbarList3\n                hr = ShObjIdl_core_h.CoCreateInstance(clsid, MemorySegment.NULL, ShObjIdl_core_h.CLSCTX_ALL(), iidTaskbarList3, taskbar3PtrToPtr);\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    if (hr == ShObjIdl_core_h.REGDB_E_CLASSNOTREG()) {\n                        System.out.println(&quot;COM class is not registered!&quot;);\n                    }\n                    throw new RuntimeException(&quot;CoCreateInstance failed with error code: &quot; + hr);\n                }\n                // 5. Obtain a pointer to the instance\n                var taskbar3Ptr = taskbar3PtrToPtr.get(ValueLayout.ADDRESS, 0);\n                // Use reinterpret method to have access to the actual ITaskbarList3 instance\n                var taskbarList3Instance = taskbar3Ptr.reinterpret(ITaskbarList3.sizeof());\n\n                // 6. Obtain lpVtbl pointer from ITaskbarList3\n                MemorySegment taskbarList3VtblPtr = ITaskbarList3.lpVtbl(taskbarList3Instance);\n                // Use reinterpret method to have access to the actual ITaskbarList3Vtbl instance\n                MemorySegment taskbarList3Vtbl = taskbarList3VtblPtr.reinterpret(ITaskbarList3Vtbl.sizeof());\n\n                // https://learn.microsoft.com/en-us/windows/win32/api/shobjidl_core/nf-shobjidl_core-itaskbarlist-hrinit\n                // Initializes the taskbar list object. This method must be called before any other ITaskbarList methods can be called.\n                MemorySegment functionHrInitPtr = ITaskbarList3Vtbl.HrInit(taskbarList3Vtbl);\n                hr = ITaskbarList3Vtbl.HrInit.invoke(functionHrInitPtr, taskbarList3Instance);\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    throw new RuntimeException(&quot;HrInit failed with error code: &quot; + hr);\n                }\n\n                // 7. Set progress state to indeterminate\n                MemorySegment functionSetProgressStatePtr = ITaskbarList3Vtbl.SetProgressState(taskbarList3Vtbl);\n                hr = ITaskbarList3Vtbl.SetProgressState.invoke(functionSetProgressStatePtr, taskbarList3Instance, windowHandle, ShObjIdl_core_h.TBPF_INDETERMINATE());\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    throw new RuntimeException(&quot;SetProgressState failed with error code: &quot; + hr);\n                }\n\n                // 8. Simulate some progress\n                for (int i = 0; i &lt; 100; i+=20) {\n                    System.out.println(&quot;Progress is: &quot; + i);\n                    MemorySegment functionSetProgressValuePtr = ITaskbarList3Vtbl.SetProgressValue(taskbarList3Vtbl);\n                    hr = ITaskbarList3Vtbl.SetProgressValue.invoke(functionSetProgressValuePtr, taskbarList3Instance, windowHandle, i, 100);\n                    if (hr != ShObjIdl_core_h.S_OK()) {\n                        throw new RuntimeException(&quot;SetProgressValue failed with error code: &quot; + hr);\n                    }\n                    Thread.sleep(500);\n\n                }\n\n                // 9. Reset progress state\n                hr = ITaskbarList3Vtbl.SetProgressState.invoke(functionSetProgressStatePtr, taskbarList3Instance, windowHandle, ShObjIdl_core_h.TBPF_INDETERMINATE());\n                if (hr != ShObjIdl_core_h.S_OK()) {\n                    throw new RuntimeException(&quot;SetProgressState failed with error code: &quot; + hr);\n                }\n\n            } catch (Throwable ex) {\n                ex.printStackTrace();\n\n            } finally {\n                ShObjIdl_core_h.CoUninitialize();\n            }\n        });\n    }\n\n    public static void main(String[] args) {\n        launch(args);\n    }\n}\n\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}