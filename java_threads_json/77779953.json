{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-boot",
      "java-threads"
    ],
    "owner": {
      "account_id": 5527532,
      "reputation": 91,
      "user_id": 4388598,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/7bf53e7cd8d8b44f9469f331bff8b67b?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Craig Archer",
      "link": "https://stackoverflow.com/users/4388598/craig-archer"
    },
    "is_answered": true,
    "view_count": 2257,
    "answer_count": 1,
    "score": 6,
    "last_activity_date": 1741096986,
    "creation_date": 1704716268,
    "last_edit_date": 1710418564,
    "question_id": 77779953,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/77779953/spring-boot-virtual-threads-djdk-tracepinnedthreads-full-causes-tasks-to-hang",
    "title": "Spring boot virtual threads -Djdk.tracePinnedThreads=full causes tasks to hang",
    "body": "<p>Not sure if this is a spring or java problem. If I run the test with the below setup including -Djdk.tracePinnedThreads=full the test hangs. Without it it runs fine. Any ideas why this might happen. Is there any additional configuration for spring I may need</p>\n<p>pom.xml</p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n    &lt;parent&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;\n        &lt;version&gt;3.2.0&lt;/version&gt;\n        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;\n    &lt;/parent&gt;\n    &lt;groupId&gt;org.test&lt;/groupId&gt;\n    &lt;artifactId&gt;virtual-spring&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;name&gt;VirtualSpring&lt;/name&gt;\n    &lt;description&gt;Virtual Spring Boot&lt;/description&gt;\n    &lt;properties&gt;\n        &lt;java.version&gt;21&lt;/java.version&gt;\n    &lt;/properties&gt;\n    &lt;dependencies&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n           \n        &lt;!--Testing--&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n\n    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n\n&lt;/project&gt;\n</code></pre>\n<p>application.properties</p>\n<pre><code>spring.main.keep-alive=true\nspring.threads.virtual.enabled=true\n</code></pre>\n<p>application class</p>\n<pre><code>package org.test;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\n\n@SpringBootApplication\npublic class VirtualSpringApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(VirtualSpringApplication.class, args);\n    }\n\n}\n</code></pre>\n<p>and test class</p>\n<pre><code>package org.test;\n\nimport org.junit.jupiter.api.Test;\nimport org.springframework.boot.test.context.SpringBootTest;\n\n@SpringBootTest\nclass VirtualSpringApplicationTests {\n\n    @Test\n    public void pinned() throws InterruptedException {\n\n        final Thread thread0 = Thread.startVirtualThread(() -&gt; testForPin(0));\n        final Thread thread1 = Thread.startVirtualThread(() -&gt; testForPin(1));\n        final Thread thread2 = Thread.startVirtualThread(() -&gt; testForPin(2));\n        System.out.println(&quot;THREADS STARTED\\n&quot;);\n\n        thread0.join();\n        thread1.join();\n        thread2.join();\n\n    }\n\n    synchronized public void testForPin(final int i) {\n\n        System.out.println(&quot;Thread: &quot; + Thread.currentThread().toString() + &quot;, virtual=&quot; + Thread.currentThread().isVirtual() + &quot; i=&quot; + i);\n        try {\n            Thread.sleep(1000);\n            System.out.println(&quot;Thread Finished: &quot; + Thread.currentThread().toString() + &quot;, virtual=&quot; + Thread.currentThread().isVirtual() + &quot; i=&quot; + i);\n        } catch (final InterruptedException e) {\n            throw new RuntimeException(e);\n        }\n    }\n}\n\n</code></pre>\n<p>Update 1:jhsdb showing blocked threads (only relevant output shown due to size)</p>\n<pre><code>jhsdb jstack --pid 16244\nAttaching to process ID 16244, please wait...\nDebugger attached successfully.\nServer compiler detected.\nJVM version is 21.0.2+13-58\nDeadlock Detection:\n\nNo deadlocks found.\n\n&quot;ForkJoinPool-1-worker-1&quot; #61 daemon prio=5 tid=0x0000025b552abba0 nid=13468 waiting on condition [0x000000e1986fe000]\n   java.lang.Thread.State: RUNNABLE\n   JavaThread state: _thread_blocked\n - java.lang.VirtualThread$VThreadContinuation.onPinned(jdk.internal.vm.Continuation$Pinned) @bci=23, line=183 (Interpreted frame)\n - jdk.internal.vm.Continuation.onPinned0(int) @bci=5, line=393 (Interpreted frame)\n - jdk.internal.vm.Continuation.yield0(jdk.internal.vm.ContinuationScope, jdk.internal.vm.Continuation) @bci=325, line=385 (Interpreted frame)\n - jdk.internal.vm.Continuation.yield(jdk.internal.vm.ContinuationScope) @bci=69, line=351 (Interpreted frame)\n - java.lang.VirtualThread.yieldContinuation() @bci=12, line=431 (Interpreted frame)\n - java.lang.VirtualThread.parkNanos(long) @bci=69, line=621 (Interpreted frame)\n - java.lang.VirtualThread.sleepNanos(long) @bci=70, line=791 (Interpreted frame)\n - java.lang.Thread.sleep(long) @bci=53, line=507 (Interpreted frame)\n - org.test.VirtualSpringApplicationTests.testForPin(int) @bci=27, line=27 (Interpreted frame)\n        - locked &lt;0x0000000621801bb8&gt; (a org.test.VirtualSpringApplicationTests)\n - org.test.VirtualSpringApplicationTests.lambda$pinned$0() @bci=2, line=12 (Interpreted frame)\n - org.test.VirtualSpringApplicationTests$$Lambda+0x0000025b58449680.run() @bci=4 (Interpreted frame)\n - java.lang.Thread.runWith(java.lang.Object, java.lang.Runnable) @bci=5, line=1596 (Interpreted frame)\n - java.lang.VirtualThread.run(java.lang.Runnable) @bci=63, line=309 (Interpreted frame)\n - java.lang.VirtualThread$VThreadContinuation$1.run() @bci=8, line=190 (Interpreted frame)\n - jdk.internal.vm.Continuation.enter0() @bci=4, line=320 (Interpreted frame)\n - jdk.internal.vm.Continuation.enter(jdk.internal.vm.Continuation, boolean) @bci=1, line=312 (Interpreted frame)\n - jdk.internal.vm.Continuation.enterSpecial(jdk.internal.vm.Continuation, boolean, boolean) @bci=0 (Compiled frame)\n - jdk.internal.vm.Continuation.run() @bci=122, line=248 (Interpreted frame)\n - java.lang.VirtualThread.runContinuation() @bci=71, line=221 (Interpreted frame)\n - java.lang.VirtualThread$$Lambda+0x0000025b5838ac20.run() @bci=4 (Interpreted frame)\n - java.util.concurrent.ForkJoinTask$RunnableExecuteAction.exec() @bci=4, line=1423 (Interpreted frame)\n - java.util.concurrent.ForkJoinTask.doExec() @bci=10, line=387 (Interpreted frame)\n - java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(java.util.concurrent.ForkJoinTask, java.util.concurrent.ForkJoinPool$WorkQueue) @bci=19, line=1312 (Interpreted frame)\n - java.util.concurrent.ForkJoinPool.scan(java.util.concurrent.ForkJoinPool$WorkQueue, int, int) @bci=211, line=1843 (Interpreted frame)\n - java.util.concurrent.ForkJoinPool.runWorker(java.util.concurrent.ForkJoinPool$WorkQueue) @bci=35, line=1808 (Interpreted frame)\n - java.util.concurrent.ForkJoinWorkerThread.run() @bci=31, line=188 (Interpreted frame)\n\n\n&quot;ForkJoinPool-1-worker-2&quot; #64 daemon prio=5 tid=0x0000025b552ac230 nid=1028 waiting for monitor entry [0x000000e1987fe000]\n   java.lang.Thread.State: BLOCKED (on object monitor)\n   JavaThread state: _thread_blocked\n - org.test.VirtualSpringApplicationTests.testForPin(int) @bci=0, line=25 (Interpreted frame)\n        - waiting to lock &lt;0x0000000621801bb8&gt; (a org.test.VirtualSpringApplicationTests)\n - org.test.VirtualSpringApplicationTests.lambda$pinned$1() @bci=2, line=13 (Interpreted frame)\n - org.test.VirtualSpringApplicationTests$$Lambda+0x0000025b584498a0.run() @bci=4 (Interpreted frame)\n - java.lang.Thread.runWith(java.lang.Object, java.lang.Runnable) @bci=5, line=1596 (Interpreted frame)\n - java.lang.VirtualThread.run(java.lang.Runnable) @bci=63, line=309 (Interpreted frame)\n - java.lang.VirtualThread$VThreadContinuation$1.run() @bci=8, line=190 (Interpreted frame)\n - jdk.internal.vm.Continuation.enter0() @bci=4, line=320 (Interpreted frame)\n - jdk.internal.vm.Continuation.enter(jdk.internal.vm.Continuation, boolean) @bci=1, line=312 (Interpreted frame)\n - jdk.internal.vm.Continuation.enterSpecial(jdk.internal.vm.Continuation, boolean, boolean) @bci=0 (Compiled frame)\n - jdk.internal.vm.Continuation.run() @bci=122, line=248 (Interpreted frame)\n - java.lang.VirtualThread.runContinuation() @bci=71, line=221 (Interpreted frame)\n - java.lang.VirtualThread$$Lambda+0x0000025b5838ac20.run() @bci=4 (Interpreted frame)\n - java.util.concurrent.ForkJoinTask$RunnableExecuteAction.exec() @bci=4, line=1423 (Interpreted frame)\n - java.util.concurrent.ForkJoinTask.doExec() @bci=10, line=387 (Interpreted frame)\n - java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(java.util.concurrent.ForkJoinTask, java.util.concurrent.ForkJoinPool$WorkQueue) @bci=19, line=1312 (Interpreted frame)\n - java.util.concurrent.ForkJoinPool.scan(java.util.concurrent.ForkJoinPool$WorkQueue, int, int) @bci=211, line=1843 (Interpreted frame)\n - java.util.concurrent.ForkJoinPool.runWorker(java.util.concurrent.ForkJoinPool$WorkQueue) @bci=35, line=1808 (Interpreted frame)\n - java.util.concurrent.ForkJoinWorkerThread.run() @bci=31, line=188 (Interpreted frame)\n\n\n&quot;ForkJoinPool-1-worker-3&quot; #65 daemon prio=5 tid=0x0000025b552acf50 nid=11824 waiting for monitor entry [0x000000e1988fe000]\n   java.lang.Thread.State: BLOCKED (on object monitor)\n   JavaThread state: _thread_blocked\n - org.test.VirtualSpringApplicationTests.testForPin(int) @bci=0, line=25 (Interpreted frame)\n        - waiting to lock &lt;0x0000000621801bb8&gt; (a org.test.VirtualSpringApplicationTests)\n - org.test.VirtualSpringApplicationTests.lambda$pinned$2() @bci=2, line=14 (Interpreted frame)\n - org.test.VirtualSpringApplicationTests$$Lambda+0x0000025b58449ac0.run() @bci=4 (Interpreted frame)\n - java.lang.Thread.runWith(java.lang.Object, java.lang.Runnable) @bci=5, line=1596 (Interpreted frame)\n - java.lang.VirtualThread.run(java.lang.Runnable) @bci=63, line=309 (Interpreted frame)\n - java.lang.VirtualThread$VThreadContinuation$1.run() @bci=8, line=190 (Interpreted frame)\n - jdk.internal.vm.Continuation.enter0() @bci=4, line=320 (Interpreted frame)\n - jdk.internal.vm.Continuation.enter(jdk.internal.vm.Continuation, boolean) @bci=1, line=312 (Interpreted frame)\n - jdk.internal.vm.Continuation.enterSpecial(jdk.internal.vm.Continuation, boolean, boolean) @bci=0 (Compiled frame)\n - jdk.internal.vm.Continuation.run() @bci=122, line=248 (Interpreted frame)\n - java.lang.VirtualThread.runContinuation() @bci=71, line=221 (Interpreted frame)\n - java.lang.VirtualThread$$Lambda+0x0000025b5838ac20.run() @bci=4 (Interpreted frame)\n - java.util.concurrent.ForkJoinTask$RunnableExecuteAction.exec() @bci=4, line=1423 (Interpreted frame)\n - java.util.concurrent.ForkJoinTask.doExec() @bci=10, line=387 (Interpreted frame)\n - java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(java.util.concurrent.ForkJoinTask, java.util.concurrent.ForkJoinPool$WorkQueue) @bci=19, line=1312 (Interpreted frame)\n - java.util.concurrent.ForkJoinPool.scan(java.util.concurrent.ForkJoinPool$WorkQueue, int, int) @bci=211, line=1843 (Interpreted frame)\n - java.util.concurrent.ForkJoinPool.runWorker(java.util.concurrent.ForkJoinPool$WorkQueue) @bci=35, line=1808 (Interpreted frame)\n - java.util.concurrent.ForkJoinWorkerThread.run() @bci=31, line=188 (Interpreted frame)\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}