{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-boot",
      "unit-testing"
    ],
    "owner": {
      "account_id": 35620455,
      "reputation": 23,
      "user_id": 27310840,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/29d835a74dcd5192976712a6320d1877?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "John Bubbles",
      "link": "https://stackoverflow.com/users/27310840/john-bubbles"
    },
    "is_answered": true,
    "view_count": 1423,
    "accepted_answer_id": 79351420,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1739463700,
    "creation_date": 1736345480,
    "question_id": 79339483,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79339483/spring-cloud-gateway-tests-fail-after-upgrade-to-spring-boot-3-4-0-specifically",
    "title": "Spring Cloud Gateway tests fail after upgrade to Spring Boot 3.4.0 (specifically spring-web 6.2.0)",
    "body": "<p>After upgrading to Spring Boot 3.4.0 (Spring Web 6.2.0), my Gateway filter tests started failing. The tests previously verified that request headers were modified correctly, but now the modifications don't seem to be visible in the test assertions.</p>\n<p>Here's a simplified example that used to pass but now fails:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Component\nclass TestGatewayFilter implements GatewayFilter {\n    public TestGatewayFilter() {\n    }\n\n    @Override\n    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        Builder builder = exchange.getRequest().mutate();\n        builder.header(&quot;test-header&quot;, &quot;test&quot;);\n        return chain.filter(exchange.mutate().request(builder.build()).build());\n\n    }\n}\n\n@ExtendWith(MockitoExtension.class)\nclass TestGatewayFilterTest {\n\n    @InjectMocks\n    private TestGatewayFilter testGatewayFilter;\n\n    @Test\n    void shouldRunFilter() {\n        MockServerHttpRequest mockRequest = MockServerHttpRequest\n                .get(&quot;/testfilter&quot;)\n                .build();\n        MockServerWebExchange exchange = MockServerWebExchange.from(mockRequest);\n\n        Mono&lt;Void&gt; result = testGatewayFilter.filter(exchange, e -&gt; Mono.empty());\n        StepVerifier.create(result)\n                .verifyComplete();\n\n        assertEquals(&quot;test&quot;, exchange.getRequest().getHeaders().getFirst(&quot;test-header&quot;));\n    }\n}\n</code></pre>\n<p>Dependencies:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>\n&lt;parent&gt;\n    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;\n    &lt;version&gt;3.4.0&lt;/version&gt;\n&lt;/parent&gt;\n\n&lt;properties&gt;\n    &lt;java.version&gt;17&lt;/java.version&gt;\n&lt;/properties&gt;\n\n&lt;dependencies&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;\n        &lt;artifactId&gt;reactor-test&lt;/artifactId&gt;\n        &lt;version&gt;3.7.1&lt;/version&gt;\n        &lt;scope&gt;test&lt;/scope&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;\n        &lt;artifactId&gt;commons-text&lt;/artifactId&gt;\n        &lt;version&gt;1.13.0&lt;/version&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n        &lt;scope&gt;test&lt;/scope&gt;\n    &lt;/dependency&gt;\n&lt;/dependencies&gt;\n\n&lt;dependencyManagement&gt;\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-gateway-dependencies&lt;/artifactId&gt;\n            &lt;version&gt;4.2.0&lt;/version&gt;\n            &lt;type&gt;pom&lt;/type&gt;\n            &lt;scope&gt;import&lt;/scope&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n&lt;/dependencyManagement&gt;\n</code></pre>\n<p>The test passes with Spring Boot 3.3.x (which includes Spring Web 6.1.x) but fails with 3.4.0 (which includes Spring web 6.2.x). I've looked through the Spring Framework 6.2 release notes but couldn't find any mention of changes to ServerWebExchange or MockServerWebExchange behavior.</p>\n<p>I'd like to test whether other services are interacted with in this unit test too.\nQuestions:</p>\n<ol>\n<li>Is this a known breaking change?</li>\n<li>What's the correct way to verify request headers and interacted services in Gateway filter tests now?</li>\n<li>If this is unintended behavior, where should I report it?</li>\n</ol>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}