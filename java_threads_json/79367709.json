{
  "question": {
    "tags": [
      "java",
      "mongodb",
      "spring-boot",
      "reactive"
    ],
    "owner": {
      "account_id": 16731772,
      "reputation": 1963,
      "user_id": 12093975,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/642f88ba5698f301f23e69a563c65bc6?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "skyho",
      "link": "https://stackoverflow.com/users/12093975/skyho"
    },
    "is_answered": true,
    "view_count": 277,
    "answer_count": 2,
    "score": 0,
    "last_activity_date": 1758802500,
    "creation_date": 1737223351,
    "question_id": 79367709,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79367709/error-when-trying-to-test-mongodb-via-testcontainers-this-host-is-unknown",
    "title": "Error when trying to test MongoDB via testcontainers (This host is unknown )",
    "body": "<p>I have a service on Spring boot where a custom configuration is set up that works with MongoDB's ReplicaSet</p>\n<pre class=\"lang-none prettyprint-override\"><code>plugins {\n    id 'java'\n    id 'org.springframework.boot' version '3.2.1'\n    id 'io.spring.dependency-management' version '1.1.4'\n}\n\n\njava {\n    toolchain {\n        languageVersion = JavaLanguageVersion.of(17)\n    }\n}\n\n....\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@Configuration\n@RequiredArgsConstructor\n@EnableConfigurationProperties(MongoPropertiesCustom.class)\n@EnableReactiveMongoRepositories(basePackageClasses = {SubscriptionRepository.class})\npublic class MongoConfig extends AbstractReactiveMongoConfiguration {\n\n    private final MongoPropertiesCustom mongoPropertiesCustom;\n\n    @Override\n    protected String getDatabaseName() {\n        return mongoPropertiesCustom.getDatabase();\n    }\n\n    @Override\n    public MongoClient reactiveMongoClient() {\n        return MongoClients.create(mongoPropertiesCustom.buildUri());\n    }\n\n    @Bean\n    public ReactiveMongoTemplate reactiveMongoTemplate() {\n        return new ReactiveMongoTemplate(reactiveMongoClient(), getDatabaseName());\n    }\n    @Bean\n    public CommandLineRunner initializeIndexes(ReactiveMongoTemplate mongoTemplate) {\n        return args -&gt; {\n            \n            mongoTemplate.indexOps(SubscriptionDocument.class)\n                    .ensureIndex(new Index().on(&quot;id&quot;, Sort.Direction.ASC).unique())\n                    .subscribe();\n            mongoTemplate.indexOps(ProcessingError.class)\n                    .ensureIndex(new Index().on(&quot;timestamp&quot;, Sort.Direction.DESC))\n                    .subscribe();\n        };\n    }\n\n    @Bean\n    public ReactiveMongoTransactionManager transactionManager(ReactiveMongoDatabaseFactory factory) {\n        return new ReactiveMongoTransactionManager(factory);\n    }\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>\n@ConfigurationProperties(prefix = &quot;mongodb&quot;)\n@Data\npublic class MongoPropertiesCustom {\n\n    private String host = &quot;&quot;;\n    private int port = 0;\n    private String database = &quot;&quot;;\n    private String username;\n    private String password;\n    private String authSource = &quot;&quot;;\n    private String replicaSet;\n\n    public String buildUri() {\n        return String.format(&quot;mongodb://%s:%s@%s:%d/%s?authSource=%s&amp;replicaSet=%s&quot;,\n                username, password, host, port, database, authSource, replicaSet);\n    }\n}\n\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@Component\n@RequiredArgsConstructor\n@Slf4j\npublic class SubscriptionRepository {\n\n    private final ReactiveMongoTemplate mongoTemplate;\n    private final ReactiveMongoTransactionManager transactionManager;\n\n    public Mono&lt;SubscriptionDocument&gt; save(SubscriptionDocument subscription) {\n       \n        TransactionalOperator transactionalOperator = TransactionalOperator.create(transactionManager);\n\n        return mongoTemplate.save(subscription)\n                .doOnSuccess(saved -&gt; log.debug(&quot;Saved subscription: {}&quot;, saved))\n                .doOnError(error -&gt; log.error(&quot;Error saving subscription: {}&quot;, error.getMessage()))\n                \n                .as(transactionalOperator::transactional);\n    }\n............\n</code></pre>\n<p><strong>tests</strong></p>\n<pre class=\"lang-java prettyprint-override\"><code>@SpringBootTest(classes = {\n        MongoConfig.class,\n        SubscriptionRepository.class\n})\n@ActiveProfiles(&quot;test&quot;)\n@Testcontainers\nclass SubscriptionRepositoryTest {\n    private static final Logger log = LoggerFactory.getLogger(SubscriptionRepositoryTest.class);\n\n      @Container\n    static MongoDBContainer mongoDBContainer = new MongoDBContainer(&quot;mongo:6.0&quot;)\n            .withCommand(\n                    &quot;--replSet&quot;, &quot;rs0&quot;,\n                    &quot;--bind_ip_all&quot;,\n                    &quot;--setParameter&quot;, &quot;transactionLifetimeLimitSeconds=30&quot;\n            );\n\n    @Autowired\n    private SubscriptionRepository subscriptionRepository;\n\n    @DynamicPropertySource\n    static void setProperties(DynamicPropertyRegistry registry) {\n        mongoDBContainer.start();\n\n        String containerIpAddress = mongoDBContainer.getHost();\n        Integer mappedPort = mongoDBContainer.getFirstMappedPort();\n\n        log.info(&quot;MongoDB container started at {}:{}&quot;, containerIpAddress, mappedPort);\n\n        initializeReplicaSet(mongoDBContainer);\n\n        registry.add(&quot;mongodb.host&quot;, () -&gt; containerIpAddress);\n        registry.add(&quot;mongodb.port&quot;, () -&gt; mappedPort);\n        registry.add(&quot;mongodb.database&quot;, () -&gt; &quot;test&quot;);\n        registry.add(&quot;mongodb.username&quot;, () -&gt; &quot;root&quot;);\n        registry.add(&quot;mongodb.password&quot;, () -&gt; &quot;root&quot;);\n        registry.add(&quot;mongodb.authSource&quot;, () -&gt; &quot;admin&quot;);\n        registry.add(&quot;mongodb.replicaSet&quot;, () -&gt; &quot;rs0&quot;);\n    }\n\n    private static void initializeReplicaSet(MongoDBContainer container) {\n        try {\n\n            log.info(&quot;Starting replica set initialization...&quot;);\n            Thread.sleep(1000);\n\n            String containerIpAddress = container.getHost();\n            Integer mappedPort = container.getFirstMappedPort();\n\n            log.info(&quot;Using host: {}, port: {}&quot;, containerIpAddress, mappedPort);\n\n            String rsConfig = String.format(\n                    &quot;rs.initiate({&quot; +\n                            &quot;_id: 'rs0',&quot; +\n                            &quot;members: [{&quot; +\n                            &quot;_id: 0,&quot; +\n                            &quot;host: '%s:%d',&quot; +\n                            &quot;priority: 1&quot; +\n                            &quot;}],&quot; +\n                            &quot;settings: {&quot; +\n                            &quot;electionTimeoutMillis: 2000&quot; +\n                          \n                            &quot;}&quot; +\n                            &quot;})&quot;,\n                    containerIpAddress, mappedPort\n            );\n\n            log.info(&quot;Initializing replica set with config: {}&quot;, rsConfig);\n\n            org.testcontainers.containers.Container.ExecResult initResult = container.execInContainer(\n                    &quot;mongosh&quot;,\n                    &quot;--eval&quot;,\n                    rsConfig\n            );\n            log.info(&quot;Initialization result - stdout: {}&quot;, initResult.getStdout());\n\n          \n            org.testcontainers.containers.Container.ExecResult statusResult = container.execInContainer(\n                    &quot;mongosh&quot;,\n                    &quot;--eval&quot;,\n                    &quot;rs.status()&quot;\n            );\n            log.info(&quot;Replica set status: {}&quot;, statusResult.getStdout());\n            Thread.sleep(2000);\n\n            ConnectionString connectionString = new ConnectionString(\n                    String.format(&quot;mongodb://%s:%d/?directConnection=true&quot;,\n                            containerIpAddress, mappedPort)\n            );\n\n            try (MongoClient testClient = MongoClients.create(connectionString)) {\n                Mono.from(testClient.getDatabase(&quot;admin&quot;)\n                                .runCommand(new Document(&quot;ping&quot;, 1)))\n                        .block(Duration.ofSeconds(10));\n                log.info(&quot;Replica set initialized successfully&quot;);\n\n                String createUserCommand = &quot;db.getSiblingDB('admin').createUser({&quot; +\n                        &quot;user: 'root',&quot; +\n                        &quot;pwd: 'root',&quot; +\n                        &quot;roles: ['root']&quot; +\n                        &quot;})&quot;;\n\n                org.testcontainers.containers.Container.ExecResult createUserResult = container.execInContainer(\n                        &quot;mongosh&quot;,\n                        &quot;--eval&quot;,\n                        createUserCommand\n                );\n                log.info(&quot;Create user result: {}&quot;, createUserResult.getStdout());\n\n                String checkUserCommand = &quot;db.getSiblingDB('admin').getUser('root')&quot;;\n                org.testcontainers.containers.Container.ExecResult checkUserResult = container.execInContainer(\n                        &quot;mongosh&quot;,\n                        &quot;--eval&quot;,\n                        checkUserCommand\n                );\n                log.info(&quot;User check result: {}&quot;, checkUserResult.getStdout());\n\n                String authTestCommand = &quot;db.getSiblingDB('admin').auth('root', 'root')&quot;;\n                org.testcontainers.containers.Container.ExecResult authTestResult = container.execInContainer(\n                        &quot;mongosh&quot;,\n                        &quot;--eval&quot;,\n                        authTestCommand\n                );\n                log.info(&quot;Auth test result: {}&quot;, authTestResult.getStdout());\n            }\n\n        } catch (Exception e) {\n            log.error(&quot;Failed to initialize replica set&quot;, e);\n            throw new RuntimeException(&quot;Failed to initialize replica set&quot;, e);\n        }\n    }\n\n\n    @BeforeEach\n    void setUp() {\n        log.info(&quot;Cleaning up database before test&quot;);\n        subscriptionRepository.dropAllCollections()\n                .doOnSuccess(v -&gt; log.info(&quot;Database cleaned successfully&quot;))\n                .doOnError(e -&gt; log.error(&quot;Error cleaning database&quot;, e))\n                .block();\n    }\n\n.....\n\n</code></pre>\n<p>After when are runned test ....</p>\n<blockquote>\n<p>2025-01-18T20:43:08.861+03:00  INFO 2560 --- [consumer] [-localhost:3316] org.mongodb.driver.cluster               : Server localhost:3316 is no longer a member of the replica set.  Removing from client view of cluster.\n2025-01-18T20:43:08.862+03:00  INFO 2560 --- [consumer] [-localhost:3316] org.mongodb.driver.cluster               : Discovered replica set primary localhost:3316 with max election id 7fffffff0000000000000001 and max set version 1\n2025-01-18T20:43:09.233+03:00  INFO 2560 --- [consumer] [    Test worker] c.repository.SubscriptionRepositoryTest  : Started SubscriptionRepositoryTest in 8.815 seconds (process running for 14.105)\n2025-01-18T20:43:09.317+03:00  INFO 2560 --- [consumer] [    Test worker] org.mongodb.driver.cluster               : No server chosen by WritableServerSelector from cluster description ClusterDescription{type=REPLICA_SET, connectionMode=MULTIPLE, serverDescriptions=[ServerDescription{address=localhost:3316, type=UNKNOWN, state=CONNECTING}]}. Waiting for 30000 ms before timing out\n2025-01-18T20:43:09.324+03:00  INFO 2560 --- [consumer] [    Test worker] org.mongodb.driver.cluster               : No server chosen by WritableServerSelector from cluster description ClusterDescription{type=REPLICA_SET, connectionMode=MULTIPLE, serverDescriptions=[ServerDescription{address=localhost:3316, type=UNKNOWN, state=CONNECTING}]}. Waiting for 30000 ms before timing out\n2025-01-18T20:43:10.541+03:00  INFO 2560 --- [consumer] [    Test worker] c.repository.SubscriptionRepositoryTest  : Cleaning up database before test\n2025-01-18T20:43:10.638+03:00  INFO 2560 --- [consumer] [    Test worker] org.mongodb.driver.cluster               : No server chosen by ReadPreferenceServerSelector{readPreference=primary} from cluster description ClusterDescription{type=REPLICA_SET, connectionMode=MULTIPLE, serverDescriptions=[ServerDescription{address=localhost:3316, type=UNKNOWN, state=CONNECTING}]}. Waiting for 30000 ms before timing out\n2025-01-18T20:43:11.151+03:00  INFO 2560 --- [consumer] [3de90b922:27017] org.mongodb.driver.cluster               : Exception in monitor thread while connecting to server 3c43de90b922:27017</p>\n</blockquote>\n<p>com.mongodb.MongoSocketException: This host is unknown (3c43de90b922)\nat com.mongodb.ServerAddress.getSocketAddresses(ServerAddress.java:221) ~[mongodb-driver-core-4.11.1.jar:na]</p>\n<p>Does anyone have any ideas why the initialization of the replica set is successful, as are the checks, then the connectionString for ReactiveMongoTemplate is also successfully formed, but at some point in time the external address is not accessed, that is, MongoDB inside the container uses its internal hostname (22e0b261103c), but this hostname is not available outside the container?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}