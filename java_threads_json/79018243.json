{
  "question": {
    "tags": [
      "java",
      "azure-keyvault",
      "keystore",
      "code-signing",
      "code-signing-certificate"
    ],
    "owner": {
      "account_id": 3127321,
      "reputation": 121,
      "user_id": 2645946,
      "user_type": "registered",
      "profile_image": "https://i.sstatic.net/xzy7I.png?s=256",
      "display_name": "scaryxited",
      "link": "https://stackoverflow.com/users/2645946/scaryxited"
    },
    "is_answered": true,
    "view_count": 1122,
    "answer_count": 2,
    "score": 0,
    "last_activity_date": 1741588128,
    "creation_date": 1727175072,
    "last_edit_date": 1727175612,
    "question_id": 79018243,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79018243/how-do-i-correctly-code-sign-using-a-certificate-stored-in-azure-key-vault-with",
    "title": "How do I correctly code sign using a certificate stored in Azure Key Vault with the trust chain included?",
    "body": "<p>Our CA, GlobalSign has issued a code signing certificate meant for an HSM. I created a Premium licensed Key Vault in Azure since the basic doesn't support HSM. I then generated a certificate in the Key Vault using the following Issuance Policy:</p>\n<ul>\n<li>Type of Certificate Authority (CA): <strong>Certificate issued by a\nnon-integrated CA</strong></li>\n<li>Subject: <strong>C=US, L=Doeville, O=JohnDoe, CN=JohnDoe,\nE=johndoe@doe.com</strong></li>\n<li>DNS Names: <strong>0 DNS names</strong></li>\n<li>Validity Period (in months): <strong>24</strong></li>\n<li>Content Type: <strong>PKCS#12</strong></li>\n<li>Enabled: <strong>Yes</strong></li>\n</ul>\n<p><strong>Advanced Policy Configuration</strong></p>\n<ul>\n<li>Extended Key Usages (EKUs): <strong>1.3.6.1.5.5.7.3.3</strong></li>\n<li>X.509 Key Usage Flags: <strong>Digital Signature, Key Encipherment</strong></li>\n<li>Reuse Key on Renewal?: <strong>No</strong></li>\n<li>Exportable Private Key?: <strong>No</strong></li>\n<li>Key Type: <strong>RSA-HSM</strong></li>\n<li>Key Size: <strong>4096</strong></li>\n<li>Enable Certificate Transparency?: <strong>Yes</strong></li>\n<li>Certificate Type: {Empty}</li>\n</ul>\n<p>Once it was instanced in the key vault, I clicked on Certificate Operation and downloaded the CSR.</p>\n<p>I followed the download link provided by Global Sign and copied and pasted the CSR. After the certificates had been generated, I got a page where I could download the Digital certificate and 2 intermediate certificates. The file names were: OS123456789.cer, intermediate1.cer and intermediate2.cer</p>\n<p>I then went back to the Azure Key Vault and click on &quot;Merge signed request&quot; I then picked the OS123456789.cer file, and it was successful.</p>\n<p>I then started getting to work on using jarsigner to sign my jars.\nI downloaded <strong>azure-security-keyvault-jca-2.8.1.jar</strong> and placed it in the %JAVA_HOME&amp;/jre/lib/ext</p>\n<p>The jarsigner command I use is this:</p>\n<pre><code>jarsigner -keystore NONE  -storetype AzureKeyVault -verbose  -storepass &quot;&quot; -tsa http://timestamp.globalsign.com/tsa/r6advanced1 -providerName AzureKeyVault -providerClass com.azure.security.keyvault.jca.KeyVaultJcaProvider -J&quot;-Dazure.keyvault.uri=$KEYVAULT_URL&quot; -J&quot;-Dazure.keyvault.tenant-id=$TENANT&quot; -J&quot;-Dazure.keyvault.client-id=$CLIENT_ID&quot; -J&quot;-Dazure.keyvault.client-secret=$CLIENT_SECRET&quot; -signedjar &quot;signed.jar&quot; &quot;unsigned.jar&quot; $CERT_ALIAS\n</code></pre>\n<p>The signing output looks like this:</p>\n<pre><code>updating: META-INF/MANIFEST.MF\nadding: META-INF/GLOBALSI.SF\nrequesting a signature timestamp\nTSA location: http://timestamp.globalsign.com/tsa/r6advanced1\nadding: META-INF/GLOBALSI.RSA\nA BUNCH OF FILES\nsigning: clientlogging.properties\nadding: JNLP-INF/\nsigning: JNLP-INF/APPLICATION_TEMPLATE.JNLP\n&gt;&gt;&gt; Signer\nX.509, EMAILADDRESS=johndoe@doe.com, CN=JohnDoe, O=JohnDoe, L=DoeVille, C=US\n[trusted certificate]\n&gt;&gt;&gt; TSA\nX.509, CN=Globalsign TSA for CodeSign1 - R6 - 202311, O=GlobalSign nv-sa, C=BE\n[certificate is valid from 07/11/23 18:13 to 09/12/34 18:13]\nX.509, CN=GlobalSign Timestamping CA - SHA384 - G4, O=GlobalSign nv-sa, C=BE\n[certificate is valid from 20/06/18 02:00 to 10/12/34 01:00]\nX.509, CN=GlobalSign, O=GlobalSign, OU=GlobalSign Root CA - R6\n[trusted certificate]\n\njar signed.\n\nThe timestamp will expire on 2034-12-09.\n</code></pre>\n<p>It looks good so far, I think.\nHowever, when I run:</p>\n<pre><code>jarsigner -verify -verbose -certs signed.jar\n</code></pre>\n<p>I get the following output:</p>\n<pre><code>s 291951 Tue Sep 24 12:09:10 CEST 2024 META-INF/MANIFEST.MF\n\n&gt;&gt;&gt; Signer\nX.509, EMAILADDRESS=johndoe@doe.com, CN=JohnDoe, O=JohnDoe, L=DoeVille, C=US\n[certificate is valid from 20/09/24 16:00 to 03/09/27 14:19]\n[Invalid certificate chain: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target]\n&gt;&gt;&gt; TSA\nX.509, CN=Globalsign TSA for CodeSign1 - R6 - 202311, O=GlobalSign nv-sa, C=BE\n[certificate is valid from 07/11/23 18:13 to 09/12/34 18:13]\nX.509, CN=GlobalSign Timestamping CA - SHA384 - G4, O=GlobalSign nv-sa, C=BE\n[certificate is valid from 20/06/18 02:00 to 10/12/34 01:00]\nX.509, CN=GlobalSign, O=GlobalSign, OU=GlobalSign Root CA - R6\n[trusted certificate]\n\n292002 Tue Sep 24 12:09:12 CEST 2024 META-INF/GLOBALSI.SF\n8401 Tue Sep 24 12:09:12 CEST 2024 META-INF/GLOBALSI.RSA\n0 Tue Sep 10 16:47:38 CEST 2024 META-INF/\n    \nA BUNCH OF FILES\n\nsm 1111 Tue Sep 10 16:47:36 CEST 2024 JNLP-INF/APPLICATION_TEMPLATE.JNLP\n[entry was signed on 24/09/24 12:09]\n&gt;&gt;&gt; Signer\nX.509, EMAILADDRESS=johndoe@doe.com, CN=JohnDoe, O=JohnDoe, L=DoeVille, C=US\n[certificate is valid from 20/09/24 16:00 to 03/09/27 14:19]\n[Invalid certificate chain: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target]\n&gt;&gt;&gt; TSA\nX.509, CN=Globalsign TSA for CodeSign1 - R6 - 202311, O=GlobalSign nv-sa, C=BE\n[certificate is valid from 07/11/23 18:13 to 09/12/34 18:13]\nX.509, CN=GlobalSign Timestamping CA - SHA384 - G4, O=GlobalSign nv-sa, C=BE\n[certificate is valid from 20/06/18 02:00 to 10/12/34 01:00]\nX.509, CN=GlobalSign, O=GlobalSign, OU=GlobalSign Root CA - R6\n[trusted certificate]\n\ns = signature was verified \nm = entry is listed in manifest\nk = at least one certificate was found in keystore\ni = at least one certificate was found in identity scope\n\nSigned by &quot;EMAILADDRESS=johndoe@doe.com, CN=JohnDoe, O=JohnDoe, L=DoeVille, C=US&quot;\nDigest algorithm: SHA-256\nSignature algorithm: SHA256withRSA, 4096-bit key\nTimestamped by &quot;CN=Globalsign TSA for CodeSign1 - R6 - 202311, O=GlobalSign nv-sa, C=BE&quot; on Tue Sep 24 10:09:12 UTC 2024\nTimestamp digest algorithm: SHA-256\nTimestamp signature algorithm: SHA256withSHA256withRSA, 3072-bit key\n\njar verified.\n\nWarning: \nThis jar contains entries whose certificate chain is invalid. Reason: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target\n\nThe signer certificate will expire on 2027-09-03.\nThe timestamp will expire on 2034-12-09.\n</code></pre>\n<p>The verification fails with the following warning:</p>\n<pre><code>This jar contains entries whose certificate chain is invalid. Reason: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target\n</code></pre>\n<p>As far as I understand, this occurs because it is unable to determine a chain of trust to the CA.\nI then used keytool to import the intermediate certificates into my local keystore located under my home directory. I then signed the jar files again and this time jarsigner was able to verify the jar file without any warnings.</p>\n<p>However, when I then deploy the java application and the users download the jnlp file and attempt to install the java application, they get a warning popup saying that the signed application is not trusted.</p>\n<p>We are using java 8. Tried both the latest Amazon Corretto and Oracles</p>\n<p>My questions are:</p>\n<ol>\n<li>Do you have any ideas on how to solve this?</li>\n<li>Is it possible to include the intermediate certs when merging the signed request, and will that solve the issue?</li>\n</ol>\n<p>Thanks for any assistance you can be provided.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}