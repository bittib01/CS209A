{
  "question": {
    "tags": [
      "java",
      "ssl",
      "websphere-liberty",
      "open-liberty",
      "java-http-client"
    ],
    "owner": {
      "account_id": 419537,
      "reputation": 5165,
      "user_id": 796761,
      "user_type": "registered",
      "accept_rate": 50,
      "profile_image": "https://www.gravatar.com/avatar/5753a5c71aa5ab839635f6852c04c3ae?s=256&d=identicon&r=PG",
      "display_name": "Doug Breaux",
      "link": "https://stackoverflow.com/users/796761/doug-breaux"
    },
    "is_answered": true,
    "view_count": 689,
    "accepted_answer_id": 78979197,
    "answer_count": 3,
    "score": 2,
    "last_activity_date": 1726161536,
    "creation_date": 1720814110,
    "last_edit_date": 1721221099,
    "question_id": 78742044,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78742044/mutual-tls-connection-from-openliberty-with-custom-keystore",
    "title": "Mutual TLS connection from OpenLiberty with custom keystore",
    "body": "<p>I'm trying to use configured host-specific outbound SSL configuration in OpenLiberty to make an https connection to a remote system (Apple Pay, in this case, but I don't think relevant).</p>\n<p>I know the keystore and password and protocols are correct, because when I do it entirely programmatically, like shown in <a href=\"https://stackoverflow.com/a/63080443/796761\">https://stackoverflow.com/a/63080443/796761</a>, the connection and request fully work.</p>\n<p>However, when I remove all the keystore/SSL setup and try to fall back on what I've configured in <code>server.xml</code>, I get the same error as I get when I'm not setting up SSL at all. (Which, in this case is <a href=\"https://stackoverflow.com/a/64354042/796761\"><code>java.io.IOException: HTTP/1.1 header parser received no bytes</code></a>.)</p>\n<p>Relevant <code>server.xml</code> elements:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>    &lt;featureManager&gt;\n        &lt;feature&gt;webProfile-8.0&lt;/feature&gt; &lt;!-- adds ssl-1.0 --&gt;\n...\n    &lt;/featureManager&gt;\n\n...\n    &lt;keyStore id=&quot;applePayKeyStore&quot; location=&quot;c:/keys/MerchID.AZMVDNOW.p12&quot; password=&quot;redacted&quot;/&gt;\n\n    &lt;ssl id=&quot;applePaySSL&quot; keyStoreRef=&quot;applePayKeyStore&quot; clientAuthentication=&quot;true&quot; sslProtocol=&quot;TLSv1.2&quot;&gt;\n        &lt;outboundConnection host=&quot;apple-pay-gateway-cert.apple.com&quot;/&gt;\n    &lt;/ssl&gt;\n</code></pre>\n<p>Java code:</p>\n<pre class=\"lang-java prettyprint-override\"><code>        HttpRequest request = HttpRequest.newBuilder().uri(validationEndpoint)\n            .header(&quot;Content-Type&quot;, &quot;application/json&quot;)\n            .POST(BodyPublishers.ofString(jsonRequest))\n            .build();\n        HttpClient client = HttpClient.newBuilder().build();\n\n        return client.send(request, BodyHandlers.ofString()).body();\n</code></pre>\n<p>Where <code>validationEndpoint</code> is set to <code>https://apple-pay-gateway-cert.apple.com/paymentservices/paymentSession</code></p>\n<p>Again, if I instead replace the above <code>client</code> with the following, the request succeeds:</p>\n<pre class=\"lang-java prettyprint-override\"><code>        char[] passwordChars = keystorePassword.toCharArray();\n\n        KeyStore keyStore = KeyStore.getInstance(&quot;PKCS12&quot;);\n        keyStore.load(new FileInputStream(&quot;/keys/MerchID.AZMVDNOW.p12&quot;), passwordChars);\n\n        KeyManagerFactory keyMgrFactory = KeyManagerFactory.getInstance(&quot;SunX509&quot;);\n        keyMgrFactory.init(keyStore, passwordChars);\n\n        SSLContext sslContext = SSLContext.getInstance(&quot;TLSv1.2&quot;);\n        sslContext.init(keyMgrFactory.getKeyManagers(), null, null);\n\n        SSLParameters sslParam = new SSLParameters();\n        sslParam.setNeedClientAuth(true);\n\n        HttpClient client = HttpClient.newBuilder()\n            .sslContext(sslContext)\n            .sslParameters(sslParam).build();\n</code></pre>\n<p>OpenLiberty 24.0.0.6, JDK 17</p>\n<p>So, the question is how can I get Liberty to use this specific keystore when making an https connection to the specified server?</p>\n<p>I haven't so far found an example of making such a connection with Liberty automatically using the configured SSL configuration, so I hope I'm just missing some simple glue.</p>\n<h2>Edit:</h2>\n<p><code>javax.net.debug=ssl</code> doesn't tell me anything helpful:</p>\n<pre><code>[err] javax.net.ssl|DEBUG|69|HttpClient-1-Worker-0|2024-07-12 20:30:31.041 UTC|SSLCipher.java:1870|KeyLimit read side: algorithm = AES/GCM/NOPADDING:KEYUPDATE\ncountdown value = 137438953472\n[err] javax.net.ssl|DEBUG|69|HttpClient-1-Worker-0|2024-07-12 20:30:31.041 UTC|SSLCipher.java:2024|KeyLimit write side: algorithm = AES/GCM/NOPADDING:KEYUPDATE\ncountdown value = 137438953472\n[err] javax.net.ssl|DEBUG|69|HttpClient-1-Worker-0|2024-07-12 20:30:31.051 UTC|SSLCipher.java:1870|KeyLimit read side: algorithm = AES/GCM/NOPADDING:KEYUPDATE\ncountdown value = 137438953472\n[err] javax.net.ssl|ALL|69|HttpClient-1-Worker-0|2024-07-12 20:30:31.053 UTC|X509Authentication.java:223|No X.509 cert selected for [RSA, EC]\n\n[err] javax.net.ssl|DEBUG|69|HttpClient-1-Worker-0|2024-07-12 20:30:31.053 UTC|SSLCipher.java:2024|KeyLimit write side: algorithm = AES/GCM/NOPADDING:KEYUPDATE\ncountdown value = 137438953472\n[err] javax.net.ssl|DEBUG|91|Finalizer thread|2024-07-12 20:30:31.127 UTC|SSLSocketImpl.java:577|duplex close of SSLSocket\n\n[err] javax.net.ssl|DEBUG|91|Finalizer thread|2024-07-12 20:30:31.129 UTC|SSLSocketImpl.java:1785|close the SSL connection (passive)\n</code></pre>\n<h2>Edit 2:</h2>\n<p>With <a href=\"https://www.ibm.com/support/pages/mustgather-ssl-problems-websphere-liberty\" rel=\"nofollow noreferrer\">Liberty SSL tracing</a>, it looks like the relevant objects loaded up successfully, including this entry showing that Liberty was able to see the certificate in the store:</p>\n<blockquote>\n<p>[7/12/24, 20:49:04:920 UTC] 00000031 id=00000000 com.ibm.ws.ssl.config.WSKeyStore                             3 alias: apple pay merchant identity certificate</p>\n</blockquote>\n<p>And mapped the host name to the configuration:</p>\n<blockquote>\n<p>[7/12/24, 20:49:05:241 UTC] 00000031 id=00000000\ncom.ibm.ws.channel.ssl.internal.SSLChannelProvider           3\nsetSslConfig\nid=applePaySSL\n{com.ibm.ws.ssl.internal.RepertoireConfigService,\ncom.ibm.wsspi.ssl.SSLConfiguration}={verifyHostname=false,\nservice.scope=bundle,\ncomponent.name=com.ibm.ws.ssl.internal.RepertoireConfigService,\nTrustStore.target=(service.pid=com.ibm.ws.ssl.keystore_0),\ntrustDefaultCerts=false,\nKeyStore.target=(service.pid=com.ibm.ws.ssl.keystore_0),\nsslProtocol=TLSv1.2, config.source=file,\n<strong>outboundConnection.0.host=apple-pay-gateway-cert.apple.com</strong>,\nid=applePaySSL, service.pid=com.ibm.ws.ssl.repertoire_0,\nclientAuthenticationSupported=false, service.id=621,\nkeyStoreRef=com.ibm.ws.ssl.keystore_0, enforceCipherOrder=false,\nservice.bundleid=132,\noutboundConnection.0.config.referenceType=com.ibm.ws.ssl.repertoire.config.outboundConnection,\nosgi.ds.satisfying.condition.target=(osgi.condition.id=true),\nconfig.overrides=true, clientAuthentication=true, component.id=487,\neffectiveTrustStore=com.ibm.ws.ssl.keystore_0,\nconfig.id=com.ibm.ws.ssl.repertoire[applePaySSL], securityLevel=HIGH,\nservice.factoryPid=com.ibm.ws.ssl.repertoire, service.vendor=IBM,\nconfig.displayId=ssl[applePaySSL]}</p>\n</blockquote>\n<p>But I think the outbound connection used the <code>defaultSSLConfig</code> instead of the <code>applePaySSL</code> one:</p>\n<blockquote>\n<p>[7/12/24, 20:50:43:868 UTC] 00000046 id=00000000 com.ibm.ws.ssl.SSLPropertyUtils                              &gt; lookupProperties alias=defaultSSLConfig Entry\n[7/12/24, 20:50:43:868 UTC] 00000046 id=00000000 com.ibm.ws.ssl.SSLPropertyUtils                              &gt; getProperties sslAliasName=defaultSSLConfig\ncurrentConnectionInfo={com.ibm.ssl.direction=outbound}</p>\n</blockquote>\n<p>I can't paste the entire huge trace here, but can provide specifics if needed.</p>\n<h2>Edit 3</h2>\n<p>On <code>OutboundSSLSelections</code>:</p>\n<pre><code>[7/15/24, 20:29:11:882 UTC] 00000031 id=00000000 com.ibm.ws.ssl.config.OutboundSSLSelections                  3 loadOutboundConnectionInfo \n                                                                                                               Adding apple-pay-gateway-cert.apple.com,* to the host list\n</code></pre>\n<p>From a later test just now, I do see these when looking up other host names:</p>\n<pre><code>[7/17/24, 12:40:30:595 UTC] 0000003b id=00000000 com.ibm.ws.ssl.config.OutboundSSLSelections                  3 SSLConfig dynamic selection info: apple-pay-gateway-cert.apple.com,*\n[7/17/24, 12:40:30:595 UTC] 0000003b id=00000000 com.ibm.ws.ssl.config.OutboundSSLSelections                  3 This entry has 2 attributes.\n[7/17/24, 12:40:30:595 UTC] 0000003b id=00000000 com.ibm.ws.ssl.config.OutboundSSLSelections                  3 Host: apple-pay-gateway-cert.apple.com, Port: *\n[7/17/24, 12:40:30:595 UTC] 0000003b id=00000000 com.ibm.ws.ssl.config.OutboundSSLSelections                  3 Host does not match.\n[7/17/24, 12:40:30:595 UTC] 0000003b id=00000000 com.ibm.ws.ssl.config.OutboundSSLSelections                  3 No match found list\n[7/17/24, 12:40:30:595 UTC] 0000003b id=00000000 com.ibm.ws.ssl.config.OutboundSSLSelections                  &lt; lookForMatchInList Exit \n[7/17/24, 12:40:30:595 UTC] 0000003b id=00000000 com.ibm.ws.ssl.config.OutboundSSLSelections                  3 Cache miss tree set size is 2 entries.\n[7/17/24, 12:40:30:595 UTC] 0000003b id=00000000 com.ibm.ws.ssl.config.OutboundSSLSelections                  3 No match found in host or host and port list.\n[7/17/24, 12:40:30:595 UTC] 0000003b id=00000000 com.ibm.ws.ssl.config.OutboundSSLSelections                  &lt; getPropertiesFromDynamicSelectionInfo Exit \n</code></pre>\n<p>But no entries at all for <code>com.ibm.ssl.remoteHost</code> with the apple host.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}