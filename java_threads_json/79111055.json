{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-boot",
      "authentication",
      "spring-security"
    ],
    "owner": {
      "account_id": 277559,
      "reputation": 401,
      "user_id": 571632,
      "user_type": "registered",
      "accept_rate": 89,
      "profile_image": "https://i.sstatic.net/sCn6C.png?s=256",
      "display_name": "aohm1989",
      "link": "https://stackoverflow.com/users/571632/aohm1989"
    },
    "is_answered": true,
    "view_count": 367,
    "accepted_answer_id": 79119801,
    "answer_count": 1,
    "score": 2,
    "last_activity_date": 1729719724,
    "creation_date": 1729529997,
    "question_id": 79111055,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79111055/spring-3-6-migration-security-config-with-custom-filter-token-provider-issues",
    "title": "Spring 3/6 Migration Security Config with Custom Filter/Token/Provider - Issues Persisting Principal after successful Provider authenticate()",
    "body": "<p>I've had some issues after a Spring 5 -&gt; 6 (Spring Boot 3.3.4) migration. I can sign in to my site, but calls requesting the Provider afterwards do not work (the user returns null in say the following code below from our AuthenticationController):</p>\n<pre><code>@RequestMapping(value = &quot;/user&quot;, method = RequestMethod.GET)\npublic UserResponse user(Principal user) {\n    UserResponse response = new UserResponse();\n    response.setCode(CODE_SUCCESS);\n    response.setStatus(SUCCESS_STATUS);\n    response.setData(user);\n    return response;\n}\n</code></pre>\n<p>I suspect the culprit is the SecurityConfig which has seen multiple changes with Spring 5 to Spring 6, most importantly, I think the code around <code>.addFilterBefore(authenticationFilter(authenticationManager(http)), UsernamePasswordAuthenticationFilter.class)</code> and authenticationFilter and authenticationManager beans are most important here and seen the most changes since Spring 5 configure overrides:</p>\n<pre><code>@Configuration\n@EnableWebSecurity(debug = true)\npublic class XYZLibrarySecurityConfig {\n\n    private final XYZLibraryAuthenticationProvider authProvider;\n    private final XYZLibraryConfig properties;\n\n    public XYZLibrarySecurityConfig(@Lazy XYZLibraryAuthenticationProvider authProvider, XYZLibraryConfig properties) {\n        this.authProvider = authProvider;\n        this.properties = properties;\n    }\n    \n    @Bean\n    public XYZLibraryAuthenticationFilter authenticationFilter(AuthenticationManager authenticationManager) {\n        XYZLibraryAuthenticationFilter filter = new XYZLibraryAuthenticationFilter();\n        filter.setAuthenticationManager(authenticationManager);\n        filter.setAuthenticationSuccessHandler(authenticationSuccessHandler());\n        filter.setAuthenticationFailureHandler(authenticationFailureHandler());\n        filter.setSessionAuthenticationStrategy(authStrategy());\n\n        return filter;\n    }\n    \n    @Bean\n    public AuthenticationManager authenticationManager(HttpSecurity http) throws Exception {\n        AuthenticationManagerBuilder authenticationManagerBuilder = http.getSharedObject(AuthenticationManagerBuilder.class);\n        authenticationManagerBuilder.authenticationProvider(authProvider);\n        return authenticationManagerBuilder.build();\n    }\n\n    @Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n        http\n            .authenticationProvider(authProvider)\n            .addFilterBefore(authenticationFilter(authenticationManager(http)), UsernamePasswordAuthenticationFilter.class)\n            .cors(cors -&gt; cors.configurationSource(corsConfigurationSource()))\n            .exceptionHandling(exceptionHandling -&gt; exceptionHandling.authenticationEntryPoint(authenticationEntryPoint()))\n            .authorizeHttpRequests(authorize -&gt; authorize\n                .requestMatchers(&quot;/rest/authentication/authenticate&quot;).permitAll()\n                .requestMatchers(&quot;/rest/authentication/user&quot;).permitAll()\n                .requestMatchers(&quot;/rest/authentication/forgotPassword&quot;).permitAll()\n                .requestMatchers(&quot;/rest/authentication/changePassword&quot;).permitAll()\n                .requestMatchers(&quot;/rest/authentication/passwordRules&quot;).permitAll()\n                .requestMatchers(&quot;/rest/authentication/helpContact&quot;).permitAll()\n                .requestMatchers(&quot;/rest/authentication/user-message&quot;).denyAll()\n                .requestMatchers(&quot;/rest/system-check/check&quot;).permitAll()\n                .requestMatchers(&quot;/rest/admin/**&quot;).hasAnyRole(&quot;Administrator&quot;, &quot;XYZ Complete Editor&quot;)\n                .requestMatchers(&quot;/rest/**&quot;).hasAnyRole(&quot;User&quot;, &quot;Administrator&quot;, &quot;XYZ Limited User&quot;, &quot;XYZ Limited Submitter&quot;, &quot;XYZ Complete User&quot;, &quot;XYZ Complete Editor&quot;)\n                .anyRequest().authenticated()\n            )\n            .formLogin(formLogin -&gt; formLogin.permitAll())\n            .logout(logout -&gt; logout\n                .deleteCookies(&quot;JSESSIONID&quot;)\n                .invalidateHttpSession(true)\n                .logoutSuccessHandler(new HttpStatusReturningLogoutSuccessHandler(HttpStatus.OK))\n            )\n            .headers(headers -&gt; headers\n                .contentSecurityPolicy(csp -&gt; csp\n                    .policyDirectives(&quot;default-src 'none'; script-src 'self'; connect-src 'self'; img-src 'self'; style-src 'self'; frame-ancestors 'self'; form-action 'self';&quot;)\n                )\n                .httpStrictTransportSecurity(hsts -&gt; hsts\n                    .includeSubDomains(true)\n                    .maxAgeInSeconds(31536000)\n                )\n            )\n            .sessionManagement(sessionManagement -&gt; sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))\n            .csrf(csrf -&gt; {\n                if (properties.getCsrf().getEnabled().booleanValue()) {\n                    if (properties.getCsrf().getUseCookie().booleanValue()) {\n                        CookieCsrfTokenRepository trep = (CookieCsrfTokenRepository) XYZLibraryCookieRepository.withHttpOnlyFalse();\n                        trep.setCookiePath(&quot;/&quot;);\n                        csrf.csrfTokenRepository(trep);\n                    }\n                } else {\n                    csrf.disable();\n                }\n            });\n\n        http.addFilterBefore(expiredSessionFilter(), SessionManagementFilter.class);\n        //http.addFilterBefore(authenticationFilter(authenticationManager(http)), UsernamePasswordAuthenticationFilter.class);\n        http.addFilterAfter(new RequestAuditingFilter(), BasicAuthenticationFilter.class);\n\n        return http.build();\n    }\n\n</code></pre>\n<p>In short, a /login request which authenticates the user appears to authenticate fine (returns 200 and a valid response, has user details, and the returning <code>new UsernamePasswordAuthenticationToken(p, password, authorities)</code> from the custom provider seems fine. However, /user (the first code block above) and other API calls that rely on the user principal coming back have null user parameters and thus don't work despite supposedly having successful authentication. I have heard of needing a supports override there, which we also have and looks like:</p>\n<pre><code>    @Override\n    public boolean supports(Class&lt;?&gt; authentication) {\n        return authentication.equals(XYZLibraryAuthenticationToken.class);\n    }\n</code></pre>\n<p>I can provide other code snippets of say the custom filter/token/providers but this post is already somewhat lengthy - while we do custom filter/token/providers there's nothing too out of the ordinary here I think and it used to work fine before migrating to Spring 3/6 so I think it's something to do with how our security config is set up now due to how many changes it needed (we also did some linter suggestions while we were in here like swapping to lambdas, etc..). I've tried moving orders around in the security chain and countless other trial and error tweaks but nothing seems to work, so I'm asking here to see if anyone has any ideas.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}