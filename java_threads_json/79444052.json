{
  "question": {
    "tags": [
      "python",
      "java",
      "tensorflow"
    ],
    "owner": {
      "account_id": 7636490,
      "reputation": 9,
      "user_id": 5789906,
      "user_type": "registered",
      "profile_image": "https://graph.facebook.com/925819970834724/picture?type=large",
      "display_name": "Tatiana Filgueiras",
      "link": "https://stackoverflow.com/users/5789906/tatiana-filgueiras"
    },
    "is_answered": false,
    "view_count": 88,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1766038128,
    "creation_date": 1739744948,
    "question_id": 79444052,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79444052/python-tensorflow-model-does-not-work-in-java-tensorflow",
    "title": "Python TensorFlow model does not work in Java TensorFlow",
    "body": "<p>I am training a model in Python using TensorFlow and Keras, and attempting to load it in a Java application. However, I am encountering an error when trying to perform inference.</p>\n<p><strong>Java Code</strong></p>\n<pre><code>public static void main(String[] args) {\n        final String MODEL_PATH = &quot;/home/himitsu/Desktop/PhD/SMA/SMACarev1/src/main/resources/ecg_model_to_java&quot;;\n\n        try (SavedModelBundle model = SavedModelBundle.load(MODEL_PATH, &quot;serve&quot;)) {\n            System.out.println(&quot;Modelo carregado com sucesso!&quot;);\n\n            // üîπ Criar uma sess√£o para executar a inicializa√ß√£o das vari√°veis\n            Session session = model.session();\n\n            // 1. Gerar dados de teste\n            float[][][] ecgSample = generateECGTestSample();\n\n            // 2. Criar tensor de entrada corretamente\n            try (TFloat32 inputTensor = TFloat32.tensorOf(\n                    Shape.of(1, 100, 1),\n                    data -&gt; {\n                        for (int i = 0; i &lt; 100; i++) {\n                            data.setFloat(ecgSample[0][i][0], 0, i, 0);\n                        }\n                    }\n            )) {\n                // 3. Executar infer√™ncia diretamente sem lista\n                try (Tensor outputTensor = model.function(&quot;serving_default&quot;).call(inputTensor)) {\n                    if (outputTensor instanceof TFloat32) {\n                        processOutput((TFloat32) outputTensor);\n                    } else {\n                        System.err.println(&quot;Erro: O modelo n√£o retornou um TFloat32.&quot;);\n                    }\n                }\n            }\n        } catch (Exception e) {\n            System.err.println(&quot;Erro durante a infer√™ncia:&quot;);\n            e.printStackTrace();\n        }\n    }\n\n    private static float[][][] generateECGTestSample() {\n        float[][][] sample = new float[1][100][1];\n        for (int i = 0; i &lt; 100; i++) {\n            sample[0][i][0] = (float) (0.5 * Math.sin(2 * Math.PI * i / 20));\n        }\n        return sample;\n    }\n\n    private static void processOutput(TFloat32 tensor) {\n        // Corrigido para a nova API: acessar os dados corretamente\n        FloatDataBuffer buffer = tensor.asRawTensor().data().asFloats();\n        float[] predictions = new float[(int) tensor.shape().size(1)];\n        buffer.read(predictions);\n\n        System.out.println(&quot;\\nResultado da Predi√ß√£o:&quot;);\n        for (int i = 0; i &lt; predictions.length; i++) {\n            System.out.printf(&quot;Classe %d: %.2f%%%n&quot;, i, predictions[i] * 100);\n        }\n\n        // Encontrar a classe com maior probabilidade\n        int predictedClass = 0;\n        float maxProb = 0;\n        for (int i = 0; i &lt; predictions.length; i++) {\n            if (predictions[i] &gt; maxProb) {\n                maxProb = predictions[i];\n                predictedClass = i;\n            }\n        }\n        System.out.printf(&quot;\\nDiagn√≥stico Previsto: Classe %d (%.2f%% de confian√ßa)%n&quot;,\n                predictedClass, maxProb * 100);\n    }\n</code></pre>\n<p><strong>Python Code</strong></p>\n<pre><code>\n\n\ndf = pd.read_csv('/home/himitsu/Desktop/PhD/SMA/Databases/arrhythmia_dataset_with_ecg.csv')\n\n# Extrair features (ECG bruto: 100 amostras por batimento)\necg_columns = [f'ecg_{i}' for i in range(100)]\nX = df[ecg_columns].values  # Shape: (n_amostras, 100)\n\n# Extrair r√≥tulos e codificar para n√∫meros\nlabel_encoder = LabelEncoder()\ny = label_encoder.fit_transform(df['label'].values)  # y: inteiros (0, 1, 2, ...)\n\n# Dividir em treino e teste (estratificado)\nX_train, X_test, y_train, y_test = train_test_split(\n    X, y,\n    test_size=0.2,\n    stratify=y,\n    random_state=42\n)\n\n# Redimensionar para formato de entrada da CNN + LSTM (n_amostras, 100, 1)\nX_train = X_train.reshape(-1, 100, 1)\nX_test = X_test.reshape(-1, 100, 1)\n\n# ======================================\n# 2. Construir o Modelo (CNN + LSTM)\n# ======================================\n\nmodel = Sequential([\n    # Camadas Convolucionais\n    Conv1D(32, kernel_size=3, activation='relu', input_shape=(100, 1)),\n    MaxPooling1D(2),\n    Conv1D(64, kernel_size=3, activation='relu'),\n    MaxPooling1D(2),\n\n    # Camada LSTM\n    LSTM(50, return_sequences=False),\n\n    # Camadas Densas\n    Dense(128, activation='relu'),\n    Dropout(0.5),\n    Dense(len(label_encoder.classes_), activation='softmax')\n])\n\n# Compilar o modelo\nmodel.compile(\n    optimizer='adam',\n    loss='sparse_categorical_crossentropy',\n    metrics=['accuracy']\n)\n\nmodel.summary()\n\n# ======================================\n# 3. Treinar o Modelo\n# ======================================\n\n# Callbacks para evitar overfitting\ncallbacks = [\n    EarlyStopping(patience=5, restore_best_weights=True),\n    ModelCheckpoint('best_model_cnn_lstm.keras', save_best_only=True)\n]\n\n# Treinamento\nhistory = model.fit(\n    X_train, y_train,\n    epochs=50,\n    batch_size=32,\n    validation_split=0.2,\n    callbacks=callbacks\n)\n\n# ======================================\n# 4. Avaliar o Modelo\n# ======================================\n\ntest_loss, test_accuracy = model.evaluate(X_test, y_test)\nprint(f'\\nAcur√°cia no teste: {test_accuracy * 100:.2f}%')\n\n# Plotar curvas de aprendizado\nplt.figure(figsize=(12, 4))\nplt.subplot(1, 2, 1)\nplt.plot(history.history['accuracy'], label='Treino')\nplt.plot(history.history['val_accuracy'], label='Valida√ß√£o')\nplt.title('Acur√°cia por √âpoca')\nplt.legend()\n\nplt.subplot(1, 2, 2)\nplt.plot(history.history['loss'], label='Treino')\nplt.plot(history.history['val_loss'], label='Valida√ß√£o')\nplt.title('Loss por √âpoca')\nplt.legend()\nplt.show()\n\n# ======================================\n# 5. Fazer Previs√µes\n# ======================================\n\nsample_idx = 0  # Escolha uma amostra\ntest_sample = X_test[sample_idx].reshape(1, 100, 1)\ntrue_label = y_test[sample_idx]\npredicted_prob = model.predict(test_sample)\npredicted_label = np.argmax(predicted_prob)\n\nprint(f'\\nExemplo Real: {label_encoder.inverse_transform([true_label])[0]}')\nprint(f'Previs√£o: {label_encoder.inverse_transform([predicted_label])[0]}')\nprint(f'Probabilidades: {predicted_prob}')\n\n# ======================================\n# 6. Salvar o Modelo para TensorFlow Java\n# ======================================\n\n# Certifique-se de que o modelo foi treinado antes de exportar\nexport_dir = &quot;ecg_model_to_javav2&quot;\n\n# Salvar o modelo corretamente sem definir manualmente a assinatura\ntf.saved_model.save(model, export_dir)\n</code></pre>\n<p><strong>Error Message</strong></p>\n<pre><code>2025-02-15 22:47:37.247065: I tensorflow/cc/saved_model/reader.cc:83] Reading SavedModel from: /home/himitsu/Desktop/PhD/SMA/SMACarev1/src/main/resources/ecg_model_to_javav2\n2025-02-15 22:47:37.250045: I tensorflow/cc/saved_model/reader.cc:51] Reading meta graph with tags { serve }\n2025-02-15 22:47:37.250082: I tensorflow/cc/saved_model/reader.cc:146] Reading SavedModel debug info (if present) from: /home/himitsu/Desktop/PhD/SMA/SMACarev1/src/main/resources/ecg_model_to_javav2\n2025-02-15 22:47:37.250161: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.\nTo enable the following instructions: AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.\n2025-02-15 22:47:37.309389: I tensorflow/compiler/mlir/mlir_graph_optimization_pass.cc:388] MLIR V1 optimization pass is not enabled\n2025-02-15 22:47:37.315025: I tensorflow/cc/saved_model/loader.cc:234] Restoring SavedModel bundle.\n2025-02-15 22:47:37.459839: I tensorflow/cc/saved_model/loader.cc:218] Running initialization op on SavedModel bundle at path: /home/himitsu/Desktop/PhD/SMA/SMACarev1/src/main/resources/ecg_model_to_javav2\n2025-02-15 22:47:37.505041: I tensorflow/cc/saved_model/loader.cc:317] SavedModel load for tags { serve }; Status: success: OK. Took 257993 microseconds.\nModelo carregado com sucesso!\n2025-02-15 22:47:37.915743: W tensorflow/core/framework/local_rendezvous.cc:404] Local rendezvous is aborting with status: FAILED_PRECONDITION: Could not find variable sequential/dense_1/kernel. This could mean that the variable has been deleted. In TF1, it can also mean the variable is uninitialized. Debug info: container=localhost, status error message=Resource localhost/sequential/dense_1/kernel/N10tensorflow3VarE does not exist.\n     [[{{function_node __inference_serving_default_338688}}{{node sequential_1/dense_1_2/Cast/ReadVariableOp}}]]\nErro durante a infer√™ncia:\norg.tensorflow.exceptions.TFFailedPreconditionException: Could not find variable sequential/dense_1/kernel. This could mean that the variable has been deleted. In TF1, it can also mean the variable is uninitialized. Debug info: container=localhost, status error message=Resource localhost/sequential/dense_1/kernel/N10tensorflow3VarE does not exist.\n     [[{{function_node __inference_serving_default_338688}}{{node sequential_1/dense_1_2/Cast/ReadVariableOp}}]]\n    at org.tensorflow.internal.c_api.AbstractTF_Status.throwExceptionIfNotOK(AbstractTF_Status.java:84)\n    at org.tensorflow.Session.run(Session.java:826)\n    at org.tensorflow.Session$Runner.runHelper(Session.java:549)\n    at org.tensorflow.Session$Runner.run(Session.java:476)\n    at org.tensorflow.SessionFunction.call(SessionFunction.java:115)\n    at org.tensorflow.TensorFunction.call(TensorFunction.java:83)\n    at org.example.EcgModelTester.main(EcgModelTester.java:34)\n</code></pre>\n<p><strong>Additional Information</strong></p>\n<pre><code>saved_model_cli show --dir './ecg_model_to_java/' --tag_set serve --signature_def serving_default \n\n2025-02-15 22:08:37.125957: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library 'libcudart.so.11.0'; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory\n2025-02-15 22:08:37.125985: I tensorflow/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.\nThe given SavedModel SignatureDef contains the following input(s):\n  inputs['inputs'] tensor_info:\n      dtype: DT_FLOAT\n      shape: (-1, 100, 1)\n      name: serving_default_inputs:0\nThe given SavedModel SignatureDef contains the following output(s):\n  outputs['output_0'] tensor_info:\n      dtype: DT_FLOAT\n      shape: (-1, 15)\n      name: StatefulPartitionedCall:0\nMethod name is: tensorflow/serving/predict\n</code></pre>\n<p><strong>Question</strong>\nHow can I resolve the error Could not find variable sequential/dense_1/bias when loading the TensorFlow model in Java?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}