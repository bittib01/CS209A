{
  "question": {
    "tags": [
      "java",
      "macos",
      "drag-and-drop"
    ],
    "owner": {
      "account_id": 111681,
      "reputation": 13382,
      "user_id": 1480018,
      "user_type": "registered",
      "accept_rate": 87,
      "profile_image": "https://www.gravatar.com/avatar/adc85b2c054f3eb102da8eb68545dca4?s=256&d=identicon&r=PG",
      "display_name": "Paul Taylor",
      "link": "https://stackoverflow.com/users/1480018/paul-taylor"
    },
    "is_answered": false,
    "view_count": 188,
    "answer_count": 0,
    "score": 0,
    "last_activity_date": 1753216421,
    "creation_date": 1737562281,
    "last_edit_date": 1753216421,
    "question_id": 79378471,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79378471/dropping-of-image-url-from-webbrowser-on-java-app-not-working-for-macos",
    "title": "Dropping of image URL from webbrowser on Java app not working for macOS",
    "body": "<p>My Java (Java 21) application has a part of GUI that lets you drag an image found on Google in web-browser to the application, the data flavor of the URL is logged, and if thee is no valid data flavor a message is also logged.</p>\n<p>On Windows it works fine (tested with Firefox)</p>\n<p>On MacOS it doesn't work (tested with Firefox and Safari) and nothing is even logged. Based on suggestion VGR I now log if there is an exception and also I log when first enter the drop method.</p>\n<p>Retested on MacOS and it doesn't even log the <em>Started Drop</em> method <strong>so it seems that MacOS is preventing the drag drop before it even gets to my code</strong>.</p>\n<p>Whereas On MacOS it does work if you drop an image from Finder instead</p>\n<p>What is causing the difference?</p>\n<p>This is the class doing the work, key method is <code>drop()</code>:</p>\n<pre><code>    package com.jthink.songkong.ui.startdialog.editsongs;\n    \n    import com.jthink.songkong.analyse.general.ArtworkHelper;\n    import com.jthink.songkong.analyse.musicbrainz.RemoteArtworkLookup;\n    import com.jthink.songkong.db.ImageCache;\n    import com.jthink.songkong.db.SongCache;\n    import com.jthink.songkong.preferences.UserOption;\n    import com.jthink.songkong.preferences.UserPreferences;\n    import com.jthink.songkong.ui.MainWindow;\n    import com.jthink.songkong.ui.startdialog.imagefilters.ImageFileFilter;\n    import com.jthink.songkong.ui.startdialog.imagefilters.ImageFilterFactory;\n    import com.jthink.songlayer.CoverImage;\n    \n    import javax.imageio.IIOImage;\n    import javax.imageio.ImageIO;\n    import javax.imageio.ImageWriteParam;\n    import javax.imageio.ImageWriter;\n    import javax.imageio.stream.MemoryCacheImageOutputStream;\n    import javax.swing.*;\n    import java.awt.*;\n    import java.awt.datatransfer.DataFlavor;\n    import java.awt.datatransfer.Transferable;\n    import java.awt.dnd.DnDConstants;\n    import java.awt.dnd.DropTarget;\n    import java.awt.dnd.DropTargetDropEvent;\n    import java.awt.image.BufferedImage;\n    import java.io.ByteArrayOutputStream;\n    import java.io.File;\n    import java.io.IOException;\n    import java.net.URI;\n    import java.net.URL;\n    import java.nio.file.Files;\n    import java.util.logging.Level;\n    \n    import static com.jthink.songkong.ui.startdialog.editsongs.ArtworkTab.ARTWORK_SIZE;\n    import static com.jthink.songkong.ui.startdialog.editsongs.ImageSizeDefaults.MAX_IMAGE_SIZE;\n    import static com.jthink.songkong.ui.startdialog.editsongs.ImageSizeDefaults.MIN_IMAGE_SIZE;\n    \n    public class ArtworkDropTarget extends DropTarget\n    {\n        private static CoverImage   coverImage;\n        private JLabel              displayArtwork;\n    \n        public static DataFlavor uriListFlavor;         //This is used by Linux for loading files\n        public static DataFlavor imageFlavor;           //This is used by Firefox, when drag single image file\n        public static DataFlavor urlFlavour;            //This is used by Firefox, when drag single image file\n        public static DataFlavor pictImageFlavor;       //This is used by OSX for iTunes\n        public static DataFlavor imageIconDataFlavor;   //When dragging from existingArtwork\n        static\n        {\n            try\n            {\n                uriListFlavor   = new DataFlavor(&quot;text/uri-list;class=java.lang.String&quot;);\n                urlFlavour = new DataFlavor(&quot;application/x-java-url;class=java.net.URL&quot;);\n                imageFlavor = new DataFlavor(&quot;image/x-java-image;class=java.awt.Image&quot;);\n                pictImageFlavor = new DataFlavor(&quot;image/x-pict;class=java.io.InputStream&quot;);\n                imageIconDataFlavor = new DataFlavor(DataFlavor.javaJVMLocalObjectMimeType +\n                        &quot;;class=\\&quot;&quot;+javax.swing.Icon.class.getName() + &quot;\\&quot;&quot;);\n            }\n            catch (ClassNotFoundException cne)\n            {\n                throw new RuntimeException(&quot;unable to create uri-list flavor in drop target:&quot; + cne.getMessage());\n            }\n        }\n    \n        public ArtworkDropTarget(Component c, JLabel displayArtwork)\n                throws HeadlessException\n        {\n            super(c, DnDConstants.ACTION_COPY, null, true, null);\n            this.displayArtwork= displayArtwork;\n        }\n    \n        public static void setCoverImage(CoverImage coverImage)\n        {\n            ArtworkDropTarget.coverImage = coverImage;\n        }\n    \n        /**\n         * When used as Drop target\n         *\n         * @param dtde\n         */\n        public synchronized void drop(DropTargetDropEvent dtde)\n        {\n            MainWindow.logger.severe(&quot;Starting Drop&quot;);\n            dtde.acceptDrop(DnDConstants.ACTION_COPY);\n            Transferable trans = dtde.getTransferable();\n            try\n            {\n                if (trans.isDataFlavorSupported(imageIconDataFlavor))\n                {\n                    MainWindow.logger.severe(&quot;Received ImageIcon:&quot;+trans.getTransferData(imageIconDataFlavor));\n                    ImageIconWithOriginalImage icon = (ImageIconWithOriginalImage)trans.getTransferData(imageIconDataFlavor);\n                    setExistingArtwork((BufferedImage)icon.getOriginalImage());\n                }\n                else if (trans.isDataFlavorSupported(DataFlavor.javaFileListFlavor) &amp;&amp; ImageFilterFactory.getImageFilter().accept(((java.util.List&lt;File&gt;) trans.getTransferData(DataFlavor.javaFileListFlavor)).get(0)))\n                {\n                    MainWindow.logger.severe(&quot;Received Files:&quot;+trans.getTransferData(DataFlavor.javaFileListFlavor));\n                    File file = ((java.util.List&lt;File&gt;) trans.getTransferData(DataFlavor.javaFileListFlavor)).get(0);\n                    setExistingArtwork(file);\n                }\n                else if (trans.isDataFlavorSupported(imageFlavor) &amp;&amp; trans.getTransferData(ArtworkDropTarget.imageFlavor) instanceof BufferedImage)\n                {\n                    MainWindow.logger.severe(&quot;Received Image:&quot;+trans.getTransferData(ArtworkDropTarget.imageFlavor));\n                    setExistingArtwork((BufferedImage)trans.getTransferData(ArtworkDropTarget.imageFlavor));\n                }\n                else if (trans.isDataFlavorSupported(urlFlavour))\n                {\n                    URI imageUri = ((URL) trans.getTransferData(ArtworkDropTarget.urlFlavour)).toURI();\n    \n                    MainWindow.logger.severe(&quot;Received ImageUrl:&quot; + imageUri);\n                    URI subUri = GoogleImageSearch.getImageUrlFromImageSearchUrl(imageUri);\n                    if (GoogleImageSearch.isGoogleImageSearch(imageUri) &amp;&amp; subUri!=null)\n                    {\n                        MainWindow.logger.severe(&quot;Received ImageSubUrl:&quot; + subUri);\n                        setExistingArtwork(subUri);\n                    }\n                    else\n                    {\n                        MainWindow.logger.severe(&quot;Received ImageUrl:&quot; + imageUri);\n                        setExistingArtwork(imageUri);\n                    }\n                }\n                else\n                {\n                    MainWindow.logger.severe(&quot;Unknown DataFlavor for ImageUrl&quot;);\n                    for(DataFlavor next:trans.getTransferDataFlavors())\n                    {\n                        MainWindow.logger.severe(next.toString());\n                    }\n                }\n                dtde.dropComplete(true);\n            }\n            catch(Exception ex)\n            {\n                MainWindow.logger.log(Level.SEVERE, ex.getMessage(), ex);\n                dtde.dropComplete(false);\n            }\n        }\n    \n        /**\n         * TODO do we have to convert to JPG, cant we keep as PNG\n         * @param image\n         */\n        private void setExistingArtwork(BufferedImage image)\n        {\n            try\n            {\n                byte[] imageData = writeCompressedJpegImageToByteArray(image, 1.0f);\n                coverImage = ImageCache.saveNewCoverImage(image, imageData, &quot;internet&quot;, com.jthink.songlayer.CoverImage.createKeyFromData(imageData),\n                        MIN_IMAGE_SIZE,\n                        UserOption.ARTWORK_MAX_SIZE.getIntValue()\n                );\n                SongCache.saveImagesForReport(coverImage, null);\n                createNewArtworkImage(image);\n            }\n            catch (IOException ex)\n            {\n                MainWindow.logger.log(Level.SEVERE, ex.getMessage(), ex);\n            }\n        }\n    \n        /**\n         * Write Compressed Jpeg, use minimum compression of 1f for best quality\n         *\n         * @param bi\n         * @param compressionLevel\n         * @return\n         * @throws IOException\n         */\n        private static byte[] writeCompressedJpegImageToByteArray(BufferedImage bi, float compressionLevel) throws IOException\n        {\n            ImageWriter imageWriter = ImageIO.getImageWritersByFormatName( &quot;jpg&quot;).next();\n            ImageWriteParam writeParams = imageWriter.getDefaultWriteParam();\n            writeParams.setCompressionMode(ImageWriteParam.MODE_EXPLICIT);\n            writeParams.setCompressionQuality(compressionLevel);\n    \n            final ByteArrayOutputStream output = new ByteArrayOutputStream();\n            imageWriter.setOutput( new MemoryCacheImageOutputStream(output));\n            IIOImage outputImage = new IIOImage(bi, null, null);\n            imageWriter.write(null, outputImage, writeParams);\n            imageWriter.dispose();\n    \n            output.flush();\n            final byte[] imageData = output.toByteArray();\n            return imageData;\n        }\n    \n        /**\n         *\n         * @param imageUri\n         */\n        private void setExistingArtwork(URI imageUri)\n        {\n            byte[] imageData = RemoteArtworkLookup.getDirectImage(imageUri.toString());\n            if (imageData != null)\n            {\n                BufferedImage image = ArtworkHelper.createBufferedImageFromRawData(imageData, imageUri.toString());\n                coverImage = ImageCache.saveNewCoverImage(image, imageData, &quot;internet&quot;, com.jthink.songlayer.CoverImage.createKeyFromData(imageData),\n                        UserPreferences.getInstance().getMinImageSize(),\n                        (Integer) UserOption.ARTWORK_MAX_SIZE.getUserPref().getValue());\n                SongCache.saveImagesForReport(coverImage, null);\n                createNewArtworkImage(image);\n            }\n            else\n            {\n                MainWindow.logger.severe(&quot;Unable To Decode Image:&quot;+imageUri.toString());\n            }\n        }\n    \n        /**\n         *\n         * @param file\n         */\n        private void setExistingArtwork(File file)\n        {\n            try\n            {\n                ImageFileFilter iff = ImageFilterFactory.getImageFilter();\n                if(iff.accept(file))\n                {\n                    byte[] imageData = Files.readAllBytes(file.toPath());\n                    BufferedImage image = ArtworkHelper.createBufferedImageFromRawData(imageData, file.getName());\n                    coverImage = ImageCache.saveNewCoverImage(image, imageData, file.getName(),\n                            com.jthink.songlayer.CoverImage.createKeyFromData(imageData),\n                            UserPreferences.getInstance().getMinImageSize(),\n                            (Integer) UserOption.ARTWORK_MAX_SIZE.getUserPref().getValue());\n                    SongCache.saveImagesForReport(coverImage, null);\n                    createNewArtworkImage(image);\n                }\n            }\n            catch(Exception ex)\n            {\n                MainWindow.logger.log(Level.SEVERE, ex.getMessage(), ex);\n            }\n        }\n    \n        /**\n         * Update new artwork label with version of this image\n         *\n         * @param image\n         */\n        private void createNewArtworkImage(BufferedImage image)\n        {\n            BufferedImage ret = new BufferedImage(ARTWORK_SIZE, ARTWORK_SIZE, BufferedImage.TYPE_INT_RGB);\n            ret.getGraphics().drawImage(image, 0, 0, ARTWORK_SIZE, ARTWORK_SIZE, null);\n            ImageIcon ii = new ImageIcon(ret);\n            displayArtwork.setIcon(ii);\n            displayArtwork.setText(image.getWidth() + &quot; x &quot; + image.getHeight());\n            ArtworkFont.formatArtworkLabel(displayArtwork);\n        }\n    \n        public static CoverImage getCoverImage()\n        {\n            return coverImage;\n        }\n    }\n</code></pre>\n<p><strong>Update</strong></p>\n<p>Removed the synchonized keyword as suggested by VGR, now gets into drop but throws an Exception</p>\n<pre><code>    01/2025 12.52.09:GMT:ArtworkDropTarget:drop:SEVERE: Cannot invoke &quot;String.length()&quot; because &quot;spec&quot; is null\n    java.awt.dnd.InvalidDnDOperationException: Cannot invoke &quot;String.length()&quot; because &quot;spec&quot; is null\n        at java.desktop/sun.awt.dnd.SunDropTargetContextPeer.getTransferData(SunDropTargetContextPeer.java:274)\n        at java.desktop/sun.awt.datatransfer.TransferableProxy.getTransferData(TransferableProxy.java:73)\n        at java.desktop/java.awt.dnd.DropTargetContext$TransferableProxy.getTransferData(DropTargetContext.java:387)\n        at com.jthink.songkong.ui.startdialog.editsongs.ArtworkDropTarget.drop(ArtworkDropTarget.java:109)\n        at java.desktop/sun.awt.dnd.SunDropTargetContextPeer.processDropMessage(SunDropTargetContextPeer.java:548)\n        at java.desktop/sun.lwawt.macosx.CDropTargetContextPeer.processDropMessage(CDropTargetContextPeer.java:129)\n        at java.desktop/sun.awt.dnd.SunDropTargetContextPeer$EventDispatcher.dispatchDropEvent(SunDropTargetContextPeer.java:864)\n        at java.desktop/sun.awt.dnd.SunDropTargetContextPeer$EventDispatcher.dispatchEvent(SunDropTargetContextPeer.java:788)\n        at java.desktop/sun.awt.dnd.SunDropTargetEvent.dispatch(SunDropTargetEvent.java:48)\n        at java.desktop/java.awt.Component.dispatchEventImpl(Component.java:4861)\n        at java.desktop/java.awt.Container.dispatchEventImpl(Container.java:2324)\n        at java.desktop/java.awt.Component.dispatchEvent(Component.java:4828)\n        at java.desktop/java.awt.LightweightDispatcher.retargetMouseEvent(Container.java:4948)\n        at java.desktop/java.awt.LightweightDispatcher.processDropTargetEvent(Container.java:4649)\n        at java.desktop/java.awt.LightweightDispatcher.dispatchEvent(Container.java:4511)\n        at java.desktop/java.awt.Container.dispatchEventImpl(Container.java:2310)\n        at java.desktop/java.awt.Window.dispatchEventImpl(Window.java:2780)\n        at java.desktop/java.awt.Component.dispatchEvent(Component.java:4828)\n        at java.desktop/java.awt.EventQueue.dispatchEventImpl(EventQueue.java:775)\n        at java.desktop/java.awt.EventQueue$4.run(EventQueue.java:720)\n        at java.desktop/java.awt.EventQueue$4.run(EventQueue.java:714)\n        at java.base/java.security.AccessController.doPrivileged(AccessController.java:400)\n        at java.base/java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:87)\n        at java.base/java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:98)\n        at java.desktop/java.awt.EventQueue$5.run(EventQueue.java:747)\n        at java.desktop/java.awt.EventQueue$5.run(EventQueue.java:745)\n        at java.base/java.security.AccessController.doPrivileged(AccessController.java:400)\n        at java.base/java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:87)\n        at java.desktop/java.awt.EventQueue.dispatchEvent(EventQueue.java:744)\n        at java.desktop/java.awt.EventDispatchThread.pumpOneEventForFilters(EventDispatchThread.java:203)\n        at java.desktop/java.awt.EventDispatchThread.pumpEventsForFilter(EventDispatchThread.java:124)\n        at java.desktop/java.awt.EventDispatchThread.pumpEventsForHierarchy(EventDispatchThread.java:113)\n        at java.desktop/java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:109)\n        at java.desktop/java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:101)\n        at java.desktop/java.awt.EventDispatchThread.run(EventDispatchThread.java:90)\n</code></pre>\n<p>Possible related issue - <a href=\"https://bugs.openjdk.org/browse/JDK-4358053\" rel=\"nofollow noreferrer\">https://bugs.openjdk.org/browse/JDK-4358053</a></p>\n<p><strong>Update 2</strong></p>\n<p>As also suggested by VGR removed multiple calls to <code>getTransferData()</code> so can only ever be called once per invocation of method, made no difference.</p>\n<p><strong>Update 3</strong></p>\n<p>Looked at the data flavors available and swapped round the <code>if</code> statement so it looks for</p>\n<pre><code> uriListFlavor   = new DataFlavor(&quot;text/uri-list;class=java.lang.String&quot;);\n</code></pre>\n<p>before</p>\n<pre><code>urlFlavour = new DataFlavor(&quot;application/x-java-url;class=java.net.URL&quot;);\n</code></pre>\n<p>and then it works.</p>\n<p>So it is my opnion that since before failed calling <code>getTransferData()</code> with</p>\n<pre><code>java.awt.dnd.InvalidDnDOperationException: Cannot invoke &quot;String.length()&quot; because &quot;spec&quot; is null\n    at java.desktop/sun.awt.dnd.SunDropTargetContextPeer.getTransferData(SunDropTargetContextPeer.java:274)\n    at java.desktop/sun.awt.datatransfer.TransferableProxy.getTransferData(TransferableProxy.java:73)\n    at java.desktop/java.awt.dnd.DropTargetContext$TransferableProxy.getTransferData(DropTargetContext.java:387)\n</code></pre>\n<p>For a flavor it had reported it had and before I did any other processing that this is actually a bug in the code that implements Java for MacOS.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}