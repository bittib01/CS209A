{
  "question": {
    "tags": [
      "java",
      "hibernate",
      "jpa",
      "spring-data-jpa",
      "hibernate-mapping"
    ],
    "owner": {
      "account_id": 16232337,
      "reputation": 51,
      "user_id": 11720740,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/159c605fd5e4beb4413ff268a6a93498?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Yury Shafran",
      "link": "https://stackoverflow.com/users/11720740/yury-shafran"
    },
    "is_answered": false,
    "view_count": 744,
    "answer_count": 1,
    "score": 2,
    "last_activity_date": 1755000513,
    "creation_date": 1732611190,
    "last_edit_date": 1755000513,
    "question_id": 79225949,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79225949/hibernate-6-6-fails-if-there-is-a-composite-generic-id-partially-in-a-mappedsu",
    "title": "Hibernate 6.6 fails if there is a composite generic @Id partially in a @MappedSuperclass",
    "body": "<h2>Update</h2>\n<p><strong>2025/05/12</strong>\nHaving tried to create a <a href=\"https://github.com/hibernate/hibernate-test-case-templates\" rel=\"nofollow noreferrer\">Hibernate Test Case</a>, I found out that my problem isn't about generic identifiers. It's about composite keys whose fields are distributed between classes. The problem has been described and reproduced in <a href=\"https://hibernate.atlassian.net/browse/HHH-19076\" rel=\"nofollow noreferrer\">HHH-19076</a>.</p>\n<p><strong>2025/08/01</strong>\n<a href=\"https://hibernate.atlassian.net/browse/HHH-19076\" rel=\"nofollow noreferrer\">HHH-19076</a> fixed the case with explicit identifiers, but generic identifiers still don't work. I have created the corresponding bug <a href=\"https://hibernate.atlassian.net/browse/HHH-19706\" rel=\"nofollow noreferrer\">HHH-19706</a>.</p>\n<h2>Original</h2>\n<p>Having changed <code>org.springframework.boot:spring-boot-starter-parent</code> from <code>3.3.4</code> to <code>3.4.0</code> (and implicitly Hibernate from <code>6.5.3.Final</code> to <code>6.6.2.Final</code>), I faced <code>java.lang.IllegalArgumentException: expecting IdClass mapping</code> for one of my inherited <code>@Entity</code>s.</p>\n<p>The parent class.</p>\n<pre class=\"lang-java prettyprint-override\"><code>import jakarta.persistence.Column;\nimport jakarta.persistence.Id;\nimport jakarta.persistence.MappedSuperclass;\nimport org.springframework.lang.Nullable;\nimport java.io.Serializable;\n// ... other imports\n\n@MappedSuperclass\npublic abstract class Parent&lt;K extends Serializable &amp; Comparable&lt;K&gt;, C extends Parent&lt;K, C&gt;&gt; {\n\n    protected static final String LEADER_ID_COLUMN = &quot;LEADER_ID&quot;;\n\n    @Id\n    @Column(name = LEADER_ID_COLUMN, nullable = false, updatable = false)\n    @Nullable\n    private K leaderId;\n\n    // ... other fields\n\n    @Nullable\n    public K getLeaderId() {\n        return leaderId;\n    }\n\n    public C setLeaderId(K entityId) {\n        this.leaderId = entityId;\n        return itself();\n    }\n\n    // ... getters/setters/equals/hashCode/toString\n\n    protected abstract C itself();\n\n}\n</code></pre>\n<p>One of the derived classes which leads to the exception. (I suppose that the rest inheritors have the same problem but the process doesn't reach them.)</p>\n<pre class=\"lang-java prettyprint-override\"><code>import jakarta.persistence.Entity;\nimport org.springframework.lang.Nullable;\n// ... other imports\n\n@Entity\npublic class Child extends Parent&lt;Long, Child&gt; {\n\n    // ... fields/getters/setters\n\n    @Override\n    protected Child itself() {\n        return this;\n    }\n\n    // ... equals/hashCode/toString\n\n}\n</code></pre>\n<p>When my application reaches <code>org.hibernate.persister.entity.AbstractEntityPersister.findAttributeMapping(String name)</code> for <code>leaderId</code> inside <code>Child</code> entity, <code>declaredAttributeMappings</code> contains all the fields from both <code>Parent</code> and <code>Child</code> apart from <code>leaderId</code>. Plus <code>superMappingType</code> is <code>null</code>, so the result of the call is <code>null</code>.</p>\n<pre class=\"lang-java prettyprint-override\"><code>    @Override\n    public AttributeMapping findAttributeMapping(String name) {\n        final AttributeMapping declaredAttribute = declaredAttributeMappings.get( name );\n        if ( declaredAttribute != null ) {\n            return declaredAttribute;\n        }\n\n        if ( superMappingType != null ) {\n            return superMappingType.findAttributeMapping( name );\n        }\n\n        return null;\n    }\n</code></pre>\n<p>That leads to the situation where <code>org.hibernate.metamodel.internal.AttributeFactory.resolveEntityMember(Property property, EntityPersister declaringEntity)</code> calls <code>resolveVirtualIdentifierMember</code>.</p>\n<pre class=\"lang-java prettyprint-override\"><code>    private static Member resolveEntityMember(Property property, EntityPersister declaringEntity) {\n        String propertyName = property.getName();\n        AttributeMapping attributeMapping = declaringEntity.findAttributeMapping(propertyName);\n        if (attributeMapping == null) {\n            return resolveVirtualIdentifierMember(property, declaringEntity);\n        } else {\n            // ...\n        }\n    }\n</code></pre>\n<p><code>resolveVirtualIdentifierMember( Property property, EntityPersister entityPersister)</code> requries <code>identifierMapping.getNature()</code> to be <code>VIRTUAL</code> but in the case it's <code>SIMPLE</code>.</p>\n<pre class=\"lang-java prettyprint-override\"><code>    private static Member resolveVirtualIdentifierMember( Property property, EntityPersister entityPersister) {\n        final EntityIdentifierMapping identifierMapping = entityPersister.getIdentifierMapping();\n\n        if ( identifierMapping.getNature() != EntityIdentifierMapping.Nature.VIRTUAL ) {\n            throw new IllegalArgumentException( &quot;expecting IdClass mapping&quot; );\n        }\n\n        // ...\n    }\n</code></pre>\n<p>The result is an exception.</p>\n<pre><code>ERROR SpringApplication Application run failed\n org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory' defined in class path resource [org/springframework/boot/autoconfigure/orm/jpa/HibernateJpaConfiguration.class]: [PersistenceUnit: default] Unable to build Hibernate SessionFactory; nested exception is java.lang.IllegalArgumentException: expecting IdClass mapping\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1802)\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:601)\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:523)\n    at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:336)\n    at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:288)\n    at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:334)\n    at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:204)\n    at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:970)\n    at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:627)\n    at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:752)\n    at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:439)\n    at org.springframework.boot.SpringApplication.run(SpringApplication.java:318)\n    at org.springframework.boot.test.context.SpringBootContextLoader.lambda$loadContext$3(SpringBootContextLoader.java:137)\n    at org.springframework.util.function.ThrowingSupplier.get(ThrowingSupplier.java:58)\n    at org.springframework.util.function.ThrowingSupplier.get(ThrowingSupplier.java:46)\n    at org.springframework.boot.SpringApplication.withHook(SpringApplication.java:1461)\n    at org.springframework.boot.test.context.SpringBootContextLoader$ContextLoaderHook.run(SpringBootContextLoader.java:553)\n    at org.springframework.boot.test.context.SpringBootContextLoader.loadContext(SpringBootContextLoader.java:137)\n    at org.springframework.boot.test.context.SpringBootContextLoader.loadContext(SpringBootContextLoader.java:108)\n    at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContextInternal(DefaultCacheAwareContextLoaderDelegate.java:225)\n    at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:152)\n    at org.springframework.test.context.support.DefaultTestContext.getApplicationContext(DefaultTestContext.java:130)\n    at org.springframework.test.context.junit.jupiter.SpringExtension.getApplicationContext(SpringExtension.java:352)\n    at org.springframework.test.context.junit.jupiter.SpringExtension.resolveParameter(SpringExtension.java:338)\n    at org.junit.jupiter.engine.execution.ParameterResolutionUtils.resolveParameter(ParameterResolutionUtils.java:136)\n    at org.junit.jupiter.engine.execution.ParameterResolutionUtils.resolveParameters(ParameterResolutionUtils.java:103)\n    at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:59)\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.invokeTestClassConstructor(ClassBasedTestDescriptor.java:364)\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.instantiateTestClass(ClassBasedTestDescriptor.java:311)\n    at org.junit.jupiter.engine.descriptor.ClassTestDescriptor.instantiateTestClass(ClassTestDescriptor.java:79)\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.instantiateAndPostProcessTestInstance(ClassBasedTestDescriptor.java:287)\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.lambda$testInstancesProvider$5(ClassBasedTestDescriptor.java:279)\n    at java.base/java.util.Optional.orElseGet(Optional.java:364)\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.lambda$testInstancesProvider$6(ClassBasedTestDescriptor.java:278)\n    at org.junit.jupiter.engine.execution.TestInstancesProvider.getTestInstances(TestInstancesProvider.java:31)\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.lambda$before$3(ClassBasedTestDescriptor.java:204)\n    at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.before(ClassBasedTestDescriptor.java:203)\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.before(ClassBasedTestDescriptor.java:85)\n    at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:153)\n    at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\n    at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)\n    at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)\n    at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)\n    at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\n    at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)\n    at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)\n    at java.base/java.util.ArrayList.forEach(ArrayList.java:1596)\n    at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)\n    at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:160)\n    at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\n    at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)\n    at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)\n    at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)\n    at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\n    at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)\n    at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)\n    at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)\n    at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)\n    at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)\n    at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:198)\n    at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:169)\n    at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:93)\n    at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:58)\n    at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:141)\n    at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:57)\n    at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)\n    at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)\n    at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)\n    at org.junit.platform.launcher.core.SessionPerRequestLauncher.execute(SessionPerRequestLauncher.java:63)\n    at com.intellij.junit5.JUnit5IdeaTestRunner.startRunnerWithArgs(JUnit5IdeaTestRunner.java:57)\n    at com.intellij.rt.junit.IdeaTestRunner$Repeater$1.execute(IdeaTestRunner.java:38)\n    at com.intellij.rt.execution.junit.TestsRepeater.repeat(TestsRepeater.java:11)\n    at com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:35)\n    at com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:232)\n    at com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:55)\nCaused by: jakarta.persistence.PersistenceException: [PersistenceUnit: default] Unable to build Hibernate SessionFactory; nested exception is java.lang.IllegalArgumentException: expecting IdClass mapping\n    at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.buildNativeEntityManagerFactory(AbstractEntityManagerFactoryBean.java:431)\n    at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.afterPropertiesSet(AbstractEntityManagerFactoryBean.java:400)\n    at org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean.afterPropertiesSet(LocalContainerEntityManagerFactoryBean.java:366)\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1849)\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1798)\n    ... 75 more\nCaused by: java.lang.IllegalArgumentException: expecting IdClass mapping\n    at org.hibernate.metamodel.internal.AttributeFactory.resolveVirtualIdentifierMember(AttributeFactory.java:715)\n    at org.hibernate.metamodel.internal.AttributeFactory.resolveEntityMember(AttributeFactory.java:765)\n    at org.hibernate.metamodel.internal.AttributeFactory.resolveMappedSuperclassMember(AttributeFactory.java:781)\n    at org.hibernate.metamodel.internal.AttributeFactory.lambda$static$2(AttributeFactory.java:746)\n    at org.hibernate.metamodel.internal.AttributeFactory.determineAttributeMetadata(AttributeFactory.java:460)\n    at org.hibernate.metamodel.internal.AttributeFactory.buildAttribute(AttributeFactory.java:122)\n    at org.hibernate.metamodel.internal.AttributeFactory.buildAttribute(AttributeFactory.java:108)\n    at org.hibernate.metamodel.internal.MetadataContext.buildAttribute(MetadataContext.java:289)\n    at org.hibernate.metamodel.internal.MetadataContext.wrapUp(MetadataContext.java:374)\n    at org.hibernate.metamodel.model.domain.internal.JpaMetamodelImpl.processJpa(JpaMetamodelImpl.java:618)\n    at org.hibernate.metamodel.model.domain.internal.MappingMetamodelImpl.finishInitialization(MappingMetamodelImpl.java:216)\n    at org.hibernate.internal.SessionFactoryImpl.initializeMappingModel(SessionFactoryImpl.java:373)\n    at org.hibernate.internal.SessionFactoryImpl.&lt;init&gt;(SessionFactoryImpl.java:302)\n    at org.hibernate.boot.internal.SessionFactoryBuilderImpl.build(SessionFactoryBuilderImpl.java:463)\n    at org.hibernate.jpa.boot.internal.EntityManagerFactoryBuilderImpl.build(EntityManagerFactoryBuilderImpl.java:1506)\n    at org.springframework.orm.jpa.vendor.SpringHibernateJpaPersistenceProvider.createContainerEntityManagerFactory(SpringHibernateJpaPersistenceProvider.java:66)\n    at org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean.createNativeEntityManagerFactory(LocalContainerEntityManagerFactoryBean.java:390)\n    at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.buildNativeEntityManagerFactory(AbstractEntityManagerFactoryBean.java:419)\n    ... 79 more\n</code></pre>\n<p>I have tried Hibernate <code>6.6.3.Final</code> and <code>6.6.4.Final</code>. The behaviour is the same.</p>\n<p>Any clarification is appreciated. Are there stricter requirements in the new version of Hibernate which I don't meet?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}