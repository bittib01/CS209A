{
  "question": {
    "tags": [
      "java",
      "opencv",
      "apache-storm"
    ],
    "owner": {
      "account_id": 18877590,
      "reputation": 11,
      "user_id": 13770775,
      "user_type": "registered",
      "profile_image": "https://lh3.googleusercontent.com/a-/AOh14GgkT3u03KyoCJwM9mRdfClliAMP5ErZ39QkN0SM=k-s256",
      "display_name": "Hatam Abolghasemi",
      "link": "https://stackoverflow.com/users/13770775/hatam-abolghasemi"
    },
    "is_answered": false,
    "view_count": 47,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1709213942,
    "creation_date": 1704391600,
    "question_id": 77760342,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/77760342/apache-storm-cant-receive-tuples-from-multiple-bolts",
    "title": "Apache Storm: can&#39;t receive tuples from multiple bolts",
    "body": "<p>I'm creating a topology which reads a sample video, do some conversions on it and saves it as output and I'm using apache storm to apply different filters simultaneously. Imagine after reading the video I sent its frames to 2 bolts. one applies gaussian blur effect and the other one sharpens every receiving frame. Both sharpener and gaussian blur emit their tuples to the same destination successfully. And now I want to merge the resulting frames emitted from these two bolts but the aggregator-bolt keeps receiving only one tuple values at a time. how can I fix it?</p>\n<p><strong>Topology.java:</strong></p>\n<pre><code>import org.apache.storm.Config;\nimport org.apache.storm.LocalCluster;\nimport org.apache.storm.topology.TopologyBuilder;\nimport java.io.*;\n\npublic class Topology {\n   public static void main(String[] args) throws Exception {\n      // Create a log file for stdout and stderr\n      File logFile = new File(&quot;topology.log&quot;);\n\n      // Redirect stdout and stderr to the log file\n      PrintStream printStream = new PrintStream(new FileOutputStream(logFile));\n       try (printStream) {\n           System.setOut(printStream);\n           System.setErr(printStream);\n           Config config = new Config();                      // Create Config instance for cluster configuration\n           config.setDebug(true);\n           TopologyBuilder builder = new TopologyBuilder();   // Create a TopologyBuilder\n\n           Spout spout = new Spout();                         // Set the spout and bolts in the topology\n           BoltFrameAnalyzer boltFrameAnalyzer = new BoltFrameAnalyzer();\n           BoltAnalysisSaver boltAnalysisSaver = new BoltAnalysisSaver();\n           BoltImageProcessor boltImageProcessor = new BoltImageProcessor();\n           BoltGaussianBlur boltGaussianBlur = new BoltGaussianBlur();\n           BoltSharpener boltSharpener = new BoltSharpener();\n           BoltFrameAggregator boltFrameAggregator = new BoltFrameAggregator();\n           BoltOutputGenerator boltOutputGenerator = new BoltOutputGenerator();\n           builder.setSpout(&quot;spout&quot;, spout, 1);      // Define the data flow by connecting the spout and bolts\n           builder.setBolt(&quot;bolt-frame-analyzer&quot;, boltFrameAnalyzer, 1).shuffleGrouping(&quot;spout&quot;);\n           builder.setBolt(&quot;bolt-analysis-saver&quot;, boltAnalysisSaver, 1).shuffleGrouping(&quot;bolt-frame-analyzer&quot;);\n           builder.setBolt(&quot;bolt-image-processor&quot;, boltImageProcessor, 1).shuffleGrouping(&quot;spout&quot;);\n           builder.setBolt(&quot;bolt-gaussian-blur&quot;, boltGaussianBlur, 1).shuffleGrouping(&quot;bolt-image-processor&quot;);\n           builder.setBolt(&quot;bolt-sharpener&quot;, boltSharpener, 1).shuffleGrouping(&quot;bolt-image-processor&quot;);\n           builder.setBolt(&quot;bolt-frame-aggregator&quot;, boltFrameAggregator, 1).shuffleGrouping(&quot;bolt-sharpener&quot;).shuffleGrouping(&quot;bolt-gaussian-blur&quot;);\n           builder.setBolt(&quot;bolt-output-generator&quot;, boltOutputGenerator, 1).shuffleGrouping(&quot;bolt-frame-aggregator&quot;);\n\n           try (LocalCluster cluster = new LocalCluster()) {  // Use try-with-resources\n               cluster.submitTopology(&quot;Topology&quot;, config, builder.createTopology());\n               Thread.sleep(100000);  // Adjust sleep time as needed\n           }  // Automatic cluster shutdown when exiting the try block\n       }\n       // Close the PrintStream and log file\n   }\n}\n</code></pre>\n<p><strong>BoltGaussianBlur.java</strong>:</p>\n<pre><code>import org.apache.storm.topology.BasicOutputCollector;\nimport org.apache.storm.topology.OutputFieldsDeclarer;\nimport org.apache.storm.topology.base.BaseBasicBolt;\nimport org.apache.storm.tuple.Fields;\nimport org.apache.storm.tuple.Tuple;\nimport org.apache.storm.tuple.Values;\nimport org.opencv.core.Mat;\nimport org.opencv.core.Size;\nimport org.opencv.imgcodecs.Imgcodecs;\nimport org.opencv.imgproc.Imgproc;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport java.io.FileInputStream;\nimport java.io.IOException;\nimport java.util.Properties;\n\npublic class BoltGaussianBlur extends BaseBasicBolt {\n    private final String framesGaussianBlurFilePath;\n\n    public BoltGaussianBlur() {\n        try {\n            Properties prop = new Properties();\n            prop.load(new FileInputStream(&quot;config.ini&quot;));\n            framesGaussianBlurFilePath = prop.getProperty(&quot;framesGaussianBlurFilePath&quot;);\n        } catch (IOException e) {\n            LOG.error(&quot;BoltImageProcessor: Error occurred while reading config.ini file&quot;, e);\n            throw new RuntimeException(e);\n        }\n    }\n\n    private static final Logger LOG = LoggerFactory.getLogger(BoltGaussianBlur.class);\n    public void execute(Tuple input, BasicOutputCollector collector) {\n        int gaussianBlurFrameNumber = input.getIntegerByField(&quot;frameNumber&quot;);\n        LOG.info(&quot;BoltGaussianBlur: Frame #&quot; + gaussianBlurFrameNumber + &quot; has been received successfully.&quot;);\n        Mat receivedFrame = (Mat) input.getValueByField(&quot;resizedFrame&quot;);\n        Mat gaussianBlurFrame = new Mat();\n        Imgproc.GaussianBlur(receivedFrame, gaussianBlurFrame, new Size(9, 9), 2, 2);\n        String gaussianBlurFileName = framesGaussianBlurFilePath + &quot;/frame_&quot; + gaussianBlurFrameNumber + &quot;_gaussian_blur.png&quot;;\n        Imgcodecs.imwrite(gaussianBlurFileName, gaussianBlurFrame);\n        LOG.info(&quot;BoltGaussianBlur: Frame #&quot; + gaussianBlurFrameNumber + &quot; has been converted to Gaussian blur successfully.&quot;);\n        collector.emit(new Values(gaussianBlurFrame, gaussianBlurFrameNumber));\n    }\n\n    public void declareOutputFields(OutputFieldsDeclarer declarer) {\n        declarer.declare(new Fields(&quot;gaussianBlurFrame&quot;, &quot;gaussianBlurFrameNumber&quot;));\n    }\n}\n</code></pre>\n<p><strong>BoltSharpener.java</strong>:</p>\n<pre><code>import org.apache.storm.topology.BasicOutputCollector;\nimport org.apache.storm.topology.OutputFieldsDeclarer;\nimport org.apache.storm.topology.base.BaseBasicBolt;\nimport org.apache.storm.tuple.Fields;\nimport org.apache.storm.tuple.Tuple;\nimport org.apache.storm.tuple.Values;\nimport org.opencv.core.Core;\nimport org.opencv.core.Mat;\nimport org.opencv.core.Size;\nimport org.opencv.imgproc.Imgproc;\nimport org.opencv.imgcodecs.Imgcodecs;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport java.io.FileInputStream;\nimport java.io.IOException;\nimport java.util.Properties;\n\npublic class BoltSharpener extends BaseBasicBolt {\n    private final String framesSharpenedFilePath;\n\n    public BoltSharpener() {\n        try {\n            Properties prop = new Properties();\n            prop.load(new FileInputStream(&quot;config.ini&quot;));\n            framesSharpenedFilePath = prop.getProperty(&quot;framesSharpenedFilePath&quot;);\n        } catch (IOException e) {\n            LOG.error(&quot;BoltSharpener: Error occurred while reading config.ini file&quot;, e);\n            throw new RuntimeException(e);\n        }\n    }\n\n    private static final Logger LOG = LoggerFactory.getLogger(BoltSharpener.class);\n    public void execute(Tuple input, BasicOutputCollector collector) {\n        int sharpenedFrameNumber = input.getIntegerByField(&quot;frameNumber&quot;);\n        LOG.info(&quot;BoltSharpener: Frame #&quot; + sharpenedFrameNumber + &quot; has been received successfully.&quot;);\n        Mat receivedFrame = (Mat) input.getValueByField(&quot;resizedFrame&quot;);\n        Mat sharpenedFrame = new Mat();\n        Imgproc.GaussianBlur(receivedFrame, sharpenedFrame, new Size(0, 0), 10);\n        Core.addWeighted(receivedFrame, 1.5, sharpenedFrame, -0.5, 0, sharpenedFrame);\n        String sharpenedFileName = framesSharpenedFilePath + &quot;/frame_&quot; + sharpenedFrameNumber + &quot;_sharpened.png&quot;;\n        Imgcodecs.imwrite(sharpenedFileName, sharpenedFrame);\n        LOG.info(&quot;BoltSharpener: Frame #&quot; + sharpenedFrameNumber + &quot; has been sharpened successfully.&quot;);\n        collector.emit(new Values(sharpenedFrame, sharpenedFrameNumber));\n    }\n\n    public void declareOutputFields(OutputFieldsDeclarer declarer) {\n        declarer.declare(new Fields(&quot;sharpenedFrame&quot;, &quot;sharpenedFrameNumber&quot;));\n    }\n}\n</code></pre>\n<p><strong>BoltFrameAggregator</strong>:</p>\n<pre><code>import org.apache.storm.topology.BasicOutputCollector;\nimport org.apache.storm.topology.OutputFieldsDeclarer;\nimport org.apache.storm.topology.base.BaseBasicBolt;\nimport org.apache.storm.tuple.Fields;\nimport org.apache.storm.tuple.Tuple;\nimport org.apache.storm.tuple.Values;\nimport org.opencv.core.Core;\nimport org.opencv.core.Mat;\nimport org.opencv.imgcodecs.Imgcodecs;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport java.io.FileInputStream;\nimport java.io.IOException;\nimport java.util.Properties;\n\npublic class BoltFrameAggregator extends BaseBasicBolt {\n    private final String framesAggregated;\n    public BoltFrameAggregator() {\n        try {\n            Properties prop = new Properties();\n            prop.load(new FileInputStream(&quot;config.ini&quot;));\n            framesAggregated = prop.getProperty(&quot;framesAggregatedFilePath&quot;);\n        } catch (IOException e) {\n            LOG.error(&quot;BoltAggregator: Error occurred while reading config.ini file&quot;, e);\n            throw new RuntimeException(e);\n        }\n    }\n\n    private static final Logger LOG = LoggerFactory.getLogger(BoltFrameAggregator.class);\n    public void execute(Tuple input, BasicOutputCollector collector) {\n        Mat receivedGaussianBlurFrame = (Mat) input.getValueByField(&quot;gaussianBlurFrame&quot;);\n        int gaussianBlurFrameNumber = input.getIntegerByField(&quot;gaussianBlurFrameNumber&quot;);\n        Mat receivedSharpenedFrame = (Mat) input.getValueByField(&quot;sharpenedFrame&quot;);\n        int sharpenedFrameNumber = input.getIntegerByField(&quot;sharpenedFrameNumber&quot;);\n        int aggregatedFrameNumber = input.getIntegerByField(&quot;sharpenedFrameNumber&quot;);\n        Mat aggregatedFrame = new Mat();\n        if (sharpenedFrameNumber == gaussianBlurFrameNumber) {\n            Core.addWeighted(receivedSharpenedFrame, 1, receivedGaussianBlurFrame, 1, 0, aggregatedFrame);\n            String aggregatedFileName = framesAggregated + &quot;/frame_&quot; + sharpenedFrameNumber + &quot;_aggregated.png&quot;;\n            Imgcodecs.imwrite(aggregatedFileName, aggregatedFrame);\n            LOG.info(&quot;BoltAggregator: Frame #&quot; + sharpenedFrameNumber + &quot; has been aggregated successfully.&quot;);\n            collector.emit(new Values(aggregatedFrame, aggregatedFrameNumber));\n        } else {\n            LOG.warn(&quot;BoltAggregator: Frame numbers for Gaussian blur and sharpened frames do not match.&quot;);\n        }\n    }\n\n    public void declareOutputFields(OutputFieldsDeclarer declarer) {\n        declarer.declare(new Fields(&quot;aggregatedFrame&quot;, &quot;aggregatedFrameNumber&quot;));\n    }\n}\n</code></pre>\n<p>I checked every typo mistakes, tried assigning a name to the output streams of gaussian-blur and sharpener. Even I tried to store the receiving tuples to see if after the first 4 or 5 tuples from gaussian-blur, the sharpener tuples will arrive but didn't work.</p>\n<p><strong>Error Log:</strong></p>\n<pre><code>[Thread-42-bolt-frame-aggregator-executor[3, 3]] INFO  o.a.s.e.Executor - Processing received TUPLE: source: bolt-gaussian-blur:5, stream: default, id: {}, [Mat [ 720*1280*CV_8UC1, isCont=true, isSubmat=false, nativeObj=0x1fc231bd4a0, dataAddr=0x1fc258f0f60 ], 0] PROC_START_TIME(sampled): null EXEC_START_TIME(sampled): null for TASK: 3 \n...\n[Thread-42-bolt-frame-aggregator-executor[3, 3]] ERROR o.a.s.u.Utils - Async loop died!\njava.lang.RuntimeException: java.lang.IllegalArgumentException: sharpenedFrame does not exist\n    at org.apache.storm.executor.Executor.accept(Executor.java:301) ~[storm-client-2.6.0.jar:2.6.0]\n    at org.apache.storm.utils.JCQueue.consumeImpl(JCQueue.java:113) ~[storm-client-2.6.0.jar:2.6.0]\n    at org.apache.storm.utils.JCQueue.consume(JCQueue.java:89) ~[storm-client-2.6.0.jar:2.6.0]\n    at org.apache.storm.executor.bolt.BoltExecutor$1.call(BoltExecutor.java:154) ~[storm-client-2.6.0.jar:2.6.0]\n    at org.apache.storm.executor.bolt.BoltExecutor$1.call(BoltExecutor.java:140) ~[storm-client-2.6.0.jar:2.6.0]\n    at org.apache.storm.utils.Utils$1.run(Utils.java:398) ~[storm-client-2.6.0.jar:2.6.0]\n    at java.base/java.lang.Thread.run(Thread.java:1583) [?:?]\nCaused by: java.lang.IllegalArgumentException: sharpenedFrame does not exist\n    at org.apache.storm.tuple.Fields.fieldIndex(Fields.java:98) ~[storm-client-2.6.0.jar:2.6.0]\n    at org.apache.storm.tuple.TupleImpl.fieldIndex(TupleImpl.java:101) ~[storm-client-2.6.0.jar:2.6.0]\n    at org.apache.storm.tuple.TupleImpl.getValueByField(TupleImpl.java:161) ~[storm-client-2.6.0.jar:2.6.0]\n    at BoltFrameAggregator.execute(BoltFrameAggregator.java:33) ~[classes/:?]\n    at org.apache.storm.topology.BasicBoltExecutor.execute(BasicBoltExecutor.java:48) ~[storm-client-2.6.0.jar:2.6.0]\n    at org.apache.storm.executor.bolt.BoltExecutor.tupleActionFn(BoltExecutor.java:212) ~[storm-client-2.6.0.jar:2.6.0]\n    at org.apache.storm.executor.Executor.accept(Executor.java:294) ~[storm-client-2.6.0.jar:2.6.0]\n    ... 6 more\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}