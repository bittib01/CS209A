{
  "question": {
    "tags": [
      "java",
      "apache-kafka",
      "avro",
      "testcontainers",
      "confluent-schema-registry"
    ],
    "owner": {
      "account_id": 14594666,
      "reputation": 29,
      "user_id": 10540801,
      "user_type": "registered",
      "profile_image": "https://lh3.googleusercontent.com/-lsv13bklESQ/AAAAAAAAAAI/AAAAAAAAVMA/40ukCeQOTXw/s256-rj/photo.jpg",
      "display_name": "Aliaksandr Arashkevich",
      "link": "https://stackoverflow.com/users/10540801/aliaksandr-arashkevich"
    },
    "is_answered": true,
    "view_count": 667,
    "answer_count": 3,
    "score": 1,
    "last_activity_date": 1760981291,
    "creation_date": 1735757958,
    "last_edit_date": 1760981291,
    "question_id": 79322178,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79322178/kafka-schema-registry-failed-to-connect-to-kafka-broker-testcontainers",
    "title": "Kafka Schema Registry failed to connect to Kafka Broker (Testcontainers)",
    "body": "<p>I need to write an integration test for Kafka and Schema Registry working together because of utilizing AVRO serialization.</p>\n<p>My Maven configured as following (Apple M2 Max)</p>\n<pre class=\"lang-bash prettyprint-override\"><code>% mvn -version\nApache Maven 3.9.9 (8e8579a9e76f7d015ee5ec7bfcdc97d260186937)\nMaven home: /opt/homebrew/Cellar/maven/3.9.9/libexec\nJava version: 17.0.13, vendor: Amazon.com Inc., runtime: /Users/neo.bsuir/.sdkman/candidates/java/17.0.13-amzn\nDefault locale: en_US, platform encoding: UTF-8\nOS name: &quot;mac os x&quot;, version: &quot;15.1.1&quot;, arch: &quot;aarch64&quot;, family: &quot;mac&quot;\n</code></pre>\n<p>My test looks like</p>\n<pre class=\"lang-java prettyprint-override\"><code>@SpringBootTest\n@Testcontainers\npublic class KafkaIntegrationTest {\n\n  public static final String CONFLUENT_PLATFORM_VERSION = &quot;7.5.1&quot;;\n\n  private static final ConfluentKafkaContainer KAFKA_CONTAINER;\n  private static final GenericContainer&lt;?&gt; SCHEMA_REGISTER_CONTAINER;\n\n  static {\n\n    final Network network = Network.newNetwork();\n\n    KAFKA_CONTAINER =\n        new ConfluentKafkaContainer(\n            DockerImageName.parse(&quot;confluentinc/cp-kafka:&quot; + CONFLUENT_PLATFORM_VERSION))\n            .withNetwork(network)\n            .withNetworkAliases(&quot;kafka&quot;)\n            .withEnv(&quot;KAFKA_BROKER_ID&quot;, &quot;1&quot;)\n            .withEnv(&quot;KAFKA_LISTENERS&quot;, &quot;PLAINTEXT://0.0.0.0:9092,BROKER://0.0.0.0:9093,CONTROLLER://0.0.0.0:9094&quot;)\n            .withEnv(&quot;KAFKA_ADVERTISED_LISTENERS&quot;, &quot;PLAINTEXT://kafka:9092,BROKER://kafka:9093,CONTROLLER://kafka:9094&quot;)\n            .withEnv(&quot;KAFKA_LISTENER_SECURITY_PROTOCOL_MAP&quot;, &quot;PLAINTEXT:PLAINTEXT,BROKER:PLAINTEXT,CONTROLLER:PLAINTEXT&quot;)\n            .withEnv(&quot;KAFKA_INTER_BROKER_LISTENER_NAME&quot;, &quot;BROKER&quot;)\n            .withEnv(&quot;KAFKA_CONTROLLER_LISTENER_NAMES&quot;, &quot;CONTROLLER&quot;)\n            .withEnv(&quot;KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR&quot;, &quot;1&quot;)\n            .withEnv(&quot;KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR&quot;, &quot;1&quot;)\n            .withExposedPorts(9092, 9093, 9094)\n            .waitingFor(Wait.forListeningPorts(9092));\n    KAFKA_CONTAINER.start();\n\n    SCHEMA_REGISTER_CONTAINER = new GenericContainer&lt;&gt;(\n        DockerImageName.parse(&quot;confluentinc/cp-schema-registry:&quot; + CONFLUENT_PLATFORM_VERSION))\n        .withNetwork(network)\n        .withExposedPorts(8081)\n        .withEnv(&quot;SCHEMA_REGISTRY_HOST_NAME&quot;, &quot;schema-registry&quot;)\n        .withEnv(&quot;SCHEMA_REGISTRY_LISTENERS&quot;, &quot;http://0.0.0.0:8081&quot;)\n        .withEnv(&quot;SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS&quot;,KAFKA_CONTAINER.getBootstrapServers())\n        .dependsOn(KAFKA_CONTAINER)\n        .waitingFor(Wait.forHttp(&quot;/subjects&quot;).forStatusCode(200)\n            .withStartupTimeout(Duration.ofSeconds(5)));\n    SCHEMA_REGISTER_CONTAINER.start();\n  }\n\n  @Test\n  void shouldHaveHealthyContainers() {\n    assertThat(KAFKA_CONTAINER.isHealthy()).isTrue();\n    assertThat(SCHEMA_REGISTER_CONTAINER.isHealthy()).isTrue();\n  }\n\n  @AfterAll\n  static void afterAll() {\n    if (SCHEMA_REGISTER_CONTAINER != null) {\n      SCHEMA_REGISTER_CONTAINER.stop();\n    }\n    if (KAFKA_CONTAINER != null) {\n      KAFKA_CONTAINER.stop();\n    }\n  }\n}\n</code></pre>\n<p>I passed <code>getBootstrapServers()</code> to <code>SCHEMA_REGISTER_CONTAINER</code> but the test failed due to <em>Connection to node -1 (localhost/127.0.0.1:54380) could not be established. Broker may not be available.</em></p>\n<p>Full output from <code>target/surefire-reports/com.example.testcontainers.KafkaIntegrationTest.txt</code>:</p>\n<pre><code>-------------------------------------------------------------------------------\nTest set: com.example.testcontainers.KafkaIntegrationTest\n-------------------------------------------------------------------------------\nTests run: 2, Failures: 0, Errors: 2, Skipped: 0, Time elapsed: 9.166 s &lt;&lt;&lt; FAILURE! -- in com.example.testcontainers.KafkaIntegrationTest\ncom.example.testcontainers.KafkaIntegrationTest.shouldHaveHealthyContainers -- Time elapsed: 0.004 s &lt;&lt;&lt; ERROR!\njava.lang.ExceptionInInitializerError\n    at java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:500)\n...\nCaused by: org.testcontainers.containers.ContainerLaunchException: Container startup failed for image confluentinc/cp-schema-registry:7.5.1\n    at org.testcontainers.containers.GenericContainer.doStart(GenericContainer.java:351)\n    at org.testcontainers.containers.GenericContainer.start(GenericContainer.java:322)\n    at com.example.testcontainers.KafkaIntegrationTest.&lt;clinit&gt;(KafkaIntegrationTest.java:58)\n    ... 5 more\nCaused by: org.rnorth.ducttape.RetryCountExceededException: Retry limit hit with exception\n    at org.rnorth.ducttape.unreliables.Unreliables.retryUntilSuccess(Unreliables.java:88)\n    at org.testcontainers.containers.GenericContainer.doStart(GenericContainer.java:336)\n    ... 7 more\nCaused by: org.testcontainers.containers.ContainerLaunchException: Could not create/start container\n    at org.testcontainers.containers.GenericContainer.tryStart(GenericContainer.java:556)\n    at org.testcontainers.containers.GenericContainer.lambda$doStart$0(GenericContainer.java:346)\n    at org.rnorth.ducttape.unreliables.Unreliables.retryUntilSuccess(Unreliables.java:81)\n    ... 8 more\nCaused by: org.testcontainers.containers.ContainerLaunchException: Timed out waiting for URL to be accessible (http://localhost:55772/subjects should return HTTP [200])\n    at org.testcontainers.containers.wait.strategy.HttpWaitStrategy.waitUntilReady(HttpWaitStrategy.java:320)\n    at org.testcontainers.containers.wait.strategy.AbstractWaitStrategy.waitUntilReady(AbstractWaitStrategy.java:52)\n    at org.testcontainers.containers.GenericContainer.waitUntilContainerStarted(GenericContainer.java:909)\n    at org.testcontainers.containers.GenericContainer.tryStart(GenericContainer.java:492)\n    ... 10 more\nCaused by: org.rnorth.ducttape.TimeoutException: Timeout waiting for result with exception\n    at org.rnorth.ducttape.unreliables.Unreliables.retryUntilSuccess(Unreliables.java:54)\n    at org.testcontainers.containers.wait.strategy.HttpWaitStrategy.waitUntilReady(HttpWaitStrategy.java:252)\n    ... 13 more\nCaused by: java.lang.RuntimeException: java.net.SocketException: Unexpected end of file from server\n    at org.testcontainers.containers.wait.strategy.HttpWaitStrategy.lambda$null$6(HttpWaitStrategy.java:312)\n    at org.rnorth.ducttape.ratelimits.RateLimiter.doWhenReady(RateLimiter.java:27)\n    at org.testcontainers.containers.wait.strategy.HttpWaitStrategy.lambda$waitUntilReady$7(HttpWaitStrategy.java:257)\n    at org.rnorth.ducttape.unreliables.Unreliables.lambda$retryUntilSuccess$0(Unreliables.java:43)\n    at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\n    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\n    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\n    at java.base/java.lang.Thread.run(Thread.java:840)\nCaused by: java.net.SocketException: Unexpected end of file from server\n    at java.base/sun.net.www.http.HttpClient.parseHTTPHeader(HttpClient.java:954)\n    at java.base/sun.net.www.http.HttpClient.parseHTTP(HttpClient.java:761)\n    at java.base/sun.net.www.http.HttpClient.parseHTTPHeader(HttpClient.java:951)\n    at java.base/sun.net.www.http.HttpClient.parseHTTP(HttpClient.java:761)\n    at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1725)\n    at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1626)\n    at java.base/java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:529)\n    at org.testcontainers.containers.wait.strategy.HttpWaitStrategy.lambda$null$6(HttpWaitStrategy.java:276)\n    ... 7 more\n\ncom.example.testcontainers.KafkaIntegrationTest -- Time elapsed: 9.166 s &lt;&lt;&lt; ERROR!\njava.lang.NoClassDefFoundError: Could not initialize class com.example.testcontainers.KafkaIntegrationTest\n    at java.base/java.lang.reflect.Method.invoke(Method.java:569)\n    at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\n    at java.base/java.util.Collections$UnmodifiableCollection.forEach(Collections.java:1092)\n    at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\nCaused by: java.lang.ExceptionInInitializerError: Exception org.testcontainers.containers.ContainerLaunchException: Container startup failed for image confluentinc/cp-schema-registry:7.5.1 [in thread &quot;main&quot;]\n    at org.testcontainers.containers.GenericContainer.doStart(GenericContainer.java:351)\n    at org.testcontainers.containers.GenericContainer.start(GenericContainer.java:322)\n    at com.example.testcontainers.KafkaIntegrationTest.&lt;clinit&gt;(KafkaIntegrationTest.java:58)\n    at java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:500)\n    at java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:481)\n    at java.base/java.util.Optional.orElseGet(Optional.java:364)\n    at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\n    ... 1 more\n\n</code></pre>\n<p>Complete code example available at <a href=\"https://github.com/AlexOreshkevich/cp-kafka-schema-registry-testcontainers\" rel=\"nofollow noreferrer\">https://github.com/AlexOreshkevich/cp-kafka-schema-registry-testcontainers</a></p>\n<p>I tried to use as a value for <code>SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS</code> many options, incl</p>\n<ul>\n<li><code>KAFKA_CONTAINER.getBootstrapServers()</code></li>\n<li><code>kafka:9092</code></li>\n<li><code>KAFKA_CONTAINER.getNetworkAliases().get(0) + &quot;:9092&quot;</code></li>\n</ul>\n<p>Also I tried to use latest Confluent Platform (<code>7.8.0</code>), same issues.</p>\n<p>I expect test to run successfully which means schema registry connected to kafka broker. After that I could proceed with producer/consumer config to test AVRO etc.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}