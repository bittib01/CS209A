{
  "question": {
    "tags": [
      "java",
      "hibernate",
      "gradle",
      "java-module"
    ],
    "owner": {
      "account_id": 258390,
      "reputation": 14679,
      "user_id": 540552,
      "user_type": "registered",
      "accept_rate": 86,
      "profile_image": "https://i.sstatic.net/ticHc.jpg?s=256",
      "display_name": "Victor Stafusa",
      "link": "https://stackoverflow.com/users/540552/victor-stafusa"
    },
    "is_answered": true,
    "view_count": 186,
    "answer_count": 1,
    "score": 2,
    "last_activity_date": 1754194013,
    "creation_date": 1729827493,
    "last_edit_date": 1729908117,
    "question_id": 79124196,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79124196/cant-run-hibernate-in-a-module-environment",
    "title": "Can&#39;t run Hibernate in a module environment",
    "body": "<h2>The problem</h2>\n<p>I'm having trouble trying to make Hibernate run in a project that have modules. I am trying to modernize an old tool that uses and old version of Hibernate with javax-based JPA and I am trying to migrate it to a newer version and make it jakarta-based.</p>\n<p>Long story short, it fails with <code>ExceptionInInitializerError</code> when trying to instantiate the <code>HibernatePersistenceProvider</code> class due to some module problem when handling JBoss Logging. The tool use the <code>HibernatePersistenceProvider</code> to call the <code>createContainerEntityManagerFactory</code> method.</p>\n<p>In order to isolate the problem, I built a MCVE.</p>\n<h2>MCVE</h2>\n<p>I'm using Gradle 8.10.2 and Java 23. All the other package versions are in the <code>gradle.build</code> file.</p>\n<p>This is the <code>build.gradle</code> file:</p>\n<pre class=\"lang-none prettyprint-override\"><code>plugins {\n    id(&quot;java-library&quot;)\n    id(&quot;project-report&quot;)\n}\n\ndescription = &quot;MCVE for a problem in Hibernate&quot;\ngroup = &quot;com.example&quot;\nversion = &quot;1.0&quot;\n\ndef artifactName = &quot;com.example&quot;\ndef moduleName = &quot;com.example&quot;\n\ndef versionApiguardian = &quot;1.1.2&quot;\ndef versionHibernate   = &quot;7.0.0.Beta1&quot;\ndef versionJakartaAnno = &quot;3.0.0&quot;\ndef versionJakartaCdi  = &quot;4.1.0&quot;\ndef versionJakartaEl   = &quot;6.0.1&quot;\ndef versionJakartaInj  = &quot;2.0.1&quot;\ndef versionJakartaInt  = &quot;2.2.0&quot;\ndef versionJakartaJpa  = &quot;3.2.0&quot;\ndef versionJakartaJta  = &quot;2.0.1&quot;\ndef versionJBossLog    = &quot;3.6.1.Final&quot;\ndef versionJunit       = &quot;5.11.2&quot;\ndef versionJunitPlatf  = &quot;1.11.2&quot;\n\ndependencies {\n\n    // Jakarta, JPA and friends.\n    testImplementation(group: &quot;jakarta.annotation&quot; , name: &quot;jakarta.annotation-api&quot;       , version: versionJakartaAnno)\n    testImplementation(group: &quot;jakarta.enterprise&quot; , name: &quot;jakarta.enterprise.cdi-api&quot;   , version: versionJakartaCdi )\n    testImplementation(group: &quot;jakarta.enterprise&quot; , name: &quot;jakarta.enterprise.lang-model&quot;, version: versionJakartaCdi )\n    testImplementation(group: &quot;jakarta.persistence&quot;, name: &quot;jakarta.persistence-api&quot;      , version: versionJakartaJpa )\n    testImplementation(group: &quot;jakarta.transaction&quot;, name: &quot;jakarta.transaction-api&quot;      , version: versionJakartaJta )\n    testImplementation(group: &quot;jakarta.inject&quot;     , name: &quot;jakarta.inject-api&quot;           , version: versionJakartaInj )\n    testImplementation(group: &quot;jakarta.interceptor&quot;, name: &quot;jakarta.interceptor-api&quot;      , version: versionJakartaInt )\n    testImplementation(group: &quot;jakarta.el&quot;         , name: &quot;jakarta.el-api&quot;               , version: versionJakartaEl  )\n\n    // JUnit.\n    testImplementation(group: &quot;org.junit.platform&quot;, name: &quot;junit-platform-launcher&quot;, version: versionJunitPlatf )\n    testImplementation(group: &quot;org.junit.jupiter&quot; , name: &quot;junit-jupiter-api&quot;      , version: versionJunit      )\n    testImplementation(group: &quot;org.junit.jupiter&quot; , name: &quot;junit-jupiter-params&quot;   , version: versionJunit      )\n    testImplementation(group: &quot;org.junit.jupiter&quot; , name: &quot;junit-jupiter-engine&quot;   , version: versionJunit      )\n    testImplementation(group: &quot;org.apiguardian&quot;   , name: &quot;apiguardian-api&quot;        , version: versionApiguardian)\n\n    // Hibernate.\n    testImplementation(group: &quot;org.hibernate.orm&quot;, name: &quot;hibernate-core&quot;, version: versionHibernate)\n\n    // JBoss Logging.\n    testImplementation(group: &quot;org.jboss.logging&quot;, name: &quot;jboss-logging&quot;, version: versionJBossLog)\n}\n\nrepositories {\n    mavenLocal()\n    mavenCentral()\n    gradlePluginPortal()\n}\n\ntasks.withType(JavaCompile) {\n    options.encoding = &quot;UTF-8&quot;\n    options.debug = true\n    options.fork = true\n    options.compilerArgs &lt;&lt; &quot;-parameters&quot;\n    doFirst {\n        options.compilerArgs += [\n            &quot;--module-path&quot;, classpath.asPath\n        ]\n        classpath = files()\n    }\n}\n\ntest {\n    useJUnitPlatform()\n    defaultCharacterEncoding = &quot;UTF-8&quot;\n    testLogging.showStandardStreams = true\n}\n</code></pre>\n<p>And, here is the <code>/src/test/java/module-info.java</code> file:</p>\n<pre class=\"lang-java prettyprint-override\"><code>open module com.example {\n    requires org.hibernate.orm.core;\n    requires jakarta.persistence;\n    requires org.junit.jupiter.api;\n}\n</code></pre>\n<p>And here is the <code>/src/test/java/com/example/SomeTest.java</code> file:</p>\n<pre class=\"lang-java prettyprint-override\"><code>package com.example;\n\nimport java.util.HashMap;\nimport org.hibernate.jpa.HibernatePersistenceProvider;\nimport org.junit.jupiter.api.Assertions;\nimport org.junit.jupiter.api.Test;\n\npublic class SomeTest {\n    @Test\n    public void testIt() {\n        // Instantiating the first parameter is difficult, so, test for NPE\n        // just to be sure we didn't got ExceptionInInitializerError.\n        NullPointerException npe = Assertions.assertThrows(\n                NullPointerException.class,\n                () -&gt; new HibernatePersistenceProvider().createContainerEntityManagerFactory(null, new HashMap&lt;&gt;())\n        );\n        Assertions.assertTrue(npe.getMessage().contains(&quot;getPersistenceUnitName()&quot;));\n    }\n}\n</code></pre>\n<p>Running that with this command line:</p>\n<pre class=\"lang-none prettyprint-override\"><code>gradle build --info\n</code></pre>\n<p>Will produce this inside all the output:</p>\n<pre class=\"lang-none prettyprint-override\"><code>SomeTest &gt; testIt() FAILED\n    org.opentest4j.AssertionFailedError: Unexpected exception type thrown, expected: &lt;java.lang.NullPointerException&gt; but was: &lt;java.lang.ExceptionInInitializerError&gt;\n        at app/org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.AssertionFailureBuilder.build(AssertionFailureBuilder.java:151)\n        at app/org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:67)\n        at app/org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:35)\n        at app/org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.Assertions.assertThrows(Assertions.java:3128)\n        at app/com.example/com.example.SomeTest.testIt(SomeTest.java:12)\n\n        Caused by:\n        java.lang.ExceptionInInitializerError\n            at com.example/com.example.SomeTest.lambda$testIt$0(SomeTest.java:13)\n            at org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:53)\n            ... 3 more\n\n            Caused by:\n            java.lang.IllegalArgumentException: This library does not have private access to interface org.hibernate.internal.EntityManagerMessageLogger\n                at org.jboss.logging@3.6.1.Final/org.jboss.logging.Logger.getMessageLogger(Logger.java:2572)\n                at org.jboss.logging@3.6.1.Final/org.jboss.logging.Logger.getMessageLogger(Logger.java:2552)\n                at org.hibernate.orm.core@7.0.0.Beta1/org.hibernate.internal.HEMLogging.messageLogger(HEMLogging.java:28)\n                at org.hibernate.orm.core@7.0.0.Beta1/org.hibernate.internal.HEMLogging.messageLogger(HEMLogging.java:24)\n                at org.hibernate.orm.core@7.0.0.Beta1/org.hibernate.jpa.HibernatePersistenceProvider.&lt;clinit&gt;(HibernatePersistenceProvider.java:42)\n                ... 5 more\n\n1 test completed, 1 failed\n</code></pre>\n<p>Trying to downgrade JBoss-Logging to <code>3.5.0.Final</code> (which is the version declared as a dependency for Hibernate <code>7.0.0.Beta1</code> accordingly to <a href=\"https://mvnrepository.com/artifact/org.hibernate.orm/hibernate-core/7.0.0.Beta1\" rel=\"nofollow noreferrer\">this</a>) will give a different error instead:</p>\n<pre class=\"lang-none prettyprint-override\"><code>SomeTest &gt; testIt() FAILED\n    org.opentest4j.AssertionFailedError: Unexpected exception type thrown, expected: &lt;java.lang.NullPointerException&gt; but was: &lt;java.lang.IllegalAccessError&gt;\n        at app/org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.AssertionFailureBuilder.build(AssertionFailureBuilder.java:151)\n        at app/org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:67)\n        at app/org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:35)\n        at app/org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.Assertions.assertThrows(Assertions.java:3128)\n        at app/com.example/com.example.SomeTest.testIt(SomeTest.java:13)\n\n        Caused by:\n        java.lang.IllegalAccessError: superclass access check failed: class org.jboss.logging.JBossLogRecord (in module org.jboss.logging) cannot access class java.util.logging.LogRecord (in module java.logging) because module org.jboss.logging does not read module java.logging\n            at java.base/java.lang.ClassLoader.defineClass1(Native Method)\n            at java.base/java.lang.ClassLoader.defineClass(ClassLoader.java:1026)\n            at java.base/java.lang.ClassLoader.defineClass(ClassLoader.java:1103)\n            at java.base/java.security.SecureClassLoader.defineClass(SecureClassLoader.java:182)\n            at java.base/jdk.internal.loader.BuiltinClassLoader.defineClass(BuiltinClassLoader.java:821)\n            at java.base/jdk.internal.loader.BuiltinClassLoader.findClassInModuleOrNull(BuiltinClassLoader.java:741)\n            at java.base/jdk.internal.loader.BuiltinClassLoader.loadClassOrNull(BuiltinClassLoader.java:665)\n            at java.base/jdk.internal.loader.BuiltinClassLoader.loadClass(BuiltinClassLoader.java:639)\n            at java.base/jdk.internal.loader.ClassLoaders$AppClassLoader.loadClass(ClassLoaders.java:188)\n            at java.base/java.lang.ClassLoader.loadClass(ClassLoader.java:528)\n            at org.jboss.logging@3.5.0.Final/org.jboss.logging.JDKLoggerProvider.getLogger(JDKLoggerProvider.java:29)\n            at org.jboss.logging@3.5.0.Final/org.jboss.logging.LoggerProviders.logProvider(LoggerProviders.java:150)\n            at org.jboss.logging@3.5.0.Final/org.jboss.logging.LoggerProviders.tryJDK(LoggerProviders.java:106)\n            at org.jboss.logging@3.5.0.Final/org.jboss.logging.LoggerProviders.findProvider(LoggerProviders.java:101)\n            at org.jboss.logging@3.5.0.Final/org.jboss.logging.LoggerProviders.find(LoggerProviders.java:32)\n            at org.jboss.logging@3.5.0.Final/org.jboss.logging.LoggerProviders.&lt;clinit&gt;(LoggerProviders.java:29)\n            at org.jboss.logging@3.5.0.Final/org.jboss.logging.Logger.getLogger(Logger.java:2465)\n            at org.jboss.logging@3.5.0.Final/org.jboss.logging.Logger.doGetMessageLogger(Logger.java:2573)\n            at org.jboss.logging@3.5.0.Final/org.jboss.logging.Logger.getMessageLogger(Logger.java:2530)\n            at org.jboss.logging@3.5.0.Final/org.jboss.logging.Logger.getMessageLogger(Logger.java:2516)\n            at org.hibernate.orm.core@7.0.0.Beta1/org.hibernate.internal.HEMLogging.messageLogger(HEMLogging.java:28)\n            at org.hibernate.orm.core@7.0.0.Beta1/org.hibernate.internal.HEMLogging.messageLogger(HEMLogging.java:24)\n            at org.hibernate.orm.core@7.0.0.Beta1/org.hibernate.jpa.HibernatePersistenceProvider.&lt;clinit&gt;(HibernatePersistenceProvider.java:42)\n            at com.example/com.example.SomeTest.lambda$testIt$0(SomeTest.java:15)\n            at org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:53)\n            ... 3 more\n\n1 test completed, 1 failed\n</code></pre>\n<p>Trying to downgrade Hibernate to <code>6.6.1.Final</code> either with JBoss Logging <code>3.5.0.Final</code> or <code>3.6.1.Final</code> doesn't work and gives very similar errors.</p>\n<p>The best case was with Hibernate <code>6.6.1.Final</code> and JBoss Logging <code>3.6.1.Final</code> when the error comes from the <code>createContainerEntityManagerFactory</code> method instead of the <code>HibernatePersistenceProvider</code> constructor:</p>\n<pre class=\"lang-none prettyprint-override\"><code>SomeTest &gt; testIt() FAILED\n    org.opentest4j.AssertionFailedError: Unexpected exception type thrown, expected: &lt;java.lang.NullPointerException&gt; but was: &lt;java.lang.ExceptionInInitializerError&gt;\n        at app/org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.AssertionFailureBuilder.build(AssertionFailureBuilder.java:151)\n        at app/org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:67)\n        at app/org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:35)\n        at app/org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.Assertions.assertThrows(Assertions.java:3128)\n        at app/com.example/com.example.SomeTest.testIt(SomeTest.java:13)\n\n        Caused by:\n        java.lang.ExceptionInInitializerError\n            at org.hibernate.orm.core@6.6.1.Final/org.hibernate.jpa.boot.spi.Bootstrap.getEntityManagerFactoryBuilder(Bootstrap.java:35)\n            at org.hibernate.orm.core@6.6.1.Final/org.hibernate.jpa.boot.spi.Bootstrap.getEntityManagerFactoryBuilder(Bootstrap.java:102)\n            at org.hibernate.orm.core@6.6.1.Final/org.hibernate.jpa.HibernatePersistenceProvider.getEntityManagerFactoryBuilder(HibernatePersistenceProvider.java:169)\n            at org.hibernate.orm.core@6.6.1.Final/org.hibernate.jpa.HibernatePersistenceProvider.createContainerEntityManagerFactory(HibernatePersistenceProvider.java:142)\n            at com.example/com.example.SomeTest.lambda$testIt$0(SomeTest.java:15)\n            at org.junit.jupiter.api@5.11.2/org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:53)\n            ... 3 more\n\n            Caused by:\n            java.lang.IllegalArgumentException: This library does not have private access to interface org.hibernate.internal.EntityManagerMessageLogger\n                at org.jboss.logging@3.6.1.Final/org.jboss.logging.Logger.getMessageLogger(Logger.java:2572)\n                at org.jboss.logging@3.6.1.Final/org.jboss.logging.Logger.getMessageLogger(Logger.java:2552)\n                at org.hibernate.orm.core@6.6.1.Final/org.hibernate.internal.HEMLogging.messageLogger(HEMLogging.java:28)\n                at org.hibernate.orm.core@6.6.1.Final/org.hibernate.internal.HEMLogging.messageLogger(HEMLogging.java:24)\n                at org.hibernate.orm.core@6.6.1.Final/org.hibernate.jpa.boot.internal.EntityManagerFactoryBuilderImpl.&lt;clinit&gt;(EntityManagerFactoryBuilderImpl.java:142)\n                ... 9 more\n\n1 test completed, 1 failed\n</code></pre>\n<h2>The workaround</h2>\n<p>As a proof of concept, if I sacrifice modularity, remove the <code>module-info.java</code> file and comment out the <code>doFirst</code> block in the <code>gradle.build</code> file, it works!</p>\n<p>However, I can't really sacrifice modularity in my environment.</p>\n<h2>My questions</h2>\n<ul>\n<li>Maybe I should add something to the <code>module-info.java</code> file?</li>\n<li>Or maybe I should change the version of some package?</li>\n<li>Or perhaps add some <code>--add-opens</code> command line options somewhere in <code>gradle.build</code>?</li>\n<li>Or should I avoid to ever directly instantiate <code>HibernatePersistenceProvider</code> and it was no more than an accident that this ever worked?</li>\n<li>Is this a bug in Hibernate?</li>\n</ul>\n<p>Or put simply:</p>\n<ul>\n<li>What I am doing wrong?</li>\n<li>How can I fix this?</li>\n<li>Any ideas?</li>\n</ul>\n<p>I tried a lot of things to fix this issue, and other than just throwing modularity out of the window, nothing worked so far.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}