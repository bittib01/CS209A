{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-boot",
      "thingsboard"
    ],
    "owner": {
      "account_id": 32515964,
      "reputation": 1,
      "user_id": 25262854,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/22d5b3f2c04a383979df4c564d47f113?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "the-tall-guy-avj",
      "link": "https://stackoverflow.com/users/25262854/the-tall-guy-avj"
    },
    "is_answered": false,
    "view_count": 100,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1729537808,
    "creation_date": 1720095578,
    "question_id": 78707078,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78707078/how-to-inject-configuration-from-spring-boot-yaml-into-thingsboard-custom-rule-n",
    "title": "How to Inject Configuration from Spring Boot YAML into ThingsBoard Custom Rule Node?",
    "body": "<p>I'm developing a custom rule node for ThingsBoard, and I need to configure various Kafka-related parameters through <strong>thingsboard.yml</strong> file. Instead of directly using <strong>@Value</strong> annotations, I want to read these values into a separate configuration class and then use its object in my custom rule node.</p>\n<p><strong>thingsboard.yml</strong></p>\n<pre><code>custom:\n  node.enabled: true\n  config:\n    bootstrap.server: localhost:9092\n    topic.pattern: custom-*\n    retries: 3\n    batch.size: 16384\n    linger.ms: 0\n    buffer.memory: 33554432\n</code></pre>\n<p><strong>CustomNodeConfig.java</strong></p>\n<pre><code>package com.example;\n\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.context.annotation.Configuration;\n\nimport lombok.Data;\n\n@Data\n@Configuration\npublic class CustomNodeConfig {\n\n     @Value(&quot;${custom.node.enabled}&quot;)\n    private boolean enabled;\n\n    @Value(&quot;${custom.config.bootstrap.server}&quot;)\n    private String bootstrapServers;\n\n    @Value(&quot;${custom.config.topic.pattern}&quot;)\n    private String topicPattern;\n\n    @Value(&quot;${custom.config.retries}&quot;)\n    private int retries;\n\n    @Value(&quot;${custom.config.batch.size}&quot;)\n    private int batchSize;\n\n    @Value(&quot;${custom.config.linger.ms}&quot;)\n    private int linger;\n\n    @Value(&quot;${custom.config.buffer.memory}&quot;)\n    private int bufferMemory;\n\n</code></pre>\n<p><strong>CustomNode.java</strong></p>\n<pre><code>package com.example;\n\nimport lombok.Data;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Component;\nimport org.thingsboard.rule.engine.api.*;\n\nimport javax.annotation.PostConstruct;\n\n@Slf4j\n@Data\n@RuleNode(\n    type = ComponentType.EXTERNAL,\n    name = &quot;Custom Node&quot;,\n    configClazz = CustomRuleNodeConfiguration.class,\n    nodeDescription = &quot;Publish messages to Kafka server&quot;,\n    nodeDetails = &quot;Outbound message will contain response fields from Kafka in the Message Metadata.&quot;,\n    uiResources = {&quot;static/rulenode/rulenode-core-config.js&quot;}\n)\n@Component\npublic class CustomNode implements TbNode {\n\n    @Autowired\n    private CustomNodeConfig kafkaConfig;\n\n    @PostConstruct\n    public void init() {\n        log.info(&quot;CustomRuleNode initialized with retries: {}, lingerMs: {}, bootstrapServers: {}, topicPattern: {}&quot;,\n                kafkaConfig.getRetries(), kafkaConfig.getLingerMs(), kafkaConfig.getBootstrapServers(), kafkaConfig.getTopicPattern());\n    }\n\n    @Override\n    public void init(TbNodeConfiguration configuration) throws TbNodeException \n        log.info(&quot;CustomRuleNode configuration initialized&quot;);\n    }\n\n    @Override\n    protected void onMsg(TbContext ctx, TbMsg msg) {\n        log.info(&quot;Received message: {}&quot;, msg.getData());\n    }\n\n    @Override\n    public void destroy() {\n        log.info(&quot;CustomRuleNode destroyed!&quot;);\n    }\n}\n\n</code></pre>\n<p>The above implementation did not work as expected, the node actor does not get initialized and throws the below exception after attempting 10 retries, as the Autowired variable is not initialized.</p>\n<pre><code>2024-07-04 11:36:03.060  INFO 356309 --- [-dispatcher-3-3] o.t.server.actors.TbActorMailbox         : [RULE_NODE|8ad08a10-39f8-11ef-8131-5d958a56f0d4] Failed to init actor, attempt 10, going to stop attempts.\n\norg.thingsboard.server.actors.TbActorException: Failed to init actor\n    at org.thingsboard.server.actors.service.ComponentActor.initProcessor(ComponentActor.java:72) ~[classes!/:3.5.1]\n    at org.thingsboard.server.actors.service.ComponentActor.init(ComponentActor.java:57) ~[classes!/:3.5.1]\n    at org.thingsboard.server.actors.TbActorMailbox.tryInit(TbActorMailbox.java:66) ~[actor-3.5.1.jar!/:3.5.1]\n    at org.thingsboard.server.actors.TbActorMailbox.lambda$tryInit$1(TbActorMailbox.java:85) ~[actor-3.5.1.jar!/:3.5.1]\n    at java.base/java.util.concurrent.ForkJoinTask$RunnableExecuteAction.exec(ForkJoinTask.java:1426) ~[na:na]\n    at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:290) ~[na:na]\n    at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1020) ~[na:na]\n    at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1656) ~[na:na]\n    at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1594) ~[na:na]\n    at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:183) ~[na:na]\nCaused by: java.lang.NullPointerException: null\n    at org.thingsboard.rule.engine.custom.CustomNode.init(CustomNode.java:92) ~[rule-engine-components-3.5.1.jar!/:3.5.1]\n    at org.thingsboard.server.actors.ruleChain.RuleNodeActorMessageProcessor.initComponent(RuleNodeActorMessageProcessor.java:173) ~[classes!/:3.5.1]\n    at org.thingsboard.server.actors.ruleChain.RuleNodeActorMessageProcessor.start(RuleNodeActorMessageProcessor.java:64) ~[classes!/:3.5.1]\n    at org.thingsboard.server.actors.service.ComponentActor.initProcessor(ComponentActor.java:63) ~[classes!/:3.5.1]\n    ... 9 common frames omitted\n</code></pre>\n<p><strong>Questions</strong></p>\n<ol>\n<li>Is there a better or more standard approach to manage configuration for a custom rule node in ThingsBoard using Spring Boot?</li>\n<li>Is my approach of using a separate configuration class (CustomNodeConfig) and autowiring it into the rule node (CustomNode) correct for injecting configuration values from application.yml?</li>\n</ol>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}