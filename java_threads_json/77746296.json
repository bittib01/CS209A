{
  "question": {
    "tags": [
      "java",
      "spring-webflux",
      "reactor-netty"
    ],
    "owner": {
      "account_id": 30253697,
      "reputation": 11,
      "user_id": 23185329,
      "user_type": "registered",
      "profile_image": "https://lh3.googleusercontent.com/a/ACg8ocJZo4X_EAXDXkcUvzsiNd1sSnDE9roDQHHp-JjHLHOOLA=k-s256",
      "display_name": "Ayesha Niazi",
      "link": "https://stackoverflow.com/users/23185329/ayesha-niazi"
    },
    "is_answered": false,
    "view_count": 381,
    "answer_count": 0,
    "score": 1,
    "last_activity_date": 1715826982,
    "creation_date": 1704201040,
    "last_edit_date": 1704296444,
    "question_id": 77746296,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/77746296/illegalreferencecountexception-after-upgrading-spring-boot-and-java-version",
    "title": "IllegalReferenceCountException after upgrading Spring Boot and Java version",
    "body": "<p>We are seeing below errors intermittently while calling APIs from our service. The issue is happening only during load testing -\nError was received while reading the incoming data. The connection will be closed.</p>\n<pre><code>2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] io.netty.util.IllegalReferenceCountException: refCnt: 0, decrement: 1\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.util.internal.ReferenceCountUpdater.toLiveRealRefCnt(ReferenceCountUpdater.java:83)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.util.internal.ReferenceCountUpdater.release(ReferenceCountUpdater.java:147)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.buffer.AbstractReferenceCountedByteBuf.release(AbstractReferenceCountedByteBuf.java:101)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.handler.codec.http.DefaultHttpContent.release(DefaultHttpContent.java:92)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.util.ReferenceCountUtil.release(ReferenceCountUtil.java:90)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at reactor.netty.channel.FluxReceive.onInboundNext(FluxReceive.java:380)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at reactor.netty.channel.ChannelOperations.onInboundNext(ChannelOperations.java:411)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at reactor.netty.http.client.HttpClientOperations.onInboundNext(HttpClientOperations.java:734)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at reactor.netty.channel.ChannelOperationsHandler.channelRead(ChannelOperationsHandler.java:114)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:103)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.CombinedChannelDuplexHandler$DelegatingChannelHandlerContext.fireChannelRead(CombinedChannelDuplexHandler.java:436)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:346)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:333)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:454)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.CombinedChannelDuplexHandler.channelRead(CombinedChannelDuplexHandler.java:251)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:442)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.handler.ssl.SslHandler.unwrap(SslHandler.java:1382)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.handler.ssl.SslHandler.decodeNonJdkCompatible(SslHandler.java:1256)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.handler.ssl.SslHandler.decode(SslHandler.java:1296)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:529)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:468)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)\n2023-11-29T12:07:17.968+05:30 [APP/PROC/WEB/25] [OUT] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at reactor.core.publisher.Operators$BaseFluxToMonoOperator.onSubscribe(Operators.java:1988)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at reactor.core.publisher.FluxMap$MapSubscriber.onSubscribe(FluxMap.java:92)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at reactor.core.publisher.FluxPeek$PeekSubscriber.onSubscribe(FluxPeek.java:171)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at reactor.core.publisher.FluxMap$MapSubscriber.onSubscribe(FluxMap.java:92)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at reactor.netty.channel.FluxReceive.startReceiver(FluxReceive.java:170)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at reactor.netty.channel.FluxReceive.lambda$subscribe$2(FluxReceive.java:148)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:174)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:167)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:403)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n2023-11-29T12:07:45.403+05:30 [APP/PROC/WEB/18] [OUT] at java.base/java.lang.Thread.run(Unknown Source)\n</code></pre>\n<p>The issue started appearing after we have upgraded spring boot version to 3.0.3 and java version to 17 from java 8.</p>\n<p>We have tried to increase the buffer size using application.properties file as well as by using ExchangeStrategies. After increasing the buffer size we see a reduction in frequency of error, but error is still persisting intermittently-</p>\n<p><code>spring.codec.max-in-memory-size: 20MB</code></p>\n<pre class=\"lang-java prettyprint-override\"><code>WebClient.builder()\n                .exchangeStrategies(ExchangeStrategies.builder()\n                        .codecs(configurer -&gt; configurer.defaultCodecs().maxInMemorySize(MAX_BUFFER_SIZE))\n                        .build())\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}