{
  "question": {
    "tags": [
      "java",
      "spring",
      "amazon-s3"
    ],
    "owner": {
      "account_id": 15881591,
      "reputation": 512,
      "user_id": 11459205,
      "user_type": "registered",
      "profile_image": "https://lh6.googleusercontent.com/-p4Uue6t2NUg/AAAAAAAAAAI/AAAAAAAAAvc/0re0WeLrMvU/s256-rj/photo.jpg",
      "display_name": "paymer",
      "link": "https://stackoverflow.com/users/11459205/paymer"
    },
    "is_answered": true,
    "view_count": 148,
    "accepted_answer_id": 79345934,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1736517224,
    "creation_date": 1733329807,
    "last_edit_date": 1733387154,
    "question_id": 79251990,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79251990/issues-processing-a-large-csv-file-from-s3-in-java",
    "title": "Issues Processing a Large CSV File from S3 in Java",
    "body": "<p>I am trying to retrieve and process a large CSV file (130,000 KB) from Amazon S3, but the processing takes over an hour, and at a certain point, an error occurs.</p>\n<p>The code I use to retrieve the file is as follows:</p>\n<pre><code>   try (Reader reader = new InputStreamReader(s3ServiceStock.getObject(key).getObjectContent(), StandardCharsets.UTF_8);\n              CSVReader csvReader = new CSVReaderBuilder(reader).withCSVParser(parser).build()) {\n\n         importContent(csvReader )\n\n        } catch (Exception e) {\n            log.error(&quot;Error&quot;, e);\n        }\n}\n\n</code></pre>\n<p>The importContent method looks like this:</p>\n<pre><code>private void importContent(CSVReader csvReader) throws IOException {\n\n        String[] nextRecord;\n        while ((nextRecord = csvReader.readNext()) != null) {\n\n          ...//some treatment\n\n         repository.save(entity);\n       }\n\n}\n\n</code></pre>\n<p>However, at some point during the process, I encounter the following error, which seems to occur on different lines of the CSV file:</p>\n<pre><code>org.apache.http.ConnectionClosedException: Premature end of Content-Length delimited message body (expected: 130,272,542; received: 22,061,056)\n    at org.apache.http.impl.io.ContentLengthInputStream.read(ContentLengthInputStream.java:178) ~[httpcore-4.4.11.jar:4.4.11]\n    at org.apache.http.conn.EofSensorInputStream.read(EofSensorInputStream.java:135) ~[httpclient-4.5.9.jar:4.5.9]\n    at com.amazonaws.internal.SdkFilterInputStream.read(SdkFilterInputStream.java:90) ~[aws-java-sdk-core-1.11.604.jar:na]\n    at com.amazonaws.event.ProgressInputStream.read(ProgressInputStream.java:180) ~[aws-java-sdk-core-1.11.604.jar:na]\n    at com.amazonaws.internal.SdkFilterInputStream.read(SdkFilterInputStream.java:90) ~[aws-java-sdk-core-1.11.604.jar:na]\n    at com.amazonaws.internal.SdkFilterInputStream.read(SdkFilterInputStream.java:90) ~[aws-java-sdk-core-1.11.604.jar:na]\n    at com.amazonaws.internal.SdkFilterInputStream.read(SdkFilterInputStream.java:90) ~[aws-java-sdk-core-1.11.604.jar:na]\n    at com.amazonaws.event.ProgressInputStream.read(ProgressInputStream.java:180) ~[aws-java-sdk-core-1.11.604.jar:na]\n    at com.amazonaws.internal.SdkFilterInputStream.read(SdkFilterInputStream.java:90) ~[aws-java-sdk-core-1.11.604.jar:na]\n    at com.amazonaws.util.LengthCheckInputStream.read(LengthCheckInputStream.java:107) ~[aws-java-sdk-core-1.11.604.jar:na]\n    at com.amazonaws.internal.SdkFilterInputStream.read(SdkFilterInputStream.java:90) ~[aws-java-sdk-core-1.11.604.jar:na]\n    at com.amazonaws.services.s3.internal.S3AbortableInputStream.read(S3AbortableInputStream.java:125) ~[aws-java-sdk-s3-1.11.604.jar:na]\n    at com.amazonaws.internal.SdkFilterInputStream.read(SdkFilterInputStream.java:90) ~[aws-java-sdk-core-1.11.604.jar:na]\n    at java.base/sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:284) ~[na:na]\n    at java.base/sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:326) ~[na:na]\n    at java.base/sun.nio.cs.StreamDecoder.read(StreamDecoder.java:178) ~[na:na]\n    at java.base/java.io.InputStreamReader.read(InputStreamReader.java:181) ~[na:na]\n    at java.base/java.io.BufferedReader.fill(BufferedReader.java:161) ~[na:na]\n    at java.base/java.io.BufferedReader.readLine(BufferedReader.java:326) ~[na:na]\n    at java.base/java.io.BufferedReader.readLine(BufferedReader.java:392) ~[na:na]\n    at com.opencsv.stream.reader.LineReader.readLine(LineReader.java:41) ~[opencsv-4.6.jar:na]\n    at com.opencsv.CSVReader.getNextLine(CSVReader.java:436) ~[opencsv-4.6.jar:na]\n    at com.opencsv.CSVReader.readNext(CSVReader.java:351) ~[opencsv-4.6.jar:na]\n    at ...\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:na]\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:na]\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:na]\n    at java.base/java.lang.reflect.Method.invoke(Method.java:566) ~[na:na]\n    at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:343) ~[spring-aop-5.1.8.RELEASE.jar:5.1.8.RELEASE]\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:198) ~[spring-aop-5.1.8.RELEASE.jar:5.1.8.RELEASE]\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163) ~[spring-aop-5.1.8.RELEASE.jar:5.1.8.RELEASE]\n    at org.springframework.aop.interceptor.AsyncExecutionInterceptor.lambda$invoke$0(AsyncExecutionInterceptor.java:115) ~[spring-aop-5.1.8.RELEASE.jar:5.1.8.RELEASE]\n    at java.base/java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:264) ~[na:na]\n    at java.base/java.util.concurrent.FutureTask.run(FutureTask.java) ~[na:na]\n    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[na:na]\n    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[na:na]\n</code></pre>\n<p>This error points to the line where <code>((nextRecord = csvReader.readNext()) != null) {</code> is called in the importContent method.</p>\n<p>I thought the issue might be that maintaining the connection to the S3 repository for such a long time was causing the error. Therefore, I tried using TransferManager to download the file:</p>\n<pre><code>@Override\n    public void downloadFileWithTransferManager(String key, String downloadFilePath){\n        TransferManager transferManager = TransferManagerBuilder.standard()\n                .withS3Client(s3)\n                .withExecutorFactory(() -&gt; Executors.newFixedThreadPool(5))\n                .withMinimumUploadPartSize(Long.valueOf(5L * 1024 * 1024)) // Tamaño mínimo por parte\n                .withMultipartUploadThreshold(Long.valueOf(10L * 1024 * 1024)) // Umbral para multipart uploads\n                .build();\n        Download download = transferManager.download(bucketName, key, new File(downloadFilePath));\n        try{\n            download.waitForCompletion();\n        } catch (Exception e) {\n            LOG.log(Level.FINER, e.getMessage());\n        }finally {\n            transferManager.shutdownNow();\n        }\n    }\n</code></pre>\n<p>However, when I reach the <em>download</em> method, I get a 400 Bad Request error.</p>\n<p>Does anyone know how I can efficiently retrieve the entire file from S3 without errors? I appreciate any help or suggestions.</p>\n<p>Thank you!</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}