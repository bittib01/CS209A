{
  "question": {
    "tags": [
      "java",
      "spring-security"
    ],
    "owner": {
      "account_id": 39519974,
      "reputation": 1,
      "user_id": 29317719,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/91cb55d560c5a98eb56a8e56ebeb7ad0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "osalazard",
      "link": "https://stackoverflow.com/users/29317719/osalazard"
    },
    "is_answered": false,
    "view_count": 39,
    "answer_count": 0,
    "score": 0,
    "last_activity_date": 1737625554,
    "creation_date": 1737596102,
    "last_edit_date": 1737625554,
    "question_id": 79379606,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79379606/handle-idp-response-with-crypted-assertion-when-the-response-is-not-signed",
    "title": "Handle IDP response with crypted assertion when the response is not signed",
    "body": "<p>I migrated an application from <code>spring-security-saml2-core:1.0.10.RELEASE</code> to <code>spring-securiy:5.8.12</code> for an application I maintain. It uses SAML2 authentication.</p>\n<p>Since the migration, one of our client fails to authenticate with the following error : <code>Did not decrypt response [_c1dfeab7-...] since it is not signed</code>\nAll I know is that they use a Windows ADFS server as IDP. There is no way to have access to the configuration of the IDP server, let alone suggesting any changes.\nI installed an ADFS Windows Server and was able to reproduce the problem by configuring the ADFS server with :</p>\n<ul>\n<li>EncryptClaims = true</li>\n<li>SamlResponseSignature = AssertionOnly</li>\n</ul>\n<p>With this configuration, the <code>process(Saml2AuthenticationToken, Response)</code> method of <code>OpenSaml4AuthenticationProvider</code> produces the same &quot;invalid_signature&quot; error.</p>\n<p>How can I can configure spring security to decrypt assertions when no Signature is provided ?</p>\n<p>I searched the spring-security documentation to find a way of ignoring the lack of a message signature, but without success.\nIf possible, I would prefer this to be configured by IDP (perhaps in <code>RelyingPartyRegistrationRepository</code>).</p>\n<p>[Sorry if this question seems oddly worded. It was marked as spam and I had to change it a bit.]</p>\n<p>Here is a example of response :</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;samlp:Response xmlns:samlp=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;\n                ID=&quot;_690a8d61-5c61-4acb-acdb-db3e82a7ce92&quot;\n                Version=&quot;2.0&quot;\n                IssueInstant=&quot;2025-01-22T15:18:44.829Z&quot;\n                Destination=&quot;https://localhost:9753/test/saml/SSO&quot;\n                Consent=&quot;urn:oasis:names:tc:SAML:2.0:consent:unspecified&quot;\n                InResponseTo=&quot;ARQe72b901-d161-400e-ac5b-168f5d312dc3&quot;\n                &gt;\n    &lt;Issuer xmlns=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;&gt;http://addc.test.fr/adfs/services/trust&lt;/Issuer&gt;\n    &lt;samlp:Status&gt;\n        &lt;samlp:StatusCode Value=&quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot; /&gt;\n    &lt;/samlp:Status&gt;\n    &lt;EncryptedAssertion xmlns=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;&gt;\n        &lt;xenc:EncryptedData xmlns:xenc=&quot;http://www.w3.org/2001/04/xmlenc#&quot;\n                            Type=&quot;http://www.w3.org/2001/04/xmlenc#Element&quot;\n                            &gt;\n            &lt;xenc:EncryptionMethod Algorithm=&quot;http://www.w3.org/2001/04/xmlenc#aes256-cbc&quot; /&gt;\n            &lt;KeyInfo xmlns=&quot;http://www.w3.org/2000/09/xmldsig#&quot;&gt;\n                &lt;e:EncryptedKey xmlns:e=&quot;http://www.w3.org/2001/04/xmlenc#&quot;&gt;\n                    &lt;e:EncryptionMethod Algorithm=&quot;http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p&quot;&gt;\n                        &lt;DigestMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#sha1&quot; /&gt;\n                    &lt;/e:EncryptionMethod&gt;\n                    &lt;KeyInfo&gt;\n                        &lt;ds:X509Data xmlns:ds=&quot;http://www.w3.org/2000/09/xmldsig#&quot;&gt;\n                            &lt;ds:X509IssuerSerial&gt;\n                                &lt;ds:X509IssuerName&gt;CN=TEST, OU=R&amp;D, O=TEST, L=Paris, S=Ile de France, C=FR&lt;/ds:X509IssuerName&gt;\n                                &lt;ds:X509SerialNumber&gt;714581089042...6570464337&lt;/ds:X509SerialNumber&gt;\n                            &lt;/ds:X509IssuerSerial&gt;\n                        &lt;/ds:X509Data&gt;\n                    &lt;/KeyInfo&gt;\n                    &lt;e:CipherData&gt;\n                        &lt;e:CipherValue&gt;MgQhfc0+Lm...KHU8GfnLFDfHQ==&lt;/e:CipherValue&gt;\n                    &lt;/e:CipherData&gt;\n                &lt;/e:EncryptedKey&gt;\n            &lt;/KeyInfo&gt;\n            &lt;xenc:CipherData&gt;\n                &lt;xenc:CipherValue&gt;pD7c6tN8g1...fkYzLjl6Q==&lt;/xenc:CipherValue&gt;\n            &lt;/xenc:CipherData&gt;\n        &lt;/xenc:EncryptedData&gt;\n    &lt;/EncryptedAssertion&gt;\n&lt;/samlp:Response&gt;\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}