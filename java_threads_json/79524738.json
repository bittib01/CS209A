{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "gmail-api"
    ],
    "owner": {
      "account_id": 26086173,
      "reputation": 1,
      "user_id": 19783678,
      "user_type": "registered",
      "profile_image": "https://lh3.googleusercontent.com/a-/AFdZucr8NwgAo0VJnPaogLhxtbxJ-AEFcVn8l7VU2RJs=k-s256",
      "display_name": "Lemon03",
      "link": "https://stackoverflow.com/users/19783678/lemon03"
    },
    "is_answered": false,
    "view_count": 86,
    "answer_count": 0,
    "score": 0,
    "last_activity_date": 1742540117,
    "creation_date": 1742540117,
    "question_id": 79524738,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79524738/having-problem-using-gmail-api-there-something-wrong-with-gmail-buidler-i-thi",
    "title": "having problem using gmail-api ,There something wrong with Gmail.buidler , i think i&#39;m adding credentials wrong way",
    "body": "<p>so this is my first project in spring boot (noob) , i wanted to created this gmail sending service, i got code from some <a href=\"https://github.dev/DavidRFerreira/GmailAPIClientSpringBoot\" rel=\"nofollow noreferrer\">repository</a> but it's not working , i saw official documents , but they are passing credentials through json file , here i'm passing this credentials as object but it's now working , i used chatgpt and still no</p>\n<p>can any one tell what i'm doing wrong</p>\n<p>also i tried debugging, access token is generating , and credential object also generating but when Gmail.Builder line execute it just stop there , do nothing , no error and nothing just stop execution</p>\n<pre><code>@Data\n@Service\npublic class GmailService {\n\n    private static final JsonFactory JSON_FACTORY = GsonFactory.getDefaultInstance();\n    private HttpTransport httpTransport;\n    private GmailCredential gmailCredential;\n    @Value(&quot;${spring.security.oauth2.client.registration.google.client-id}&quot;)\n    private String clientId;\n    @Value(&quot;${spring.security.oauth2.client.registration.google.client-secret}&quot;)\n    private String secretKey;\n    private String refreshToken;\n    private String fromEmail;\n    private String toEmail;\n\n\n    @SneakyThrows\n    public GmailService() {\n\n        this.httpTransport = GoogleNetHttpTransport.newTrustedTransport();\n\n        this.gmailCredential = new GmailCredential(\n                clientId,\n                secretKey,\n                refreshToken,\n                null,\n                null,\n                fromEmail\n        );\n\n    }\n\n    public boolean sendMessage(\n            String subject,\n            String body,\n            MultipartFile attachment) throws MessagingException, IOException {\n\n        refreshAccessToken();\n\n        Message message = createMessageWithEmail(\n                createEmail(toEmail, gmailCredential.userEmail(), subject, body));\n\n        return createGmail()\n                .users()\n                .messages()\n                .send(gmailCredential.userEmail(), message)\n                .execute()\n                .getLabelIds()\n                .contains(&quot;SENT&quot;);\n\n    }\n\n    private Gmail createGmail() {\n\n        TokenResponse tokenResponse = refreshAccessToken();\n        Credential credential = authorize();\n//        // Create GoogleCredential from the TokenResponse\n//        GoogleCredential credential = new GoogleCredential.Builder()\n//                .setTransport(httpTransport)\n//                .setJsonFactory(JSON_FACTORY)\n//                .setClientSecrets(clientId, secretKey)\n//                .build()\n//                .setAccessToken(tokenResponse.getAccessToken());\n\n        return new Gmail.Builder(httpTransport, JSON_FACTORY, credential)\n                .build();\n\n    }\n\n    private MimeMessage createEmail(\n            String to,\n            String from,\n            String subject,\n            String bodyText) throws MessagingException {\n\n        MimeMessage email = new MimeMessage(Session.getDefaultInstance(new Properties(), null));\n\n        email.setFrom(new InternetAddress(from));\n\n        email.addRecipient(javax.mail.Message.RecipientType.TO, new InternetAddress(to));\n\n        email.setSubject(subject);\n\n        email.setText(bodyText);\n\n        return email;\n\n    }\n\n\n    private Message createMessageWithEmail(MimeMessage emailContent)\n            throws MessagingException, IOException {\n\n        ByteArrayOutputStream buffer = new ByteArrayOutputStream();\n        emailContent.writeTo(buffer);\n\n        return new Message()\n                .setRaw(Base64.encodeBase64URLSafeString(buffer.toByteArray()));\n    }\n\n    private Credential authorize() {\n\n        try {\n\n            TokenResponse tokenResponse = refreshAccessToken();\n\n            return new Credential(BearerToken.authorizationHeaderAccessMethod()).setFromTokenResponse(\n                    tokenResponse);\n\n        } catch (Exception e) {\n\n            throw new ResponseStatusException(HttpStatus.BAD_REQUEST,\n                    &quot;Not able to process request.&quot;);\n\n        }\n\n    }\n\n    private TokenResponse refreshAccessToken() {\n\n        RestTemplate restTemplate = new RestTemplate();\n\n        GmailCredential gmailCredentialsDto = new GmailCredential(\n                clientId,\n                secretKey,\n                refreshToken,\n                &quot;refresh_token&quot;,\n                null,\n                null\n        );\n\n        HttpEntity&lt;GmailCredential&gt; entity = new HttpEntity(gmailCredentialsDto);\n\n        try {\n\n            GoogleTokenResponse response = restTemplate.postForObject(\n                    &quot;https://www.googleapis.com/oauth2/v4/token&quot;,\n                    entity,\n                    GoogleTokenResponse.class);\n            System.out.println(&quot;request sucess234wefull &quot;);\n\n            gmailCredential = new GmailCredential(\n                    clientId,\n                    secretKey,\n                    refreshToken,\n                    null,\n                    response.getAccessToken(),\n                    fromEmail\n            );\n            System.out.println(&quot;request sucessfull &quot;);\n            return response;\n\n        } catch (Exception e) {\n\n            e.printStackTrace();\n\n            throw new ResponseStatusException(HttpStatus.BAD_REQUEST,\n                    &quot;Not able to process request.&quot;);\n\n        }\n    }\n\n}\n\n\n</code></pre>\n<pre><code>package com.lemon.worker.utils;\n\nimport lombok.Data;\n\nimport javax.annotation.Nullable;\n\npublic record GmailCredential(\n        @Nullable\n        String client_id,\n        @Nullable\n        String client_secret,\n        @Nullable\n        String refresh_token,\n        @Nullable\n        String grant_type,\n        @Nullable\n        String access_token,\n        @Nullable\n        String userEmail\n) {\n\n        public String getAccessToken() {\n                return &quot;something&quot;;\n        }\n}\n</code></pre>\n<pre><code>package com.lemon.worker.utils;\n\n\nimport com.google.api.client.auth.oauth2.TokenResponse;\nimport com.google.api.client.util.Key;\n\npublic class GoogleTokenResponse extends TokenResponse {\n\n    @Key(&quot;expires_in&quot;)\n    private Integer expiresInSeconds;\n}\n\n\n</code></pre>\n<p>this error is thrown in dubug mode when Builder line executed-&gt;  throw ex.getTargetException();</p>\n<pre><code>    @Nullable\n    public static Object invokeJoinpointUsingReflection(@Nullable Object target, Method method, Object[] args) throws Throwable {\n        try {\n            Method originalMethod = BridgeMethodResolver.findBridgedMethod(method);\n            ReflectionUtils.makeAccessible(originalMethod);\n            return coroutinesReactorPresent &amp;&amp; KotlinDetector.isSuspendingFunction(originalMethod) ? AopUtils.KotlinDelegate.invokeSuspendingFunction(originalMethod, target, args) : originalMethod.invoke(target, args);\n        } catch (InvocationTargetException ex) {\n            throw ex.getTargetException(); // &lt;----- this exception is thrown \n        } catch (IllegalArgumentException ex) {\n            throw new AopInvocationException(&quot;AOP configuration seems to be invalid: tried calling method [&quot; + String.valueOf(method) + &quot;] on target [&quot; + String.valueOf(target) + &quot;]&quot;, ex);\n        } catch (IllegalAccessException ex) {\n            throw new AopInvocationException(&quot;Could not access method [&quot; + String.valueOf(method) + &quot;]&quot;, ex);\n        }\n    }\n\n</code></pre>\n<p>one thing i like to mention that access is getting generate also is in Credential\n<a href=\"https://i.sstatic.net/cwikeULg.png\" rel=\"nofollow noreferrer\">credential</a></p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}