{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "sftp"
    ],
    "owner": {
      "account_id": 3395858,
      "reputation": 99,
      "user_id": 2849501,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/2fbe5927a717ee6d9b8d77c4da46821e?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "pri05",
      "link": "https://stackoverflow.com/users/2849501/pri05"
    },
    "is_answered": false,
    "view_count": 24,
    "answer_count": 0,
    "score": 0,
    "last_activity_date": 1742477995,
    "creation_date": 1742477995,
    "question_id": 79523131,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79523131/sftp-dynamic-session-factory-message-handler",
    "title": "SFTP Dynamic session factory message handler",
    "body": "<p>I'm trying to upload files to multiple SFTP server locations based on the request. I read the sftp connection details from database and create a session factory, that is stored in a map of session factories based on a key. Now, when I try to create messagehandler for the same, I need to create a dynamic message handler with session factory created and stored in the map. I'm not sure how to dynamically use that map and messagehandler. Couldn't find enough source. I have given my code below. I would like to know which is the best approach for this. I did see spring integration flows, but I couldn't get how to use that dynamically. Can someone please help on this?</p>\n<p>Message builder</p>\n<pre><code>public class SFTPService {\n   \n   private final MessageChannel uploadEmployerSftpChannel;\n   \n   @Retryable(\n            retryFor = { MessagingException.class, IOException.class },\n            backoff = @Backoff(delay = 5000)\n    )\n    public void uploadFromSftpConnection(@NonNull final SftpConnection sftpConnection,\n                                         @NonNull final Resource file,\n                                         @NonNull final String groupId) throws IOException {\n        if (UploadEnabled) {\n            log.info(&quot;Uploading file {} to server via InputStream with sftpRemoteDir header: {}&quot;, file.getFilename(), sftpConnection.getRemoteDirectory());\n\n            final Message&lt;InputStream&gt; message = MessageBuilder.withPayload(file.getInputStream())\n                    .setHeader(SFTP_REMOTE_DIR, sftpConnection.getRemoteDirectory())\n                    .setHeader(FILE_NAME, file.getFilename())\n                    .setHeader(GROUP_ID, groupId)\n                    .build();\n            uploadEmployerSftpChannel.send(message);\n            log.info(&quot;File successfully uploaded to client server path: {}&quot;, sftpConnection.getRemoteDirectory());\n        } else {\n            log.info(&quot;upload is disabled. Skipping upload of file {} to client server.&quot;, file.getFilename());\n        }\n    }\n}\n</code></pre>\n<p>SFTP Message handler</p>\n<pre><code>@RequiredArgsConstructor\n@Configuration\npublic class SftpRuntimeSessionFactoryLocator {\n\n    private final Map&lt;Object, SessionFactory&lt;SftpClient.DirEntry&gt;&gt; sftpSessionFactoryMap = new HashMap&lt;&gt;();\n    private final SftpConnectionService sftpConnectionService;\n\n    public SessionFactory getSessionFactory(final Object groupId) {\n        if (!sftpSessionFactoryMap.containsKey(groupId)) {\n            sftpSessionFactoryMap.put(groupId, generateSessionFactory(groupId.toString()));\n        }\n        return sftpSessionFactoryMap.get(groupId);\n    }\n\n    public SessionFactory&lt;SftpClient.DirEntry&gt; generateSessionFactory(final String key) {\n        //get sftp connection details from database\n        final SftpConnection sftpConnection = getSftpConnection(key);\n\n        final DefaultSftpSessionFactory factory = new DefaultSftpSessionFactory(true);\n        factory.setHost(sftpConnection.getHost());\n        factory.setPort(sftpConnection.getPort());\n        factory.setPassword(sftpConnection.getPassword());\n        factory.setUser(sftpConnection.getUser());\n        factory.setAllowUnknownKeys(sftpConnection.isAllowUnknownKeys());\n        return new CachingSessionFactory&lt;&gt;(factory);\n    }\n\n    private SftpConnection getSftpConnection(final String groupId) {\n        return sftpConnectionService.getSFtpConnectionDetailsByGroupId(groupId);\n    }\n\n    @Bean\n    public MessageChannel uploadEmployerSftpChannel() {\n        return new DirectChannel();\n    }\n\n    @ServiceActivator(inputChannel = &quot;uploadEmployerSftpChannel&quot;)\n    public MessageHandler dynamicSftpMessageHandler() {\n        return message -&gt; {\n            final SessionFactory sftpSessionFactory = getSessionFactory(message.getHeaders().get(&quot;groupId&quot;));\n\n            final SftpMessageHandler handler = new SftpMessageHandler(sftpSessionFactory);\n            handler.setUseTemporaryFileName(false);\n\n            handler.setRemoteDirectoryExpression(new FunctionExpression&lt;Message&lt;?&gt;&gt;(msg\n                    -&gt; msg.getHeaders().get(&quot;sftpRemoteDir&quot;, String.class)\n            ));\n\n            handler.setFileNameGenerator(msg -&gt; {\n                if (msg.getHeaders().containsKey(&quot;filename&quot;)) {\n                    return msg.getHeaders().get(&quot;filename&quot;, String.class);\n                }\n                if (msg.getPayload() instanceof File) {\n                    return ((File) msg.getPayload()).getName();\n                }\n                throw new IllegalArgumentException(&quot;filename not provided for SFTP Message&quot;);\n            });\n        };\n    }\n}\n</code></pre>\n<p>When I try to connect, I get error saying</p>\n<pre><code>Caused by: org.springframework.messaging.MessageHandlingException: error occurred in message handler [ServiceActivator for [org.springframework.integration.handler.MethodInvokingMessageProcessor@1b030042] (sftpRuntimeSessionFactoryLocator.dynamicSftpMessageHandler.serviceActivator)], failedMessage=GenericMessage [payload=sun.nio.ch.ChannelInputStream@378c9b97, headers={sftpRemoteDir=/target/outbound, filename=testfile.txt, id=aa6242a1-fce3-6ad4-c239-04131046f456, groupId=789, timestamp=1742477124410}]\n    at org.springframework.integration.support.utils.IntegrationUtils.wrapInHandlingExceptionIfNecessary(IntegrationUtils.java:191)\n    at org.springframework.integration.handler.AbstractMessageHandler.doHandleMessage(AbstractMessageHandler.java:108)\n    at org.springframework.integration.handler.AbstractMessageHandler.handleWithMetrics(AbstractMessageHandler.java:90)\n    at org.springframework.integration.handler.AbstractMessageHandler.handleMessage(AbstractMessageHandler.java:70)\n    at org.springframework.integration.dispatcher.AbstractDispatcher.tryOptimizedDispatch(AbstractDispatcher.java:132)\n    at org.springframework.integration.dispatcher.UnicastingDispatcher.doDispatch(UnicastingDispatcher.java:148)\n    at org.springframework.integration.dispatcher.UnicastingDispatcher.dispatch(UnicastingDispatcher.java:121)\n    at org.springframework.integration.channel.AbstractSubscribableChannel.doSend(AbstractSubscribableChannel.java:72)\n    at org.springframework.integration.channel.AbstractMessageChannel.sendInternal(AbstractMessageChannel.java:390)\n    at org.springframework.integration.channel.AbstractMessageChannel.sendWithMetrics(AbstractMessageChannel.java:361)\n    at org.springframework.integration.channel.AbstractMessageChannel.send(AbstractMessageChannel.java:331)\n    at org.springframework.integration.channel.AbstractMessageChannel.send(AbstractMessageChannel.java:304)\n    at com.company.notification.service.SftpService.uploadFromSftpConnection(SftpService.java:104)\n    ... 158 more\nCaused by: org.springframework.messaging.core.DestinationResolutionException: no output-channel or replyChannel header available\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}