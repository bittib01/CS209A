{
  "question": {
    "tags": [
      "java",
      "postgresql",
      "jdbi",
      "jdbi3",
      "jdbi3-core"
    ],
    "owner": {
      "account_id": 4467428,
      "reputation": 822,
      "user_id": 3634630,
      "user_type": "registered",
      "accept_rate": 80,
      "profile_image": "https://www.gravatar.com/avatar/433559a48a07ea761d6486a10fd4d079?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "brcolow",
      "link": "https://stackoverflow.com/users/3634630/brcolow"
    },
    "is_answered": true,
    "view_count": 184,
    "accepted_answer_id": 79157395,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1737419139,
    "creation_date": 1730532417,
    "last_edit_date": 1730767802,
    "question_id": 79150159,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79150159/how-to-use-a-postgresql-custom-type-as-a-nested-pojo-in-jdbi",
    "title": "How to use a PostgreSQL custom type as a nested POJO in jdbi?",
    "body": "<p>I am trying to do something which I think should be relatively straight-forward with JDBI v3 (using the sql-object and postgres extensions).</p>\n<p>I have an Item class:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class Item {\n    private String itemNumber;\n    private Dimension3D dimensions;\n\n    public Item(String itemNumber, Dimension3D dimensions) {\n        this.itemNumber = itemNumber;\n        this.dimensions = dimensions;\n    }\n\n    public String getItemNumber() {\n        return itemNumber;\n    }\n\n    public Dimension3D getDimensions() {\n        return dimensions;\n    }\n}\n</code></pre>\n<p>The Dimension3D class is:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class Dimension3D {\n    private BigDecimal width, length, height;\n    private LengthUnit lengthUnit; // This is an enum, defaults to INCH.\n\n    public Dimension3D(BigDecimal width, BigDecimal length, BigDecimal height) {\n        this.width = width;\n        this.length = length;\n        this.height = height;\n        this.unit = LengthUnit.INCH;\n    }\n\n    // Getters and setters.\n}\n</code></pre>\n<p>I am using the following table schemas for items:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@SqlUpdate(&quot;&quot;&quot;\n        CREATE TABLE items  (\n            item_number VARCHAR(7) NOT NULL PRIMARY KEY CHECK (item_number ~ '^[0-9]{6}[ab]?$'),\n            dimensions dimension_3d NOT NULL DEFAULT (0, 0, 0, 'inch'),\n        );\n        &quot;&quot;&quot;)\nvoid createTable();\n</code></pre>\n<p>The dimension_3d type is created thusly:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@SqlScript(&quot;&quot;&quot;\n        CREATE TYPE spatial_unit AS ENUM ('inch', 'metric');\n        \n        CREATE TYPE dimension_3d AS (\n            width numeric,\n            length numeric,\n            height numeric,\n            unit spatial_unit\n        );\n        &quot;&quot;&quot;)\nvoid createTypes();\n</code></pre>\n<p>I am trying to make an <code>insertItem</code> method which takes an <code>Item</code> POJO:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@SqlUpdate(&quot;insert into items (item_number, dimensions) &quot; +\n        &quot;values (:itemNumber, :dimensions)&quot;)\n@RegisterColumnMapper(Dimension3DColumnMapper.class)\nvoid insertItem(@BindBean Item item);\n</code></pre>\n<p>In order to try and make this work I have the above referenced <code>Dimension3DColumnMapper</code> (not sure that this is necessary):</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class Dimension3DColumnMapper implements ColumnMapper&lt;Dimension3D&gt; {\n    @Override\n    public Dimension3D map(ResultSet r, int columnNumber, StatementContext ctx) throws SQLException {\n        return new Dimension3D(r.getBigDecimal(&quot;length&quot;), r.getBigDecimal(&quot;width&quot;), r.getBigDecimal(&quot;height&quot;), LengthUnit.INCH);\n    }\n}\n</code></pre>\n<p>Finally I call these methods thusly:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Test\npublic void testCreateTables(Jdbi jdbi) {\n    jdbi.installPlugin(new SqlObjectPlugin());\n    jdbi.installPlugin(new PostgresPlugin());\n    jdbi.withHandle(handle -&gt; {\n        handle.registerArgument(new Dimension3DArgumentFactory());\n        handle.configure(PostgresTypes.class, pt -&gt; pt.registerCustomType(Dimension3DPGType.class, &quot;dimension_3d&quot;));\n        handle.attach(ItemQueries.class).createTypes();\n        handle.attach(ItemQueries.class).insertItem(new Item(&quot;00001&quot;, new Dimension3D(new BigDecimal(&quot;1&quot;), new BigDecimal(&quot;1&quot;), new BigDecimal(&quot;1&quot;), LengthUnit.INCH));\n    });\n}\n</code></pre>\n<p>My attempt to make this work seamlessly has led me to register a custom <code>ArgumentFactory</code> defined thusly:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class Dimension3DArgumentFactory extends AbstractArgumentFactory&lt;Dimension3D&gt; {\n\n    public Dimension3DArgumentFactory() {\n        super(Types.NUMERIC);\n    }\n\n    @Override\n    protected Argument build(Dimension3D value, ConfigRegistry config) {\n        return (position, statement, ctx) -&gt; {\n            statement.setBigDecimal(position, value.getLength());\n            statement.setBigDecimal(position + 1, value.getWidth());\n            statement.setBigDecimal(position + 2, value.getHeight());\n        };\n    }\n}\n</code></pre>\n<p>I also tried to register the <code>dimension_3d</code> custom type (as seen above) which is:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class Dimension3DPGType extends PGobject {\n    private Dimension3D dimension3D;\n\n    public Dimension3DPGType(BigDecimal length, BigDecimal width, BigDecimal height) {\n        this();\n        this.dimension3D = new Dimension3D(length, width, height, LengthUnit.INCH);\n    }\n\n    public Dimension3DPGType() {\n        setType(&quot;dimension_3d&quot;);\n    }\n\n    public BigDecimal getWidth() {\n        return dimension3D.getWidth();\n    }\n\n    public void setWidth(BigDecimal width) {\n        dimension3D = new Dimension3D(width, dimension3D.getLength(), dimension3D.getHeight(), LengthUnit.INCH);\n    }\n\n    public BigDecimal getLength() {\n        return dimension3D.getLength();\n    }\n\n    public void setLength(BigDecimal length) {\n        dimension3D = new Dimension3D(getWidth(), length, dimension3D.getHeight(), LengthUnit.INCH);\n    }\n\n    public BigDecimal getHeight() {\n        return dimension3D.getHeight();\n    }\n\n    public void setHeight(BigDecimal height) {\n        dimension3D = new Dimension3D(dimension3D.getWidth(), dimension3D.getLength(), height, LengthUnit.INCH);\n    }\n\n    @Override\n    public String getValue() {\n        return &quot;(&quot; + getWidth() + &quot;,&quot; + getLength() + &quot;,&quot; + getHeight() + &quot;)&quot;;\n    }\n\n    @Override\n    public void setValue(String value) {\n        PGtokenizer t = new PGtokenizer(PGtokenizer.removePara(value), ',');\n\n        BigDecimal length = new BigDecimal(t.getToken(0));\n        BigDecimal width = new BigDecimal(t.getToken(1));\n        BigDecimal height = new BigDecimal(t.getToken(2));\n        dimension3D = new Dimension3D(length, width, height, LengthUnit.INCH);\n    }\n\n    @Override\n    public boolean equals(Object o) {\n        if (this == o) {\n            return true;\n        }\n        if (!(o instanceof Dimension3DPGType that)) {\n            return false;\n        }\n        if (!super.equals(o)) {\n            return false;\n        }\n        return Objects.equals(dimension3D, that.dimension3D);\n    }\n\n    @Override\n    public int hashCode() {\n        return dimension3D.hashCode();\n    }\n}\n</code></pre>\n<p>I have tried this with/without the ColumnMapper, ArgumentFactory, and custom type registration.</p>\n<p>The current exception I'm facing is:</p>\n<pre><code>[ERROR]   DatabaseTest.testCreateTables:21-&gt;lambda$testCreateTables$1:29 » UnableToExecuteStatement org.postgresql.util.PSQLException: ERROR: column &quot;dimensions&quot; is of type dimension_3d but expression is of type numeric\n  Hint: You will need to rewrite or cast the expression.\n</code></pre>\n<p>Attempting to correct this with using casts like below:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@SqlUpdate(&quot;insert into items (item_number, dimensions) &quot; +\n        &quot;values (:itemNumber, CAST(:dimensions AS dimension_3d))&quot;)\n@RegisterColumnMapper(Dimension3DColumnMapper.class)\nvoid insertItem(@BindBean Item item);\n\n</code></pre>\n<p>then produces the exception:</p>\n<pre><code>DatabaseTest.testCreateTables:21-&gt;lambda$testCreateTables$1:29 » UnableToExecuteStatement org.postgresql.util.PSQLException: ERROR: cannot cast type numeric to dimension_3d\n</code></pre>\n<p>For reference I am using the following dependency versions:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;dependency&gt;\n    &lt;groupId&gt;org.jdbi&lt;/groupId&gt;\n    &lt;artifactId&gt;jdbi3-core&lt;/artifactId&gt;\n    &lt;version&gt;3.47.0&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;org.jdbi&lt;/groupId&gt;\n    &lt;artifactId&gt;jdbi3-sqlobject&lt;/artifactId&gt;\n    &lt;version&gt;3.47.0&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;org.jdbi&lt;/groupId&gt;\n    &lt;artifactId&gt;jdbi3-postgres&lt;/artifactId&gt;\n    &lt;version&gt;3.47.0&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;org.postgresql&lt;/groupId&gt;\n    &lt;artifactId&gt;postgresql&lt;/artifactId&gt;\n    &lt;version&gt;42.7.4&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;org.jdbi&lt;/groupId&gt;\n    &lt;artifactId&gt;jdbi3-testing&lt;/artifactId&gt;\n    &lt;version&gt;3.47.0&lt;/version&gt;\n    &lt;scope&gt;test&lt;/scope&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;de.softwareforge.testing&lt;/groupId&gt;\n    &lt;artifactId&gt;pg-embedded&lt;/artifactId&gt;\n    &lt;version&gt;5.2.0&lt;/version&gt;\n    &lt;scope&gt;test&lt;/scope&gt;\n&lt;/dependency&gt;\n</code></pre>\n<p>Thanks very much for any assistance!</p>\n<p>Update:</p>\n<p>I tried the following:</p>\n<pre class=\"lang-java prettyprint-override\"><code>package com.dow.inventory.db;\n\nimport com.dow.items.Dimension3D;\nimport org.jdbi.v3.core.argument.AbstractArgumentFactory;\nimport org.jdbi.v3.core.argument.Argument;\nimport org.jdbi.v3.core.config.ConfigRegistry;\n\nimport java.sql.Types;\n\npublic class Dimension3DArgumentFactory extends AbstractArgumentFactory&lt;Dimension3D&gt; {\n\n    public Dimension3DArgumentFactory() {\n        super(Types.OTHER);\n    }\n\n    @Override\n    protected Argument build(Dimension3D value, ConfigRegistry config) {\n        final Dimension3DPGType dimension3d = new Dimension3DPGType(value);\n        return (i, p, cx) -&gt; p.setObject(i, dimension3d, Types.OTHER);\n    }\n}\n</code></pre>\n<p>but this leads to:</p>\n<p><code>UnableToExecuteStatement org.postgresql.util.PSQLException: ERROR: malformed record literal: &quot;(10.75,8.5,7.25)&quot;</code></p>\n<p>This String is coming from:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Override\npublic String getValue() {\n    return &quot;(&quot; + getWidth() + &quot;,&quot; + getLength() + &quot;,&quot; + getHeight() + &quot;)&quot;;\n}\n</code></pre>\n<p>Don't know what the correct format is for this to work...</p>\n<p>Update 2:</p>\n<p>I think I'm getting closer with:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Override\npublic String getValue() {\n    return &quot;(ROW(&quot; + getWidth() + &quot;,&quot; + getLength() + &quot;,&quot; + getHeight() + &quot;))&quot;;\n}\n</code></pre>\n<p>because this then leads to the exception for trying to &quot;deserialize&quot;:</p>\n<p>org.jdbi.v3.core.statement.UnableToExecuteStatementException:\norg.postgresql.util.PSQLException: ERROR: invalid input syntax for type numeric: &quot;ROW(10.75&quot;</p>\n<p>Don't know where this is coming from though because I use the following substring to set the value:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Override\npublic void setValue(String value) {\n    String[] parts = value.substring(5, value.length() - 2).split(&quot;,&quot;);\n\n    BigDecimal width = new BigDecimal(parts[0]);\n    BigDecimal length = new BigDecimal(parts[1]);\n    BigDecimal height = new BigDecimal(parts[2]);\n\n    dimension3D = new Dimension3D(width, length, height, LengthUnit.INCH);\n}\n\n</code></pre>\n<p>I don't know why using just parentheses leads to a malformed record literal <code>ERROR: malformed record literal: &quot;(10.75,8.5,7.25)&quot;</code> as that it what is done <a href=\"https://github.com/marklogic-community/ml-jdbc-driver/blob/7d79e6e87e234c00382c79b319d860aff9144efa/src/main/java/org/postgresql/geometric/PGpoint.java#L110\" rel=\"nofollow noreferrer\">here</a>.</p>\n<p>Update 3:</p>\n<p>Seems like not including the length_unit doesn't work, this is now super close:</p>\n<pre class=\"lang-java prettyprint-override\"><code>    @Override\n    public String getValue() {\n        return &quot;(&quot; + getWidth() + &quot;,&quot; + getLength() + &quot;,&quot; + getHeight() + &quot;,'inch')&quot;;\n    }\n</code></pre>\n<p>but this yields:</p>\n<p><code>UnableToExecuteStatement org.postgresql.util.PSQLException: ERROR: invalid input value for enum spatial_unit: &quot;'inch'&quot;</code></p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}