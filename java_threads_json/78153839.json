{
  "question": {
    "tags": [
      "java",
      "hibernate",
      "jpa",
      "memory-leaks",
      "eclipselink"
    ],
    "owner": {
      "account_id": 1440381,
      "reputation": 2516,
      "user_id": 1360694,
      "user_type": "registered",
      "accept_rate": 49,
      "profile_image": "https://www.gravatar.com/avatar/e27fb93585c721206036bc9ee2aff5ab?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Siddharth Trikha",
      "link": "https://stackoverflow.com/users/1360694/siddharth-trikha"
    },
    "is_answered": false,
    "view_count": 524,
    "answer_count": 1,
    "score": 3,
    "last_activity_date": 1741536770,
    "creation_date": 1710333399,
    "last_edit_date": 1711022992,
    "question_id": 78153839,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78153839/jpa-queries-memory-leak",
    "title": "JPA queries memory leak?",
    "body": "<p>We are profiling our application using <code>Jprofiler</code> to solve memory leaks and came across following observations:</p>\n<p>We ran our application on the same data set to check and took multiple snapshots after marking Heap to see the Classes contributing to memory leak.</p>\n<p><a href=\"https://i.sstatic.net/mhdAl.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/mhdAl.png\" alt=\"enter image description here\" /></a></p>\n<p>The <code>byte[]</code>, <code>String</code>, <code>int[]</code> after checking their allocations all point to <code>JPA</code> queries. For example the allocation Hotspots for <code>byte[]</code> all point to query results :</p>\n<p><code>QuerImpl.getSingleResult</code>,</p>\n<p><code>QueryImpl.getResultList</code></p>\n<p><code>EnitiyManger.find</code> :</p>\n<p><a href=\"https://i.sstatic.net/zjHkH.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/zjHkH.png\" alt=\"enter image description here\" /></a></p>\n<p>Similar results were found for allocations of <code>String</code>, <code>jav.util.HashMap$Node</code>:</p>\n<p><a href=\"https://i.sstatic.net/aJVVl.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/aJVVl.png\" alt=\"enter image description here\" /></a></p>\n<p>The one query on JPA which shows significant allocation is <code>checkResourceID</code> in <code>Dao</code> class:</p>\n<pre><code>@Stateless\n@EJB(name = &quot;java:global/ResourceProceduresDaoImpl&quot;, beanInterface = ResourceProceduresDao.class)\npublic class ResourceProceduresDaoImpl&lt;R&gt; implements ResourceProceduresDao&lt;R&gt; {\n\n    @Resource(mappedName = &quot;java:/M2M_RESOURCES&quot;)\n    private DataSource ds;\n\n    @PersistenceContext(unitName = &quot;EM&quot;)\n    EntityManager em;\n    static Logger logger = LogManager.getLogger(ResourceProceduresDaoImpl.class);\n    SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyyMMdd'T'HHmmss&quot;);\n\n    public void create(R resource) {\n        em.persist(resource);\n        em.flush();\n    }\n\n    public R retrieve(Class type, String resourceID) {\n        logger.info(&quot;ResourceProceduresDaoImpl class=&quot; + type + &quot; resourceID=&quot; + resourceID);\n        Object obj = em.find(type, resourceID);\n        // logger.info(&quot;ResourceProceduresDaoImpl obj=&quot;+obj);\n        return (R) obj;\n    }\n\n    public void update(R resource) {\n        em.merge(resource);\n    }\n\n    public void delete(R resource) {\n        if (!em.contains(resource))\n            resource = em.merge(resource);\n        em.remove(resource);\n    }        \npublic boolean checkResourceID(String resourceID) {\n                boolean ifExists = false;\n             \n                if (em.createNamedQuery(&quot;ResourcePCM.findByResourceID&quot;, ResourceParentChildMapping.class)\n                    .setParameter(&quot;resourceId&quot;, resourceID).getSingleResult() == null) {\n                    \n                        ifExists = true;\n                    } \n    \n    ..//\n                return ifExists;\n            }\n</code></pre>\n<p>The JPA for <code>ResourcePCM</code> :</p>\n<pre><code>    @Entity\n    @Table(name=&quot;\\&quot;RESOURCE_PCM\\&quot;&quot;,schema=&quot;\\&quot;RESOURCES\\&quot;&quot;)\n    @NamedQueries({\n       @NamedQuery(name=&quot;ResourcePCM.findAll&quot;, query=&quot;SELECT r FROM ResourcePCM r&quot;),\n       @NamedQuery(name=&quot;ResourcePCM.findByResourceID&quot;, query=&quot;SELECT r FROM ResourcePCM r where r.resourceID = :resourceId&quot;)\n    \n    })\n    @NamedStoredProcedureQuery(\n            name = &quot;generateResourceID&quot;, \n            procedureName = &quot;generateResourceID&quot;, \n            parameters = { \n                @StoredProcedureParameter(mode = ParameterMode.IN, type = String.class, name = &quot;input&quot;), \n                @StoredProcedureParameter(mode = ParameterMode.OUT, type = String.class, name = &quot;output&quot;)\n            }\n        )\n    public class ResourcePCM implements Serializable {\n        private static final long serialVersionUID = 1L;\n    \n        @Id\n        @Column(name=&quot;\\&quot;resourceID\\&quot;&quot;)\n        private String resourceID;\n        \n        @Column(name=&quot;\\&quot;structuredResourceID\\&quot;&quot;)\n        private String structuredResourceID;\n    \n        @Column(name=&quot;\\&quot;parentID\\&quot;&quot;)\n        private String parentID;\n    \n        @Column(name=&quot;\\&quot;resourceType\\&quot;&quot;)\n        private Integer resourceType;\n        \n        @OneToMany(cascade = CascadeType.ALL, fetch = FetchType.EAGER, orphanRemoval = true)\n        @JoinColumn(name=&quot;\\&quot;resourceID\\&quot;&quot;,referencedColumnName=&quot;\\&quot;resourceID\\&quot;&quot;)\n        private Set&lt;ResourceACP&gt; resourceACP;\n\n..///\n}\n</code></pre>\n<p>So like this only in queries there are significant allocations of memory and I am unable to figure out the cause.</p>\n<p>Is it the <code>JPA</code> ? Or the way <code>EntityManager</code> is invoked ?</p>\n<p>PS: I use <code>JNDI</code> lookup for my Beans rather than injection with <code>@EJB</code> or <code>@Inject</code>, if this would make a difference ?</p>\n<p><strong>EDIT</strong></p>\n<p>persistence.xml:</p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;persistence version=&quot;1.0&quot; xmlns=&quot;http://java.sun.com/xml/ns/persistence&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_1.xsd&quot;&gt;\n     &lt;persistence-unit name=&quot;EM&quot; transaction-type=&quot;JTA&quot;&gt;\n        &lt;provider&gt;org.eclipse.persistence.jpa.PersistenceProvider&lt;/provider&gt;\n        &lt;jta-data-source&gt;java:/M2M_RESOURCES&lt;/jta-data-source&gt;\n            &lt;class&gt;package.jpa.ResourceBase1&lt;/class&gt;\n            &lt;class&gt;package.jpa.ResourceBase2&lt;/class&gt;\n            &lt;class&gt;package.jpa.ResourceBase3&lt;/class&gt;\n            &lt;class&gt;package.jpa.ResourceBase4&lt;/class&gt;\n            &lt;class&gt;package.jpa.ResourceBase5&lt;/class&gt;\n            &lt;class&gt;package.jpa.ResourceBase6&lt;/class&gt;  \n\n..///\n\n            &lt;!-- Converters --&gt;\n            &lt;class&gt;package.mapping.DBJsonConverter&lt;/class&gt;       \n            &lt;properties&gt;                                                \n            &lt;property name=&quot;eclipselink.target-server&quot; value=&quot;JBoss&quot;/&gt;\n            &lt;property name=&quot;eclipselink.target-database&quot; value=&quot;PostgreSQL&quot; /&gt;\n        &lt;/properties&gt;\n    &lt;/persistence-unit&gt;\n&lt;/persistence&gt;\n</code></pre>\n<p><strong>EDIT2:</strong></p>\n<p>Incoming References to <code>byte[] : </code></p>\n<p><a href=\"https://i.sstatic.net/dRjZp.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/dRjZp.png\" alt=\"enter image description here\" /></a></p>\n<p>Incoming references expanded:</p>\n<p><a href=\"https://i.sstatic.net/fX5xL.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/fX5xL.png\" alt=\"enter image description here\" /></a></p>\n<p>The difference between two snapshots taken between 5k request and 10k request load:</p>\n<p><a href=\"https://i.sstatic.net/cr88T.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/cr88T.png\" alt=\"enter image description here\" /></a></p>\n<p><strong>postgresql-ds.xml</strong></p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;datasources&gt;\n    &lt;datasource jndi-name=&quot;java:/RESOURCES&quot; pool-name=&quot;RESOURCES&quot; enabled=&quot;true&quot; use-java-context=&quot;true&quot; use-ccm=&quot;true&quot;&gt;\n        &lt;connection-url&gt;jdbc:postgresql://[hostname]:[port]/[schema]&lt;/connection-url&gt;\n        &lt;driver&gt;postgresql-42.2.5.jar&lt;/driver&gt;\n        &lt;pool&gt; \n            &lt;min-pool-size&gt;200&lt;/min-pool-size&gt; &lt;max-pool-size&gt;400&lt;/max-pool-size&gt; \n            &lt;prefill&gt;true&lt;/prefill&gt; \n        &lt;/pool&gt; \n        &lt;security&gt;\n            &lt;user-name&gt;[userName]&lt;/user-name&gt;\n            &lt;password&gt;[password]&lt;/password&gt;\n        &lt;/security&gt;\n        &lt;timeout&gt;\n            &lt;blocking-timeout-millis&gt;800&lt;/blocking-timeout-millis&gt;\n        &lt;/timeout&gt;\n        &lt;statement&gt;\n            &lt;prepared-statement-cache-size&gt;100&lt;/prepared-statement-cache-size&gt;\n            &lt;share-prepared-statements&gt;true&lt;/share-prepared-statements&gt;\n        &lt;/statement&gt;\n    &lt;/datasource&gt;\n&lt;/datasources&gt;\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}