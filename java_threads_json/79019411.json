{
  "question": {
    "tags": [
      "java",
      "spring",
      "oracle-database",
      "spring-cloud-stream",
      "oracle-aq"
    ],
    "owner": {
      "account_id": 2934677,
      "reputation": 1478,
      "user_id": 2513934,
      "user_type": "registered",
      "profile_image": "https://i.sstatic.net/EYFHh.jpg?s=256",
      "display_name": "actunderdc",
      "link": "https://stackoverflow.com/users/2513934/actunderdc"
    },
    "is_answered": false,
    "view_count": 420,
    "answer_count": 0,
    "score": 3,
    "last_activity_date": 1752569151,
    "creation_date": 1727193002,
    "last_edit_date": 1727193456,
    "question_id": 79019411,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79019411/read-messages-from-oracle-aq-with-custom-adt-payload",
    "title": "Read messages from Oracle AQ with custom ADT payload",
    "body": "<p>I am trying to read messages from an Oracle Queue that has custom ADT payload (not simple text messaging) using a simple spring cloud stream project. I am having difficulties doing this with spring, but I was able to do it using simple java, so the problem should not be on Oracle part.</p>\n<p>The error that I am getting is:</p>\n<pre><code>oracle.jakarta.jms.AQjmsException: JMS-137: Payload factory must be specified for destinations with ADT payloads\n    at oracle.jakarta.jms.AQjmsError.throwEx(AQjmsError.java:317) ~[aqapi-jakarta-23.3.1.0.jar:na]\n    at oracle.jakarta.jms.AQjmsConsumer.&lt;init&gt;(AQjmsConsumer.java:482) ~[aqapi-jakarta-23.3.1.0.jar:na]\n    at oracle.jakarta.jms.AQjmsConsumer.&lt;init&gt;(AQjmsConsumer.java:338) ~[aqapi-jakarta-23.3.1.0.jar:na]\n    at oracle.jakarta.jms.AQjmsSession.createConsumer(AQjmsSession.java:8974) ~[aqapi-jakarta-23.3.1.0.jar:na]\n    at oracle.jakarta.jms.AQjmsSession.createConsumer(AQjmsSession.java:8863) ~[aqapi-jakarta-23.3.1.0.jar:na]\n    at org.springframework.jms.listener.AbstractMessageListenerContainer.createConsumer(AbstractMessageListenerContainer.java:930) ~[spring-jms-6.1.13.jar:6.1.13]\n    at org.springframework.jms.listener.AbstractPollingMessageListenerContainer.createListenerConsumer(AbstractPollingMessageListenerContainer.java:225) ~[spring-jms-6.1.13.jar:6.1.13]\n    at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.initResourcesIfNecessary(DefaultMessageListenerContainer.java:1290) ~[spring-jms-6.1.13.jar:6.1.13]\n    at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.invokeListener(DefaultMessageListenerContainer.java:1256) ~[spring-jms-6.1.13.jar:6.1.13]\n    at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.executeOngoingLoop(DefaultMessageListenerContainer.java:1247) ~[spring-jms-6.1.13.jar:6.1.13]\n    at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.run(DefaultMessageListenerContainer.java:1140) ~[spring-jms-6.1.13.jar:6.1.13]\n    at java.base/java.lang.Thread.run(Thread.java:833) ~[na:na]\n</code></pre>\n<p>(I placed <strong>logging.level.org.springframework.jms=TRACE</strong> in <strong>application.properties</strong>)</p>\n<p>The queue name is <strong>container_queue</strong>, the database user is <strong>jmsuser</strong> and the database object type name is <strong>message_container</strong></p>\n<p>Here is the spring-cloud-stream project:</p>\n<p><strong>build.gradle</strong></p>\n<pre><code>implementation 'org.springframework.cloud:spring-cloud-stream'\nimplementation 'org.springframework.boot:spring-boot-starter-activemq'\nimplementation 'jakarta.jms:jakarta.jms-api:3.0.0'\nimplementation 'com.oracle.database.messaging:aqapi-jakarta:23.3.1.0'\nimplementation 'com.oracle.database.jdbc:ojdbc11:23.3.0.23.09'\nimplementation 'com.oracle.database.jdbc:ucp:23.3.0.23.09'\n</code></pre>\n<p><strong>MessageContainer.java</strong></p>\n<pre><code>import java.sql.Connection;\nimport java.sql.SQLException;\nimport java.sql.Struct;\nimport java.sql.Timestamp;\n\nimport oracle.jdbc.OracleTypes;\nimport oracle.sql.Datum;\nimport oracle.sql.ORAData;\nimport oracle.sql.ORADataFactory;\n\npublic class MessageContainer implements ORAData, ORADataFactory {\n    String primaryId;\n    String businessUnitCode;\n    Timestamp scanTimestamp;\n    public static final String SQL_NAME = &quot;jmsuser.MESSAGE_CONTAINER&quot;;\n    public static final int SQL_TYPECODE = OracleTypes.STRUCT;\n\n    protected static final MessageContainer MESSAGECONTAINERFactory = new MessageContainer();\n\n    public MessageContainer() {\n    }\n\n    public MessageContainer(String primaryId, String businessUnitCode, Timestamp scanTimestamp) {\n        this.primaryId = primaryId;\n        this.businessUnitCode = businessUnitCode;\n        this.scanTimestamp = scanTimestamp;\n    }\n\n    public static ORADataFactory getORADataFactory() {\n        return MESSAGECONTAINERFactory;\n    }\n\n    public ORAData create(Datum d, int sqlType) throws SQLException {\n        if (d == null) {\n            return null;\n        }\n        if (!(d instanceof Struct)) {\n            throw new SQLException(&quot;Expected Struct type Datum but found &quot; + d.getClass());\n        }\n        Struct struct = (Struct) d;\n        Object[] attr = struct.getAttributes();\n        return new MessageContainer((String) attr[0], (String) attr[1], (Timestamp) attr[2]);\n    }\n\n    @Override\n    public Datum toDatum(Connection c) throws SQLException {\n        Object[] attributes = { primaryId, businessUnitCode, scanTimestamp };\n        Struct struct = c.createStruct(SQL_NAME, attributes);\n        return (Datum) struct;\n    }\n\n    public String getPrimaryId() {\n        return primaryId;\n    }\n\n    public void setPrimaryId(String primaryId) {\n        this.primaryId = primaryId;\n    }\n\n    public String getBusinessUnitCode() {\n        return businessUnitCode;\n    }\n\n    public void setBusinessUnitCode(String businessUnitCode) {\n        this.businessUnitCode = businessUnitCode;\n    }\n\n    public Timestamp getScanTimestamp() {\n        return scanTimestamp;\n    }\n\n    public void setScanTimestamp(Timestamp scanTimestamp) {\n        this.scanTimestamp = scanTimestamp;\n    }\n}\n</code></pre>\n<p><strong>OracleAQListener.java</strong></p>\n<pre><code>import org.springframework.jms.annotation.JmsListener;\nimport org.springframework.stereotype.Component;\n\nimport jakarta.jms.Message;\nimport oracle.jakarta.jms.AQjmsAdtMessage;\n\n@Component\npublic class OracleAQListener {\n    @JmsListener(destination = &quot;container_queue&quot;, containerFactory = &quot;jmsListenerContainerFactory&quot;)\n    public void receiveMessage(Message message) {\n        try {\n            if (message instanceof AQjmsAdtMessage adtMessage) {\n                MessageContainer msg = (MessageContainer) adtMessage.getAdtPayload();\n                System.out.println(&quot;Received a message! ID: &quot; + msg.getPrimaryId() + &quot; BU: &quot; + msg.getBusinessUnitCode() + &quot; date: &quot; + msg.getScanTimestamp());\n\n            } else {\n                System.out.println(&quot;Received unknown message type: &quot; + message.getClass().getName());\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n}\n</code></pre>\n<p><strong>OracleAQConfig.java</strong> (most probably here I need to change, but I don't know how)</p>\n<pre><code>import java.sql.Connection;\nimport java.sql.SQLException;\nimport java.util.Map;\nimport java.util.Properties;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\nimport jakarta.jms.ConnectionFactory;\nimport jakarta.jms.JMSException;\nimport oracle.jakarta.jms.AQjmsFactory;\nimport oracle.jdbc.pool.OracleDataSource;\n\n@Configuration\npublic class OracleAQConfig {\n\n    @Bean\n    public ConnectionFactory connectionFactory() throws JMSException, SQLException {\n        Properties props = new Properties();\n        props.setProperty(&quot;oracle.jms.mapMessage&quot;, &quot;true&quot;);\n\n        OracleDataSource dataSource = new OracleDataSource();\n        dataSource.setURL(&quot;jdbc:oracle:thin:@//dbaddress.com:1521/MYSID&quot;);\n        dataSource.setUser(&quot;jmsuser&quot;);\n        dataSource.setPassword(&quot;jmspassword&quot;);\n        dataSource.setConnectionProperties(props);\n\n        Connection conn = null;\n        try {\n            conn = dataSource.getConnection();\n            Map&lt;String, Class&lt;?&gt;&gt; typeMap = conn.getTypeMap();\n            typeMap.put(MessageContainer.SQL_NAME, MessageContainer.class);\n            conn.setTypeMap(typeMap);\n        } catch (Exception e) {\n            throw new RuntimeException(&quot;Error setting up custom ADT factory&quot;, e);\n        } finally {\n            if (conn != null) {\n                try {\n                    conn.close();\n                } catch (SQLException e) {\n                    e.printStackTrace();\n                }\n            }\n        }\n\n        return AQjmsFactory.getConnectionFactory(dataSource);\n    }\n\n}\n</code></pre>\n<p>In the <a href=\"https://docs.oracle.com/en/database/oracle/oracle-database/21/adque/error-messages.html#GUID-65473942-EF92-4393-BAEE-99E96E578261\" rel=\"nofollow noreferrer\">Oracle documentation</a> they state about this error:</p>\n<blockquote>\n<p>JMS-137 Payload factory must be specified for destinations with ADT payloads</p>\n</blockquote>\n<blockquote>\n<p>Cause: CustomDatumFactory was not specified for destinations containing ADT payloads</p>\n</blockquote>\n<blockquote>\n<p>Action: For destinations containing ADT messages, a CustomDatumFactory for a java class that maps to the SQL ADT type of the destination must be specified</p>\n</blockquote>\n<p>But I have no idea how to create <strong>CustomDatumFactory</strong>. I found no relevant example/documentation on how to do it.\nAny advice would be very helpful.\nThank you!</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}