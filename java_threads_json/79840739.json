{
  "question": {
    "tags": [
      "java",
      "google-play"
    ],
    "owner": {
      "account_id": 2510127,
      "reputation": 5232,
      "user_id": 2182809,
      "user_type": "registered",
      "accept_rate": 65,
      "profile_image": "https://i.sstatic.net/g613H.jpg?s=256",
      "display_name": "Nimila Hiranya",
      "link": "https://stackoverflow.com/users/2182809/nimila-hiranya"
    },
    "is_answered": false,
    "view_count": 63,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1765266647,
    "creation_date": 1765182621,
    "last_edit_date": 1765184164,
    "question_id": 79840739,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79840739/google-pay-decryption-failure-with-tink",
    "title": "Google Pay Decryption Failure with Tink",
    "body": "<p>I'm trying to integrate Google Pay in Direct Integration mode. I'm having trouble decrypting the payment data once received.</p>\n<pre><code>public static String decryptGooglePayTokenWithTink(\n            String encryptedMessage,\n            String privateKeyBase64,\n            String merchantId,\n            boolean isTestEnvironment\n    ) throws Exception {\n        // Per Google documentation:\n        // - For TEST: Use &quot;merchant:[MERCHANT ID]&quot; format\n        // - For PRODUCTION: Use &quot;merchant:[MERCHANT ID]&quot; format\n        // If merchant ID is not configured, use empty string\n        String recipientId = (merchantId != null &amp;&amp; !merchantId.trim().isEmpty()) \n                ? &quot;merchant:&quot; + merchantId \n                : &quot;&quot;;\n        \n        try {\n            // Build recipient using Tink library exactly as per Google documentation\n            PaymentMethodTokenRecipient.Builder builder = new PaymentMethodTokenRecipient.Builder();\n            \n            // Use appropriate Google signing keys manager based on environment\n            // Keys are prefetched at startup for performance\n            if (isTestEnvironment) {\n                builder.fetchSenderVerifyingKeysWith(GooglePaymentsPublicKeysManager.INSTANCE_TEST);\n            } else {\n                builder.fetchSenderVerifyingKeysWith(GooglePaymentsPublicKeysManager.INSTANCE_PRODUCTION);\n            }\n            \n            // Set recipient ID per Google documentation: &quot;merchant:[MERCHANT ID]&quot;\n            builder.recipientId(recipientId);\n            \n            // Set protocol version (ECv2 only)\n            builder.protocolVersion(&quot;ECv2&quot;);\n            \n            // Add private key as Base64-encoded PKCS8 string\n            // Can add multiple keys for graceful key rotation\n            builder.addRecipientPrivateKey(privateKeyBase64);\n            \n            // Build and unseal (decrypt and verify signatures)\n            PaymentMethodTokenRecipient recipient = builder.build();\n            return recipient.unseal(encryptedMessage);\n        } catch (Exception e) {\n            throw new IllegalArgumentException(e.getMessage(), e);\n        }\n    }\n</code></pre>\n<p>This fails. I have added my Public Key on <a href=\"https://pay.google.com/\" rel=\"nofollow noreferrer\">https://pay.google.com/</a> under the Direct Integration. And I'm trying on TEST mode. The <code>unseal</code> method throws an error.</p>\n<p>Error Log:</p>\n<blockquote>\n<p>Caused by: javax.crypto.AEADBadTagException: Tag mismatch!    at\njava.base/com.sun.crypto.provider.GaloisCounterMode$GCMDecrypt.doFinal(GaloisCounterMode.java:1395)\nat\njava.base/com.sun.crypto.provider.GaloisCounterMode.engineDoFinal(GaloisCounterMode.java:406)\nat java.base/javax.crypto.Cipher.doFinal(Cipher.java:2205)  at\nio.apptizer.payments.util.GooglePayECv2Util.decryptGooglePayPayload(GooglePayECv2Util.java:231)\n... 73 common frames omitted</p>\n</blockquote>\n<p>What could be causing the issue?</p>\n<p>Edit:\nOn the Google Pay Console, my added Public Key is on &quot;Inactive&quot; status. I don't see any option to bring it to Active status.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}