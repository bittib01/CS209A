{
  "question": {
    "tags": [
      "java",
      "android",
      "kotlin",
      "android-camerax",
      "google-mlkit"
    ],
    "owner": {
      "account_id": 8788482,
      "reputation": 1092,
      "user_id": 6569390,
      "user_type": "registered",
      "profile_image": "https://lh4.googleusercontent.com/-njhQ45Um0gA/AAAAAAAAAAI/AAAAAAAAAYg/doiOiYnmOMg/s256-rj/photo.jpg",
      "display_name": "Purushotam Kumar",
      "link": "https://stackoverflow.com/users/6569390/purushotam-kumar"
    },
    "is_answered": true,
    "view_count": 444,
    "accepted_answer_id": 78679070,
    "answer_count": 3,
    "score": 0,
    "last_activity_date": 1719562118,
    "creation_date": 1718785891,
    "question_id": 78641341,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78641341/text-recognition-overlay-misalignment-issue-in-camera-preview",
    "title": "Text Recognition Overlay Misalignment Issue in Camera Preview",
    "body": "<p>I'm working on an Android application where I'm implementing live text recognition using CameraX and ML Kit. The recognized text is displayed with bounding boxes on the camera preview, but I'm facing an issue where these bounding boxes are not aligning correctly with the text in the live feed.</p>\n<p><strong>Problem Description When running the application:</strong></p>\n<ul>\n<li>The camera preview displays the live feed correctly.</li>\n<li>The ML Kit Text Recognition processes the image and identifies text blocks.</li>\n<li>Bounding boxes are drawn around detected text elements.</li>\n<li>However, these bounding boxes do not align with the actual text in the camera preview. They appear displaced or incorrectly scaled.</li>\n</ul>\n<p>Main Activity Snippets</p>\n<pre><code>package com.aviskaarlab.booksnap.ui.views.home\n\nimport android.Manifest\nimport android.content.pm.PackageManager\nimport android.os.Build\nimport android.os.Bundle\nimport android.util.Log\nimport androidx.appcompat.app.AppCompatActivity\nimport androidx.camera.core.AspectRatio\nimport androidx.camera.core.CameraSelector\nimport androidx.camera.core.ImageAnalysis\nimport androidx.camera.core.Preview\nimport androidx.camera.core.resolutionselector.AspectRatioStrategy\nimport androidx.camera.core.resolutionselector.ResolutionSelector\nimport androidx.camera.lifecycle.ProcessCameraProvider\nimport androidx.camera.view.PreviewView\nimport androidx.core.content.ContextCompat\nimport java.util.concurrent.ExecutorService\nimport java.util.concurrent.Executors\n\nclass MainActivity : AppCompatActivity() {\n    private lateinit var viewBinding: ActivityMainBinding\n    private lateinit var cameraExecutor: ExecutorService\n    private lateinit var textOverlay: TextOverlay\n    private lateinit var viewFinder: PreviewView\n\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        viewBinding = ActivityMainBinding.inflate(layoutInflater)\n        setContentView(viewBinding.root)\n\n        viewFinder = viewBinding.previewView\n        textOverlay = viewBinding.textOverlay\n\n        // Initialize camera and start preview\n        startCamera()\n\n        cameraExecutor = Executors.newSingleThreadExecutor()\n    }\n\n    private fun startCamera() {\n        val cameraProviderFuture = ProcessCameraProvider.getInstance(this)\n\n        cameraProviderFuture.addListener({\n            val resolutionSelector = ResolutionSelector.Builder()\n                .setAspectRatioStrategy(AspectRatioStrategy.RATIO_4_3_FALLBACK_AUTO_STRATEGY)\n                .build()\n\n            val rotation = viewFinder.display.rotation\n            val cameraProvider: ProcessCameraProvider = cameraProviderFuture.get()\n\n            // Preview\n            val preview = Preview.Builder()\n                .setResolutionSelector(resolutionSelector)\n                .setTargetRotation(rotation)\n                .build()\n                .also {\n                    it.setSurfaceProvider(viewBinding.previewView.surfaceProvider)\n                }\n\n            // Image Analysis\n            val imageAnalysis = ImageAnalysis.Builder()\n                .setResolutionSelector(resolutionSelector)\n                .setTargetRotation(rotation)\n                .build()\n                .also {\n                    it.setAnalyzer(\n                        cameraExecutor,\n                        BookSnapWordAnalyzer(\n                            textOverlay,\n                            viewBinding.previewView,\n                        )\n                    )\n                }\n\n            // Select back camera as default\n            val cameraSelector = CameraSelector.DEFAULT_BACK_CAMERA\n\n            try {\n                cameraProvider.unbindAll()\n                cameraProvider.bindToLifecycle(\n                    this, cameraSelector, preview, imageAnalysis\n                )\n\n                preview.setSurfaceProvider(viewFinder.surfaceProvider)\n            } catch (exc: Exception) {\n                Log.e(TAG, &quot;Use case binding failed&quot;, exc)\n            }\n\n        }, ContextCompat.getMainExecutor(this))\n    }\n\n    override fun onDestroy() {\n        super.onDestroy()\n        cameraExecutor.shutdown()\n    }\n\n    companion object {\n        private const val TAG = &quot;CameraXApp&quot;\n    }\n}\n</code></pre>\n<p>BookSnapWordAnalyzer Code Snippet</p>\n<pre><code>package com.aviskaarlab.booksnap.ui.views.home\n\nimport android.graphics.Matrix\nimport android.graphics.Rect\nimport android.graphics.RectF\nimport android.util.Log\nimport androidx.camera.core.ExperimentalGetImage\nimport androidx.camera.core.ImageAnalysis\nimport androidx.camera.core.ImageProxy\nimport androidx.camera.view.PreviewView\nimport com.google.mlkit.vision.common.InputImage\nimport com.google.mlkit.vision.text.Text\nimport com.google.mlkit.vision.text.TextRecognition\nimport com.google.mlkit.vision.text.latin.TextRecognizerOptions\n\ninternal class BookSnapWordAnalyzer(\n    private val overlay: TextOverlay,\n    private val previewView: PreviewView,\n) : ImageAnalysis.Analyzer {\n\n    companion object {\n        private const val TAG = &quot;BookSnapWordAnalyzer&quot;\n        private const val WORD_LENGTH = 4\n    }\n\n    private val recognizer = TextRecognition.getClient(TextRecognizerOptions.DEFAULT_OPTIONS)\n    private lateinit var visionText: Text\n    private lateinit var matrix: Matrix\n    private var rotationDegrees: Int = 0\n\n    @OptIn(ExperimentalGetImage::class)\n    override fun analyze(imageProxy: ImageProxy) {\n        val mediaImage = imageProxy.image ?: return\n        rotationDegrees = imageProxy.imageInfo.rotationDegrees\n        matrix = getCorrectionMatrix(imageProxy, previewView)\n\n        val image =\n            InputImage.fromMediaImage(mediaImage, imageProxy.imageInfo.rotationDegrees)\n\n        recognizer.process(image)\n            .addOnSuccessListener { visionText -&gt;\n                this.visionText = visionText\n                val boxes = mutableListOf&lt;CustomRect&gt;()\n                for (block in visionText.textBlocks) {\n                    for (line in block.lines) {\n                        for (element in line.elements) {\n                            val elementText = element.text\n                            val boundingBox = element.boundingBox\n                            if (elementText.length &gt;= WORD_LENGTH &amp;&amp; boundingBox != null) {\n                                boxes.add(\n                                    CustomRect(\n                                        adjustBoundingBox(boundingBox, imageProxy, previewView),\n                                        elementText\n                                    )\n                                )\n                            }\n                        }\n                    }\n                }\n                overlay.updateBoundingBoxes(boxes)\n            }\n            .addOnFailureListener { e -&gt;\n                Log.e(TAG, &quot;Text recognition failed&quot;, e)\n            }.addOnCompleteListener {\n                imageProxy.close()\n            }\n    }\n\n    private fun adjustBoundingBox(\n        rect: Rect,\n        imageProxy: ImageProxy,\n        previewView: PreviewView\n    ): RectF {\n        val cropRect = imageProxy.cropRect\n        val imageWidth = cropRect.width()\n        val imageHeight = cropRect.height()\n\n        val previewWidth = previewView.width\n        val previewHeight = previewView.height\n\n        val scaleX = previewWidth.toFloat() / imageWidth\n        val scaleY = previewHeight.toFloat() / imageHeight\n\n        val verticalOffset = (previewHeight - imageHeight * scaleY) / 2\n        val horizontalOffset = (previewWidth - imageWidth * scaleX) / 2\n\n        val left = rect.left * scaleX + horizontalOffset\n        val top = rect.top * scaleY + verticalOffset\n        val right = rect.right * scaleX + horizontalOffset\n        val bottom = rect.bottom * scaleY + verticalOffset\n\n        return RectF(left, top, right, bottom)\n    }\n\n    private fun getCorrectionMatrix(\n        imageProxy: ImageProxy,\n        previewView: PreviewView,\n    ): Matrix {\n        val cropRect = imageProxy.cropRect\n        val matrix = Matrix()\n\n        val source = floatArrayOf(\n            cropRect.left.toFloat(), cropRect.top.toFloat(),\n            cropRect.right.toFloat(), cropRect.top.toFloat(),\n            cropRect.right.toFloat(), cropRect.bottom.toFloat(),\n            cropRect.left.toFloat(), cropRect.bottom.toFloat()\n        )\n\n        val destination = floatArrayOf(\n            0f, 0f,\n            previewView.width.toFloat(), 0f,\n            previewView.width.toFloat(), previewView.height.toFloat(),\n            0f, previewView.height.toFloat()\n        )\n\n        matrix.setPolyToPoly(source, 0, destination, 0, 4)\n        return matrix\n    }\n}\n</code></pre>\n<p>TextOverlay Code Snippet</p>\n<pre><code>package com.aviskaarlab.booksnap.ui.views.home\n\nimport android.content.Context\nimport android.graphics.Canvas\nimport android.graphics.Color\nimport android.graphics.Paint\nimport android.graphics.RectF\nimport android.util.AttributeSet\nimport android.view.MotionEvent\nimport android.view.View\n\nclass TextOverlay @JvmOverloads constructor(\n    context: Context, attrs: AttributeSet? = null, defStyleAttr: Int = 0\n) : View(context, attrs, defStyleAttr) {\n\n    private val paint = Paint().apply {\n        color = Color.RED\n        style = Paint.Style.STROKE\n        strokeWidth = 2.0f\n    }\n\n    private val boundingBoxes = mutableListOf&lt;CustomRect&gt;()\n    private var clickListener: ((String) -&gt; Unit)? = null\n\n    fun setOnRectangleClickListener(listener: (String) -&gt; Unit) {\n        clickListener = listener\n    }\n\n    fun updateBoundingBoxes(newBoundingBoxes: List&lt;CustomRect&gt;) {\n        boundingBoxes.clear()\n        boundingBoxes.addAll(newBoundingBoxes)\n        invalidate() // Redraw the view\n    }\n\n    override fun onDraw(canvas: Canvas) {\n        super.onDraw(canvas)\n        for (box in boundingBoxes) {\n            canvas.drawRect(box.rect, paint)\n        }\n    }\n\n    override fun onTouchEvent(event: MotionEvent): Boolean {\n        if (event.action == MotionEvent.ACTION_UP) {\n            val x = event.x\n            val y = event.y\n            for (box in boundingBoxes) {\n                if (box.rect.contains(x, y)) {\n                    clickListener?.invoke(&quot;Clicked on rectangle ${box.text}&quot;)\n                    return true\n                }\n            }\n        }\n        return true // Event handled\n    }\n}\n</code></pre>\n<p><strong>Issue</strong>\nThe rectangles drawn around recognized text do not align with the text in the camera preview. How can I adjust the bounding box coordinates so that they correctly overlay on the text in the live camera feed?(Please see image attached)</p>\n<p><a href=\"https://i.sstatic.net/pnM6s7fg.jpg\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/pnM6s7fg.jpg\" alt=\"This is the issue, boxes are not aligned with the text\" /></a></p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}