{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "spring-security",
      "observability"
    ],
    "owner": {
      "account_id": 14482834,
      "reputation": 5478,
      "user_id": 10461625,
      "user_type": "registered",
      "profile_image": "https://i.sstatic.net/fgo5D.jpg?s=256",
      "display_name": "PatPanda",
      "link": "https://stackoverflow.com/users/10461625/patpanda"
    },
    "is_answered": false,
    "view_count": 185,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1737599706,
    "creation_date": 1736843962,
    "last_edit_date": 1736973150,
    "question_id": 79354398,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79354398/spring-boot-starter-oauth2-client-ability-to-provide-custom-restclient-instead-o",
    "title": "spring-boot-starter-oauth2-client ability to provide custom RestClient instead of using RestTemplate for provider get token observablity",
    "body": "<p>I am trying to have observability using the spring OAuth2 client when fetching the protected resource but also when fetching the token from the token provider. Using this code:</p>\n<pre class=\"lang-java prettyprint-override\"><code> private final RestClient restClient;\n\n    public Controller(RestClient.Builder restClientBuilder) {\n        this.restClient = restClientBuilder.build();\n    }\n\n@GetMapping(&quot;/lessons&quot;)\n    public String fetchLessons() {\n        Map ssa = restClient.post()\n                .uri(&quot;https://service.com/token?scope=resolve+download&amp;grant_type=client_credentials&quot;)\n                .contentType(MediaType.APPLICATION_FORM_URLENCODED)\n                .headers(httpHeaders -&gt; httpHeaders.setBasicAuth(&quot;aaa&quot;, &quot;bbb&quot;))\n                .retrieve()\n                .body(Map.class);\n\n        final MultiValueMap&lt;String, String&gt; params2 = new LinkedMultiValueMap&lt;&gt;();\n        params2.add(&quot;Authorization&quot;, &quot;Bearer &quot; + ssa.get(&quot;access_token&quot;));\n        Consumer&lt;HttpHeaders&gt; consumer2 = it -&gt; it.addAll(params2);\n\n        String result = restClient.get()\n                .uri(&quot;https://protectedresource...&quot;)\n                .headers(consumer2)\n                .retrieve()\n                .body(String.class);\n        return result;\n    }\n</code></pre>\n<p>Above code would work. It first make a request to get the token. Then, with the token, it will make the second call to get the protected resource. The important part is that with the solution above, we can observe it is working. It would yield tracing such as</p>\n<p><a href=\"https://i.sstatic.net/eAPd4WXv.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/eAPd4WXv.png\" alt=\"enter image description here\" /></a></p>\n<p>Everything is working, happy. Hoping to leverage Spring Boot OAuth2, we are now having this code</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Configuration\npublic class RestClientConfig {\n\n    @Bean\n    public RestClient restClient(OAuth2AuthorizedClientManager authorizedClientManager, RestClient.Builder restClientBuilder) {\n        OAuth2ClientHttpRequestInterceptor interceptor = new OAuth2ClientHttpRequestInterceptor(authorizedClientManager);\n        return restClientBuilder\n                .requestInterceptor(interceptor)\n                .build();\n    }\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@RestController\npublic class LessonsController {\n\n    private final RestClient restClient;\n\n    public LessonsController(RestClient restClient) {\n        this.restClient = restClient;\n    }\n\n    @GetMapping(&quot;/lessons&quot;)\n    public String fetchLessons() {\n        return restClient.get()\n                .uri(&quot;https://someprotectedresourceneedingtoken&quot;)\n                .attributes(clientRegistrationId(&quot;my-provider&quot;))\n                .retrieve()\n                .body(String.class);\n    }\n}\n</code></pre>\n<pre class=\"lang-yaml prettyprint-override\"><code>spring:\n  application:\n    name: client-application\n  security:\n    oauth2:\n      client:\n        registration:\n          my-provider:\n            provider: the-provider\n            client-id: someusername\n            client-secret: somepassword\n            authorization-grant-type: client_credentials\n            scope:\n              - resolve\n              - download\n        provider:\n          the-provider:\n            token-uri: https://somethirdparty.com/token\n</code></pre>\n<p>And the code would also work, we are able to get the token, and the protected resource. However, we are losing the trace to the token call</p>\n<p><a href=\"https://i.sstatic.net/lG1NSwX9.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/lG1NSwX9.png\" alt=\"enter image description here\" /></a></p>\n<pre class=\"lang-java prettyprint-override\"><code>2025-01-09T23:59:01.308+08:00 DEBUG 4250 --- [client-application] [nio-8080-exec-2] [29e0fac8ee9435452ddc0e91ac67b652-9c95bddc85f879bb] s.n.www.protocol.http.HttpURLConnection  : sun.net.www.MessageHeader@10ce6bfd 8 pairs: {POST /token HTTP/1.1: null}{Accept: application/json;charset=UTF-8}{Content-Type: application/x-www-form-urlencoded;charset=UTF-8}{...5}{User-Agent: Java/23}{Host: ....com}{Connection: keep-alive}{Content-Length: 76}\n2025-01-09T23:59:01.420+08:00 DEBUG 4250 --- [client-application] [nio-8080-exec-2] [29e0fac8ee9435452ddc0e91ac67b652-9c95bddc85f879bb] s.n.www.protocol.http.HttpURLConnection  : sun.net.www.MessageHeader@67f01113 13 pairs: {null: HTTP/1.1 200}{Date: Thu, 09 Jan 2025 15:59:01 GMT}{Content-Type: application/json;charset=UTF-8}{Transfer-Encoding: chunked}{Connection: keep-alive}{Vary: origin,access-control-request-method,access-control-request-headers,accept-encoding}{X-Content-Type-Options: nosniff}{X-XSS-Protection: 0}{Cache-Control: no-cache, no-store, max-age=0, must-revalidate}{Pragma: no-cache}{Expires: 0}{Strict-Transport-Security: max-age=31536000 ; includeSubDomains}{X-Frame-Options: DENY}\n2025-01-09T23:59:01.420+08:00 DEBUG 4250 --- [client-application] [nio-8080-exec-2] [29e0fac8ee9435452ddc0e91ac67b652-9c95bddc85f879bb] o.s.web.client.RestTemplate              : Response 200 OK\n2025-01-09T23:59:01.421+08:00 DEBUG 4250 --- [client-application] [nio-8080-exec-2] [29e0fac8ee9435452ddc0e91ac67b652-9c95bddc85f879bb] o.s.web.client.RestTemplate              : Reading to [org.springframework.security.oauth2.core.endpoint.OAuth2AccessTokenResponse] as &quot;application/json;charset=UTF-8&quot;\n</code></pre>\n<p>From the log, it seems there is an internal usage on a RestTemplate.</p>\n<p>Questions:</p>\n<ul>\n<li><p>How to have observability (traces, but also the metrics) with solution 2?</p>\n</li>\n<li><p>Most of all, how to pass my own <code>RestClient</code> (not <code>RestTemplate</code>, not <code>WebClient</code>) for the token call?</p>\n</li>\n</ul>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}