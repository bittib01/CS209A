{
  "question": {
    "tags": [
      "java",
      "c++",
      "c++17",
      "java-native-interface",
      "java-21"
    ],
    "owner": {
      "account_id": 9660706,
      "reputation": 386,
      "user_id": 7168877,
      "user_type": "registered",
      "accept_rate": 100,
      "profile_image": "https://i.sstatic.net/kieuF.png?s=256",
      "display_name": "Stew",
      "link": "https://stackoverflow.com/users/7168877/stew"
    },
    "is_answered": false,
    "view_count": 268,
    "answer_count": 1,
    "score": -1,
    "last_activity_date": 1721974829,
    "creation_date": 1721651388,
    "last_edit_date": 1721733734,
    "question_id": 78778717,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78778717/jni-callstaticobjectmethod-is-causing-crash-with-java-21",
    "title": "JNI CallStaticObjectMethod is causing crash with Java 21",
    "body": "<p>The company I work for recently moved to Java 21 from Java 8, which updated the JNI version as well that is used with interoperatibility with C++. All the function (written in C++) called through JNI work fine on Java 8, but\nthe function <code>CallStaticObjectMethod</code> is throwing Access Violation exception and causing crash.</p>\n<p>This function is used to call a static method on Java side.</p>\n<p>The function which invokes <code>CallStaticObjectMethod</code> is as below:</p>\n<pre><code>jobject Bindings::ToSystemArchObj(JNIEnv* env, const std::string&amp; arch)\n{\n    if (env == nullptr || arch == ARCH_UNSUPPORTED)\n    {\n        return nullptr;\n    }\n    jobject jstr = env-&gt;NewStringUTF(arch.c_str()); // I have tried converting the type of jstr from jobject to jstring\n\n    processArchObj = env-&gt;CallStaticObjectMethod(JniProcessInfoDTO::SystemArchClass, JniProcessInfoDTO::ofMethodId, jstr); // THIS LINE IS THROWING access violation and causing crash\n\n\n    return processArchObj;\n}\n</code></pre>\n<p>The <code>JniProcessInfoDTO::SystemArchClass</code> and <code>JniProcessInfoDTO::ofMethodId</code> argument for this function are being initialized in a separate function which is below:</p>\n<pre><code>void JniProcessInfoDTO::initClass(JNIEnv* env)\n{\n    jclass const localProcessInfoDTO = env-&gt;FindClass(JavaTypes::ProcessInfoDTO.c_str());\n    ProcessInfoDTORef = reinterpret_cast&lt;jclass&gt;(env-&gt;NewGlobalRef(localProcessInfoDTO));\n    initFieldIDs(env);\n    // std::string const SystemArch = &quot;Lcom/company/mfw/model/dto/SystemArch;&quot;;\n    SystemArchClass = env-&gt;FindClass(JavaTypes::SystemArch.c_str());\n    \n    // (Ljava/lang/String;)Lcom/company/mfw/model/dto/SystemArch;\n    const std::string ofSign = &quot;(&quot; + JavaTypes::String + &quot;)&quot; + JavaTypes::SystemArch; //// std::string const String = &quot;java/lang/String;&quot;;\n\n    ofMethodId = env-&gt;GetStaticMethodID(SystemArchClass, &quot;of&quot;, ofSign.c_str());\n}\n</code></pre>\n<p>The Java side static function <code>do</code> which is supposed to get called looks like below:</p>\n<pre><code>package com.company.mfw.model.dto;\n\npublic enum SystemArch {\n\n    X86, X86_64, UNSUPPORTED;\n\n    public static SystemArch of(String arch) {\n        try {\n            return SystemArch.valueOf(arch);\n        } catch (Exception ignored) {\n            return UNSUPPORTED;\n        }\n    }\n\n}\n</code></pre>\n<p>The JNI is being loaded and unloaded in the following way:</p>\n<pre><code>extern &quot;C&quot;\n{\n    // cppcheck-suppress unusedFunction\n    JNIEXPORT jint JNICALL JNI_OnLoad(JavaVM* vm, void*)\n    {\n        // This is an entry point for initialization of Java classes.\n        // All required Java classes must exist and must be initialized here.\n        // JNI_OnLoad must not be wrapped with Safe Environment.\n        // JVM should be crashed in case of exceptions here.\n        \n\n        JniGlobals::JVMConnector::InitJavaVM(vm);\n\n        JavaVMAttachArgs args;\n        args.version = JNI_VERSION_21;\n        args.name = nullptr;\n        args.group = nullptr;\n        JNIEnv* env = nullptr;\n\n        vm-&gt;AttachCurrentThread((void**)&amp;env, &amp;args);\n        JniContext::Current().JniEnv = env;\n        JniGlobals::unmaskFPSR();\n\n        GdiplusStartup(&amp;JniGlobals::gdiplusToken, &amp;JniGlobals::gdiplusStartupInput, nullptr);\n\n        Bindings::JniComponentDTO::initClass(env);\n        Bindings::JniWindowDTO::initClass(env);\n        Bindings::JniPointDTO::initClass(env);\n        Bindings::JniDimensionDTO::initClass(env);\n        Bindings::JniRectangleDTO::initClass(env);\n        Bindings::JniProcessInfoDTO::initClass(env); \n        Bindings::JniProcessStartupInfoDTO::initClass(env);\n        Bindings::JniProcessEndInfoDTO::initClass(env);\n        Bindings::JniKeyDTO::initClass(env);\n        Bindings::JniNativeMouseEvent::initClass(env);\n        Bindings::JniNativeKeyEvent::initClass(env);\n        Bindings::JniHooksSettings::initClass(env);\n        Bindings::WinSessionDTO::initClass(env);\n\n        JniGlobals::TimeManager::GetInstance().InitJavaHandlers(env);\n\n        JniGlobals::JavaObjectFactory::JavaObjectFactoryClass = env-&gt;FindClass(&quot;com/company/mfw/bridge/internal/JavaObjectsFactory&quot;);\n        JniGlobals::JavaObjectFactory::NewStringMethodID\n            = env-&gt;GetStaticMethodID(JniGlobals::JavaObjectFactory::JavaObjectFactoryClass, &quot;newString&quot;, &quot;([B)Ljava/lang/String;&quot;);\n\n        Log::GetInstance().Init();\n\n        LOG_TRACE(L&quot;BEGIN&quot;);\n        auto osInfo = JniGlobals::WindowsSystemInfo::GetInstance().ReadOsInfo();\n        std::string csd(osInfo.szCSDVersion);\n        LOG_INFO(L&quot;System info. Version: {}.{}, Build: {}, Platform ID: {}, CSD Version: {}&quot;, (int)osInfo.dwMajorVersion,\n                 (int)osInfo.dwMinorVersion, (int)osInfo.dwBuildNumber, (int)osInfo.dwPlatformId,\n                 csd.length() &gt; 0 ? StringsConverter::StringToWstring(csd) : L&quot;&lt;empty&gt;&quot;);\n\n        return JNI_VERSION_21;\n    }\n\n    // cppcheck-suppress unusedFunction\n    JNIEXPORT void JNICALL JNI_OnUnload(JavaVM*, void*)\n    {\n        LOG_TRACE(L&quot;BEGIN&quot;);\n\n        Gdiplus::GdiplusShutdown(JniGlobals::gdiplusToken);\n\n        JNIEnv* env = JniContext::Current().JniEnv;\n        Bindings::JniComponentDTO::releaseClass(env);\n        Bindings::JniWindowDTO::releaseClass(env);\n        Bindings::JniPointDTO::releaseClass(env);\n        Bindings::JniDimensionDTO::releaseClass(env);\n        Bindings::JniRectangleDTO::releaseClass(env);\n        Bindings::JniProcessInfoDTO::releaseClass(env);\n        Bindings::JniProcessStartupInfoDTO::releaseClass(env);\n        Bindings::JniProcessEndInfoDTO::releaseClass(env);\n        Bindings::JniKeyDTO::releaseClass(env);\n        Bindings::JniNativeMouseEvent::releaseClass(env);\n        Bindings::JniNativeKeyEvent::releaseClass(env);\n        Bindings::JniHooksSettings::releaseClass(env);\n        Bindings::WinSessionDTO::releaseClass(env);\n    }\n\n} // extern &quot;C&quot;\n</code></pre>\n<p>The JNI documentation does not contain any information about this function. Can anyone help me here?</p>\n<p><strong>UPDATE 1: All the other JNI methods work fine only this one is causing crash</strong></p>\n<p><strong>UPDATE 2</strong> All these functions are called to convert a C++ object type to Java type. The <code>Bindings::ToSystemArchObj</code> method is being called by the method which is doing this <em>type conversion</em> here:</p>\n<pre><code>/**\n * Converts a ProcessInfoPtr to a Java ProcessInfoDTO object.\n *\n * @param env The JNI environment pointer.\n * @param pi The ProcessInfoPtr object.\n * @return The corresponding Java ProcessInfoDTO object or nullptr if the environment or ProcessInfoPtr is null.\n */\njobject Bindings::ToJavaType(JNIEnv* env, ProcessInfoPtr pi)\n{\n    if (env == nullptr || pi == nullptr)\n    {\n        return nullptr;  // Return nullptr if environment or ProcessInfoPtr is null\n    }\n\n    jobject joProcessInfoDTO = env-&gt;AllocObject(JniProcessInfoDTO::ProcessInfoDTORef);  // Allocate a new ProcessInfoDTO object\n\n    env-&gt;SetIntField(joProcessInfoDTO, JniProcessInfoDTO::processPidFieldId, pi-&gt;pid);  // Set process PID field\n    env-&gt;SetIntField(joProcessInfoDTO, JniProcessInfoDTO::processParentPidFieldId, pi-&gt;parentPid);  // Set process parent PID field\n\n    env-&gt;SetObjectField(joProcessInfoDTO, JniProcessInfoDTO::processChildProcessFieldId, ToJavaType(env, pi-&gt;childProcesses));  // Set child processes field\n\n    env-&gt;SetObjectField(joProcessInfoDTO, JniProcessInfoDTO::processCommandLineFieldId, ToJavaType(env, pi-&gt;commandLine));  // Set command line field\n    env-&gt;SetObjectField(joProcessInfoDTO, JniProcessInfoDTO::processNameFieldId, ToJavaType(env, pi-&gt;name));  // Set process name field\n    env-&gt;SetObjectField(joProcessInfoDTO, JniProcessInfoDTO::processOwnerFieldId, ToJavaType(env, pi-&gt;owner));  // Set process owner field\n\n    env-&gt;SetIntField(joProcessInfoDTO, JniProcessInfoDTO::processResidentBytesFieldId, pi-&gt;residentBytes);  // Set resident bytes field\n    env-&gt;SetIntField(joProcessInfoDTO, JniProcessInfoDTO::processTotalBytesFieldId, pi-&gt;totalBytes);  // Set total bytes field\n    env-&gt;SetIntField(joProcessInfoDTO, JniProcessInfoDTO::processSystemMillsFieldId, pi-&gt;systemMillis);  // Set system milliseconds field\n    env-&gt;SetIntField(joProcessInfoDTO, JniProcessInfoDTO::processUserMillsFieldId, pi-&gt;userMillis);  // Set user milliseconds field\n\n    env-&gt;SetObjectField(joProcessInfoDTO, JniProcessInfoDTO::processArchFieldId, ToSystemArchObj(env, pi-&gt;arch));  // Set process architecture field\n\n    return joProcessInfoDTO;  // Return the ProcessInfoDTO object\n}\n</code></pre>\n<p>The above function is trying to convert <code>ProcessInfo</code> to a Java <code>ProcessInfoDTO</code> object. ProcessInfo type is as below.</p>\n<pre><code>class ProcessInfo\n{\npublic:\n    ProcessInfo()\n        : pid(-1), parentPid(0), commandLine(L&quot;&quot;), name(L&quot;&quot;), owner(L&quot;&quot;), residentBytes(0), totalBytes(0), systemMillis(0), userMillis(0),\n          arch(&quot;&quot;)\n    {\n        childProcesses.resize(0);\n    };\n\n    ~ProcessInfo() = default;\n\npublic:\n    int pid;\n    int parentPid;\n    std::vector&lt;int&gt; childProcesses;\n    std::wstring commandLine;\n    std::wstring name;\n    std::wstring owner;\n\n    long residentBytes;\n    long totalBytes;\n    long systemMillis;\n    long userMillis;\n\n    std::string arch;\n};\n</code></pre>\n<p>and part of <code>ProcessInfoDTO</code> type is as below:</p>\n<pre><code>public class ProcessInfoDTO {\n\n    private static final long serialVersionUID = -212324578578245L;\n\n    private int pid;\n    private int parentPid;\n    private String commandLine;\n    private String name;\n    private String owner;\n    private int[] childProcesses;\n\n    private long residentBytes;\n    private long totalBytes;\n    private long systemMillis;\n    private long userMillis;\n\n    private SystemArch arch;\n\n    public int getPid() {\n        return pid;\n    }\n\n    public void setPid(int pid) {\n        this.pid = pid;\n    }\n    // Some more function definitions\n    // Some more function definitions\n}\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}