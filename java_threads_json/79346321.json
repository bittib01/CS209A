{
  "question": {
    "tags": [
      "java",
      "android",
      "ringtone"
    ],
    "owner": {
      "account_id": 461547,
      "reputation": 3316,
      "user_id": 863311,
      "user_type": "registered",
      "accept_rate": 62,
      "profile_image": "https://www.gravatar.com/avatar/3731c7120e30182ebf4f3fbb8609468a?s=256&d=identicon&r=PG",
      "display_name": "Simon",
      "link": "https://stackoverflow.com/users/863311/simon"
    },
    "is_answered": false,
    "view_count": 47,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1738569869,
    "creation_date": 1736525825,
    "question_id": 79346321,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79346321/change-ringtone-while-already-ringing-in-android-app",
    "title": "Change ringtone while already ringing in Android app",
    "body": "<p>From various SO posts I've put together code to change the ringtone depending on some app settings. A <code>BroadcastReceiver</code> subclass makes sure notifications are received and gets to pick up the incoming phone number:</p>\n<pre><code>public class IncomingCallFilter extends BroadcastReceiver {\n\n    @Override\n    public void onReceive(final Context context, Intent intent) {\n        if (TelephonyManager.ACTION_PHONE_STATE_CHANGED.equals(intent.getAction())) {\n            Log.d(&quot;onReceive@&quot; + hashCode(), &quot;Phone state changed&quot;);\n            Optional.ofNullable(intent.getExtras())\n                    .map(extras -&gt; extras.getString(TelephonyManager.EXTRA_INCOMING_NUMBER))\n                    .filter(s -&gt; !s.isEmpty())\n                    .ifPresent(number -&gt; {\n                        final RingtoneTelephonyCallback telephonyCallback = new RingtoneTelephonyCallback(context, number);\n                        final TelephonyManager telephony = (TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE);\n                        Log.d(&quot;onReceive&quot;, &quot;Registering new TelephonyCallback&quot;);\n                        telephony.registerTelephonyCallback(context.getMainExecutor(), telephonyCallback);\n                        // note that RingtoneTelephonyCallback unregisters itself on TelephonyManager.CALL_STATE_IDLE\n                    });\n        }\n    }\n}\n</code></pre>\n<p>The <code>RingtoneTelephonyCallback</code> then handles the actual switch of the ringtone:</p>\n<pre><code>        final String ringtonePreference = sharedPreferences.getString(Constants.KEY_RINGTONE_PREFERENCE, Settings.System.DEFAULT_NOTIFICATION_URI.toString());\n        final Uri ringtoneUri = Constants.SILENT_VALUE.equals(ringtonePreference) ? null : Uri.parse(ringtonePreference);\n        defaultRingTone = RingtoneManager.getActualDefaultRingtoneUri(context, RingtoneManager.TYPE_RINGTONE);\n        if (!Objects.equals(ringtoneUri, defaultRingTone) &amp;&amp; Settings.System.canWrite(context)) {\n            Log.d(&quot;dynamicRingtone@&quot; + hashCode(), &quot;Switching ringtone for number &quot; + incomingNumber + &quot; to &quot; + ringtoneUri);\n            RingtoneManager.setActualDefaultRingtoneUri(context, RingtoneManager.TYPE_RINGTONE, ringtoneUri);\n            needsRingtoneRevert = true;\n        }\n</code></pre>\n<p>Running this in Android Studio on an emulated phone works, the logcat output shows</p>\n<pre><code>2025-01-10 15:47:31.839 12950-12950 onReceive@70713570      ch.want.dynamicringtone              D  Phone state changed\n2025-01-10 15:47:31.844 12950-12950 onReceive@243035251     ch.want.dynamicringtone              D  Phone state changed\n2025-01-10 15:47:31.845 12950-12950 RingtoneTe...@133654320 ch.want.dynamicringtone              D  Created\n2025-01-10 15:47:31.846 12950-12950 onReceive               ch.want.dynamicringtone              D  Registering new TelephonyCallback\n2025-01-10 15:47:31.864 12950-12950 RingtoneTe...@133654320 ch.want.dynamicringtone              D  Got new call state 1\n2025-01-10 15:47:31.885 12950-12950 dynamicRin...@133654320 ch.want.dynamicringtone              D  Switching ringtone for number 6505551212 to content://media/external_primary/audio/media/1000000065?title=Gentle%20Gong&amp;canonical=1\n...\n2025-01-10 15:47:36.960 12950-12950 RingtoneTe...@133654320 ch.want.dynamicringtone              D  Got new call state 0\n2025-01-10 15:47:36.963 12950-12950 dynamicRin...@133654320 ch.want.dynamicringtone              D  Switching ringtone back to content://media/external_primary/audio/media/1000000072?title=Your%20New%20Adventure&amp;canonical=1\n</code></pre>\n<p>and the desired &quot;Gentle Gong&quot; ringtone plays. Doing the same on a physical device results in pretty much the same logcat</p>\n<pre><code>2025-01-10 15:55:40.426 28222-28222 onReceive@102975571     ch.want.dynamicringtone              D  Phone state changed\n2025-01-10 15:55:40.448 28222-28222 onReceive@4277648       ch.want.dynamicringtone              D  Phone state changed\n2025-01-10 15:55:40.452 28222-28222 RingtoneTe...@207400585 ch.want.dynamicringtone              D  Created\n2025-01-10 15:55:40.452 28222-28222 onReceive               ch.want.dynamicringtone              D  Registering new TelephonyCallback\n2025-01-10 15:55:40.480 28222-28222 ActivityThread          ch.want.dynamicringtone              I  Performing receive of Intent { act=android.intent.action.PHONE_STATE flg=0x1000010 cmp=ch.want.dynamicringtone/.IncomingCallFilter (has extras) }: app=android.app.Application@b9016af, appName=ch.want.dynamicringtone, pkg=ch.want.dynamicringtone, comp={ch.want.dynamicringtone/ch.want.dynamicringtone.IncomingCallFilter}, dir=/data/app/~~MLS6TUSSv0EmvwgrNDKu0A==/ch.want.dynamicringtone-q3qpKiYRDyW7_aMt5CtnFg==/base.apk, duration=31\n2025-01-10 15:55:40.480 28222-28222 RingtoneTe...@207400585 ch.want.dynamicringtone              D  Got new call state 1\n2025-01-10 15:55:40.514 28222-28222 RingtoneManager         ch.want.dynamicringtone              D  getActualDefaultRingtoneUri+uriString=content://0@media/external/audio/media/1000034473?title=Black%20Woodpecker%20(Dryocopus%20martius)&amp;canonical=1,type=1\n2025-01-10 15:55:40.515 28222-28222 dynamicRin...@207400585 ch.want.dynamicringtone              D  Switching ringtone for number 01416287667 to content://media/external/audio/media/85?title=Calm&amp;canonical=1\n2025-01-10 15:55:40.536 28222-28222 RingtoneManager         ch.want.dynamicringtone              D  setActualDefaultRingtoneUri,ringtoneUri=content://media/external/audio/media/85?title=Calm&amp;canonical=1,type=1, forceIgnoreSyncParent: false\n2025-01-10 15:55:40.573 28222-28222 RingtoneManager         ch.want.dynamicringtone              D  [saveRingtoneCacheTitle]: Calm, setting: ringtone, type: 1\n2025-01-10 15:55:40.573 28222-28222 RingtoneManager         ch.want.dynamicringtone              D  [loadRingtoneCacheTitle] Uri: content://0@settings/system/ringtones_title_cache\n2025-01-10 15:55:40.577 28222-28222 RingtoneManager         ch.want.dynamicringtone              D  [loadRingtoneCacheTitle] data[0]: ringtone ,data[1]: Black Woodpecker (Dryocopus martius)\n2025-01-10 15:55:40.577 28222-28222 RingtoneManager         ch.want.dynamicringtone              D  [loadRingtoneCacheTitle] data[0]: notification_sound ,data[1]: NewMailVip\n2025-01-10 15:55:40.577 28222-28222 RingtoneManager         ch.want.dynamicringtone              D  [loadRingtoneCacheTitle] data[0]: alarm_alert ,data[1]: BusyBugs\n2025-01-10 15:55:40.577 28222-28222 RingtoneManager         ch.want.dynamicringtone              D  [loadRingtoneCacheTitle] data[0]: ringtone_2 ,data[1]: Black Woodpecker (Dryocopus martius)\n2025-01-10 15:55:40.933  1237-1339  ANDR-PERF-OPTSHANDLER   ven...qti.hardware.perf@2.2-service  E  thermal_pol, detect_fps = 7, avg_fps=3, topApp=ch.want.dynamicringtone\n...\n2025-01-10 15:55:48.933 28222-28222 RingtoneTe...@207400585 ch.want.dynamicringtone              D  Got new call state 0\n2025-01-10 15:55:48.934 28222-28222 dynamicRin...@207400585 ch.want.dynamicringtone              D  Switching ringtone back to content://media/external/audio/media/1000034473?title=Black%20Woodpecker%20(Dryocopus%20martius)&amp;canonical=1\n</code></pre>\n<p>However the phone keeps ringing with the system default &quot;Black Woodpecker&quot; instead of the desired &quot;Calm&quot;.</p>\n<p>The logcat output tells me that the code is running as expected, <code>RingtoneManager.setActualDefaultRingtoneUri()</code> is called with the changed ringtone. I assume at the time this happens on the physical device, Android just won't pick up that change anymore. I've looked through <a href=\"https://developer.android.com/reference/android/media/RingtoneManager\" rel=\"nofollow noreferrer\">https://developer.android.com/reference/android/media/RingtoneManager</a> and can't find any way to &quot;force&quot; a ringtone update. Is this simply not possible?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}