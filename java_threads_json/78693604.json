{
  "question": {
    "tags": [
      "java",
      "spring",
      "testing",
      "reflection",
      "dependencies"
    ],
    "owner": {
      "account_id": 31721814,
      "reputation": 33,
      "user_id": 24538254,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/1a7ba5d274a87343dcbb8b3652b94b14?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "user24538254",
      "link": "https://stackoverflow.com/users/24538254/user24538254"
    },
    "is_answered": false,
    "view_count": 73,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1722955937,
    "creation_date": 1719856618,
    "last_edit_date": 1722955937,
    "question_id": 78693604,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78693604/testing-multiple-classes-with-dependencies-using-reflection",
    "title": "Testing multiple classes with dependencies using reflection",
    "body": "<p>We're recently building a java compiler for college and need to test our compiled files with java reflection. I've had no problem with this tool until now. We need to test if multiple files with dependencies to each other are working. So we have two <code>byte[]</code>, one of them contains the class I want to test, and the other contains a class from which the first one has an object (down below). I want to generate a <code>Class&lt;?&gt;</code> object out of these files on which I can execute methods like <code>getDeclaredConstructors()</code>. The <code>Class&lt;?&gt;</code> object should contain the first class. But I can't figure out how to make it work. Can you help me?</p>\n<p>These are the two example files I want to inspect the generated bytecode (generating the bytecode works fine):</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class MultipleClasses1 {\n    MultipleClasses2 anotherClass;\n\n    public MultipleClasses1() {\n        this.anotherClass = new MultipleClasses2();\n    }\n\n    public int getIFromAnotherClass() {\n        return this.anotherClass.i;\n    }\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>public class MultipleClasses2 {\n    int i;\n\n    public MultipleClasses2() {\n        this.i = 4;\n    }\n}\n</code></pre>\n<p>This is the file that helps me to get the Class&lt;?&gt; object:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class BytecodeTestUtil {\n\n    private final Class&lt;?&gt; clazz;\n    private final Object instance;\n    private static final Logger LOGGER = Logger.getLogger(BytecodeTestUtil.class.getName());\n\n    public BytecodeTestUtil(List&lt;String&gt; sourceFilePaths, String className) throws Exception {\n        byte[] resultBytecode = new byte[0];\n        for (byte[] bytecode : Compiler.generateByteCodeArrayFromFiles(sourceFilePaths)) {\n            int neededLength = resultBytecode.length + bytecode.length;\n            byte[] result = new byte[neededLength];\n            System.arraycopy(resultBytecode, 0, result, 0, resultBytecode.length);\n            System.arraycopy(bytecode, 0, result, resultBytecode.length, bytecode.length);\n            resultBytecode = result;\n        }\n\n        byte[] finalResultBytecode = resultBytecode;\n        ClassLoader classLoader = new ClassLoader() {\n            @Override\n            protected Class&lt;?&gt; findClass(String name) {\n                return defineClass(name, finalResultBytecode, 0, finalResultBytecode.length);\n            }\n        };\n\n        try {\n            clazz = classLoader.loadClass(className);\n            this.instance = clazz.getDeclaredConstructor().newInstance();\n        } catch (ClassNotFoundException | SecurityException | NoSuchMethodException e) {\n            LOGGER.log(Level.SEVERE, &quot;Exception occur&quot;, e);\n            throw new RuntimeException(e);\n        }\n    }\n}\n</code></pre>\n<p>As you see I have tried to just put the code of both classes in one <code>byte[]</code>, but on compilation I get the error <code>java.lang.ClassFormatError: Extra bytes at the end of class file MultipleClasses1</code></p>\n<p>If I just load the classfile for class<code> MultipleClasses1</code> I get the exception <code>java.lang.NoClassDefFoundError: MultipleClasses2 (wrong name: MultipleClasses1)</code></p>\n<p>I also tried to put up this custom ClassLoader:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class ByteClassLoader extends ClassLoader {\n\n    // Map to store the class name and its corresponding byte array\n    private final Map&lt;String, byte[]&gt; classesBytes = new HashMap&lt;&gt;();\n\n    public ByteClassLoader() {\n        super(ClassLoader.getSystemClassLoader());\n    }\n\n    // Method to add a class byte array to the loader\n    public void addClass(String name, byte[] classData) {\n        classesBytes.put(name, classData);\n    }\n\n    @Override\n    protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException {\n        byte[] classData = classesBytes.get(name);\n        if (classData == null) {\n            throw new ClassNotFoundException(name);\n        }\n        return defineClass(name, classData, 0, classData.length);\n    }\n}\n</code></pre>\n<p>But that did't solve my either.</p>\n<p>Do you have any other Ideas?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}