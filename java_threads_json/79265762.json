{
  "question": {
    "tags": [
      "java",
      "windows",
      "swing",
      "remote-desktop",
      "headless"
    ],
    "owner": {
      "account_id": 1416081,
      "reputation": 310,
      "user_id": 1341731,
      "user_type": "registered",
      "profile_image": "https://i.sstatic.net/W1sKg.png?s=256",
      "display_name": "Michael Conrad",
      "link": "https://stackoverflow.com/users/1341731/michael-conrad"
    },
    "is_answered": true,
    "view_count": 648,
    "answer_count": 3,
    "score": 7,
    "last_activity_date": 1736350496,
    "creation_date": 1733762227,
    "last_edit_date": 1734363228,
    "question_id": 79265762,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79265762/java-windows-rdp-disconnect-causes-java-headless-exception",
    "title": "Java + Windows RDP disconnect causes Java Headless Exception",
    "body": "<p>Starting with Java 17.0.12 and 21.0.4 Java fails with a Headless exception when running a full GUI app via RDP and the RDP session is disconnected. The remote desktop is running and can be reconnected with. All non-Java apps are still running and updating their UI's just fine. It is only Java GUI apps that are crashing.</p>\n<p>If the Java program attempts to do GUI operations such as create a modal progress bar while the RDP session is disconnected, a Headless exception is thrown, even though <strong>the environment is not headless</strong>, just disconnected.</p>\n<p>This seems to be related to <a href=\"https://bugs.openjdk.org/browse/JDK-8340992\" rel=\"nofollow noreferrer\">https://bugs.openjdk.org/browse/JDK-8340992</a> and <a href=\"https://bugs.openjdk.org/browse/JDK-8336862\" rel=\"nofollow noreferrer\">https://bugs.openjdk.org/browse/JDK-8336862</a> but there are no workarounds provided.</p>\n<p>Is there a workaround that can be done runtime?</p>\n<p>The only workarounds we can come up with are:</p>\n<ol>\n<li>Rewrite everything in another language. Not a small undertaking.</li>\n<li>Downgrade all Java/JDK instances to 21.0.3 and not apply any security updates.</li>\n<li>Lose all work and start over for any RDP disconnects caused by intentional user disconnect, internet issues, etc. This is where we are at now and it is causing production issues.</li>\n</ol>\n<p>This would also seem to be breaking of the &quot;contract&quot; where minor point releases are not supposed to cause breaking changes.</p>\n<p>We mostly use simple apps composed of <code>JFrames</code>, <code>JTextComponents</code>, and <code>ProgressMonitor</code> with a couple of self-hosted <code>JediTerm</code> applications.</p>\n<p>Code demonstrating issue. MUST RUN IN RDP SESSION:</p>\n<pre class=\"lang-java prettyprint-override\"><code>import javax.swing.*;\nimport java.awt.*;\n\n//TIP To &lt;b&gt;Run&lt;/b&gt; code, press &lt;shortcut actionId=&quot;Run&quot;/&gt; or\n// click the &lt;icon src=&quot;AllIcons.Actions.Execute&quot;/&gt; icon in the gutter.\npublic class Main {\n    public static void main(String[] args) throws InterruptedException {\n        var delay = 10;\n        var isHeadless = GraphicsEnvironment.isHeadless();\n        System.out.printf(&quot;1) Is headless: %s.%n&quot;, isHeadless);\n        System.out.printf(&quot;Sleeping %,d seconds.%n&quot;, delay);\n        System.out.printf(&quot;&quot;&quot;\n                DISCONNECT YOUR REMOTE DESKTOP CONNECTION NOW!\n                RECONNECT AFTER %,d SECONDS.\n                &quot;&quot;&quot;, delay);\n        Thread.sleep(delay * 1_000);\n        System.out.println(&quot;Drawing progress bar&quot;);\n        ProgressMonitor p = new ProgressMonitor(null, &quot;Test progressbar&quot;, &quot;My note&quot;, 0, 100);\n        for (int i = 0; i &lt; 100; i++) {\n            p.setProgress(i);\n            Thread.sleep(250);\n        }\n        isHeadless = GraphicsEnvironment.isHeadless();\n        System.out.printf(&quot;2) Is headless: %s.%n&quot;, isHeadless);\n\n        //TIP Press &lt;shortcut actionId=&quot;ShowIntentionActions&quot;/&gt; with your caret at the highlighted text\n        // to see how IntelliJ IDEA suggests fixing it.\n        System.out.printf(&quot;Hello and welcome!&quot;);\n\n        for (int i = 1; i &lt;= 5; i++) {\n            //TIP Press &lt;shortcut actionId=&quot;Debug&quot;/&gt; to start debugging your code. We have set one &lt;icon src=&quot;AllIcons.Debugger.Db_set_breakpoint&quot;/&gt; breakpoint\n            // for you, but you can always add more by pressing &lt;shortcut actionId=&quot;ToggleLineBreakpoint&quot;/&gt;.\n            System.out.println(&quot;i = &quot; + i);\n        }\n    }\n}\n</code></pre>\n<p>Errors:</p>\n<pre class=\"lang-java prettyprint-override\"><code>&quot;C:\\Program Files\\Eclipse Adoptium\\jdk-21.0.5.11-hotspot\\bin\\java.exe&quot; &quot;-javaagent:C:\\Program Files\\JetBrains\\IntelliJ IDEA 2024.3.1\\lib\\idea_rt.jar=59072:C:\\Program Files\\JetBrains\\IntelliJ IDEA 2024.3.1\\bin&quot; -Dfile.encoding=UTF-8 -Dsun.stdout.encoding=UTF-8 -Dsun.stderr.encoding=UTF-8 -classpath C:\\Users\\admin.NEWSRX\\git\\rdp-crashes\\out\\production\\rdp-crashes Main\nPicked up JAVA_TOOL_OPTIONS: -Xmx6144m -Dlog4j2.formatMsgNoLookups=true\n1) Is headless: false.\nSleeping 10 seconds.\nDISCONNECT YOUR REMOTE DESKTOP CONNECTION NOW!\nRECONNECT AFTER 10 SECONDS.\nDrawing progress bar\nException in thread &quot;main&quot; java.awt.AWTError: no screen devices\n    at java.desktop/sun.awt.Win32GraphicsEnvironment.getDefaultScreenDevice(Win32GraphicsEnvironment.java:101)\n    at java.desktop/sun.font.FontDesignMetrics.getDefaultFrc(FontDesignMetrics.java:157)\n    at java.desktop/sun.font.FontDesignMetrics.getMetrics(FontDesignMetrics.java:274)\n    at java.desktop/sun.swing.SwingUtilities2.getFontMetrics(SwingUtilities2.java:1242)\n    at java.desktop/javax.swing.JComponent.getFontMetrics(JComponent.java:1700)\n    at java.desktop/javax.swing.plaf.basic.BasicGraphicsUtils.getPreferredButtonSize(BasicGraphicsUtils.java:360)\n    at java.desktop/javax.swing.plaf.basic.BasicButtonUI.getPreferredSize(BasicButtonUI.java:542)\n    at java.desktop/javax.swing.plaf.basic.BasicButtonUI.getMinimumSize(BasicButtonUI.java:532)\n    at java.desktop/javax.swing.JComponent.getMinimumSize(JComponent.java:1814)\n    at java.desktop/javax.swing.plaf.basic.BasicOptionPaneUI.addButtonComponents(BasicOptionPaneUI.java:818)\n    at java.desktop/javax.swing.plaf.basic.BasicOptionPaneUI.createButtonArea(BasicOptionPaneUI.java:751)\n    at java.desktop/javax.swing.plaf.basic.BasicOptionPaneUI.installComponents(BasicOptionPaneUI.java:206)\n    at java.desktop/javax.swing.plaf.basic.BasicOptionPaneUI.installUI(BasicOptionPaneUI.java:160)\n    at java.desktop/javax.swing.JComponent.setUI(JComponent.java:740)\n    at java.desktop/javax.swing.JOptionPane.setUI(JOptionPane.java:1858)\n    at java.desktop/javax.swing.JOptionPane.updateUI(JOptionPane.java:1880)\n    at java.desktop/javax.swing.JOptionPane.&lt;init&gt;(JOptionPane.java:1845)\n    at java.desktop/javax.swing.ProgressMonitor$ProgressOptionPane.&lt;init&gt;(ProgressMonitor.java:161)\n    at java.desktop/javax.swing.ProgressMonitor.setProgress(ProgressMonitor.java:291)\n    at Main.main(Main.java:20)\n\nProcess finished with exit code 1\n\n</code></pre>\n<h4>Additional Information</h4>\n<ul>\n<li>Environment: Multiple physical Windows 10 and Windows 11 machines with physical keyboards, physical mice, and physical monitors on a local Active Directory Domain.</li>\n<li>RDP: Windows Remote Desktop is used almost exclusively to access these <strong>physical</strong> systems.</li>\n<li>The bug appears to be in native code that changed between 21.0.3 and 21.0.4. I've not been able to develop a work around as monkey-patching is really not a Java feature.</li>\n<li>Forced Downgrade: We've downgraded all the physical Windows machines to 21.0.3 and the problem seems to have ceased.</li>\n</ul>\n<p>-Mike/NewsRx</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}