{
  "question": {
    "tags": [
      "java",
      "aws-lambda",
      "build.gradle",
      "graalvm",
      "micronaut-aws"
    ],
    "owner": {
      "account_id": 8056431,
      "reputation": 55,
      "user_id": 6073417,
      "user_type": "registered",
      "accept_rate": 50,
      "profile_image": "https://www.gravatar.com/avatar/9b1c582c92c9c0a04558c021410e8ae8?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "paxtuik",
      "link": "https://stackoverflow.com/users/6073417/paxtuik"
    },
    "is_answered": true,
    "view_count": 104,
    "accepted_answer_id": 79009674,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1726925528,
    "creation_date": 1726338843,
    "last_edit_date": 1726339831,
    "question_id": 78985886,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78985886/micronaut-graalvm-sendgrid-aws-lambda-application-keeps-getting-a-400-returned-f",
    "title": "Micronaut GraalVM Sendgrid AWS lambda application keeps getting a 400 returned from Sendgrid when trying to send email",
    "body": "<p>I built a simple emailing application using micronaut, java, and sendgrid. Using it as a basic java application deployed to AWS works, emails send\nfine. I have created another lambda to try using the GraalVM capabilities. I simply followed the Micronaut docs guid, everything compiles, and builds\nusing ./gradlew buildNativeLambda. Running the test option in the AWS console works and the application returns no errors, however sendgrid is sending\na 400 back. I feel I am missing something basic. I have tried adding everything I can think of to the\nresources/META-INF/native-image/reflect-config.json . Tried the different ways shown in the micronaut docs to run the lambda , i.e. using a Controller\nmethod, the FunctionRequestHandler , and FunctionLambdaRuntime. With each the lambda will work and it returns a string or APIGatewayProxyResponseEvent\nno problem. There seems to be something with building the email and I feel I have been just throwing sh*t at the wall at this point and nothing is\nsticking, no matter what i change I am not getting new error codes or anything to push me in the right direction.</p>\n<ul>\n<li>Current build.gradle - at this point it is super bloated, but like i said I have been stuck on trying to get this to work so I seem to just keep\nadding things in hope of something to change</li>\n</ul>\n<pre><code>    plugins {\n        id(&quot;com.github.johnrengelman.shadow&quot;) version &quot;8.1.1&quot;\n        id(&quot;io.micronaut.application&quot;) version &quot;4.4.2&quot;\n        id(&quot;com.diffplug.spotless&quot;) version &quot;6.23.3&quot;\n        id(&quot;io.micronaut.aot&quot;) version &quot;4.4.2&quot;\n    }\n    \n    version = &quot;0.1&quot;\n    group = &quot;example.micronaut&quot;\n    \n    repositories {\n        mavenCentral()\n    }\n    \n    dependencies {\n        annotationProcessor(&quot;io.micronaut:micronaut-http-validation&quot;)\n        annotationProcessor(&quot;io.micronaut.serde:micronaut-serde-processor&quot;)\n        implementation(&quot;io.micronaut.email:micronaut-email-sendgrid&quot;)\n        implementation(&quot;io.micronaut:micronaut-http-client-jdk&quot;)\n        implementation(&quot;jakarta.mail:jakarta.mail-api:2.1.3&quot;)\n        implementation(&quot;io.micronaut.aws:micronaut-aws-lambda-events-serde&quot;)\n        implementation(&quot;io.micronaut.serde:micronaut-serde-jackson&quot;)\n        runtimeOnly(&quot;org.yaml:snakeyaml&quot;)\n        runtimeOnly(&quot;ch.qos.logback:logback-classic&quot;)\n    }\n    \n    \n    application {\n        mainClass = &quot;example.micronaut.Application&quot;\n    }\n    java {\n        sourceCompatibility = JavaVersion.toVersion(&quot;17&quot;)\n        targetCompatibility = JavaVersion.toVersion(&quot;17&quot;)\n    }\n    \n    shadowJar {\n        // Ensure resources are included\n        mergeServiceFiles()\n        include 'EmailTemplate/**'\n    }\n    \n    sourceSets {\n        main {\n            resources {\n                srcDirs = ['src/main/resources']\n    //            include([ '**/*.properties', '**/*.yml', '**/*.json', '**/*.png', '**/*.html', '**/*.css','**/*.JPG'])\n            }\n        }\n    }\n    \n    graalvmNative {\n        toolchainDetection = false\n    \n        binaries {\n            main {\n                javaLauncher = javaToolchains.launcherFor {\n                    languageVersion = JavaLanguageVersion.of(17)\n                    vendor = JvmVendorSpec.matching(&quot;GraalVM Community&quot;)\n                }\n                resources.autodetect()\n                metadataRepository { enabled = true }\n                imageName.set('graal-mail')\n                buildArgs.add('--verbose')\n                buildArgs.add('--initialize-at-build-time=kotlin.coroutines.intrinsics.CoroutineSingletons')\n                buildArgs.add('--initialize-at-run-time=reactor.core.publisher.Traces$StackWalkerCallSiteSupplierFactory')\n                buildArgs.add('--initialize-at-run-time=reactor.core.publisher.Traces$ExceptionCallSiteSupplierFactory')\n            }\n        }\n    }\n    \n    micronaut {\n        runtime(&quot;lambda_provided&quot;)\n        testRuntime(&quot;junit5&quot;)\n        processing {\n            incremental(true)\n            annotations(&quot;example.micronaut.*&quot;)\n        }\n        aot {\n            // Please review carefully the optimizations enabled below\n            // Check https://micronaut-projects.github.io/micronaut-aot/latest/guide/ for more details\n            optimizeServiceLoading = false\n            convertYamlToJava = false\n            precomputeOperations = true\n            cacheEnvironment = true\n            optimizeClassLoading = true\n            deduceEnvironment = true\n            optimizeNetty = true\n            replaceLogbackXml = true\n        }\n    }\n    \n    \n    tasks.named(&quot;dockerfileNative&quot;) {\n        baseImage = &quot;amazonlinux:2023&quot;\n        jdkVersion = &quot;17&quot;\n        args(\n                &quot;-XX:MaximumHeapSizePercent=80&quot;,\n                &quot;-Dio.netty.allocator.numDirectArenas=0&quot;,\n                &quot;-Dio.netty.noPreferDirect=true&quot;\n        )\n    }\n    \n    spotless {\n        java {\n            licenseHeaderFile(file(&quot;LICENSEHEADER&quot;))\n        }\n    } \n</code></pre>\n<ul>\n<li>Email builder - again at this point I am throwing Annotations on things where they probably don 't need to be, but nothing seems to affect it, the app runs but from the lambda GraalVM the emails aren' t sending right</li>\n</ul>\n<pre class=\"lang-java prettyprint-override\"><code>    package example.micronaut.services\n    \n    import com.sendgrid.Response;\n    import example.micronaut.Util.MimeType;\n    import example.micronaut.Util.UtilMailService;\n    import io.micronaut.context.annotation.Value;\n    import io.micronaut.core.annotation.ReflectiveAccess;\n    import io.micronaut.email.BodyType;\n    import io.micronaut.email.Email;\n    import io.micronaut.email.sendgrid.SendgridEmailSender;\n    import jakarta.inject.Inject;\n    import jakarta.inject.Singleton;\n    import jakarta.mail.internet.MimeBodyPart;\n    \n    import java.util.Optional;\n    import java.util.concurrent.atomic.AtomicInteger;\n    \n    @Singleton\n    @ReflectiveAccess\n    public class TestCampaign {\n        private final UtilMailService utilMailService;\n        private final SendgridEmailSender sendgridEmailSender;\n    \n        @Value(&quot;${micronaut.email.from.email}&quot;)\n        private String fromEmail;\n    \n        @Inject\n        public TestCampaign(SendgridEmailSender sendgridEmailSender, UtilMailService utilMailService) {\n            this.sendgridEmailSender = sendgridEmailSender;\n            this.utilMailService = utilMailService;\n        }\n    \n        public Response sendTestEmail() throws Exception {\n            AtomicInteger index = new AtomicInteger(0);\n            Email.Builder emailBuilder = getEmailBuilder();\n    \n            utilMailService.getContacts(&quot;EmailTemplate/EmailListTest.json&quot;).forEach(contact -&gt; {\n                if (index.getAndIncrement() == 0) {\n                    emailBuilder.to(contact);\n                } else {\n                    emailBuilder.bcc(contact);\n                }\n            });\n    \n            return sendgridEmailSender.send(emailBuilder.build());\n        }\n    \n        private Email.Builder getEmailBuilder() throws Exception {\n            Optional&lt;String&gt; bodyOption = utilMailService.readHtmlFile(&quot;EmailTemplate/StdEmail.html&quot;);\n            String body = bodyOption.orElse(&quot;Be Aware of Your Prescriptions at work&quot;);\n            return Email.builder()\n                    .from(fromEmail)\n                    .subject(&quot;subject&quot;)\n                    .body(body, BodyType.HTML)\n                    .attachment(utilMailService.buildAttachment(&quot;EmailTemplate/Meds1.png&quot;, &quot;meds1.png&quot;, MimeBodyPart.ATTACHMENT, MimeType.IMAGE_PNG).build())\n                    .attachment(utilMailService.buildAttachment(&quot;EmailTemplate/Meds2.png&quot;, &quot;meds2.png&quot;, MimeBodyPart.ATTACHMENT, MimeType.IMAGE_PNG).build())\n                    .attachment(utilMailService.buildAttachment(&quot;EmailTemplate/Meds3.JPG&quot;, &quot;meds3.JPG&quot;, MimeBodyPart.ATTACHMENT, MimeType.IMAGE_JPEG).build())\n                    .attachment(utilMailService.buildAttachment(&quot;EmailTemplate/AllMeds.png&quot;, &quot;AllMeds.png&quot;, MimeBodyPart\n</code></pre>\n<ul>\n<li>Current util that adds contacts from a json file, attachments , and an html page from resources</li>\n</ul>\n<pre class=\"lang-java prettyprint-override\"><code>    package example.micronaut.Util;\n    \n    import io.micronaut.core.annotation.NonNull;\n    import io.micronaut.core.annotation.Nullable;\n    import io.micronaut.core.annotation.ReflectiveAccess;\n    import io.micronaut.core.io.IOUtils;\n    import io.micronaut.core.io.ResourceResolver;\n    import io.micronaut.core.type.Argument;\n    import io.micronaut.email.Attachment;\n    import io.micronaut.email.Contact;\n    import io.micronaut.serde.ObjectMapper;\n    import jakarta.inject.Inject;\n    import jakarta.inject.Singleton;\n    import jakarta.mail.internet.MimeBodyPart;\n    \n    import java.io.BufferedReader;\n    import java.io.IOException;\n    import java.io.InputStream;\n    import java.io.InputStreamReader;\n    import java.net.URL;\n    import java.util.*;\n    \n    @Singleton\n    @ReflectiveAccess\n    public class UtilMailService {\n        private final ResourceResolver resourceResolver;\n        private final ObjectMapper objectMapper;\n    \n    \n        @Inject\n        public UtilMailService(ResourceResolver resourceResolver, ObjectMapper objectMapper) {\n            this.objectMapper = objectMapper;\n            this.resourceResolver = resourceResolver;\n        }\n    \n        public @NonNull Attachment.Builder buildAttachment(String path, String name, String disposition, MimeType type) throws Exception {\n            Optional&lt;byte[]&gt; fileBytes = getClasspathResourceAsBytes(path);\n    \n            if (fileBytes.isEmpty()) {\n                throw new IllegalArgumentException(&quot;File not found! &quot; + path);\n            }\n    \n            Attachment.Builder newAttachment = Attachment.builder().filename(name).contentType(type.getMimeType()).content(fileBytes.get());\n    \n            if (Objects.equals(disposition, MimeBodyPart.INLINE)) {\n    \n                newAttachment.id(name).disposition(disposition);\n            }\n    \n            return newAttachment;\n        }\n    \n        public Optional&lt;byte[]&gt; getClasspathResourceAsBytes(String path) throws Exception {\n            Optional&lt;URL&gt; url = resourceResolver.getResource(&quot;classpath:&quot; + path);\n            if (url.isPresent()) {\n                try (InputStream inputStream = url.get().openStream()) {\n                    return Optional.of(inputStream.readAllBytes());\n                }\n            }\n            else {\n                return Optional.empty();\n            }\n        }\n    \n        public List&lt;Contact&gt; getContacts(String path) throws IOException {\n            List&lt;Contact&gt; contactList = new ArrayList&lt;&gt;();\n            Map&lt;String, String&gt; contactMap = readJsonFileToMap(path).orElse(Map.of(&quot;sender@gmail.com&quot;, &quot;crash&quot;));\n            contactMap.forEach((key, value) -&gt; {\n                contactList.add(new Contact(key, value));\n            });\n    \n            return contactList;\n        }\n    \n        public @Nullable Optional&lt;Map&lt;String, String&gt;&gt; readJsonFileToMap(String resourcePath) throws IOException {\n            Optional&lt;URL&gt; url = resourceResolver.getResource(&quot;classpath:&quot; + resourcePath);\n            if (url.isPresent()) {\n                try (InputStream inputStream = url.get().openStream()) {\n                    return Optional.of(objectMapper.readValue(inputStream.readAllBytes(), Argument.mapOf(String.class, String.class)));\n                }\n            }\n            else {\n                return Optional.empty();\n            }\n        }\n    \n        public Optional&lt;String&gt; readHtmlFile(String path) throws Exception {\n            Optional&lt;URL&gt; url = resourceResolver.getResource(&quot;classpath:&quot; + path);\n            if (url.isPresent()) {\n                return Optional.of(IOUtils.readText(new BufferedReader(new InputStreamReader(url.get().openStream()))));\n            }\n            else {\n                return Optional.empty();\n            }\n        }\n    \n        public Optional&lt;String&gt; getClasspathResourceAsText(String path) throws Exception {\n            Optional&lt;URL&gt; url = resourceResolver.getResource(&quot;classpath:&quot; + path);\n            if (url.isPresent()) {\n                return Optional.of(IOUtils.readText(new BufferedReader(new InputStreamReader(url.get().openStream()))));\n            }\n            else {\n                return Optional.empty();\n            }\n        }\n    }\n</code></pre>\n<ul>\n<li>controller code</li>\n</ul>\n<pre class=\"lang-java prettyprint-override\"><code>package example.micronaut;\n\nimport com.amazonaws.services.lambda.runtime.events.APIGatewayProxyResponseEvent;\nimport com.sendgrid.Response;\nimport example.micronaut.services.EmailSendingService;\nimport io.micronaut.http.annotation.Controller;\nimport io.micronaut.http.annotation.Get;\nimport io.micronaut.http.annotation.QueryValue;\nimport io.micronaut.serde.ObjectMapper;\nimport jakarta.inject.Inject;\n\nimport java.util.Collections;\n\n@Controller\npublic class HomeController {\n    private final EmailSendingService emailSendingService;\n    @Inject\n    ObjectMapper objectMapper;\n    APIGatewayProxyResponseEvent response = new APIGatewayProxyResponseEvent();\n\n    @Inject\n    public HomeController(EmailSendingService emailSendingService) {\n        this.emailSendingService = emailSendingService;\n    }\n\n    @Get\n    public APIGatewayProxyResponseEvent index(@QueryValue(defaultValue = &quot;test&quot;) String campaign) {\n        try {\n\n            Response sendGridResponse = emailSendingService.sendCustomizedEmail(campaign);\n            String json = new String(objectMapper.writeValueAsBytes(Collections.singletonMap(&quot;message&quot;, response.getHeaders())));\n            response.setStatusCode(sendGridResponse.getStatusCode());\n            response.setBody(json);\n        }\n        catch (Exception e) {\n            response.setStatusCode(500);\n            response.setBody(String.valueOf(e.getMessage()));\n        }\n\n        return response;\n    }\n}\n</code></pre>\n<ul>\n<li>current runtime config</li>\n</ul>\n<p><a href=\"https://i.sstatic.net/IaNV3MWk.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/IaNV3MWk.png\" alt=\"enter image description here\" /></a></p>\n<ul>\n<li>test response</li>\n</ul>\n<p>-- execution log</p>\n<pre class=\"lang-json prettyprint-override\"><code>    {\n      &quot;statusCode&quot;: 200,\n      &quot;headers&quot;: {\n        &quot;Date&quot;: &quot;Sat, 14 Sep 2024 18:05:23 GMT&quot;,\n        &quot;Content-Type&quot;: &quot;application/json&quot;\n      },\n      &quot;multiValueHeaders&quot;: {\n        &quot;Date&quot;: [\n          &quot;Sat, 14 Sep 2024 18:05:23 GMT&quot;\n        ],\n        &quot;Content-Type&quot;: [\n          &quot;application/json&quot;\n        ]\n      },\n      &quot;body&quot;: &quot;{\\&quot;statusCode\\&quot;:400,\\&quot;body\\&quot;:\\&quot;{\\\\\\&quot;message\\\\\\&quot;:null}\\&quot;}&quot;,\n      &quot;isBase64Encoded&quot;: false\n    }\n</code></pre>\n<p>-- log output</p>\n<pre><code>    START RequestId: b984c570-f7af-4d4c-a929-0ae8cf1fdcd7 Version: $LATEST\n     [36m18:05:23.612 [0;39m  [1;30m[main] [0;39m  [34mINFO  [0;39m  [35mi.m.e.sendgrid.SendgridEmailSender [0;39m - Status Code: 400\n     [36m18:05:23.612 [0;39m  [1;30m[main] [0;39m  [34mINFO  [0;39m  [35mi.m.e.sendgrid.SendgridEmailSender [0;39m - Body: {&quot;errors&quot;:[{&quot;message&quot;:&quot;The from object must be provided for every email send. It is an object that requires the email parameter, but may also contain a name parameter.  e.g. {\\&quot;email\\&quot; : \\&quot;example@example.com\\&quot;}  or {\\&quot;email\\&quot; : \\&quot;example@example.com\\&quot;, \\&quot;name\\&quot; : \\&quot;Example Recipient\\&quot;}.&quot;,&quot;field&quot;:&quot;from.email&quot;,&quot;help&quot;:&quot;http://sendgrid.com/docs/API_Reference/Web_API_v3/Mail/errors.html#message.from&quot;},{&quot;message&quot;:&quot;The personalizations field is required and must have at least one personalization.&quot;,&quot;field&quot;:&quot;personalizations&quot;,&quot;help&quot;:&quot;http://sendgrid.com/docs/API_Reference/Web_API_v3/Mail/errors.html#-Personalizations-Errors&quot;},{&quot;message&quot;:&quot;Unless a valid template_id is provided, the content parameter is required. There must be at least one defined content block. We typically suggest both text/plain and text/html blocks are included, but only one block is required.&quot;,&quot;field&quot;:&quot;content&quot;,&quot;help&quot;:&quot;http://sendgrid.com/docs/API_Reference/Web_API_v3/Mail/errors.html#message.content&quot;}]}\n     [36m18:05:23.612 [0;39m  [1;30m[main] [0;39m  [34mINFO  [0;39m  [35mi.m.e.sendgrid.SendgridEmailSender [0;39m - Headers {Strict-Transport-Security=max-age=600; includeSubDomains, Server=nginx, Access-Control-Allow-Origin=https://sendgrid.api-docs.io, Access-Control-Allow-Methods=POST, Connection=keep-alive, X-No-CORS-Reason=https://sendgrid.com/docs/Classroom/Basics/API/cors.html, Content-Length=980, Access-Control-Max-Age=600, Date=Sat, 14 Sep 2024 18:05:23 GMT, Access-Control-Allow-Headers=Authorization, Content-Type, On-behalf-of, x-sg-elas-acl, Content-Type=application/json}\n    END RequestId: b984c570-f7af-4d4c-a929-0ae8cf1fdcd7\n    REPORT RequestId: b984c570-f7af-4d4c-a929-0ae8cf1fdcd7  Duration: 2722.27 ms    Billed Duration: 2723 ms    Memory Size: 128 MB Max Memory Used: 113 MB \n</code></pre>\n<p>Like I said the application works when not deployed as GraalVM. Any help or something else to try is greatly appreciated</p>\n<p>I have tried adding everything I can think of to the resources/META-INF/native-image/reflect-config.json . Tried the different ways shown in the\nmicronaut docs to run the lambda , i.e. using a Controller method, the FunctionRequestHandler , and FunctionLambdaRuntime. With each the lambda will\nwork and it returns a string or APIGatewayProxyResponseEvent no problem. There seems to be something with building the email</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}