{
  "question": {
    "tags": [
      "java",
      "performance",
      "garbage-collection",
      "java-memory-model",
      "corretto"
    ],
    "owner": {
      "account_id": 5524210,
      "reputation": 652,
      "user_id": 4386227,
      "user_type": "registered",
      "accept_rate": 67,
      "profile_image": "https://www.gravatar.com/avatar/5a23b86b6bc00cc85c7925fd3b4fbc1c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Vlad",
      "link": "https://stackoverflow.com/users/4386227/vlad"
    },
    "is_answered": true,
    "view_count": 141,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1735224883,
    "creation_date": 1732175629,
    "last_edit_date": 1732181498,
    "question_id": 79210175,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79210175/how-does-memory-allocation-work-when-calling-lambdas-in-java-can-lambdas-be-use",
    "title": "How does memory allocation work when calling lambdas in Java? Can lambdas be used in a GC-free style for latency-critical applications?",
    "body": "<p>I am trying to understand how Java handles <strong>memory allocation for lambdas</strong> and whether it's possible to use them in a <strong>GC-free style</strong> for latency-critical applications. My goal is to determine if lambdas can be used without generating garbage, as avoiding GC is crucial for my use case.</p>\n<p>Below are two examples to illustrate my questions. In both lambda captures effectively final variable.</p>\n<p><em>Environment: Amazon Corretto 17.0.12 JDK, G1GC.</em></p>\n<h3>Example 1: Inline Lambda</h3>\n<pre class=\"lang-java prettyprint-override\"><code>package com.example;\n\nimport java.util.List;\nimport java.util.function.Predicate;\n\npublic class LambdaTest {\n    private static final Something something = new Something();\n\n    public static void main(String[] args) {\n        String a = &quot;hello there&quot;;\n        while (true) {\n            something.method(x -&gt; x.equals(a));\n        }\n    }\n}\n\nclass Something {\n    private final List&lt;String&gt; list = List.of(&quot;1&quot;, &quot;2&quot;);\n\n    void method(Predicate&lt;String&gt; predicate) {\n        for (int i = 0; i &lt; list.size(); i++) {\n            predicate.test(list.get(i));\n        }\n    }\n}\n</code></pre>\n<p>When running this code for about 15 seconds, <strong>~22 MB of memory is allocated</strong> (as observed using Java Flight Recorder). This is surprising for what seems like a simple lambda call.</p>\n<p>The GC logs also show a lot of &quot;Cleanup&quot; events and G1 collections. Why does this happen?</p>\n<p><a href=\"https://i.sstatic.net/AgQUPs8J.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/AgQUPs8J.png\" alt=\"example 1 jfr\" /></a></p>\n<p>GC log:</p>\n<pre><code>[2024-11-21T11:17:19.564+0400][0.009s][info][gc] Using G1\n[2024-11-21T11:17:19.566+0400][0.011s][info][gc,init] Version: 17.0.12+7-LTS (release)\n[2024-11-21T11:17:19.566+0400][0.011s][info][gc,init] CPUs: 12 total, 12 available\n[2024-11-21T11:17:19.566+0400][0.011s][info][gc,init] Memory: 32448M\n[2024-11-21T11:17:19.566+0400][0.011s][info][gc,init] Large Page Support: Disabled\n[2024-11-21T11:17:19.567+0400][0.011s][info][gc,init] NUMA Support: Disabled\n[2024-11-21T11:17:19.567+0400][0.011s][info][gc,init] Compressed Oops: Enabled (Zero based)\n[2024-11-21T11:17:19.567+0400][0.011s][info][gc,init] Heap Region Size: 4M\n[2024-11-21T11:17:19.567+0400][0.011s][info][gc,init] Heap Min Capacity: 8M\n[2024-11-21T11:17:19.567+0400][0.011s][info][gc,init] Heap Initial Capacity: 508M\n[2024-11-21T11:17:19.568+0400][0.013s][info][gc,init] Heap Max Capacity: 8116M\n[2024-11-21T11:17:19.568+0400][0.013s][info][gc,init] Pre-touch: Disabled\n[2024-11-21T11:17:19.568+0400][0.013s][info][gc,init] Parallel Workers: 10\n[2024-11-21T11:17:19.568+0400][0.013s][info][gc,init] Concurrent Workers: 3\n[2024-11-21T11:17:19.568+0400][0.013s][info][gc,init] Concurrent Refinement Workers: 10\n[2024-11-21T11:17:19.568+0400][0.013s][info][gc,init] Periodic GC: Disabled\n[2024-11-21T11:17:19.574+0400][0.019s][info][gc,metaspace] CDS archive(s) mapped at: [0x000001f851000000-0x000001f851bb0000-0x000001f851bb0000), size 12255232, SharedBaseAddress: 0x000001f851000000, ArchiveRelocationMode: 1.\n[2024-11-21T11:17:19.574+0400][0.019s][info][gc,metaspace] Compressed class space mapped at: 0x000001f852000000-0x000001f892000000, reserved size: 1073741824\n[2024-11-21T11:17:19.574+0400][0.019s][info][gc,metaspace] Narrow klass base: 0x000001f851000000, Narrow klass shift: 0, Narrow klass range: 0x100000000\n[2024-11-21T11:17:19.766+0400][0.211s][info][safepoint   ] Safepoint &quot;ICBufferFull&quot;, Time since last: 189551200 ns, Reaching safepoint: 17600 ns, Cleanup: 60000 ns, At safepoint: 7500 ns, Total: 85100 ns\n[2024-11-21T11:17:19.787+0400][0.232s][info][safepoint   ] Safepoint &quot;RedefineClasses&quot;, Time since last: 16989500 ns, Reaching safepoint: 3100 ns, Cleanup: 45500 ns, At safepoint: 3409200 ns, Total: 3457800 ns\n[2024-11-21T11:17:19.814+0400][0.259s][info][safepoint   ] Safepoint &quot;JFRCheckpoint&quot;, Time since last: 27203200 ns, Reaching safepoint: 2100 ns, Cleanup: 8500 ns, At safepoint: 1600 ns, Total: 12200 ns\n[2024-11-21T11:17:20.614+0400][1.058s][info][gc,start    ] GC(0) Pause Young (Normal) (G1 Evacuation Pause)\n[2024-11-21T11:17:20.614+0400][1.059s][info][gc,task     ] GC(0) Using 10 workers of 10 for evacuation\n[2024-11-21T11:17:20.616+0400][1.061s][info][gc,phases   ] GC(0)   Pre Evacuate Collection Set: 0.1ms\n[2024-11-21T11:17:20.616+0400][1.061s][info][gc,phases   ] GC(0)   Merge Heap Roots: 0.1ms\n[2024-11-21T11:17:20.616+0400][1.061s][info][gc,phases   ] GC(0)   Evacuate Collection Set: 1.5ms\n[2024-11-21T11:17:20.616+0400][1.061s][info][gc,phases   ] GC(0)   Post Evacuate Collection Set: 0.2ms\n[2024-11-21T11:17:20.616+0400][1.061s][info][gc,phases   ] GC(0)   Other: 0.4ms\n[2024-11-21T11:17:20.616+0400][1.061s][info][gc,heap     ] GC(0) Eden regions: 6-&gt;0(7)\n[2024-11-21T11:17:20.616+0400][1.061s][info][gc,heap     ] GC(0) Survivor regions: 0-&gt;1(1)\n[2024-11-21T11:17:20.616+0400][1.061s][info][gc,heap     ] GC(0) Old regions: 0-&gt;0\n[2024-11-21T11:17:20.616+0400][1.061s][info][gc,heap     ] GC(0) Archive regions: 0-&gt;0\n[2024-11-21T11:17:20.616+0400][1.061s][info][gc,heap     ] GC(0) Humongous regions: 0-&gt;0\n[2024-11-21T11:17:20.616+0400][1.061s][info][gc,metaspace] GC(0) Metaspace: 3984K(4096K)-&gt;3984K(4096K) NonClass: 3594K(3648K)-&gt;3594K(3648K) Class: 389K(448K)-&gt;389K(448K)\n[2024-11-21T11:17:20.616+0400][1.061s][info][gc          ] GC(0) Pause Young (Normal) (G1 Evacuation Pause) 24M-&gt;3M(508M) 2.466ms\n[2024-11-21T11:17:20.616+0400][1.061s][info][gc,cpu      ] GC(0) User=0.00s Sys=0.00s Real=0.00s\n[2024-11-21T11:17:20.616+0400][1.061s][info][safepoint   ] Safepoint &quot;G1CollectForAllocation&quot;, Time since last: 799453500 ns, Reaching safepoint: 23700 ns, Cleanup: 10700 ns, At safepoint: 2637900 ns, Total: 2672300 ns\n[2024-11-21T11:17:21.803+0400][2.248s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 1186781600 ns, Reaching safepoint: 25100 ns, Cleanup: 41800 ns, At safepoint: 5600 ns, Total: 72500 ns\n[2024-11-21T11:17:22.804+0400][3.248s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 1000461600 ns, Reaching safepoint: 43400 ns, Cleanup: 6300 ns, At safepoint: 5000 ns, Total: 54700 ns\n[2024-11-21T11:17:23.805+0400][4.249s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 1000781300 ns, Reaching safepoint: 59000 ns, Cleanup: 11500 ns, At safepoint: 11600 ns, Total: 82100 ns\n[2024-11-21T11:17:24.805+0400][5.249s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 1000039000 ns, Reaching safepoint: 28800 ns, Cleanup: 7100 ns, At safepoint: 4200 ns, Total: 40100 ns\n[2024-11-21T11:17:26.806+0400][7.250s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 2000881000 ns, Reaching safepoint: 24300 ns, Cleanup: 8800 ns, At safepoint: 6300 ns, Total: 39400 ns\n[2024-11-21T11:17:28.807+0400][9.251s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 2000920600 ns, Reaching safepoint: 28000 ns, Cleanup: 7500 ns, At safepoint: 4100 ns, Total: 39600 ns\n[2024-11-21T11:17:34.810+0400][15.254s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 6002864400 ns, Reaching safepoint: 37000 ns, Cleanup: 9400 ns, At safepoint: 8600 ns, Total: 55000 ns\n[2024-11-21T11:17:35.086+0400][15.531s][info][safepoint   ] Safepoint &quot;JFRCheckpoint&quot;, Time since last: 276571100 ns, Reaching safepoint: 36100 ns, Cleanup: 6400 ns, At safepoint: 58900 ns, Total: 101400 ns\n[2024-11-21T11:17:35.105+0400][15.549s][info][gc,heap,exit] Heap\n[2024-11-21T11:17:35.105+0400][15.549s][info][gc,heap,exit]  garbage-first heap   total 520192K, used 9809K [0x0000000604c00000, 0x0000000800000000)\n[2024-11-21T11:17:35.105+0400][15.549s][info][gc,heap,exit]   region size 4096K, 3 young (12288K), 1 survivors (4096K)\n[2024-11-21T11:17:35.105+0400][15.549s][info][gc,heap,exit]  Metaspace       used 8222K, committed 8512K, reserved 1114112K\n[2024-11-21T11:17:35.105+0400][15.549s][info][gc,heap,exit]   class space    used 900K, committed 1024K, reserved 1048576K\n</code></pre>\n<h3>Example 2: Predefined Lambda</h3>\n<pre><code>public static void main(String[] args) {\n    String a = &quot;hello there&quot;;\n    Predicate&lt;String&gt; stringPredicate = x -&gt; x.equals(a);\n    while (true) {\n         something.method(stringPredicate);\n    }\n}\n</code></pre>\n<p>In this example, the lambda is assigned to a variable beforehand and reused in the loop. Interestingly, much less memory is allocated (according to IDEA profiler hints), but almost the same number of Safepoint &quot;Cleanup&quot; events.\n<a href=\"https://i.sstatic.net/K5Ii7JGy.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/K5Ii7JGy.png\" alt=\"example 2\" /></a></p>\n<p>GC log:</p>\n<pre><code>[2024-11-21T11:29:08.186+0400][0.011s][info][gc] Using G1\n[2024-11-21T11:29:08.187+0400][0.013s][info][gc,init] Version: 17.0.12+7-LTS (release)\n[2024-11-21T11:29:08.187+0400][0.013s][info][gc,init] CPUs: 12 total, 12 available\n[2024-11-21T11:29:08.187+0400][0.013s][info][gc,init] Memory: 32448M\n[2024-11-21T11:29:08.187+0400][0.013s][info][gc,init] Large Page Support: Disabled\n[2024-11-21T11:29:08.187+0400][0.013s][info][gc,init] NUMA Support: Disabled\n[2024-11-21T11:29:08.187+0400][0.013s][info][gc,init] Compressed Oops: Enabled (Zero based)\n[2024-11-21T11:29:08.187+0400][0.013s][info][gc,init] Heap Region Size: 4M\n[2024-11-21T11:29:08.187+0400][0.013s][info][gc,init] Heap Min Capacity: 8M\n[2024-11-21T11:29:08.187+0400][0.013s][info][gc,init] Heap Initial Capacity: 508M\n[2024-11-21T11:29:08.188+0400][0.013s][info][gc,init] Heap Max Capacity: 8116M\n[2024-11-21T11:29:08.188+0400][0.013s][info][gc,init] Pre-touch: Disabled\n[2024-11-21T11:29:08.188+0400][0.013s][info][gc,init] Parallel Workers: 10\n[2024-11-21T11:29:08.188+0400][0.013s][info][gc,init] Concurrent Workers: 3\n[2024-11-21T11:29:08.188+0400][0.013s][info][gc,init] Concurrent Refinement Workers: 10\n[2024-11-21T11:29:08.188+0400][0.013s][info][gc,init] Periodic GC: Disabled\n[2024-11-21T11:29:08.194+0400][0.019s][info][gc,metaspace] CDS archive(s) mapped at: [0x0000024c45000000-0x0000024c45bb0000-0x0000024c45bb0000), size 12255232, SharedBaseAddress: 0x0000024c45000000, ArchiveRelocationMode: 1.\n[2024-11-21T11:29:08.194+0400][0.019s][info][gc,metaspace] Compressed class space mapped at: 0x0000024c46000000-0x0000024c86000000, reserved size: 1073741824\n[2024-11-21T11:29:08.194+0400][0.019s][info][gc,metaspace] Narrow klass base: 0x0000024c45000000, Narrow klass shift: 0, Narrow klass range: 0x100000000\n[2024-11-21T11:29:08.391+0400][0.216s][info][safepoint   ] Safepoint &quot;ICBufferFull&quot;, Time since last: 193888700 ns, Reaching safepoint: 7400 ns, Cleanup: 69600 ns, At safepoint: 8300 ns, Total: 85300 ns\n[2024-11-21T11:29:08.410+0400][0.235s][info][safepoint   ] Safepoint &quot;RedefineClasses&quot;, Time since last: 16389000 ns, Reaching safepoint: 2900 ns, Cleanup: 45800 ns, At safepoint: 2560100 ns, Total: 2608800 ns\n[2024-11-21T11:29:08.438+0400][0.263s][info][safepoint   ] Safepoint &quot;JFRCheckpoint&quot;, Time since last: 28071700 ns, Reaching safepoint: 2800 ns, Cleanup: 11700 ns, At safepoint: 2500 ns, Total: 17000 ns\n[2024-11-21T11:29:09.396+0400][1.221s][info][gc,start    ] GC(0) Pause Young (Normal) (G1 Evacuation Pause)\n[2024-11-21T11:29:09.396+0400][1.222s][info][gc,task     ] GC(0) Using 10 workers of 10 for evacuation\n[2024-11-21T11:29:09.400+0400][1.225s][info][gc,phases   ] GC(0)   Pre Evacuate Collection Set: 0.1ms\n[2024-11-21T11:29:09.400+0400][1.225s][info][gc,phases   ] GC(0)   Merge Heap Roots: 0.1ms\n[2024-11-21T11:29:09.400+0400][1.225s][info][gc,phases   ] GC(0)   Evacuate Collection Set: 2.0ms\n[2024-11-21T11:29:09.400+0400][1.225s][info][gc,phases   ] GC(0)   Post Evacuate Collection Set: 0.4ms\n[2024-11-21T11:29:09.400+0400][1.225s][info][gc,phases   ] GC(0)   Other: 0.5ms\n[2024-11-21T11:29:09.400+0400][1.225s][info][gc,heap     ] GC(0) Eden regions: 6-&gt;0(7)\n[2024-11-21T11:29:09.400+0400][1.225s][info][gc,heap     ] GC(0) Survivor regions: 0-&gt;1(1)\n[2024-11-21T11:29:09.400+0400][1.225s][info][gc,heap     ] GC(0) Old regions: 0-&gt;0\n[2024-11-21T11:29:09.400+0400][1.225s][info][gc,heap     ] GC(0) Archive regions: 0-&gt;0\n[2024-11-21T11:29:09.400+0400][1.225s][info][gc,heap     ] GC(0) Humongous regions: 0-&gt;0\n[2024-11-21T11:29:09.400+0400][1.225s][info][gc,metaspace] GC(0) Metaspace: 7360K(7552K)-&gt;7360K(7552K) NonClass: 6565K(6656K)-&gt;6565K(6656K) Class: 794K(896K)-&gt;794K(896K)\n[2024-11-21T11:29:09.400+0400][1.225s][info][gc          ] GC(0) Pause Young (Normal) (G1 Evacuation Pause) 24M-&gt;3M(508M) 3.217ms\n[2024-11-21T11:29:09.400+0400][1.225s][info][gc,cpu      ] GC(0) User=0.00s Sys=0.00s Real=0.00s\n[2024-11-21T11:29:09.400+0400][1.225s][info][safepoint   ] Safepoint &quot;G1CollectForAllocation&quot;, Time since last: 958423000 ns, Reaching safepoint: 23600 ns, Cleanup: 37100 ns, At safepoint: 3297100 ns, Total: 3357800 ns\n[2024-11-21T11:29:10.419+0400][2.244s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 1019081500 ns, Reaching safepoint: 15700 ns, Cleanup: 21900 ns, At safepoint: 5300 ns, Total: 42900 ns\n[2024-11-21T11:29:11.420+0400][3.244s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 1000396700 ns, Reaching safepoint: 13700 ns, Cleanup: 8300 ns, At safepoint: 4800 ns, Total: 26800 ns\n[2024-11-21T11:29:12.420+0400][4.245s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 1000880300 ns, Reaching safepoint: 25700 ns, Cleanup: 10100 ns, At safepoint: 66000 ns, Total: 101800 ns\n[2024-11-21T11:29:13.421+0400][5.245s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 1000087200 ns, Reaching safepoint: 18300 ns, Cleanup: 13100 ns, At safepoint: 5200 ns, Total: 36600 ns\n[2024-11-21T11:29:14.421+0400][6.246s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 1000750200 ns, Reaching safepoint: 16000 ns, Cleanup: 8300 ns, At safepoint: 28600 ns, Total: 52900 ns\n[2024-11-21T11:29:15.422+0400][7.247s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 1000323100 ns, Reaching safepoint: 13500 ns, Cleanup: 9500 ns, At safepoint: 566000 ns, Total: 589000 ns\n[2024-11-21T11:29:17.423+0400][9.248s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 2000973400 ns, Reaching safepoint: 17600 ns, Cleanup: 6200 ns, At safepoint: 4500 ns, Total: 28300 ns\n[2024-11-21T11:29:23.427+0400][15.251s][info][safepoint   ] Safepoint &quot;Cleanup&quot;, Time since last: 6003316900 ns, Reaching safepoint: 16300 ns, Cleanup: 13000 ns, At safepoint: 11100 ns, Total: 40400 ns\n[2024-11-21T11:29:23.858+0400][15.683s][info][safepoint   ] Safepoint &quot;JFRCheckpoint&quot;, Time since last: 431903500 ns, Reaching safepoint: 12800 ns, Cleanup: 10400 ns, At safepoint: 44800 ns, Total: 68000 ns\n[2024-11-21T11:29:23.876+0400][15.701s][info][gc,heap,exit] Heap\n[2024-11-21T11:29:23.876+0400][15.701s][info][gc,heap,exit]  garbage-first heap   total 520192K, used 7237K [0x0000000604c00000, 0x0000000800000000)\n[2024-11-21T11:29:23.876+0400][15.701s][info][gc,heap,exit]   region size 4096K, 2 young (8192K), 1 survivors (4096K)\n[2024-11-21T11:29:23.876+0400][15.701s][info][gc,heap,exit]  Metaspace       used 8206K, committed 8448K, reserved 1114112K\n[2024-11-21T11:29:23.876+0400][15.701s][info][gc,heap,exit]   class space    used 900K, committed 1024K, reserved 1048576K\n</code></pre>\n<h3><strong>Questions</strong></h3>\n<ol>\n<li><p>Why does Example 1 result in significantly more memory allocation compared to Example 2?</p>\n<ul>\n<li>Is a new lambda object created each time the inline lambda is called?</li>\n<li>How is memory allocated for lambdas in the JVM?</li>\n</ul>\n</li>\n<li><p>In both examples, the GC logs show many &quot;Cleanup&quot; events.</p>\n<ul>\n<li>What exactly is being cleaned up during these events?</li>\n<li>Is it related to lambdas, thread-local storage, or something else?</li>\n</ul>\n</li>\n<li><p>Is there a way to use lambdas in a <strong>GC-free style</strong>, such that no garbage is generated when they are called repeatedly?</p>\n<ul>\n<li>If not, would sticking to anonymous classes or functional interfaces help?</li>\n</ul>\n</li>\n<li><p>How can I profile and debug this further to understand the internal memory behavior of lambdas?</p>\n</li>\n</ol>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}