{
  "question": {
    "tags": [
      "java",
      "spring",
      "unit-testing",
      "junit",
      "mockito"
    ],
    "owner": {
      "account_id": 27049770,
      "reputation": 35,
      "user_id": 20603331,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/1cc667e60b03e79a0ecef4a4f17bc512?s=256&d=identicon&r=PG",
      "display_name": "felipesousac",
      "link": "https://stackoverflow.com/users/20603331/felipesousac"
    },
    "is_answered": true,
    "view_count": 118,
    "accepted_answer_id": 78842123,
    "answer_count": 1,
    "score": 2,
    "last_activity_date": 1726435646,
    "creation_date": 1722993245,
    "last_edit_date": 1722996531,
    "question_id": 78841512,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78841512/mock-repository-method-not-being-called-inside-service-method",
    "title": "Mock repository method not being called inside service method",
    "body": "<p>I'm using Spring and testing with JUnit5 and mockito to test a service layer method that makes a call to a JPA repository method. The service layer should make a query to the database and if a record is present then an exception must be throw.</p>\n<p>Bellow the classes that are being used.</p>\n<p>ItemServiceTest:</p>\n<pre><code>@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n@ExtendWith(MockitoExtension.class)\nclass ItemServiceTest {\n\n    MockItem input;\n\n    @InjectMocks\n    ItemService itemService;\n\n    @Mock\n    ItemRepository itemRepository;\n\n    @Mock\n    CategorieRepository categorieRepository;\n\n    @Mock\n    ItemDTOMapper itemDTOMapper;\n    \n    @Mock\n    private UriComponentsBuilder uriBuilder;\n\n    @Mock\n    private UriComponents uriComponents;\n\n    @Captor\n    private ArgumentCaptor&lt;Long&gt; longCaptor;\n\n    @Captor\n    private ArgumentCaptor&lt;String&gt; stringCaptor;\n\n    @BeforeEach\n    void setUpMocks() {\n        input = new MockItem();\n        MockitoAnnotations.openMocks(this);\n    }\n\n    @Test\n    void testCase() throws ItemAlreadyCreatedException {\n        Item item = input.mockEntity();\n        CreateItemData data = input.mockDTO();\n        ItemListData listData = input.mockItemListData();\n\n        when(itemRepository.findByItemNameIgnoreCase(any())).thenReturn(Optional.of(item));\n        given(uriBuilder.path(stringCaptor.capture())).willReturn(uriBuilder);\n        given(uriBuilder.buildAndExpand(longCaptor.capture())).willReturn(uriComponents);\n\n        Exception ex = assertThrows(ItemAlreadyCreatedException.class, () -&gt; {\n            itemService.createItem(data, uriBuilder);\n        });\n\n        String expectedMessage = &quot;There is an item created with this name&quot;;\n        String actualMessage = ex.getMessage();\n\n        assertEquals(expectedMessage, actualMessage);\n    }\n}\n</code></pre>\n<p>ItemRepository:</p>\n<pre><code>public interface ItemRepository extends JpaRepository&lt;Item, Long&gt; {\n\n    Optional&lt;Item&gt; findByItemNameIgnoreCase(String name);\n}\n</code></pre>\n<p>ItemService:</p>\n<pre><code>@Service\npublic class ItemService {\n\n    private final ItemRepository itemRepository;\n    private final CategorieRepository categorieRepository;\n    private final ItemDTOMapper itemDTOMapper;\n    private final ImageService imageService;\n\n    public ItemService(ItemRepository itemRepository, CategorieRepository categorieRepository, ItemDTOMapper itemDTOMapper, ImageService imageService) {\n        this.itemRepository = itemRepository;\n        this.categorieRepository = categorieRepository;\n        this.itemDTOMapper = itemDTOMapper;\n        this.imageService = imageService;\n    }\n    \n    @Transactional\n    public CreateRecordUtil createItem(CreateItemData data, UriComponentsBuilder uriBuilder) throws ItemAlreadyCreatedException {\n        \n        Optional&lt;Item&gt; isNameInUse = itemRepository.findByItemNameIgnoreCase(data.itemName());\n\n        if (isNameInUse.isPresent()) {\n            throw new ItemAlreadyCreatedException(&quot;There is an item created with this name&quot;);\n        }\n\n        //some logic after if statement\n \n        return new CreateRecordUtil();\n    }\n}\n</code></pre>\n<p>MockItem (it is a class to mock Item entity and its DTOs):</p>\n<pre><code>public class MockItem {\n\n    public Item mockEntity() {\n        return mockEntity(0);\n    }\n\n    public CreateItemData mockDTO() {\n        return mockDTO(0);\n    }\n\n    public ItemListData mockItemListData() {\n        return itemListData(0);\n    }\n\n    public Item mockEntity(Integer number) {\n        Item item = new Item();\n        Categorie category = new Categorie(11L, &quot;mockCategory&quot;, &quot;mockDescription&quot;);\n\n        item.setId(number.longValue());\n        item.setItemName(&quot;Name Test&quot; + number);\n        item.setDescription(&quot;Name Description&quot; + number);\n        item.setCategory(category);\n        item.setPrice(BigDecimal.valueOf(number));\n        item.setNumberInStock(number);\n\n        return item;\n    }\n\n    public CreateItemData mockDTO(Integer number) {\n        CreateItemData data = new CreateItemData(\n                &quot;Name Test&quot; + number,\n                &quot;Name Description&quot; + number,\n                11L,\n                BigDecimal.valueOf(number),\n                number);\n\n        return data;\n    }\n\n    private ItemListData itemListData(Integer number) {\n        CategoryListData category = new CategoryListData(11L, &quot;mockCategory&quot;);\n\n        ItemListData data = new ItemListData(\n                number.longValue(),\n                &quot;First Name Test&quot; + number,\n                category,\n                &quot;Name Description&quot; + number,\n                BigDecimal.valueOf(number),\n                number\n        );\n\n        return data;\n    }\n}\n</code></pre>\n<p>I've tried to use mockito when like the following:</p>\n<p><code>when(itemRepository.findByItemNameIgnoreCase(any())).thenReturn(Optional.of(item));</code></p>\n<p>With this line I expect that when my itemService calls itemRepository.findByItemNameIgnoreCase() inside createItem() method, it should return the mock record.</p>\n<p>That works fine when I call itemRepository directly in the test case body, the problem begins when I tried to call itemRepository in the service layer as I said. It does not returned the expected when() that was being expected and the if statement was not reached at all, and the test case fails with:</p>\n<pre><code>org.opentest4j.AssertionFailedError: Expected com.inventory.server.infra.exception.ItemAlreadyCreatedException to be thrown, but nothing was thrown.\n\n    at org.junit.jupiter.api.AssertionFailureBuilder.build(AssertionFailureBuilder.java:152)\n    at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:73)\n    at org.junit.jupiter.api.AssertThrows.assertThrows(AssertThrows.java:35)\n    at org.junit.jupiter.api.Assertions.assertThrows(Assertions.java:3115)\n    at com.inventory.server.service.ItemServiceTest.testCase(ItemServiceTest.java:84)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:580)\n    at java.base/java.util.ArrayList.forEach(ArrayList.java:1596)\n    at java.base/java.util.ArrayList.forEach(ArrayList.java:1596)\n</code></pre>\n<p>So, after that I've tried to use verify to see if there were some interaction being made with itemRepository inside itemService, like the following:</p>\n<p><code>verify(itemRepository).findByItemNameIgnoreCase(any());</code></p>\n<p>But with that call I get the following error:</p>\n<pre><code>Wanted but not invoked:\nitemRepository.findByItemNameIgnoreCase(\n    &lt;any&gt;\n);\n-&gt; at com.inventory.server.service.ItemServiceTest.testCase(ItemServiceTest.java:92)\nActually, there were zero interactions with this mock.\n\nWanted but not invoked:\nitemRepository.findByItemNameIgnoreCase(\n    &lt;any&gt;\n);\n-&gt; at com.inventory.server.service.ItemServiceTest.testCase(ItemServiceTest.java:92)\nActually, there were zero interactions with this mock.\n\n    at com.inventory.server.service.ItemServiceTest.testCase(ItemServiceTest.java:92)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:580)\n    at java.base/java.util.ArrayList.forEach(ArrayList.java:1596)\n    at java.base/java.util.ArrayList.forEach(ArrayList.java:1596)\n\n</code></pre>\n<p>How can I reach the if statement so I can assert that the exception was throw?</p>\n<p>I've tried A LOT of other similar problems solutions here in SO, but none of then worked in my case, a help in this one would be really appreciated.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}