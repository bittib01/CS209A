{
  "question": {
    "tags": [
      "java",
      "apache-camel",
      "sftp"
    ],
    "owner": {
      "account_id": 7816784,
      "reputation": 99,
      "user_id": 5911228,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/92c5b1b1551a67b8fbf7bd29d32e4e63?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "cdprete",
      "link": "https://stackoverflow.com/users/5911228/cdprete"
    },
    "is_answered": true,
    "view_count": 114,
    "accepted_answer_id": 79642038,
    "answer_count": 1,
    "score": -1,
    "last_activity_date": 1748447233,
    "creation_date": 1747996498,
    "last_edit_date": 1748324451,
    "question_id": 79635332,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79635332/apache-camel-jsch-permission-denied-for-sftp-upload",
    "title": "Apache Camel / JSch permission denied for SFTP upload",
    "body": "<p>I'm using Apache Camel <code>3.4.10</code> to upload some files to an SFTP server and, since almost one week, this is not working anymore and below there is the output I get:</p>\n<pre><code>2025-05-23 12:02:08,890 WARN  [org.apache.camel.component.file.remote.RemoteFileProducer:87] (Camel (tsbulk-sftp-context) thread #1 - file:///export/home/tsbulk_delivery) Writing file failed with: Cannot store file: tsbulk-prod/CH36158/tsbulk_delivery/selection/labsconfig1.xml\n2025-05-23 12:02:10,199 WARN  [org.apache.camel.component.file.remote.RemoteFileProducer:87] (Camel (tsbulk-sftp-context) thread #1 - file:///export/home/tsbulk_delivery) Writing file failed with: Cannot store file: tsbulk-prod/CH36158/tsbulk_delivery/selection/labsconfig1.xml\n2025-05-23 12:02:11,530 WARN  [org.apache.camel.component.file.remote.RemoteFileProducer:87] (Camel (tsbulk-sftp-context) thread #1 - file:///export/home/tsbulk_delivery) Writing file failed with: Cannot store file: tsbulk-prod/CH36158/tsbulk_delivery/selection/labsconfig1.xml\n2025-05-23 12:02:12,925 WARN  [org.apache.camel.component.file.remote.RemoteFileProducer:87] (Camel (tsbulk-sftp-context) thread #1 - file:///export/home/tsbulk_delivery) Writing file failed with: Cannot store file: tsbulk-prod/CH36158/tsbulk_delivery/selection/labsconfig1.xml\n2025-05-23 12:02:14,255 WARN  [org.apache.camel.component.file.remote.RemoteFileProducer:87] (Camel (tsbulk-sftp-context) thread #1 - file:///export/home/tsbulk_delivery) Writing file failed with: Cannot store file: tsbulk-prod/CH36158/tsbulk_delivery/selection/labsconfig1.xml\n2025-05-23 12:02:15,658 WARN  [org.apache.camel.component.file.remote.RemoteFileProducer:87] (Camel (tsbulk-sftp-context) thread #1 - file:///export/home/tsbulk_delivery) Writing file failed with: Cannot store file: tsbulk-prod/CH36158/tsbulk_delivery/selection/labsconfig1.xml\n2025-05-23 12:02:17,103 WARN  [org.apache.camel.component.file.remote.RemoteFileProducer:87] (Camel (tsbulk-sftp-context) thread #1 - file:///export/home/tsbulk_delivery) Writing file failed with: Cannot store file: tsbulk-prod/CH36158/tsbulk_delivery/selection/labsconfig1.xml\n2025-05-23 12:02:18,452 WARN  [org.apache.camel.component.file.remote.RemoteFileProducer:87] (Camel (tsbulk-sftp-context) thread #1 - file:///export/home/tsbulk_delivery) Writing file failed with: Cannot store file: tsbulk-prod/CH36158/tsbulk_delivery/selection/labsconfig1.xml\n2025-05-23 12:02:19,787 WARN  [org.apache.camel.component.file.remote.RemoteFileProducer:87] (Camel (tsbulk-sftp-context) thread #1 - file:///export/home/tsbulk_delivery) Writing file failed with: Cannot store file: tsbulk-prod/CH36158/tsbulk_delivery/selection/labsconfig1.xml\n2025-05-23 12:02:21,133 WARN  [org.apache.camel.component.file.remote.RemoteFileProducer:87] (Camel (tsbulk-sftp-context) thread #1 - file:///export/home/tsbulk_delivery) Writing file failed with: Cannot store file: tsbulk-prod/CH36158/tsbulk_delivery/selection/labsconfig1.xml\n2025-05-23 12:02:22,506 WARN  [org.apache.camel.component.file.remote.RemoteFileProducer:87] (Camel (tsbulk-sftp-context) thread #1 - file:///export/home/tsbulk_delivery) Writing file failed with: Cannot store file: tsbulk-prod/CH36158/tsbulk_delivery/selection/labsconfig1.xml\n2025-05-23 12:02:22,508 ERROR [org.apache.camel.processor.errorhandler.DefaultErrorHandler:205] (Camel (tsbulk-sftp-context) thread #1 - file:///export/home/tsbulk_delivery) Failed delivery for (MessageId: 44C4CB7F36787D0-000000000000001F on ExchangeId: 44C4CB7F36787D0-000000000000001F). Exhausted after delivery attempt: 11 caught: org.apache.camel.component.file.GenericFileOperationFailedException: Cannot store file: tsbulk-prod/CH36158/tsbulk_delivery/selection/labsconfig1.xml\n\nMessage History (complete message history is disabled)\n---------------------------------------------------------------------------------------------------------------------------------------\nRouteId              ProcessorId          Processor                                                                        Elapsed (ms)\n[selection-files   ] [selection-files   ] [from[file:///export/home/tsbulk_delivery?antInclude=*%2Fselection%2F*.xml&amp;flat] [     55166]\n        ...\n[selection-files   ] [to1               ] [sftp:&lt;SERVER&gt;:6323/tsbulk-prod?preferredAuthentications=publi] [         0]\n\nStacktrace\n---------------------------------------------------------------------------------------------------------------------------------------\n: org.apache.camel.component.file.GenericFileOperationFailedException: Cannot store file: tsbulk-prod/CH36158/tsbulk_delivery/selection/labsconfig1.xml\n        at org.apache.camel.component.file.remote.SftpOperations.doStoreFile(SftpOperations.java:1061)\n        at org.apache.camel.component.file.remote.SftpOperations.storeFile(SftpOperations.java:977)\n        at org.apache.camel.component.file.GenericFileProducer.writeFile(GenericFileProducer.java:290)\n        at org.apache.camel.component.file.GenericFileProducer.processExchange(GenericFileProducer.java:173)\n        at org.apache.camel.component.file.remote.RemoteFileProducer.process(RemoteFileProducer.java:61)\n        at org.apache.camel.support.AsyncProcessorConverterHelper$ProcessorToAsyncProcessorBridge.process(AsyncProcessorConverterHelper.java:66)\n        at org.apache.camel.processor.SendProcessor.lambda$process$2(SendProcessor.java:191)\n        at org.apache.camel.support.cache.DefaultProducerCache.doInAsyncProducer(DefaultProducerCache.java:327)\n        at org.apache.camel.processor.SendProcessor.process(SendProcessor.java:190)\n        at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler$RedeliveryTask.redeliver(RedeliveryErrorHandler.java:895)\n        at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.schedule(DefaultReactiveExecutor.java:193)\n        at org.apache.camel.impl.engine.DefaultReactiveExecutor.scheduleMain(DefaultReactiveExecutor.java:64)\n        at org.apache.camel.processor.Pipeline.process(Pipeline.java:185)\n        at org.apache.camel.impl.engine.CamelInternalProcessor.process(CamelInternalProcessor.java:398)\n        at org.apache.camel.component.file.GenericFileConsumer.processExchange(GenericFileConsumer.java:492)\n        at org.apache.camel.component.file.GenericFileConsumer.processBatch(GenericFileConsumer.java:245)\n        at org.apache.camel.component.file.GenericFileConsumer.poll(GenericFileConsumer.java:206)\n        at org.apache.camel.support.ScheduledPollConsumer.doRun(ScheduledPollConsumer.java:202)\n        at org.apache.camel.support.ScheduledPollConsumer.run(ScheduledPollConsumer.java:116)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n        at java.lang.Thread.run(Thread.java:750)\nCaused by: 3: Permission denied.\n        at com.jcraft.jsch.ChannelSftp.throwStatusError(ChannelSftp.java:2830)\n        at com.jcraft.jsch.ChannelSftp._put(ChannelSftp.java:561)\n        at com.jcraft.jsch.ChannelSftp.put(ChannelSftp.java:509)\n        at com.jcraft.jsch.ChannelSftp.put(ChannelSftp.java:464)\n        at org.apache.camel.component.file.remote.SftpOperations.doStoreFile(SftpOperations.java:1039)\n        ... 25 more\n</code></pre>\n<p>The weird thing is that, if I connect to the SFTP server with WinSCP, I can actually see the files in there being uploaded/updated.</p>\n<p>The SFTP endpoint is defined as follows:</p>\n<pre class=\"lang-java prettyprint-override\"><code>protected StringBuilder buildTargetSftpEndpoint() {\n    final StringBuilder builder = new StringBuilder();\n    builder.append(&quot;sftp:&quot;);\n    builder.append(config.getHost());\n    builder.append(&quot;:&quot;);\n    builder.append(config.getPort());\n    if(!config.getRootDirectoryName().startsWith(&quot;/&quot;)) builder.append(&quot;/&quot;);\n    builder.append(config.getRootDirectoryName());\n    builder.append(&quot;?preferredAuthentications=publickey&quot;);\n    builder.append(&quot;&amp;fastExistsCheck=true&quot;);\n    builder.append(&quot;&amp;greedy=true&quot;);\n    builder.append(&quot;&amp;throwExceptionOnConnectFailed=true&quot;);\n    builder.append(&quot;&amp;initialDelay=0&quot;);\n    builder.append(&quot;&amp;stepwise=false&quot;);\n    builder.append(&quot;&amp;reconnectDelay=0&quot;);\n    builder.append(&quot;&amp;serverAliveCountMax=0&quot;);\n    builder.append(&quot;&amp;serverAliveInterval=0&quot;);\n    builder.append(&quot;&amp;username=&quot;);\n    builder.append(config.getUsername());\n    builder.append(&quot;&amp;privateKeyFile=&quot;);\n    builder.append(config.getSshPrivateKey());\n    builder.append(&quot;&amp;knownHostsFile=&quot;);\n    builder.append(config.getSshKnownHostsFile());\n    builder.append(&quot;&amp;maximumReconnectAttempts=&quot;);\n    builder.append(maxRetries);\n\n    return builder;\n}\n</code></pre>\n<p>The file endpoint is defined as follows:</p>\n<pre class=\"lang-java prettyprint-override\"><code>private String buildSourceEndpointUri() {\n    final StringBuilder builder = new StringBuilder();\n    builder.append(&quot;file:&quot;);\n    if(!getBaseDirectory().startsWith(&quot;/&quot;)) builder.append(&quot;/&quot;);\n    builder.append(getBaseDirectory());\n    builder.append(&quot;?recursive=true&quot;);\n    builder.append(&quot;&amp;flatten=false&quot;);\n    builder.append(&quot;&amp;startingDirectoryMustExist=true&quot;);\n    builder.append(&quot;&amp;noop=true&quot;);\n    builder.append(&quot;&amp;idempotent=true&quot;);\n    builder.append(&quot;&amp;idempotentKey=${file:name}-${file:modified}&quot;);\n    builder.append(&quot;&amp;greedy=true&quot;);\n    builder.append(&quot;&amp;initialDelay=0&quot;);\n    builder.append(&quot;&amp;antInclude=&quot;);\n    builder.append(&quot;*/&quot;);\n    builder.append(selectionSpace.getDir());\n    builder.append(&quot;/*.xml&quot;);\n\n    return builder.toString();\n}\n</code></pre>\n<p>The route is defined as follows:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@PostConstruct\nprivate void setup() {\n    processor = new FilePathAdjusterProcessor(getBaseDirectory());\n}\n\n@Override\npublic void configure() {\n    onException(FileNotFoundException.class).continued(true);\n    errorHandler(defaultErrorHandler().maximumRedeliveries(max(0, config.getMaxRetries())).redeliveryDelay(max(0, config.getRetriesDelayMs())));\n\n    configureRoute();\n}\n\n@Override\nprotected StringBuilder buildTargetSftpEndpoint() {\n    return super.buildTargetSftpEndpoint().append(&quot;&amp;disconnect=true&quot;);\n}\n\n@Override\nprotected void configureRoute() {\n    from(buildSourceEndpointUri())\n    .routeId(routeId)\n    .process(processor)\n    .to(buildTargetSftpEndpoint().toString())\n    .log(logLevel, logMessageTemplate);\n}\n</code></pre>\n<p>The processor is</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class FilePathAdjusterProcessor implements Processor {\n    private final Path baseDirectory;\n    FilePathAdjusterProcessor(String baseDirectory) {\n        this.baseDirectory = Paths.get(baseDirectory);\n    }\n\n    @Override\n    public void process(Exchange exchange) {\n        Path deliveryFolderName = baseDirectory.getFileName();\n        Path relativeFilePath = baseDirectory.relativize(exchange.getIn().getBody(File.class).toPath());\n        Path customerName = relativeFilePath.getName(0);\n        Path filePathWithoutCustomerName = relativeFilePath.subpath(1, relativeFilePath.getNameCount());\n        Path extendedPath = customerName.resolve(deliveryFolderName).resolve(filePathWithoutCustomerName);\n\n        exchange.getMessage().setHeader(OVERRULE_FILE_NAME, extendedPath);\n    }\n}\n</code></pre>\n<p>The code below checks the same, but using JSch only</p>\n<pre class=\"lang-java prettyprint-override\"><code>private static final int PORT = 6323;\nprivate static final String USERNAME = &quot;tsbulk&quot;;\nprivate static final String HOST = &quot;&lt;SERVER&gt;&quot;;\nprivate static final String ROOT_DIRECTORY = &quot;/tsbulk-prod&quot;;\nprivate static final String PRIVATE_KEY = &quot;&lt;PRIVATE-KEY-PATH&gt;&quot;\n\npublic static void main(String[] args) throws JSchException, IOException, SftpException {\n    Path file = Files.write(createTempFile(&quot;foo&quot;, &quot;bar&quot;), &quot;test&quot;.getBytes(UTF_8));\n    Path targetPath = Paths.get(ROOT_DIRECTORY, &quot;CH10601&quot;, &quot;tsbulk_delivery&quot;, &quot;test&quot;, &quot;jsch.xml&quot;);\n    JSch jSch = new JSch();\n    jSch.addIdentity(PRIVATE_KEY);\n    Session session = jSch.getSession(USERNAME, HOST, PORT);\n    session.setConfig(&quot;StrictHostKeyChecking&quot;, &quot;no&quot;);\n    session.setConfig(&quot;PreferredAuthentications&quot;, &quot;publickey&quot;);\n    session.connect();\n    ChannelSftp sftp = (ChannelSftp) session.openChannel(&quot;sftp&quot;);\n    sftp.connect();\n    for(int i = 0; i &lt; targetPath.getNameCount() - 1; ++i) {\n        try {\n            sftp.cd(targetPath.getName(i).toString());\n        } catch (SftpException ex) {\n            sftp.mkdir(targetPath.getName(i).toString());\n            sftp.cd(targetPath.getName(i).toString());\n        }\n    }\n    sftp.put(file.toString(), targetPath.getFileName().toString());\n    sftp.rm(targetPath.getFileName().toString());\n    sftp.disconnect();\n    session.disconnect();\n}\n</code></pre>\n<p>and it works with no issues.</p>\n<p>Honestly, I don't know what to look for anymore, especially given the fact that the same exact code is working correctly in the QA environment against the QA SFTP server, but not in PROD anymore and only since a week or so.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}