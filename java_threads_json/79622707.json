{
  "question": {
    "tags": [
      "java",
      "java-stream",
      "java-24"
    ],
    "owner": {
      "account_id": 5174533,
      "reputation": 13154,
      "user_id": 4142130,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/164f6e8d8691de95326965a42bfe8fab?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Hoopje",
      "link": "https://stackoverflow.com/users/4142130/hoopje"
    },
    "is_answered": true,
    "view_count": 617,
    "accepted_answer_id": 79643092,
    "answer_count": 1,
    "score": 17,
    "last_activity_date": 1748502914,
    "creation_date": 1747288948,
    "question_id": 79622707,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79622707/why-doesnt-my-gatherer-short-circuit-the-stream-if-the-source-is-an-intstream",
    "title": "Why doesn&#39;t my Gatherer short-circuit the Stream if the source is an IntStream?",
    "body": "<p>I'm playing around with Stream Gatherers, which were introduced (or, at least, lost preview-status) in Java 24. As an exercise, I implemented my own version of the <code>limit</code> intermediate operation:</p>\n<pre><code>public class LimitDemo {\n\n    private static class State {\n        int count;\n    }\n\n    static &lt;T&gt; Gatherer&lt;T, ?, T&gt; limit(int size) {\n        Supplier&lt;State&gt; initializer = State::new;\n        Gatherer.Integrator&lt;State, T, T&gt; integrator = (state, element, downstream) -&gt; {\n            if (++state.count &gt; size) {\n                return false;\n            }\n            return downstream.push(element);\n        };\n        return Gatherer.ofSequential(initializer, integrator);\n    }\n\n    public static void main(String[] args) {\n        var rng = new Random();\n        var result = \n            Stream.generate(() -&gt; rng.nextInt(10)) // here\n            .gather(limit(10))\n            .toList();\n        System.out.println(result);\n    }\n}\n</code></pre>\n<p>This works very well: a list of 10 random numbers is printed on the screen, as I expected. The infinite stream of random Integers is short-circuited.</p>\n<p>However, if I generate the infinite stream in another way, it doesn't work anymore. If I replace the line marked <code>// here</code> with</p>\n<pre><code>rng.ints(0, 10).boxed()\n</code></pre>\n<p>then my program terminates with an OutOfMemoryException. Apparently, the IntStream generated by the <code>Random</code> instance doesn't notice that my Gatherer short-circuits. Of course, when I use the standard <code>limit</code> instead of my custom one, it works in both cases.</p>\n<p>What am I missing?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}