{
  "question": {
    "tags": [
      "java",
      "android",
      "widget"
    ],
    "owner": {
      "account_id": 29395671,
      "reputation": 13,
      "user_id": 22523072,
      "user_type": "registered",
      "profile_image": "https://lh3.googleusercontent.com/a/AAcHTtcJBukLhEy5RR0xs9NPT7OOhLsdRkielUyl7iL0ob1R=k-s256",
      "display_name": "Teriteh Teriteh",
      "link": "https://stackoverflow.com/users/22523072/teriteh-teriteh"
    },
    "is_answered": true,
    "view_count": 213,
    "accepted_answer_id": 78950589,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1725484601,
    "creation_date": 1708900707,
    "question_id": 78057925,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78057925/weather-widget-in-java-in-android-studio",
    "title": "Weather widget in Java in Android Studio",
    "body": "<p>I wrote a widget in Java in Android Studio. This widget takes and displays the weather from an api from the internet.\nThe problem is that this widget stops working after staying on the phone for a while or as soon as the phone is turned off and on and does not show any reaction.\nWhat should I do to solve this problem?</p>\n<p>When the WeatherApiClient.java class is called, it reads the weather from the Internet, and the widget_size_1.java class loads the information in the widget.</p>\n<p><code>widget_size_1.java</code></p>\n<pre><code>import android.annotation.SuppressLint;\nimport android.app.PendingIntent;\nimport android.appwidget.AppWidgetManager;\nimport android.appwidget.AppWidgetProvider;\nimport android.content.ComponentName;\nimport android.content.Context;\nimport android.content.Intent;\nimport android.location.Location;\nimport android.location.LocationManager;\nimport android.util.Log;\nimport android.widget.RemoteViews;\nimport androidx.annotation.NonNull;\nimport java.text.DecimalFormat;\n\npublic class widget_size_1 extends AppWidgetProvider {\n\n    String temp, city, desc;\n\n    public void updateAppWidget(@NonNull Context context, String shahr, String temp, String desc, int appWidgetId) {\n        // Construct the RemoteViews object\n        RemoteViews views = new RemoteViews(context.getPackageName(), R.layout.widget_size_1);\n        views.setTextViewText(R.id.widget_city, shahr);\n        views.setTextViewText(R.id.widget_desc, desc);\n        views.setTextViewText(R.id.widget_temp, temp);\n\n        // Setting up the onClickListener for the refresh icon\n        Intent intent = new Intent(context, widget_size_1.class);\n        intent.setAction(AppWidgetManager.ACTION_APPWIDGET_UPDATE);\n        intent.putExtra(AppWidgetManager.EXTRA_APPWIDGET_IDS, new int[]{appWidgetId});\n\n        PendingIntent pendingIntent = PendingIntent.getBroadcast(context, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE);\n        views.setOnClickPendingIntent(R.id.widget_refresh, pendingIntent);\n\n        // Instruct the widget manager to update the widget\n        AppWidgetManager appWidgetManager = AppWidgetManager.getInstance(context);\n        appWidgetManager.updateAppWidget(appWidgetId, views);\n    }\n\n    @Override public void onReceive(Context context, Intent intent) {\n        super.onReceive(context, intent);\n        int[] appWidgetIds = intent.getIntArrayExtra(AppWidgetManager.EXTRA_APPWIDGET_IDS);\n\n        // Handling the onClick event for the refresh icon\n        if (intent.getAction() != null &amp;&amp; intent.getAction().equals(AppWidgetManager.ACTION_APPWIDGET_UPDATE)) {\n            for (int appWidgetId : appWidgetIds)\n                resetWidget(context, appWidgetId);\n            performBtnSetAction(context);\n\n            // Update the widget views (if needed)\n            AppWidgetManager appWidgetManager = AppWidgetManager.getInstance(context);\n            if (appWidgetIds != null) {\n                onUpdate(context, appWidgetManager, appWidgetIds);\n            }\n        }\n    }\n\n    private void performBtnSetAction(@NonNull Context context) {\n        RemoteViews views = new RemoteViews(context.getPackageName(), R.layout.widget_size_1);\n        AppWidgetManager appWidgetManager = AppWidgetManager.getInstance(context);\n        int[] appWidgetIds = appWidgetManager.getAppWidgetIds(new ComponentName(context, widget_size_1.class));\n        \n        onUpdate(context, appWidgetManager, appWidgetIds);\n\n        for (int appWidgetId : appWidgetIds)\n            currentLocTempReader(context);\n    }\n    \n    public void currentLocTempReader(@NonNull Context context) {\n        @SuppressLint(&quot;SetTextI18n&quot;)\n        LocationManager locationManager = (LocationManager) context.getSystemService(Context.LOCATION_SERVICE);\n        GpsClass gpsClass = new GpsClass(locationManager, context);\n        Location location = gpsClass.getLocation2();\n        LinkCreator linkCreator = new LinkCreator(context);\n        WeatherApiClient weatherApiClient = new WeatherApiClient(&quot;base url&quot;);\n\n        weatherApiClient.getCurrentWeatherData(location.getLatitude(),location.getLongitude(),linkCreator.GetOWMApiKey(), new WeatherApiClient.WeatherCallback() {\n            @Override\n            public void onSuccess(WeatherData weatherData) {\n                city = weatherData.getName();\n                DecimalFormat decimalFormat = new DecimalFormat(&quot;#,##0.00&quot;);\n                temp = decimalFormat.format(weatherData.getMain().getTemp());\n                desc = weatherData.getWeather()[0].getDescription();\n                setDataToWidget(context);\n                Log.i(&quot;MyWidgetLogs&quot;, &quot; ok&quot;);\n            }\n\n            @Override\n            public void onFailure(Throwable throwable) {\n                Log.e(&quot;MyWidgetLogs&quot;, throwable.toString());\n            }\n        });\n    }\n\n    private void setDataToWidget(Context context) {\n        AppWidgetManager appWidgetManager = AppWidgetManager.getInstance(context);\n        int[] appWidgetIds = appWidgetManager.getAppWidgetIds(new ComponentName(context, widget_size_1.class));\n        \n        for (int appWidgetId : appWidgetIds)\n            updateAppWidget(context, city, temp, desc, appWidgetId);\n    }\n\n    public void resetWidget(Context context, int appWidgetId) {\n        // Construct the RemoteViews object\n        RemoteViews views = new RemoteViews(context.getPackageName(), R.layout.widget_size_1);\n        views.setTextViewText(R.id.widget_city, &quot;Loading...&quot;);\n        views.setTextViewText(R.id.widget_desc, &quot;Loading...&quot;);\n        views.setTextViewText(R.id.widget_temp, &quot;Loading...&quot;);\n\n        // Setting up the onClickListener for the refresh icon\n        Intent intent = new Intent(context, widget_size_1.class);\n        intent.setAction(AppWidgetManager.ACTION_APPWIDGET_UPDATE);\n        intent.putExtra(AppWidgetManager.EXTRA_APPWIDGET_IDS, new int[]{appWidgetId});\n\n        PendingIntent pendingIntent = PendingIntent.getBroadcast(context, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE);\n        views.setOnClickPendingIntent(R.id.widget_refresh, pendingIntent);\n\n        // Instruct the widget manager to update the widget\n        AppWidgetManager appWidgetManager = AppWidgetManager.getInstance(context);\n        appWidgetManager.updateAppWidget(appWidgetId, views);\n        performBtnSetAction(context);\n    }\n\n    @Override public void onUpdate(Context context, AppWidgetManager appWidgetManager, @NonNull int[] appWidgetIds) {\n        for (int appWidgetId : appWidgetIds) {\n            updateAppWidget(context, city, temp, desc, appWidgetId);\n        }\n    }\n\n    @Override public void onEnabled(Context context) {}\n    @Override public void onDisabled(Context context) {}\n}\n</code></pre>\n<p><code>WeatherApiClient.java</code></p>\n<pre><code>import android.util.Log;\nimport retrofit2.Call;\nimport retrofit2.Callback;\nimport retrofit2.Response;\nimport retrofit2.Retrofit;\nimport retrofit2.converter.gson.GsonConverterFactory;\nimport retrofit2.http.GET;\n\npublic class WeatherApiClient {\n\n    private final WeatherApi weatherApi;\n\n    public WeatherApiClient(String baseURL) {\n        Retrofit retrofit = new Retrofit.Builder()\n                .baseUrl(baseURL)\n                .addConverterFactory(GsonConverterFactory.create())\n                .build();\n\n        weatherApi = retrofit.create(WeatherApi.class);\n        mytest();\n    }\n\n    public void getCurrentWeatherData(\n            double lat, double lon, String apiKey, final WeatherCallback callback) {\n        String url = &quot;weather?lat=&quot; + lat + &quot;&amp;lon=&quot; + lon + &quot;&amp;appid=&quot; + apiKey;\n\n        Call&lt;WeatherData&gt; call = weatherApi.getWeatherData(url);\n        try {\n            call.enqueue(new Callback&lt;WeatherData&gt;() {\n                @Override\n                public void onResponse(Call&lt;WeatherData&gt; call, Response&lt;WeatherData&gt; response) {\n                    if (response.isSuccessful()) {\n                        WeatherData weatherData = response.body();\n                        callback.onSuccess(weatherData);\n                    } else {\n                        callback.onFailure(new Exception(&quot;Response not successful&quot;));\n                    }\n                }\n\n                @Override\n                public void onFailure(Call&lt;WeatherData&gt; call, Throwable t) {\n                    callback.onFailure(t);\n                }\n            });\n        } catch (Throwable e) {\n            Log.e(MainActivity.myExceptionTag + &quot; Callback&lt;WeatherData&gt;&quot;, e.toString());\n        }\n    }\n\n    protected void mytest() {\n\n        TestApiClient testApiClient = new TestApiClient(&quot;https://www.stackoverflow.com&quot;);\n\n        testApiClient.getTestData(new TestCallback() {\n            @Override\n            public void onSuccess(Object data) {\n                Log.d(&quot;TestApiClient&quot;, &quot;Response: &quot; + data.toString());\n            }\n\n            @Override\n            public void onFailure(Throwable throwable) {\n                Log.e(&quot;TestApiClient&quot;, &quot;Error: &quot; + throwable.toString());\n            }\n        });\n    }\n\n    public class TestApiClient {\n\n        private final TestApi testApi;\n\n        public TestApiClient(String baseUrl) {\n            Retrofit retrofit = new Retrofit.Builder()\n                    .baseUrl(baseUrl)\n                    .addConverterFactory(GsonConverterFactory.create())\n                    .build();\n\n            testApi = retrofit.create(TestApi.class);\n        }\n\n        public void getTestData(final TestCallback callback) {\n            Call&lt;Object&gt; call = testApi.getTestData();\n            call.enqueue(new retrofit2.Callback&lt;Object&gt;() {\n                @Override\n                public void onResponse(Call&lt;Object&gt; call, retrofit2.Response&lt;Object&gt; response) {\n                    if (response.isSuccessful()) {\n                        callback.onSuccess(response.body());\n                    } else {\n                        callback.onFailure(new Exception(&quot;Response not successful&quot;));\n                    }\n                }\n\n                @Override\n                public void onFailure(Call&lt;Object&gt; call, Throwable t) {\n                    callback.onFailure(t);\n                }\n            });\n        }\n    }\n\n    public interface TestCallback {\n        void onSuccess(Object data);\n        void onFailure(Throwable throwable);\n    }\n\n    public interface TestApi {\n        @GET(&quot;/posts/1&quot;)\n        Call&lt;Object&gt; getTestData();\n    }\n\n    public interface WeatherCallback {\n        void onSuccess(WeatherData weatherData);\n\n        void onFailure(Throwable throwable);\n    }\n}\n</code></pre>\n<p>The internet status has been checked and the internet is active\nThe api status has been checked and is active</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}