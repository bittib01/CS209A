{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-boot",
      "spring-websocket"
    ],
    "owner": {
      "account_id": 29116701,
      "reputation": 13,
      "user_id": 22305263,
      "user_type": "registered",
      "profile_image": "https://lh3.googleusercontent.com/a/AAcHTtf56ZPQC9clAaqyVbIIl-RJ84z-GbFgA7EoG9koN1vE=k-s256",
      "display_name": "valerii",
      "link": "https://stackoverflow.com/users/22305263/valerii"
    },
    "is_answered": true,
    "view_count": 135,
    "accepted_answer_id": 79674493,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1750548457,
    "creation_date": 1750506201,
    "last_edit_date": 1750540861,
    "question_id": 79674395,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79674395/spring-boot-websocket-stomp-jwt-preauthorize-securitycontext-problem-auth",
    "title": "Spring Boot WebSocket STOMP + JWT (@PreAuthorize) SecurityContext problem: &quot;Authentication object was not found&quot;",
    "body": "<p>I'm building a Spring Boot chat application with:</p>\n<ul>\n<li>WebSocket (STOMP) endpoint (with message broker)</li>\n<li>Clients connect via STOMP and authenticate with JWT (sent as a STOMP Authorization header in the CONNECT frame)</li>\n<li>Spring Security with @PreAuthorize on @MessageMapping methods</li>\n</ul>\n<p>I have a ChannelInterceptor that:</p>\n<pre><code>- On CONNECT, parses the JWT from the Authorization header\n- Validates JWT and creates an Authentication object (with authorities)\n- Calls StompHeaderAccessor.setUser(authentication)\n</code></pre>\n<p>My controller looks like:</p>\n<pre><code>@MessageMapping(&quot;/chat/message.send&quot;)\n@PreAuthorize(&quot;hasAuthority('SCOPE_WRITE')&quot;)\npublic void sendMessage(@Payload MessageRequestDto dto) {\n\n}\n</code></pre>\n<p>But whenever a STOMP SEND is received, I get:\nAuthenticationCredentialsNotFoundException: An Authentication object was not found in the SecurityContext</p>\n<p>because of :</p>\n<pre><code>private Authentication getAuthenticationOrThrow() {\n        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();\n        if (authentication == null || !authentication.isAuthenticated())\n            throw new AuthenticationCredentialsNotFoundException(&quot;No authenticated user found in SecurityContext&quot;);\n\n        return authentication;\n    }\n</code></pre>\n<p>How do I properly wire up Spring Security so that the user authenticated at STOMP CONNECT (via JWT) is available in the SecurityContext for each @MessageMapping?(i can provide github link if needed - <a href=\"https://github.com/engly817chat/engly-server\" rel=\"nofollow noreferrer\">https://github.com/engly817chat/engly-server</a>) it is a univ project</p>\n<p>I implemented a custom ChannelInterceptor which, on each STOMP CONNECT, extracts the Authorization header from the STOMP frame, validates the JWT, and sets the authenticated user using accessor.setUser(authentication).\nI also tried (as suggested by Spring/StackOverflow answers) adding a second ChannelInterceptor that, for every inbound message, copies accessor.getUser() (if it's an Authentication) into the SecurityContextHolder. I confirmed in logs that accessor.getUser() is a valid Authentication object during message handling, with the correct authorities.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}