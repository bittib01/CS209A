{
  "question": {
    "tags": [
      "java",
      "linux",
      "linux-kernel",
      "network-programming",
      "system-calls"
    ],
    "owner": {
      "account_id": 7909307,
      "reputation": 409,
      "user_id": 5973816,
      "user_type": "registered",
      "profile_image": "https://lh3.googleusercontent.com/-RjPvqkf3rZw/AAAAAAAAAAI/AAAAAAAAABY/-YxB_dQMpKo/s256-rj/photo.jpg",
      "display_name": "Poison",
      "link": "https://stackoverflow.com/users/5973816/poison"
    },
    "is_answered": true,
    "view_count": 350,
    "answer_count": 2,
    "score": 2,
    "last_activity_date": 1711725510,
    "creation_date": 1703607231,
    "last_edit_date": 1704285174,
    "question_id": 77718137,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/77718137/why-does-ioctl-with-siocgifconf-occasionally-execute-slowly",
    "title": "Why does ioctl with SIOCGIFCONF occasionally execute slowly?",
    "body": "<p>When I used JDK8 on Linux, I found that the <code>java.net.NetworkInterface#getNetworkInterfaces</code> method occasionally took several seconds to return, so I wrote the following Java program to try to reproduce the problem:</p>\n<pre class=\"lang-java prettyprint-override\"><code>import java.net.NetworkInterface;\nimport java.net.SocketException;\nimport java.time.LocalDateTime;\nimport java.time.format.DateTimeFormatter;\n\npublic class NetworkTest {\n\n    private static final DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;);\n\n    public static void main(String[] args) {\n        while (true) {\n            try {\n                long startTime = System.currentTimeMillis();\n                NetworkInterface.getNetworkInterfaces();\n                long endTime = System.currentTimeMillis();\n\n                long cost = endTime - startTime;\n                if (cost &gt; 200) {\n                    System.out.println(&quot;time: &quot; + LocalDateTime.now().format(DATE_TIME_FORMATTER) + &quot;, cost: &quot; + cost + &quot;ms&quot;);\n                }\n            } catch (SocketException e) {\n                throw new RuntimeException(e);\n            }\n\n            try {\n                Thread.sleep(1000);\n            } catch (InterruptedException e) {\n                throw new RuntimeException(e);\n            }\n        }\n    }\n\n}\n</code></pre>\n<p>At the same time, I used <code>strace</code> to trace the program and found that ioctl with SIOCGIFCONF occasionally executed slowly. The following is the captured log that took a long time.</p>\n<p>Java output:</p>\n<pre><code>time: 2023-12-26 20:51:22.453, cost: 1971ms\n</code></pre>\n<p><code>strace</code> output:</p>\n<pre><code>20:51:20.482408 socket(PF_INET, SOCK_DGRAM, IPPROTO_IP) = 8\n20:51:20.482448 ioctl(8, SIOCGIFCONF, {1000 -&gt; 80, NULL}) = 0\n20:51:21.450974 ioctl(8, SIOCGIFCONF, {80, {{&quot;lo&quot;, {AF_INET, inet_addr(&quot;127.0.0.1&quot;)}}, {&quot;eth0&quot;, {AF_INET, inet_addr(&quot;10.0.16.15&quot;)}}}}) = 0\n20:51:22.452894 ioctl(8, SIOCGIFFLAGS, {ifr_name=&quot;lo&quot;, ifr_flags=IFF_UP|IFF_LOOPBACK|IFF_RUNNING}) = 0\n20:51:22.452960 ioctl(8, SIOCGIFNETMASK, {ifr_name=&quot;lo&quot;, ifr_netmask={AF_INET, inet_addr(&quot;255.0.0.0&quot;)}}) = 0\n20:51:22.453023 ioctl(8, SIOCGIFINDEX, {ifr_name=&quot;lo&quot;, ifr_index=1}) = 0\n20:51:22.453060 ioctl(8, SIOCGIFFLAGS, {ifr_name=&quot;eth0&quot;, ifr_flags=IFF_UP|IFF_BROADCAST|IFF_RUNNING|IFF_MULTICAST}) = 0\n20:51:22.453093 ioctl(8, SIOCGIFBRDADDR, {ifr_name=&quot;eth0&quot;, ifr_broadaddr={AF_INET, inet_addr(&quot;10.0.16.15&quot;)}}) = 0\n20:51:22.453127 ioctl(8, SIOCGIFNETMASK, {ifr_name=&quot;eth0&quot;, ifr_netmask={AF_INET, inet_addr(&quot;255.255.255.255&quot;)}}) = 0\n20:51:22.453161 ioctl(8, SIOCGIFINDEX, {ifr_name=&quot;eth0&quot;, ifr_index=128}) = 0\n20:51:22.453199 close(8)                = 0\n20:51:22.453242 socket(PF_INET6, SOCK_DGRAM, IPPROTO_IP) = 8\n20:51:22.453297 open(&quot;/proc/net/if_inet6&quot;, O_RDONLY) = 9\n20:51:22.453360 fstat(9, {st_mode=S_IFREG|0444, st_size=0, ...}) = 0\n20:51:22.453410 mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f7cd648e000\n20:51:22.453448 read(9, &quot;fe80000000000000b8cef600741e59e0&quot;..., 1024) = 108\n20:51:22.453517 read(9, &quot;&quot;, 1024)       = 0\n20:51:22.453552 read(9, &quot;&quot;, 1024)       = 0\n20:51:22.453590 close(9)                = 0\n20:51:22.453646 munmap(0x7f7cd648e000, 4096) = 0\n20:51:22.453684 close(8)                = 0\n20:51:22.453991 write(1, &quot;time: 2023-12-26 20:51:22.453, c&quot;..., 41) = 41\n20:51:22.454055 write(1, &quot;\\n&quot;, 1)       = 1\n</code></pre>\n<p>From the above output, we can observe that ioctl with SIOCGIFCONF takes a long time twice. What is the possible reason? How can I continue to troubleshoot the cause?</p>\n<p><strong>Reference:</strong>\n<a href=\"https://github.com/openjdk/jdk8u/blob/master/jdk/src/solaris/native/java/net/NetworkInterface.c#L423-L479\" rel=\"nofollow noreferrer\">java.net.NetworkInterface#getAll</a></p>\n<h5>Update</h5>\n<p>I tried to use ftrace and systemtap to further troubleshoot, but because my Linux system is customized by the company, the above tools do not take effect (lack of relevant debug info). Are there any other troubleshooting ideas?</p>\n<p>If I run the above NetworkTest for a long time, I can observe that slow requests occur at intervals of half an hour, but I don't know the reason.</p>\n<pre><code>time: 2024-01-03 11:51:20.459, cost: 769ms\ntime: 2024-01-03 11:51:22.458, cost: 999ms\ntime: 2024-01-03 12:21:21.451, cost: 550ms\ntime: 2024-01-03 12:51:21.453, cost: 558ms\ntime: 2024-01-03 13:06:20.456, cost: 780ms\ntime: 2024-01-03 13:06:23.453, cost: 1995ms\ntime: 2024-01-03 13:21:19.459, cost: 786ms\ntime: 2024-01-03 13:21:21.453, cost: 994ms\ntime: 2024-01-03 13:36:20.452, cost: 777ms\ntime: 2024-01-03 13:51:20.457, cost: 777ms\ntime: 2024-01-03 13:51:23.459, cost: 1002ms\ntime: 2024-01-03 14:06:20.458, cost: 775ms\ntime: 2024-01-03 14:06:22.458, cost: 1000ms\ntime: 2024-01-03 14:21:19.450, cost: 755ms\ntime: 2024-01-03 14:21:22.453, cost: 1002ms\ntime: 2024-01-03 14:36:20.451, cost: 777ms\ntime: 2024-01-03 14:51:22.452, cost: 1754ms\ntime: 2024-01-03 14:51:24.458, cost: 1006ms\ntime: 2024-01-03 15:06:21.454, cost: 1743ms\ntime: 2024-01-03 15:06:23.458, cost: 1004ms\ntime: 2024-01-03 15:21:21.456, cost: 728ms\ntime: 2024-01-03 15:21:23.458, cost: 1001ms\ntime: 2024-01-03 15:36:21.458, cost: 727ms\ntime: 2024-01-03 15:36:25.453, cost: 1994ms\ntime: 2024-01-03 15:51:22.460, cost: 732ms\ntime: 2024-01-03 15:51:25.452, cost: 1992ms\ntime: 2024-01-03 16:06:21.455, cost: 733ms\ntime: 2024-01-03 16:06:23.456, cost: 1001ms\ntime: 2024-01-03 16:21:22.454, cost: 727ms\ntime: 2024-01-03 16:36:21.458, cost: 735ms\ntime: 2024-01-03 16:36:24.451, cost: 1993ms\ntime: 2024-01-03 16:51:22.455, cost: 732ms\ntime: 2024-01-03 17:06:21.453, cost: 726ms\ntime: 2024-01-03 17:06:23.458, cost: 1005ms\ntime: 2024-01-03 17:21:21.455, cost: 726ms\ntime: 2024-01-03 17:36:20.458, cost: 732ms\ntime: 2024-01-03 17:36:22.457, cost: 999ms\ntime: 2024-01-03 17:51:21.456, cost: 730ms\ntime: 2024-01-03 18:06:21.451, cost: 724ms\ntime: 2024-01-03 18:21:21.457, cost: 731ms\ntime: 2024-01-03 18:36:20.457, cost: 725ms\ntime: 2024-01-03 18:36:23.455, cost: 1997ms\ntime: 2024-01-03 18:51:22.458, cost: 733ms\ntime: 2024-01-03 18:51:25.453, cost: 1994ms\ntime: 2024-01-03 19:06:23.451, cost: 1720ms\ntime: 2024-01-03 19:21:21.459, cost: 728ms\ntime: 2024-01-03 19:21:23.458, cost: 999ms\ntime: 2024-01-03 19:36:21.458, cost: 729ms\ntime: 2024-01-03 19:36:24.454, cost: 1995ms\ntime: 2024-01-03 19:51:23.451, cost: 1727ms\ntime: 2024-01-03 19:51:26.454, cost: 1002ms\ntime: 2024-01-03 20:06:23.455, cost: 729ms\ntime: 2024-01-03 20:21:22.453, cost: 1727ms\ntime: 2024-01-03 20:21:24.460, cost: 1006ms\n</code></pre>\n<p>Kernel version: 4.18.0-193.el8.#{company}.x86_64</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}