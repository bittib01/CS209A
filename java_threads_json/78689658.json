{
  "question": {
    "tags": [
      "java",
      "angular",
      "spring-boot",
      "cookies",
      "spring-security"
    ],
    "owner": {
      "account_id": 13570044,
      "reputation": 592,
      "user_id": 9789035,
      "user_type": "registered",
      "profile_image": "https://lh4.googleusercontent.com/-EWpXDMV9bwo/AAAAAAAAAAI/AAAAAAAAAeg/9C1AdWxfd-M/s256-rj/photo.jpg",
      "display_name": "Gabriel Garc&#237;a Garrido",
      "link": "https://stackoverflow.com/users/9789035/gabriel-garc%c3%ada-garrido"
    },
    "is_answered": true,
    "view_count": 832,
    "answer_count": 1,
    "score": 2,
    "last_activity_date": 1722436790,
    "creation_date": 1719777641,
    "last_edit_date": 1722436790,
    "question_id": 78689658,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78689658/spring-boot-cookie-not-save-and-send-by-the-browser",
    "title": "spring boot cookie not save and send by the browser",
    "body": "<p>Hi have an spring boot application that in one service return a cookie with the following code:</p>\n<pre><code>public ResponseEntity&lt;TokenDTO&gt; login(@RequestBody CredentialsDTO credentials,HttpServletResponse response){\n        TokenWithSessionDTO tokenDTO = authServiceFacade.login( credentials );\n        if(credentials.getRememberMe() != null &amp;&amp; credentials.getRememberMe() &amp;&amp; tokenDTO.getSessionToken() != null) {\n            Cookie cookie = new Cookie( &quot;gatestats-sessionId&quot;, tokenDTO.getSessionToken() );\n            cookie.setMaxAge( 7 * 24 * 60 * 60 ); // expires in 7 days\n            cookie.setPath( &quot;/&quot; );\n            //cookie.setSecure( true );\n            //cookie.setHttpOnly( true );\n            response.addCookie( cookie );\n        }\n        return ResponseEntity.ok().header( &quot;withCredentials&quot;,&quot;true&quot; ).body(tokenDTO.getToken());\n    }\n</code></pre>\n<p>I also tried usisng ResponseCookie class instead</p>\n<pre><code>if(credentials.getRememberMe() != null &amp;&amp; credentials.getRememberMe() &amp;&amp; tokenDTO.getSessionToken() != null) {\n            ResponseCookie cookie = SessionCookieGenerator.generateSessionCookie( tokenDTO.getSessionToken() );\n            response.addHeader(&quot;Set-Cookie&quot;, cookie.toString());\n        }\n</code></pre>\n<p>it does the same with the same result</p>\n<p>I have commented just in case the httpOnly and the secure to see if this was the issue but it is not.\nIn the response in the browser I can perfectly see the header received</p>\n<p><a href=\"https://i.sstatic.net/7o3ZfPwe.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/7o3ZfPwe.png\" alt=\"enter image description here\" /></a>\n<a href=\"https://i.sstatic.net/51ox6KzH.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/51ox6KzH.png\" alt=\"enter image description here\" /></a></p>\n<p>also is not shown in the application tab</p>\n<p><a href=\"https://i.sstatic.net/iE2RpMj8.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/iE2RpMj8.png\" alt=\"enter image description here\" /></a></p>\n<p>also the cookies tab does not appear in the next requests\nfor example this one</p>\n<p><a href=\"https://i.sstatic.net/GP71dZ8Q.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/GP71dZ8Q.png\" alt=\"enter image description here\" /></a></p>\n<p>I also tried just in case to see if it is received in the following request with the code of the authentication filter I have:</p>\n<pre><code>    if(request.getCookies() != null &amp;&amp; idTokenWithBearer == null) {\n      List&lt;Cookie&gt; persistentToken = List.of( request.getCookies() );\n      Cookie seesionCookie = persistentToken.stream().filter( cookie -&gt; cookie.getName().equals( &quot;gatestats-sessionId&quot; ) )\n          .findAny().orElse( null );\n</code></pre>\n<p>But the getCookies method return null.</p>\n<p>I am usisng as a front end an angular app and I have an interceptor with he &quot;withCredentials: true&quot;, you can see other requests here:</p>\n<p><a href=\"https://i.sstatic.net/9nyB00ZK.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/9nyB00ZK.png\" alt=\"enter image description here\" /></a></p>\n<p>here just in case you want to see all headers:\n<a href=\"https://i.sstatic.net/2V4SGGM6.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/2V4SGGM6.png\" alt=\"enter image description here\" /></a></p>\n<p>I also tried to change the cookie configuration with different domains as &quot;localhost&quot;, &quot;localhost:4200&quot;, &quot;localhost:8080&quot; and anything has work.</p>\n<p>I am a bit new on cookies but as far as I know it should be shown in the application tab and then send automatically by the browser.</p>\n<p>in postman it works nice</p>\n<p><a href=\"https://i.sstatic.net/UmyhMzbE.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/UmyhMzbE.png\" alt=\"enter image description here\" /></a>\n<a href=\"https://i.sstatic.net/f5Qvfzm6.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/f5Qvfzm6.png\" alt=\"enter image description here\" /></a></p>\n<p>then withouth any Auth is sending the cookie automatically\n<a href=\"https://i.sstatic.net/2fE9kZaM.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/2fE9kZaM.png\" alt=\"enter image description here\" /></a></p>\n<p>The code I use in angular is the following in case you want to see it, but as I said the cookie does not even appear in the browser app tab.</p>\n<p>so this is the interceptor that will send the withCredentials: true</p>\n<pre><code>import { Injectable } from '@angular/core';\nimport {HttpRequest,HttpHandler,HttpEvent,HttpInterceptor} from '@angular/common/http';\nimport { from, Observable, Subscription } from 'rxjs';\nimport { AuthService } from '../services/auth.service';\nimport { CookieService } from 'ngx-cookie-service';\n\n@Injectable()\nexport class HttpTokenInterceptor implements HttpInterceptor {\n\n  constructor(private authServ : AuthService, private cookieService: CookieService) {}\n\n  intercept(request: HttpRequest&lt;unknown&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;unknown&gt;&gt; {\n    return from(this.handle(request, next));\n  }\n\n  async handle(request: HttpRequest&lt;any&gt;, next: HttpHandler) {\n\n    const cookieExists:boolean=this.cookieService.check(&quot;gatestats-sessionId&quot;);\n\n    const originalReq = request;\n    if(cookieExists){\n      request = originalReq.clone({\n        setHeaders: {\n          'Content-Type': 'application/json',\n          'withCredentials': 'true'\n        },\n      });\n      return next.handle(request).toPromise();\n    }\n    \n\n    const token = this.authServ.getIdToken();\n\n    if (token) {\n      request = originalReq.clone({\n        setHeaders: {\n          authorization: `Bearer ${token}`,\n          'Content-Type': 'application/json',\n          'withCredentials': 'true'\n        },\n      });\n    }\n    return next.handle(request).toPromise();\n\n  }\n}\n\n</code></pre>\n<p>This is the http client request just for the login</p>\n<pre><code>login(email: string, password: string, rememberMe:boolean){\n    Swal.fire({\n      icon: 'info',\n      allowOutsideClick: false,\n      text: &quot;Loging in&quot;\n    });\n    Swal.showLoading();\n\n    this.httpClient.post&lt;TokenDTO&gt;(`${environment.backendUrl}/auth/login`, new CredentialsDTO(email, password, rememberMe)).subscribe(\n      (resp : TokenDTO) =&gt; {\n        this.setIdToken(resp.idToken);\n        this.setAccessToken(resp.accessToken);\n        this.setTenant(resp.tenant);\n        this.setWebcode(resp.webcode);\n        this.setEmail(resp.email);\n        this.setExpireAt(resp.expiresIn);\n        Swal.close();\n        this.router.navigate(['/blabla/home']);\n      }\n    );\n  }\n</code></pre>\n<p>Take into account that the cookie is only sent back due to thereis a remeber me button that is received in the backend as shown in the spring boot code. The application works also with a JWT short live token used also with non remeber me is used.\nChecking or not checking the remeberme it will received the normal access token, refresh tokens and so on, but if the user has check the remeber me then when going to the login page it will check if this cookie exists and it will use this token cookie directly</p>\n<p>I also tried usisng <a href=\"http://127.0.0.1:4200/\" rel=\"nofollow noreferrer\">http://127.0.0.1:4200/</a> instead of localhost just in case. Nothing works</p>\n<p>the cors filter also is this one</p>\n<pre><code>@Component\n@Order(Ordered.HIGHEST_PRECEDENCE)\npublic class CorsFilter implements Filter {\n\n    private final List&lt;String&gt; allowedOrigins = Arrays.asList(&quot;http://localhost:4200&quot;,...more urls);\n\n    @Override\n    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)\n        throws IOException, ServletException {\n        HttpServletResponse res = (HttpServletResponse) response;\n        HttpServletRequest req = (HttpServletRequest) request;\n\n        String origin = req.getHeader(&quot;Origin&quot;);\n        res.setHeader(&quot;Access-Control-Allow-Origin&quot;, allowedOrigins.contains(origin) ? origin : &quot;*&quot;);\n        res.setHeader( &quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot; );\n        res.setHeader(&quot;Vary&quot;, &quot;Origin&quot;);\n        res.setHeader( &quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, DELETE, PUT, OPTIONS&quot; );\n        res.setHeader( &quot;Access-Control-Allow-Headers&quot;, &quot;*&quot; );\n\n        // Just REPLY OK if request method is OPTIONS for CORS (pre-flight)\n        if ( req.getMethod().equals(&quot;OPTIONS&quot;) ) {\n            res.setHeader( &quot;Access-Control-Max-Age&quot;, &quot;86400&quot; );\n            res.setStatus( HttpServletResponse.SC_OK );\n            return;\n        }\n\n        chain.doFilter( request, response );\n    }\n\n    @Override\n    public void destroy() { }\n\n    @Override\n    public void init(FilterConfig filterConfig) { }\n}\n</code></pre>\n<p>Thanks in advance for all your help and info.</p>\n<p>Any additional information you want please add me a comment and I will update the question</p>\n<p>UPDATE:</p>\n<p>in angular I change this</p>\n<p><a href=\"https://i.sstatic.net/AJzUY3K8.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/AJzUY3K8.png\" alt=\"enter image description here\" /></a></p>\n<p>And now I am getting a CORS error but not in the login request</p>\n<p><a href=\"https://i.sstatic.net/TM8ouoNJ.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/TM8ouoNJ.png\" alt=\"enter image description here\" /></a></p>\n<p>maybe this can help</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}