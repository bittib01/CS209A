{
  "question": {
    "tags": [
      "java",
      "project-panama",
      "java-ffm"
    ],
    "owner": {
      "account_id": 465573,
      "reputation": 200443,
      "user_id": 869736,
      "user_type": "registered",
      "accept_rate": 82,
      "profile_image": "https://www.gravatar.com/avatar/ae7bb06b9a23a4dd7eea69e853d47d12?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Louis Wasserman",
      "link": "https://stackoverflow.com/users/869736/louis-wasserman"
    },
    "is_answered": true,
    "view_count": 299,
    "accepted_answer_id": 79698821,
    "answer_count": 1,
    "score": 12,
    "last_activity_date": 1752376787,
    "creation_date": 1752168776,
    "question_id": 79697417,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79697417/with-a-minimum-of-copies-convert-length-bounded-utf-8-memorysegment-in-java-lan",
    "title": "With a minimum of copies, convert length-bounded UTF-8 MemorySegment in java.lang.foreign",
    "body": "<p>Suppose I have a sequence of bytes coming from C or some other native platform, expressed on the JVM as a <a href=\"https://docs.oracle.com/en/java/javase/24/docs/api/java.base/java/lang/foreign/MemorySegment.html\" rel=\"noreferrer\"><code>java.lang.foreign.MemorySegment</code></a> and an <code>int</code> (or whatever) length.  This byte sequence is <em>not</em> zero-terminated.</p>\n<p>How can I convert this into a <code>java.lang.String</code> with a minimum of copying?</p>\n<p>In particular, the Javadoc for <a href=\"https://docs.oracle.com/en/java/javase/24/docs/api/java.base/java/lang/foreign/MemorySegment.html#getString(long,java.nio.charset.Charset)\" rel=\"noreferrer\"><code>MemorySegment.getString(long, Charset)</code></a> suggests creating a fresh <code>byte[]</code>, copying the <code>MemorySegment</code> into that <code>byte[]</code>, and converting that <code>byte[]</code> to a <code>String</code>:</p>\n<pre><code>    byte[] bytes = new byte[length];\n    MemorySegment.copy(segment, JAVA_BYTE, offset, bytes, 0, length);\n    return new String(bytes, charset);\n</code></pre>\n<p>Given <a href=\"https://minborgsjavapot.blogspot.com/2023/08/java-22-panama-ffm-provides-massive.html\" rel=\"noreferrer\">Oracle's bragging about FFM's efficiency in converting strings</a>, I'd hope for there to be a way that avoids this copy, but perhaps I'm incorrect.</p>\n<p>(Please assume I'm familiar with Knuth's dictum about optimization and know that this is worth the time to optimize.)</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}