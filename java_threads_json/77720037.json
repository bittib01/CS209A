{
  "question": {
    "tags": [
      "java",
      "nosuchelementexception",
      "apache-httpclient-5.x"
    ],
    "owner": {
      "account_id": 2031487,
      "reputation": 29,
      "user_id": 1815069,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/f61147db5641b180aa2ed9d881c03f36?s=256&d=identicon&r=PG",
      "display_name": "Sam J Sem",
      "link": "https://stackoverflow.com/users/1815069/sam-j-sem"
    },
    "is_answered": true,
    "view_count": 271,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1731342984,
    "creation_date": 1703651116,
    "last_edit_date": 1703655132,
    "question_id": 77720037,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/77720037/closeablehttpclient-execute-call-results-in-nosuchelementexception",
    "title": "CloseableHttpClient execute call results in NoSuchElementException",
    "body": "<p>Hi team: I have a question regarding the use of Apache HttpClient 5 CloseableHttpClient in a Spring Boot 3 application. I am executing the following code:</p>\n<pre class=\"lang-java prettyprint-override\"><code>        try\n        {\n            final HttpGet httpGet = new HttpGet(&quot;http://httpbin.org/get&quot;);\n            httpGet.addHeader(&quot;content-type&quot;, &quot;application/json&quot;);\n            HttpClientResponseHandler&lt;String&gt; responseHandler = new HttpClientResponseHandler&lt;String&gt;()\n            {\n                @Override\n                public String handleResponse(ClassicHttpResponse _httpResponse) throws HttpException, IOException \n                {\n                    int status = _httpResponse.getCode();\n                    if (status &gt;= 200 &amp;&amp; status &lt; 300)\n                    {\n                        HttpEntity entity = _httpResponse.getEntity();\n                        String stringEntity = EntityUtils.toString(entity);\n                        return entity != null ? stringEntity : null;\n                    }\n                    else\n                    {\n                        throw new ClientProtocolException(&quot;Unexpected response status: &quot; + status);\n                    }\n                }\n            };\n            responseBody = closeableHttpClient.execute(httpGet, responseHandler);\n            log.info(&quot;Response Body: &quot; + responseBody);\n        }\n        catch (NoSuchElementException _e)\n        {\n            log.error(&quot;NoSuchElementException: &quot;+ _e.getMessage());\n            _e.printStackTrace();\n        }\n        catch (ClientProtocolException _e)\n        {\n            log.error(&quot;ClientProtocolException: &quot;+ _e.getMessage());\n        }\n        catch (IOException _e)\n        {\n            log.error(&quot;IOException: &quot;+ _e.getMessage());\n        }\n        catch (Exception _e)\n        {\n            log.error(&quot;Exception: &quot;+ _e.getMessage());\n        }\n\n</code></pre>\n<p>But when I execute this code, I get the following exception:</p>\n<blockquote>\n<p>NoSuchElementException: No more header elements available\njava.util.NoSuchElementException: No more header elements available</p>\n</blockquote>\n<p>To get the CloseableHttpClient, I have the following configurations:</p>\n<pre><code>@Slf4j\n@Configuration\n@EnableScheduling\npublic class HttpConfig\n    @Bean\n    @ConditionalOnMissingBean\n    public CloseableHttpClient httpClient(HttpClientConnectionManager connectionManager)\n    {\n        RequestConfig requestConfig = RequestConfig.custom()\n            .setConnectionRequestTimeout(Timeout.ofMilliseconds(15000))\n            .setResponseTimeout(Timeout.ofMilliseconds(15000))\n            .build();\n\n        return HttpClients.custom()\n            .setConnectionManager(connectionManager)\n            .setKeepAliveStrategy(getConnectionKeepAliveStrategy())\n            .setDefaultRequestConfig(requestConfig)\n            .build();\n    }\n\n    @Bean(destroyMethod = &quot;&quot;)\n    @ConditionalOnMissingBean\n    public HttpClientConnectionManager httpClientConnectionManager()\n    {\n        HttpHost host1 = new HttpHost(&quot;httpbin.org/get&quot;, 80);\n        final PoolingHttpClientConnectionManager connectionManager = PoolingHttpClientConnectionManagerBuilder.create()\n                .setConnectionFactory(getHttpConnectionFactory())\n                .setPoolConcurrencyPolicy(PoolConcurrencyPolicy.STRICT)\n                .setConnPoolPolicy(PoolReusePolicy.LIFO)\n                .build();\n\n        connectionManager.setMaxTotal(100);\n        connectionManager.setDefaultMaxPerRoute(20);\n        connectionManager.setMaxPerRoute(new HttpRoute(host1), 10);\n\n        return connectionManager;\n    }\n    \n    public ConnectionKeepAliveStrategy getConnectionKeepAliveStrategy()\n    {\n        final ConnectionKeepAliveStrategy connectionKeepAliveStrategy = new ConnectionKeepAliveStrategy()\n        {\n            @Override\n            public TimeValue getKeepAliveDuration(HttpResponse response, HttpContext context)\n            {\n                Args.notNull(response, &quot;HTTP response&quot;);\n                final Iterator&lt;HeaderElement&gt; iterator = MessageSupport.iterate(response, HeaderElements.KEEP_ALIVE);\n                final HeaderElement headerElement = iterator.next();\n                final String param = headerElement.getName();\n                final String value = headerElement.getValue();\n                if (value != null &amp;&amp; param.equalsIgnoreCase(&quot;timeout&quot;))\n                {\n                    try\n                    {\n                        return TimeValue.ofSeconds(Long.parseLong(value));\n                    }\n                    catch (final NumberFormatException e)\n                    {\n                        log.error(&quot;Connection Keep-Alive Strategy: Number Format Exception: Safely Ignore: &quot; + e.getMessage());\n                    }\n                }\n                return TimeValue.ofSeconds(5);\n            }\n\n        };\n        return connectionKeepAliveStrategy; \n    }\n\n    @Bean\n    public Runnable getIdleConnectionMonitor(final PoolingHttpClientConnectionManager connectionManager)\n    {\n        return new Runnable()\n        {\n            @Override\n            @Scheduled(fixedDelay = 15000)\n            public void run()\n            {\n                try\n                {\n                    if (connectionManager != null)\n                    {\n                        connectionManager.closeExpired();\n                        connectionManager.closeIdle(Timeout.ofSeconds(60000));\n                    }\n                }\n                catch (Exception e)\n                {\n                    log.error(&quot;IdleConnectionMonitor - Exception occurred: Message = {}, Exception = {}&quot;, e.getMessage(), e);\n                }\n            }\n        };\n    }\n</code></pre>\n<p>I have no idea what could be wrong here. Any help would be much appreciated.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}