{
  "question": {
    "tags": [
      "java",
      "jms",
      "activemq-artemis"
    ],
    "owner": {
      "account_id": 36462560,
      "reputation": 15,
      "user_id": 27753676,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/94a14950772239637951815998377d99?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Sergio Scaramuzzi",
      "link": "https://stackoverflow.com/users/27753676/sergio-scaramuzzi"
    },
    "is_answered": false,
    "view_count": 69,
    "answer_count": 0,
    "score": 0,
    "last_activity_date": 1740080052,
    "creation_date": 1739994539,
    "last_edit_date": 1740080052,
    "question_id": 79452615,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79452615/client-failover-not-failing-to-backup-broker-first",
    "title": "Client failover not failing to backup broker first",
    "body": "<p>I am struggling to get my client to failover as I'd expect in my cluster.</p>\n<p>I am expecting that when 1 node fails my client should jump to that nodeâ€™s backup in the topology. However, what I see occur is my client jumps to another primary node instead. Sometimes I do see things behave as expected but it seems to depend on where my consumers get initially created....</p>\n<p>For example, if I have consumer A end up on broker A, and consumer B end up on broker B, then when I close broker A consumer A will just jump over to broker B instead of jumping over to its replicated backup. Then if I close broker B after restarting broker A the consumer that had previously jumped to broker B will jump back to broker A while the other consumer properly goes into the back up for broker B.</p>\n<p>I'm not sure if it will change anything or be of importance but I am using a replicated setup for HA where I have all 6 nodes just running locally with ports offset. The end goal will be 3 servers but for now this is just so I can test things out.</p>\n<p>I've also read these docs on <a href=\"https://activemq.apache.org/components/artemis/documentation/latest/client-failover.html#reconnect-to-the-backup-server\" rel=\"nofollow noreferrer\">client failover</a> which makes me think all I should have to do is add 'HA' and 'reconnectAttempts' to my connection factory URL.</p>\n<pre class=\"lang-java prettyprint-override\"><code>public ActiveMQConnectionFactory activeMQConnectionFactory() throws NamingException{\n    ArtemisTargetConfig config = (ArtemisTargetConfig) new InitialContext().lookup(&quot;java:comp/env/bean/ArtemisConfig&quot;);\n    ActiveMQConnectionFactory cf = new ActiveMQConnectionFactory(&quot;udp://&quot; + config.getGroupAddress() + &quot;:&quot; + config.getGroupPort() + &quot;?ha=true&amp;reconnectAttempts=10&quot;);\n    cf.setUser(config.getUserName());\n    cf.setPassword(config.getPassword());\n\n    return cf;\n}\n</code></pre>\n<p>The URL string above resolves into <code>udp://231.7.7.7:9876?ha=true&amp;reconnectAttempts=10</code>.</p>\n<p>Here is my JmsConfig.java file.</p>\n<pre><code>@EnableJms\n@Configuration\npublic class JmsConfig {\n\n    private static final Logger LOG = LoggerFactory.getLogger(JmsConfig.class);\n\n    private final ActiveMQConnectionFactory activeMQConnectionFactory;\n\n    @Autowired\n    public JmsConfig(\n            ActiveMQConnectionFactory activeMQConnectionFactory){\n        this.activeMQConnectionFactory = activeMQConnectionFactory;\n    \n    \n    @Bean\n    public CachingConnectionFactory cachingConnectionFactory() {\n        return new CachingConnectionFactory(activeMQConnectionFactory);\n    }\n\n    @Bean\n    public JmsTemplate jmsTemplate(CachingConnectionFactory cachingConnectionFactory) {\n        JmsTemplate template = new JmsTemplate(cachingConnectionFactory);\n        template.setPubSubDomain(false);\n        return template;\n    }\n\n    @Bean\n    public DefaultJmsListenerContainerFactory jmsListenerContainerFactory () {\n\n        DefaultJmsListenerContainerFactory jmsListenerContainerFactory = new DefaultJmsListenerContainerFactory();\n        jmsListenerContainerFactory.setConnectionFactory(activeMQConnectionFactory);\n        jmsListenerContainerFactory.setSessionAcknowledgeMode(ActiveMQJMSConstants.INDIVIDUAL_ACKNOWLEDGE);\n        jmsListenerContainerFactory.setPubSubDomain(false);\n        \n        MappingJackson2MessageConverter converter = new MappingJackson2MessageConverter();\n        ObjectMapper objectMapper = new ObjectMapper();\n        objectMapper.registerModule(new JavaTimeModule());\n        converter.setObjectMapper(objectMapper);\n        converter.setTargetType(MessageType.TEXT);\n        converter.setTypeIdPropertyName(&quot;_type&quot;);\n        jmsListenerContainerFactory.setCacheLevel(null);\n        jmsListenerContainerFactory.setMessageConverter(converter);\n\n        return jmsListenerContainerFactory;\n    }\n</code></pre>\n<p>Here is a primary and back up <code>broker.xml</code> that I've trimmed to contain only areas I believe may be relevant.</p>\n<p>Primary1:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;name&gt;localhost&lt;/name&gt;\n\n&lt;connectors&gt;\n    &lt;connector name=&quot;artemis&quot;&gt;tcp://localhost:61616&lt;/connector&gt;\n&lt;/connectors&gt;\n\n  &lt;acceptors&gt;\n     &lt;acceptor name=&quot;artemis&quot;&gt;tcp://localhost:61616?tcpSendBufferSize=1048576;tcpReceiveBufferSize=1048576;amqpMinLargeMessageSize=102400;protocols=CORE,AMQP,STOMP,HORNETQ,MQTT,OPENWIRE;useEpoll=true;amqpCredits=1000;amqpLowCredits=300;amqpDuplicateDetection=true;supportAdvisory=false;suppressInternalManagementObjects=false \n     &lt;/acceptor&gt;\n  &lt;/acceptors&gt;\n\n  &lt;cluster-user&gt;cluster-admin&lt;/cluster-user&gt;\n  &lt;cluster-password&gt;apassword&lt;/cluster-password&gt;\n  &lt;broadcast-groups&gt;\n     &lt;broadcast-group name=&quot;bg-group1&quot;&gt;\n        &lt;group-address&gt;231.7.7.7&lt;/group-address&gt;\n        &lt;group-port&gt;9876&lt;/group-port&gt;\n        &lt;broadcast-period&gt;5000&lt;/broadcast-period&gt;\n        &lt;connector-ref&gt;artemis&lt;/connector-ref&gt;\n     &lt;/broadcast-group&gt;\n  &lt;/broadcast-groups&gt;\n\n  &lt;discovery-groups&gt;\n     &lt;discovery-group name=&quot;dg-group1&quot;&gt;\n        &lt;group-address&gt;231.7.7.7&lt;/group-address&gt;\n        &lt;group-port&gt;9876&lt;/group-port&gt;\n        &lt;refresh-timeout&gt;10000&lt;/refresh-timeout&gt;\n     &lt;/discovery-group&gt;\n  &lt;/discovery-groups&gt;\n\n  &lt;cluster-connections&gt;\n     &lt;cluster-connection name=&quot;my-cluster&quot;&gt;\n        &lt;connector-ref&gt;artemis&lt;/connector-ref&gt;\n        &lt;message-load-balancing&gt;ON_DEMAND&lt;/message-load-balancing&gt;\n        &lt;max-hops&gt;1&lt;/max-hops&gt;\n        &lt;discovery-group-ref discovery-group-name=&quot;dg-group1&quot;/&gt;\n     &lt;/cluster-connection&gt;\n  &lt;/cluster-connections&gt;\n\n  &lt;ha-policy&gt;\n     &lt;replication&gt;\n        &lt;primary&gt;\n           &lt;vote-on-replication-failure&gt;true&lt;/vote-on-replication-failure&gt;\n           &lt;check-for-active-server&gt;true&lt;/check-for-active-server&gt;\n        &lt;/primary&gt;\n     &lt;/replication&gt;\n  &lt;/ha-policy&gt;\n</code></pre>\n<p>Backup1:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;name&gt;localhost&lt;/name&gt;\n\n&lt;connectors&gt;\n    &lt;connector name=&quot;artemis&quot;&gt;tcp://localhost:61617&lt;/connector&gt;\n&lt;/connectors&gt;\n\n  &lt;acceptors&gt;\n     &lt;!-- Acceptor for every supported protocol --&gt;\n     &lt;acceptor name=&quot;artemis&quot;&gt;tcp://localhost:61617?tcpSendBufferSize=1048576;tcpReceiveBufferSize=1048576;amqpMinLargeMessageSize=102400;protocols=CORE,AMQP,STOMP,HORNETQ,MQTT,OPENWIRE;useEpoll=true;amqpCredits=1000;amqpLowCredits=300;amqpDuplicateDetection=true;supportAdvisory=false;suppressInternalManagementObjects=false \n     &lt;/acceptor&gt;\n  &lt;/acceptors&gt;\n\n  &lt;cluster-user&gt;cluster-admin&lt;/cluster-user&gt;\n  &lt;cluster-password&gt;aPassword&lt;/cluster-password&gt;\n\n  &lt;broadcast-groups&gt;\n     &lt;broadcast-group name=&quot;bg-group1&quot;&gt;\n        &lt;group-address&gt;231.7.7.7&lt;/group-address&gt;\n        &lt;group-port&gt;9876&lt;/group-port&gt;\n        &lt;broadcast-period&gt;5000&lt;/broadcast-period&gt;\n        &lt;connector-ref&gt;artemis&lt;/connector-ref&gt;\n     &lt;/broadcast-group&gt;\n  &lt;/broadcast-groups&gt;\n\n  &lt;discovery-groups&gt;\n     &lt;discovery-group name=&quot;dg-group1&quot;&gt;\n        &lt;group-address&gt;231.7.7.7&lt;/group-address&gt;\n        &lt;group-port&gt;9876&lt;/group-port&gt;\n        &lt;refresh-timeout&gt;10000&lt;/refresh-timeout&gt;\n     &lt;/discovery-group&gt;\n  &lt;/discovery-groups&gt;\n\n  &lt;cluster-connections&gt;\n     &lt;cluster-connection name=&quot;my-cluster&quot;&gt;\n        &lt;connector-ref&gt;artemis&lt;/connector-ref&gt;\n        &lt;message-load-balancing&gt;ON_DEMAND&lt;/message-load-balancing&gt;\n        &lt;max-hops&gt;1&lt;/max-hops&gt;\n        &lt;discovery-group-ref discovery-group-name=&quot;dg-group1&quot;/&gt;\n     &lt;/cluster-connection&gt;\n  &lt;/cluster-connections&gt;\n\n  &lt;ha-policy&gt;\n     &lt;replication&gt;\n        &lt;backup&gt;\n          &lt;allow-failback&gt;true&lt;/allow-failback&gt;\n        &lt;/backup&gt;\n     &lt;/replication&gt;\n  &lt;/ha-policy&gt;\n&lt;/core&gt;\n</code></pre>\n<p>Here is what the 'listNetworkTopology' operation in the broker shows me</p>\n<pre><code>[{&quot;nodeID&quot;:&quot;19f26f12-ee1f-11ef-b81c-00155df5022d&quot;,&quot;live&quot;:&quot;localhost:61616&quot;,&quot;primary&quot;:&quot;localhost:61616&quot;,&quot;backup&quot;:&quot;localhost:61617&quot;},\n    {&quot;nodeID&quot;:&quot;b071e7f0-ee3f-11ef-b10d-00155df5022d&quot;,&quot;live&quot;:&quot;localhost:61620&quot;,&quot;primary&quot;:&quot;localhost:61620&quot;,&quot;backup&quot;:&quot;localhost:61621&quot;},\n    {&quot;nodeID&quot;:&quot;d46e2693-ee1f-11ef-9cd3-00155df5022d&quot;,&quot;live&quot;:&quot;localhost:61618&quot;,&quot;primary&quot;:&quot;localhost:61618&quot;,&quot;backup&quot;:&quot;localhost:61619&quot;}]\n</code></pre>\n<p>Here is some additional info:</p>\n<ul>\n<li><p>I have confirmed that replication is working and in my primary broker logs I see AMQ221025: Replication: sending NIOSequentialFile when I boot up my backups (As well as the AMQ221031: backup announced on my backup).</p>\n</li>\n<li><p>I have tried entirely removing my CachedConnectionFactory.</p>\n</li>\n<li><p>I have tried deleting\nand remaking each of my brokers just in case. (This seemed to work\nfor a brief period).</p>\n</li>\n</ul>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}