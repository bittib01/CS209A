{
  "question": {
    "tags": [
      "java",
      "spring",
      "apache-kafka",
      "spring-kafka"
    ],
    "owner": {
      "account_id": 2492679,
      "reputation": 23196,
      "user_id": 2169845,
      "user_type": "registered",
      "accept_rate": 91,
      "profile_image": "https://i.sstatic.net/XoDg6.gif?s=256",
      "display_name": "zappee",
      "link": "https://stackoverflow.com/users/2169845/zappee"
    },
    "is_answered": true,
    "view_count": 76,
    "accepted_answer_id": 79394189,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1738074693,
    "creation_date": 1737551949,
    "last_edit_date": 1738073440,
    "question_id": 79377852,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79377852/setting-the-value-serializer-only-works-via-the-constructor-with-3-params-the-m",
    "title": "setting the value serializer only works via the constructor with 3 params, the map configuration is not considered",
    "body": "<p>I am learning how to use Spring for Apache Kafka 3.3.1. I am following the official documentation <a href=\"https://docs.spring.io/spring-kafka/reference/kafka/sending-messages.html#kafka-template\" rel=\"nofollow noreferrer\">here</a>, <a href=\"https://docs.spring.io/spring-kafka/reference/kafka/sending-messages.html#producer-factory\" rel=\"nofollow noreferrer\">here</a> and <a href=\"https://(Map%3CString,Object%3E%20configs)\" rel=\"nofollow noreferrer\">here</a> to set JSON value serializer for my <code>KafkaTemplate</code>.</p>\n<p>Unfortunately in my case initializing the <code>ProducerFactory&lt;&gt;</code> using the <code>Map&lt;String,Object&gt; configs</code> constructor does not set the serializer and my template uses the default serializers. Only the constructor that sets the config-map + key and value serializers works properly.</p>\n<p>It seems that I really missed something, but I can not see what. I would like to use the simple constructor with one Map parameter as it is written in the doc:</p>\n<pre><code>return new DefaultKafkaProducerFactory&lt;&gt;(producerConfigs())\n</code></pre>\n<p>My Kafka configuration:</p>\n<pre><code>@Slf4j\n@Configuration\n@RequiredArgsConstructor\n@EnableKafka\npublic class KafkaConfiguration {\n\n    @Value(&quot;${kafka.producer.bootstrap.servers:kafka-1.hello.com:9092, kafka-2.hello.com:9092}&quot;)\n    private String kafkaBootstrapServers;\n\n    @Value(&quot;${kafka.producer.enable.idempotence:true}&quot;)\n    private String kafkaProducerEnableIdempotence;\n\n    @Value(&quot;${kafka.producer.acks:all}&quot;)\n    private String kafkaProducerAcks;\n\n    @Value(&quot;${kafka.producer.retries:2147483647}&quot;)\n    private String kafkaProducerRetries;\n\n    @Value(&quot;${kafka.producer.linger.ms:0}&quot;)\n    private String kafkaProducerLingerMs;\n\n    @Value(&quot;${kafka.producer.delivery.timeout.ms:120000}&quot;)\n    private String kafkaProducerDeliveryTimeoutMs;\n\n    @Value(&quot;${kafka.producer.request.timeout.ms:30000}&quot;)\n    private String kafkaProducerRequestTimeoutMs;\n\n    @Value(&quot;${kafka.producer.retry.backoff.ms:100}&quot;)\n    private String kafkaProducerRetryBackoffMs;\n\n    @Value(&quot;${kafka.producer.retry.backoff.max.ms:1000}&quot;)\n    private String kafkaProducerRetryBackoffMaxMs;\n\n\n    @Value(&quot;${kafka.topic.name:topic1}&quot;)\n    private String kafkaTopicName;\n\n    @Value(&quot;${kafka.topic.partitions:1}&quot;)\n    private int kafkaTopicPartitions;\n\n    @Value(&quot;${kafka.topic.replicas:1}&quot;)\n    private int kafkaTopicReplicas;\n\n    @Bean\n    public ProducerFactory&lt;String, Event&gt; producerFactory() {\n        // set the key and value serializer this way does not work\n        // KafkaTemplate uses the default serializers\n        //DefaultKafkaProducerFactory&lt;String, Event&gt; factory = new DefaultKafkaProducerFactory&lt;&gt;(producerConfiguration());\n\n        // this sets properly the serializers\n        DefaultKafkaProducerFactory&lt;String, Event&gt; factory = new DefaultKafkaProducerFactory&lt;&gt;(\n                producerConfiguration(),\n                new StringSerializer(),\n                new JsonDeserializer&lt;&gt;(Event.class));\n        factory.setProducerPerThread(true);\n        return factory;\n    }\n\n    @Bean\n    public KafkaTemplate&lt;String, Event&gt; kafkaTemplate() {\n        var factory = producerFactory();\n        log.debug(&quot;initializing a KafkaTemplate using the following setting: {{}}&quot;, factoryConfigurationToString(factory));\n        return new KafkaTemplate&lt;&gt;(factory);\n    }\n\n    @Bean\n    public KafkaAdmin admin() {\n        Map&lt;String, Object&gt; configs = new HashMap&lt;&gt;();\n        configs.put(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaBootstrapServers);\n        return new KafkaAdmin(configs);\n    }\n\n    @Bean\n    public NewTopic topic() {\n        log.debug(\n                &quot;creating a new kafka topic: \\&quot;{name: \\&quot;{}\\&quot;, partitions: {}, replicas: {}}\\&quot;&quot;,\n                kafkaTopicName,\n                kafkaTopicPartitions,\n                kafkaTopicReplicas);\n\n        return TopicBuilder.name(kafkaTopicName)\n                .partitions(kafkaTopicPartitions)\n                .replicas(kafkaTopicReplicas)\n                .build();\n    }\n\n    private Map&lt;String, Object&gt; producerConfiguration() {\n        Map&lt;String, Object&gt; configs = new HashMap&lt;&gt;();\n        configs.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaBootstrapServers);\n        configs.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);\n        configs.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, JsonSerializer.class);\n        configs.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, kafkaProducerEnableIdempotence);\n        configs.put(ProducerConfig.ACKS_CONFIG, kafkaProducerAcks);\n        configs.put(ProducerConfig.RETRIES_CONFIG, kafkaProducerRetries);\n        configs.put(ProducerConfig.LINGER_MS_CONFIG, kafkaProducerLingerMs);\n        configs.put(ProducerConfig.DELIVERY_TIMEOUT_MS_CONFIG, kafkaProducerDeliveryTimeoutMs);\n        configs.put(ProducerConfig.REQUEST_TIMEOUT_MS_CONFIG, kafkaProducerRequestTimeoutMs);\n        configs.put(ProducerConfig.RETRY_BACKOFF_MS_CONFIG, kafkaProducerRetryBackoffMs);\n        configs.put(ProducerConfig.RETRY_BACKOFF_MAX_MS_CONFIG, kafkaProducerRetryBackoffMaxMs);\n        return configs;\n    }\n\n    private String factoryConfigurationToString(ProducerFactory&lt;String, Event&gt; producerFactory) {\n        var keySerializer = producerFactory.getKeySerializer();\n        var keySerializerAsString = Objects.isNull(keySerializer) ? &quot;null&quot; : keySerializer.getClass().getName();\n\n        var valueSerializer = producerFactory.getValueSerializer();\n        var valueSerializerAsString = Objects.isNull(valueSerializer) ? &quot;null&quot; : valueSerializer.getClass().getName();\n\n        var sb = new StringBuilder().append(&quot;configuration: &quot;).append(&quot;{&quot;);\n        producerFactory.\n                getConfigurationProperties().\n                forEach((key, value) -&gt; sb.append(String.format(&quot;\\&quot;%s\\&quot;: \\&quot;%s\\&quot;, &quot;, key, value)));\n\n        sb.setLength(sb.length() - 2);\n        sb.append(&quot;}, &quot;);\n        sb.append(&quot;key-serializer: &quot;).append(keySerializerAsString).append(&quot;, &quot;);\n        sb.append(&quot;value-serializer: &quot;).append(valueSerializerAsString);\n        return sb.toString();\n    }\n}\n</code></pre>\n<p>I always check the result using a Topic browser as well. In the 1st case I can see binary content on the topic, not JSON.</p>\n<p><strong>Log using the constructor with only Map:</strong></p>\n<pre><code>DEBUG 200 --- [kafka-producer] [           main] c.r.g.s.m.p.c.KafkaConfiguration         : initializing a KafkaTemplate using the following setting:\n{\n   &quot;configuration&quot;:{\n      &quot;retries&quot;:&quot;5&quot;,\n      &quot;enable.idempotence&quot;:&quot;true&quot;,\n      &quot;retry.backoff.max.ms&quot;:&quot;1000&quot;,\n      &quot;value.serializer&quot;:&quot;class org.springframework.kafka.support.serializer.JsonSerializer&quot;,\n      &quot;request.timeout.ms&quot;:&quot;30000&quot;,\n      &quot;acks&quot;:&quot;all&quot;,\n      &quot;bootstrap.servers&quot;:&quot;kafka-1.hello.com:9092, kafka-2.hello.com:9092&quot;,\n      &quot;delivery.timeout.ms&quot;:&quot;120000&quot;,\n      &quot;retry.backoff.ms&quot;:&quot;100&quot;,\n      &quot;key.serializer&quot;:&quot;class org.apache.kafka.common.serialization.StringSerializer&quot;,\n      &quot;linger.ms&quot;:&quot;0&quot;\n   },\n   &quot;key-serializer&quot;:null,   &lt;-- WRONG\n   &quot;value-serializer&quot;:null  &lt;-- WRONG\n}\nDEBUG 200 --- [kafka-producer] [           main] c.r.g.s.m.p.c.KafkaConfiguration         : creating a new kafka topic:\n{\n   &quot;name&quot;:&quot;incoming&quot;,\n   &quot;partitions&quot;:2,\n   &quot;replicas&quot;:2\n}\n</code></pre>\n<p><strong>Log using the constructor with three parameters:</strong></p>\n<pre><code>DEBUG 201 --- [kafka-producer] [           main] c.r.g.s.m.p.c.KafkaConfiguration     \n    : initializing a KafkaTemplate using the following setting:\n{\n   &quot;configuration&quot;:{\n      &quot;retries&quot;:&quot;5&quot;,\n      &quot;enable.idempotence&quot;:&quot;true&quot;,\n      &quot;retry.backoff.max.ms&quot;:&quot;1000&quot;,\n      &quot;value.serializer&quot;:&quot;class org.springframework.kafka.support.serializer.JsonSerializer&quot;,\n      &quot;request.timeout.ms&quot;:&quot;30000&quot;,\n      &quot;acks&quot;:&quot;all&quot;,\n      &quot;bootstrap.servers&quot;:&quot;kafka-1.hello.com:9092, kafka-2.hello.com:9092&quot;,\n      &quot;delivery.timeout.ms&quot;:&quot;120000&quot;,\n      &quot;retry.backoff.ms&quot;:&quot;100&quot;,\n      &quot;key.serializer&quot;:&quot;class org.apache.kafka.common.serialization.StringSerializer&quot;,\n      &quot;linger.ms&quot;:&quot;0&quot;\n   },\n   &quot;key-serializer&quot;:&quot;org.apache.kafka.common.serialization.StringSerializer&quot;,         &lt;-- OK\n   &quot;value-serializer&quot;:&quot;org.springframework.kafka.support.serializer.JsonSerializer&quot;   &lt;-- OK\n}\nDEBUG 201 --- [kafka-producer] [           main] c.r.g.s.m.p.c.KafkaConfiguration         : creating a new kafka topic:\n{\n   &quot;name&quot;:&quot;incoming&quot;,\n   &quot;partitions&quot;:2,\n   &quot;replicas&quot;:2\n}\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}