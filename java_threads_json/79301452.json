{
  "question": {
    "tags": [
      "java",
      "spring",
      "rest",
      "security",
      "backend"
    ],
    "owner": {
      "account_id": 15894877,
      "reputation": 11,
      "user_id": 11468895,
      "user_type": "registered",
      "profile_image": "https://lh3.googleusercontent.com/-4FEbcPSeLpw/AAAAAAAAAAI/AAAAAAAACoQ/y_HLLbU_Wok/s256-rj/photo.jpg",
      "display_name": "Android World   ",
      "link": "https://stackoverflow.com/users/11468895/android-world"
    },
    "is_answered": false,
    "view_count": 63,
    "answer_count": 0,
    "score": 1,
    "last_activity_date": 1734892669,
    "creation_date": 1734890200,
    "question_id": 79301452,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79301452/403-forbidden-error-during-login-in-spring-boot-application",
    "title": "403 Forbidden Error During Login in Spring Boot Application",
    "body": "<p>Have a good day.</p>\n<p>I am facing an issue when verifying the user osamazaza200 with the correct password (test123) during login in my Spring Boot application. Despite providing the proper credentials, the authentication process fails, and a 403 error is returned.</p>\n<p>Steps to Reproduce</p>\n<p>Create a user with the following credentials:</p>\n<p>Username: osamazaza200</p>\n<p>Password: test123 (hashed and stored in the database)</p>\n<p>Attempt to sign in using the /signin endpoint with the credentials.</p>\n<p>Observe the response, which results in a 403 Forbidden error.</p>\n<p>Relevant Code:\nFristly: Security Config Class:</p>\n<pre><code>@Configuration\n@EnableMethodSecurity\npublic class SecurityConfig {\n\n    private UserDetailsService userDetailsService;\n\n    public SecurityConfig(UserDetailsService userDetailsService){\n        this.userDetailsService = userDetailsService;\n    }\n\n    @Bean\n    public static PasswordEncoder passwordEncoder(){\n        return new BCryptPasswordEncoder();\n    }\n\n    @Bean\n    public AuthenticationManager authenticationManager(\n        \n    AuthenticationConfiguration configuration)\n    \n    throws Exception {\n        return configuration.getAuthenticationManager();\n    }\n\n    @Bean\n    SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n\n    http.authorizeHttpRequests((authorize) -&gt;\n                        //authorize.anyRequest().authenticated() \n                        authorize.requestMatchers(HttpMethod.GET, &quot;/api/**&quot;).permitAll()\n                                .requestMatchers(&quot;/api/auth/**&quot;).permitAll()\n                                .anyRequest().authenticated()\n\n                );\n\n        return http.build();\n    }\n}\n\n</code></pre>\n<p>Secondly: AuthController</p>\n<pre><code>package com.muhammedessa.securityapicrud.controllers;\n\n \n\n\n@RestController\n@RequestMapping(&quot;/api/auth&quot;)\npublic class AuthController {\n\n    @Autowired\n    private AuthenticationManager authenticationManager;\n\n    @Autowired\n    private UserRepository userRepository;\n\n    @Autowired\n    private RoleRepository roleRepository;\n\n    @Autowired\n    private PasswordEncoder passwordEncoder;\n\n    @PostMapping(&quot;/signin&quot;)\n    public ResponseEntity&lt;String&gt; authenticateUser(@RequestBody LoginDto loginDto){\n        Authentication authentication = authenticationManager.authenticate(new UsernamePasswordAuthenticationToken(\n                loginDto.getUsernameOrEmail(), loginDto.getPassword()));\n\n        SecurityContextHolder.getContext().setAuthentication(authentication);\n        return new ResponseEntity&lt;&gt;(&quot;User signed-in successfully!.&quot;, HttpStatus.OK);\n    }\n\n    @PostMapping(&quot;/signup&quot;)\n    public ResponseEntity&lt;?&gt; registerUser(@RequestBody SignUpDto signUpDto){\n\n        // add check for username exists in a DB\n        if(userRepository.existsByUsername(signUpDto.getUsername())){\n            return new ResponseEntity&lt;&gt;(&quot;Username is already taken!&quot;, HttpStatus.BAD_REQUEST);\n        }\n\n        // add check for email exists in DB\n        if(userRepository.existsByEmail(signUpDto.getEmail())){\n            return new ResponseEntity&lt;&gt;(&quot;Email is already taken!&quot;, HttpStatus.BAD_REQUEST);\n        }\n\n        // create user object\n        User user = new User();\n        user.setName(signUpDto.getName());\n        user.setUsername(signUpDto.getUsername());\n        user.setEmail(signUpDto.getEmail());\n        user.setPassword(passwordEncoder.encode(signUpDto.getPassword()));\n\n        Role roles = roleRepository.findByName(&quot;ROLE_ADMIN&quot;).get();\n        user.setRoles(Collections.singleton(roles));\n\n        userRepository.save(user);\n\n        return new ResponseEntity&lt;&gt;(&quot;User registered successfully&quot;, HttpStatus.OK);\n\n    }\n}\n\n</code></pre>\n<p>Thirdly: Login DTO</p>\n<pre><code>package com.muhammedessa.securityapicrud.dto;\n\nimport lombok.Data;\n\n@Data\npublic class LoginDto {\n    private String usernameOrEmail;\n    private String password;\n}\n\n</code></pre>\n<p>Fourthly: Sign UP DTO</p>\n<pre><code>package com.muhammedessa.securityapicrud.dto;\n\nimport lombok.Data;\n\n@Data\npublic class SignUpDto {\n    private String name;\n    private String username;\n    private String email;\n    private String password;\n}\n\n</code></pre>\n<p>Fifthly: Role Class</p>\n<pre><code>package com.muhammedessa.securityapicrud.entity;\n\nimport jakarta.persistence.Column;\nimport jakarta.persistence.Entity;\nimport jakarta.persistence.GeneratedValue;\nimport jakarta.persistence.GenerationType;\nimport jakarta.persistence.Id;\nimport jakarta.persistence.Table;\nimport lombok.Getter;\nimport lombok.Setter;\n\n@Setter\n@Getter\n@Entity\n@Table(name = &quot;roles&quot;)\npublic class Role {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private long id;\n\n    @Column(length = 60)\n    private String name;\n}\n\n\n</code></pre>\n<p>Sixthly: User Role Class</p>\n<pre><code>package com.muhammedessa.securityapicrud.entity;\n\nimport java.util.Set;\n\nimport jakarta.persistence.*; \nimport lombok.Data;\n\n@Data\n@Entity\n@Table(name = &quot;users&quot;, uniqueConstraints = {\n        @UniqueConstraint(columnNames = {&quot;username&quot;}),\n        @UniqueConstraint(columnNames = {&quot;email&quot;})\n})\npublic class User {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private long id;\n    private String name;\n    private String username;\n    private String email;\n    private String password;\n\n    @ManyToMany(fetch = FetchType.EAGER, cascade = CascadeType.ALL)\n    @JoinTable(name = &quot;user_roles&quot;,\n        joinColumns = @JoinColumn(name = &quot;user_id&quot;, referencedColumnName = &quot;id&quot;),\n        inverseJoinColumns = @JoinColumn(name = &quot;role_id&quot;, referencedColumnName = &quot;id&quot;))\n    private Set&lt;Role&gt; roles;\n}\n\n</code></pre>\n<p>Seventhly: Role Repository Class</p>\n<pre><code>package com.muhammedessa.securityapicrud.repository;\n\nimport java.util.Optional;\n\nimport org.springframework.data.jpa.repository.JpaRepository;\n\nimport com.muhammedessa.securityapicrud.entity.Role;\n\npublic interface RoleRepository extends JpaRepository&lt;Role, Long&gt; {\n    Optional&lt;Role&gt; findByName(String name);\n}\n\n</code></pre>\n<p>Eighty: User Repository Class</p>\n<pre><code>package com.muhammedessa.securityapicrud.repository;\n\nimport java.util.Optional;\n\nimport org.springframework.data.jpa.repository.JpaRepository;\n\nimport com.muhammedessa.securityapicrud.entity.User;\n\npublic interface UserRepository extends JpaRepository&lt;User, Long&gt; {\n    Optional&lt;User&gt; findByEmail(String email);\n    Optional&lt;User&gt; findByUsernameOrEmail(String username, String email);\n    Optional&lt;User&gt; findByUsername(String username);\n    Boolean existsByUsername(String username);\n    Boolean existsByEmail(String email);\n}\n\n</code></pre>\n<p>Ninthly: CustomUserDetailsService</p>\n<pre><code>package com.muhammedessa.securityapicrud.services;\n\nimport java.util.Set;\nimport java.util.stream.Collectors;\nimport org.springframework.security.core.authority.SimpleGrantedAuthority;\nimport org.springframework.security.core.GrantedAuthority;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.core.userdetails.UserDetailsService;\nimport org.springframework.security.core.userdetails.UsernameNotFoundException;\nimport org.springframework.stereotype.Service;\n\n\nimport com.muhammedessa.securityapicrud.entity.User;\nimport com.muhammedessa.securityapicrud.repository.UserRepository;\n\n@Service\npublic class CustomUserDetailsService implements UserDetailsService {\n\n\n\n\n    private UserRepository userRepository;\n\n    public CustomUserDetailsService(UserRepository userRepository) {\n        this.userRepository = userRepository;\n    }\n\n    @Override\n    public UserDetails loadUserByUsername(String usernameOrEmail) throws UsernameNotFoundException {\n          User user = userRepository.findByUsernameOrEmail(usernameOrEmail, usernameOrEmail)\n                 .orElseThrow(() -&gt;\n                         new UsernameNotFoundException(&quot;User not found with username or email: &quot;+ usernameOrEmail));\n\n        Set&lt;GrantedAuthority&gt; authorities = user\n                .getRoles()\n                .stream()\n                .map((role) -&gt; new SimpleGrantedAuthority(role.getName())).collect(Collectors.toSet());\n\n        return new org.springframework.security.core.userdetails.User(user.getEmail(),\n                user.getPassword(),\n                authorities);\n    }\n}\n\n</code></pre>\n<p>Application Properties</p>\n<pre><code>spring.application.name=APIDemo\n# DATASOURCE (DataSourceAutoConfiguration &amp; DataSourceProperties)\nspring.datasource.url=jdbc:mysql://127.0.0.1:3306/usersdb?useSSL=false\nspring.datasource.username=root\nspring.datasource.password= \n\n# Hibernate\n# The SQL dialect makes Hibernate generate better SQL for the chosen database\nspring.jpa.properties.hibernate.dialect = org.hibernate.dialect.MySQLDialect\n\n# Hibernate ddl auto (create, create-drop, validate, update)\nspring.jpa.hibernate.ddl-auto = update\n\nlogging.level.org.hibernate.SQL=DEBUG\nlogging.level.org.hibernate.type=TRACE\n\n</code></pre>\n<p>When running [POST] request API http://localhost:8080/api/auth/signup</p>\n<p>Body</p>\n<p>{\n&quot;name&quot;: &quot;Loyasl Essa&quot;,\n&quot;username&quot;: &quot;testrer&quot;,\n&quot;email&quot;: &quot;test123@gmail.com&quot;,\n&quot;password&quot;: &quot;12345678&quot;\n}</p>\n<p>getting 403 error</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}