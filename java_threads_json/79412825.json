{
  "question": {
    "tags": [
      "java",
      "spring",
      "hibernate",
      "jpa",
      "auditing"
    ],
    "owner": {
      "account_id": 15155273,
      "reputation": 1,
      "user_id": 10936296,
      "user_type": "registered",
      "profile_image": "https://graph.facebook.com/2349922495287056/picture?type=large",
      "display_name": "Ankit Raj",
      "link": "https://stackoverflow.com/users/10936296/ankit-raj"
    },
    "is_answered": false,
    "view_count": 75,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1755625139,
    "creation_date": 1738697364,
    "last_edit_date": 1738698866,
    "question_id": 79412825,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79412825/issue-in-saving-postupdateeventlistener-postinserteventlistener-postdeleteevent",
    "title": "issue in saving PostUpdateEventListener,PostInsertEventListener, PostDeleteEventListener, getting duplicate error in case of non auto generated Id",
    "body": "<p>I have the following entity:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Entity\n@Data\n@DoAudit\n@Table(name = &quot;product&quot;)\n@EntityListeners(AuditListener.class)\npublic class Product implements Serializable {\n\n    @Id\n    @Column(name = &quot;code&quot;, length = 50, nullable = false, unique = true, insertable = false, updatable = false)\n    private String code; // Primary Key: code (VARCHAR(50))\n\n    private String name;\n    private Double price;\n}\n</code></pre>\n<pre><code>CREATE TABLE product (\n    code VARCHAR(50) NOT NULL UNIQUE,\n    name VARCHAR(255),\n    price DOUBLE,\n    PRIMARY KEY (code)\n);\n</code></pre>\n<p>Whenever I try to save this class, there is no issue.</p>\n<p>However, when I try to save the following version:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Entity\n@Data\n@DoAudit\n@Table(name = &quot;product&quot;)\n@EntityListeners(AuditListener.class)\npublic class Product implements Serializable {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Integer id;\n\n    private String name;\n    private Double price;\n}\n</code></pre>\n<pre><code>CREATE TABLE product (\n    id INT AUTO_INCREMENT PRIMARY KEY,\n    name VARCHAR(255),\n    price DOUBLE\n);\n</code></pre>\n<p>I encounter the following error in this class in logChange method\nissue is with all DB I am using.</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Component\npublic class AuditListener implements PostUpdateEventListener, PostInsertEventListener, PostDeleteEventListener {\n\n    @Autowired\n    private AuditRepository auditRepository;\n\n    @Transactional(Transactional.TxType.REQUIRES_NEW)\n    private void logChanges(Object entity, String operation, Object[] oldState, Object[] newState, String[] propertyNames) {\n        if (entity instanceof AuditLog) {\n            return;\n        }\n\n        try {\n            AuditLog auditLog = new AuditLog();\n            auditLog.setTableName(entity.getClass().getSimpleName());\n            auditLog.setOperationType(operation);\n            auditLog.setChangedBy(&quot;Ankit&quot;);\n            auditLog.setTimestamp(LocalDateTime.now());\n            auditLog.setEntityId(&quot;UNKNOWN&quot;);\n            auditLog.setTraceId(&quot;traceId&quot;);\n            auditLog.setChanges(&quot;Changes as per logic&quot;);\n\n            auditRepository.save(auditLog);\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n\n\n    @Override\n    public void onPostInsert(PostInsertEvent event) {\n        System.out.println(&quot;ðŸ”¹ Post triggered for: &quot; + event.getEntity().getClass().getSimpleName());\n        logChanges(event.getEntity(), &quot;INSERT&quot;, null, event.getState(), event.getPersister().getPropertyNames());\n\n    }\n\n    @Override\n    public boolean requiresPostCommitHandling(EntityPersister entityPersister) {\n        return false;\n    }\n\n    @Override\n    public void onPostUpdate(PostUpdateEvent event) {\n        logChanges(event.getEntity(), &quot;UPDATE&quot;, null, event.getState(), event.getPersister().getPropertyNames());\n    }\n\n\n    @Override\n    public void onPostDelete(PostDeleteEvent event) {\n        logChanges(event.getEntity(), &quot;DELETE&quot;, null, null, event.getPersister().getPropertyNames());\n    }\n}\n</code></pre>\n<pre><code>@Configuration\npublic class HibernateEventListenerConfig {\n\n    private final AuditListener auditListener;\n\n    @Autowired\n    public HibernateEventListenerConfig(AuditListener auditListener) {\n        this.auditListener = auditListener;\n    }\n\n    @Autowired\n    public void registerListeners(EntityManagerFactory entityManagerFactory) {\n        SessionFactoryImplementor sessionFactory = entityManagerFactory.unwrap(SessionFactoryImplementor.class);\n        EventListenerRegistry registry = sessionFactory.getServiceRegistry().getService(EventListenerRegistry.class);\n\n        registry.appendListeners(EventType.POST_INSERT, auditListener);\n        registry.appendListeners(EventType.POST_UPDATE, auditListener);\n        registry.appendListeners(EventType.POST_DELETE, auditListener);\n    }\n}\n</code></pre>\n<pre><code>@Entity\n@Data\n@Table(name = &quot;audit_log&quot;)\npublic class AuditLog  {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id;\n\n    private String traceId;\n\n    private String tableName;\n    private String entityId;\n\n    private String operationType;\n    private String changedBy;\n    private LocalDateTime timestamp;\n\n    @Column(columnDefinition = &quot;TEXT&quot;)\n    private String changes;\n}\n</code></pre>\n<p>Error:</p>\n<pre><code>2025-01-30T19:20:49.095+05:30  WARN 2541 --- [nio-8080-exec-7] o.h.engine.jdbc.spi.SqlExceptionHelper   : SQL Error: 23505, SQLState: 23505\n2025-01-30T19:20:49.095+05:30 ERROR 2541 --- [nio-8080-exec-7] o.h.engine.jdbc.spi.SqlExceptionHelper   : Unique index or primary key violation: &quot;PUBLIC.PRIMARY_KEY_1 ON PUBLIC.PRODUCT(CODE) VALUES ( /* 5 */ 'ffc' )&quot;; SQL statement:\ninsert into product (name,price,code) values (?,?,?) [23505-232]\norg.springframework.dao.DataIntegrityViolationException: could not execute statement [Unique index or primary key violation: &quot;PUBLIC.PRIMARY_KEY_1 ON PUBLIC.PRODUCT(CODE) VALUES ( /* 5 */ 'ffc' )&quot;; SQL statement:\ninsert into product (name,price,code) values (?,?,?) [23505-232]] [insert into product (name,price,code) values (?,?,?)]; SQL [insert into product (name,price,code) values (?,?,?)]; constraint [PUBLIC.PRIMARY_KEY_1]\n    at org.springframework.orm.jpa.vendor.HibernateJpaDialect.convertHibernateAccessException(HibernateJpaDialect.java:290)\n    at org.springframework.orm.jpa.vendor.HibernateJpaDialect.translateExceptionIfPossible(HibernateJpaDialect.java:241)\n    at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.translateExceptionIfPossible(AbstractEntityManagerFactoryBean.java:560)\n    at org.springframework.dao.support.ChainedPersistenceExceptionTranslator.translateExceptionIfPossible(ChainedPersistenceExceptionTranslator.java:61)\n    at org.springframework.dao.support.DataAccessUtils.translateIfNecessary(DataAccessUtils.java:343)\n    at org.springframework.dao.support.PersistenceExceptionTranslationInterceptor.invoke(PersistenceExceptionTranslationInterceptor.java:160)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.springframework.data.jpa.repository.support.CrudMethodMetadataPostProcessor$CrudMethodMetadataPopulatingMethodInterceptor.invoke(CrudMethodMetadataPostProcessor.java:147)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:223)\n    at jdk.proxy2/jdk.proxy2.$Proxy113.save(Unknown Source)\n    at com.example.AuditLog.listner.AuditListener.logChanges(AuditListener.java:36)\n    at com.example.AuditLog.listner.AuditListener.onPostInsert(AuditListener.java:46)\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:569)\n</code></pre>\n<p>I have tried every possible solution available online, including ChatGPT suggestions.</p>\n<p>I want to audit all my entries. Alternative solutions are also welcome.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}