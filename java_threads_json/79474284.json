{
  "question": {
    "tags": [
      "java",
      "couchbase",
      "testcontainers",
      "spring-data-couchbase",
      "couchbase-java-api"
    ],
    "owner": {
      "account_id": 5046108,
      "reputation": 3809,
      "user_id": 6366458,
      "user_type": "registered",
      "accept_rate": 64,
      "profile_image": "https://i.sstatic.net/99cOW.jpg?s=256",
      "display_name": "arqam",
      "link": "https://stackoverflow.com/users/6366458/arqam"
    },
    "is_answered": false,
    "view_count": 37,
    "answer_count": 1,
    "score": 1,
    "last_activity_date": 1742579284,
    "creation_date": 1740705400,
    "last_edit_date": 1740765442,
    "question_id": 79474284,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79474284/couchbase-testcontainer-with-transactions",
    "title": "Couchbase TestContainer with Transactions",
    "body": "<p>My issue is with the TestContainer behavior.\nI am trying to test my code in couchbase testcontainer but facing certain anomaly.</p>\n<p>My main part of code</p>\n<pre><code>    public void execute() {\n        boolean success = false;\n        int retryCount = 0;\n        while (!success) {\n            try {\n                transactions.run((TransactionAttemptContext ctx) -&gt; {\n                    process(ctx);\n                });\n                success = true;\n            } catch (TransactionFailedException ex) {\n                Throwable cause = ex.getCause();\n\n                if (cause instanceof DocumentExistsException || cause instanceof DuplicateKeyException) {\n                    if (cause.getMessage().contains(getCollectionName(TransactionSubLedgerEntity.class))) {\n                        log.warn(&quot;Duplicate event with eventId {} while stock-processing. Event already present&quot;,\n                                storeStockMovement.getStockTransaction().stockTransactionId());\n                        success = true;\n                    } else {\n                        retryCount++;\n                        log.warn(&quot;Duplicate entry in stockWacSubLedger or stockRefSubLedger eventId {} while stock-processing. Retrying... Attempt {}&quot;,\n                                storeStockMovement.getStockTransaction().stockTransactionId(), retryCount);\n\n                        if (retryCount &gt;= MAX_RETRY_COUNT) {\n                            throw new TransactionProcessingException(\n                                    String.format(&quot;Exceeded max retries while processing srs event with id %s&quot;,\n                                            storeStockMovement.getStockTransaction().stockTransactionId()), ex);\n                        }\n                    }\n                } else if (cause instanceof WacCalculationTransientException) {\n                    throw (WacCalculationTransientException) cause;\n                } else {\n                    throw new TransactionProcessingException(\n                            String.format(&quot;Error while processing stock event with id %s&quot;,\n                                    storeStockMovement.getStockTransaction().stockTransactionId()), ex);\n                }\n            }\n        }\n    }\n</code></pre>\n<p>All db operations performed from the <code>process(ctx)</code> method uses <code>ctx</code> to maintain the transactional behavior.</p>\n<p>For eg:</p>\n<pre><code>    public TransactionSubLedgerEntity saveEntity(TransactionAttemptContext ctx, TransactionSubLedgerEntity transactionSubLedgerEntity) {\n        Collection collection = getCollection();\n\n        try {\n            ctx.insert(collection, transactionSubLedgerEntity.getTransactionId(), transactionSubLedgerEntity);\n            log.info(&quot;Inserted new TransactionSubLedgerEntity with ID: {}&quot;, transactionSubLedgerEntity.getTransactionId());\n\n        } catch (DocumentExistsException e) {\n            log.error(&quot;Duplicate TransactionSubLedgerEntity detected with ID: {}&quot;, transactionSubLedgerEntity.getTransactionId());\n            throw e;\n        }\n        return transactionSubLedgerEntity;\n    }\n</code></pre>\n<p>But my main problem is when I am writing integration tests, where I use couchbase testcontainer</p>\n<p>When I try to check the data I saved in my test code, its not coming up. Even though insertion has happened as per the logs in the code inside <code>process(ctx)</code> method.</p>\n<p>Testing code piece</p>\n<pre><code>    def &quot;Verify that successful stock receipt processing txn&quot;() {\n        given: &quot;A SRS transfer is present in the system&quot;\n        buildDepotStockMovement(tpnb, storeId, referenceId, srsTransactionDate)\n        insertStockWac(tpnb, storeId, 10)\n        if(rcvEventTpnb!=tpnb)\n            insertStockWac(rcvEventTpnb,storeId,11)\n        insertStockRef(referenceId, 10, tpnb, storeId, stockInTransit, createdAt, srsTransactionDate)\n\n        //currency  mock\n        ConfigData configData = new ConfigData()\n        configData.setCurrency(&quot;GBP&quot;)\n        CurrencyMapping currencyMapping = new CurrencyMapping()\n        def storeStockMovement =\n                createStockReceivingEvent(rcvEventTpnb == null ? tpnb : rcvEventTpnb, storeId, invoiceNo, receiveQty, sourceTransactionDateTime)\n        currencyMapping.setConfigData(Collections.singletonList(configData))\n        Mockito.when(configurationService.getCurrencyMappingConfig(STOCK_CURRENCY_COUNTRY_MAPPING,\n                storeStockMovement.getLocationReferenceEnriched().country()))\n                .thenReturn(currencyMapping)\n        Mockito.when(wacService.fetchCurrentWac(Mockito.anyString(), Mockito.any(LocalDate.class), Mockito.anyString()))\n                .thenReturn(BigDecimal.valueOf(15.25))\n        Mockito.when(missingPreReqHelper.persistMissingPreReqEvent()).thenReturn(new MissingPreReqEntity())\n\n        when: &quot;Stock receipt is received for that referenceId&quot;\n        String auditId = &quot;test-1&quot;\n        def command = new StockReceivingProcessingCommand(storeStockMovement, stockProcessorHelper, srsProcessorHelper,\n                auditId, missingPreReqHelper, transactions)\n        command.execute()\n        Thread.sleep(1000)\n\n        then: &quot;Expected transaction TransactionCode=#transactionCode ReasonCode=#reasonCode is created&quot;\n        if (transactionCode &gt;= 0 &amp;&amp; reasonCode &gt;= 0) {\n            QueryCriteria criteria = QueryCriteria.where(&quot;storeId&quot;).is(storeId)\n                    .and(QueryCriteria.where(&quot;tpnb&quot;).is(rcvEventTpnb == null ? tpnb : rcvEventTpnb))\n                    .and(QueryCriteria.where(&quot;referenceId&quot;).is(invoiceNo))\n                    .and(QueryCriteria.where(&quot;transactionCode&quot;).is(transactionCode))\n                    .and(QueryCriteria.where(&quot;reasonCode&quot;).is(reasonCode))\n\n            def results = couchbaseTemplate.findByQuery(TransactionSubLedgerEntity)\n                    .withConsistency(QueryScanConsistency.REQUEST_PLUS)\n                    .matching(criteria)\n                    .all()\n\n            log.info(&quot;results {}&quot;, results);\n            log.info(&quot;transaction {}&quot;, transactionSubLedgerRepository.findAll().toString())\n            assert results.size() == 1\n            assert results.stream().findFirst().get().quantity == expectedQty\n            assert results.stream().findFirst().get().newStockOnHand == expectedSOH\n        }\n}\n</code></pre>\n<p>Here both the logs in results and transactions come as null.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}