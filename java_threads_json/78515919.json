{
  "question": {
    "tags": [
      "java",
      "apache-sshd"
    ],
    "owner": {
      "account_id": 16647842,
      "reputation": 1,
      "user_id": 12031667,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/094e7c9d3f1ab74ea31c77824296182d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Ravi",
      "link": "https://stackoverflow.com/users/12031667/ravi"
    },
    "is_answered": false,
    "view_count": 917,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1717564019,
    "creation_date": 1716362915,
    "last_edit_date": 1716363520,
    "question_id": 78515919,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78515919/issue-with-connecting-to-a-server-using-apache-sshd-java",
    "title": "Issue with connecting to a server using Apache sshd Java",
    "body": "<p>I was trying to connect to a remote server(node1) tunneling through a different remote server(gateway). I was able to connect to to gateway server. But, I'm unable to establish connection with node1 through tunneling. May be I'm missing something which I'm not able to understand.</p>\n<pre><code>package org.example;\n\nimport org.apache.sshd.client.ClientBuilder;\nimport org.apache.sshd.client.SshClient;\nimport org.apache.sshd.client.channel.ChannelExec;\nimport org.apache.sshd.client.channel.ClientChannelEvent;\nimport org.apache.sshd.client.session.ClientSession;\nimport org.apache.sshd.common.NamedFactory;\nimport org.apache.sshd.common.compression.BuiltinCompressions;\nimport org.apache.sshd.common.config.keys.FilePasswordProvider;\nimport org.apache.sshd.common.kex.KeyExchangeFactory;\nimport org.apache.sshd.common.keyprovider.FileKeyPairProvider;\nimport org.apache.sshd.common.keyprovider.KeyPairProvider;\nimport org.apache.sshd.common.util.net.SshdSocketAddress;\nimport org.apache.sshd.common.kex.BuiltinDHFactories;\nimport java.io.ByteArrayOutputStream;\nimport java.io.File;\nimport java.nio.file.Files;\nimport java.security.KeyPair;\nimport java.util.EnumSet;\nimport java.util.List;\nimport java.util.ArrayList;\nimport java.util.stream.Collectors;\n\npublic class RemoteCommandExecutor {\n\n    public static void main(String[] args) throws Exception {\n        String gatewayHost = &quot;host ip&quot;;\n        String gatewayUser = &quot;username&quot;;\n        String gatewayPassword = &quot;passeord&quot;;\n        int localPort = 12345; // Choose any unused port\n        int remotePort = 22; // SSH port on node1\n\n        String node1Host = &quot;ixxxxxx017&quot;;\n        String node1User = &quot;username&quot;;\n        String passphrase = &quot;password&quot;;\n        List&lt;String&gt; commands = List.of(&quot;hostname&quot;, &quot;cd /home/&quot;, &quot;ls -lrt&quot;);\n\n        String privateKeyPath = &quot;/home/&quot;+gatewayUser+&quot;/.ssh/id_rsa&quot;;\n\n        try {\n            SshClient client = SshClient.setUpDefaultClient();\n            client.setCompressionFactoriesNames(BuiltinCompressions.Constants.NONE);\n            client.setCipherFactoriesNames(&quot;aes256-gcm@openssh.com&quot;,&quot;aes128-gcm@openssh.com&quot;,&quot;aes256-ctr&quot;,&quot;aes192-ctr&quot;,&quot;aes128-ctr&quot;);\n            client.setMacFactoriesNames(&quot;hmac-sha2-256-etm@openssh.com&quot;,&quot;hmac-sha2-512-etm@openssh.com&quot;,&quot;hmac-sha2-256&quot;,&quot;hmac-sha2-512&quot;);\n            List&lt;KeyExchangeFactory&gt; keyExchangeFactories = new ArrayList&lt;KeyExchangeFactory&gt;();\n\n\n            keyExchangeFactories.addAll(NamedFactory.setUpTransformedFactories(\n                    false,\n                    List.of(BuiltinDHFactories.curve25519),\n                    ClientBuilder.DH2KEX));\n\n            // Update the key exchange factories\n            client.setKeyExchangeFactories(keyExchangeFactories);\n            List&lt;KeyExchangeFactory&gt; currentList = client.getKeyExchangeFactories();\n            //print currentList\n            for(KeyExchangeFactory f : currentList) {\n                System.out.println(&quot;ascdsfdff  ---  \\n&quot;+f.toString());\n            }\n\n            // Start the client (if not already started\n            client.start();\n            // Connect to Gateway with Password Authentication\n            try (ClientSession gatewaySession = client.connect(gatewayUser, gatewayHost, 22)\n                    .verify().getSession()) {\n                gatewaySession.addPasswordIdentity(gatewayPassword);\n                gatewaySession.auth().verify();\n                String testOutput = executeCommand(gatewaySession, &quot;ls -l&quot;);\n                System.out.println(&quot;Testing&quot; + testOutput);\n                // Establish tunnel (if needed)\n                gatewaySession.startLocalPortForwarding(\n                        new SshdSocketAddress(&quot;localhost&quot;, localPort), // Local address and port\n                        new SshdSocketAddress(node1Host, remotePort) // Remote address and port\n                );\n\n                for(KeyExchangeFactory f : client.getKeyExchangeFactories()) {\n                    System.out.println(&quot;ascdsfdff  ---  \\n&quot;+f.toString());\n                }\n\n                // Connect to node1 with Password Authentication (through tunnel)\n                // Connect to node1 with Private Key Authentication (through tunnel)\n                try (ClientSession node1Session = client.connect(node1User, &quot;localhost&quot;, localPort)\n                        .verify().getSession()) {\n                    // Fetch the private key contents from the gateway server\n                    String privateKeyContents = executeCommand(gatewaySession, &quot;cat &quot; + privateKeyPath);\n\n                    // Create a temporary file to store the private key contents\n                    File tempPrivateKeyFile = File.createTempFile(&quot;temp-private-key&quot;, &quot;.pem&quot;);\n                    Files.write(tempPrivateKeyFile.toPath(), privateKeyContents.getBytes());\n\n                    // Use the temporary file to load the private key\n                    KeyPairProvider keyPairProvider = new FileKeyPairProvider(List.of(tempPrivateKeyFile.toPath()));\n                    ((FileKeyPairProvider) keyPairProvider).setPasswordFinder(FilePasswordProvider.of(passphrase));\n\n                    // Load the key pair\n                    Iterable&lt;KeyPair&gt; keyPairs = keyPairProvider.loadKeys(node1Session);\n\n                    // Get the first key pair\n                    KeyPair keyPair = keyPairs.iterator().next();\n\n                    // Add the public key identity from the loaded key pair\n                    node1Session.addPublicKeyIdentity(keyPair);\n\n                    node1Session.auth().verify();\n                    List&lt;String&gt; results = new ArrayList&lt;&gt;();\n                    for (String cmd : commands) {\n                        String output = executeCommand(node1Session, cmd);\n                        results.add(output);\n                    }\n\n                    // Combine and print results\n                    String combinedOutput = results.stream().collect(Collectors.joining(&quot;\\n---\\n&quot;));\n                    System.out.println(combinedOutput);\n                }\n            } finally {\n                client.stop();\n                client.close();\n            }\n        } catch (Exception e) {\n            System.err.println(&quot;Error: &quot; + e.getMessage());\n        }\n    }\n\n    private static String executeCommand(ClientSession session, String command) throws Exception {\n        ChannelExec channelExec = session.createExecChannel(command);\n        ByteArrayOutputStream out = new ByteArrayOutputStream();\n        ByteArrayOutputStream err = new ByteArrayOutputStream();\n\n        channelExec.setOut(out);\n        channelExec.setErr(err);\n        channelExec.open();\n        channelExec.waitFor(EnumSet.of(ClientChannelEvent.CLOSED), 0);\n\n        String output = new String(out.toByteArray());\n        String error = new String(err.toByteArray());\n\n        if (!error.isEmpty() &amp;&amp; !error.contains(&quot;cannot find name for group ID&quot;)) {\n            throw new Exception(&quot;Command execution error: &quot; + error);\n        }\n        return output;\n    }\n}\n\n</code></pre>\n<p>It is able to connect to gatewayHost. But, not able to establish connection with node1Host. I see the following error.</p>\n<pre><code>Error: Unable to negotiate key exchange for server host key algorithms (client: ecdsa-sha2-nistp256-cert-v01@openssh.com,ecdsa-sha2-nistp384-cert-v01@openssh.com,ecdsa-sha2-nistp521-cert-v01@openssh.com,rsa-sha2-512-cert-v01@openssh.com,rsa-sha2-256-cert-v01@openssh.com,ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,ecdsa-sha2-nistp521,sk-ecdsa-sha2-nistp256@openssh.com,rsa-sha2-512,rsa-sha2-256,ssh-rsa / server: ssh-ed25519)\n</code></pre>\n<p>These are the maven dependencies I'm using.</p>\n<pre><code>&lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.apache.sshd&lt;/groupId&gt;\n            &lt;artifactId&gt;sshd-core&lt;/artifactId&gt;\n            &lt;version&gt;2.11.0&lt;/version&gt; &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.apache.sshd&lt;/groupId&gt;\n            &lt;artifactId&gt;sshd-sftp&lt;/artifactId&gt;\n            &lt;version&gt;2.11.0&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.apache.sshd&lt;/groupId&gt;\n            &lt;artifactId&gt;sshd-common&lt;/artifactId&gt;\n            &lt;version&gt;2.11.0&lt;/version&gt;\n        &lt;/dependency&gt;\n\n    &lt;/dependencies&gt;\n\n</code></pre>\n<p>I've tried setting different KeyExchangeFactories and it doesn't help</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}