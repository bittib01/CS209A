{
  "question": {
    "tags": [
      "java",
      "email",
      "quarkus",
      "email-attachments"
    ],
    "owner": {
      "account_id": 7337005,
      "reputation": 442,
      "user_id": 5588032,
      "user_type": "registered",
      "accept_rate": 60,
      "profile_image": "https://i.sstatic.net/TGvFS.jpg?s=256",
      "display_name": "Pmsmm",
      "link": "https://stackoverflow.com/users/5588032/pmsmm"
    },
    "is_answered": true,
    "view_count": 282,
    "accepted_answer_id": 78988755,
    "answer_count": 2,
    "score": 0,
    "last_activity_date": 1726457027,
    "creation_date": 1724165422,
    "last_edit_date": 1724234621,
    "question_id": 78893108,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78893108/quarkus-mailer-not-inserting-attachments-when-sending-email",
    "title": "Quarkus Mailer Not Inserting Attachments When Sending Email",
    "body": "<p>I have a piece of code that I hard coded in order to fix a silent issue that occurred while inserting attachments into my email.</p>\n<p>Basically when running my tests the <a href=\"https://javadoc.io/doc/io.quarkus/quarkus-mailer/1.5.0.Final/io/quarkus/mailer/Mail.html\" rel=\"nofollow noreferrer\">email</a> object comes back with the attachments attached and I can assert through said tests that everything is attached, with the correct names and information.</p>\n<p>The initial version where I hard coded stuff can be seen below:</p>\n<pre><code>  private final InputStream firstAttachment = WelcomeEmail.class\n      .getResourceAsStream(&quot;/META-INF/resources/attachments/welcome/example1.pdf&quot;);\n  private final InputStream secondAttachment =\n      WelcomeEmail.class.getResourceAsStream(&quot;/META-INF/resources/attachments/welcome/example2.pdf&quot;);\n  private final InputStream thirdAttachment = WelcomeEmail.class\n      .getResourceAsStream(&quot;/META-INF/resources/attachments/welcome/example3.pdf&quot;);\n  private final InputStream fourthAttachment = WelcomeEmail.class.getResourceAsStream(\n      &quot;/META-INF/resources/attachments/welcome/example4.pdf&quot;);\n\n  /**\n   * Builds an instance of an email based on a specific template.\n   *\n   * @param paymentIntent Payment Intent used to extract information for the email generation\n   * @param context The Context used to populate the email template\n   * @return Instance of the Email template populated.\n   */\n  @Override\n  public MailTemplateInstance build(PaymentIntentAggregate paymentIntent,\n      CustomerEmailContext context) {\n\n    if (paymentIntent == null) {\n      log.warn(&quot;Couldn't send customer Welcome Email: Missing Payment Intent&quot;);\n      return null;\n    }\n\n    String customerEmail = context.getCustomerEmail();\n\n    Mail mail = new Mail().setTo(List.of(customerEmail))\n        .setSubject(SIGN_ENCRYPT_SUBJECT_PREFIX + getSubject());\n\n    try {\n      mail.addAttachment(&quot;Name1.pdf&quot;, firstAttachment.readAllBytes(), &quot;.pdf&quot;);\n      mail.addAttachment(&quot;Name2.pdf&quot;, secondAttachment.readAllBytes(), &quot;.pdf&quot;);\n      mail.addAttachment(&quot;Name3.pdf&quot;, thirdAttachment.readAllBytes(), &quot;.pdf&quot;);\n      mail.addAttachment(&quot;Name4.pdf&quot;, fourthAttachment.readAllBytes(), &quot;.pdf&quot;);\n    } catch (IOException e) {\n      throw new RuntimeException(e);\n    }\n\n    return mailTemplate.of(mail).data(&quot;mailId&quot;, generateEmailId());\n  }\n\n</code></pre>\n<p>This version is working and the email is being sent with all the attachments in it.</p>\n<p>To improve this code I developed the following refactored version:</p>\n<pre><code>  private static final String ATTACHMENTS_DIRECTORY = &quot;/META-INF/resources/attachments/welcome/&quot;;\n\n  /**\n   * Builds an instance of an email based on a specific template.\n   *\n   * @param paymentIntent Payment Intent used to extract information for the email generation\n   * @param context The Context used to populate the email template\n   * @return Instance of the Email template populated.\n   */\n  @Override\n  public MailTemplateInstance build(PaymentIntentAggregate paymentIntent,\n      CustomerEmailContext context) {\n\n    if (paymentIntent == null) {\n      log.warn(&quot;Couldn't send customer Welcome Email: Missing Payment Intent&quot;);\n      return null;\n    }\n\n    String customerEmail = context.getCustomerEmail();\n\n    Mail mail = new Mail().setTo(List.of(customerEmail)).setSubject(getSubject())\n        .setAttachments(AttachmentService.getAttachments(ATTACHMENTS_DIRECTORY));\n\n    return mailTemplate.of(mail).data(&quot;mailId&quot;, generateEmailId());\n  }\n</code></pre>\n<p>Where the AttachmentService which, as the name implies, basically takes care of retrieving <a href=\"https://javadoc.io/doc/io.quarkus/quarkus-mailer/1.5.0.Final/io/quarkus/mailer/Attachment.html\" rel=\"nofollow noreferrer\">attachments</a>, looks like this:</p>\n<pre><code>@Slf4j\n@ApplicationScoped\npublic class AttachmentService {\n\n  /**\n   * Gets all the attachments from the given resource name (directory)\n   *\n   * @param resourceName The resource name which must always be a directory\n   *\n   * @return All the attachments retrieved from the given resource\n   */\n  public static List&lt;Attachment&gt; getAttachments(String resourceName) {\n    return getAttachmentNames(resourceName).stream()\n        .map(attachmentName -&gt; getAttachment(resourceName + attachmentName, attachmentName))\n        .toList();\n  }\n\n  private static Attachment getAttachment(String attachmentFQN, String attachmentName) {\n    try (InputStream attachment = AttachmentService.class.getResourceAsStream(attachmentFQN)) {\n      return new Attachment(attachmentName, attachment.readAllBytes(), ContentType.PDF);\n    } catch (IOException ioException) {\n      log.error(&quot;An issue occurred while attempting to read attachment {}&quot;, attachmentFQN,\n          ioException);\n      throw new RuntimeException(ioException);\n    }\n  }\n\n  /**\n   * Retrieves all attachment names from the given resource (directory).\n   *\n   * @param resourceName The directory path\n   *\n   * @return List of all attachment names in the given directory\n   */\n  private static List&lt;String&gt; getAttachmentNames(String resourceName) {\n    try (BufferedReader directoryContentReader = new BufferedReader(\n        new InputStreamReader(AttachmentService.class.getResourceAsStream(resourceName)))) {\n      return directoryContentReader.lines().toList();\n    } catch (IOException ioException) {\n      log.error(&quot;An issue occurred while attempting to read attachment names from path {}&quot;,\n          resourceName, ioException);\n      throw new RuntimeException(ioException);\n    }\n  }\n\n}\n</code></pre>\n<p>This refactored version does not break any of the existing tests I made and asserts that, when running the maven lifecycle or running the tests directly through the IDE, that the attachments are inserted into the email object.</p>\n<p>The problem is, <strong>when running this code from the JAR the attachments are not inserted into the email and the email is sent as is without them</strong>. In other words, when deploying the code, the email is sent without the attachments.</p>\n<p>There is no error being logged and therefor it is impossible to determine if and where the issue is happening.</p>\n<p>I have tried changing the path to the directory where the attachments are being stored and that immediately throws an error which tells me it is not an issue with the current directory path.</p>\n<p>One suspicion I have is that I might be somehow mishandling the InputStreams when using them to read the content of the attachments but at the same time no exception is being thrown and I use try with resources to specifically close the streams when I finish using them.</p>\n<p>Any help would be greatly appreciated, kind regards in advance!</p>\n<p>Some of the documentation I consulted while developing this code:</p>\n<ul>\n<li><a href=\"https://javadoc.io/doc/io.quarkus/quarkus-mailer/3.13.2/io/quarkus/mailer/package-summary.html\" rel=\"nofollow noreferrer\">Quarkus Mailer Docs</a>;</li>\n<li><a href=\"https://quarkus.io/guides/mailer-reference\" rel=\"nofollow noreferrer\">Mailer Reference</a>;</li>\n<li><a href=\"https://quarkus.io/guides/qute\" rel=\"nofollow noreferrer\">Qute Template Engine</a>;</li>\n<li><a href=\"https://www.tutorialspoint.com/java/lang/classloader_getresourceasstream.htm\" rel=\"nofollow noreferrer\">ClassLoader getResourceAsStream</a>; (Consulted many other sites on this topic)</li>\n</ul>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}