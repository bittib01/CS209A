{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-data-jpa",
      "multipleoutputs"
    ],
    "owner": {
      "account_id": 4882378,
      "reputation": 21,
      "user_id": 3935749,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/13872f93b0e7c55e0f0b301bf2a34de4?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Itachi Uchiha",
      "link": "https://stackoverflow.com/users/3935749/itachi-uchiha"
    },
    "is_answered": false,
    "view_count": 49,
    "answer_count": 0,
    "score": 0,
    "last_activity_date": 1735219674,
    "creation_date": 1734712582,
    "last_edit_date": 1735219674,
    "question_id": 79297864,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79297864/how-to-call-an-oracle-stored-procedure-with-multiple-output-parameter-refcursor",
    "title": "How to call an Oracle stored procedure with multiple output parameter- Refcursor and Number example?",
    "body": "<p>I have a problem while calling a stored procedure in Spring JPA using <code>@NamedStoredProcedureQuery</code>. My stored procedure will return multiple parameters, including a <code>REF_CURSOR</code> and a <code>NUMBER</code> (for example, REF_CURSOR is for result set, and number to return total records).</p>\n<p>Therefore my code is like this - my entity class:</p>\n<pre><code>@Getter\n@Setter\n@Builder\n@NoArgsConstructor\n@AllArgsConstructor\n@FieldDefaults(level = AccessLevel.PRIVATE)\n@Entity\n@IdClass(PowerSellDataId.class)\n@NamedStoredProcedureQuery(\n        name = &quot;PowerSellData.getPowerData&quot;,\n        procedureName = &quot;PKG_DUBAOTHUONGPHAMCMIS.GET_THUONGPHAM&quot;,\n        //resultClasses = PowerSellData.class,\n        //resultClasses = {PowerSellData.class},\n        parameters = {\n            @StoredProcedureParameter(mode = ParameterMode.IN, name = &quot;P_MADVIQLY&quot;, type = String.class),\n            @StoredProcedureParameter(mode = ParameterMode.IN, name = &quot;P_THANG&quot;, type = Integer.class),\n            @StoredProcedureParameter(mode = ParameterMode.IN, name = &quot;P_NAM&quot;, type = Integer.class),\n            @StoredProcedureParameter(mode = ParameterMode.IN, name = &quot;P_LOAIDULIEU&quot;, type = Integer.class),\n            @StoredProcedureParameter(mode = ParameterMode.IN, name = &quot;P_SOKY&quot;, type = Integer.class),\n            @StoredProcedureParameter(mode = ParameterMode.IN, name = &quot;P_LOAIKH&quot;, type = Integer.class),\n            @StoredProcedureParameter(mode = ParameterMode.IN, name = &quot;P_PAGE_NUMBER&quot;, type = Integer.class),\n            @StoredProcedureParameter(mode = ParameterMode.IN, name = &quot;P_PAGE_SIZE&quot;, type = Integer.class),\n                @StoredProcedureParameter(mode = ParameterMode.REF_CURSOR, name = &quot;P_RST&quot;, type = void.class),\n                //@StoredProcedureParameter(mode = ParameterMode.OUT, name = &quot;P_RST&quot;, type = Integer.class),\n            @StoredProcedureParameter(mode = ParameterMode.OUT, name = &quot;P_TOTAL_RECORDS&quot;, type = Integer.class)\n\n        })\npublic class PowerSellData  {\n\n    @Id\n    @Column(name = &quot;MA_DVIQLY&quot;)\n    String maDviqly;\n\n    @Id\n    @Column(name = &quot;MA_KHANG&quot;)\n    String maKhang;\n\n    @Column(name = &quot;TEN_KHANG&quot;)\n    String tenKhang;\n\n    @Column(name = &quot;MANHOM_KHANG&quot;)\n    String maNhomKhang;\n\n    @Column(name = &quot;CSUAT&quot;)\n    Integer congSuat;\n\n    @Column(name = &quot;THUONG_PHAM&quot;)\n    Integer thuongPham;\n\n    @Column(name = &quot;ROW_NUM&quot;)\n    Integer rowNum;\n}\n</code></pre>\n<p>My repository class:</p>\n<pre><code>package tripqm.evn.java.power.repository;\n\nimport java.util.List;\nimport java.util.Map;\n\nimport org.springframework.data.jpa.repository.JpaRepository;\nimport org.springframework.data.jpa.repository.query.Procedure;\nimport org.springframework.data.repository.query.Param;\nimport org.springframework.stereotype.Repository;\n\nimport tripqm.evn.java.power.entity.PowerSellData;\n\n@Repository\npublic interface PowerRepository extends JpaRepository&lt;PowerSellData, Long&gt; {\n    @Procedure(name = &quot;PowerSellData.getPowerData&quot;)\n    // List&lt;PowerSellData&gt; getPowerData\n    Map&lt;String,Object&gt; getPowerData(\n            @Param(&quot;P_MADVIQLY&quot;) String madviqly,\n            @Param(&quot;P_THANG&quot;) int thang,\n            @Param(&quot;P_NAM&quot;) int nam,\n            @Param(&quot;P_LOAIDULIEU&quot;) int loaiDulieu,\n            @Param(&quot;P_SOKY&quot;) int soKy,\n            @Param(&quot;P_LOAIKH&quot;) int loaiKh,\n            @Param(&quot;P_PAGE_NUMBER&quot;) int page,\n            @Param(&quot;P_PAGE_SIZE&quot;) int size);\n}\n</code></pre>\n<p>My service class:</p>\n<pre><code>@Service\n@RequiredArgsConstructor\n@FieldDefaults(level = AccessLevel.PRIVATE, makeFinal = true)\n@Slf4j\npublic class PowerDataService {\n    PowerRepository powerRepository;\n    PowerDataMapper powerDataMapper;\n\n    @Transactional(readOnly = true)\n    public PaginationResponse&lt;PowerSellDataResponse&gt; getSellPowerData(\n            String madviqly, int thang, int nam, int loaiDulieu, int soKy, int loaiKh, int page, int size) {\n        //List&lt;PowerSellData&gt;\n        Map&lt;String,Object&gt; sellPowerData = null;\n        int totalRecords = 0;\n        int totalPages = 0;\n        try {\n            sellPowerData =\n                    powerRepository.getPowerData(madviqly, thang, nam, loaiDulieu, soKy, loaiKh, page, size);\n                    //.get(&quot;P_RST&quot;);\n            totalPages = totalRecords / size;\n        } catch (Exception e) {\n            e.printStackTrace(); // Prints full stack trace\n            throw new RuntimeException(&quot;Error fetching data from repository: &quot; + e.getMessage(), e);\n        }\n        List&lt;Object&gt; listPowerData = Arrays.asList(sellPowerData);\n//        var result = listPowerData.stream()\n//                .map(powerDataMapper::toPowerSellDataResponse)\n//                .toList();\n        return PaginationResponse.&lt;PowerSellDataResponse&gt;builder()\n                .currentPage(page)\n                .pageSize(0)\n                .totalPages(totalPages)\n                .totalElements(totalRecords)\n                .data((List)listPowerData)\n                .build();\n    }\n}\n</code></pre>\n<p>I apply exactly like the document on the Spring JPA website: <a href=\"https://docs.spring.io/spring-data/jpa/reference/jpa/stored-procedures.html\" rel=\"nofollow noreferrer\">https://docs.spring.io/spring-data/jpa/reference/jpa/stored-procedures.html</a></p>\n<p>Example 7: stored procedure metadata definitions on an entity:</p>\n<pre><code> @Entity\n    @NamedStoredProcedureQuery(name = &quot;User.multiple_out_parameters&quot;, procedureName = &quot;multiple_out_parameters&quot;, parameters = {\n      @StoredProcedureParameter(mode = ParameterMode.IN, name = &quot;arg&quot;, type = Integer.class),\n      @StoredProcedureParameter(mode = ParameterMode.REF_CURSOR, name = &quot;some_cursor&quot;, type = void.class),\n      @StoredProcedureParameter(mode = ParameterMode.OUT, name = &quot;res&quot;, type = Integer.class) })\n    public class User {}\n</code></pre>\n<p>Example 8: returning multiple OUT parameters:</p>\n<pre><code>@Procedure(name = &quot;User.multiple_out_parameters&quot;)\nMap&lt;String, Object&gt; returnsMultipleOutParameters(@Param(&quot;arg&quot;) Integer arg);\n</code></pre>\n<p>But it throws error like this:</p>\n<blockquote>\n<p>org.springframework.dao.IncorrectResultSizeDataAccessException: Call to stored procedure [PKG_DUBAOTHUONGPHAMCMIS.GET_THUONGPHAM] returned multiple results</p>\n</blockquote>\n<p>Can someone please help me, it will be thankful, because I can't find the answer anywhere on internet.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}