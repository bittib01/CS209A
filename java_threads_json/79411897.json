{
  "question": {
    "tags": [
      "java",
      "hibernate"
    ],
    "owner": {
      "account_id": 1000887,
      "reputation": 3886,
      "user_id": 1015761,
      "user_type": "registered",
      "accept_rate": 97,
      "profile_image": "https://www.gravatar.com/avatar/b16c9d5bec0f5cd54f0a2f9c365a8604?s=256&d=identicon&r=PG",
      "display_name": "Goulash",
      "link": "https://stackoverflow.com/users/1015761/goulash"
    },
    "is_answered": true,
    "view_count": 74,
    "accepted_answer_id": 79650654,
    "answer_count": 2,
    "score": 0,
    "last_activity_date": 1748927798,
    "creation_date": 1738676305,
    "last_edit_date": 1738680430,
    "question_id": 79411897,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79411897/detached-entity-passed-to-persist-immediately-after-saving",
    "title": "&quot;Detached entity passed to persist&quot; immediately after saving",
    "body": "<p>I have the following method which is throwing a <code>org.springframework.dao.InvalidDataAccessApiUsageException: detached entity passed to persist: com.domain.Passenger</code> on the <code>vehicleRepository.saveAll</code> call. I don't understand why this is happening since the <code>Passenger</code> is persisted just a few lines before, and therefore shouldn't it be an attached entity still? I'm especially confused because the <code>Property</code> save and passing that into <code>Passenger</code> works just fine.</p>\n<p>On the <code>Vehicle</code> entity, the relationship with <code>Passenger</code> is:</p>\n<pre><code>@OneToOne(cascade = CascadeType.PERSIST)\n@JoinColumn(name = &quot;passenger_id&quot;, updatable = false)\n@JsonManagedReference(value = &quot;vehicle-passenger&quot;)\nprivate Passenger passenger;\n</code></pre>\n<p>And here is the unit test set up method:</p>\n<pre><code>@DataJpaTest\n@Transactional(propagation = NOT_SUPPORTED)\n@TestInstance(TestInstance.Lifecycle.PER_CLASS)\nclass Tests {\n\n    @BeforeAll\n    void setup() {\n\n        Vehicle veh1 = build.fromFile(Vehicle.class, &quot;json/Vehicle&quot;);\n        Vehicle veh2 = build.fromFile(Vehicle.class, &quot;json/Vehicle&quot;);\n        Vehicle veh3 = build.fromFile(Vehicle.class, &quot;json/Vehicle&quot;);\n        Vehicle veh4 = build.fromFile(Vehicle.class, &quot;json/Vehicle&quot;);\n\n        // persist a property to use\n        Property property = build.fromFile(Property.class, &quot;json/Property&quot;);\n        property.setPropertyId(1L);\n        propertyRepository.save(property);\n\n        Passenger passenger1 = build.fromFile(Passenger.class, &quot;json/Passenger&quot;);\n        Passenger passenger2 = build.fromFile(Passenger.class, &quot;json/Passenger&quot;);\n\n        // add test properties to passengers\n        passenger1.setProperty(property);\n        passenger2.setProperty(property);\n        passenger1 = passengerRepository.save(passenger1);\n        passenger2 = passengerRepository.save(passenger2);\n\n        // add test passengers to vehicles\n        veh1.setPassenger(passenger1);\n        veh2.setPassenger(passenger2);\n\n        vehicleRepository.saveAll(List.of(\n            veh1,\n            veh2,\n            veh3,\n            veh4\n        ));\n    }\n\n.....\n</code></pre>\n<pre><code>@Data\n@Entity\n@DiscriminatorValue(&quot;VEHICLE&quot;)\n@FieldNameConstants\n@SuperBuilder\n@RequiredArgsConstructor\n@AllArgsConstructor\n@EqualsAndHashCode(callSuper = true)\npublic class Vehicle extends Conveyance {\n   .. removed unrelated properties for brevity ...\n}\n</code></pre>\n<pre><code>@Data\n@Entity\n@Inheritance(strategy = InheritanceType.SINGLE_TABLE)\n@DiscriminatorColumn(name = &quot;CONVEYANCE_TYPE&quot;, discriminatorType = DiscriminatorType.STRING)\n@FieldNameConstants\n@SuperBuilder\n@RequiredArgsConstructor\n@AllArgsConstructor\npublic abstract class Conveyance {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = &quot;conveyance_id_seq&quot;)\n    @SequenceGenerator(name = &quot;conveyance_id_seq&quot;, allocationSize = 1)\n    @Setter(AccessLevel.NONE)\n    private Long id;\n\n    @OneToOne(cascade = CascadeType.PERSIST)\n    @JoinColumn(name = &quot;passenger_id&quot;, updatable = false)\n    @JsonManagedReference(value = &quot;conveyance-passenger&quot;)\n    private Passenger passenger;\n}\n\n</code></pre>\n<pre><code>@Data\n@Entity\n@FieldNameConstants\n@Builder\n@NoArgsConstructor\n@AllArgsConstructor\npublic class Passenger {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = &quot;passenger_id_seq&quot;)\n    @SequenceGenerator(name = &quot;passenger_id_seq&quot;, allocationSize = 1)\n    @Setter(AccessLevel.NONE)\n    private Long id;\n\n    @Column(\n        unique = true,\n        updatable = false,\n        columnDefinition = &quot;bigint GENERATED ALWAYS AS IDENTITY (START WITH 10)&quot;\n    )\n    @Generated(event = EventType.INSERT)\n    private Long passengerId;\n\n    @ManyToOne\n    @JoinColumn(name = &quot;property_id&quot;)\n    @JsonBackReference\n    private Property property;\n\n    @OneToOne(cascade = CascadeType.PERSIST, mappedBy = Conveyance.Fields.passenger)\n    @EqualsAndHashCode.Exclude\n    @JsonBackReference(value = &quot;conveyance-passenger&quot;)\n    private Conveyance conveyance;\n}\n</code></pre>\n<pre><code>@Data\n@Entity\n@Builder\n@NoArgsConstructor\n@AllArgsConstructor\n@FieldNameConstants\npublic class Property {\n\n    public Property(Long id) {\n        this.id = id;\n    }\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = &quot;property_id_seq&quot;)\n    @SequenceGenerator(name = &quot;property_id_seq&quot;, allocationSize = 1)\n    @Setter(AccessLevel.NONE)\n    private Long id;\n\n    @Column(unique = true)\n    private Long propertyId;\n}\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}