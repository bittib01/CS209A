{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "spring-security",
      "keycloak",
      "testcontainers"
    ],
    "owner": {
      "account_id": 423574,
      "reputation": 1527,
      "user_id": 803050,
      "user_type": "registered",
      "accept_rate": 61,
      "profile_image": "https://www.gravatar.com/avatar/1a94f2d3d602f3d0aef2ea187054c30f?s=256&d=identicon&r=PG",
      "display_name": "Ivan",
      "link": "https://stackoverflow.com/users/803050/ivan"
    },
    "is_answered": false,
    "view_count": 472,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1723130316,
    "creation_date": 1720100339,
    "last_edit_date": 1723130316,
    "question_id": 78707434,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78707434/how-to-configure-a-spring-boot-webtestclient-in-a-servlet-application-to-work-wi",
    "title": "How to configure a Spring Boot WebTestClient in a Servlet application to work with OAuth 2.0 Login",
    "body": "<p>I have a bunch of end-to-end tests that use WebTestClient in a Servlet Spring Boot application.</p>\n<pre><code>@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)\n@ActiveProfiles(&quot;test&quot;)\npublic class End2EndTest {\n    \n    @Autowired\n    protected WebTestClient webClient;\n\n    public void test() {\n        webClient\n            .get()\n            .uri(&quot;api/v1/tasks&quot;)\n            .exchange()\n            .expectStatus().isOk();\n    \n    }\n}\n</code></pre>\n<p>I have now added security using <a href=\"https://docs.spring.io/spring-security/reference/servlet/oauth2/index.html#oauth2-client-log-users-in\" rel=\"nofollow noreferrer\">Spring Security OAuth 2 login feature</a>:</p>\n<pre><code>@Configuration\n@EnableWebSecurity\npublic class SecurityConfigurer {\n    @Bean\n    SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n       // ...\n\n        http.authorizeHttpRequests(c -&gt; c\n            .requestMatchers(GET, URL_V1_API_DOCS + &quot;/**&quot;).permitAll()\n            .requestMatchers(URL_V1_BASE + &quot;/**&quot;).authenticated()\n            .anyRequest().denyAll());\n\n       http           \n           .oauth2Login(withDefaults());\n           // ...\n\n        return http.build();\n    }\n}\n</code></pre>\n<p>The application runs fine and I can log in using a Keycloak auth server configured in application.properties.</p>\n<p>For my tests what I would like is to configure WebTestClient to login in a <strong>Keycloak test container</strong>.</p>\n<p>Or at least know how to mock it<sup>*</sup>. I see support for <strong>mockOidcLogin</strong> when using a WebTestClient in a reactive application or MockMvc in a servlet application. Still, it doesn't seem possible to mock it when using WebTestClient for a servlet application (Spring Security throws runtime errors).</p>\n<p><sup>*</sup>(Independently whether using mocks in an end-to-end test is the right thing to do).</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}