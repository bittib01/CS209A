{
  "question": {
    "tags": [
      "java",
      "swing"
    ],
    "owner": {
      "account_id": 29118402,
      "reputation": 85,
      "user_id": 22306589,
      "user_type": "registered",
      "profile_image": "https://i.sstatic.net/pBXhDmqf.png?s=256",
      "display_name": "Tech of the Absence",
      "link": "https://stackoverflow.com/users/22306589/tech-of-the-absence"
    },
    "is_answered": false,
    "view_count": 102,
    "answer_count": 1,
    "score": 2,
    "last_activity_date": 1750677580,
    "creation_date": 1749969350,
    "last_edit_date": 1750677580,
    "question_id": 79666355,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79666355/how-do-i-implement-compositeview-so-it-displays-the-components-correctly",
    "title": "How do I implement CompositeView so it displays the components correctly?",
    "body": "<p>I am working on a Markdown <code>EditorKit</code> (from <code>javax.swing.text</code>).<br />\nThe parser seems to work fine, but now I need to make a <code>ViewFactory</code>.</p>\n<p>The test string is parsed in such way, that we get the following structure:</p>\n<pre><code>root\n| - paragraph\n|   | - text\n| - list\n|   | - paragraph\n|   |   | - text\n|   |   | - code span\n|   |   | - text\n</code></pre>\n<p>Paragraph is converted to the <code>BoxView(elem, X_AXIS)</code>, it works great.<br />\nText is converted to my custom <code>View</code>, which is also OK.<br />\nList is converted to my custom <code>CompositeView</code>, <strong>which is the main problem</strong>, as components on it just do not show up (at all).</p>\n<p>I have the following classes:</p>\n<pre class=\"lang-java prettyprint-override\"><code>class MDListView extends MarkdownContainerView{\n    public MDListView(MDList e,ViewFactory f){\n        super(e);\n    }\n    public float getPreferredSpan(int axis){\n        //Returns a correct non-empty rectangle.\n    }\n    public Shape getChildAllocation(int index,Shape s){\n        Rectangle r=s.getBounds();\n        return new Rectangle(r.x,r.y+(int)(index*getPreferredSpan(Y_AXIS)/getViewCount()),r.width,r.height/getViewCount());\n    }\n    public void replace(int offset,int length,View[]views){\n        super.replace(offset,length,views);\n        //Some additional logic\n    }\n    protected void childAllocation(int index,Rectangle a){\n        a.setBounds(getChildAllocation(index,a).getBounds());\n    }\n}\n</code></pre>\n<p>and</p>\n<pre><code>static abstract class MarkdownContainerView extends CompositeView{\n    public MarkdownContainerView(Element e){\n        super(e);\n    }\n    public void paint(Graphics g,Shape allocation){\n        for(int i=0;i&lt;getViewCount();++i){\n            Shape a=getChildAllocation(i,allocation);\n            if(a!=null)getView(i).paint(g,a);\n        }\n    }\n    /**\n     * A stub, added for compatibility.\n     * Makes no sense for read-only documents.\n     * @see View#modelToView(int,Shape,Bias)\n     */\n    public Shape modelToView(int pos,Shape a,Bias b)throws BadLocationException{\n        return new Rectangle();\n    }\n    /**\n     * A stub, added for compatibility.\n     * Makes no sense for read-only documents.\n     * @see View#viewToModel(float, float, Shape, Bias[])\n     */\n    public int viewToModel(float x,float y,Shape a,Bias[]biasReturn){\n        return 0;\n    }\n    protected boolean isBefore(int x,int y,Rectangle alloc){\n        return (alloc.outcode(x,y)&amp;Rectangle.OUT_LEFT)!=0;\n    }\n    protected boolean isAfter(int x,int y,Rectangle alloc){\n        return (alloc.outcode(x,y)&amp;Rectangle.OUT_RIGHT)!=0;\n    }\n    protected View getViewAtPoint(int x,int y,Rectangle alloc){\n        return null;\n    }\n}\n</code></pre>\n<h3>Screenshots</h3>\n<p>What I have (empty space on the right):\n<img src=\"https://i.sstatic.net/oEGCNRA4.png\" alt=\"nothing to see at the end\" /></p>\n<p>What I need is a list with only a single paragraph in it (see the scheme above). That means that although it should be displayed just like the text before, <em>it should still be displayed</em>.\nSo, here is what I want:\n<img src=\"https://i.sstatic.net/GPrvnO7Q.png\" alt=\"a list of one item at the end\" /></p>\n<h3>A bit of debug info</h3>\n<p>MDListView <code>getView(0)</code> and <code>getView(1)</code> methods return a correct view and <strong><code>null</code></strong> respectively.</p>\n<hr />\n<p>getView(0).childAllocation is an <strong>empty</strong> rectangle.</p>\n<hr />\n<p><code>getChildAllocation</code> is <strong>never called</strong>.</p>\n<h3>Even more code</h3>\n<p>The entire implementation of ViewFactory is provided below, in case it's of any use.</p>\n<pre class=\"lang-java prettyprint-override\"><code>package com.myenvironment.swing.markdown;\n\nimport java.awt.BasicStroke;\nimport java.awt.Color;\nimport java.awt.Font;\nimport java.awt.FontMetrics;\nimport java.awt.Graphics;\nimport java.awt.Graphics2D;\nimport java.awt.Rectangle;\nimport java.awt.RenderingHints;\nimport java.awt.Shape;\n\nimport javax.swing.text.BadLocationException;\nimport javax.swing.text.BoxView;\nimport javax.swing.text.CompositeView;\nimport javax.swing.text.Element;\nimport javax.swing.text.Position.Bias;\nimport javax.swing.text.View;\nimport javax.swing.text.ViewFactory;\n\nimport com.myenvironment.swing.markdown.MarkdownDocument.CodeSpan;\nimport com.myenvironment.swing.markdown.MarkdownDocument.MDList;\nimport com.myenvironment.swing.markdown.MarkdownDocument.Text;\n\n//TODO: finish the markdown view factory\npublic class MarkdownViewFactory implements ViewFactory{\n    static abstract class MarkdownView extends View{\n        public MarkdownView(Element e){\n            super(e);\n        }\n        /**\n         * A stub, added for compatibility.\n         * Makes no sense for read-only documents.\n         * @see View#modelToView(int,Shape,Bias)\n         */\n        public Shape modelToView(int pos,Shape a,Bias b)throws BadLocationException{\n            return new Rectangle();\n        }\n        /**\n         * A stub, added for compatibility.\n         * Makes no sense for read-only documents.\n         * @see View#viewToModel(float, float, Shape, Bias[])\n         */\n        public int viewToModel(float x,float y,Shape a,Bias[]biasReturn){\n            return 0;\n        }\n    }\n    static abstract class MarkdownContainerView extends CompositeView{\n        public MarkdownContainerView(Element e){\n            super(e);\n        }\n        public void paint(Graphics g,Shape allocation){\n            for(int i=0;i&lt;getViewCount();++i){\n                Shape a=getChildAllocation(i,allocation);\n                if(a!=null)getView(i).paint(g,a);\n            }\n        }\n        /**\n         * A stub, added for compatibility.\n         * Makes no sense for read-only documents.\n         * @see View#modelToView(int,Shape,Bias)\n         */\n        public Shape modelToView(int pos,Shape a,Bias b)throws BadLocationException{\n            return new Rectangle();\n        }\n        /**\n         * A stub, added for compatibility.\n         * Makes no sense for read-only documents.\n         * @see View#viewToModel(float, float, Shape, Bias[])\n         */\n        public int viewToModel(float x,float y,Shape a,Bias[]biasReturn){\n            return 0;\n        }\n        protected boolean isBefore(int x,int y,Rectangle alloc){\n            return (alloc.outcode(x,y)&amp;Rectangle.OUT_LEFT)!=0;\n        }\n        protected boolean isAfter(int x,int y,Rectangle alloc){\n            return (alloc.outcode(x,y)&amp;Rectangle.OUT_RIGHT)!=0;\n        }\n        protected View getViewAtPoint(int x,int y,Rectangle alloc){\n            return null;\n        }\n    }\n    static class TextView extends MarkdownView{\n        public TextView(Text e){\n            super(e);\n        }\n        public float getPreferredSpan(int axis){\n            FontMetrics fm=getContainer().getFontMetrics(getContainer().getFont());\n            if(axis==X_AXIS)return fm.stringWidth(((Text)getElement()).text);\n            else if(axis==Y_AXIS)return fm.getHeight();\n            else throw new IllegalArgumentException();\n        }\n        public void paint(Graphics g,Shape allocation){\n            Graphics2D g2=(Graphics2D)g;\n            g2.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_ON);\n            g2.setClip(allocation);\n            Rectangle r=allocation.getBounds();\n            FontMetrics fm=g2.getFontMetrics();\n            String text=((Text)getElement()).text;\n            g2.setColor(getContainer().getForeground());\n            g2.drawString(text,r.x+(r.width-fm.stringWidth(text))/2,r.y+(r.height+fm.getAscent()+fm.getLeading()-fm.getDescent())/2);\n        }\n    }\n    static class CodeSpanView extends MarkdownView{\n        public CodeSpanView(CodeSpan e){\n            super(e);\n        }\n        public float getPreferredSpan(int axis){\n            FontMetrics fm=getContainer().getFontMetrics(getContainer().getFont());\n            if(axis==X_AXIS)return fm.stringWidth(((CodeSpan)getElement()).text)+fm.getHeight()/3;\n            else if(axis==Y_AXIS)return fm.getHeight();\n            else throw new IllegalArgumentException();\n        }\n        public void paint(Graphics g,Shape allocation){\n            Graphics2D g2=(Graphics2D)g;\n            g2.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_ON);\n            g2.setClip(allocation);\n            Rectangle r=allocation.getBounds();\n            g2.setColor(new Color(50,50,50,200));\n            g2.fillRoundRect(r.x,r.y,r.width,r.height,r.height/5,r.height/5);\n            g2.setStroke(new BasicStroke(r.height/10,1,1));\n            g2.setColor(Color.BLACK);\n            g2.drawRoundRect(r.x,r.y,r.width,r.height,r.height/5,r.height/5);\n            FontMetrics fm=g2.getFontMetrics();\n            String text=((CodeSpan)getElement()).text;\n            g2.setFont(new Font(Font.MONOSPACED,Font.PLAIN,getContainer().getFont().getSize()));\n            g2.setColor(Color.WHITE);\n            g2.drawString(text,r.x+(r.width-fm.stringWidth(text))/2,r.y+(r.height+fm.getAscent()+fm.getLeading()-fm.getDescent())/2);\n        }\n    }\n    static class MDListView extends MarkdownContainerView{\n        private float xSpanCached=-1,ySpanCached=-1;\n        public MDListView(MDList e,ViewFactory f){\n            super(e);\n        }\n        public float getPreferredSpan(int axis){\n            if(axis==Y_AXIS){\n                if(ySpanCached==-1){\n                    ySpanCached=0;\n                    for(int i=0;i&lt;getViewCount();++i)ySpanCached+=getView(i).getPreferredSpan(Y_AXIS);\n                }\n                return ySpanCached;\n            }else if(axis==X_AXIS){\n                if(xSpanCached==-1){\n                    xSpanCached=0;\n                    for(int i=0;i&lt;getViewCount();++i)xSpanCached=Math.max(ySpanCached,getView(i).getPreferredSpan(X_AXIS));\n                }\n                return xSpanCached;\n            }else throw new IllegalArgumentException();\n        }\n        public Shape getChildAllocation(int index,Shape s){\n            Rectangle r=s.getBounds();\n            return new Rectangle(r.x,r.y+(int)(index*getPreferredSpan(Y_AXIS)/getViewCount()),r.width,r.height/getViewCount());\n        }\n        public void replace(int offset,int length,View[]views){\n            super.replace(offset,length,views);\n            xSpanCached=-1;\n            ySpanCached=-1;\n        }\n        protected void childAllocation(int index,Rectangle a){\n            a.setBounds(getChildAllocation(index,a).getBounds());\n        }\n    }\n    public View create(Element elem){\n        View v=switch(elem){\n            case MarkdownDocument.Text e-&gt;new TextView(e);\n            case MarkdownDocument.CodeSpan e-&gt;new CodeSpanView(e);\n            case MDList e-&gt;new MDListView(e,this);\n            default-&gt;new BoxView(elem,BoxView.X_AXIS);\n            // default-&gt;throw new UnsupportedOperationException(&quot;No view for &quot;+elem.getName());\n        };\n        return v;\n    }\n}\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}