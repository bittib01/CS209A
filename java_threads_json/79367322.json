{
  "question": {
    "tags": [
      "java",
      "redis",
      "testcontainers",
      "redis-cluster"
    ],
    "owner": {
      "account_id": 30742917,
      "reputation": 49,
      "user_id": 23574254,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/d5552693f92a5e7290be7f5b04a15ec6?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "djGowda",
      "link": "https://stackoverflow.com/users/23574254/djgowda"
    },
    "is_answered": true,
    "view_count": 1337,
    "accepted_answer_id": 79371934,
    "answer_count": 2,
    "score": 0,
    "last_activity_date": 1762310660,
    "creation_date": 1737210568,
    "last_edit_date": 1737281281,
    "question_id": 79367322,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79367322/how-to-bring-up-redis-cluster-using-testcontainers-in-java",
    "title": "How to bring up redis cluster using testContainers in java",
    "body": "<p>I'm trying to create a Redis cluster using TestContainers to test my application, which depends on a Redis cluster. Here's what I have tried so far:</p>\n<p>Code snippet for starting container:</p>\n<pre><code>Network network = Network.newNetwork();\nRedisContainer redisContainer = new RedisContainer(DockerImageName.parse(&quot;redis:7.0.5&quot;))\n                    .withExposedPorts(port)\n                    .withCommand(&quot;redis-server --port &quot; + port +\n                            &quot; --requirepass &quot; + redisPassword +  // Password for clients\n                            &quot; --masterauth &quot; + redisPassword +  // Password for inter-node communication\n                            &quot; --cluster-enabled yes&quot; +\n                            &quot; --cluster-config-file nodes.conf&quot;+\n                            &quot; --cluster-node-timeout 5000&quot;+\n                            &quot; --appendonly yes&quot; +\n                            &quot; --bind 0.0.0.0&quot; )\n                    .withNetwork(network)\n                    .withNetworkMode(&quot;bridge&quot;)\n                    .withNetworkAliases(&quot;redis-&quot; + i)\n                    .waitingFor(Wait.forListeningPort());\n</code></pre>\n<p><strong>1. Single-Node Cluster</strong></p>\n<p>I attempted to create a single-node cluster with cluster-enabled set to yes and replica set to 0. I tried connecting to it using JedisCluster.</p>\n<p>Issues and Fixes:</p>\n<p>Initially, I got the error: <code>Cluster slots not allocated</code>. I resolved this by running the CLUSTER ADDSLOTS command to allocate the slot range.\nAfter this, I ran the CLUSTER NODES command and got the following output:</p>\n<pre><code>1f2673c5fdb45ca16d564658ff88f815db5cbf01 172.29.0.2:6379@16379 myself,master - 0 0 1 connected 0-16383\n</code></pre>\n<p>However, when I tried connecting to the cluster using JedisCluster, connection got established, I was able to get nodes list with ip and port using jedisCluster.getClusterNodes() api. When I tried writing some key value pair got below error after few seconds.</p>\n<p><code>redis.clients.jedis.exceptions.JedisClusterOperationException: Cluster retry deadline exceeded.</code></p>\n<p>Oddly enough, running commands via redis-cli worked perfectly for both writing and reading data.\nCluster Info Output:</p>\n<pre><code>cluster_state:ok\ncluster_slots_assigned:16384\ncluster_slots_ok:16384\ncluster_slots_pfail:0\ncluster_slots_fail:0\ncluster_known_nodes:1\ncluster_size:1\ncluster_current_epoch:1\ncluster_my_epoch:1\ncluster_stats_messages_pong_sent:1\ncluster_stats_messages_meet_sent:1\ncluster_stats_messages_sent:2\ncluster_stats_messages_pong_received:1\ncluster_stats_messages_meet_received:1\ncluster_stats_messages_received:2\ntotal_cluster_links_buffer_limit_exceeded:0\n</code></pre>\n<p>Cluster Slots Output:</p>\n<pre><code>1) 1) (integer) 0\n   2) (integer) 16383\n   3) 1) &quot;172.29.0.2&quot;\n      2) (integer) 6379\n      3) &quot;b47f7da9be31ce953d4b4fbf9e3a737d1c9b7a58&quot;\n      4) (empty array)\n</code></pre>\n<p><strong>2. Multi-Node Cluster</strong></p>\n<p>I also tried setting up a 6-node cluster (3 masters and 3 slaves).</p>\n<p>Observations:</p>\n<p>JedisCluster.getClusterNodes() returned the correct node information for all 3 master nodes (IP and port).\nHowever, when I tried writing data to the cluster using JedisCluster, I got the following error:</p>\n<pre><code>redis.clients.jedis.exceptions.JedisClusterOperationException: Cluster retry deadline exceeded.\n</code></pre>\n<p>When I used redis-cli -c to write data, it got stuck at the <code>Redirecting to slot [&lt;some slot&gt;] located at &lt;ip&gt; node</code> message.</p>\n<p>Possible Issue\nI'm trying to bring up redis in a container using TestContainer module. I suspect the nodes in the cluster are unable to communicate with each other properly. In the case of the single-node cluster, some configuration might still be missing. Some</p>\n<p>Any help in resolving this issue would be greatly appreciated. Thanks!</p>\n<p>Edit:</p>\n<p>JedisCluster Config code:</p>\n<pre><code>// Using redisContainer in above code snippet start the container and run  &lt;redis-cli --no-auth-warning -h localhost -p 6379 -a password cluster addslotsrange 0 16383&gt; to add slots and continue with below code\n\n        GenericObjectPoolConfig poolConfig = new GenericObjectPoolConfig();\n        poolConfig.setMaxTotal(Runtime.getRuntime().availableProcessors()); \n        poolConfig.setMaxIdle(Runtime.getRuntime().availableProcessors());\n        poolConfig.setMinIdle(Runtime.getRuntime().availableProcessors());\n        poolConfig.setMaxWaitMillis(2000);\n\n//        Connect to the cluster using Jedis with a password\n        DefaultJedisClientConfig.Builder jedisClientConfig = DefaultJedisClientConfig.builder()\n                .password(redisPassword)\n                .ssl(false)\n                .connectionTimeoutMillis(10000)\n                .socketTimeoutMillis(4000);\n\n        final Set&lt;HostAndPort&gt; hosts = new HashSet&lt;&gt;(redisContainers.size());\n        int i = 0;\n        for(RedisContainer redisContainer : redisContainers){\n            String redisHost = &quot;127.0.0.1&quot;;\n            int redisPort = redisContainer.getMappedPort(basePort+i);\n            hosts.add(new HostAndPort(redisHost, redisPort));\n            i += 1;\n        }\n\n        System.out.println(&quot;Hosts &quot; + hosts);\n\n        try (JedisCluster jedis = new JedisCluster(hosts, jedisClientConfig.build(), 3, poolConfig)) {\n            Map&lt;String, redis.clients.jedis.ConnectionPool&gt; nodes = jedis.getClusterNodes();\n            System.out.println(&quot;Connected cluster nodes: &quot; + nodes);\n            nodes.forEach((key, value) -&gt; System.out.println(key));\n            jedis.set(&quot;key&quot;, &quot;value&quot;); // This is where the error is seen\n            System.out.println(&quot;Key set in Redis Cluster: &quot; + jedis.get(&quot;key&quot;));\n        }\n    ```\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}