{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "spring-security",
      "jwt"
    ],
    "owner": {
      "account_id": 5438368,
      "reputation": 193,
      "user_id": 4327100,
      "user_type": "registered",
      "accept_rate": 58,
      "profile_image": "https://www.gravatar.com/avatar/abaea12bb4f205cfcec5f26a3b184731?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "CODI",
      "link": "https://stackoverflow.com/users/4327100/codi"
    },
    "is_answered": true,
    "view_count": 418,
    "accepted_answer_id": 78690037,
    "answer_count": 1,
    "score": -2,
    "last_activity_date": 1723508173,
    "creation_date": 1719684434,
    "last_edit_date": 1719753388,
    "question_id": 78686737,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78686737/spring-security-issue-with-jwt-cannot-subclass-final-class-jwtauthenticationpro",
    "title": "Spring Security issue with JWT: Cannot subclass final class JwtAuthenticationProvider",
    "body": "<p>I would appreciate your help with resolving this issue. I have an application (appA) developed with spring-boot 3.2.5. This application has another module (moduleA) which implements Spring Security's resource server (spring-boot-starter-oauth2-resource-server). Whenever I try to start the application, I get this error:</p>\n<pre class=\"lang-none prettyprint-override\"><code>Error creating bean with name\n'org.springframework.security.config.annotation.web.configuration.WebSecurityConfiguration':\nUnsatisfied dependency expressed through method 'setFilterChains'\nparameter 0: Error creating bean with name\n'oAuth2ResourceServerFilterChain' defined in class path resource\n[com/modulea/oauth2resourceserver/config/Oauth2ResourceServerConfig.class]:\nFailed to instantiate\n[org.springframework.security.web.SecurityFilterChain]: Factory method\n'oAuth2ResourceServerFilterChain' threw exception with message: Could\nnot postProcess\n org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationProvider@26f1b53b of type class\norg.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationProvider\n\nCaused by: org.springframework.beans.factory.BeanCreationException:\nError creating bean with name 'oAuth2ResourceServerFilterChain'\ndefined in class path resource\n[oauth2resourceserver/config/Oauth2ResourceServerConfig.class]: Failed\nto instantiate [org.springframework.security.web.SecurityFilterChain]:\nFactory method 'oAuth2ResourceServerFilterChain' threw exception with\nmessage: Could not postProcess\n\norg.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationProvider@26f1b53b of type class\n org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationProvider\n    at\n org.springframework.beans.factory.support.ConstructorResolver.instantiate(ConstructorResolver.java:648)\n~[spring-beans-6.1.6.jar:6.1.6]\n\nProject Structure\n\n1. AppA's pom\n\n    &lt;dependency&gt;\n      &lt;groupId&gt;com.modulea&lt;/groupId&gt;\n      &lt;artifactId&gt;oauth2-resourceserver&lt;/artifactId&gt;\n      &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;/dependency&gt;\n\n2. Module A\n - src\n   - main\n     - com\n       - modulea\n         - oauth2resourceserver\n           - config\n             - Oauth2ResourceServerConfig\n             - RsaKeyProperties\n             - DecoderEncoderConfig\n\nOauth2ResourceServerConfig\n\n    package com.modulea.oauth2resourceserver.config;\n    \n    import lombok.AccessLevel;\n    import lombok.RequiredArgsConstructor;\n    import org.springframework.beans.factory.annotation.Autowired;\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.context.annotation.Configuration;\n    import org.springframework.core.annotation.Order;\n    import org.springframework.security.config.Customizer;\n    import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n    import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;\n    \n    import org.springframework.security.config.http.SessionCreationPolicy;\n    import org.springframework.security.oauth2.jwt.JwtDecoder;\n    import org.springframework.security.web.SecurityFilterChain;\n    import org.springframework.security.web.savedrequest.HttpSessionRequestCache;\n    \n    @RequiredArgsConstructor(access = AccessLevel.PROTECTED, onConstructor_ = {@Autowired})\n    @Configuration\n    public class Oauth2ResourceServerConfig {\n        private final JwtDecoder jwtDecoder;\n    \n        @Order(4)\n        @Bean\n        public SecurityFilterChain oAuth2ResourceServerFilterChain(HttpSecurity http) throws Exception {\n            HttpSessionRequestCache requestCache = new HttpSessionRequestCache();\n            requestCache.setMatchingRequestParameterName(null);\n            http\n                    .csrf(AbstractHttpConfigurer::disable)\n                    .authorizeHttpRequests(authorize -&gt; authorize\n                            .requestMatchers(&quot;/internal/**&quot;)\n                                    .permitAll()\n                            .anyRequest()\n                                    .authenticated())\n                    .oauth2ResourceServer(oAuth2ResourceServerConfigurer -&gt; oAuth2ResourceServerConfigurer.jwt(Customizer.withDefaults()))\n                    .sessionManagement(sessionManagement -&gt; sessionManagement\n                            .sessionCreationPolicy(SessionCreationPolicy.STATELESS))\n                    .httpBasic(Customizer.withDefaults());\n            return http\n                    .build();\n        }\n    }\n\nRsaKeyProperties\n\n    package com.modulea.oauth2resourceserver.config;\n    \n    import org.springframework.boot.context.properties.ConfigurationProperties;\n    \n    import java.security.interfaces.RSAPrivateKey;\n    import java.security.interfaces.RSAPublicKey;\n    \n    @ConfigurationProperties(prefix = &quot;rsa&quot;)\n    public record RsaKeyProperties(RSAPublicKey publicKey, RSAPrivateKey privateKey) {\n    }\n\nDecoderEncoderConfig\n\n    package com.modulea.oauth2resourceserver.config;\n    \n    import com.nimbusds.jose.jwk.JWK;\n    import com.nimbusds.jose.jwk.JWKSet;\n    import com.nimbusds.jose.jwk.RSAKey;\n    import com.nimbusds.jose.jwk.source.ImmutableJWKSet;\n    import com.nimbusds.jose.jwk.source.JWKSource;\n    import com.nimbusds.jose.proc.SecurityContext;\n    import lombok.RequiredArgsConstructor;\n    import org.springframework.boot.context.properties.EnableConfigurationProperties;\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.context.annotation.Configuration;\n    import org.springframework.security.oauth2.jwt.JwtDecoder;\n    import org.springframework.security.oauth2.jwt.JwtEncoder;\n    import org.springframework.security.oauth2.jwt.NimbusJwtDecoder;\n    import org.springframework.security.oauth2.jwt.NimbusJwtEncoder;\n    \n    @EnableConfigurationProperties({RsaKeyProperties.class})\n    @RequiredArgsConstructor\n    @Configuration\n    public class DecoderEncoderConfig {\n    \n        private final RsaKeyProperties rsaKeyProperties;\n    \n        @Bean\n        public JwtDecoder jwtDecoder() {\n            return NimbusJwtDecoder.withPublicKey(rsaKeyProperties.publicKey()).build();\n        }\n    \n        @Bean\n        public JwtEncoder jwtEncoder() {\n            JWK jwk = new RSAKey.Builder(rsaKeyProperties.publicKey()).privateKey(rsaKeyProperties.privateKey()).build();\n            JWKSource&lt;SecurityContext&gt; jwkSource = new ImmutableJWKSet&lt;&gt;(new JWKSet(jwk));\n            return new NimbusJwtEncoder(jwkSource);\n        }\n    }\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}