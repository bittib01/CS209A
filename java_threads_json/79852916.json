{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "spring-security"
    ],
    "owner": {
      "account_id": 6420196,
      "reputation": 654,
      "user_id": 4977114,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/15bb38f4426a207b550e9e27b97e9edf?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Hayo Baan",
      "link": "https://stackoverflow.com/users/4977114/hayo-baan"
    },
    "is_answered": false,
    "view_count": 32,
    "answer_count": 0,
    "score": 0,
    "last_activity_date": 1766492338,
    "creation_date": 1766409785,
    "last_edit_date": 1766492338,
    "question_id": 79852916,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79852916/webmvctest-security-unit-tests-no-longer-working-with-spring-boot-4",
    "title": "WebMvcTest security unit tests no longer working with Spring Boot 4",
    "body": "<p>I have a (jwt) security enabled application and have written unit tests to verify the security filtering works as expected. With Spring Boot 3 these unit tests work fine, however, after upgrading to Spring Boot 4 they no longer work. The application, however works just fine and applies the security filtering as expected.</p>\n<p>I have debugged this and found the issue to be with the calling order of the filter. With Spring Boot 4, inside the WebMvcTest, my authentication filter is called at the very beginning of the request handling even before trying to match it (and then again when applying the filter chain; this should be the first call). That first call does not happen in the Spring Boot 3 version and neither does it happen when <em>running</em> the application. It's that first call that breaks the test as the authentication is then no longer set properly when running the filter chain (it's a once per request filter so doesn't get called again).</p>\n<p>Looks to me like a bug in how security/filtering is set up inside a WebMvcTest; it's clearly different from how the application normally sets it up. But perhaps there's something I overlooked or can/should do to fix this under Spring Boot 4?</p>\n<p>I have created a small example project that illustrates the issue on <a href=\"https://github.com/HayoBaan/spring-security-test\" rel=\"nofollow noreferrer\">github</a>.</p>\n<p>Example test log with Spring Boot 3:</p>\n<pre><code>2025-12-22T14:00:49.617+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Trying to match request against DefaultSecurityFilterChain defined as 'filterChain' in [class path resource [com/hayobaan/securitytest/security/SecurityConfiguration.class]] matching [any request] and having filters [DisableEncodeUrl, WebAsyncManagerIntegration, SecurityContextHolder, HeaderWriter, Cors, Logout, JwtAuthentication, RequestCacheAware, SecurityContextHolderAwareRequest, AnonymousAuthentication, SessionManagement, ExceptionTranslation, Authorization] (1/1)\n2025-12-22T14:00:49.617+01:00 DEBUG 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Securing GET /getUserInfo\n2025-12-22T14:00:49.617+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking DisableEncodeUrlFilter (1/13)\n2025-12-22T14:00:49.617+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking WebAsyncManagerIntegrationFilter (2/13)\n2025-12-22T14:00:49.617+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking SecurityContextHolderFilter (3/13)\n2025-12-22T14:00:49.617+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking HeaderWriterFilter (4/13)\n2025-12-22T14:00:49.617+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking CorsFilter (5/13)\n2025-12-22T14:00:49.617+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking LogoutFilter (6/13)\n2025-12-22T14:00:49.617+01:00 TRACE 25899 --- [security-test] [           main] o.s.s.w.a.logout.LogoutFilter            : Did not match request to Or [Ant [pattern='/logout', GET], Ant [pattern='/logout', POST], Ant [pattern='/logout', PUT], Ant [pattern='/logout', DELETE]]\n2025-12-22T14:00:49.617+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking JwtAuthenticationFilter (7/13)\n2025-12-22T14:00:49.617+01:00 DEBUG 25899 --- [security-test] [           main] c.h.s.security.JwtAuthenticationFilter   : Inside JwtAuthenticationFilter.doFilter\n2025-12-22T14:00:49.617+01:00 DEBUG 25899 --- [security-test] [           main] c.h.s.security.JwtAuthenticationFilter   : Inside JwtAuthenticationFilter.doFilterInternal\n2025-12-22T14:00:49.618+01:00 DEBUG 25899 --- [security-test] [           main] c.h.s.security.JwtAuthenticationFilter   : Authenticated: UsernamePasswordAuthenticationToken [Principal=authenticatedUser, Credentials=[PROTECTED], Authenticated=true, Details=null, Granted Authorities=[User]]\n2025-12-22T14:00:49.618+01:00 TRACE 25899 --- [security-test] [           main] .s.s.w.c.SupplierDeferredSecurityContext : Created SecurityContextImpl [Null authentication]\n2025-12-22T14:00:49.618+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking RequestCacheAwareFilter (8/13)\n2025-12-22T14:00:49.618+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking SecurityContextHolderAwareRequestFilter (9/13)\n2025-12-22T14:00:49.618+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking AnonymousAuthenticationFilter (10/13)\n2025-12-22T14:00:49.618+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking SessionManagementFilter (11/13)\n2025-12-22T14:00:49.618+01:00 TRACE 25899 --- [security-test] [           main] o.s.s.w.a.AnonymousAuthenticationFilter  : Did not set SecurityContextHolder since already authenticated UsernamePasswordAuthenticationToken [Principal=authenticatedUser, Credentials=[PROTECTED], Authenticated=true, Details=null, Granted Authorities=[User]]\n2025-12-22T14:00:49.618+01:00 TRACE 25899 --- [security-test] [           main] s.CompositeSessionAuthenticationStrategy : Preparing session with ChangeSessionIdAuthenticationStrategy (1/1)\n2025-12-22T14:00:49.618+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking ExceptionTranslationFilter (12/13)\n2025-12-22T14:00:49.618+01:00 TRACE 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking AuthorizationFilter (13/13)\n2025-12-22T14:00:49.618+01:00 TRACE 25899 --- [security-test] [           main] estMatcherDelegatingAuthorizationManager : Authorizing GET /getUserInfo\n2025-12-22T14:00:49.618+01:00 TRACE 25899 --- [security-test] [           main] estMatcherDelegatingAuthorizationManager : Checking authorization on GET /getUserInfo using AuthorityAuthorizationManager[authorities=[User, Admin]]\n2025-12-22T14:00:49.618+01:00 DEBUG 25899 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Secured GET /getUserInfo\n2025-12-22T14:00:49.618+01:00 DEBUG 25899 --- [security-test] [           main] c.h.s.security.JwtAuthenticationFilter   : Inside JwtAuthenticationFilter.doFilter\n2025-12-22T14:00:49.618+01:00 TRACE 25899 --- [security-test] [           main] o.s.s.w.header.writers.HstsHeaderWriter  : Not injecting HSTS header since it did not match request to [Is Secure]\n</code></pre>\n<p>Same test log with Spring Boot 4 (stack trace stripped):</p>\n<pre><code>2025-12-22T14:02:58.044+01:00 DEBUG 26270 --- [security-test] [           main] c.h.s.security.JwtAuthenticationFilter   : Inside JwtAuthenticationFilter.doFilter\n2025-12-22T14:02:58.044+01:00 DEBUG 26270 --- [security-test] [           main] c.h.s.security.JwtAuthenticationFilter   : Inside JwtAuthenticationFilter.doFilterInternal\n2025-12-22T14:02:58.044+01:00 DEBUG 26270 --- [security-test] [           main] c.h.s.security.JwtAuthenticationFilter   : Authenticated: UsernamePasswordAuthenticationToken [Principal=authenticatedUser, Credentials=[PROTECTED], Authenticated=true, Details=null, Granted Authorities=[User]]\n2025-12-22T14:02:58.044+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Trying to match request against DefaultSecurityFilterChain defined as 'filterChain' in [class path resource [com/hayobaan/securitytest/security/SecurityConfiguration.class]] matching [any request] and having filters [DisableEncodeUrl, WebAsyncManagerIntegration, SecurityContextHolder, HeaderWriter, Cors, Logout, JwtAuthentication, RequestCacheAware, SecurityContextHolderAwareRequest, AnonymousAuthentication, SessionManagement, ExceptionTranslation, Authorization] (1/1)\n2025-12-22T14:02:58.044+01:00 DEBUG 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Securing GET /getUserInfo\n2025-12-22T14:02:58.044+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking DisableEncodeUrlFilter (1/13)\n2025-12-22T14:02:58.044+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking WebAsyncManagerIntegrationFilter (2/13)\n2025-12-22T14:02:58.044+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking SecurityContextHolderFilter (3/13)\n2025-12-22T14:02:58.044+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking HeaderWriterFilter (4/13)\n2025-12-22T14:02:58.044+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking CorsFilter (5/13)\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking LogoutFilter (6/13)\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] o.s.s.w.a.logout.LogoutFilter            : Did not match request to Or [PathPattern [GET /logout], PathPattern [POST /logout], PathPattern [PUT /logout], PathPattern [DELETE /logout]]\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking JwtAuthenticationFilter (7/13)\n2025-12-22T14:02:58.045+01:00 DEBUG 26270 --- [security-test] [           main] c.h.s.security.JwtAuthenticationFilter   : Inside JwtAuthenticationFilter.doFilter\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking RequestCacheAwareFilter (8/13)\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking SecurityContextHolderAwareRequestFilter (9/13)\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking AnonymousAuthenticationFilter (10/13)\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking SessionManagementFilter (11/13)\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] .s.s.w.c.SupplierDeferredSecurityContext : Created SecurityContextImpl [Null authentication]\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] o.s.s.w.a.AnonymousAuthenticationFilter  : Set SecurityContextHolder to AnonymousAuthenticationToken [Principal=anonymousUser, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[ROLE_ANONYMOUS]]\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking ExceptionTranslationFilter (12/13)\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] o.s.security.web.FilterChainProxy        : Invoking AuthorizationFilter (13/13)\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] estMatcherDelegatingAuthorizationManager : Authorizing GET /getUserInfo\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] estMatcherDelegatingAuthorizationManager : Checking authorization on GET /getUserInfo using AuthorityAuthorizationManager[authorities=[User, Admin]]\n2025-12-22T14:02:58.045+01:00 TRACE 26270 --- [security-test] [           main] o.s.s.w.a.ExceptionTranslationFilter     : Sending AnonymousAuthenticationToken [Principal=anonymousUser, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[ROLE_ANONYMOUS]] to authentication entry point since access is denied\n\norg.springframework.security.authorization.AuthorizationDeniedException: Access Denied\n    at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:99) ~[spring-security-web-7.0.0.jar:7.0.0]\n\n...\n\n2025-12-22T14:02:58.046+01:00 DEBUG 26270 --- [security-test] [           main] o.s.s.w.a.Http403ForbiddenEntryPoint     : Pre-authenticated entry point called. Rejecting access\n2025-12-22T14:02:58.046+01:00 TRACE 26270 --- [security-test] [           main] o.s.s.w.header.writers.HstsHeaderWriter  : Not injecting HSTS header since it did not match request to [Is Secure]\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}