{
  "question": {
    "tags": [
      "java",
      "c#",
      "spring",
      "bouncycastle",
      "aes-gcm"
    ],
    "owner": {
      "account_id": 12945841,
      "reputation": 434,
      "user_id": 9360232,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/31d1f2677bb34a6a8864509ba482f8b5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "ashtrix-001",
      "link": "https://stackoverflow.com/users/9360232/ashtrix-001"
    },
    "is_answered": true,
    "view_count": 246,
    "accepted_answer_id": 79717239,
    "answer_count": 1,
    "score": 3,
    "last_activity_date": 1762801703,
    "creation_date": 1753695074,
    "last_edit_date": 1753710234,
    "question_id": 79717119,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79717119/i-have-an-encrypted-text-from-javas-bouncy-castle-library-using-aes-gcm-which-i",
    "title": "I have an encrypted text from Java&#39;s Bouncy Castle Library using AES/GCM which I am unable to decrypt using C# Bouncy Castle library AES/GCM",
    "body": "<p>I have a text which I am encrypting using Java's Bouncy Castle AES/GCM utility.</p>\n<pre><code>package com.stackoflow.symmetric_token_decryptor;\n    \nimport static org.apache.commons.codec.binary.Hex.encodeHex;\n\nimport java.nio.charset.StandardCharsets;\nimport java.security.Key;\nimport java.security.NoSuchAlgorithmException;\n\nimport javax.crypto.KeyGenerator;\n\nimport org.bouncycastle.util.encoders.Base64;\nimport org.springframework.security.crypto.encrypt.BouncyCastleAesGcmBytesEncryptor;\nimport org.springframework.security.crypto.encrypt.BytesEncryptor;\n\npublic class App \n{\n    public static void main( String[] args ) throws Exception\n    {\n        String generatedKey = generateSymmetricKey();\n        \n        System.out.println(&quot;generatedKey = &quot; + generatedKey);\n        \n        String encryptedToken = encrypt(&quot;abc&quot;, generatedKey);\n        \n        System.out.println(&quot;encryptedToken = &quot; + encryptedToken);\n        \n        String plainToken = decryptToken(encryptedToken, generatedKey);\n        \n        System.out.println(plainToken);\n    }\n\n    private static String generateSymmetricKey() throws NoSuchAlgorithmException {\n\n            KeyGenerator keyGen = KeyGenerator.getInstance(&quot;AES&quot;);\n            keyGen.init(256);\n            Key key = keyGen.generateKey();\n\n            return new String(encodeHex(key.getEncoded()));\n        }\n    \n    private static String encrypt(String text, String secretKey) {\n        BytesEncryptor encryptor = new BouncyCastleAesGcmBytesEncryptor(&quot;&quot;, secretKey);\n        return new String(Base64.encode(encryptor.encrypt(text.getBytes())), StandardCharsets.UTF_8);\n    }\n}\n</code></pre>\n<p>Output:</p>\n<pre><code>generatedKey = e4deeabbdfbf504f5a980bb7e4ae6b8e9cb8896cd5e64692e162a9691449c196\nencryptedToken = 52nvbvyz2mEYBIb+grW5SNXplUufgeTtlVVOVOmhqRFvmeg=\n</code></pre>\n<p>Spring Framework's Bouncy Castle AES/GCM utility uses 16 byte IV by default.</p>\n<p>pom.xml:</p>\n<pre><code>&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n    &lt;groupId&gt;com.stackoflow&lt;/groupId&gt;\n    &lt;artifactId&gt;symmetric-token-decryptor&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;packaging&gt;jar&lt;/packaging&gt;\n    &lt;name&gt;symmetric-token-decryptor&lt;/name&gt;\n    &lt;url&gt;http://maven.apache.org&lt;/url&gt;\n    &lt;properties&gt;\n        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;\n        &lt;java.version&gt;17&lt;/java.version&gt;\n        &lt;maven.compiler.source&gt;${java.version}&lt;/maven.compiler.source&gt;\n        &lt;maven.compiler.target&gt;${java.version}&lt;/maven.compiler.target&gt;\n    &lt;/properties&gt;\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-security-crypto&lt;/artifactId&gt;\n            &lt;version&gt;5.8.10&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.bouncycastle&lt;/groupId&gt;\n            &lt;artifactId&gt;bcprov-jdk18on&lt;/artifactId&gt;\n            &lt;version&gt;1.80&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;commons-codec&lt;/groupId&gt;\n            &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;\n            &lt;version&gt;1.18.0&lt;/version&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n&lt;/project&gt;\n</code></pre>\n<p>I have to decrypt the cipher text in C# (.NET Core 3.1), for which I am using the below code:</p>\n<pre><code>using Org.BouncyCastle.Crypto.Engines;\nusing Org.BouncyCastle.Crypto.Modes;\nusing Org.BouncyCastle.Crypto.Parameters;\nusing System;\nusing System.Linq;\nusing System.Security.Cryptography;\nusing System.Text;\n\nnamespace Symmetric_Decryption_AES_GCM_C_ {\n\nclass Program\n{\n    static void Main(string[] args)\n    {\n        String encryptedToken = &quot;52nvbvyz2mEYBIb+grW5SNXplUufgeTtlVVOVOmhqRFvmeg=&quot;;\n\n        String secretKey = &quot;e4deeabbdfbf504f5a980bb7e4ae6b8e9cb8896cd5e64692e162a9691449c196&quot;;\n\n        Console.WriteLine(DecryptPayload(encryptedToken, secretKey));\n    }\n\n    private static string DecryptPayload(string base64EncryptedToken, string stringKey)\n    {\n        Console.WriteLine(&quot;----C# Decryption Details----&quot;);\n        byte[] encryptedToken = Convert.FromBase64String(base64EncryptedToken); // Converting the base64 string encrypted text to byte[]\n\n        byte[] key = Enumerable.Range(0, stringKey.Length / 2)\n           .Select(i =&gt; Convert.ToByte(stringKey.Substring(i * 2, 2), 16))\n           .ToArray(); // Converting hex encoded key to byte[]\n\n        int ivLength = 16;\n        int ciphertextTagLength = encryptedToken.Length - ivLength;\n\n        byte[] iv = new byte[ivLength];\n        byte[] ciphertextTag = new byte[ciphertextTagLength];\n\n        Buffer.BlockCopy(encryptedToken, 0, iv, 0, ivLength);\n        Buffer.BlockCopy(encryptedToken, ivLength, ciphertextTag, 0, ciphertextTagLength);\n\n        return DecryptWithGCM(ciphertextTag, key, iv);\n    }\n\n    private static string DecryptWithGCM(byte[] ciphertextTag, byte[] key, byte[] nonce)\n    {\n        var cipher = new GcmBlockCipher(new AesEngine());\n        cipher.Init(false, new AeadParameters(new KeyParameter(key), 128, nonce, null));\n\n        int outputSizeDecryptedData = cipher.GetOutputSize(ciphertextTag.Length);\n\n        byte[] decryptedBytes = new byte[outputSizeDecryptedData];\n\n        int processedBytes = cipher.ProcessBytes(ciphertextTag, 0, ciphertextTag.Length, decryptedBytes, 0);\n\n        cipher.DoFinal(decryptedBytes, processedBytes);\n\n        return Encoding.UTF8.GetString(decryptedBytes);\n    }\n}\n}\n</code></pre>\n<p>This decryption code works fine if I am encrypting/decrypting a text in C#, hence the code is working.\nBut when I am giving the encrypted text generated from Java code then I am getting</p>\n<blockquote>\n<p>mac check failed in GCM</p>\n</blockquote>\n<p>Also, the Java code works fine as well if I am encrypting/decrypting only in Java</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}