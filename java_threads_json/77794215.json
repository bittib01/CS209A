{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "hibernate",
      "spring-data-jpa",
      "parallel-processing"
    ],
    "owner": {
      "account_id": 2166428,
      "reputation": 111,
      "user_id": 1919452,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/26919d4fbe922de7ce924720229aa9f5?s=256&d=identicon&r=PG",
      "display_name": "user1919452",
      "link": "https://stackoverflow.com/users/1919452/user1919452"
    },
    "is_answered": true,
    "view_count": 12998,
    "answer_count": 4,
    "score": 9,
    "last_activity_date": 1722857831,
    "creation_date": 1704897783,
    "last_edit_date": 1718622079,
    "question_id": 77794215,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/77794215/illegalstateexception-illegal-pop-with-non-matching-jdbcvaluessourceprocessin",
    "title": "IllegalStateException: Illegal pop() with non-matching JdbcValuesSourceProcessingState with spring JpaRepository&lt;&gt;",
    "body": "<p>I have a repository implemented with <code>CriteriaQuery</code>, that loads an entity that is part of a parent-child structure. The <em>Illegal pop() with non-matching JdbcValuesSourceProcessingState</em> exception comes up irregularly when a webservice is called in parallel that uses this repository and lazy loads the parent of the loaded entity recursively in the business logic. The call stack of the exception points to the line where the parent is loaded. The REST webservice is annotated with <code>@Transactional(readOnly = true, propagation = Propagation.REQUIRES_NEW)</code>. All involved classes are annotated as some sort of a Component with default scope and use default <code>@Transactional</code> scope of <code>REQUIRED</code>.</p>\n<p>Having the parents loaded eagerly did not solve the problem, nor did rewriting the repository to be a <code>JpaRepository</code>. But if I do both, the problem is not reproduceable any more.</p>\n<p>Tech. stack: spring-boot 3.1.4, hibernate 6.4.1, java 17, docker.</p>\n<p>I do not use Uni&lt;&gt; nor quarkus as in other similar questions:</p>\n<p><a href=\"https://stackoverflow.com/questions/77774102/illegal-pop-with-non-matching-jdbcvaluessourceprocessingstate\">Illegal pop() with non-matching JdbcValuesSourceProcessingState</a></p>\n<p><a href=\"https://stackoverflow.com/questions/75345248/hibernate-6-error-invaliddataaccessapiusageexception-illegal-pop-with-non-mat\">Hibernate 6 Error InvalidDataAccessApiUsageException: Illegal pop() with non-matching JdbcValuesSourceProcessingState</a></p>\n<p>My understanding is that this exception is caused by using an <code>EntityManager</code> in non thread safe way. So I would assume that using the <code>JpaRepository</code> solution that is designed to be thread safe should solve the problem and I do not need to load the parents eagerly.</p>\n<p>Can somebody please explain why this exception occurs whit a thread safe usage of the entity manager?</p>\n<p>Thanks in advance,\nBen</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}