{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "micrometer",
      "mdc"
    ],
    "owner": {
      "account_id": 33069385,
      "reputation": 33,
      "user_id": 25644235,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/bf67c5ca2b8275de131e40a560bb8ec9?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "Heorhi Utseuski",
      "link": "https://stackoverflow.com/users/25644235/heorhi-utseuski"
    },
    "is_answered": true,
    "view_count": 4128,
    "accepted_answer_id": 78765658,
    "answer_count": 1,
    "score": 2,
    "last_activity_date": 1725804957,
    "creation_date": 1720960268,
    "last_edit_date": 1721072802,
    "question_id": 78746378,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78746378/spring-boot-3-micrometer-tracing-in-mdc",
    "title": "Spring Boot 3 micrometer tracing in MDC",
    "body": "<p>I need to organize custom tracing and logging.\nLogging logback (Slf4j).</p>\n<p>I have a service that needs to read fields from the header and add them to the correlation (before switching to spring boot 3, I used MDC to distribute data). Plus I also added custom fields to MDC for logging.</p>\n<p>After switching to spring boot 3 (from sleuth to micrometer), I donâ€™t understand how I can manage data in MDC.</p>\n<p>Can you tell me how to correctly add custom fields to the correlation?\nHow to fill out Mdc when using a micrometer.\nHow to transfer everything from the parent thread to a new one, and clean it up after completion?</p>\n<p>Here's my example:</p>\n<ol>\n<li>Set up a logging pattern:</li>\n</ol>\n<pre><code>logging:\n  pattern:\n    console: &quot;%clr(%d){faint} %clr(%5p) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%X{testRemoteBaggage}-%X{testLocalBaggage}]){magenta} %clr([%40.40t]){faint} %clr(${LOG_CORRELATION_PATTERN:-}){faint}%clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n%wEx&quot;\n</code></pre>\n<ol start=\"2\">\n<li>Configured adding custom fields to the correlation (the first field should be sent with requests, the second should not):</li>\n</ol>\n<pre><code>management:\n  tracing:\n    sampling:\n      probability: 1.0\n    baggage:\n      correlation:\n        fields: testRemoteBaggage, testLocalBaggage\n      remote-fields: testRemoteBaggage\n      local-fields: testLocalBaggage\n</code></pre>\n<ol start=\"3\">\n<li>Configured a task executor to work asynchronously with virtual threads:</li>\n</ol>\n<pre><code>spring:\n  threads:\n    virtual:\n      enabled: true\n</code></pre>\n<pre><code>@EnableAsync\n@Configuration(proxyBeanMethods = false)\npublic class DummyJsonTracingConfiguration {\n\n    @Bean\n    public AsyncTaskExecutor applicationTaskExecutor() {\n        return new TaskExecutorAdapter(Executors.newVirtualThreadPerTaskExecutor());\n    }\n\n    @Bean\n    public TomcatProtocolHandlerCustomizer&lt;?&gt; protocolHandlerVirtualThreadExecutorCustomizer() {\n        return protocolHandler -&gt; {\n            protocolHandler.setExecutor(Executors.newVirtualThreadPerTaskExecutor());\n        };\n    }\n}\n</code></pre>\n<ol start=\"4\">\n<li>Added a filter that adds custom fields to the correlation:</li>\n</ol>\n<pre><code>@Component\n@Slf4j\n@RequiredArgsConstructor\npublic class AddBaggageFilter extends OncePerRequestFilter implements OrderedFilter {\n    private static final String fieldRemote = &quot;testRemoteBaggage&quot;;\n    private static final String fieldLocal = &quot;testLocalBaggage&quot;;\n\n    private final Tracer tracer;\n\n    @Override\n    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {\n\n        String baggagefieldRemote = request.getHeader(fieldRemote);\n        if (StringUtils.isEmpty(baggagefieldRemote)) {\n            baggagefieldRemote = &quot;autoValue&quot;+fieldRemote;\n        }\n        String baggagefieldLocal = request.getHeader(fieldLocal);\n        if (StringUtils.isEmpty(baggagefieldLocal)) {\n            baggagefieldLocal = &quot;autoValue&quot;+fieldLocal;\n        }\n        log.warn(&quot;baggagefieldRemote value : [{}]&quot;, baggagefieldRemote);\n        log.warn(&quot;baggagefieldLocal value : [{}]&quot;, baggagefieldLocal);\n\n        try (BaggageInScope baggageRemote = tracer.createBaggageInScope(fieldRemote, baggagefieldRemote);\n             BaggageInScope baggageLocal = tracer.createBaggageInScope(fieldLocal, baggagefieldLocal)) {\n            log.warn(&quot;baggagefieldRemote was created!&quot;);\n            filterChain.doFilter(request, response);\n        }\n    }\n\n    @Override\n    public int getOrder() {\n        return Ordered.HIGHEST_PRECEDENCE + 2;\n    }\n}\n</code></pre>\n<p>But in the logs I see that the correlation is displayed only for the main thread.</p>\n<pre><code>2024-07-14 14:05:28,274  WARN 23716 --- [test1-] [                        tomcat-handler-1] [6693bf08c4ecb0e29507c9dbc43570fe-9507c9dbc43570fe] b.g.t.rest.AddBaggageFilter              : baggagefieldRemote value : [test1]\n2024-07-14 14:05:28,275  WARN 23716 --- [test1-] [                        tomcat-handler-1] [6693bf08c4ecb0e29507c9dbc43570fe-9507c9dbc43570fe] b.g.t.rest.AddBaggageFilter              : baggagefieldLocal value : [autoValuetestLocalBaggage]\n2024-07-14 14:05:28,276  WARN 23716 --- [test1-autoValuetestLocalBaggage] [                        tomcat-handler-1] [6693bf08c4ecb0e29507c9dbc43570fe-9507c9dbc43570fe] b.g.t.rest.AddBaggageFilter              : baggagefieldRemote was created!\n2024-07-14 14:05:28,279 DEBUG 23716 --- [test1-autoValuetestLocalBaggage] [                        tomcat-handler-1] [6693bf08c4ecb0e29507c9dbc43570fe-9507c9dbc43570fe] o.s.web.servlet.DispatcherServlet        : POST &quot;/categoryInfo&quot;, parameters={}\n2024-07-14 14:05:28,285 DEBUG 23716 --- [test1-autoValuetestLocalBaggage] [                        tomcat-handler-1] [6693bf08c4ecb0e29507c9dbc43570fe-9507c9dbc43570fe] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped to by.gvu.testtracingrestclient.controller.SimpleController#getListProducts()\n2024-07-14 14:05:29,128 DEBUG 23716 --- [test1-autoValuetestLocalBaggage] [                        tomcat-handler-1] [6693bf08c4ecb0e29507c9dbc43570fe-9507c9dbc43570fe] o.s.web.client.DefaultRestClient         : Reading to [java.util.List&lt;java.lang.String&gt;]\n2024-07-14 14:05:29,377 DEBUG 23716 --- [-] [        ForkJoinPool.commonPool-worker-9] [                                                 ] o.s.web.client.DefaultRestClient         : Reading to [java.util.List&lt;by.gvu.testtracingrestclient.model.Product&gt;]\n2024-07-14 14:05:29,689 DEBUG 23716 --- [-] [       ForkJoinPool.commonPool-worker-10] [                                                 ] o.s.web.client.DefaultRestClient         : Reading to [java.util.List&lt;by.gvu.testtracingrestclient.model.Product&gt;]\n2024-07-14 14:05:29,734 DEBUG 23716 --- [-] [        ForkJoinPool.commonPool-worker-4] [                                                 ] o.s.web.client.DefaultRestClient         : Reading to [java.util.List&lt;by.gvu.testtracingrestclient.model.Product&gt;]\n2024-07-14 14:05:29,734 DEBUG 23716 --- [-] [       ForkJoinPool.commonPool-worker-12] [                                                 ] o.s.web.client.DefaultRestClient         : Reading to [java.util.List&lt;by.gvu.testtracingrestclient.model.Product&gt;]\n</code></pre>\n<p><strong>UPDATED</strong></p>\n<p>The problem was not related to virtual threads.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}