{
  "question": {
    "tags": [
      "java",
      "http",
      "java-17",
      "wiremock"
    ],
    "owner": {
      "account_id": 5254523,
      "reputation": 1004,
      "user_id": 4197768,
      "user_type": "registered",
      "accept_rate": 40,
      "profile_image": "https://lh3.googleusercontent.com/-gJbxzIpIppY/AAAAAAAAAAI/AAAAAAAAABY/TjCUq6QnbF4/s256-rj/photo.jpg",
      "display_name": "Mark Sch&#228;fer",
      "link": "https://stackoverflow.com/users/4197768/mark-sch%c3%a4fer"
    },
    "is_answered": true,
    "view_count": 2192,
    "answer_count": 1,
    "score": 4,
    "last_activity_date": 1740588382,
    "creation_date": 1704878119,
    "question_id": 77792144,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/77792144/response-stream-cancelled-in-wiremock-test",
    "title": "Response Stream cancelled in Wiremock-Test",
    "body": "<p>The following test with Wiremock throws an exception when sending an HTTP POST request to a Wiremock server.</p>\n<pre class=\"lang-java prettyprint-override\"><code>import com.github.tomakehurst.wiremock.WireMockServer;\nimport com.github.tomakehurst.wiremock.client.WireMock;\nimport com.github.tomakehurst.wiremock.common.ConsoleNotifier;\nimport com.github.tomakehurst.wiremock.core.WireMockConfiguration;\nimport org.junit.jupiter.api.Test;\n\nimport java.io.ByteArrayInputStream;\nimport java.io.IOException;\nimport java.net.URI;\nimport java.net.http.HttpClient;\nimport java.net.http.HttpRequest;\nimport java.net.http.HttpResponse;\nimport java.nio.charset.StandardCharsets;\n\nimport static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\nimport static com.github.tomakehurst.wiremock.client.WireMock.post;\nimport static com.github.tomakehurst.wiremock.client.WireMock.urlEqualTo;\n\npublic class ClientTest {\n\n    private static final int PORT = 27970;\n\n    @Test\n    public void myTest() throws IOException, InterruptedException {\n        WireMockServer server = new WireMockServer(WireMockConfiguration.options().port(PORT).notifier(new ConsoleNotifier(true)));\n        server.start();\n        WireMock mock = WireMock.create().host(&quot;localhost&quot;).port(PORT).build();\n        WireMock.configureFor(mock);\n\n        WireMock.stubFor(\n                post(urlEqualTo(&quot;/foo&quot;))\n                        .willReturn(aResponse()\n                                .withStatus(201)\n                                .withBody(&quot;bar&quot;)));\n\n        HttpRequest httpRequest = HttpRequest.newBuilder()\n                .uri(URI.create(&quot;http://localhost:&quot; + PORT + &quot;/foo&quot;))\n//                .version(HttpClient.Version.HTTP_1_1)\n//                .POST(HttpRequest.BodyPublishers.ofString(&quot;stuff&quot;))\n                .POST(HttpRequest.BodyPublishers.ofInputStream(() -&gt; new ByteArrayInputStream(&quot;stuff&quot;.getBytes(StandardCharsets.UTF_8))))\n                .build();\n\n        // Here there be Exceptions\n        HttpResponse&lt;String&gt; httpResponse = HttpClient.newHttpClient().send(httpRequest, HttpResponse.BodyHandlers.ofString());\n\n        assert httpResponse.body().equals(&quot;bar&quot;);\n    }\n}\n</code></pre>\n<p>The following exceptions occurs:</p>\n<pre><code>java.io.IOException: Received RST_STREAM: Stream cancelled\n\n    at java.net.http/jdk.internal.net.http.HttpClientImpl.send(HttpClientImpl.java:586)\n    at java.net.http/jdk.internal.net.http.HttpClientFacade.send(HttpClientFacade.java:123)\n    at ContentStoreConnectorImplTest.myTest(ContentStoreConnectorImplTest.java:44)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:568)\n    at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\n    at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\nCaused by: java.io.IOException: Received RST_STREAM: Stream cancelled\n    at java.net.http/jdk.internal.net.http.Stream.handleReset(Stream.java:534)\n    at java.net.http/jdk.internal.net.http.Stream.incoming_reset(Stream.java:505)\n    at java.net.http/jdk.internal.net.http.Stream.otherFrame(Stream.java:452)\n    at java.net.http/jdk.internal.net.http.Stream.incoming(Stream.java:445)\n    at java.net.http/jdk.internal.net.http.Http2Connection.processFrame(Http2Connection.java:812)\n    at java.net.http/jdk.internal.net.http.frame.FramesDecoder.decode(FramesDecoder.java:155)\n    at java.net.http/jdk.internal.net.http.Http2Connection$FramesController.processReceivedData(Http2Connection.java:232)\n    at java.net.http/jdk.internal.net.http.Http2Connection.asyncReceive(Http2Connection.java:674)\n    at java.net.http/jdk.internal.net.http.Http2Connection$Http2TubeSubscriber.processQueue(Http2Connection.java:1310)\n    at java.net.http/jdk.internal.net.http.common.SequentialScheduler$LockingRestartableTask.run(SequentialScheduler.java:205)\n    at java.net.http/jdk.internal.net.http.common.SequentialScheduler$CompleteRestartableTask.run(SequentialScheduler.java:149)\n    at java.net.http/jdk.internal.net.http.common.SequentialScheduler$SchedulableTask.run(SequentialScheduler.java:230)\n    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\n    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\n    at java.base/java.lang.Thread.run(Thread.java:833)\n</code></pre>\n<p>If either HTTP/1.1 or a String BodyPublisher or a GET request is used everything works, see commented lines.</p>\n<p>After some debugging we found no solution or obvious problem. We are also not sure if this is a Wiremock problem or a problem with the Java-HTTP-Client.</p>\n<p>When we dump the request, the body looks a bit strange though with some additional lines:</p>\n<pre><code>POST /foo HTTP/1.1\nConnection: Upgrade, HTTP2-Settings\nHost: localhost:2727\nHTTP2-Settings: AAEAAEAAAAIAAAABAAMAAABkAAQBAAAAAAUAAEAA\nTransfer-encoding: chunked\nUpgrade: h2c\nUser-Agent: Java-http-client/17.0.6\n\n5\nstuff\n0\n\n</code></pre>\n<p>These lines disappear when using the String-Publisher. They do not disappear when using HTTP/1.1 but then it works regardless.</p>\n<p>The dependencies as <code>pom.xml</code>:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;\n         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n\n    &lt;groupId&gt;org.example&lt;/groupId&gt;\n    &lt;artifactId&gt;wiremockhttp2&lt;/artifactId&gt;\n    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;\n\n    &lt;properties&gt;\n        &lt;maven.compiler.source&gt;17&lt;/maven.compiler.source&gt;\n        &lt;maven.compiler.target&gt;17&lt;/maven.compiler.target&gt;\n        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;\n    &lt;/properties&gt;\n\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.wiremock&lt;/groupId&gt;\n            &lt;artifactId&gt;wiremock&lt;/artifactId&gt;\n            &lt;version&gt;3.3.1&lt;/version&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;\n            &lt;artifactId&gt;junit-jupiter-api&lt;/artifactId&gt;\n            &lt;version&gt;5.10.1&lt;/version&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n\n    &lt;/dependencies&gt;\n&lt;/project&gt;\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}