{
  "question": {
    "tags": [
      "java",
      "spring-boot",
      "hibernate",
      "jpa",
      "h2"
    ],
    "owner": {
      "account_id": 23782627,
      "reputation": 65,
      "user_id": 17795116,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/8b9c03927a8f42b9acf11a0e9c0ef33e?s=256&d=identicon&r=PG",
      "display_name": "lordlaurent",
      "link": "https://stackoverflow.com/users/17795116/lordlaurent"
    },
    "is_answered": true,
    "view_count": 389,
    "accepted_answer_id": 78914069,
    "answer_count": 2,
    "score": 0,
    "last_activity_date": 1724670522,
    "creation_date": 1724145909,
    "last_edit_date": 1724155788,
    "question_id": 78891613,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78891613/referential-integrity-constraint-violation-error-in-spring-boot-using-h2-databas",
    "title": "Referential integrity constraint violation error in Spring Boot using H2 database",
    "body": "<p>I have a problem with testing entities in my simple Spring Boot library api.</p>\n<p>In this test I even manually remove every book from titles to ensure it doesn't violate anything, but the problem still occurs in line <code>entityManager.remove(title);</code></p>\n<pre><code>    @Test\n    @Transactional\n    void titleAssociationTest() {\n        title.getBooks().forEach(book -&gt; {\n            if (book.getLoan() != null) {\n                entityManager.remove(book.getLoan());\n            }\n            entityManager.remove(book);\n        });\n        title.getBooks().clear();\n\n        entityManager.flush();\n\n        entityManager.remove(title);\n        entityManager.flush();\n\n        Title foundTitle = entityManager.find(Title.class, title.getId());\n        assertThat(foundTitle).isNull();\n    }\n</code></pre>\n<p>I receive this error message:</p>\n<pre><code>Referential integrity constraint violation: &quot;FK6I4NJ1U4KX1J2YOVIIM8HT8S9: PUBLIC.BOOKS FOREIGN KEY(TITLE_ID) REFERENCES PUBLIC.TITLES(ID) (CAST(1 AS BIGINT))&quot;; SQL statement: \ndelete from titles where id=? [23503-214]] [delete from titles where id=?]\n</code></pre>\n<p>Here is my book entity</p>\n<pre><code>package com.projects.library.model;\n\nimport com.projects.library.enums.BookStatus;\nimport jakarta.persistence.*;\nimport lombok.AllArgsConstructor;\nimport lombok.Getter;\nimport lombok.NoArgsConstructor;\nimport lombok.Setter;\n\n@NoArgsConstructor\n@AllArgsConstructor\n@Setter\n@Getter\n@Entity\n@Table(name = &quot;books&quot;)\npublic class Book {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private long id;\n\n    @ManyToOne\n    @JoinColumn(name = &quot;title_id&quot;, nullable = false)\n    private Title title;\n\n    @Enumerated(EnumType.STRING)\n    @Column(name = &quot;status&quot;, nullable = false)\n    private BookStatus status;\n\n    @OneToOne(mappedBy = &quot;book&quot;, cascade = CascadeType.ALL, orphanRemoval = true)\n    private Loan loan;\n\n    public Book(Title title, BookStatus status) {\n        this.title = title;\n        this.status = status;\n    }\n}\n</code></pre>\n<p>And here is title entity, where I use Cascade.ALL, so when a title is removed all books should be removed as well.</p>\n<pre><code>package com.projects.library.model;\n\nimport jakarta.persistence.*;\nimport lombok.AllArgsConstructor;\nimport lombok.Getter;\nimport lombok.NoArgsConstructor;\nimport lombok.Setter;\n\nimport java.util.HashSet;\nimport java.util.Set;\n\n@NoArgsConstructor\n@AllArgsConstructor\n@Setter\n@Getter\n@Entity\n@Table(name = &quot;titles&quot;)\npublic class Title {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private long id;\n\n    @Column(name = &quot;`title`&quot;, nullable = false, unique = true)\n    private String title;\n\n    @Column(name = &quot;author&quot;, nullable = false)\n    private String author;\n\n    @Column(name = &quot;`year`&quot;, nullable = false)\n    private int year;\n\n    @OneToMany(mappedBy = &quot;title&quot;, cascade = CascadeType.ALL, orphanRemoval = true)\n    private Set&lt;Book&gt; books = new HashSet&lt;&gt;();\n\n    public Title(String title, String author, int year) {\n        this.title = title;\n        this.author = author;\n        this.year = year;\n    }\n}\n</code></pre>\n<p>For testing i use hibernate's H2 database with this testing profile in <code>application-test.properties</code></p>\n<pre><code>spring.datasource.url=jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE\nspring.datasource.driver-class-name=org.h2.Driver\nspring.datasource.username=sa\nspring.datasource.password=password\n\nspring.jpa.database-platform=org.hibernate.dialect.H2Dialect\nspring.jpa.hibernate.ddl-auto=update\nspring.jpa.show-sql=true\nspring.jpa.properties.hibernate.format_sql=true\nspring.jpa.properties.hibernate.dialect=org.hibernate.dialect.H2Dialect\n</code></pre>\n<p>Here are the full SQL logs from hibernate:</p>\n<pre><code>    create table books (\n        id bigint generated by default as identity,\n        status varchar(255) not null check (status in ('AVAILABLE','RENTED')),\n        title_id bigint not null,\n        primary key (id)\n    )\nHibernate: \n    create table books (\n        id bigint generated by default as identity,\n        status varchar(255) not null check (status in ('AVAILABLE','RENTED')),\n        title_id bigint not null,\n        primary key (id)\n    )\n2024-08-20T14:07:28.365+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    create table loans (\n        id bigint generated by default as identity,\n        borrow_date timestamp(6) not null,\n        return_date timestamp(6),\n        book_id bigint not null,\n        user_id bigint not null,\n        primary key (id)\n    )\nHibernate: \n    create table loans (\n        id bigint generated by default as identity,\n        borrow_date timestamp(6) not null,\n        return_date timestamp(6),\n        book_id bigint not null,\n        user_id bigint not null,\n        primary key (id)\n    )\n2024-08-20T14:07:28.371+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    create table titles (\n        id bigint generated by default as identity,\n        author varchar(255) not null,\n        &quot;title&quot; varchar(255) not null,\n        &quot;year&quot; integer not null,\n        primary key (id)\n    )\nHibernate: \n    create table titles (\n        id bigint generated by default as identity,\n        author varchar(255) not null,\n        &quot;title&quot; varchar(255) not null,\n        &quot;year&quot; integer not null,\n        primary key (id)\n    )\n2024-08-20T14:07:28.371+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    create table users (\n        id bigint generated by default as identity,\n        account_creation_date timestamp(6) not null,\n        first_name varchar(255) not null,\n        last_name varchar(255) not null,\n        primary key (id)\n    )\nHibernate: \n    create table users (\n        id bigint generated by default as identity,\n        account_creation_date timestamp(6) not null,\n        first_name varchar(255) not null,\n        last_name varchar(255) not null,\n        primary key (id)\n    )\n2024-08-20T14:07:28.379+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    alter table if exists loans \n       drop constraint if exists UK_7t9p42ubdqp606tp4whc233lt\nHibernate: \n    alter table if exists loans \n       drop constraint if exists UK_7t9p42ubdqp606tp4whc233lt\n2024-08-20T14:07:28.379+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    alter table if exists loans \n       add constraint UK_7t9p42ubdqp606tp4whc233lt unique (book_id)\nHibernate: \n    alter table if exists loans \n       add constraint UK_7t9p42ubdqp606tp4whc233lt unique (book_id)\n2024-08-20T14:07:28.379+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    alter table if exists titles \n       drop constraint if exists UK_teg25db4y95gscy7bdb9jqmes\nHibernate: \n    alter table if exists titles \n       drop constraint if exists UK_teg25db4y95gscy7bdb9jqmes\n2024-08-20T14:07:28.379+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    alter table if exists titles \n       add constraint UK_teg25db4y95gscy7bdb9jqmes unique (&quot;title&quot;)\nHibernate: \n    alter table if exists titles \n       add constraint UK_teg25db4y95gscy7bdb9jqmes unique (&quot;title&quot;)\n2024-08-20T14:07:28.379+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    alter table if exists books \n       add constraint FK6i4nj1u4kx1j2yoviim8ht8s9 \n       foreign key (title_id) \n       references titles\nHibernate: \n    alter table if exists books \n       add constraint FK6i4nj1u4kx1j2yoviim8ht8s9 \n       foreign key (title_id) \n       references titles\n2024-08-20T14:07:28.389+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    alter table if exists loans \n       add constraint FKokwvlrv6o4i4h3le3bwhe6kie \n       foreign key (book_id) \n       references books\nHibernate: \n    alter table if exists loans \n       add constraint FKokwvlrv6o4i4h3le3bwhe6kie \n       foreign key (book_id) \n       references books\n2024-08-20T14:07:28.389+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    alter table if exists loans \n       add constraint FK6xxlcjc0rqtn5nq28vjnx5t9d \n       foreign key (user_id) \n       references users\nHibernate: \n    alter table if exists loans \n       add constraint FK6xxlcjc0rqtn5nq28vjnx5t9d \n       foreign key (user_id) \n       references users\n2024-08-20T14:07:28.389+02:00  INFO 12728 --- [    Test worker] j.LocalContainerEntityManagerFactoryBean : Initialized JPA EntityManagerFactory for persistence unit 'default'\n2024-08-20T14:07:28.780+02:00  INFO 12728 --- [    Test worker] o.s.d.j.r.query.QueryEnhancerFactory     : Hibernate is in classpath; If applicable, HQL parser will be used.\n2024-08-20T14:07:29.384+02:00  INFO 12728 --- [    Test worker] c.projects.library.model.BookTestSuite   : Started BookTestSuite in 3.519 seconds (process running for 4.796)\nWARNING: A Java agent has been loaded dynamically (C:\\Users\\Pawe?\\.gradle\\caches\\modules-2\\files-2.1\\net.bytebuddy\\byte-buddy-agent\\1.14.13\\979ce25f7d3096a2e82214ba7dc972a05ce7a171\\byte-buddy-agent-1.14.13.ja)\nWARNING: If a serviceability tool is in use, please run with -XX:+EnableDynamicAgentLoading to hide this warning\nWARNING: If a serviceability tool is not in use, please run with -Djdk.instrument.traceUsage for more information\nWARNING: Dynamic loading of agents will be disallowed by default in a future release\n2024-08-20T14:07:29.884+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    insert \n    into\n        titles\n        (author,&quot;title&quot;,&quot;year&quot;,id) \n    values\n        (?,?,?,default)\nHibernate: \n    insert \n    into\n        titles\n        (author,&quot;title&quot;,&quot;year&quot;,id) \n    values\n        (?,?,?,default)\n2024-08-20T14:07:29.899+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    insert \n    into\n        users\n        (account_creation_date,first_name,last_name,id) \n    values\n        (?,?,?,default)\nHibernate: \n    insert \n    into\n        users\n        (account_creation_date,first_name,last_name,id) \n    values\n        (?,?,?,default)\n2024-08-20T14:07:29.903+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    insert \n    into\n        books\n        (status,title_id,id) \n    values\n        (?,?,default)\nHibernate: \n    insert \n    into\n        books\n        (status,title_id,id) \n    values\n        (?,?,default)\n2024-08-20T14:07:29.906+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    insert \n    into\n        loans\n        (book_id,borrow_date,return_date,user_id,id) \n    values\n        (?,?,?,?,default)\nHibernate: \n    insert \n    into\n        loans\n        (book_id,borrow_date,return_date,user_id,id) \n    values\n        (?,?,?,?,default)\n2024-08-20T14:07:29.924+02:00 DEBUG 12728 --- [    Test worker] org.hibernate.SQL                        : \n    delete \n    from\n        titles \n    where\n        id=?\nHibernate: \n    delete \n    from\n        titles \n    where\n        id=?\n2024-08-20T14:07:29.931+02:00  WARN 12728 --- [    Test worker] o.h.engine.jdbc.spi.SqlExceptionHelper   : SQL Error: 23503, SQLState: 23503\n2024-08-20T14:07:29.931+02:00 ERROR 12728 --- [    Test worker] o.h.engine.jdbc.spi.SqlExceptionHelper   : Naruszenie więzów integralności: &quot;FK6I4NJ1U4KX1J2YOVIIM8HT8S9: PUBLIC.BOOKS FOREIGN KEY(TITLE_ID) REFERENCES PUBLIC.TITLES(ID) (CAST(1 AS BIGINT))&quot;\nReferential integrity constraint violation: &quot;FK6I4NJ1U4KX1J2YOVIIM8HT8S9: PUBLIC.BOOKS FOREIGN KEY(TITLE_ID) REFERENCES PUBLIC.TITLES(ID) (CAST(1 AS BIGINT))&quot;; SQL statement:\ndelete from titles where id=? [23503-214]\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}