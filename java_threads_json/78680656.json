{
  "question": {
    "tags": [
      "java",
      "gatling",
      "gatling-java"
    ],
    "owner": {
      "account_id": 8915876,
      "reputation": 4246,
      "user_id": 6654475,
      "user_type": "registered",
      "accept_rate": 100,
      "profile_image": "https://i.sstatic.net/360Vn.png?s=256",
      "display_name": "Francislainy Campos",
      "link": "https://stackoverflow.com/users/6654475/francislainy-campos"
    },
    "is_answered": true,
    "view_count": 374,
    "accepted_answer_id": 78680960,
    "answer_count": 1,
    "score": -1,
    "last_activity_date": 1725898230,
    "creation_date": 1719548899,
    "last_edit_date": 1725898230,
    "question_id": 78680656,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78680656/gatling-java-request-to-be-called-only-once-to-retrieve-login-information-for-ot",
    "title": "Gatling Java request to be called only once to retrieve login information for other requests that are executed multiple times",
    "body": "<p>I want my login to be executed only once as it's managed by a third party service, so after the token is retrieved once for the whole duration of the tests, it should not execute again. That token should be injected as a cookie header for the other api calls, not changing regardless of how many calls are done to those other requests within the same running of the tests. Below is what I have, but maybe due to the way Gatling manages sessions, it's not working and the login is being executed as many times as the other api calls.</p>\n<pre><code>import io.gatling.javaapi.core.ScenarioBuilder;\nimport io.gatling.javaapi.core.Simulation;\nimport io.gatling.javaapi.http.HttpProtocolBuilder;\nimport lombok.extern.slf4j.Slf4j;\n\nimport java.util.concurrent.atomic.AtomicReference;\n\nimport static io.gatling.javaapi.core.CoreDsl.*;\nimport static io.gatling.javaapi.http.HttpDsl.*;\n\n@Slf4j\npublic class MySimulation extends Simulation {\n\n    private static final String BASE_URL_DEV = &quot;myurl&quot;;\n    private static final String BASE_URL_STAGE = &quot;myotherurl&quot;;\n    private static final String ENV = System.getProperty(&quot;env&quot;);\n    private static final String BASE_URL = ENV.equals(&quot;dev&quot;) ? BASE_URL_DEV : BASE_URL_STAGE;\n    private static final String API_PATH = ENV.equals(&quot;dev&quot;) ? &quot;&quot; : &quot;mypath&quot;;\n\n    private static final AtomicReference&lt;String&gt; authCookieRef = new AtomicReference&lt;&gt;();\n\n    private final HttpProtocolBuilder httpProtocol = http\n            .disableFollowRedirect()\n            .baseUrl(BASE_URL)\n            .acceptHeader(&quot;application/json&quot;);\n\n    private final ScenarioBuilder scn = scenario(&quot;MyScenario&quot;)\n            .exec(session -&gt; {\n                if (authCookieRef.get() != null) {\n                    System.out.println(&quot;User does not need cookie&quot;);\n                    return session.set(&quot;authCookie&quot;, authCookieRef.get());\n                }\n                else {\n                    System.out.println(&quot;User needs cookie&quot;);\n                }\n                return session.set(&quot;needLogin&quot;, true);\n            })\n            .doIf(session -&gt; session.contains(&quot;needLogin&quot;)).then(\n                    exec(http(&quot;Login&quot;)\n                            .post(&quot;/login&quot;)\n                            .header(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;)\n                            .formParam(&quot;username&quot;, &quot;username&quot;)\n                            .formParam(&quot;password&quot;, &quot;password&quot;)\n                            .formParam(&quot;login-form-type&quot;, &quot;token&quot;)\n                            .check(status().is(302), header(&quot;Set-Cookie&quot;).saveAs(&quot;authCookie&quot;)))\n                            .exec(session -&gt; {\n                                String authCookie = session.getString(&quot;authCookie&quot;).split(&quot;;&quot;)[0];\n                                authCookieRef.set(&quot;auth_token=&quot; + authCookie);\n                                return session.set(&quot;authCookie&quot;, authCookieRef.get());\n                            })\n            )\n            .exec(http(&quot;LastRefreshDate&quot;)\n                    .get(API_PATH + &quot;/last-refresh-date&quot;)\n                    .header(&quot;cookie&quot;, &quot;#{authCookie}&quot;)\n                    .check(status().is(200))\n            );\n\n    {\n        setUp(\n                scn.injectOpen(atOnceUsers(2))\n        ).protocols(httpProtocol);\n    }\n}\n</code></pre>\n<p>Thank you.</p>\n<p><em>Update</em></p>\n<p>Attempting to split the simulation into two different scenarios and doing my best guess on the Gatling syntax for retrieving the token based on my understanding from their docs.</p>\n<pre><code>package com.mycompany.performancetests;\n\nimport io.gatling.javaapi.core.ScenarioBuilder;\nimport io.gatling.javaapi.core.Simulation;\nimport io.gatling.javaapi.http.HttpProtocolBuilder;\nimport lombok.extern.slf4j.Slf4j;\n\nimport static io.gatling.javaapi.core.CoreDsl.atOnceUsers;\nimport static io.gatling.javaapi.core.CoreDsl.scenario;\nimport static io.gatling.javaapi.http.HttpDsl.*;\n\n@Slf4j\npublic class MySimulation extends Simulation {\n\n    private static final String BASE_URL_DEV = &quot;myurl&quot;;\n    private static final String BASE_URL_STAGE = &quot;myanotherurl&quot;;\n    private static final String ENV = System.getProperty(&quot;env&quot;, &quot;dev&quot;);\n    private static final String BASE_URL = ENV.equals(&quot;dev&quot;) ? BASE_URL_DEV : BASE_URL_STAGE;\n    private static final String API_PATH = ENV.equals(&quot;dev&quot;) ? &quot;&quot; : &quot;mypath&quot;;\n\n    private final HttpProtocolBuilder httpProtocol = http\n            .disableFollowRedirect()\n            .baseUrl(BASE_URL)\n            .acceptHeader(&quot;application/json&quot;);\n\n    private final ScenarioBuilder loginScn = scenario(&quot;LoginScenario&quot;)\n            .exec(http(&quot;Login&quot;)\n                            .post(&quot;/login&quot;)\n                            .header(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;)\n                            .formParam(&quot;username&quot;, &quot;username&quot;)\n                            .formParam(&quot;password&quot;, &quot;password&quot;)\n                            .formParam(&quot;login-form-type&quot;, &quot;token&quot;)\n                            .check(status().is(302))\n                    //      .check(mycompany(&quot;Set-Cookie&quot;).saveAs(&quot;auth_token&quot;))\n            )\n            .exec(getCookieValue(CookieKey(&quot;auth_token&quot;)));\n\n    private final ScenarioBuilder mainScn = scenario(&quot;MainScenario&quot;)\n            .exec(addCookie(Cookie(&quot;auth_token&quot;, &quot;value&quot;)))\n            .exec(http(&quot;LastRefreshDate&quot;)\n                    .get(API_PATH + &quot;/last-refresh-date&quot;)\n                    .check(status().is(200))\n            )\n            .exec(addCookie(Cookie(&quot;auth_token&quot;, &quot;#{auth_token}&quot;)))\n            .exec(http(&quot;Notifications&quot;)\n                    .get(API_PATH + &quot;/notifications&quot;)\n                    .check(status().is(200))\n            );\n\n    {\n        setUp(\n                loginScn.injectOpen(atOnceUsers(1)).andThen(\n                        mainScn.injectOpen(atOnceUsers(2))\n                )\n        ).protocols(httpProtocol);\n    }\n}\n</code></pre>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}