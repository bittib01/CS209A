{
  "question": {
    "tags": [
      "java",
      "android",
      "textview",
      "spannablestringbuilder"
    ],
    "owner": {
      "account_id": 34914302,
      "reputation": 11,
      "user_id": 26858678,
      "user_type": "registered",
      "profile_image": "https://i.sstatic.net/Yjsqs23x.jpg?s=256",
      "display_name": "Aerin",
      "link": "https://stackoverflow.com/users/26858678/aerin"
    },
    "is_answered": false,
    "view_count": 80,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1724804380,
    "creation_date": 1724157634,
    "question_id": 78892504,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78892504/android-javaarrayindeexoutofbounds-error-was-reported-while-setting-text-with-a",
    "title": "Android/Java:ArrayIndeexOutOfBounds error was reported while setting text with a non-null SpannableStringBuuilder parameter",
    "body": "<h1>How I encountered this error</h1>\n<p>I generated a SpannableStringBuilder object by a series of options firstly,then I stored the object and read it in another method,trying to set textview's text with that,however an ArrayIndexOutOfBounds error was reported at that time.</p>\n<h1>My conjecture</h1>\n<p>I think the most possible reason is that the object isn't serialized correctly while storing,but I don't know how to solve it.</p>\n<h1>Difficulties</h1>\n<p>I can't understand the error log fully,because I can't find where the array,which's size is 0,is.</p>\n<h1>Desired result</h1>\n<p>The content of the object should be shown onto the screen</p>\n<h1>Error details</h1>\n<h2>Error log</h2>\n<blockquote>\n<p>2024-08-20 20:22:38.811 23328-23328 AndroidRuntime          pers.beapoe.fortest                  E  FATAL EXCEPTION: main\nProcess: pers.beapoe.fortest, PID: 23328\njava.lang.IllegalStateException: Could not execute method for android:onClick\nat androidx.appcompat.app.AppCompatViewInflater$DeclaredOnClickListener.onClick(AppCompatViewInflater.java:473)\nat android.view.View.performClick(View.java:7188)\nat com.google.android.material.button.MaterialButton.performClick(MaterialButton.java:1213)\nat android.view.View.performClickInternal(View.java:7165)\nat android.view.View.access$3500(View.java:814)\nat android.view.View$PerformClick.run(View.java:27657)\nat android.os.Handler.handleCallback(Handler.java:883)\nat android.os.Handler.dispatchMessage(Handler.java:100)\nat android.os.Looper.loop(Looper.java:230)\nat android.app.ActivityThread.main(ActivityThread.java:7887)\nat java.lang.reflect.Method.invoke(Native Method)\nat com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:526)\nat com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1034)\nCaused by: java.lang.reflect.InvocationTargetException\nat java.lang.reflect.Method.invoke(Native Method)\nat androidx.appcompat.app.AppCompatViewInflater$DeclaredOnClickListener.onClick(AppCompatViewInflater.java:468)\nat android.view.View.performClick(View.java:7188) \nat com.google.android.material.button.MaterialButton.performClick(MaterialButton.java:1213) \nat android.view.View.performClickInternal(View.java:7165) \nat android.view.View.access$3500(View.java:814) \nat android.view.View$PerformClick.run(View.java:27657) \nat android.os.Handler.handleCallback(Handler.java:883) \nat android.os.Handler.dispatchMessage(Handler.java:100) \nat android.os.Looper.loop(Looper.java:230) \nat android.app.ActivityThread.main(ActivityThread.java:7887) \nat java.lang.reflect.Method.invoke(Native Method) \nat com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:526) \nat com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1034) \nCaused by: java.lang.ArrayIndexOutOfBoundsException: length=0; index=0\nat android.text.SpannableStringBuilder.getSpansRec(SpannableStringBuilder.java:976)\nat android.text.SpannableStringBuilder.getSpans(SpannableStringBuilder.java:880)\nat android.text.SpannableStringBuilder.getSpans(SpannableStringBuilder.java:849)\nat android.text.SpannableStringInternal.copySpans(SpannableStringInternal.java:69)\nat android.text.SpannableStringInternal.&lt;init&gt;(SpannableStringInternal.java:45)\nat android.text.SpannedString.&lt;init&gt;(SpannedString.java:35)\nat android.text.SpannedString.&lt;init&gt;(SpannedString.java:44)\nat android.text.TextUtils.stringOrSpannedString(TextUtils.java:531)\nat android.widget.TextView.setText(TextView.java:6272)\nat android.widget.TextView.setText(TextView.java:6174)\nat android.widget.TextView.setText(TextView.java:6126)\nat pers.beapoe.fortest.main.onClick(main.java:169)\nat java.lang.reflect.Method.invoke(Native Method) \nat androidx.appcompat.app.AppCompatViewInflater$DeclaredOnClickListener.onClick(AppCompatViewInflater.java:468) \nat android.view.View.performClick(View.java:7188) \nat com.google.android.material.button.MaterialButton.performClick(MaterialButton.java:1213) \nat android.view.View.performClickInternal(View.java:7165) \nat android.view.View.access$3500(View.java:814) \nat android.view.View$PerformClick.run(View.java:27657) \nat android.os.Handler.handleCallback(Handler.java:883) \nat android.os.Handler.dispatchMessage(Handler.java:100) \nat android.os.Looper.loop(Looper.java:230) \nat android.app.ActivityThread.main(ActivityThread.java:7887) \nat java.lang.reflect.Method.invoke(Native Method) \nat com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:526) \nat com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1034)</p>\n</blockquote>\n<h2>Step to reproduce</h2>\n<ol>\n<li>Create an Android application</li>\n<li>Add dependency &quot;gson&quot; into this app</li>\n<li>Replace the activity and xml file's code with the code in next title(Code to reproduce)\nTip:Please make sure that two files are named &quot;main.java&quot; and &quot;main.xml&quot;</li>\n<li>Build and run the app</li>\n<li>Tap the button &quot;Next chapter&quot;,then you'll see the error in the logcat</li>\n</ol>\n<h2>Code to reproduce</h2>\n<h3>Java code(main.java)</h3>\n<pre><code>public class main extends AppCompatActivity {\n    SpannableStringBuilder content = new SpannableStringBuilder();\n    public final Gson gson = new GsonBuilder()\n            .registerTypeAdapter(SpannableStringBuilderAdapter.class,new SpannableStringBuilderAdapter())\n            .create();\n\n    @Override\n    protected void onCreate(@Nullable Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.main);\n\n        final String TAG = &quot;ForTest:OnCreate(...)&quot;;\n\n        ArrayList&lt;String&gt; lines = new ArrayList&lt;&gt;();\n        lines.add(&quot;    hello world&quot;);\n        lines.add(&quot;    •&lt;this is what to replace&gt;•&quot;);\n        lines.add(&quot;    •&amp;be used to replace&amp;•&quot;);\n\n        ArrayList&lt;String&gt; Replacements = new ArrayList&lt;&gt;();\n        ArrayList&lt;Span&gt; spans = new ArrayList&lt;&gt;();\n        // 将String转换为char的ArrayList，方便索引补全\n        ArrayList&lt;Character&gt; chars = new ArrayList&lt;&gt;();\n        for (char ch : String.join(&quot;\\n&quot;, lines).toCharArray()) chars.add(ch);\n\n        // 循环判断是否是特殊字符\n        int SpanTimes = -1;\n        try {\n            for (int outside = 0; outside &lt; chars.size() - 1; outside++) {\n                Span span = new Span();\n\n                // 如果遇到了初始开始符\n                if (chars.get(outside) == '•' &amp;&amp; chars.get(outside + 1) == '&lt;') {\n                    // 将此时的迭代标识设为Span的开始索引\n                    span.setStart(outside - 1);\n                    boolean FoundEnd = false;\n\n                    // 嵌套循环从特殊字符之后的字符开始寻找初始结束符\n                    inner:\n                    for (int inside = outside + 2; inside &lt; chars.size() - 1; inside++) {\n                        if (chars.get(inside) == '&gt;' &amp;&amp; chars.get(inside + 1) == '•') {\n                            FoundEnd = true;\n                            // 将此时的嵌套迭代标识的下一位，即‘•’设为Span的结束索引\n                            span.setEnd(inside - 2);\n                            // 将该Span添加到Spans里，并使Span计数加一\n                            spans.add(span);\n                            SpanTimes += 1;\n                            // 删除初始开始符\n                            for (int remove = 0; remove &lt; 2; remove++)\n                                chars.remove(span.getStart() + 1);\n                            // 删除初始结束符\n                            for (int remove = 0; remove &lt; 2; remove++) chars.remove(span.getEnd());\n                            //将初始结束符的索引设为外部迭代标识符\n                            outside = span.getEnd();\n                            break inner;\n                        }\n                    }\n                    if (!FoundEnd) {\n                        // 如果没找到初始结束符，自杀\n                        Log.e(TAG, &quot;No end(&gt;•) found&quot;);\n                        android.os.Process.killProcess(Process.myPid());\n                        System.exit(1);\n                    }\n\n                } else if (chars.get(outside) == '•' &amp;&amp; chars.get(outside + 1) == '&amp;') {\n                    // 如果找到了替换开始符\n                    boolean FoundEnd = false;\n                    StringBuilder sb = new StringBuilder();\n\n                    // 嵌套循环寻找替换结束符\n                    inner:\n                    for (int inside = outside + 2; inside &lt; chars.size()-1; inside++) {\n                        if (chars.get(inside) == '&amp;' &amp;&amp; chars.get(inside + 1) == '•') {\n                            FoundEnd = true;\n                            // 删除文本之中要替换的字符\n                            if(inside+2==chars.size()){\n                                chars.subList(outside,inside).clear();\n                                for(int counter=0;counter&lt;2;counter++) chars.remove(outside);\n                                outside -= 1;\n                            }else{\n                                chars.subList(outside, inside + 2).clear();\n                            }\n                            break inner;\n                        }\n                        // 将替换开始符之后的字符作为Replacement的值\n                        sb.append(chars.get(inside));\n                    }\n                    // 删除多余空格\n                    if (chars.get(outside) == '\\n') chars.subList(outside - 5, outside).clear();\n                    if(chars.get(outside)==' '){\n                        chars.subList(outside-3,outside).clear();\n                        chars.remove(outside-3);\n                        outside = outside-4;\n                    }\n                    if (!FoundEnd) {\n                        // 如果没找到替换结束符，自杀\n                        Log.e(TAG, &quot;No end(&amp;•) found&quot;);\n                        android.os.Process.killProcess(Process.myPid());\n                        System.exit(1);\n                    }\n                    Replacements.add(sb.toString());\n                }\n            }\n        } catch (IndexOutOfBoundsException e) {\n            // 如果出现数组越界，自杀\n            Log.e(TAG, &quot;Error processing the special content&quot;, new IndexOutOfBoundsException(&quot;处理特别章节的文本时出错&quot;));\n            android.os.Process.killProcess(Process.myPid());\n            System.exit(1);\n        }\n        // 设置替换内容\n        for (int index = 0; index &lt; spans.size(); index++)\n            spans.get(index).setReplacement(Replacements.get(index));\n        // 合成Spannable内容\n        StringBuilder sb = new StringBuilder();\n        for(char ch:chars) sb.append(ch);\n        content.append(sb.toString());\n        // 为每个Span设置color并添加到Spannable\n        for (Span span : spans) content.setSpan(span.getColor(), span.getStart(), span.getEnd(), Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);\n        test test = new test(content);\n        SharedPreferences sp = getSharedPreferences(&quot;sp&quot;,MODE_PRIVATE);\n        SharedPreferences.Editor editor = sp.edit();\n        editor.putString(&quot;c&quot;,gson.toJson(test));\n        editor.apply();\n        test ss = gson.fromJson(sp.getString(&quot;c&quot;,&quot;&quot;),new TypeToken&lt;test&gt;(){}.getType());\n        SpannableStringBuilder c = ss.getSsb();\n        int i = 2;\n    }\n\n    public void onClick(View v){\n        TextView Read = findViewById(R.id.Read);\n        SharedPreferences sp = getSharedPreferences(&quot;sp&quot;,MODE_PRIVATE);\n        test ssb = gson.fromJson(sp.getString(&quot;c&quot;,&quot;&quot;),new TypeToken&lt;test&gt;(){}.getType());\n        Read.setText(ssb.getSsb());\n    }\n\n    public static class test implements Serializable {\n        private SpannableStringBuilder ssb = new SpannableStringBuilder();\n        public test(SpannableStringBuilder ssb){this.ssb = ssb;}\n\n        public SpannableStringBuilder getSsb() {\n            return ssb;\n        }\n    }\n\n    static class Span{\n        private int start = 0;\n        private int end = 0;\n        private String Replacement = &quot;&quot;;\n        private ForegroundColorSpan color = new ForegroundColorSpan(Color.BLUE);\n\n        public Span(){}\n\n        public int getStart() {\n            return start;\n        }\n\n        public void setStart(int start) {\n            this.start = start;\n        }\n\n        public int getEnd() {\n            return end;\n        }\n\n        public void setEnd(int end) {\n            this.end = end;\n        }\n\n        public void setReplacement(String replacement) {\n            Replacement = replacement;\n        }\n\n        public ForegroundColorSpan getColor() {\n            return color;\n        }\n    }\n\n    static class SpannableStringBuilderAdapter implements JsonSerializer&lt;SpannableStringBuilder&gt;, JsonDeserializer&lt;SpannableStringBuilder&gt; {\n        @Override\n        public SpannableStringBuilder deserialize(JsonElement json, Type typeOfT, JsonDeserializationContext context) throws JsonParseException {\n            return new SpannableStringBuilder(Html.fromHtml(json.getAsString(),Html.FROM_HTML_MODE_LEGACY).toString());\n        }\n\n        @Override\n        public JsonElement serialize(SpannableStringBuilder src, Type typeOfSrc, JsonSerializationContext context) {\n            return new JsonPrimitive(Html.toHtml(src,Html.FROM_HTML_MODE_LEGACY));\n        }\n    }\n}\n</code></pre>\n<h3>XML code(main.xml)</h3>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;\n&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;\n    xmlns:tools=&quot;http://schemas.android.com/tools&quot;\n    android:layout_width=&quot;match_parent&quot;\n    android:layout_height=&quot;match_parent&quot;&gt;\n\n    &lt;ScrollView\n        android:id=&quot;@+id/ReadParent&quot;\n        android:layout_width=&quot;match_parent&quot;\n        android:layout_height=&quot;match_parent&quot;\n        tools:ignore=&quot;UselessParent&quot;&gt;\n\n        &lt;RelativeLayout\n            android:layout_width=&quot;match_parent&quot;\n            android:layout_height=&quot;wrap_content&quot;&gt;\n\n            &lt;TextView\n                android:id=&quot;@+id/Read&quot;\n                android:layout_width=&quot;match_parent&quot;\n                android:layout_height=&quot;wrap_content&quot;\n                android:textSize=&quot;14sp&quot;\n                android:textStyle=&quot;bold&quot; /&gt;\n\n            &lt;LinearLayout\n                android:layout_width=&quot;match_parent&quot;\n                android:layout_height=&quot;wrap_content&quot;\n                android:layout_below=&quot;@id/Read&quot;\n                android:orientation=&quot;horizontal&quot;&gt;\n\n                &lt;Button\n                    android:id=&quot;@+id/Next&quot;\n                    android:layout_width=&quot;wrap_content&quot;\n                    android:layout_height=&quot;wrap_content&quot;\n                    android:backgroundTint=&quot;#A9AAAD&quot;\n                    android:onClick=&quot;onClick&quot;\n                    android:text=&quot;Next chapter&quot;\n                    android:textColor=&quot;#263238&quot;\n                    tools:ignore=&quot;VisualLintButtonSize&quot; /&gt;\n            &lt;/LinearLayout&gt;\n\n        &lt;/RelativeLayout&gt;\n    &lt;/ScrollView&gt;\n\n&lt;/RelativeLayout&gt;\n</code></pre>\n<h1>Thanks for help!</h1>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}