{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-boot",
      "spring-security",
      "virtual-threads"
    ],
    "owner": {
      "account_id": 23824735,
      "reputation": 125,
      "user_id": 17831952,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/f158dd7afc178c446f2d81f43bbfd6f6?s=256&d=identicon&r=PG",
      "display_name": "ROBLCSnail",
      "link": "https://stackoverflow.com/users/17831952/roblcsnail"
    },
    "is_answered": true,
    "view_count": 3115,
    "accepted_answer_id": 78224869,
    "answer_count": 2,
    "score": 5,
    "last_activity_date": 1730639682,
    "creation_date": 1710501433,
    "question_id": 78166517,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78166517/spring-security-virtual-threads-and-threadlocal",
    "title": "Spring Security Virtual Threads and ThreadLocal",
    "body": "<p>As I was reading up about virtual threads and their pitfalls I found this mention :</p>\n<blockquote>\n<p>Don't Cache Expensive Reusable Objects in Thread-Local Variables</p>\n</blockquote>\n<blockquote>\n<p>Virtual threads support thread-local variables just as platform\nthreads do. See Thread-Local Variables for more information. Usually,\nthread-local variables are used to associate some context-specific\ninformation with the currently running code, such as the current\ntransaction and user ID. This use of thread-local variables is\nperfectly reasonable with virtual threads. However, consider using the\nsafer and more efficient scoped values. See Scoped Values for more\ninformation.</p>\n</blockquote>\n<p>Here : <a href=\"https://docs.oracle.com/en/java/javase/21/core/virtual-threads.html#GUID-68216B85-7B43-423E-91BA-11489B1ACA61\" rel=\"noreferrer\">https://docs.oracle.com/en/java/javase/21/core/virtual-threads.html#GUID-68216B85-7B43-423E-91BA-11489B1ACA61</a></p>\n<p>But i also remembered that Spring Security uses ThreadLocal to save the SecurityContext of a given request:</p>\n<blockquote>\n<p>By default, SecurityContextHolder uses a ThreadLocal to store these\ndetails, which means that the SecurityContext is always available to\nmethods in the same thread, even if the SecurityContext is not\nexplicitly passed around as an argument to those methods. Using a\nThreadLocal in this way is quite safe if you take care to clear the\nthread after the present principal’s request is processed. Spring\nSecurity’s FilterChainProxy ensures that the SecurityContext is always\ncleared.</p>\n</blockquote>\n<p>Docs : <a href=\"https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html\" rel=\"noreferrer\">https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html</a></p>\n<p>So the question is : is it safe to use virtual threads in a Spring Boot REST Application with endpoints that do require authentication and authorization and therefor have a <code>SecurityContext</code> ? Is this considered a pitfall ?</p>\n<p>Thanks !</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}