{
  "question": {
    "tags": [
      "java",
      "c#",
      ".net",
      "plantuml",
      "ikvm"
    ],
    "owner": {
      "account_id": 460329,
      "reputation": 89,
      "user_id": 861352,
      "user_type": "registered",
      "profile_image": "https://i.sstatic.net/WFbnB.jpg?s=256",
      "display_name": "LemonLion",
      "link": "https://stackoverflow.com/users/861352/lemonlion"
    },
    "is_answered": true,
    "view_count": 209,
    "answer_count": 1,
    "score": 0,
    "last_activity_date": 1721078848,
    "creation_date": 1704637417,
    "last_edit_date": 1704639211,
    "question_id": 77773432,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/77773432/running-plantuml-jar-on-ikvm-fails-with-system-typeinitializationexception",
    "title": "Running PlantUml Jar On IKVM fails with System.TypeInitializationException",
    "body": "<p>I am attempting to run PlantUml in .Net rather than relying on a Java Virtual Machine installed locally/in docker/externally for it to run on.  IKVM as I understand it creates a JVM that runs in .Net itself, so would be the solution to my problem.</p>\n<p>To aid anyone who want to try help fixing the issue I have created a public repository of the code <a href=\"https://github.com/lemonlion/PlantUmlIkvmTest\" rel=\"nofollow noreferrer\">https://github.com/lemonlion/PlantUmlIkvmTest</a></p>\n<p>First I went to <a href=\"https://plantuml.com/download\" rel=\"nofollow noreferrer\">https://plantuml.com/download</a> and downloaded the latest MIT licensed version (<code>plantuml-mit-1.2023.13.jar</code>).  I then created a new C# .Net 6 console project named <code>PlantUmlIkvm</code> and added a new folder called <code>PlantUml</code> and put the jar in there.</p>\n<p>Next I installed all the packages mentioned in the <a href=\"https://github.com/ikvmnet/ikvm/blob/main/README.md\" rel=\"nofollow noreferrer\">IKVM Readme</a> and I also installed <code>IKVM.Maven.Sdk</code></p>\n<pre><code>    &lt;ItemGroup&gt;\n        &lt;PackageReference Include=&quot;IKVM&quot; Version=&quot;8.7.3&quot; /&gt;\n        &lt;PackageReference Include=&quot;IKVM.Image&quot; Version=&quot;8.7.3&quot; /&gt;\n        &lt;PackageReference Include=&quot;IKVM.Image.JDK&quot; Version=&quot;8.7.3&quot; /&gt;\n        &lt;PackageReference Include=&quot;IKVM.Image.JRE&quot; Version=&quot;8.7.3&quot; /&gt;\n        &lt;PackageReference Include=&quot;IKVM.Maven.Sdk&quot; Version=&quot;1.6.5&quot; /&gt;\n        &lt;PackageReference Include=&quot;IKVM.MSBuild&quot; Version=&quot;8.7.3&quot; /&gt;\n    &lt;/ItemGroup&gt;\n</code></pre>\n<p>Next I added an IkvmReference tag in my project file as per the IKVM readme.  I also put Debug true to allow for any debugging functionality.</p>\n<pre><code>    &lt;ItemGroup&gt;\n        &lt;IkvmReference Include=&quot;PlantUml\\plantuml-mit-1.2023.13.jar&quot; &gt;\n            &lt;Debug&gt;true&lt;/Debug&gt;\n        &lt;/IkvmReference&gt;\n    &lt;/ItemGroup&gt;\n</code></pre>\n<p>At this point the entire solution looks like this:</p>\n<p><a href=\"https://i.sstatic.net/bEG0d.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/bEG0d.png\" alt=\"enter image description here\" /></a></p>\n<p><a href=\"https://i.sstatic.net/AoeHo.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/AoeHo.png\" alt=\"enter image description here\" /></a></p>\n<p>I then rebuilt the entire solution.  I look in <code>C:/Code/PlantUmlIkvm/bin/Debug/net6.0</code> and am pleased to see that a dll has been created called <code>net.sourceforge.plantuml.dll</code> indicating that IKVM has successfully translated the jar into something .net compatible.</p>\n<p><a href=\"https://i.sstatic.net/k8JdM.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/k8JdM.png\" alt=\"enter image description here\" /></a></p>\n<p>I then attempt to use PlantUml from my solution.  Besides some intellisense weirdness (the IDE isn't always recognising the classes as classes), the new classes appear to be picked up by visual studio and I can decompile into them using Visual Studio/Resharper.  I follow the <a href=\"https://plantuml.com/api\" rel=\"nofollow noreferrer\">PlantUml tutorial from their main page</a> for creating a PNG image from some basic plantUml and so I enter the following code into the main Program.cs:</p>\n<pre><code>    using System.Reflection;\n    using com.plantuml.api.cheerpj;\n    using com.plantuml.api.cheerpj.v1;\n    using java.io;\n    using net.sourceforge.plantuml;\n    using net.sourceforge.plantuml.api;\n    using net.sourceforge.plantuml.security;\n    using net.sourceforge.plantuml.sequencediagram;\n    using sun.misc;\n    using sun.net.www.content.image;\n\n    namespace PlantUmlIkvm;\n\n    public class Program\n    {\n        public static void Main(string[] args)\n        {\n            var uml = &quot;@startuml\\n&quot;;\n            uml += &quot;Bob -&gt; Alice : hello\\n&quot;;\n            uml += &quot;@enduml\\n&quot;;\n            var reader = new net.sourceforge.plantuml.SourceStringReader(uml);\n            OutputStream png = new Base64OutputStream();\n            var desc = reader.outputImage(png).getDescription();\n        }\n    }\n</code></pre>\n<p>The program builds successfully.  It runs successfully up to a point, but fails on this line:</p>\n<p><code>var desc = reader.outputImage(png).getDescription();</code></p>\n<p>The line fails with message</p>\n<p><code>System.TypeInitializationException: 'The type initializer for 'net.sourceforge.plantuml.FileFormat' threw an exception.'</code></p>\n<p><a href=\"https://i.sstatic.net/zaDWD.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/zaDWD.png\" alt=\"enter image description here\" /></a></p>\n<p><a href=\"https://i.sstatic.net/WGXcY.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/WGXcY.png\" alt=\"enter image description here\" /></a></p>\n<p>Outer Exception TargetSite:</p>\n<p><a href=\"https://i.sstatic.net/7zrgB.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/7zrgB.png\" alt=\"enter image description here\" /></a></p>\n<p>Inner Exception TargetSite:</p>\n<p><a href=\"https://i.sstatic.net/hMqAC.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/hMqAC.png\" alt=\"enter image description here\" /></a></p>\n<p>The main Stack Trace:</p>\n<p><a href=\"https://i.sstatic.net/RClXU.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/RClXU.png\" alt=\"enter image description here\" /></a></p>\n<p>The inner exception Stack Trace:</p>\n<p><a href=\"https://i.sstatic.net/V2mN7.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/V2mN7.png\" alt=\"enter image description here\" /></a></p>\n<p>I believe the error is happening when it tries to create a FileFormatOption, hence when I insert this additional line it fails there first:</p>\n<pre><code>var fileFormat = new FileFormatOption(FileFormat.PNG);\n</code></pre>\n<p><a href=\"https://i.sstatic.net/z9RTQ.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/z9RTQ.png\" alt=\"enter image description here\" /></a></p>\n<p>I am running all this on Windows 10.</p>\n<p>I imagine this is more of an IKVM issue than a PlantUml issue, but open to any ideas.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}