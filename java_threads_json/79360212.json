{
  "question": {
    "tags": [
      "java",
      "java-8",
      "uri"
    ],
    "owner": {
      "account_id": 313216,
      "reputation": 47899,
      "user_id": 627727,
      "user_type": "registered",
      "accept_rate": 84,
      "profile_image": "https://i.sstatic.net/uOIWL.jpg?s=256",
      "display_name": "mkobit",
      "link": "https://stackoverflow.com/users/627727/mkobit"
    },
    "is_answered": true,
    "view_count": 108,
    "accepted_answer_id": 79588769,
    "answer_count": 1,
    "score": 2,
    "last_activity_date": 1745416228,
    "creation_date": 1736994604,
    "question_id": 79360212,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79360212/resolving-relative-uris-in-java-8-while-dealing-with-jdk-bug",
    "title": "Resolving relative URIs in Java 8 while dealing with JDK bug",
    "body": "<p>I'm in the scenario where I am stuck on Java 8. I have a program that creates and resolves URIs using <a href=\"https://docs.oracle.com/javase/8/docs/api/java/net/URI.html\" rel=\"nofollow noreferrer\"><code>java.net.URI</code></a>. These are generally always going to be <code>http</code> scheme, but we will potentially get others that we need to handle.</p>\n<pre class=\"lang-java prettyprint-override\"><code>import java.net.URI;\n\nclass Scratch {\n    public static void main(String[] args) throws Exception {\n        URI base = new URI(&quot;https://example.com/&quot;);\n        URI other = new URI(&quot;path/to/resource?query=hello&quot;);\n        URI result = base.resolve(other);\n        System.out.println(result);\n    }\n}\n</code></pre>\n<p>This resolves to the correct URI, as expected:</p>\n<blockquote>\n<p><a href=\"https://example.com/path/to/resource?query=hello\" rel=\"nofollow noreferrer\">https://example.com/path/to/resource?query=hello</a></p>\n</blockquote>\n<p>However, due to <a href=\"https://bugs.openjdk.org/browse/JDK-8272702\" rel=\"nofollow noreferrer\">JDK-8272702</a>, this behaves rather unexpectedly when resolving <em>relative</em> URIs in various other ways.</p>\n<h3>Examples</h3>\n<p>Here are a handful of examples of different relative resolutions and their expectation:</p>\n<pre class=\"lang-java prettyprint-override\"><code>import java.net.URI;\n\nclass Scratch {\n    private static final String F = &quot;%-20s %-15s %-35s %-35s%n&quot;;\n    public static void main(String[] args) throws Exception {\n        System.out.printf(F, &quot;Base&quot;, &quot;Resolve part&quot;, &quot;Expected&quot;, &quot;Actual (if different)&quot;);\n        test(&quot;https://a.com&quot;, &quot;.&quot;, &quot;https://a.com/&quot;);\n        test(&quot;https://a.com&quot;, &quot;./&quot;, &quot;https://a.com/&quot;);\n        test(&quot;https://a.com&quot;, &quot;./path&quot;, &quot;https://a.com/path&quot;);\n        test(&quot;https://a.com&quot;, &quot;path&quot;, &quot;https://a.com/path&quot;);\n        test(&quot;https://a.com&quot;, &quot;path/&quot;, &quot;https://a.com/path/&quot;);\n        test(&quot;https://a.com&quot;, &quot;./path/&quot;, &quot;https://a.com/path/&quot;);\n        test(&quot;https://a.com&quot;, &quot;../&quot;, &quot;https://a.com/../&quot;);\n        test(&quot;https://a.com&quot;, &quot;../path&quot;, &quot;https://a.com/../path&quot;);\n        test(&quot;https://a.com&quot;, &quot;../path/&quot;, &quot;https://a.com/../path/&quot;);\n\n        System.out.println(&quot;\\nTrailing slash&quot;);\n        test(&quot;https://a.com/&quot;, &quot;.&quot;, &quot;https://a.com/&quot;);\n        test(&quot;https://a.com/&quot;, &quot;./&quot;, &quot;https://a.com/&quot;);\n        test(&quot;https://a.com/&quot;, &quot;./path&quot;, &quot;https://a.com/path&quot;);\n        test(&quot;https://a.com/&quot;, &quot;path&quot;, &quot;https://a.com/path&quot;);\n        test(&quot;https://a.com/&quot;, &quot;path/&quot;, &quot;https://a.com/path/&quot;);\n        test(&quot;https://a.com/&quot;, &quot;./path/&quot;, &quot;https://a.com/path/&quot;);\n        test(&quot;https://a.com/&quot;, &quot;../&quot;, &quot;https://a.com/../&quot;);\n        test(&quot;https://a.com/&quot;, &quot;../path&quot;, &quot;https://a.com/../path&quot;);\n        test(&quot;https://a.com/&quot;, &quot;../path/&quot;, &quot;https://a.com/../path/&quot;);\n    }\n\n    private static void test(String base, String resolve, String expected) throws Exception {\n        URI baseUri = new URI(base);\n        URI resolveUri = new URI(resolve);\n        URI actual = baseUri.resolve(resolveUri);\n        URI expectedUri = new URI(expected);\n        String difference = actual.equals(expectedUri) ? &quot;&quot; : actual.toString();\n        System.out.printf(F, baseUri, resolveUri, expectedUri, difference);\n    }\n}\n</code></pre>\n<p>On Java 21, where the linked bug is &quot;fixed&quot; and assuming the output of each resolution is correct, we get the following output:</p>\n<pre class=\"lang-none prettyprint-override\"><code>Base                 Resolve part    Expected                            Actual (if different)              \nhttps://a.com        .               https://a.com/                                                         \nhttps://a.com        ./              https://a.com/                                                         \nhttps://a.com        ./path          https://a.com/path                                                     \nhttps://a.com        path            https://a.com/path                                                     \nhttps://a.com        path/           https://a.com/path/                                                    \nhttps://a.com        ./path/         https://a.com/path/                                                    \nhttps://a.com        ../             https://a.com/../                                                      \nhttps://a.com        ../path         https://a.com/../path                                                  \nhttps://a.com        ../path/        https://a.com/../path/                                                 \n\nTrailing slash\nhttps://a.com/       .               https://a.com/                                                         \nhttps://a.com/       ./              https://a.com/                                                         \nhttps://a.com/       ./path          https://a.com/path                                                     \nhttps://a.com/       path            https://a.com/path                                                     \nhttps://a.com/       path/           https://a.com/path/                                                    \nhttps://a.com/       ./path/         https://a.com/path/                                                    \nhttps://a.com/       ../             https://a.com/../                                                      \nhttps://a.com/       ../path         https://a.com/../path                                                  \nhttps://a.com/       ../path/        https://a.com/../path/\n</code></pre>\n<h3>Java 8 invocation</h3>\n<p>However, when ran on Java 8 (1.8.0_322):</p>\n<pre class=\"lang-none prettyprint-override\"><code>Base                 Resolve part    Expected                            Actual (if different)              \nhttps://a.com        .               https://a.com/                      https://a.com                      \nhttps://a.com        ./              https://a.com/                      https://a.com                      \nhttps://a.com        ./path          https://a.com/path                  https://a.compath                  \nhttps://a.com        path            https://a.com/path                  https://a.compath                  \nhttps://a.com        path/           https://a.com/path/                 https://a.compath/                 \nhttps://a.com        ./path/         https://a.com/path/                 https://a.compath/                 \nhttps://a.com        ../             https://a.com/../                   https://a.com../                   \nhttps://a.com        ../path         https://a.com/../path               https://a.com../path               \nhttps://a.com        ../path/        https://a.com/../path/              https://a.com../path/              \n\nTrailing slash\nhttps://a.com/       .               https://a.com/                                                         \nhttps://a.com/       ./              https://a.com/                                                         \nhttps://a.com/       ./path          https://a.com/path                                                     \nhttps://a.com/       path            https://a.com/path                                                     \nhttps://a.com/       path/           https://a.com/path/                                                    \nhttps://a.com/       ./path/         https://a.com/path/                                                    \nhttps://a.com/       ../             https://a.com/../                                                      \nhttps://a.com/       ../path         https://a.com/../path                                                  \nhttps://a.com/       ../path/        https://a.com/../path/\n</code></pre>\n<p>You can see the <em>Actual</em> are much different for many of the resolutions. This is also not a complete set of potential inputs, just some to demonstrate the problem.</p>\n<h3>What does Python do?</h3>\n<p>As an aside, running the same thing in Python (3.11 here) using <code>urllib.parse</code> produces different output</p>\n<pre class=\"lang-py prettyprint-override\"><code>from urllib.parse import urljoin\n\nFORMAT = &quot;{:20s} {:15s} {:35s} {:35s}&quot;\n\ndef main():\n    print(FORMAT.format(&quot;Base&quot;, &quot;Resolve part&quot;, &quot;Expected&quot;, &quot;Actual (if different)&quot;))\n    test(&quot;https://a.com&quot;, &quot;.&quot;, &quot;https://a.com/&quot;)\n    test(&quot;https://a.com&quot;, &quot;./&quot;, &quot;https://a.com/&quot;)\n    test(&quot;https://a.com&quot;, &quot;./path&quot;, &quot;https://a.com/path&quot;)\n    test(&quot;https://a.com&quot;, &quot;path&quot;, &quot;https://a.com/path&quot;)\n    test(&quot;https://a.com&quot;, &quot;path/&quot;, &quot;https://a.com/path/&quot;)\n    test(&quot;https://a.com&quot;, &quot;./path/&quot;, &quot;https://a.com/path/&quot;)\n    test(&quot;https://a.com&quot;, &quot;../&quot;, &quot;https://a.com/../&quot;)\n    test(&quot;https://a.com&quot;, &quot;../path&quot;, &quot;https://a.com/../path&quot;)\n    test(&quot;https://a.com&quot;, &quot;../path/&quot;, &quot;https://a.com/../path/&quot;)\n\n    print(&quot;\\nTrailing slash&quot;)\n    test(&quot;https://a.com/&quot;, &quot;.&quot;, &quot;https://a.com/&quot;)\n    test(&quot;https://a.com/&quot;, &quot;./&quot;, &quot;https://a.com/&quot;)\n    test(&quot;https://a.com/&quot;, &quot;./path&quot;, &quot;https://a.com/path&quot;)\n    test(&quot;https://a.com/&quot;, &quot;path&quot;, &quot;https://a.com/path&quot;)\n    test(&quot;https://a.com/&quot;, &quot;path/&quot;, &quot;https://a.com/path/&quot;)\n    test(&quot;https://a.com/&quot;, &quot;./path/&quot;, &quot;https://a.com/path/&quot;)\n    test(&quot;https://a.com/&quot;, &quot;../&quot;, &quot;https://a.com/../&quot;)\n    test(&quot;https://a.com/&quot;, &quot;../path&quot;, &quot;https://a.com/../path&quot;)\n    test(&quot;https://a.com/&quot;, &quot;../path/&quot;, &quot;https://a.com/../path/&quot;)\n\ndef test(base, resolve, expected):\n    base_uri = urljoin(base, &quot;&quot;)  # Ensure base is a proper URL\n    resolve_uri = urljoin(&quot;&quot;, resolve)  # Resolve treats empty string as base\n    actual = urljoin(base_uri, resolve_uri)\n    difference = &quot;&quot; if actual == expected else actual\n    print(FORMAT.format(base_uri, resolve_uri, expected, difference))\n\nmain()\n</code></pre>\n<p>Output:</p>\n<pre class=\"lang-none prettyprint-override\"><code>Base                 Resolve part    Expected                            Actual (if different)              \nhttps://a.com        .               https://a.com/                                                         \nhttps://a.com        ./              https://a.com/                                                         \nhttps://a.com        ./path          https://a.com/path                                                     \nhttps://a.com        path            https://a.com/path                                                     \nhttps://a.com        path/           https://a.com/path/                                                    \nhttps://a.com        ./path/         https://a.com/path/                                                    \nhttps://a.com        ../             https://a.com/../                   https://a.com/                     \nhttps://a.com        ../path         https://a.com/../path               https://a.com/path                 \nhttps://a.com        ../path/        https://a.com/../path/              https://a.com/path/                \n\nTrailing slash\nhttps://a.com/       .               https://a.com/                                                         \nhttps://a.com/       ./              https://a.com/                                                         \nhttps://a.com/       ./path          https://a.com/path                                                     \nhttps://a.com/       path            https://a.com/path                                                     \nhttps://a.com/       path/           https://a.com/path/                                                    \nhttps://a.com/       ./path/         https://a.com/path/                                                    \nhttps://a.com/       ../             https://a.com/../                   https://a.com/                     \nhttps://a.com/       ../path         https://a.com/../path               https://a.com/path                 \nhttps://a.com/       ../path/        https://a.com/../path/              https://a.com/path/ \n</code></pre>\n<p>Produces slightly different output. This could be do to an RFC difference between Java and Python or a slight difference in how the normalization works, because the only differences are with the double dot segments.</p>\n<h3>Question</h3>\n<p>How can I author a Java 8 safe resolve method that works for all <code>java.net.URI</code>s in spite of the above mentioned bug?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}