{
  "question": {
    "tags": [
      "java",
      "httpconnection",
      "apache-httpclient-5.x"
    ],
    "owner": {
      "account_id": 3393280,
      "reputation": 51,
      "user_id": 2847612,
      "user_type": "registered",
      "profile_image": "https://www.gravatar.com/avatar/faea2b7e7ade4df568862d3ba59a9780?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name": "newLearner",
      "link": "https://stackoverflow.com/users/2847612/newlearner"
    },
    "is_answered": true,
    "view_count": 625,
    "answer_count": 3,
    "score": 0,
    "last_activity_date": 1745021195,
    "creation_date": 1740676288,
    "last_edit_date": 1740676771,
    "question_id": 79473448,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79473448/apache-http-client-5-timeout-is-not-working-version-httpclient55-4-1",
    "title": "Apache http client 5 timeout is not working - version httpclient5:5.4.1",
    "body": "<p>I want to configure a timeout of 3 seconds against <a href=\"https://httpbin.org/delay/5\" rel=\"nofollow noreferrer\">https://httpbin.org/delay/5</a> which respond back after 5 second only. This is to make sure a service which takes more than three second is doing a timeout after three seconds. I have followed the documentation and written below code where the httpclient is not timed out after 3 seconds instead it takes between 5 to 6 seconds to timeout.</p>\n<pre><code>public class HttpClientTimeoutExamplePoolingHttpClientConnectionManagerBuilder {\npublic static void main(String[] args) {\n    try {\n\n        DefaultClientTlsStrategy tlsStrategy = new DefaultClientTlsStrategy(SSLContext.getDefault());\n\n\n        final PoolingHttpClientConnectionManager connectionManager = PoolingHttpClientConnectionManagerBuilder.create()\n                .setTlsSocketStrategy(tlsStrategy)\n                .setDefaultSocketConfig(SocketConfig.custom()\n                        .setSoTimeout(Timeout.of(3, TimeUnit.SECONDS))\n                        .build())\n                .setMaxConnPerRoute(20)\n                .setMaxConnTotal(200)\n                .build();\n\n        final RequestConfig requestConfig = RequestConfig.custom()\n                .setConnectionRequestTimeout(Timeout.of(1, TimeUnit.SECONDS))\n                .setConnectTimeout(Timeout.of(3, TimeUnit.SECONDS))\n                .setResponseTimeout(Timeout.of(3, TimeUnit.SECONDS))\n                .build();\n\n        CloseableHttpClient httpClient = HttpClients.custom()\n                .setConnectionManager(connectionManager)\n                .setDefaultRequestConfig(requestConfig)\n                .evictExpiredConnections()\n                .build();\n\n        // Create GET request\n        final HttpGet httpGet = new HttpGet(&quot;https://httpbin.org/delay/5&quot;);\n        httpGet.setConfig(requestConfig);\n\n        // Log start time\n        long startTime = System.currentTimeMillis();\n        System.out.println(&quot;Executing GET request at: &quot; + startTime);\n\n        try {\n            CloseableHttpResponse response = httpClient.execute(httpGet);\n            try {\n                long endTime = System.currentTimeMillis();\n                System.out.println(&quot;Response received after: &quot; + (endTime - startTime) + &quot;ms&quot;);\n                System.out.println(&quot;Response status: &quot; + response.getCode());\n                System.out.println(&quot;Response body: &quot; + EntityUtils.toString(response.getEntity()));\n            } finally {\n                response.close();\n            }\n        } catch (Exception e) {\n            long endTime = System.currentTimeMillis();\n            System.out.println(&quot;Exception after: &quot; + (endTime - startTime) + &quot;ms&quot;);\n            System.out.println(&quot;Exception type: &quot; + e.getClass().getName());\n            System.out.println(&quot;Exception message: &quot; + e.getMessage());\n            e.printStackTrace();\n        } finally {\n            httpClient.close();\n        }\n\n    } catch (Exception e) {\n        e.printStackTrace();\n    }\n}\n</code></pre>\n<p>Output:</p>\n<p>app.verify.http.HttpClientTimeoutExamplePoolingHttpClientConnectionManagerBuilder.main()</p>\n<p>Executing GET request at: 1740675604245</p>\n<p>Exception after: <strong>6575ms</strong></p>\n<p>Exception type: java.net.SocketTimeoutException</p>\n<p>Exception message: Read timed out</p>\n<p><strong>I have tried different config (socket level, connection level, request level) but was not able achieve the timeout functionality.</strong></p>\n<p>Then I have changed the code to use PoolingHttpClientConnectionManager and Registry and <strong>everything started working</strong></p>\n<pre><code>public class HttpClientTimeoutExamplePoolingHttpClientConnectionManager {\n\npublic static void main(String[] args) {\n    try {\n\n        Registry&lt;ConnectionSocketFactory&gt; registry = RegistryBuilder.&lt;ConnectionSocketFactory&gt;create()\n                .register(&quot;http&quot;, PlainConnectionSocketFactory.getSocketFactory())\n                .register(&quot;https&quot;, SSLConnectionSocketFactory.getSocketFactory())\n                .build();\n\n        PoolingHttpClientConnectionManager connectionManager = new PoolingHttpClientConnectionManager(registry);\n        connectionManager.setDefaultSocketConfig(org.apache.hc.core5.http.io.SocketConfig.custom()\n                .setSoTimeout(Timeout.of(3, TimeUnit.SECONDS))\n                .build());\n        connectionManager.setMaxTotal(200);\n        connectionManager.setDefaultMaxPerRoute(20);\n\n        // Define request config with timeouts\n        RequestConfig requestConfig = RequestConfig.custom()\n                .setConnectTimeout(Timeout.of(1, TimeUnit.SECONDS))\n                .setResponseTimeout(Timeout.of(3, TimeUnit.SECONDS))\n                .setConnectionRequestTimeout(Timeout.of(3, TimeUnit.SECONDS))\n                .build();\n\n        // Build the client with timeouts applied at connection manager level\n        CloseableHttpClient httpClient = HttpClients.custom()\n                .setConnectionManager(connectionManager)\n                .setDefaultRequestConfig(requestConfig)\n                .evictExpiredConnections()\n                .build();\n\n        // Create GET request\n        final HttpGet httpGet = new HttpGet(&quot;https://httpbin.org/delay/5&quot;);\n        httpGet.setConfig(requestConfig);\n\n        // Log start time\n        long startTime = System.currentTimeMillis();\n        System.out.println(&quot;Executing GET request at: &quot; + startTime);\n\n        try {\n            CloseableHttpResponse response = httpClient.execute(httpGet);\n            try {\n                long endTime = System.currentTimeMillis();\n                System.out.println(&quot;Response received after: &quot; + (endTime - startTime) + &quot;ms&quot;);\n                System.out.println(&quot;Response status: &quot; + response.getCode());\n                System.out.println(&quot;Response body: &quot; + EntityUtils.toString(response.getEntity()));\n            } finally {\n                response.close();\n            }\n        } catch (Exception e) {\n            long endTime = System.currentTimeMillis();\n            System.out.println(&quot;Exception after: &quot; + (endTime - startTime) + &quot;ms&quot;);\n            System.out.println(&quot;Exception type: &quot; + e.getClass().getName());\n            System.out.println(&quot;Exception message: &quot; + e.getMessage());\n            e.printStackTrace();\n        } finally {\n            httpClient.close();\n        }\n\n    } catch (Exception e) {\n        e.printStackTrace();\n    }\n}\n</code></pre>\n<p>Output: app.verify.http.HttpClientTimeoutExamplePoolingHttpClientConnectionManager.main()</p>\n<p>Executing GET request at: 1740675734246</p>\n<p>java.net.SocketTimeoutException: Read timed out</p>\n<p>Exception after: <strong>3540ms</strong></p>\n<p>Exception type: java.net.SocketTimeoutException</p>\n<p>Exception message: Read timed out</p>\n<p>The issue is ConnectionSocketFactory, PlainConnectionSocketFactory and SSLConnectionSocketFactory are deprecated, so any idea how to achieve timeout using non deprecated class? Or can someone correct me the wrong config is the first class? (Would be great if you can use the same code with 3 second timeout that hit 5 second delay API endpoint)</p>\n<p>I have tried <a href=\"https://github.com/apache/httpcomponents-client/blob/5.4.x/httpclient5/src/test/java/org/apache/hc/client5/http/examples/ClientConfiguration.java\" rel=\"nofollow noreferrer\">https://github.com/apache/httpcomponents-client/blob/5.4.x/httpclient5/src/test/java/org/apache/hc/client5/http/examples/ClientConfiguration.java</a> code and invoked the same URL with 3 second timeout and the behavior is same where request is taking around 5 to 6 second to timeout when I have configured the timeout as 3 seconds,.</p>\n<p>Thanks</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}