{
  "question": {
    "tags": [
      "java",
      "spring",
      "spring-boot",
      "spring-data-jpa"
    ],
    "owner": {
      "account_id": 1857554,
      "reputation": 20801,
      "user_id": 1682820,
      "user_type": "registered",
      "accept_rate": 70,
      "profile_image": "https://i.sstatic.net/z9bzH.png?s=256",
      "display_name": "injecteer",
      "link": "https://stackoverflow.com/users/1682820/injecteer"
    },
    "is_answered": false,
    "view_count": 518,
    "answer_count": 2,
    "score": 0,
    "last_activity_date": 1713162214,
    "creation_date": 1708340722,
    "last_edit_date": 1708342210,
    "question_id": 78020174,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/78020174/preupdate-never-called-on-respository-save",
    "title": "@PreUpdate never called on respository.save()",
    "body": "<p>In a spring-boot 3 app with <code>spring-boot-starter-data-jpa</code> I have an entity:</p>\n<pre><code>@Entity\npublic class SomeJson {\n\n  public static final ObjectMapper MAPPER = new ObjectMapper();\n\n  public static final TypeReference&lt;HashMap&lt;String, Object&gt;&gt; MAP_REF = new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {};\n\n  // some fields\n\n  public String jsonData;\n\n  @Transient\n  public HashMap&lt;String, Object&gt; data = new HashMap&lt;String, Object&gt;();\n  \n  @Transient\n  private int initialHashCode = 0;\n\n  /**\n   * Converts JSON-Data to {@link HashMap}.\n   */\n  @PostLoad\n  public void onLoad() {\n    try {\n      if (StringUtils.isNotEmpty(jsonData))\n        data.putAll( MAPPER.readValue(jsonData, MAP_REF) );\n    } catch (JacksonException ignore) {}\n    initialHashCode = data.hashCode();\n  }\n\n  /**\n   * Converts {@link HashMap} to JSON-String if dirty.\n   */\n  @PreUpdate\n  public void onSave() {\n    System.out.println(&quot;**** &quot; + initialHashCode + &quot; == &quot; + data.hashCode() );\n    if( initialHashCode == data.hashCode() ) return;\n    try {\n      jsonData = MAPPER.writeValueAsString(data);\n    } catch (JsonProcessingException e) {}\n  }\n  \n}\n</code></pre>\n<p>and the corresponding repo:</p>\n<pre><code>@Repository\npublic interface SomeJsonRepo extends JpaRepository&lt;SomeJson, Long&gt; {}\n</code></pre>\n<p>The <code>@PostLoad</code> works just fine, but the code</p>\n<pre><code>SomeJson sj = someJsonRepo.findById(42);\nsj.data.put(&quot;lastSuccessfulExport&quot;, System.currentTimeMillis());\n// sj.onSave(); (1)\nsomeJsonRepo.save(er);\nlog.info( &quot;Authentication failed&quot; );\n</code></pre>\n<p>does NOT trigger the <code>@PreUpdate</code> method.</p>\n<p>If I uncomment the line <code>(1)</code>, I see that the <code>onSave()</code> is executed twice:</p>\n<pre><code>**** -888829936 == 1673013342\n2024-02-19T11:44:27.913+01:00  INFO 18408 --- [nio-8050-exec-1] some.Service : Authentication failed\n**** -888829936 == 1673013342\n</code></pre>\n<p>Does JPA/Hibernate have troubles determining whether the instance is dirty and &quot;forgetting&quot; to fire the <code>@PreUpdate</code>?</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}