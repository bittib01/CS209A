{
  "question": {
    "tags": [
      "java",
      "invokedynamic"
    ],
    "owner": {
      "account_id": 1412195,
      "reputation": 1372,
      "user_id": 1338565,
      "user_type": "registered",
      "accept_rate": 20,
      "profile_image": "https://www.gravatar.com/avatar/d08b34dbf6a126fc8fa21c1738d3c75c?s=256&d=identicon&r=PG",
      "display_name": "Thiru kumaran",
      "link": "https://stackoverflow.com/users/1338565/thiru-kumaran"
    },
    "is_answered": true,
    "view_count": 82,
    "answer_count": 2,
    "score": 3,
    "last_activity_date": 1745156138,
    "creation_date": 1745152846,
    "last_edit_date": 1745153376,
    "question_id": 79583360,
    "content_license": "CC BY-SA 4.0",
    "link": "https://stackoverflow.com/questions/79583360/how-to-generate-a-lambda-with-a-captured-int-argument-using-lambdametafactory",
    "title": "How to generate a lambda with a captured `int` argument using `LambdaMetafactory.metafactory` for a static method?",
    "body": "<p>I'm trying to dynamically generate a lambda using <code>LambdaMetafactory.metafactory</code>, where the target method has an additional captured <code>int</code> parameter.</p>\n<h2>Context</h2>\n<p>Assume I have the following functional interface:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@FunctionalInterface\npublic interface Binder {\n    void parseAndStore(byte[] src, byte[] dst);\n}\n</code></pre>\n<p>And the static method I want to call looks like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class BinderFactory {\n    public static void bindField(byte[] src, byte[] dst, int offset) {\n        // Business logic\n    }\n}\n</code></pre>\n<p>At runtime, I want to produce a Binder instance like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>Binder binder = (src, dst) -&gt; BinderFactory.bindField(src, dst, offset);\n</code></pre>\n<p>The offset is known only at runtime and should be captured</p>\n<h3>What I tried</h3>\n<pre class=\"lang-java prettyprint-override\"><code>public class BinderBuilder {\n    public static Binder createBinder(String methodName, int offset) {\n        try {\n            MethodHandles.Lookup lookup = MethodHandles.lookup();\n\n            // (byte[], byte[], int) -&gt; void\n            MethodHandle target = lookup.findStatic(\n                BinderFactory.class,\n                methodName,\n                MethodType.methodType(void.class, byte[].class, byte[].class, int.class)\n            );\n\n            // Bind the offset argument at position 2\n            MethodHandle bound = MethodHandles.insertArguments(target, 2, offset);\n\n            CallSite site = LambdaMetafactory.metafactory(\n                lookup,\n                &quot;parseAndStore&quot;, // functional interface method\n                MethodType.methodType(Binder.class), // invokedType: () -&gt; Binder\n                MethodType.methodType(void.class, byte[].class, byte[].class), // erased SAM\n                bound, // implementation handle with offset bound\n                MethodType.methodType(void.class, byte[].class, byte[].class) // implType\n            );\n\n            return (Binder) site.getTarget().invoke(); // invoke factory\n        } catch (Throwable t) {\n            throw new RuntimeException(&quot;Failed to bind lambda&quot;, t);\n        }\n    }\n}\n</code></pre>\n<h3>Problem</h3>\n<p>When I run the code, I get:</p>\n<blockquote>\n<p>Caused by: java.lang.invoke.LambdaConversionException: no direct\nmethod, cannot crack method handle ...</p>\n</blockquote>\n<h3>Expected</h3>\n<p>I want a single-call Binder lambda that internally captures the offset value and calls:</p>\n<pre class=\"lang-java prettyprint-override\"><code>BinderFactory.bindField(src, dst, offset);\n</code></pre>\n<h3>Questions</h3>\n<p>Why does the metafactory setup fail with a “no direct method” or “cannot crack” exception?</p>\n<p>Is <code>insertArguments()</code> enough to bind the captured offset, or is another approach needed?</p>\n<p>Are my <code>invokedType</code>, <code>samMethodType</code>, and <code>implMethodType</code> correctly specified?</p>\n<p>How can I ensure that the result is a single-layer lambda (no factory indirection)?</p>\n<p>Any guidance on resolving this lambda binding issue would be appreciated. I’d prefer sticking to <code>LambdaMetafactory.metafactory</code> for performance and clarity, unless <code>altMetafactory</code> is absolutely required.</p>\n"
  },
  "answers": [],
  "question_comments": [],
  "answer_comments": {}
}